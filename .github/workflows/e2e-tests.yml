name: ğŸ§ª E2E Tests - Sistema Unificado

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  e2e-tests:
    name: E2E Tests (Playwright + PostgreSQL)
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test123
          POSTGRES_DB: attendance_system_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“š Install dependencies
        working-directory: backend
        run: npm ci

      - name: ğŸ­ Install Playwright browsers
        working-directory: backend
        run: npx playwright install --with-deps chromium

      - name: ğŸ—„ï¸ Setup database schema
        working-directory: backend
        env:
          PGPASSWORD: test123
        run: |
          # Ejecutar migraciones
          psql -h localhost -U postgres -d attendance_system_test -f migrations/*.sql || echo "Migrations might fail, continuing..."

      - name: ğŸš€ Start backend server (background)
        working-directory: backend
        env:
          PORT: 9998
          DATABASE_URL: postgresql://postgres:test123@localhost:5432/attendance_system_test
          JWT_SECRET: test-secret-key
          NODE_ENV: test
        run: |
          npm start &
          sleep 10
          curl http://localhost:9998/api/v1/health || echo "Server might not be ready"

      - name: ğŸ§ª Run Playwright E2E tests
        working-directory: backend
        env:
          CI: true
        run: npx playwright test --reporter=html,list

      - name: ğŸ“Š Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: backend/playwright-report/
          retention-days: 30

      - name: ğŸ“¸ Upload screenshots (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots
          path: backend/test-results/
          retention-days: 7

      - name: ğŸ“¹ Upload videos (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-videos
          path: backend/test-results/**/*.webm
          retention-days: 7

      - name: ğŸ’¬ Comment PR with results
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **E2E Tests Failed**\n\nVer screenshots y videos en los artifacts de este workflow.'
            })
