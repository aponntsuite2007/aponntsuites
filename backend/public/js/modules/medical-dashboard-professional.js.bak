/**
 * ============================================================================
 * DASHBOARD M√âDICO PROFESIONAL
 * ============================================================================
 * Sistema completo de gesti√≥n m√©dica con historial cronol√≥gico,
 * comunicaci√≥n bidireccional y diagn√≥stico profesional.
 *
 * Dise√±o: Inspirado en Expediente 360
 * Features:
 * - Lista de casos pendientes
 * - Historial m√©dico cronol√≥gico completo
 * - Chat bidireccional m√©dico ‚Üî empleado
 * - Formulario de diagn√≥stico
 * - Cierre de casos
 * ============================================================================
 */

(function() {
    'use strict';

    // ========================================================================
    // STATE MANAGEMENT
    // ========================================================================
    let currentState = {
        selectedCase: null,
        selectedEmployee: null,
        pendingCases: [],
        medicalHistory: null,
        messages: [],
        filters: {
            status: 'all',
            priority: 'all',
            search: ''
        }
    };

    // ========================================================================
    // INITIALIZATION
    // ========================================================================
    window.initMedicalDashboard = function() {
        console.log('ü©∫ [MEDICAL-DASHBOARD] Inicializando Dashboard M√©dico Profesional...');

        const container = document.getElementById('medical-dashboard-container');
        if (!container) {
            console.error('‚ùå [MEDICAL-DASHBOARD] Container no encontrado');
            return;
        }

        renderDashboard(container);
        loadPendingCases();
        setupWebSocketConnection();
    };

    // ========================================================================
    // MAIN RENDER
    // ========================================================================
    function renderDashboard(container) {
        container.innerHTML = `
            <div class="medical-dashboard-wrapper" style="display: flex; height: calc(100vh - 100px); background: #f5f7fa;">

                <!-- LEFT PANEL: Casos Pendientes -->
                <div class="cases-panel" style="width: 350px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column;">

                    <!-- Header -->
                    <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h3 style="margin: 0 0 10px 0; color: white; font-size: 18px;">ü©∫ Casos M√©dicos</h3>
                        <div style="display: flex; gap: 8px;">
                            <input
                                type="text"
                                id="search-cases"
                                placeholder="Buscar por empleado..."
                                style="flex: 1; padding: 8px; border: none; border-radius: 4px; font-size: 13px;"
                                oninput="window.filterCases(this.value)"
                            >
                        </div>
                    </div>

                    <!-- Filters -->
                    <div style="padding: 12px; border-bottom: 1px solid #e0e0e0; background: #fafafa;">
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="filter-btn active" data-filter="all" onclick="window.filterByStatus('all')" style="flex: 1; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background: #667eea; color: white; font-size: 12px; cursor: pointer;">
                                Todos
                            </button>
                            <button class="filter-btn" data-filter="pending" onclick="window.filterByStatus('pending')" style="flex: 1; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; color: #333; font-size: 12px; cursor: pointer;">
                                Pendientes
                            </button>
                            <button class="filter-btn" data-filter="under_review" onclick="window.filterByStatus('under_review')" style="flex: 1; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; color: #333; font-size: 12px; cursor: pointer;">
                                En Revisi√≥n
                            </button>
                        </div>
                    </div>

                    <!-- Cases List -->
                    <div id="cases-list" style="flex: 1; overflow-y: auto; padding: 10px;">
                        <div style="text-align: center; padding: 40px 20px; color: #999;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 15px; display: block;"></i>
                            <p>Cargando casos...</p>
                        </div>
                    </div>

                    <!-- Stats Footer -->
                    <div id="cases-stats" style="padding: 15px; border-top: 1px solid #e0e0e0; background: #fafafa; font-size: 12px; color: #666;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Total: <strong id="total-cases">0</strong></span>
                            <span>Pendientes: <strong id="pending-cases">0</strong></span>
                        </div>
                    </div>
                </div>

                <!-- RIGHT PANEL: Detalles del Caso -->
                <div class="case-details-panel" style="flex: 1; display: flex; flex-direction: column; background: #f5f7fa;">
                    <div id="case-details-content" style="flex: 1; overflow-y: auto;">
                        ${renderEmptyState()}
                    </div>
                </div>

            </div>
        `;
    }

    // ========================================================================
    // EMPTY STATE
    // ========================================================================
    function renderEmptyState() {
        return `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 40px;">
                <div>
                    <div style="font-size: 80px; margin-bottom: 20px; opacity: 0.3;">ü©∫</div>
                    <h3 style="color: #999; margin: 0 0 10px 0;">Selecciona un Caso</h3>
                    <p style="color: #bbb; margin: 0;">Elige un caso de la lista para ver los detalles</p>
                </div>
            </div>
        `;
    }

    // ========================================================================
    // LOAD PENDING CASES
    // ========================================================================
    async function loadPendingCases() {
        console.log('üìã [MEDICAL-DASHBOARD] Cargando casos pendientes...');

        try {
            const response = await fetch('/api/medical-cases/doctor/pending', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                }
            });

            if (!response.ok) {
                throw new Error('Error al cargar casos pendientes');
            }

            const data = await response.json();
            currentState.pendingCases = data.cases || [];

            renderCasesList();
            updateCasesStats();

        } catch (error) {
            console.error('‚ùå [MEDICAL-DASHBOARD] Error:', error);
            const container = document.getElementById('cases-list');
            if (container) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #dc3545;">
                        <i class="fas fa-exclamation-circle" style="font-size: 32px; margin-bottom: 15px; display: block;"></i>
                        <p>Error al cargar casos</p>
                        <button onclick="window.loadPendingCases()" class="btn btn-sm btn-primary" style="margin-top: 10px;">
                            Reintentar
                        </button>
                    </div>
                `;
            }
        }
    }

    // ========================================================================
    // RENDER CASES LIST
    // ========================================================================
    function renderCasesList() {
        const container = document.getElementById('cases-list');
        if (!container) return;

        let filteredCases = currentState.pendingCases;

        // Apply filters
        if (currentState.filters.status !== 'all') {
            filteredCases = filteredCases.filter(c => c.case_status === currentState.filters.status);
        }

        if (currentState.filters.search) {
            const search = currentState.filters.search.toLowerCase();
            filteredCases = filteredCases.filter(c =>
                c.employee_name.toLowerCase().includes(search) ||
                c.employee_legajo.toLowerCase().includes(search)
            );
        }

        if (filteredCases.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #999;">
                    <i class="fas fa-inbox" style="font-size: 32px; margin-bottom: 15px; display: block;"></i>
                    <p>No hay casos para mostrar</p>
                </div>
            `;
            return;
        }

        let html = '';
        filteredCases.forEach(caseData => {
            const isSelected = currentState.selectedCase && currentState.selectedCase.id === caseData.id;
            const priority = calculateCasePriority(caseData);
            const priorityColor = priority === 'high' ? '#dc3545' : (priority === 'medium' ? '#ffc107' : '#28a745');

            html += `
                <div
                    class="case-card ${isSelected ? 'selected' : ''}"
                    onclick="window.selectCase('${caseData.id}')"
                    style="
                        background: ${isSelected ? '#f0f4ff' : 'white'};
                        border: 1px solid ${isSelected ? '#667eea' : '#e0e0e0'};
                        border-left: 4px solid ${priorityColor};
                        border-radius: 6px;
                        padding: 12px;
                        margin-bottom: 10px;
                        cursor: pointer;
                        transition: all 0.2s;
                    "
                    onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'"
                    onmouseout="this.style.boxShadow='none'"
                >
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <strong style="font-size: 14px; color: #333;">${caseData.employee_name}</strong>
                            <div style="font-size: 11px; color: #999; margin-top: 2px;">
                                Legajo: ${caseData.employee_legajo || 'N/A'} | DNI: ${caseData.employee_dni || 'N/A'}
                            </div>
                        </div>
                        ${caseData.unread_messages > 0 ? `
                            <span class="badge badge-danger" style="font-size: 10px; padding: 3px 6px;">
                                ${caseData.unread_messages} nuevo${caseData.unread_messages > 1 ? 's' : ''}
                            </span>
                        ` : ''}
                    </div>

                    <div style="font-size: 12px; color: #666; margin-bottom: 6px;">
                        ${getAbsenceTypeIcon(caseData.absence_type)} ${getAbsenceTypeName(caseData.absence_type)}
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: #999;">
                        <span>üìÖ ${formatDateShort(caseData.start_date)} ‚Ä¢ ${caseData.requested_days} d√≠a${caseData.requested_days > 1 ? 's' : ''}</span>
                        <span>${getCaseStatusBadge(caseData.case_status)}</span>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // ========================================================================
    // SELECT CASE
    // ========================================================================
    window.selectCase = async function(caseId) {
        console.log('üëÅÔ∏è [MEDICAL-DASHBOARD] Seleccionando caso:', caseId);

        const caseData = currentState.pendingCases.find(c => c.id === caseId);
        if (!caseData) return;

        currentState.selectedCase = caseData;
        renderCasesList(); // Re-render to show selection

        // Show loading state
        const detailsContainer = document.getElementById('case-details-content');
        detailsContainer.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; text-align: center;">
                <div>
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #667eea; margin-bottom: 20px; display: block;"></i>
                    <p style="color: #999;">Cargando historial m√©dico completo...</p>
                </div>
            </div>
        `;

        try {
            // Load complete medical history
            await loadMedicalHistory(caseData.employee_id);

            // Load case details and messages
            await loadCaseDetails(caseId);

            // Render complete view
            renderCaseDetails();

        } catch (error) {
            console.error('‚ùå [MEDICAL-DASHBOARD] Error:', error);
            detailsContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #dc3545;">
                    <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 20px; display: block;"></i>
                    <p>Error al cargar detalles del caso</p>
                    <button onclick="window.selectCase('${caseId}')" class="btn btn-primary">Reintentar</button>
                </div>
            `;
        }
    };

    // ========================================================================
    // LOAD MEDICAL HISTORY
    // ========================================================================
    async function loadMedicalHistory(employeeId) {
        console.log('üè• [MEDICAL-DASHBOARD] Cargando historial m√©dico completo:', employeeId);

        const response = await fetch(`/api/medical-cases/employee/${employeeId}/medical-history`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
            }
        });

        if (!response.ok) {
            throw new Error('Error al cargar historial m√©dico');
        }

        const data = await response.json();
        currentState.medicalHistory = data;
        currentState.selectedEmployee = data.employee;
    }

    // ========================================================================
    // LOAD CASE DETAILS
    // ========================================================================
    async function loadCaseDetails(caseId) {
        const response = await fetch(`/api/medical-cases/${caseId}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
            }
        });

        if (!response.ok) {
            throw new Error('Error al cargar detalles del caso');
        }

        const data = await response.json();
        currentState.selectedCase = data.case;
        currentState.messages = data.messages || [];
    }

    // ========================================================================
    // RENDER CASE DETAILS
    // ========================================================================
    function renderCaseDetails() {
        const container = document.getElementById('case-details-content');
        const caseData = currentState.selectedCase;
        const employee = currentState.selectedEmployee;
        const history = currentState.medicalHistory;

        container.innerHTML = `
            <!-- Header with Employee Info -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h2 style="margin: 0 0 10px 0; font-size: 24px;">ü©∫ ${employee.firstName} ${employee.lastName}</h2>
                        <div style="font-size: 14px; opacity: 0.9; line-height: 1.6;">
                            <span style="margin-right: 20px;">üìã Legajo: ${employee.employeeId || 'N/A'}</span>
                            <span style="margin-right: 20px;">üÜî DNI: ${employee.dni || 'N/A'}</span>
                            <span style="margin-right: 20px;">üìß ${employee.email || 'N/A'}</span>
                        </div>
                        <div style="font-size: 13px; opacity: 0.8; margin-top: 8px;">
                            <span style="margin-right: 15px;">üè¢ ${employee.department || 'Sin departamento'}</span>
                            <span>üïê ${employee.shift || 'Sin turno'}</span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        ${getCaseStatusBadge(caseData.case_status)}
                        <div style="font-size: 12px; margin-top: 8px; opacity: 0.9;">
                            Caso asignado ${formatDateShort(caseData.created_at)}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div style="display: flex; height: calc(100% - 115px);">

                <!-- Left Column: Medical History & Current Case -->
                <div style="flex: 1.5; overflow-y: auto; padding: 20px; border-right: 1px solid #e0e0e0; background: white;">

                    <!-- Current Case Details -->
                    ${renderCurrentCaseSection(caseData)}

                    <!-- Medical History Timeline -->
                    ${renderMedicalHistoryTimeline(history)}

                </div>

                <!-- Right Column: Communication & Actions -->
                <div style="flex: 1; display: flex; flex-direction: column; background: #fafafa;">

                    <!-- Messages -->
                    <div style="flex: 1; overflow-y: auto; padding: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">üí¨ Comunicaciones</h4>
                        ${renderMessagesSection()}
                    </div>

                    <!-- Actions Panel -->
                    <div style="border-top: 1px solid #e0e0e0; padding: 20px; background: white;">
                        ${renderActionsPanel()}
                    </div>

                </div>

            </div>
        `;

        // Setup message input handler
        setupMessageInput();
    }

    // ========================================================================
    // RENDER CURRENT CASE SECTION
    // ========================================================================
    function renderCurrentCaseSection(caseData) {
        return `
            <div style="background: #f0f4ff; border: 1px solid #667eea; border-radius: 8px; padding: 20px; margin-bottom: 25px;">
                <h4 style="margin: 0 0 15px 0; color: #667eea; font-size: 16px;">üìã Caso Actual</h4>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="font-size: 11px; color: #666; text-transform: uppercase; display: block; margin-bottom: 4px;">Tipo de Ausencia</label>
                        <div style="font-size: 14px; color: #333;">
                            ${getAbsenceTypeIcon(caseData.absence_type)} ${getAbsenceTypeName(caseData.absence_type)}
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #666; text-transform: uppercase; display: block; margin-bottom: 4px;">Fecha Inicio</label>
                        <div style="font-size: 14px; color: #333;">üìÖ ${formatDateShort(caseData.start_date)}</div>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #666; text-transform: uppercase; display: block; margin-bottom: 4px;">D√≠as Solicitados</label>
                        <div style="font-size: 14px; color: #333;">${caseData.requested_days} d√≠a${caseData.requested_days > 1 ? 's' : ''}</div>
                    </div>
                    <div>
                        <label style="font-size: 11px; color: #666; text-transform: uppercase; display: block; margin-bottom: 4px;">D√≠as Aprobados</label>
                        <div style="font-size: 14px; color: #333;">${caseData.approved_days || 'Pendiente'}</div>
                    </div>
                </div>

                ${caseData.employee_description ? `
                    <div style="background: white; padding: 15px; border-radius: 6px; border-left: 3px solid #667eea;">
                        <label style="font-size: 11px; color: #666; text-transform: uppercase; display: block; margin-bottom: 8px;">üìù Descripci√≥n del Empleado</label>
                        <div style="font-size: 13px; color: #333; line-height: 1.6; white-space: pre-wrap;">${caseData.employee_description}</div>
                    </div>
                ` : ''}

                ${caseData.final_diagnosis ? `
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; border-left: 3px solid #28a745; margin-top: 15px;">
                        <label style="font-size: 11px; color: #155724; text-transform: uppercase; display: block; margin-bottom: 8px;">ü©∫ Diagn√≥stico</label>
                        <div style="font-size: 13px; color: #155724; line-height: 1.6; white-space: pre-wrap;">${caseData.final_diagnosis}</div>
                        ${caseData.is_justified !== null ? `
                            <div style="margin-top: 10px;">
                                <span class="badge ${caseData.is_justified ? 'badge-success' : 'badge-danger'}">
                                    ${caseData.is_justified ? '‚úÖ Justificada' : '‚ùå No Justificada'}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
            </div>
        `;
    }

    // ========================================================================
    // RENDER MEDICAL HISTORY TIMELINE
    // ========================================================================
    function renderMedicalHistoryTimeline(history) {
        if (!history || !history.timeline || history.timeline.length === 0) {
            return `
                <div style="background: #fafafa; border-radius: 8px; padding: 30px; text-align: center;">
                    <i class="fas fa-history" style="font-size: 48px; color: #ddd; margin-bottom: 15px; display: block;"></i>
                    <p style="color: #999; margin: 0;">No hay historial m√©dico previo</p>
                </div>
            `;
        }

        let html = `
            <div style="margin-bottom: 20px;">
                <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                    üïê Historial M√©dico Cronol√≥gico
                    <span style="background: #667eea; color: white; font-size: 11px; padding: 3px 8px; border-radius: 12px;">
                        ${history.timeline.length} registro${history.timeline.length > 1 ? 's' : ''}
                    </span>
                </h4>
                <div style="position: relative; padding-left: 30px;">
                    <!-- Timeline vertical line -->
                    <div style="position: absolute; left: 10px; top: 0; bottom: 0; width: 2px; background: linear-gradient(180deg, #667eea 0%, #e0e0e0 100%);"></div>
        `;

        history.timeline.forEach((item, index) => {
            const isFirst = index === 0;
            const bgColor = item.type === 'absence' ? '#fff3cd' : (item.type === 'exam' ? '#d1ecf1' : '#f8d7da');
            const borderColor = item.type === 'absence' ? '#ffc107' : (item.type === 'exam' ? '#17a2b8' : '#dc3545');
            const icon = item.type === 'absence' ? 'ü©∫' : (item.type === 'exam' ? 'üî¨' : 'üíä');

            html += `
                <div style="position: relative; margin-bottom: 20px;">
                    <!-- Timeline dot -->
                    <div style="position: absolute; left: -25px; top: 8px; width: 12px; height: 12px; border-radius: 50%; background: ${isFirst ? '#667eea' : borderColor}; border: 3px solid white; box-shadow: 0 0 0 2px ${borderColor};"></div>

                    <!-- Timeline card -->
                    <div style="background: ${bgColor}; border-left: 3px solid ${borderColor}; border-radius: 6px; padding: 15px; cursor: pointer;"
                         onclick="window.toggleTimelineItem('timeline-${index}')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 14px; color: #333; margin-bottom: 5px;">
                                    ${icon} ${getTimelineItemTitle(item)}
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    üìÖ ${formatDateShort(item.date)} ‚Ä¢ ${item.type === 'absence' ? item.data.absence_type : item.data.exam_type || 'Examen m√©dico'}
                                </div>
                            </div>
                            <i class="fas fa-chevron-down" id="timeline-${index}-icon" style="color: #999; font-size: 12px; transition: transform 0.2s;"></i>
                        </div>

                        <!-- Expandable details -->
                        <div id="timeline-${index}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);">
                            ${renderTimelineItemDetails(item)}
                        </div>
                    </div>
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;

        return html;
    }

    // ========================================================================
    // TOGGLE TIMELINE ITEM
    // ========================================================================
    window.toggleTimelineItem = function(itemId) {
        const element = document.getElementById(itemId);
        const icon = document.getElementById(itemId + '-icon');

        if (element.style.display === 'none') {
            element.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
        } else {
            element.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    };

    // ========================================================================
    // RENDER TIMELINE ITEM DETAILS
    // ========================================================================
    function renderTimelineItemDetails(item) {
        if (item.type === 'absence') {
            return `
                <div style="font-size: 13px; line-height: 1.6; color: #555;">
                    <div><strong>Estado:</strong> ${getCaseStatusBadge(item.data.case_status)}</div>
                    <div style="margin-top: 5px;"><strong>D√≠as solicitados:</strong> ${item.data.requested_days}</div>
                    ${item.data.approved_days ? `<div><strong>D√≠as aprobados:</strong> ${item.data.approved_days}</div>` : ''}
                    ${item.data.final_diagnosis ? `
                        <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                            <strong>Diagn√≥stico:</strong><br>
                            ${item.data.final_diagnosis}
                        </div>
                    ` : ''}
                </div>
            `;
        } else if (item.type === 'exam') {
            return `
                <div style="font-size: 13px; line-height: 1.6; color: #555;">
                    <div><strong>Tipo:</strong> ${item.data.exam_type || 'Examen m√©dico'}</div>
                    <div><strong>Fecha:</strong> ${formatDateShort(item.data.exam_date)}</div>
                    ${item.data.result ? `<div><strong>Resultado:</strong> ${item.data.result}</div>` : ''}
                    ${item.data.doctor_notes ? `
                        <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                            <strong>Notas:</strong><br>
                            ${item.data.doctor_notes}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        return '';
    }

    // ========================================================================
    // RENDER MESSAGES SECTION
    // ========================================================================
    function renderMessagesSection() {
        if (currentState.messages.length === 0) {
            return `
                <div style="text-align: center; padding: 40px 20px; color: #999;">
                    <i class="fas fa-comments" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; display: block;"></i>
                    <p>No hay mensajes a√∫n</p>
                    <p style="font-size: 12px; color: #bbb;">Env√≠a el primer mensaje al empleado</p>
                </div>
            `;
        }

        let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';

        currentState.messages.forEach(msg => {
            const isDoctor = msg.sender_type === 'doctor';
            const isSystem = msg.sender_type === 'system';
            const bgColor = isSystem ? '#f5f5f5' : (isDoctor ? '#e3f2fd' : '#fff3cd');
            const borderColor = isSystem ? '#999' : (isDoctor ? '#2196f3' : '#ffc107');
            const icon = isSystem ? 'ü§ñ' : (isDoctor ? 'üë®‚Äç‚öïÔ∏è' : 'üë§');

            html += `
                <div style="background: ${bgColor}; border-left: 3px solid ${borderColor}; border-radius: 6px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <strong style="font-size: 13px; color: #333;">${icon} ${msg.sender_name || msg.sender_type}</strong>
                        <span style="font-size: 11px; color: #999;">${formatDateShort(msg.created_at)}</span>
                    </div>
                    <p style="margin: 0; font-size: 13px; color: #555; line-height: 1.5; white-space: pre-wrap;">${msg.message}</p>
                    ${msg.attachments && msg.attachments.length > 0 ? `
                        <div style="margin-top: 10px; font-size: 12px;">
                            <strong>üìé Adjuntos:</strong><br>
                            ${msg.attachments.map(att => `
                                <a href="${att.url}" target="_blank" style="display: inline-block; margin-right: 10px; margin-top: 5px; color: #667eea;">
                                    ${att.filename}
                                </a>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        });

        html += '</div>';

        // Add message input
        html += `
            <div style="margin-top: 20px; background: white; border-radius: 8px; padding: 15px; border: 1px solid #e0e0e0;">
                <textarea
                    id="message-input"
                    placeholder="Escribe un mensaje al empleado..."
                    style="width: 100%; min-height: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 10px; font-size: 13px; resize: vertical;"
                ></textarea>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <input type="file" id="message-attachments" multiple style="font-size: 12px;">
                    <button onclick="window.sendMessage()" class="btn btn-primary btn-sm">
                        üì§ Enviar
                    </button>
                </div>
            </div>
        `;

        return html;
    }

    // ========================================================================
    // SEND MESSAGE
    // ========================================================================
    window.sendMessage = async function() {
        const messageInput = document.getElementById('message-input');
        const attachmentsInput = document.getElementById('message-attachments');

        const message = messageInput.value.trim();
        if (!message) {
            alert('Por favor escribe un mensaje');
            return;
        }

        const formData = new FormData();
        formData.append('message', message);
        formData.append('message_type', 'follow_up');

        if (attachmentsInput.files.length > 0) {
            for (let i = 0; i < attachmentsInput.files.length; i++) {
                formData.append('attachments', attachmentsInput.files[i]);
            }
        }

        try {
            const response = await fetch(`/api/medical-cases/${currentState.selectedCase.id}/messages`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error('Error al enviar mensaje');
            }

            // Clear inputs
            messageInput.value = '';
            attachmentsInput.value = '';

            // Reload messages
            await loadCaseDetails(currentState.selectedCase.id);
            renderCaseDetails();

            showNotification('‚úÖ Mensaje enviado exitosamente', 'success');

        } catch (error) {
            console.error('‚ùå [MEDICAL-DASHBOARD] Error:', error);
            alert('Error al enviar mensaje: ' + error.message);
        }
    };

    // ========================================================================
    // RENDER ACTIONS PANEL
    // ========================================================================
    function renderActionsPanel() {
        const caseData = currentState.selectedCase;
        const canDiagnose = !caseData.final_diagnosis && caseData.case_status !== 'closed';
        const canClose = caseData.final_diagnosis && caseData.case_status !== 'closed';

        return `
            <h4 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">‚ö° Acciones</h4>

            ${canDiagnose ? `
                <button
                    onclick="window.showDiagnosisModal()"
                    class="btn btn-success btn-block"
                    style="margin-bottom: 10px; padding: 12px; font-size: 14px;"
                >
                    ü©∫ Enviar Diagn√≥stico
                </button>
            ` : ''}

            ${canClose ? `
                <button
                    onclick="window.closeCaseModal()"
                    class="btn btn-primary btn-block"
                    style="margin-bottom: 10px; padding: 12px; font-size: 14px;"
                >
                    ‚úÖ Cerrar Expediente
                </button>
            ` : ''}

            <button
                onclick="window.requestDocuments()"
                class="btn btn-warning btn-block"
                style="margin-bottom: 10px; padding: 12px; font-size: 14px;"
            >
                üìÑ Solicitar Documentaci√≥n
            </button>

            <button
                onclick="window.loadPendingCases()"
                class="btn btn-secondary btn-block"
                style="padding: 12px; font-size: 14px;"
            >
                üîÑ Actualizar Lista
            </button>
        `;
    }

    // ========================================================================
    // SHOW DIAGNOSIS MODAL
    // ========================================================================
    window.showDiagnosisModal = function() {
        const modal = document.createElement('div');
        modal.id = 'diagnosisModal';
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center;
            align-items: center; z-index: 10001;
        `;

        modal.innerHTML = `
            <div style="background: white; padding: 30px; border-radius: 12px; width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
                <h3 style="margin: 0 0 20px 0; color: #667eea;">ü©∫ Diagn√≥stico M√©dico</h3>

                <form id="diagnosisForm">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Diagn√≥stico Completo:</label>
                        <textarea
                            id="final-diagnosis"
                            class="form-control"
                            rows="6"
                            placeholder="Describa el diagn√≥stico m√©dico completo..."
                            required
                            style="font-size: 14px;"
                        ></textarea>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Justificaci√≥n de la Ausencia:</label>
                        <div style="display: flex; gap: 20px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="is_justified" value="true" required style="margin-right: 8px;">
                                <span style="color: #28a745; font-weight: bold;">‚úÖ Justificada</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="is_justified" value="false" required style="margin-right: 8px;">
                                <span style="color: #dc3545; font-weight: bold;">‚ùå No Justificada</span>
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">D√≠as Aprobados:</label>
                        <input
                            type="number"
                            id="approved-days"
                            class="form-control"
                            min="0"
                            max="${currentState.selectedCase.requested_days}"
                            value="${currentState.selectedCase.requested_days}"
                            required
                            style="font-size: 14px;"
                        >
                        <small style="color: #666; font-size: 12px;">D√≠as solicitados: ${currentState.selectedCase.requested_days}</small>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Motivo (opcional):</label>
                        <textarea
                            id="justification-reason"
                            class="form-control"
                            rows="3"
                            placeholder="Explique el motivo de la justificaci√≥n o rechazo..."
                            style="font-size: 14px;"
                        ></textarea>
                    </div>

                    <div style="text-align: right; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <button type="button" onclick="document.getElementById('diagnosisModal').remove()" class="btn btn-secondary" style="margin-right: 10px;">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            ü©∫ Enviar Diagn√≥stico
                        </button>
                    </div>
                </form>
            </div>
        `;

        document.body.appendChild(modal);

        document.getElementById('diagnosisForm').onsubmit = async (e) => {
            e.preventDefault();
            await submitDiagnosis();
        };
    };

    // ========================================================================
    // SUBMIT DIAGNOSIS
    // ========================================================================
    async function submitDiagnosis() {
        const diagnosis = document.getElementById('final-diagnosis').value;
        const isJustified = document.querySelector('input[name="is_justified"]:checked').value === 'true';
        const approvedDays = parseInt(document.getElementById('approved-days').value);
        const reason = document.getElementById('justification-reason').value;

        try {
            const response = await fetch(`/api/medical-cases/${currentState.selectedCase.id}/diagnosis`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify({
                    final_diagnosis: diagnosis,
                    is_justified: isJustified,
                    approved_days: approvedDays,
                    justification_reason: reason
                })
            });

            if (!response.ok) {
                throw new Error('Error al enviar diagn√≥stico');
            }

            document.getElementById('diagnosisModal').remove();
            showNotification('‚úÖ Diagn√≥stico enviado exitosamente', 'success');

            // Reload case
            await selectCase(currentState.selectedCase.id);
            await loadPendingCases();

        } catch (error) {
            console.error('‚ùå [MEDICAL-DASHBOARD] Error:', error);
            alert('Error al enviar diagn√≥stico: ' + error.message);
        }
    }

    // ========================================================================
    // CLOSE CASE MODAL
    // ========================================================================
    window.closeCaseModal = async function() {
        if (!confirm('¬øEst√° seguro de cerrar este expediente m√©dico? Esta acci√≥n es definitiva.')) {
            return;
        }

        try {
            const response = await fetch(`/api/medical-cases/${currentState.selectedCase.id}/close`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify({
                    notes: 'Expediente cerrado por el m√©dico'
                })
            });

            if (!response.ok) {
                throw new Error('Error al cerrar expediente');
            }

            showNotification('‚úÖ Expediente cerrado exitosamente', 'success');

            // Reload
            await loadPendingCases();
            document.getElementById('case-details-content').innerHTML = renderEmptyState();
            currentState.selectedCase = null;

        } catch (error) {
            console.error('‚ùå [MEDICAL-DASHBOARD] Error:', error);
            alert('Error al cerrar expediente: ' + error.message);
        }
    };

    // ========================================================================
    // REQUEST DOCUMENTS
    // ========================================================================
    window.requestDocuments = function() {
        const message = prompt('¬øQu√© documentos necesita solicitar al empleado?', 'Certificado m√©dico actualizado');
        if (!message) return;

        // Use send message with request_document type
        document.getElementById('message-input').value = message;
        sendMessage();
    };

    // ========================================================================
    // FILTERS
    // ========================================================================
    window.filterByStatus = function(status) {
        currentState.filters.status = status;

        // Update button states
        document.querySelectorAll('.filter-btn').forEach(btn => {
            if (btn.dataset.filter === status) {
                btn.classList.add('active');
                btn.style.background = '#667eea';
                btn.style.color = 'white';
            } else {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = '#333';
            }
        });

        renderCasesList();
    };

    window.filterCases = function(searchTerm) {
        currentState.filters.search = searchTerm;
        renderCasesList();
    };

    // ========================================================================
    // UPDATE STATS
    // ========================================================================
    function updateCasesStats() {
        const total = currentState.pendingCases.length;
        const pending = currentState.pendingCases.filter(c => c.case_status === 'pending').length;

        document.getElementById('total-cases').textContent = total;
        document.getElementById('pending-cases').textContent = pending;
    }

    // ========================================================================
    // WEBSOCKET CONNECTION
    // ========================================================================
    function setupWebSocketConnection() {
        // TODO: Implement WebSocket for real-time updates
        console.log('üîå [MEDICAL-DASHBOARD] WebSocket connection (placeholder)');
    }

    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================
    function setupMessageInput() {
        // Auto-focus message input
        const input = document.getElementById('message-input');
        if (input) {
            input.focus();
        }
    }

    function calculateCasePriority(caseData) {
        const daysSinceCreated = Math.floor((new Date() - new Date(caseData.created_at)) / (1000 * 60 * 60 * 24));
        if (daysSinceCreated > 3) return 'high';
        if (daysSinceCreated > 1) return 'medium';
        return 'low';
    }

    function getTimelineItemTitle(item) {
        if (item.type === 'absence') {
            return 'Ausencia M√©dica';
        } else if (item.type === 'exam') {
            return item.data.exam_type || 'Examen M√©dico';
        }
        return 'Evento M√©dico';
    }

    function getAbsenceTypeIcon(type) {
        const icons = {
            'medical_illness': 'ü©∫',
            'work_accident': 'üöë',
            'non_work_accident': 'ü§ï',
            'occupational_disease': '‚ö†Ô∏è',
            'maternity': 'ü§±',
            'family_care': 'üë®‚Äçüë©‚Äçüëß',
            'authorized_leave': '‚úÖ',
            'unauthorized': '‚ùå'
        };
        return icons[type] || 'üìã';
    }

    function getAbsenceTypeName(type) {
        const names = {
            'medical_illness': 'Enfermedad Com√∫n',
            'work_accident': 'Accidente Laboral',
            'non_work_accident': 'Accidente No Laboral',
            'occupational_disease': 'Enfermedad Profesional',
            'maternity': 'Maternidad',
            'family_care': 'Cuidado Familiar',
            'authorized_leave': 'Licencia Autorizada',
            'unauthorized': 'Injustificada'
        };
        return names[type] || type;
    }

    function getCaseStatusBadge(status) {
        const badges = {
            'pending': '<span class="badge" style="background: #ffc107; color: #856404; font-size: 10px; padding: 4px 8px;">‚è≥ Pendiente</span>',
            'under_review': '<span class="badge" style="background: #17a2b8; color: white; font-size: 10px; padding: 4px 8px;">üîç En Revisi√≥n</span>',
            'awaiting_docs': '<span class="badge" style="background: #ffc107; color: #856404; font-size: 10px; padding: 4px 8px;">üìÑ Esperando Docs</span>',
            'needs_follow_up': '<span class="badge" style="background: #007bff; color: white; font-size: 10px; padding: 4px 8px;">ü©∫ Seguimiento</span>',
            'justified': '<span class="badge" style="background: #28a745; color: white; font-size: 10px; padding: 4px 8px;">‚úÖ Justificada</span>',
            'not_justified': '<span class="badge" style="background: #dc3545; color: white; font-size: 10px; padding: 4px 8px;">‚ùå No Justificada</span>',
            'closed': '<span class="badge" style="background: #6c757d; color: white; font-size: 10px; padding: 4px 8px;">üîí Cerrada</span>'
        };
        return badges[status] || `<span class="badge badge-secondary">${status}</span>`;
    }

    function formatDateShort(dateStr) {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        return date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function showNotification(message, type) {
        // Simple notification (can be replaced with toast library)
        alert(message);
    }

    // ========================================================================
    // EXPOSE PUBLIC API
    // ========================================================================
    window.loadPendingCases = loadPendingCases;

    console.log('‚úÖ [MEDICAL-DASHBOARD] Module loaded successfully');

})();
