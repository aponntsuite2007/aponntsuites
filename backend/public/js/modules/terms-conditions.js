// Terms Conditions Module - v4.0 PROGRESSIVE
console.log('üìã [TERMS-CONDITIONS] M√≥dulo terms-conditions cargado');

// Terms functions - IMPORTANTE: nombre correcto sin may√∫scula en 'conditions'
function showTermsconditionsContent() {
    const content = document.getElementById('mainContent');
    if (!content) return;
    
    content.innerHTML = `
        <div class="tab-content active" id="terms-conditions">
            <div class="card">
                <h2>üìã Gesti√≥n de T√©rminos y Condiciones</h2>
                <p>Administre las versiones de t√©rminos y condiciones que los empleados deben aceptar para comunicaciones fehacientes.</p>
                
                <!-- Editor de T√©rminos Actuales -->
                <div style="display: grid; grid-template-columns: 1fr 300px; gap: 30px; margin-bottom: 30px;">
                    <div>
                        <h3>üìù Editor de T√©rminos</h3>
                        <div class="form-group">
                            <label for="terms-version">üîÑ Versi√≥n:</label>
                            <input type="text" id="terms-version" placeholder="1.0" value="1.0">
                        </div>
                        
                        <div class="form-group">
                            <label for="terms-title">üìÑ T√≠tulo:</label>
                            <input type="text" id="terms-title" placeholder="T√©rminos y Condiciones de Comunicaciones Fehacientes" 
                                   value="T√©rminos y Condiciones de Comunicaciones Fehacientes">
                        </div>
                        
                        <div class="form-group">
                            <label for="terms-content">üìã Contenido:</label>
                            <textarea id="terms-content" rows="15" style="width: 100%; font-family: monospace; font-size: 0.9em;">T√âRMINOS Y CONDICIONES PARA COMUNICACIONES FEHACIENTES

1. ACEPTACI√ìN DE LOS T√âRMINOS
Al aceptar estos t√©rminos y condiciones, el empleado otorga su consentimiento expreso e informado para recibir comunicaciones oficiales de la empresa a trav√©s de los medios digitales seleccionados (SMS, WhatsApp, Email).

2. NATURALEZA FEHACIENTE DE LAS COMUNICACIONES  
El empleado reconoce que:
‚Ä¢ Las comunicaciones enviadas por estos medios tendr√°n valor probatorio y validez legal
‚Ä¢ Constituyen notificaciones formales y fehacientes seg√∫n la legislaci√≥n argentina
‚Ä¢ Su recepci√≥n se considerar√° acreditada mediante acuses de entrega autom√°ticos
‚Ä¢ El no acceso o lectura no exime de responsabilidades legales

3. DATOS DE CONTACTO
El empleado se compromete a:
‚Ä¢ Mantener actualizados sus datos de contacto (tel√©fono, WhatsApp, email)  
‚Ä¢ Notificar inmediatamente cualquier cambio en los mismos
‚Ä¢ Asegurar el acceso regular a los medios de comunicaci√≥n autorizados
‚Ä¢ Responder en los plazos establecidos para cada tipo de comunicaci√≥n

4. TIPOS DE COMUNICACIONES
Se utilizar√°n estos canales para:
‚Ä¢ Solicitudes de documentaci√≥n m√©dica
‚Ä¢ Notificaciones de cumplimiento o incumplimiento
‚Ä¢ Requerimientos de informaci√≥n adicional
‚Ä¢ Comunicaciones relacionadas con ausencias m√©dicas
‚Ä¢ Otras comunicaciones laborales de car√°cter formal

5. RESPONSABILIDADES DEL EMPLEADO
El empleado declara que:
‚Ä¢ Los medios de comunicaci√≥n proporcionados son de uso personal y exclusivo
‚Ä¢ Mantendr√° la confidencialidad de las comunicaciones recibidas
‚Ä¢ Acusar√° recibo cuando sea requerido
‚Ä¢ Cumplir√° con los plazos y requerimientos comunicados

6. REVOCACI√ìN DEL CONSENTIMIENTO
El empleado puede:
‚Ä¢ Revocar su consentimiento en cualquier momento mediante comunicaci√≥n escrita
‚Ä¢ La revocaci√≥n no afectar√° la validez de comunicaciones anteriores
‚Ä¢ Deber√° proporcionar un medio alternativo de notificaci√≥n fehaciente

7. VIGENCIA Y MODIFICACIONES
‚Ä¢ Estos t√©rminos rigen desde su aceptaci√≥n hasta su revocaci√≥n
‚Ä¢ La empresa puede modificarlos previa notificaci√≥n fehaciente
‚Ä¢ Las modificaciones requieren nueva aceptaci√≥n expresa

8. LEGISLACI√ìN APLICABLE
Estos t√©rminos se rigen por la legislaci√≥n argentina, especialmente:
‚Ä¢ C√≥digo Civil y Comercial de la Naci√≥n
‚Ä¢ Ley de Protecci√≥n de Datos Personales N¬∞ 25.326
‚Ä¢ Ley de Contrato de Trabajo N¬∞ 20.744

FECHA: _______________
EMPLEADO: _______________
FIRMA: _______________</textarea>
                        </div>
                        
                        <div class="form-group">
                            <button onclick="saveTermsAndConditions()" class="btn btn-primary" style="width: 100%;">
                                üíæ Guardar T√©rminos y Condiciones
                            </button>
                        </div>
                    </div>
                    
                    <!-- Panel Lateral de Control -->
                    <div>
                        <h3>‚öôÔ∏è Control de Versiones</h3>
                        
                        <div class="stat-card" style="margin-bottom: 20px;">
                            <div class="stat-number" id="current-version">1.0</div>
                            <div class="stat-label">üìã Versi√≥n Actual</div>
                        </div>
                        
                        <div class="stat-card" style="margin-bottom: 20px;">
                            <div class="stat-number" id="acceptance-count">0</div>
                            <div class="stat-label">‚úÖ Aceptaciones</div>
                        </div>
                        
                        <div class="form-group">
                            <label>üéØ Acciones R√°pidas:</label>
                            <button onclick="previewTerms()" class="btn btn-info btn-sm" style="width: 100%; margin-bottom: 10px;">
                                üëÅÔ∏è Vista Previa
                            </button>
                            <button onclick="generateTermsPDF()" class="btn btn-secondary btn-sm" style="width: 100%; margin-bottom: 10px;">
                                üìÑ Generar PDF
                            </button>
                            <button onclick="notifyAllEmployees()" class="btn btn-warning btn-sm" style="width: 100%; margin-bottom: 10px;">
                                üìß Notificar a Todos
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label>üìä Estad√≠sticas:</label>
                            <div style="font-size: 0.9em; line-height: 1.6;">
                                <p>‚Ä¢ <strong>Pendientes:</strong> <span id="pending-acceptances">3</span></p>
                                <p>‚Ä¢ <strong>Completados:</strong> <span id="completed-acceptances">1</span></p>
                                <p>‚Ä¢ <strong>√öltima actualizaci√≥n:</strong> <span id="last-update">Nunca</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Historial de Aceptaciones -->
                <div class="card">
                    <h3>üìä Historial de Aceptaciones</h3>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button onclick="showAllAcceptances()" class="btn btn-primary btn-sm">üë• Ver Todos</button>
                        <button onclick="showPendingAcceptances()" class="btn btn-warning btn-sm">‚è≥ Pendientes</button>
                        <button onclick="showCompletedAcceptances()" class="btn btn-success btn-sm">‚úÖ Completados</button>
                        <button onclick="exportAcceptanceData()" class="btn btn-info btn-sm">üìä Exportar</button>
                    </div>
                    
                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>üë§ Empleado</th>
                                    <th>üìã Estado</th>
                                    <th>üìÖ Fecha Aceptaci√≥n</th>
                                    <th>üîÑ Versi√≥n</th>
                                    <th>üíª Dispositivo</th>
                                    <th>üåê IP</th>
                                    <th>‚öôÔ∏è Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="acceptance-tbody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 20px;">
                                        üîÑ Cargando historial de aceptaciones...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Modal para Vista Previa de T√©rminos -->
            <div id="terms-preview-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
                <div class="modal-content" style="background: white; margin: 2% auto; padding: 20px; border-radius: 10px; max-width: 800px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header" style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <h3>üëÅÔ∏è Vista Previa de T√©rminos y Condiciones</h3>
                        <span onclick="closeTermsPreview()" style="font-size: 24px; cursor: pointer; color: #999;">&times;</span>
                    </div>
                    
                    <div class="modal-body">
                        <div id="terms-preview-content" style="white-space: pre-wrap; line-height: 1.6; font-size: 0.95em; background: #f8f9fa; padding: 20px; border-radius: 5px;">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                    </div>
                    
                    <div class="modal-footer" style="border-top: 1px solid #eee; padding-top: 15px; text-align: right; margin-top: 20px;">
                        <button onclick="closeTermsPreview()" class="btn btn-secondary" style="margin-right: 10px;">‚ùå Cerrar</button>
                        <button onclick="generateTermsPDF()" class="btn btn-primary">üìÑ Generar PDF</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    console.log('üìã [TERMS-CONDITIONS] Interfaz cargada');
    loadTermsData();
}

// Variables globales del m√≥dulo
let termsData = {
    version: '1.0',
    title: 'T√©rminos y Condiciones de Comunicaciones Fehacientes',
    content: '',
    lastUpdate: null,
    acceptances: []
};

let acceptanceHistory = [];
let currentAcceptanceFilter = 'all';

// Cargar datos de t√©rminos y condiciones
async function loadTermsData() {
    try {
        showTermsMessage('üîÑ Cargando datos de t√©rminos y condiciones...', 'info');
        
        // Simular datos de aceptaciones
        acceptanceHistory = [
            {
                id: 1,
                employeeName: 'Juan P√©rez',
                employeeId: 1,
                termsVersion: '1.0',
                acceptedDate: '2025-01-15',
                ipAddress: '192.168.1.100',
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
                status: 'accepted',
                device: 'Windows PC'
            },
            {
                id: 2,
                employeeName: 'Mar√≠a Gonz√°lez',
                employeeId: 2,
                termsVersion: null,
                acceptedDate: null,
                ipAddress: null,
                userAgent: null,
                status: 'pending',
                device: null
            },
            {
                id: 3,
                employeeName: 'Carlos Rodriguez',
                employeeId: 3,
                termsVersion: null,
                acceptedDate: null,
                ipAddress: null,
                userAgent: null,
                status: 'pending',
                device: null
            },
            {
                id: 4,
                employeeName: 'Ana Mart√≠nez',
                employeeId: 4,
                termsVersion: null,
                acceptedDate: null,
                ipAddress: null,
                userAgent: null,
                status: 'pending',
                device: null
            },
            {
                id: 5,
                employeeName: 'Luis L√≥pez',
                employeeId: 5,
                termsVersion: '1.0',
                acceptedDate: '2025-01-18',
                ipAddress: '192.168.1.105',
                userAgent: 'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)',
                status: 'accepted',
                device: 'iPhone'
            }
        ];
        
        updateAcceptanceTable();
        updateTermsStats();
        showTermsMessage(`‚úÖ ${acceptanceHistory.length} empleados cargados`, 'success');
        
    } catch (error) {
        showTermsMessage('‚ùå Error cargando t√©rminos: ' + error.message, 'error');
    }
}

// Actualizar tabla de aceptaciones
function updateAcceptanceTable(filter = 'all') {
    const tbody = document.getElementById('acceptance-tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    currentAcceptanceFilter = filter;
    
    let filteredAcceptances = acceptanceHistory;
    
    if (filter === 'pending') {
        filteredAcceptances = acceptanceHistory.filter(acc => acc.status === 'pending');
    } else if (filter === 'completed') {
        filteredAcceptances = acceptanceHistory.filter(acc => acc.status === 'accepted');
    }
    
    if (filteredAcceptances.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #6c757d;">No hay aceptaciones para mostrar</td></tr>';
        return;
    }
    
    filteredAcceptances.forEach(acceptance => {
        const statusBadge = acceptance.status === 'accepted' ? 
            '<span class="status-badge success">‚úÖ Aceptado</span>' :
            '<span class="status-badge warning">‚è≥ Pendiente</span>';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${acceptance.employeeName}</strong></td>
            <td>${statusBadge}</td>
            <td>${acceptance.acceptedDate || '-'}</td>
            <td>${acceptance.termsVersion || '-'}</td>
            <td>${acceptance.device || '-'}</td>
            <td style="font-family: monospace; font-size: 0.8em;">${acceptance.ipAddress || '-'}</td>
            <td>
                <button onclick="viewAcceptanceDetails(${acceptance.id})" class="btn-icon" style="background: #007bff; margin-right: 5px;">üìã</button>
                ${acceptance.status === 'pending' ? 
                    '<button onclick="sendTermsReminder(' + acceptance.employeeId + ')" class="btn-icon" style="background: #ffc107;">üìß</button>' : 
                    '<button onclick="revokeAcceptance(' + acceptance.id + ')" class="btn-icon" style="background: #dc3545;">üóëÔ∏è</button>'
                }
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Actualizar estad√≠sticas de t√©rminos
function updateTermsStats() {
    const acceptedCount = acceptanceHistory.filter(acc => acc.status === 'accepted').length;
    const pendingCount = acceptanceHistory.filter(acc => acc.status === 'pending').length;
    
    document.getElementById('acceptance-count').textContent = acceptedCount;
    document.getElementById('pending-acceptances').textContent = pendingCount;
    document.getElementById('completed-acceptances').textContent = acceptedCount;
}

// Funciones de filtrado
function showAllAcceptances() {
    updateAcceptanceTable('all');
}

function showPendingAcceptances() {
    updateAcceptanceTable('pending');
}

function showCompletedAcceptances() {
    updateAcceptanceTable('completed');
}

// Guardar t√©rminos y condiciones
async function saveTermsAndConditions() {
    try {
        showTermsMessage('üíæ Guardando t√©rminos y condiciones...', 'info');
        
        const version = document.getElementById('terms-version').value;
        const title = document.getElementById('terms-title').value;
        const content = document.getElementById('terms-content').value;
        
        if (!version || !title || !content) {
            showTermsMessage('‚ùå Todos los campos son obligatorios', 'error');
            return;
        }
        
        termsData = {
            version: version,
            title: title,
            content: content,
            lastUpdate: new Date().toISOString().split('T')[0]
        };
        
        // Actualizar estad√≠sticas
        document.getElementById('current-version').textContent = version;
        document.getElementById('last-update').textContent = termsData.lastUpdate;
        
        showTermsMessage('‚úÖ T√©rminos y condiciones guardados exitosamente', 'success');
        
    } catch (error) {
        showTermsMessage('‚ùå Error guardando t√©rminos: ' + error.message, 'error');
    }
}

// Vista previa de t√©rminos
function previewTerms() {
    const title = document.getElementById('terms-title').value;
    const content = document.getElementById('terms-content').value;
    const version = document.getElementById('terms-version').value;
    
    const previewContent = document.getElementById('terms-preview-content');
    previewContent.innerHTML = `<h2>${title}</h2><p><strong>Versi√≥n:</strong> ${version}</p><hr><div>${content}</div>`;
    
    document.getElementById('terms-preview-modal').style.display = 'block';
}

// Cerrar vista previa
function closeTermsPreview() {
    document.getElementById('terms-preview-modal').style.display = 'none';
}

// Generar PDF de t√©rminos
function generateTermsPDF() {
    showTermsMessage('üìÑ Generando PDF de t√©rminos...', 'info');
    // En un entorno real, esto generar√≠a un PDF
    setTimeout(() => {
        showTermsMessage('‚úÖ PDF generado exitosamente', 'success');
    }, 2000);
}

// Notificar a todos los empleados
function notifyAllEmployees() {
    const pendingEmployees = acceptanceHistory.filter(acc => acc.status === 'pending');
    showTermsMessage(`üìß Enviando notificaci√≥n a ${pendingEmployees.length} empleados...`, 'info');
    
    setTimeout(() => {
        showTermsMessage(`‚úÖ Notificaciones enviadas a ${pendingEmployees.length} empleados`, 'success');
    }, 3000);
}

// Ver detalles de aceptaci√≥n
function viewAcceptanceDetails(acceptanceId) {
    const acceptance = acceptanceHistory.find(acc => acc.id === acceptanceId);
    if (!acceptance) return;
    
    const detailsHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 20000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-top: 0; color: #2c3e50;">üìã Detalles de Aceptaci√≥n</h3>
                <h4 style="color: #3498db; margin-bottom: 25px;">üë§ ${acceptance.employeeName}</h4>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>üìä Estado:</strong><br>
                            ${acceptance.status === 'accepted' ? 
                                '<span style="color: #28a745;">‚úÖ Aceptado</span>' : 
                                '<span style="color: #ffc107;">‚è≥ Pendiente</span>'
                            }
                        </div>
                        <div>
                            <strong>üìÖ Fecha:</strong><br>
                            ${acceptance.acceptedDate || 'No aceptado'}
                        </div>
                        <div>
                            <strong>üîÑ Versi√≥n:</strong><br>
                            ${acceptance.termsVersion || 'N/A'}
                        </div>
                        <div>
                            <strong>üíª Dispositivo:</strong><br>
                            ${acceptance.device || 'No registrado'}
                        </div>
                    </div>
                </div>
                
                ${acceptance.ipAddress ? `
                    <div style="margin-bottom: 20px;">
                        <p><strong>üåê Direcci√≥n IP:</strong> ${acceptance.ipAddress}</p>
                        <p><strong>üîß User Agent:</strong><br><small style="font-family: monospace; background: #f1f1f1; padding: 5px; border-radius: 3px;">${acceptance.userAgent}</small></p>
                    </div>
                ` : ''}
                
                ${acceptance.status === 'pending' ? `
                    <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                        <strong>‚ö†Ô∏è Acci√≥n Requerida:</strong><br>
                        Este empleado a√∫n no ha aceptado los t√©rminos y condiciones.
                    </div>
                ` : ''}
                
                <div style="text-align: center;">
                    ${acceptance.status === 'pending' ? 
                        `<button onclick="sendTermsReminder(${acceptance.employeeId}); this.parentElement.parentElement.parentElement.remove();" 
                                style="margin-right: 10px; padding: 10px 20px; background: #ffc107; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            üìß Enviar Recordatorio
                        </button>` : ''
                    }
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                            style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        ‚úÖ Cerrar
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', detailsHtml);
}

// Enviar recordatorio de t√©rminos
function sendTermsReminder(employeeId) {
    const employee = acceptanceHistory.find(acc => acc.employeeId === employeeId);
    if (!employee) return;
    
    showTermsMessage(`üìß Enviando recordatorio a ${employee.employeeName}...`, 'info');
    
    setTimeout(() => {
        showTermsMessage(`‚úÖ Recordatorio enviado a ${employee.employeeName}`, 'success');
    }, 2000);
}

// Revocar aceptaci√≥n
function revokeAcceptance(acceptanceId) {
    const acceptance = acceptanceHistory.find(acc => acc.id === acceptanceId);
    if (!acceptance) return;
    
    if (confirm(`¬øEst√° seguro que desea revocar la aceptaci√≥n de ${acceptance.employeeName}?`)) {
        acceptance.status = 'pending';
        acceptance.acceptedDate = null;
        acceptance.termsVersion = null;
        acceptance.ipAddress = null;
        acceptance.userAgent = null;
        acceptance.device = null;
        
        updateAcceptanceTable(currentAcceptanceFilter);
        updateTermsStats();
        
        showTermsMessage(`‚úÖ Aceptaci√≥n revocada para ${acceptance.employeeName}`, 'success');
    }
}

// Exportar datos de aceptaciones
function exportAcceptanceData() {
    try {
        const csvContent = [
            ['Empleado', 'Estado', 'Fecha Aceptaci√≥n', 'Versi√≥n', 'Dispositivo', 'IP', 'User Agent'],
            ...acceptanceHistory.map(acc => [
                acc.employeeName,
                acc.status === 'accepted' ? 'Aceptado' : 'Pendiente',
                acc.acceptedDate || '',
                acc.termsVersion || '',
                acc.device || '',
                acc.ipAddress || '',
                acc.userAgent || ''
            ])
        ].map(row => row.join(',')).join('\\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `aceptaciones_terminos_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        showTermsMessage('‚úÖ Datos de aceptaciones exportados exitosamente', 'success');
    } catch (error) {
        showTermsMessage('‚ùå Error exportando datos: ' + error.message, 'error');
    }
}

// Mostrar mensajes de t√©rminos
function showTermsMessage(message, type) {
    console.log(`üìã [TERMS-CONDITIONS] ${message}`);
    // En un entorno real, esto podr√≠a usar el sistema de notificaciones global
    if (window.progressiveAdmin && window.progressiveAdmin.updateLoadingStatus) {
        window.progressiveAdmin.updateLoadingStatus(message);
    }
}