// ================================
// VACATION MANAGEMENT - SISTEMA PROFESIONAL COMPLETO
// Multi-Tenant | Programaci√≥n Autom√°tica | Matriz de Compatibilidad | Dotaci√≥n M√≠nima
// ================================

console.log('üèñÔ∏è [VACATION-PRO] M√≥dulo profesional de gesti√≥n de vacaciones cargado');

// ======== VARIABLES GLOBALES ========
let authToken = localStorage.getItem('token') || sessionStorage.getItem('authToken');
let currentUser = null;
let companyId = null;
let vacationConfig = null;
let vacationScales = [];
let compatibilityMatrix = [];
let currentSchedule = [];

// ======== INICIALIZACI√ìN ========
async function initVacationModule() {
    try {
        // Obtener usuario actual
        const userStr = localStorage.getItem('user') || sessionStorage.getItem('user');
        if (userStr) {
            currentUser = JSON.parse(userStr);
            companyId = currentUser.company_id || 1;
        }

        // Cargar configuraci√≥n
        await loadVacationConfig();
    } catch (error) {
        console.error('‚ùå [VACATION-PRO] Error inicializando m√≥dulo:', error);
    }
}

// ======== CONTENIDO PRINCIPAL ========
function showVacationManagementContent() {
    console.log('üèñÔ∏è [VACATION-PRO] Ejecutando showVacationManagementContent()');

    const content = document.getElementById('mainContent');
    if (!content) {
        console.error('‚ùå [VACATION-PRO] mainContent no encontrado');
        return;
    }

    content.style.setProperty('display', 'block', 'important');

    content.innerHTML = `
        <div class="tab-content active">
            <div class="card" style="padding: 0; overflow: hidden;">
                <!-- Header Profesional -->
                <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 50%, #1e8449 100%); color: white; padding: 30px 40px; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; right: 0; opacity: 0.1; font-size: 200px; transform: rotate(15deg);">üèñÔ∏è</div>
                    <div style="position: relative; z-index: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                            <div>
                                <h1 style="margin: 0; font-size: 32px; font-weight: 700;">üèñÔ∏è Gesti√≥n Profesional de Vacaciones</h1>
                                <p style="margin: 5px 0 0 0; opacity: 0.95; font-size: 16px;">Sistema Inteligente | Programaci√≥n Autom√°tica | Matriz de Compatibilidad</p>
                            </div>
                            <button onclick="showNewVacationModal()"
                                    style="background: rgba(255,255,255,0.25); backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.5); color: white; padding: 14px 28px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 15px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2);"
                                    onmouseover="this.style.background='rgba(255,255,255,0.35)'"
                                    onmouseout="this.style.background='rgba(255,255,255,0.25)'">
                                ‚ûï Nueva Solicitud
                            </button>
                        </div>

                        <!-- Dashboard R√°pido -->
                        <div id="vacationQuickStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 25px;">
                            ${getQuickStatsHTML()}
                        </div>
                    </div>
                </div>

                <!-- Tabs de Navegaci√≥n Profesional -->
                <div style="background: #f8f9fa; border-bottom: 2px solid #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div style="display: flex; padding: 0 40px; overflow-x: auto;">
                        <button onclick="switchVacationTab('dashboard')" id="tab-dashboard"
                                class="vacation-tab active-vacation-tab"
                                style="padding: 18px 24px; border: none; background: none; cursor: pointer; font-weight: 600; font-size: 14px; border-bottom: 3px solid #27ae60; white-space: nowrap; transition: all 0.3s;">
                            üìä Dashboard
                        </button>
                        <button onclick="switchVacationTab('requests')" id="tab-requests"
                                class="vacation-tab"
                                style="padding: 18px 24px; border: none; background: none; cursor: pointer; font-weight: 600; font-size: 14px; border-bottom: 3px solid transparent; white-space: nowrap; transition: all 0.3s;">
                            üìã Solicitudes
                        </button>
                        <button onclick="switchVacationTab('auto-schedule')" id="tab-auto-schedule"
                                class="vacation-tab"
                                style="padding: 18px 24px; border: none; background: none; cursor: pointer; font-weight: 600; font-size: 14px; border-bottom: 3px solid transparent; white-space: nowrap; transition: all 0.3s;">
                            ü§ñ Programaci√≥n Autom√°tica
                        </button>
                        <button onclick="switchVacationTab('compatibility')" id="tab-compatibility"
                                class="vacation-tab"
                                style="padding: 18px 24px; border: none; background: none; cursor: pointer; font-weight: 600; font-size: 14px; border-bottom: 3px solid transparent; white-space: nowrap; transition: all 0.3s;">
                            üîó Matriz de Compatibilidad
                        </button>
                        <button onclick="switchVacationTab('config')" id="tab-config"
                                class="vacation-tab"
                                style="padding: 18px 24px; border: none; background: none; cursor: pointer; font-weight: 600; font-size: 14px; border-bottom: 3px solid transparent; white-space: nowrap; transition: all 0.3s;">
                            ‚öôÔ∏è Configuraci√≥n
                        </button>
                        <button onclick="switchVacationTab('balance')" id="tab-balance"
                                class="vacation-tab"
                                style="padding: 18px 24px; border: none; background: none; cursor: pointer; font-weight: 600; font-size: 14px; border-bottom: 3px solid transparent; white-space: nowrap; transition: all 0.3s;">
                                üí∞ Balance
                        </button>
                        <button onclick="switchVacationTab('analytics')" id="tab-analytics"
                                class="vacation-tab"
                                style="padding: 18px 24px; border: none; background: none; cursor: pointer; font-weight: 600; font-size: 14px; border-bottom: 3px solid transparent; white-space: nowrap; transition: all 0.3s;">
                            üìà An√°lisis
                        </button>
                    </div>
                </div>

                <!-- Contenido de las pesta√±as -->
                <div style="padding: 40px;" id="vacationTabContent">
                    ${getDashboardContent()}
                </div>
            </div>
        </div>

        <!-- Modales -->
        ${getModalsHTML()}
    `;

    console.log('‚úÖ [VACATION-PRO] Contenido renderizado exitosamente');

    // Inicializar m√≥dulo
    initVacationModule();

    // Force hide modals
    setTimeout(() => {
        const modals = document.querySelectorAll('.vacation-modal');
        modals.forEach(modal => {
            if (modal) {
                modal.style.setProperty('display', 'none', 'important');
            }
        });
    }, 100);
}

// ======== QUICK STATS HTML ========
function getQuickStatsHTML() {
    return `
        <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 15px 20px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3);">
            <div style="font-size: 28px; font-weight: 700;">...</div>
            <div style="font-size: 13px; opacity: 0.9;">Total Solicitudes</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 15px 20px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3);">
            <div style="font-size: 28px; font-weight: 700;">...</div>
            <div style="font-size: 13px; opacity: 0.9;">Pendientes</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 15px 20px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3);">
            <div style="font-size: 28px; font-weight: 700;">...</div>
            <div style="font-size: 13px; opacity: 0.9;">Aprobadas</div>
        </div>
        <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 15px 20px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.3);">
            <div style="font-size: 28px; font-weight: 700;">...</div>
            <div style="font-size: 13px; opacity: 0.9;">Desde APK</div>
        </div>
    `;
}

// ======== MODALES HTML ========
function getModalsHTML() {
    return `
        <!-- Modal Nueva Solicitud -->
        <div id="newVacationModal" class="vacation-modal modal" style="display: none !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999;">
            <div class="modal-content" style="position: relative; margin: 2% auto; width: 90%; max-width: 900px; background: white; border-radius: 15px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 25px 35px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 24px;">üèñÔ∏è Nueva Solicitud de Vacaciones/Permiso</h3>
                    <button onclick="closeNewVacationModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">&times;</button>
                </div>
                <div class="modal-body" style="padding: 35px;" id="newVacationFormContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Modal Programaci√≥n Autom√°tica -->
        <div id="autoScheduleModal" class="vacation-modal modal" style="display: none !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999;">
            <div class="modal-content" style="position: relative; margin: 1% auto; width: 95%; max-width: 1400px; background: white; border-radius: 15px; max-height: 95vh; overflow-y: auto;">
                <div class="modal-header" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); color: white; padding: 25px 35px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 24px;">ü§ñ Cronograma Autom√°tico Generado</h3>
                    <button onclick="closeAutoScheduleModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%;">&times;</button>
                </div>
                <div class="modal-body" style="padding: 35px;" id="autoScheduleContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Modal Matriz de Compatibilidad -->
        <div id="compatibilityMatrixModal" class="vacation-modal modal" style="display: none !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999;">
            <div class="modal-content" style="position: relative; margin: 1% auto; width: 95%; max-width: 1200px; background: white; border-radius: 15px; max-height: 95vh; overflow-y: auto;">
                <div class="modal-header" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 25px 35px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 24px;">üîó Detalles de Compatibilidad</h3>
                    <button onclick="closeCompatibilityMatrixModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%;">&times;</button>
                </div>
                <div class="modal-body" style="padding: 35px;" id="compatibilityMatrixContent">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
        </div>
    `;
}

// ======== SWITCH TABS ========
function switchVacationTab(tabName) {
    // Update tab styles
    document.querySelectorAll('.vacation-tab').forEach(tab => {
        tab.style.borderBottom = '3px solid transparent';
        tab.style.color = '#666';
        tab.classList.remove('active-vacation-tab');
    });

    const activeTab = document.getElementById(`tab-${tabName}`);
    if (activeTab) {
        activeTab.style.borderBottom = '3px solid #27ae60';
        activeTab.style.color = '#27ae60';
        activeTab.classList.add('active-vacation-tab');
    }

    // Update content
    const contentDiv = document.getElementById('vacationTabContent');
    if (!contentDiv) return;

    switch(tabName) {
        case 'dashboard':
            contentDiv.innerHTML = getDashboardContent();
            loadDashboardData();
            break;
        case 'requests':
            contentDiv.innerHTML = getRequestsContent();
            loadVacationRequests();
            break;
        case 'auto-schedule':
            contentDiv.innerHTML = getAutoScheduleContent();
            loadAutoScheduleTab();
            break;
        case 'compatibility':
            contentDiv.innerHTML = getCompatibilityContent();
            loadCompatibilityMatrix();
            break;
        case 'config':
            contentDiv.innerHTML = getConfigContent();
            loadConfigurationTab();
            break;
        case 'balance':
            contentDiv.innerHTML = getBalanceContent();
            loadBalanceTab();
            break;
        case 'analytics':
            contentDiv.innerHTML = getAnalyticsContent();
            loadAnalyticsTab();
            break;
    }
}

// ======== TAB CONTENTS ========

// DASHBOARD
function getDashboardContent() {
    return `
        <div class="vacation-dashboard">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px;">
                <!-- KPIs Principales -->
                <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(39,174,96,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Solicitudes Aprobadas</div>
                            <div id="stats-approved" style="font-size: 36px; font-weight: 700;">...</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px;">‚úÖ</div>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(243,156,18,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Pendientes de Aprobaci√≥n</div>
                            <div id="stats-pending" style="font-size: 36px; font-weight: 700;">...</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px;">‚è≥</div>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(52,152,219,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Desde APK M√≥vil</div>
                            <div id="stats-mobile" style="font-size: 36px; font-weight: 700;">...</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px;">üì±</div>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(142,68,173,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Dotaci√≥n Promedio</div>
                            <div id="stats-staffing" style="font-size: 36px; font-weight: 700;">...</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px;">üë•</div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n del Sistema -->
            <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 30px;">
                <h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 20px;">üìã Configuraci√≥n Actual del Sistema</h3>
                <div id="systemConfigSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #27ae60;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;">D√≠as M√≠nimos Continuos</div>
                        <div id="config-min-days" style="font-size: 20px; font-weight: 600; color: #2c3e50;">...</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #f39c12;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;">M√°x. Simult√°neos (%)</div>
                        <div id="config-max-simultaneous" style="font-size: 20px; font-weight: 600; color: #2c3e50;">...</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;">Fraccionamientos M√°x.</div>
                        <div id="config-max-fractions" style="font-size: 20px; font-weight: 600; color: #2c3e50;">...</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #8e44ad;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 5px;">Aviso Previo (d√≠as)</div>
                        <div id="config-advance-notice" style="font-size: 20px; font-weight: 600; color: #2c3e50;">...</div>
                    </div>
                </div>
            </div>

            <!-- Acciones R√°pidas -->
            <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                <h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 20px;">‚ö° Acciones R√°pidas</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <button onclick="switchVacationTab('auto-schedule')" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%); color: white; border: none; padding: 15px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 8px rgba(142,68,173,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(142,68,173,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(142,68,173,0.3)'">
                        ü§ñ Generar Cronograma Autom√°tico
                    </button>
                    <button onclick="switchVacationTab('compatibility')" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border: none; padding: 15px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 8px rgba(52,152,219,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(52,152,219,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(52,152,219,0.3)'">
                        üîó Ver Matriz de Compatibilidad
                    </button>
                    <button onclick="switchVacationTab('config')" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; padding: 15px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 8px rgba(231,76,60,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(231,76,60,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(231,76,60,0.3)'">
                        ‚öôÔ∏è Configuraci√≥n Avanzada
                    </button>
                    <button onclick="switchVacationTab('analytics')" style="background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%); color: white; border: none; padding: 15px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 8px rgba(22,160,133,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(22,160,133,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(22,160,133,0.3)'">
                        üìà Ver An√°lisis Detallado
                    </button>
                </div>
            </div>
        </div>
    `;
}

// REQUESTS (solicitudes existentes simplificadas)
function getRequestsContent() {
    return `
        <div class="vacation-requests-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 15px; flex-wrap: wrap;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <select id="requestTypeFilter" onchange="filterVacationRequests()" style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="all">Todos los tipos</option>
                        <option value="vacation">Vacaciones</option>
                        <option value="extraordinary">Licencia Extraordinaria</option>
                    </select>

                    <select id="requestStatusFilter" onchange="filterVacationRequests()" style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="all">Todos los estados</option>
                        <option value="pending">Pendiente</option>
                        <option value="approved">Aprobada</option>
                        <option value="rejected">Rechazada</option>
                    </select>

                    <select id="requestSourceFilter" onchange="filterVacationRequests()" style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="all">Todas las fuentes</option>
                        <option value="web">Web</option>
                        <option value="mobile">APK M√≥vil</option>
                    </select>
                </div>

                <input type="text" id="vacationSearch" placeholder="Buscar empleado..." onkeyup="searchVacationRequests()"
                       style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; min-width: 250px; font-size: 14px;">
            </div>

            <div id="vacation-requests-list">
                <div style="text-align: center; padding: 60px 20px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üîÑ</div>
                    <div style="font-size: 16px;">Cargando solicitudes de vacaciones...</div>
                </div>
            </div>
        </div>
    `;
}

// Contin√∫a en siguiente parte...

// ======== LOAD FUNCTIONS ========

// Load Dashboard Data
async function loadDashboardData() {
    try {
        const [requestsRes, configRes] = await Promise.all([
            fetch(`/api/v1/vacation/requests?company_id=${companyId}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            }),
            loadVacationConfig()
        ]);

        if (requestsRes.ok) {
            const requestsData = await requestsRes.json();
            const requests = requestsData.data || [];

            // Update stats
            document.getElementById('stats-approved').textContent = requests.filter(r => r.status === 'approved').length;
            document.getElementById('stats-pending').textContent = requests.filter(r => r.status === 'pending').length;
            document.getElementById('stats-mobile').textContent = requests.filter(r => r.source === 'mobile').length;

            // Calculate staffing
            const totalEmployees = 100; // TODO: Get real count
            const onVacation = requests.filter(r => r.status === 'active' || r.status === 'approved').length;
            const staffingPercent = Math.round((totalEmployees - onVacation) / totalEmployees * 100);
            document.getElementById('stats-staffing').textContent = `${staffingPercent}%`;
        }

        // Update config summary
        if (vacationConfig) {
            document.getElementById('config-min-days').textContent = `${vacationConfig.minContinuousDays} d√≠as`;
            document.getElementById('config-max-simultaneous').textContent = `${vacationConfig.maxSimultaneousPercentage}%`;
            document.getElementById('config-max-fractions').textContent = vacationConfig.maxFractions;
            document.getElementById('config-advance-notice').textContent = `${vacationConfig.minAdvanceNoticeDays} d√≠as`;
        }
    } catch (error) {
        console.error('‚ùå Error loading dashboard:', error);
    }
}

// Load Vacation Config
async function loadVacationConfig() {
    try {
        const response = await fetch(`/api/v1/vacation/config?company_id=${companyId}`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
            const result = await response.json();
            vacationConfig = result.data.configuration || {
                minContinuousDays: 7,
                maxFractions: 3,
                minAdvanceNoticeDays: 15,
                maxSimultaneousPercentage: 30,
                vacationInterruptible: true
            };
            vacationScales = result.data.vacationScales || [];
        }
    } catch (error) {
        console.error('‚ùå Error loading config:', error);
    }
}

// Load Vacation Requests
async function loadVacationRequests() {
    try {
        const response = await fetch(`/api/v1/vacation/requests?company_id=${companyId}`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
            const result = await response.json();
            displayVacationRequests(result.data || []);
        } else {
            throw new Error('Error loading requests');
        }
    } catch (error) {
        console.error('‚ùå Error:', error);
        document.getElementById('vacation-requests-list').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #e74c3c;">
                <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                <div>Error cargando solicitudes. Verifica tu conexi√≥n.</div>
            </div>
        `;
    }
}

function displayVacationRequests(requests) {
    const container = document.getElementById('vacation-requests-list');

    if (!requests || requests.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #999;">
                <div style="font-size: 64px; margin-bottom: 15px;">üìã</div>
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No hay solicitudes</div>
                <div style="font-size: 14px;">Crea una nueva solicitud para comenzar</div>
            </div>
        `;
        return;
    }

    container.innerHTML = requests.map(req => `
        <div style="background: white; border: 1px solid #e9ecef; border-left: 4px solid ${getStatusColor(req.status)}; padding: 20px; margin-bottom: 15px; border-radius: 10px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05);" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div>
                    <h4 style="margin: 0 0 8px 0; color: #2c3e50; font-size: 16px;">${req.employee?.name || 'N/A'}</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <span style="background: ${getTypeColor(req.requestType)}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                            ${req.requestType === 'vacation' ? 'üèñÔ∏è Vacaciones' : 'üìÑ Licencia'}
                        </span>
                        <span style="background: ${getStatusColor(req.status)}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                            ${getStatusText(req.status)}
                        </span>
                        ${req.source ? `<span style="background: ${getSourceColor(req.source)}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">${getSourceText(req.source)}</span>` : ''}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 24px; font-weight: 700; color: #27ae60;">${req.totalDays}</div>
                    <div style="font-size: 11px; color: #999;">d√≠as</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                <div>
                    <div style="font-size: 11px; color: #999; margin-bottom: 3px;">Inicio</div>
                    <div style="font-weight: 600; font-size: 13px;">${new Date(req.startDate).toLocaleDateString('es-AR')}</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: #999; margin-bottom: 3px;">Fin</div>
                    <div style="font-weight: 600; font-size: 13px;">${new Date(req.endDate).toLocaleDateString('es-AR')}</div>
                </div>
            </div>
            ${req.reason ? `<div style="font-size: 13px; color: #666; margin-bottom: 15px;"><strong>Motivo:</strong> ${req.reason}</div>` : ''}
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                ${req.status === 'pending' ? `
                    <button onclick="approveRequest(${req.id})" style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">‚úÖ Aprobar</button>
                    <button onclick="rejectRequest(${req.id})" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">‚ùå Rechazar</button>
                ` : ''}
                <button onclick="viewRequestDetails(${req.id})" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">üëÅÔ∏è Detalles</button>
            </div>
        </div>
    `).join('');
}

// Utility Functions
function getStatusColor(status) {
    const colors = {
        pending: '#f39c12',
        approved: '#27ae60',
        rejected: '#e74c3c',
        cancelled: '#95a5a6',
        active: '#3498db',
        completed: '#16a085'
    };
    return colors[status] || '#95a5a6';
}

function getStatusText(status) {
    const texts = {
        pending: 'Pendiente',
        approved: 'Aprobada',
        rejected: 'Rechazada',
        cancelled: 'Cancelada',
        active: 'Activa',
        completed: 'Completada'
    };
    return texts[status] || status;
}

function getTypeColor(type) {
    return type === 'vacation' ? '#27ae60' : '#3498db';
}

function getSourceColor(source) {
    const colors = {
        web: '#3498db',
        mobile: '#27ae60',
        system: '#8e44ad'
    };
    return colors[source] || '#95a5a6';
}

function getSourceText(source) {
    const texts = {
        web: 'üåê Web',
        mobile: 'üì± APK',
        system: '‚öôÔ∏è Sistema'
    };
    return texts[source] || source;
}

// Generate Auto Schedule
async function generateAutoSchedule() {
    const year = document.getElementById('scheduleYear').value;
    const resultsDiv = document.getElementById('autoScheduleResults');

    resultsDiv.innerHTML = `
        <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 64px; margin-bottom: 20px;">ü§ñ</div>
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px; color: #8e44ad;">Generando cronograma autom√°tico...</div>
            <div style="font-size: 14px; color: #999;">Esto puede tardar unos segundos</div>
        </div>
    `;

    try {
        const response = await fetch('/api/v1/vacation/generate-schedule', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ year, company_id: companyId })
        });

        if (response.ok) {
            const result = await response.json();
            currentSchedule = result.data.schedule || [];
            displayAutoSchedule(result.data);
        } else {
            throw new Error('Error generating schedule');
        }
    } catch (error) {
        console.error('‚ùå Error:', error);
        resultsDiv.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #e74c3c;">
                <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                <div>Error generando cronograma. Intenta nuevamente.</div>
            </div>
        `;
    }
}

function displayAutoSchedule(data) {
    const resultsDiv = document.getElementById('autoScheduleResults');

    resultsDiv.innerHTML = `
        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h4 style="margin: 0; color: #2c3e50;">üìã Cronograma Generado para ${data.year}</h4>
                <div style="display: flex; gap: 10px;">
                    <button onclick="exportScheduleToPDF()" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">üìÑ Exportar PDF</button>
                    <button onclick="applySchedule()" style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">‚úÖ Aplicar Cronograma</button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: #27ae60;">${data.totalEmployees}</div>
                    <div style="font-size: 13px; color: #155724;">Empleados Totales</div>
                </div>
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: #f39c12;">${data.schedule.filter(s => s.compatibilityScore >= 80).length}</div>
                    <div style="font-size: 13px; color: #8d6e08;">Alta Compatibilidad</div>
                </div>
            </div>
        </div>

        ${data.schedule.map(emp => `
            <div style="background: white; padding: 20px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid ${emp.compatibilityScore >= 80 ? '#27ae60' : emp.compatibilityScore >= 60 ? '#f39c12' : '#e74c3c'};">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                    <div>
                        <h5 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 16px;">${emp.userName}</h5>
                        <div style="font-size: 12px; color: #999;">Antig√ºedad: ${emp.yearsOfService} a√±os | ${emp.vacationDays} d√≠as de vacaciones</div>
                    </div>
                    <div style="background: ${emp.compatibilityScore >= 80 ? '#27ae60' : emp.compatibilityScore >= 60 ? '#f39c12' : '#e74c3c'}; color: white; padding: 8px 15px; border-radius: 20px; font-weight: 600; font-size: 14px;">
                        ${Math.round(emp.compatibilityScore)}% Compatible
                    </div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    ${emp.suggestedPeriods.map(period => `
                        <div style="background: #f8f9fa; padding: 10px 15px; border-radius: 8px; border: 1px solid #e9ecef;">
                            <div style="font-size: 11px; color: #999; margin-bottom: 3px;">Per√≠odo Sugerido</div>
                            <div style="font-weight: 600; font-size: 13px;">${new Date(period.startDate).toLocaleDateString('es-AR')} - ${new Date(period.endDate).toLocaleDateString('es-AR')}</div>
                            <div style="font-size: 11px; color: #27ae60; margin-top: 3px;">${period.days} d√≠as</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('')}
    `;
}

// Load Compatibility Matrix
async function loadCompatibilityMatrix() {
    try {
        const response = await fetch(`/api/v1/vacation/compatibility-matrix?company_id=${companyId}`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });

        if (response.ok) {
            const result = await response.json();
            compatibilityMatrix = result.data || [];
            displayCompatibilityMatrix();
        }
    } catch (error) {
        console.error('‚ùå Error:', error);
    }
}

function displayCompatibilityMatrix() {
    const container = document.getElementById('compatibilityMatrixList');

    if (compatibilityMatrix.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #999;">
                <div style="font-size: 48px; margin-bottom: 15px;">üîó</div>
                <div>No hay datos de compatibilidad a√∫n</div>
            </div>
        `;
        return;
    }

    const highCompatibility = compatibilityMatrix.filter(m => m.compatibilityScore >= 70);

    container.innerHTML = highCompatibility.map(item => `
        <div style="background: white; padding: 20px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid ${item.compatibilityScore >= 90 ? '#27ae60' : item.compatibilityScore >= 80 ? '#3498db' : '#f39c12'};">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                    <div style="font-size: 14px; font-weight: 700; color: #2c3e50; margin-bottom: 8px;">
                        ${item.primaryUser?.name || 'N/A'} ‚Üí ${item.coverUser?.name || 'N/A'}
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        ${item.coverUser?.name} puede cubrir a ${item.primaryUser?.name}
                    </div>
                    ${item.coverableTasks && item.coverableTasks.length > 0 ? `
                        <div style="margin-top: 10px; font-size: 11px; color: #999;">
                            <strong>Tareas:</strong> ${item.coverableTasks.slice(0, 3).join(', ')}${item.coverableTasks.length > 3 ? '...' : ''}
                        </div>
                    ` : ''}
                </div>
                <div style="text-align: center; margin-left: 20px;">
                    <div style="font-size: 32px; font-weight: 700; color: ${item.compatibilityScore >= 90 ? '#27ae60' : item.compatibilityScore >= 80 ? '#3498db' : '#f39c12'};">
                        ${Math.round(item.compatibilityScore)}
                    </div>
                    <div style="font-size: 11px; color: #999;">SCORE</div>
                </div>
            </div>
        </div>
    `).join('');
}

// Load Configuration Tab
function loadConfigurationTab() {
    if (vacationConfig) {
        document.getElementById('minContinuousDays').value = vacationConfig.minContinuousDays || 7;
        document.getElementById('maxFractions').value = vacationConfig.maxFractions || 3;
        document.getElementById('minAdvanceNoticeDays').value = vacationConfig.minAdvanceNoticeDays || 15;
        document.getElementById('maxSimultaneousPercentage').value = vacationConfig.maxSimultaneousPercentage || 30;
        document.getElementById('vacationInterruptible').checked = vacationConfig.vacationInterruptible !== false;
    }

    loadVacationScalesList();
}

function loadVacationScalesList() {
    const container = document.getElementById('vacationScalesList');

    if (vacationScales.length === 0) {
        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #999;">No hay escalas configuradas</div>`;
        return;
    }

    container.innerHTML = vacationScales.map(scale => `
        <div style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid #27ae60;">
            <div style="font-weight: 600; margin-bottom: 5px;">${scale.rangeDescription}</div>
            <div style="font-size: 13px; color: #666;">
                Antig√ºedad: ${scale.yearsFrom} - ${scale.yearsTo || '‚àû'} a√±os ‚Üí ${scale.vacationDays} d√≠as
            </div>
        </div>
    `).join('');
}

// Load other tabs (simplified)
function loadAutoScheduleTab() {}
function loadBalanceTab() {}
function loadAnalyticsTab() {}

// Save Configuration
async function saveVacationConfig() {
    const configData = {
        vacationInterruptible: document.getElementById('vacationInterruptible').checked,
        minContinuousDays: parseInt(document.getElementById('minContinuousDays').value),
        maxFractions: parseInt(document.getElementById('maxFractions').value),
        minAdvanceNoticeDays: parseInt(document.getElementById('minAdvanceNoticeDays').value),
        maxSimultaneousPercentage: parseInt(document.getElementById('maxSimultaneousPercentage').value),
        company_id: companyId
    };

    try {
        const response = await fetch('/api/v1/vacation/config', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(configData)
        });

        if (response.ok) {
            alert('‚úÖ Configuraci√≥n guardada exitosamente');
            await loadVacationConfig();
        }
    } catch (error) {
        alert('‚ùå Error guardando configuraci√≥n');
    }
}

// Request Actions
async function approveRequest(requestId) {
    if (!confirm('¬øAprobar esta solicitud?')) return;

    try {
        const response = await fetch(`/api/v1/vacation/requests/${requestId}/approval`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: 'approved', approvedBy: currentUser?.id })
        });

        if (response.ok) {
            alert('‚úÖ Solicitud aprobada');
            loadVacationRequests();
        }
    } catch (error) {
        alert('‚ùå Error aprobando solicitud');
    }
}

async function rejectRequest(requestId) {
    const reason = prompt('Motivo del rechazo:');
    if (!reason) return;

    try {
        const response = await fetch(`/api/v1/vacation/requests/${requestId}/approval`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: 'rejected', approvalComments: reason, approvedBy: currentUser?.id })
        });

        if (response.ok) {
            alert('‚ùå Solicitud rechazada');
            loadVacationRequests();
        }
    } catch (error) {
        alert('‚ùå Error rechazando solicitud');
    }
}

function viewRequestDetails(requestId) {
    alert(`Ver detalles de solicitud ${requestId} (pr√≥ximamente)`);
}

// Filter/Search Functions
function filterVacationRequests() {
    loadVacationRequests();
}

function searchVacationRequests() {
    loadVacationRequests();
}

function searchEmployeeBalance() {
    // TODO: Implement
}

// Modal Functions
function showNewVacationModal() {
    const modal = document.getElementById('newVacationModal');
    modal.style.setProperty('display', 'block', 'important');
}

function closeNewVacationModal() {
    const modal = document.getElementById('newVacationModal');
    modal.style.setProperty('display', 'none', 'important');
}

function closeAutoScheduleModal() {
    const modal = document.getElementById('autoScheduleModal');
    modal.style.setProperty('display', 'none', 'important');
}

function closeCompatibilityMatrixModal() {
    const modal = document.getElementById('compatibilityMatrixModal');
    modal.style.setProperty('display', 'none', 'important');
}

function showNewScaleModal() {
    alert('Crear nueva escala (pr√≥ximamente)');
}

function exportScheduleToPDF() {
    alert('Exportar a PDF (pr√≥ximamente)');
}

function applySchedule() {
    if (confirm('¬øAplicar este cronograma autom√°tico? Se crear√°n las solicitudes pendientes.')) {
        alert('Cronograma aplicado (pr√≥ximamente)');
    }
}

// Export Global Functions
window.showVacationManagementContent = showVacationManagementContent;
window.switchVacationTab = switchVacationTab;
window.loadVacationRequests = loadVacationRequests;
window.generateAutoSchedule = generateAutoSchedule;
window.loadCompatibilityMatrix = loadCompatibilityMatrix;
window.saveVacationConfig = saveVacationConfig;
window.approveRequest = approveRequest;
window.rejectRequest = rejectRequest;
window.viewRequestDetails = viewRequestDetails;
window.filterVacationRequests = filterVacationRequests;
window.searchVacationRequests = searchVacationRequests;
window.searchEmployeeBalance = searchEmployeeBalance;
window.showNewVacationModal = showNewVacationModal;
window.closeNewVacationModal = closeNewVacationModal;
window.closeAutoScheduleModal = closeAutoScheduleModal;
window.closeCompatibilityMatrixModal = closeCompatibilityMatrixModal;
window.showNewScaleModal = showNewScaleModal;
window.exportScheduleToPDF = exportScheduleToPDF;
window.applySchedule = applySchedule;

console.log('‚úÖ [VACATION-PRO] M√≥dulo profesional completo cargado y funcional');
