<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - Sistema Completo de Gesti√≥n y Facturaci√≥n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Leaflet CSS y JS para mapas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Configuraci√≥n din√°mica de puertos - DEBE CARGAR PRIMERO -->
    <script src="js/port-config.js"></script>

    <!-- üîå SOCKET.IO - WebSocket Communication -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- üîê APONNT LOGIN - Sistema de Autenticaci√≥n Staff + Partners -->
    <script src="js/modules/aponnt-login.js"></script>

    <!-- üì± RESPONSIVE MODALS - Sistema Global -->
    <link rel="stylesheet" href="css/responsive-modals.css">

    <!-- üèÜ TECH STACK BADGES - Marketing Subliminal Profesional -->
    <link rel="stylesheet" href="css/admin-modern.css">

    <!-- üèóÔ∏è ENGINEERING DASHBOARD - Visualizaci√≥n 3D del Sistema -->
    <link rel="stylesheet" href="css/engineering-dashboard.css">

    <!-- üè¢ MODAL ENTERPRISE STYLES - Professional Edit Modal -->
    <link rel="stylesheet" href="css/modal-enterprise-styles.css">

    <!-- üìë MODAL COMPANY EDIT TABS - Tab-Based Enterprise Redesign -->
    <link rel="stylesheet" href="css/modal-company-edit-tabs.css">

    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --light-bg: #f8f9fa;
            --white: #ffffff;
            --dark-text: #2c3e50;
            --border-color: #e9ecef;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #1e293b;
            padding: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-bottom: 3px solid #60a5fa;
        }

        .dashboard-title {
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .dashboard-subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard-container {
            max-width: 1457px;
            margin: 0 auto;
            margin-top: -1cm;
            padding: 0.5rem 2rem 2rem 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 0.5rem;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 0.5rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        /* Wrapper para tabs con navegaci√≥n */
        .tabs-navigation-wrapper {
            position: relative;
            background: white;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-tabs {
            display: flex;
            background: white;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: #007bff #f8f9fa;
            margin-bottom: 0;
        }

        .nav-tabs::-webkit-scrollbar {
            height: 6px;
        }

        .nav-tabs::-webkit-scrollbar-track {
            background: #f8f9fa;
        }

        .nav-tabs::-webkit-scrollbar-thumb {
            background: #007bff;
            border-radius: 3px;
        }

        .tabs-nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 35px;
            height: 35px;
            background: rgba(0, 123, 255, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .tabs-nav-button:hover {
            background: rgba(0, 123, 255, 1);
            transform: translateY(-50%) scale(1.1);
        }

        .tabs-nav-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .tabs-nav-button.left {
            left: 10px;
        }

        .tabs-nav-button.right {
            right: 10px;
        }

        .nav-tab {
            flex: 0 0 auto;
            min-width: 140px;
            padding: 1rem 1.5rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 400;
            transition: all 0.3s ease;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .nav-tab span {
            font-size: 1.2em;
        }

        .nav-tab:last-child {
            border-right: none;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        .billing-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .billing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f8f9fa;
        }

        .invoice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .invoice-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 1rem;
            border-left: 4px solid var(--primary-color);
        }

        .invoice-card.overdue {
            border-left-color: var(--danger-color);
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
        }

        .invoice-card.paid {
            border-left-color: var(--success-color);
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        }

        .qr-payment {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 15px;
            margin: 1rem 0;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 1rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #666;
        }

        .pricing-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .module-pricing {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tier-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tier-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .tier-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .price-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .notification {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notification.success { background: #d4edda; color: #155724; }
        .notification.warning { background: #fff3cd; color: #856404; }
        .notification.error { background: #f8d7da; color: #721c24; }
        .notification.info { background: #d1ecf1; color: #0c5460; }

        .section-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 0.55rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 600;
        }

        .section-content {
            padding: 2rem;
            margin-top: calc(-1cm + 5mm);
        }

        /* ==================== ESTILOS M√ìDULO DE FACTURACI√ìN ==================== */
        
        .billing-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .billing-table th {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .billing-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
            vertical-align: middle;
        }
        
        .billing-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .billing-table tr.unpaid {
            background-color: #fff5f5;
        }
        
        .billing-table tr.unpaid:hover {
            background-color: #ffebee;
        }
        
        .billing-table .amount {
            text-align: right;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
        
        .billing-table .commission {
            color: #ff9800;
        }
        
        .billing-table .aponnt {
            color: #2196f3;
        }
        
        .status {
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status.paid {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status.unpaid {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .btn-action {
            background: none;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            margin: 0 0.25rem;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .btn-action:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .total-item {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
        }
        
        .total-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .total-value.paid {
            color: var(--success-color);
        }
        
        .total-value.unpaid {
            color: var(--danger-color);
        }
        
        .total-label {
            font-size: 0.85rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .billing-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #666;
        }
        
        .filter-input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .btn-filter {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .btn-filter.primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-filter.primary:hover {
            background: var(--secondary-color);
        }
        
        .btn-filter.secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-filter.secondary:hover {
            background: #545b62;
        }
        
        .billing-generation {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .generation-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .generation-description {
            color: #666;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        /* ==================== ESTILOS M√ìDULO DE VENDEDORES ==================== */
        
        .vendor-controls {
            margin-bottom: 2rem;
        }
        
        .vendor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            border-left: 4px solid var(--primary-color);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .preliquidation-generator {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .preliquidation-generator h3 {
            margin: 0 0 1rem 0;
            color: #b8860b;
        }
        
        .preliq-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .preliq-results {
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .vendors-grid {
            display: block;
            width: 100%;
        }
        
        .vendor-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .vendor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .vendor-card.inactive {
            opacity: 0.6;
            border-left-color: #dc3545;
        }
        
        .vendor-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .vendor-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .vendor-email {
            color: #666;
            font-size: 0.9rem;
        }
        
        .vendor-status {
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .vendor-status.active {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .vendor-status.inactive {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .vendor-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }
        
        .vendor-detail {
            display: flex;
            flex-direction: column;
        }
        
        .vendor-detail-label {
            color: #666;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .vendor-detail-value {
            color: #333;
        }
        
        .vendor-commission {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .commission-percentage {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .commission-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .vendor-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-vendor {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 80px;
        }
        
        .btn-vendor.primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-vendor.secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-vendor.success {
            background: #28a745;
            color: white;
        }
        
        .btn-vendor.warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-vendor:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        .preliq-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--success-color);
        }
        
        .preliq-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .preliq-vendor {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .preliq-amount {
            font-weight: bold;
            color: var(--success-color);
        }
        
        .preliq-details {
            font-size: 0.85rem;
            color: #666;
        }
        
        .vendor-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .vendor-modal.show {
            display: flex;
        }
        
        .vendor-modal-content {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            max-width: 800px;
            width: 98%;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
        }
        
        .vendor-form {
            display: grid;
            gap: 1rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .form-input {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }

        .form-help {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
            line-height: 1.3;
        }

        .vendor-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            margin: 0 0 1.2rem 0;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .vendor-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .vendor-section .form-group {
            margin-bottom: 0;
        }

        .vendor-section .form-label {
            font-weight: 500;
            color: #343a40;
            margin-bottom: 0.5rem;
        }

        .vendor-section .form-help {
            color: #6c757d;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* Estilos para tabla de vendedores */
        .vendors-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 1rem 0;
            width: 100%;
        }

        .vendors-table-container .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vendors-table-container .table-header h3 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .vendors-table-container .table-actions {
            display: flex;
            gap: 0.5rem;
        }

        .vendors-table {
            display: grid;
            grid-template-columns: 2fr 2fr 1.5fr 1fr 1fr 1fr 1fr 1.5fr;
            width: 100%;
        }

        .vendors-table .table-header-row {
            display: contents;
        }

        .vendors-table .table-cell.header {
            background: #f8f9fa;
            padding: 1rem;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            font-size: 0.9rem;
        }

        .vendors-table .table-row {
            display: contents;
        }

        .vendors-table .table-row:hover .table-cell:not(.header) {
            background-color: #f8f9fa;
        }

        .vendors-table .table-row.inactive-row .table-cell:not(.header) {
            opacity: 0.6;
            background-color: #f8f8f8;
        }

        .vendors-table .table-cell {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .vendor-name-cell {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .vendor-notes {
            color: #6c757d;
            font-size: 0.75rem;
            font-style: italic;
        }

        .commission-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
            text-align: center;
        }

        .commission-badge.sales {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .commission-badge.support {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .auction-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.8rem;
            text-align: center;
        }

        .auction-badge.accepts {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .auction-badge.rejects {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .status-badge.activo {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactivo {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            margin: 1rem 0;
            color: #495057;
        }

        .empty-state p {
            margin-bottom: 2rem;
        }
        
        .form-select {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            background: white;
        }
        
        .form-textarea {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #f0f0f0;
        }
        
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }
        
        .close-modal:hover {
            color: #333;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        }

        .companies-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .companies-table th,
        .companies-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .companies-table th {
            background: var(--light-bg);
            font-weight: 600;
            color: var(--dark-text);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-active { background: #d4edda; color: #155724; }
        .status-trial { background: #fff3cd; color: #856404; }
        .status-suspended { background: #f8d7da; color: #721c24; }

        /* Filtros de b√∫squeda */
        .filters-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: calc(20px - 1cm);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .filters-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .filters-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filters-toggle {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .filters-toggle:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }

        .filters-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--dark-text);
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .filter-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            grid-column: 1 / -1;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .btn-filter {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-filter.primary {
            background: #007bff;
            color: white;
        }

        .btn-filter.primary:hover {
            background: #0056b3;
        }

        .btn-filter.secondary {
            background: #6c757d;
            color: white;
        }

        .btn-filter.secondary:hover {
            background: #545b62;
        }

        .results-info {
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #1565c0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            width: 98%;
            max-width: 1457px;
            height: 98vh;
            max-height: 98vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.55rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            opacity: 0.8;
        }

        .close-btn:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 2rem;
            flex: 1;
            overflow: auto;
        }

        .modal-footer {
            flex-shrink: 0;
            margin-top: auto;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            align-items: start;
            height: 100%;
            overflow: visible;
        }

        .company-form {
            max-height: 100%;
            overflow-y: auto;
            padding-right: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark-text);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modules-section h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--dark-text);
        }

        .employee-counter {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .employee-counter input {
            width: 120px;
            padding: 8px 12px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .module-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .module-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .module-card.selected {
            border-color: var(--success-color);
            background: rgba(39, 174, 96, 0.05);
        }
        
        /* Estados de m√≥dulos */
        .module-card.contracted {
            border-color: #2196f3;
            background: rgba(33, 150, 243, 0.05);
        }
        
        .module-card.contracted.selected {
            border-color: #2196f3;
            background: rgba(33, 150, 243, 0.1);
        }
        
        .module-card.removing {
            border-color: #ff9800;
            background: rgba(255, 152, 0, 0.05);
            opacity: 0.7;
        }
        
        .module-card.new {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.05);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        .module-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .module-card.disabled:hover {
            transform: none;
            border-color: var(--border-color);
        }
        
        /* Filtros de m√≥dulos */
        .module-filters {
            display: flex;
            gap: 8px;
        }
        
        .filter-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .filter-btn:hover {
            background: #e0e0e0;
        }
        
        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* Estados de m√≥dulos */
        .module-status {
            margin-top: 8px;
            display: flex;
            justify-content: flex-end;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-badge.contracted {
            background: rgba(33, 150, 243, 0.15);
            color: #1565c0;
        }
        
        .status-badge.new {
            background: rgba(76, 175, 80, 0.15);
            color: #2e7d32;
        }
        
        .status-badge.removing {
            background: rgba(255, 152, 0, 0.15);
            color: #e65100;
        }
        
        .status-badge.available {
            background: rgba(158, 158, 158, 0.15);
            color: #424242;
        }
        
        .no-modules {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-style: italic;
        }

        .module-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .module-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .module-icon {
            font-size: 1.4rem;
        }

        .module-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .module-price {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
            min-width: 70px;
            text-align: center;
        }

        .module-description {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
        }

        .module-details {
            font-size: 0.75rem;
            color: #999;
        }

        .pricing-sidebar {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            position: sticky;
            top: 1rem;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            max-height: calc(98vh - 8rem);
            overflow-y: auto;
        }

        .pricing-sidebar h3 {
            font-size: 1.3rem;

        /* Tabla simple de vendedores - Expandida y optimizada */
        .vendors-simple-table {
            width: 100%;
            max-width: none;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            font-size: 0.45rem; /* Reducido a la mitad */
            margin-right: 0;
        }

        .vendors-simple-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 6px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.2rem !important; /* M√°s peque√±o con !important */
            border: none;
            white-space: nowrap;
        }

        .vendors-simple-table td {
            padding: 5px 6px; /* Reducido a la mitad */
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            font-size: 0.44rem; /* Reducido a la mitad */
        }

        .vendors-simple-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .vendors-simple-table tr.inactive-row {
            opacity: 0.7;
            background: rgba(255, 0, 0, 0.02);
        }

        .badge {
            padding: 2px 5px; /* Reducido a la mitad */
            border-radius: 6px;
            font-size: 0.39rem; /* Reducido a la mitad */
            font-weight: 600;
            text-align: center;
            display: inline-block;
            min-width: 22px; /* Reducido a la mitad */
        }

        /* Estilos espec√≠ficos para celdas compactas */
        .vendors-simple-table .compact-cell {
            padding: 4px 3px; /* Reducido a la mitad */
            text-align: center;
        }

        .vendors-simple-table .number-cell {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 500;
            min-width: 40px; /* Reducido a la mitad */
        }

        .vendors-simple-table .vendor-info {
            line-height: 1.1;
            max-width: 100px; /* Reducido a la mitad */
        }

        .vendors-simple-table .vendor-info strong {
            font-size: 0.45rem; /* Reducido a la mitad */
            display: block;
            margin-bottom: 1px;
        }

        .vendors-simple-table .vendor-info small {
            color: #666;
            font-size: 0.39rem; /* Reducido a la mitad */
        }

        /* Estilos para botones compactos */
        .btn-simple {
            border: none;
            background: transparent;
            cursor: pointer;
            margin: 0 1px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .btn-simple:hover {
            background: rgba(0,0,0,0.1);
            transform: scale(1.1);
        }

        /* Mejoras adicionales para la tabla expandida */
        .vendors-simple-table thead th small {
            font-size: 0.6rem;
            opacity: 0.8;
            font-weight: 400;
        }

        /* Responsive para pantallas m√°s peque√±as */
        @media (max-width: 1600px) {
            .vendors-simple-table {
                font-size: 0.425rem;
            }

            .vendors-simple-table th {
                font-size: 0.25rem;
                padding: 5px 4px;
            }

            .vendors-simple-table td {
                padding: 4px 3px;
                font-size: 0.41rem;
            }

            /* Ajustar anchos de columnas en pantallas medianas */
            .vendors-simple-table th:first-child,
            .vendors-simple-table td:first-child {
                width: 100px;
            }
        }

        @media (max-width: 1200px) {
            .vendors-simple-table {
                font-size: 0.4rem;
            }

            .vendors-simple-table th {
                font-size: 0.2rem;
                padding: 4px 3px;
            }

            .vendors-simple-table td {
                padding: 3px 2px;
                font-size: 0.39rem;
            }
        }

        /* Clases de utilidad adicionales */
        .text-center {
            text-align: center;
        }

        .badge-sales {
            background: #10b981;
            color: white;
        }

        .badge-support {
            background: #3b82f6;
            color: white;
        }

        .badge-referral {
            background: #8b5cf6;
            color: white;
        }

        .badge-active {
            background: #10b981;
            color: white;
        }

        .badge-inactive {
            background: #ef4444;
            color: white;
        }

        .simple-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .btn-simple {
            padding: 5px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .btn-edit {
            background: var(--primary-color);
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-simple:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
            margin-bottom: 1rem;
            color: var(--dark-text);
            text-align: center;
        }

        .tier-info {
            background: rgba(39, 174, 96, 0.1);
            border-left: 4px solid var(--success-color);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .pricing-summary {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .summary-total {
            border-top: 2px solid var(--border-color);
            padding-top: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .selected-modules {
            max-height: 200px;
            margin-top: 1cm;
            overflow-y: auto;
            font-size: 0.75rem;
        }

        .selected-modules h4 {
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .pricing-breakdown {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pricing-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .pricing-item:last-child {
            border-bottom: none;
        }

        .pricing-item.total {
            border-top: 2px solid var(--primary-color);
            margin-top: 0.5rem;
            padding-top: 0.8rem;
            font-size: 1rem;
            color: var(--primary-color);
        }

        .pricing-sidebar h4 {
            background: var(--primary-color);
            color: white;
            padding: 0.8rem;
            margin: -1.5rem -1.5rem 1rem -1.5rem;
            border-radius: 15px 15px 0 0;
            font-size: 1rem;
            text-align: center;
        }

        .pricing-sidebar h5 {
            font-size: 0.9rem;
            color: var(--dark-text);
            margin-bottom: 0.8rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.4rem;
        }

        .contracted-module {
            border: 2px solid #4CAF50 !important;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05)) !important;
        }

        .contracted-module:hover {
            border-color: #45a049 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .selected-module {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.75rem;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .modules-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-title {
                font-size: 1.8rem;
            }
        }

        /* Estilos para exportaci√≥n a Excel */
        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .export-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        /* ========================================= */
        /* ESTILOS ESPEC√çFICOS PARA SIAC CONFIG    */
        /* ========================================= */

        .siac-company-selector {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .siac-status-bar {
            margin-top: 1rem;
            padding: 0.8rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .siac-status-bar.active {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .siac-status-bar.inactive {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: currentColor;
        }

        .siac-config-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .siac-section {
            margin-bottom: 3rem;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }

        .siac-section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.55rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .siac-section-header h3 {
            margin: 0;
            font-size: 1.3em;
            font-weight: 600;
        }

        .siac-section-desc {
            font-size: 0.9em;
            opacity: 0.9;
            flex-basis: 100%;
            margin-top: 0.5rem;
        }

        .siac-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            padding: 2rem;
            background: #f8f9fa;
        }

        .siac-config-group {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .siac-config-group h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .terminals-container, .sessions-container {
            padding: 2rem;
            background: #f8f9fa;
        }

        .terminal-card, .session-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
        }

        .terminal-header, .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .terminal-title, .session-title {
            font-weight: 600;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .terminal-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .session-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .session-stat {
            text-align: center;
            padding: 0.8rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .session-stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .session-stat-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 0.2rem;
        }

        .siac-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            padding: 2rem;
            border-top: 1px solid #e9ecef;
            margin-top: 2rem;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85em;
        }

        .status-active {
            color: var(--success-color);
            font-weight: 600;
        }

        .status-inactive {
            color: var(--danger-color);
            font-weight: 600;
        }

        .terminal-status {
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .terminal-status.active {
            background: #d4edda;
            color: #155724;
        }

        .terminal-status.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .siac-config-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1rem;
            }

            .terminal-config-grid {
                grid-template-columns: 1fr;
            }

            .siac-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .siac-section-header {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
            }
        }
        /* ==============================
           TAX TEMPLATES STYLES
           ============================== */

        .tax-templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .tax-template-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .tax-template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: #007bff;
        }

        .tax-template-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .tax-template-title {
            flex-grow: 1;
        }

        .tax-template-title h3 {
            margin: 0;
            color: #333;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .country-code {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .tax-template-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tax-template-body {
            margin-bottom: 1rem;
        }

        .tax-template-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-label {
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
        }

        .info-value {
            font-weight: 600;
            color: #333;
        }

        .tax-template-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tax-template-footer {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            border-top: 1px solid #eee;
            padding-top: 1rem;
        }

        /* Detail Modal Styles */
        .tax-template-detail {
            max-width: 100%;
        }

        .detail-section {
            margin-bottom: 2rem;
        }

        .detail-section h4 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 8px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
            display: block;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-weight: 600;
            color: #333;
        }

        .conditions-list, .concepts-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .condition-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .condition-code {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .condition-name {
            flex-grow: 1;
            font-weight: 500;
        }

        .concept-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid #ffc107;
        }

        .concept-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .concept-name {
            font-weight: 600;
            color: #333;
        }

        .concept-order {
            background: #ffc107;
            color: #333;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .concept-details {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            color: #666;
        }

        .rates-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .rate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .rate-percentage {
            background: #17a2b8;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .no-data, .no-rates {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 1rem;
        }

        @media (max-width: 768px) {
            .tax-templates-grid {
                grid-template-columns: 1fr;
            }

            .tax-template-info {
                grid-template-columns: 1fr;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .concept-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

        /* ===============================
           NUEVOS ESTILOS PARA SISTEMA DE VENDEDORES Y ASOCIADOS
           =============================== */

        /* Secondary Tabs (Tabs internos de Vendedores y Partners) */
        .nav-tabs-secondary {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-tab-secondary {
            flex: 1;
            min-width: 120px;
            padding: 0.75rem 1rem;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            color: #495057;
        }

        .nav-tab-secondary:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .nav-tab-secondary.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        /* Subtab Content */
        .vendor-subtab-content,
        .partner-subtab-content {
            display: none;
        }

        .vendor-subtab-content.active,
        .partner-subtab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .data-table thead {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .data-table thead th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .data-table tbody tr {
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .data-table tbody tr:last-child {
            border-bottom: none;
        }

        .data-table tbody td {
            padding: 1rem;
            font-size: 0.9rem;
            color: #495057;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.paid {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.overdue {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.cancelled {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-badge.active {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.draft {
            background: #e7e7e7;
            color: #6c757d;
        }

        .status-badge.sent {
            background: #cce5ff;
            color: #004085;
        }

        .status-badge.accepted {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.expired {
            background: #f8d7da;
            color: #721c24;
        }

        /* Star Rating */
        .star-rating {
            color: #ffc107;
            font-size: 1.2rem;
        }

        .score-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .score-badge.excellent {
            background: #d4edda;
            color: #155724;
        }

        .score-badge.good {
            background: #cce5ff;
            color: #004085;
        }

        .score-badge.medium {
            background: #fff3cd;
            color: #856404;
        }

        .score-badge.low {
            background: #f8d7da;
            color: #721c24;
        }

        .score-badge.critical {
            background: #721c24;
            color: white;
        }

        /* Action Buttons */
        .btn-action {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            margin: 0 0.2rem;
        }

        .btn-action.btn-view {
            background: var(--info-color);
            color: white;
        }

        .btn-action.btn-edit {
            background: var(--warning-color);
            color: white;
        }

        .btn-action.btn-delete {
            background: var(--danger-color);
            color: white;
        }

        .btn-action.btn-download {
            background: var(--success-color);
            color: white;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Partner Stats Dashboard */
        .partner-stats-dashboard {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* Vendor Stats */
        .vendor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* Commission Type Badges */
        .commission-type {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .commission-type.sale {
            background: #d4edda;
            color: #155724;
        }

        .commission-type.support {
            background: #cce5ff;
            color: #004085;
        }

        .commission-type.leader {
            background: #fff3cd;
            color: #856404;
        }

        /* Auction Timer */
        .auction-timer {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 0.4rem 0.8rem;
            background: #fff3cd;
            color: #856404;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .auction-timer.ending-soon {
            background: #f8d7da;
            color: #721c24;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Modal styles for new modals */
        .modal-lg {
            max-width: 900px;
        }

        .modal-xl {
            max-width: 1200px;
        }

        /* Bot√≥n Logout Header */
        .btn-logout-header {
            transition: all 0.3s ease;
        }

        .btn-logout-header:hover {
            background: rgba(255, 59, 48, 0.8) !important;
            border-color: rgba(255, 59, 48, 0.9) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
        }

        .btn-logout-header:active {
            transform: translateY(0);
        }

        /* üèóÔ∏è ENGINEERING DASHBOARD STYLES */
        .cube-layer {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s ease;
        }

        .cube-layer:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .layer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .layer-header h3 {
            margin: 0;
            color: #495057;
            font-size: 1.2rem;
        }

        .btn-drill-down {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-drill-down:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .layer-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .preview-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .preview-card h4 {
            margin: 0 0 8px 0;
            color: #343a40;
            font-size: 1rem;
        }

        .preview-card p {
            margin: 5px 0;
            font-size: 0.85rem;
            color: #6c757d;
        }

        .dependency-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .dependency-section h3 {
            margin: 0 0 20px 0;
            color: #495057;
        }

    </style>

    <!-- Google Maps API (para m√≥dulo de Departamentos) -->
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"
            onload="console.log('‚úÖ Google Maps cargado correctamente')"
            onerror="console.error('‚ùå Error cargando Google Maps')">
    </script>
    <script>
        // Callback dummy para Google Maps
        function initMap() {
            console.log('üó∫Ô∏è Google Maps API inicializada');
        }
    </script>
</head>
<body>
    <div class="dashboard-header" style="transform: scale(0.5); transform-origin: top left; width: 200%; margin-bottom: -50px;">
        <!-- Barra superior con informaci√≥n principal -->
        <div style="padding: 0.1rem 1rem; display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 0.3rem; align-items: center; grid-auto-rows: min-content;">

            <!-- Izquierda: Logo y Sistema -->
            <div class="brand-section" style="display: flex; align-items: center; gap: 20px; height: fit-content;">
                <div class="logo-container" style="display: flex; flex-direction: column; text-align: center;">
                    <div style="font-size: 4.4rem; letter-spacing: -2px; line-height: 1;">
                        <span style="color: #3b82f6; font-weight: 800; font-size: 5.6rem; transform: skewX(-12deg); display: inline-block;">A</span><span style="color: #1e293b; font-weight: 300;">ponnt</span>
                    </div>
                    <div style="font-size: 1.5rem; color: #64748b; font-weight: 400; letter-spacing: 0.2px; line-height: 1.5; margin-top: 22px;">Sistema Integral de Planificaci√≥n y<br>Administraci√≥n de los Recursos Empresariales</div>
                </div>
            </div>

            <!-- Centro: Dashboard Administrativo -->
            <div class="admin-info-center" style="display: flex; justify-content: center; height: fit-content;">
                <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); padding: 1rem 3rem; border-radius: 16px; border: 2px solid #e2e8f0; display: flex; align-items: center; gap: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <span style="font-size: 3.2rem;">üè¢</span>
                    <div style="text-align: left;">
                        <div style="font-weight: 700; color: #1e40af; font-size: 2.6rem; line-height: 1.1; white-space: nowrap;">Dashboard Comercial, Administrativo y Ejecutivo</div>
                        <div id="dashboardSubtitle" style="font-size: 1.6rem; color: #64748b; line-height: 1;">Sistema Completo de Gesti√≥n y Facturaci√≥n</div>
                    </div>
                </div>
            </div>

            <!-- Derecha: Info del usuario logueado -->
            <div class="system-info" id="userInfoHeader" style="display: flex; align-items: center; justify-content: flex-end; gap: 1.6rem; height: fit-content;">
                <div style="text-align: right;">
                    <div id="userFullName" style="font-size: 1.5rem; font-weight: 600; color: #1e293b; line-height: 1.1;">Cargando...</div>
                    <div id="userRoleAndId" style="font-size: 1.1rem; color: #64748b; text-transform: uppercase; line-height: 1;">...</div>
                </div>
                <div style="width: 76px; height: 76px; border-radius: 50%; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); border: 4px solid #e2e8f0; display: flex; align-items: center; justify-content: center; font-size: 2.4rem; color: white;" id="userAvatarIcon">
                    <span>üë§</span>
                </div>
                <div style="display: flex; flex-direction: row; gap: 0.8rem; align-items: center;">
                    <!-- Language Selector -->
                    <div id="languageSelectorContainer" style="transform: scale(2); transform-origin: center;"></div>
                    <button onclick="handleLogout()" class="btn-logout-header" style="padding: 0.8rem 1.8rem; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1.9rem; font-weight: 500; box-shadow: 0 2px 8px rgba(239,68,68,0.3);">
                        üö™ Salir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Estad√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üè¢</div>
                <div class="stat-number" id="totalCompanies">0</div>
                <div class="stat-label">Total Empresas</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-number" id="activeCompanies">0</div>
                <div class="stat-label">Empresas Activas</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üîÑ</div>
                <div class="stat-number" id="trialCompanies">0</div>
                <div class="stat-label">En Prueba</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-number" id="suspendedCompanies">0</div>
                <div class="stat-label">Suspendidas</div>
            </div>
        </div>

        <!-- Sistema de Pesta√±as -->
        <div class="main-content">
            <div class="section-card">
                <div class="tabs-navigation-wrapper">
                    <button class="tabs-nav-button left" id="tabScrollLeft" onclick="scrollTabs('left')">
                        ‚óÄ
                    </button>
                    <button class="tabs-nav-button right" id="tabScrollRight" onclick="scrollTabs('right')">
                        ‚ñ∂
                    </button>
                    <div class="nav-tabs" id="mainNavTabs">
                        <button class="nav-tab active" onclick="switchTab('companies')"><span>üè¢</span><br>Empresas</button>
                        <button class="nav-tab" onclick="switchTab('partners')"><span>ü§ù</span><br>Asociados</button>
                        <button class="nav-tab" onclick="switchTab('taxTemplates')"><span>üèõÔ∏è</span><br>Plantillas Fiscales</button>
                        <button class="nav-tab" onclick="switchTab('vendors')"><span>üë•</span><br>Vendedores</button>
                        <button class="nav-tab" onclick="switchTab('staff')"><span>üëî</span><br>Staff Aponnt</button>
                        <button class="nav-tab" onclick="switchTab('staffRoles')"><span>üé≠</span><br>Roles de Staff</button>
                        <button class="nav-tab" onclick="switchTab('pricing')"><span>üí∞</span><br>Precios</button>
                        <button class="nav-tab" onclick="switchTab('billing')"><span>üßæ</span><br>Facturaci√≥n</button>
                        <button class="nav-tab" onclick="switchTab('payments')"><span>üí≥</span><br>Pagos</button>
                        <button class="nav-tab" onclick="switchTab('notifications')"><span>üîî</span><br>Notificaciones</button>
                        <button class="nav-tab" onclick="switchTab('supportTools')"><span>üîß</span><br>Herramientas</button>
                        <button class="nav-tab" onclick="switchTab('consents')"><span>üìú</span><br>Consentimientos</button>
                        <button class="nav-tab" onclick="switchTab('supportTickets')">
                            <span>üé´</span><br>Tickets Soporte
                            <span id="tickets-badge" class="badge badge-danger" style="display:none; margin-left: 5px;">0</span>
                        </button>
                        <button class="nav-tab" onclick="switchTab('engineering')"><span>üèóÔ∏è</span><br>Ingenier√≠a</button>
                    </div>
                </div>

                <!-- Pesta√±a Empresas -->
                <div id="companies" class="tab-content active">
                    <div class="section-header" style="padding: 0.4rem 2rem !important;">
                        <h2 class="section-title">üìä Empresas Registradas</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="export-btn" onclick="exportCompaniesToExcel()">
                                üìä Exportar Excel
                            </button>
                            <button class="btn btn-success" onclick="openNewCompanyModal()">
                                ‚ûï Nueva Empresa
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <!-- Panel de Filtros -->
                        <div class="filters-panel">
                            <div class="filters-header">
                                <div class="filters-title">
                                    üîç Filtros de B√∫squeda
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <button class="btn-filter secondary" onclick="clearFilters()">Limpiar Filtros</button>
                                    <button class="btn-filter primary" onclick="applyFilters()">üîç Buscar</button>
                                    <button class="filters-toggle" onclick="toggleFilters()" id="filtersToggle">
                                        Ocultar Filtros
                                    </button>
                                </div>
                            </div>
                            <div class="filters-content" id="filtersContent">
                                <div class="filter-group">
                                    <label class="filter-label">Raz√≥n Social</label>
                                    <input type="text" class="filter-input" id="filterName" placeholder="Buscar por nombre..." onkeyup="applyFiltersDebounced()">
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">CUIT</label>
                                    <input type="text" class="filter-input" id="filterCuit" placeholder="Buscar por CUIT..." onkeyup="applyFiltersDebounced()">
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Pa√≠s</label>
                                    <select class="filter-input" id="filterCountry" onchange="loadFilterProvinces(); applyFilters();">
                                        <option value="">Todos los pa√≠ses</option>
                                        <option value="Argentina">Argentina</option>
                                        <option value="Bolivia">Bolivia</option>
                                        <option value="Brasil">Brasil</option>
                                        <option value="Chile">Chile</option>
                                        <option value="Colombia">Colombia</option>
                                        <option value="Costa Rica">Costa Rica</option>
                                        <option value="Ecuador">Ecuador</option>
                                        <option value="El Salvador">El Salvador</option>
                                        <option value="Espa√±a">Espa√±a</option>
                                        <option value="Guatemala">Guatemala</option>
                                        <option value="Honduras">Honduras</option>
                                        <option value="M√©xico">M√©xico</option>
                                        <option value="Nicaragua">Nicaragua</option>
                                        <option value="Panam√°">Panam√°</option>
                                        <option value="Paraguay">Paraguay</option>
                                        <option value="Per√∫">Per√∫</option>
                                        <option value="Uruguay">Uruguay</option>
                                        <option value="Venezuela">Venezuela</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Provincia/Estado</label>
                                    <select class="filter-input" id="filterProvince" onchange="loadFilterCities(); applyFilters();">
                                        <option value="">Todas las provincias</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Ciudad</label>
                                    <select class="filter-input" id="filterCity" onchange="applyFilters();">
                                        <option value="">Todas las ciudades</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Vendedor</label>
                                    <input type="text" class="filter-input" id="filterVendor" placeholder="Buscar por vendedor..." onkeyup="applyFiltersDebounced()">
                                </div>
                            </div>
                        </div>

                        <!-- Informaci√≥n de resultados -->
                        <div id="resultsInfo" class="results-info" style="display: none;"></div>

<!-- Toggle View Button -->                        <div style="margin-bottom: 16px; display: flex; justify-content: flex-end;">                            <button id="viewToggleBtn" onclick="toggleCompanyView()"                                     style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); transition: all 0.3s ease;">                                üé® Vista Grid                            </button>                        </div>
                        <div id="companiesContainer">
                            <!-- Tabla de empresas se carga aqu√≠ -->
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a Vendedores -->
                <div id="vendors" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">üë• Gesti√≥n de Vendedores & Facturaci√≥n</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="openPaymentRegisterModal()">
                                üí≥ Registrar Pago
                            </button>
                            <button class="btn btn-primary" onclick="generateMonthlyInvoices()">
                                üìÑ Generar Facturas Mensuales
                            </button>
                            <button class="export-btn" onclick="exportVendorsToExcel()">
                                üìä Exportar Excel
                            </button>
                            <button class="btn btn-info" onclick="openNewVendorModal()">
                                ‚ûï Nuevo Vendedor
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <!-- Panel de Control de Vendedores -->
                        <div class="vendor-controls">
                            <div class="vendor-stats" id="vendorStats">
                                <div class="stat-card">
                                    <div class="stat-value">-</div>
                                    <div class="stat-label">Total Vendedores</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">-</div>
                                    <div class="stat-label">Vendedores Activos</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">$-</div>
                                    <div class="stat-label">Comisiones del Mes</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">-</div>
                                    <div class="stat-label">Facturas Pendientes</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">$-</div>
                                    <div class="stat-label">Pagos del Mes</div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabs Internos de Vendedores -->
                        <div class="vendor-tabs-container" style="margin-top: 20px;">
                            <div class="nav-tabs-secondary">
                                <button class="nav-tab-secondary active" onclick="switchVendorSubTab('vendors-list')">
                                    üë• Vendedores
                                </button>
                                <button class="nav-tab-secondary" onclick="switchVendorSubTab('quotes-list')">
                                    üìã Presupuestos
                                </button>
                                <button class="nav-tab-secondary" onclick="switchVendorSubTab('contracts-list')">
                                    üìú Contratos
                                </button>
                                <button class="nav-tab-secondary" onclick="switchVendorSubTab('invoices-list')">
                                    üìÑ Facturas
                                </button>
                                <button class="nav-tab-secondary" onclick="switchVendorSubTab('payments-list')">
                                    üí≥ Pagos
                                </button>
                                <button class="nav-tab-secondary" onclick="switchVendorSubTab('commissions-list')">
                                    üí∞ Comisiones
                                </button>
                            </div>

                            <!-- Sub-Tab: Lista de Vendedores -->
                            <div id="vendors-list" class="vendor-subtab-content active">
                                <div style="margin: 20px 0;">
                                    <h3 style="margin-bottom: 15px; font-size: 1rem;">üìã Lista de Vendedores</h3>
                                    <div id="vendorsContainer" class="vendors-grid">
                                        <!-- Los vendedores se cargar√°n aqu√≠ din√°micamente -->
                                    </div>
                                </div>
                            </div>

                            <!-- Sub-Tab: Presupuestos/Cotizaciones -->
                            <div id="quotes-list" class="vendor-subtab-content">
                                <div style="margin: 20px 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3>üìã Presupuestos & Cotizaciones</h3>
                                        <div style="display: flex; gap: 10px;">
                                            <select id="quoteFilterStatus" class="filter-input" style="width: 150px;" onchange="loadQuotes()">
                                                <option value="">Todos los estados</option>
                                                <option value="draft">Borrador</option>
                                                <option value="sent">Enviado</option>
                                                <option value="accepted">Aceptado</option>
                                                <option value="rejected">Rechazado</option>
                                                <option value="expired">Vencido</option>
                                            </select>
                                            <input type="month" id="quoteFilterMonth" class="filter-input" style="width: 150px;" onchange="loadQuotes()">
                                            <button class="btn btn-success btn-sm" onclick="openQuoteGenerator()">
                                                ‚ûï Generar Presupuesto
                                            </button>
                                        </div>
                                    </div>
                                    <div id="quotesTableContainer">
                                        <table class="data-table" style="width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th>N¬∫</th>
                                                    <th>Empresa</th>
                                                    <th>Vendedor</th>
                                                    <th>Fecha Emisi√≥n</th>
                                                    <th>V√°lido Hasta</th>
                                                    <th>Total</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="quotesTableBody">
                                                <tr>
                                                    <td colspan="8" style="text-align: center; padding: 40px;">
                                                        Cargando presupuestos...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Sub-Tab: Contratos -->
                            <div id="contracts-list" class="vendor-subtab-content">
                                <div style="margin: 20px 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3>üìú Gesti√≥n de Contratos</h3>
                                        <div style="display: flex; gap: 10px;">
                                            <select id="contractFilterStatus" class="filter-input" style="width: 150px;" onchange="loadContracts()">
                                                <option value="">Todos los estados</option>
                                                <option value="pending_signature">Pendiente Firma</option>
                                                <option value="active">Activo</option>
                                                <option value="expired">Vencido</option>
                                                <option value="cancelled">Cancelado</option>
                                            </select>
                                            <select id="contractFilterCountry" class="filter-input" style="width: 150px;" onchange="loadContracts()">
                                                <option value="">Todos los pa√≠ses</option>
                                                <option value="Argentina">Argentina</option>
                                                <option value="Bolivia">Bolivia</option>
                                                <option value="Chile">Chile</option>
                                                <option value="Colombia">Colombia</option>
                                                <option value="M√©xico">M√©xico</option>
                                                <option value="Per√∫">Per√∫</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="contractsTableContainer">
                                        <table class="data-table" style="width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th>N¬∫ Contrato</th>
                                                    <th>Empresa</th>
                                                    <th>Pa√≠s</th>
                                                    <th>Fecha Inicio</th>
                                                    <th>Fecha Fin</th>
                                                    <th>Monto Mensual</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="contractsTableBody">
                                                <tr>
                                                    <td colspan="8" style="text-align: center; padding: 40px;">
                                                        Cargando contratos...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Sub-Tab: Facturas -->
                            <div id="invoices-list" class="vendor-subtab-content">
                                <div style="margin: 20px 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3>üìÑ Gesti√≥n de Facturas</h3>
                                        <div style="display: flex; gap: 10px;">
                                            <select id="invoiceFilterStatus" class="filter-input" style="width: 150px;" onchange="loadInvoices()">
                                                <option value="">Todos los estados</option>
                                                <option value="pending">Pendiente</option>
                                                <option value="paid">Pagada</option>
                                                <option value="overdue">Vencida</option>
                                                <option value="cancelled">Cancelada</option>
                                            </select>
                                            <input type="month" id="invoiceFilterMonth" class="filter-input" style="width: 150px;" onchange="loadInvoices()">
                                        </div>
                                    </div>
                                    <div id="invoicesTableContainer">
                                        <table class="data-table" style="width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th>N¬∫ Factura</th>
                                                    <th>Empresa</th>
                                                    <th>Fecha Emisi√≥n</th>
                                                    <th>Vencimiento</th>
                                                    <th>Total</th>
                                                    <th>Pagado</th>
                                                    <th>Saldo</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="invoicesTableBody">
                                                <tr>
                                                    <td colspan="9" style="text-align: center; padding: 40px;">
                                                        Cargando facturas...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Sub-Tab: Pagos -->
                            <div id="payments-list" class="vendor-subtab-content">
                                <div style="margin: 20px 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3>üí≥ Registro de Pagos</h3>
                                        <div style="display: flex; gap: 10px;">
                                            <select id="paymentFilterMethod" class="filter-input" style="width: 150px;" onchange="loadPayments()">
                                                <option value="">Todos los m√©todos</option>
                                                <option value="transferencia">Transferencia</option>
                                                <option value="efectivo">Efectivo</option>
                                                <option value="cheque">Cheque</option>
                                                <option value="tarjeta">Tarjeta</option>
                                            </select>
                                            <input type="month" id="paymentFilterMonth" class="filter-input" style="width: 150px;" onchange="loadPayments()">
                                        </div>
                                    </div>
                                    <div id="paymentsTableContainer">
                                        <table class="data-table" style="width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Fecha</th>
                                                    <th>Empresa</th>
                                                    <th>Factura</th>
                                                    <th>Monto</th>
                                                    <th>M√©todo</th>
                                                    <th>Referencia</th>
                                                    <th>Comprobante</th>
                                                    <th>Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="paymentsTableBody">
                                                <tr>
                                                    <td colspan="9" style="text-align: center; padding: 40px;">
                                                        Cargando pagos...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Sub-Tab: Comisiones -->
                            <div id="commissions-list" class="vendor-subtab-content">
                                <div style="margin: 20px 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3>üí∞ Gesti√≥n de Comisiones</h3>
                                        <div style="display: flex; gap: 10px;">
                                            <select id="commissionFilterType" class="filter-input" style="width: 150px;" onchange="loadCommissions()">
                                                <option value="">Todos los tipos</option>
                                                <option value="sale">Venta</option>
                                                <option value="support">Soporte</option>
                                                <option value="leader">L√≠der</option>
                                            </select>
                                            <select id="commissionFilterStatus" class="filter-input" style="width: 150px;" onchange="loadCommissions()">
                                                <option value="">Todos los estados</option>
                                                <option value="pending">Pendiente</option>
                                                <option value="approved">Aprobada</option>
                                                <option value="paid">Pagada</option>
                                            </select>
                                            <button class="btn btn-success btn-sm" onclick="markSelectedCommissionsAsPaid()">
                                                ‚úì Marcar como Pagadas
                                            </button>
                                        </div>
                                    </div>
                                    <div id="commissionsTableContainer">
                                        <table class="data-table" style="width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th><input type="checkbox" id="selectAllCommissions" onchange="toggleAllCommissions()"></th>
                                                    <th>ID</th>
                                                    <th>Fecha</th>
                                                    <th>Partner</th>
                                                    <th>Tipo</th>
                                                    <th>Empresa</th>
                                                    <th>Monto</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="commissionsTableBody">
                                                <tr>
                                                    <td colspan="9" style="text-align: center; padding: 40px;">
                                                        Cargando comisiones...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a Staff Aponnt -->
                <div id="staff" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">üëî Gesti√≥n de Staff Aponnt</h2>
                        <button class="btn btn-success" onclick="openNewStaffModal()">
                            ‚ûï Agregar Staff
                        </button>
                    </div>

                    <!-- Filtros -->
                    <div class="filters-container" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                            <div>
                                <label style="display: block; font-size: 0.85rem; margin-bottom: 5px; color: #666;">√Årea:</label>
                                <select id="staffFilterArea" class="filter-input" onchange="loadStaff()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="">Todas las √°reas</option>
                                    <option value="ventas">Ventas</option>
                                    <option value="admin">Administraci√≥n</option>
                                    <option value="desarrollo">Desarrollo</option>
                                    <option value="externo">Externo</option>
                                    <option value="direccion">Direcci√≥n</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; margin-bottom: 5px; color: #666;">Pa√≠s:</label>
                                <select id="staffFilterCountry" class="filter-input" onchange="loadStaff()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="">Todos los pa√≠ses</option>
                                    <option value="AR">Argentina</option>
                                    <option value="BR">Brasil</option>
                                    <option value="CL">Chile</option>
                                    <option value="MX">M√©xico</option>
                                    <option value="US">Estados Unidos</option>
                                    <option value="ES">Espa√±a</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; margin-bottom: 5px; color: #666;">Estado:</label>
                                <select id="staffFilterStatus" class="filter-input" onchange="loadStaff()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="">Todos</option>
                                    <option value="true">Activos</option>
                                    <option value="false">Inactivos</option>
                                </select>
                            </div>
                            <div style="margin-left: auto;">
                                <label style="display: block; font-size: 0.85rem; margin-bottom: 5px; color: transparent;">Acciones</label>
                                <button class="btn btn-info" onclick="exportStaffToExcel()" style="padding: 8px 15px;">
                                    üìä Exportar Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs Secundarios -->
                    <div class="vendor-tabs-container" style="margin-top: 20px;">
                        <div class="nav-tabs-secondary">
                            <button class="nav-tab-secondary active" onclick="switchStaffSubTab('staff-list')">
                                üìã Lista de Staff
                            </button>
                            <button class="nav-tab-secondary" onclick="switchStaffSubTab('staff-orgchart')">
                                üå≥ Organigrama
                            </button>
                        </div>

                        <!-- Sub-Tab: Lista de Staff -->
                        <div id="staff-list" class="vendor-subtab-content active">
                            <div id="staffTableContainer">
                                <div style="text-align: center; padding: 40px; color: #999;">
                                    <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                                    <p>Cargando staff...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Sub-Tab: Organigrama -->
                        <div id="staff-orgchart" class="vendor-subtab-content" style="display: none;">
                            <div style="margin: 20px 0;">
                                <!-- Filtro de pa√≠s para organigrama -->
                                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <label style="font-weight: bold; margin-right: 10px;">Filtrar por pa√≠s:</label>
                                    <select id="orgchartCountryFilter" onchange="renderOrgChart()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                        <option value="">üåé Todos los pa√≠ses</option>
                                        <option value="AR">üá¶üá∑ Argentina</option>
                                        <option value="BR">üáßüá∑ Brasil</option>
                                        <option value="CL">üá®üá± Chile</option>
                                        <option value="MX">üá≤üáΩ M√©xico</option>
                                        <option value="US">üá∫üá∏ Estados Unidos</option>
                                        <option value="ES">üá™üá∏ Espa√±a</option>
                                    </select>
                                </div>

                                <!-- Contenedor del organigrama -->
                                <div id="orgchartContainer" style="padding: 20px; background: white; border-radius: 8px; overflow-x: auto;">
                                    <!-- Se renderizar√° aqu√≠ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a Roles de Staff -->
                <div id="staffRoles" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">üé≠ Gesti√≥n de Roles de Staff</h2>
                        <button class="btn btn-success" onclick="openNewStaffRoleModal()">
                            ‚ûï Agregar Rol
                        </button>
                    </div>

                    <!-- Filtros -->
                    <div class="filters-container" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                            <div>
                                <label style="display: block; font-size: 0.85rem; margin-bottom: 5px; color: #666;">√Årea:</label>
                                <select id="roleFilterArea" class="filter-input" onchange="loadStaffRoles()">
                                    <option value="">Todas las √°reas</option>
                                    <option value="ventas">Ventas</option>
                                    <option value="admin">Administraci√≥n</option>
                                    <option value="desarrollo">Desarrollo</option>
                                    <option value="externo">Externo</option>
                                    <option value="direccion">Direcci√≥n</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; margin-bottom: 5px; color: #666;">Nivel:</label>
                                <select id="roleFilterLevel" class="filter-input" onchange="loadStaffRoles()">
                                    <option value="">Todos los niveles</option>
                                    <option value="0">Nivel 0 - CEO</option>
                                    <option value="1">Nivel 1 - Gerentes</option>
                                    <option value="2">Nivel 2 - Jefes</option>
                                    <option value="3">Nivel 3 - Coordinadores</option>
                                    <option value="4">Nivel 4 - Operativos</option>
                                </select>
                            </div>
                            <div style="margin-left: auto;">
                                <button class="btn btn-info" onclick="exportStaffRolesToExcel()">
                                    üìä Exportar Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n sobre roles protegidos -->
                    <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                        <p style="margin: 0; color: #856404; font-size: 0.9rem;">
                            ‚ö†Ô∏è <strong>Roles base protegidos:</strong> Los 26 roles base del sistema no pueden ser eliminados, solo editados para traducciones i18n.
                        </p>
                    </div>

                    <!-- Contenedor de tabla de roles -->
                    <div id="staffRolesTableContainer">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                            <p>Cargando roles...</p>
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a Precios -->
                <div id="pricing" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">üí∞ Configuraci√≥n de Precios</h2>
                        <button class="btn btn-success" onclick="saveAllPricing()">
                            üíæ Guardar Cambios
                        </button>
                    </div>
                    <div class="section-content">
                        <div id="pricingContainer">
                            <!-- Controles de precios se cargan aqu√≠ -->
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a Facturaci√≥n -->
                <div id="billing" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">üßæ Sistema de Facturaci√≥n</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="export-btn" onclick="exportBillingToExcel()">
                                üìä Exportar Excel
                            </button>
                            <button class="btn btn-success" onclick="generateMonthlyInvoices()">
                                üìä Generar Facturas Mes
                            </button>
                            <button class="btn btn-primary" onclick="checkOverduePayments()">
                                ‚ö†Ô∏è Verificar Vencidos
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="billingContainer">
                            <!-- Filtros de facturaci√≥n -->
                            <div class="filters-section">
                                <div class="filters-header">
                                    <h3>üîç Filtros de Facturas</h3>
                                </div>
                                <div class="filters-content">
                                    <div class="filter-group">
                                        <label class="filter-label">Mes</label>
                                        <select class="filter-input" id="billingMonth">
                                            <option value="">Todos los meses</option>
                                            <option value="1">Enero</option>
                                            <option value="2">Febrero</option>
                                            <option value="3">Marzo</option>
                                            <option value="4">Abril</option>
                                            <option value="5">Mayo</option>
                                            <option value="6">Junio</option>
                                            <option value="7">Julio</option>
                                            <option value="8">Agosto</option>
                                            <option value="9">Septiembre</option>
                                            <option value="10">Octubre</option>
                                            <option value="11">Noviembre</option>
                                            <option value="12">Diciembre</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label class="filter-label">A√±o</label>
                                        <select class="filter-input" id="billingYear">
                                            <option value="">Todos los a√±os</option>
                                            <option value="2024">2024</option>
                                            <option value="2025">2025</option>
                                            <option value="2026">2026</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label class="filter-label">Vendedor</label>
                                        <input type="text" class="filter-input" id="billingVendor" placeholder="Filtrar por vendedor">
                                    </div>
                                    <div class="filter-group">
                                        <label class="filter-label">Estado de Pago</label>
                                        <select class="filter-input" id="billingPaymentStatus">
                                            <option value="">Todos</option>
                                            <option value="paid">Pagado</option>
                                            <option value="pending">Pendiente</option>
                                        </select>
                                    </div>
                                    <div class="filter-actions">
                                        <button class="btn-filter primary" onclick="loadBillingData()">üîç Buscar</button>
                                        <button class="btn-filter secondary" onclick="clearBillingFilters()">Limpiar</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Generaci√≥n de facturas -->
                            <div class="generate-invoices-section" style="margin-top: 2rem;">
                                <div class="filters-header">
                                    <h3>üìä Generar Canon Mensual</h3>
                                </div>
                                <div class="filters-content">
                                    <div class="filter-group">
                                        <label class="filter-label">Mes a generar</label>
                                        <select class="filter-input" id="generateMonth">
                                            <option value="">Seleccionar mes</option>
                                            <option value="1">Enero</option>
                                            <option value="2">Febrero</option>
                                            <option value="3">Marzo</option>
                                            <option value="4">Abril</option>
                                            <option value="5">Mayo</option>
                                            <option value="6">Junio</option>
                                            <option value="7">Julio</option>
                                            <option value="8">Agosto</option>
                                            <option value="9">Septiembre</option>
                                            <option value="10">Octubre</option>
                                            <option value="11">Noviembre</option>
                                            <option value="12">Diciembre</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label class="filter-label">A√±o a generar</label>
                                        <select class="filter-input" id="generateYear">
                                            <option value="2024">2024</option>
                                            <option value="2025" selected>2025</option>
                                            <option value="2026">2026</option>
                                        </select>
                                    </div>
                                    <div class="filter-actions">
                                        <button class="btn btn-success" onclick="generateMonthlyCanon()">üìä Generar Canon Mensual</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Resumen de totales -->
                            <div id="billingTotals" style="display: none; margin-top: 2rem;">
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-icon">üí∞</div>
                                        <div class="stat-number" id="totalFacturado">$0</div>
                                        <div class="stat-label">Total Facturado</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon">üí∏</div>
                                        <div class="stat-number" id="totalComisiones">$0</div>
                                        <div class="stat-label">Total Comisiones</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon">üè¢</div>
                                        <div class="stat-number" id="totalAponnt">$0</div>
                                        <div class="stat-label">Total Aponnt</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon">‚úÖ</div>
                                        <div class="stat-number" id="totalPagado">$0</div>
                                        <div class="stat-label">Total Pagado</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tabla de facturas -->
                            <div id="billingTableContainer" style="margin-top: 2rem;">
                                <!-- La tabla se carga din√°micamente aqu√≠ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a Pagos -->
                <div id="payments" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">üí≥ Sistema de Pagos</h2>
                        <button class="btn btn-success" onclick="processAutomaticPayments()">
                            üîÑ Procesar Pagos Autom√°ticos
                        </button>
                    </div>
                    <div class="section-content">
                        <div id="paymentsContainer">
                            <!-- Sistema de pagos se carga aqu√≠ -->
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a Notificaciones -->
                <div id="notifications" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">üîî Sistema de Notificaciones</h2>
                        <button class="btn btn-success" onclick="sendPaymentReminders()">
                            üìß Enviar Recordatorios
                        </button>
                    </div>
                    <div class="section-content">
                        <div id="notificationsContainer">
                            <!-- Sistema de notificaciones se carga aqu√≠ -->
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a Herramientas de Soporte -->
                <div id="supportTools" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">üîß Sistema de Auditor√≠a y Testing</h2>
                    </div>
                    <div class="section-content">
                        <!-- Sistema de Testing Phase 4 Integrated -->
                        <div id="phase4IntegratedContainer">
                            <div class="section-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white; margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 1.5rem;">üéØ ORQUESTADOR DE TESTING COMPLETO</h3>
                                <p style="margin: 10px 0 0 0; opacity: 0.9;">Playwright E2E + PostgreSQL Validation + Ollama AI Analysis + WebSocket Auto-Repair</p>
                            </div>

                            <!-- Health Indicators -->
                            <div class="row" style="margin-bottom: 20px;">
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body p-3">
                                            <h6>üß† Ollama AI</h6>
                                            <span id="phase4OllamaStatus" class="badge badge-secondary">Checking...</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body p-3">
                                            <h6>üîå WebSocket</h6>
                                            <span id="phase4WebSocketStatus" class="badge badge-success">Ready</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center">
                                        <div class="card-body p-3">
                                            <h6>üóÑÔ∏è PostgreSQL</h6>
                                            <span id="phase4PostgreSQLStatus" class="badge badge-success">Connected</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Cards de Estado -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                                <!-- Card LOCAL -->
                                <div class="card" style="border-left: 4px solid #667eea;">
                                    <div class="card-body">
                                        <h5 style="color: #667eea; margin-bottom: 15px;">üñ•Ô∏è LOCAL</h5>
                                        <div id="localTestStatus">
                                            <div class="badge badge-secondary">Esperando inicio</div>
                                        </div>
                                        <div class="progress" style="height: 6px; margin-top: 10px;">
                                            <div id="progressLocal" class="progress-bar bg-primary" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card STAGING -->
                                <div class="card" style="border-left: 4px solid #f5576c;">
                                    <div class="card-body">
                                        <h5 style="color: #f5576c; margin-bottom: 15px;">üß™ STAGING</h5>
                                        <div id="stagingTestStatus">
                                            <div class="badge badge-secondary">Pendiente</div>
                                        </div>
                                        <div class="progress" style="height: 6px; margin-top: 10px;">
                                            <div id="progressStaging" class="progress-bar bg-info" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card PRODUCTION -->
                                <div class="card" style="border-left: 4px solid #4facfe;">
                                    <div class="card-body">
                                        <h5 style="color: #4facfe; margin-bottom: 15px;">üöÄ PRODUCTION</h5>
                                        <div id="productionTestStatus">
                                            <div class="badge badge-secondary">Pendiente</div>
                                        </div>
                                        <div class="progress" style="height: 6px; margin-top: 10px;">
                                            <div id="progressProduction" class="progress-bar bg-success" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Panel de Control -->
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <strong>‚öôÔ∏è Panel de Control de Tests</strong>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-group">
                                                <label for="phase4TestCompany">üè¢ Empresa a Auditar</label>
                                                <select id="phase4TestCompany" class="form-control">
                                                    <option value="">Cargando empresas...</option>
                                                </select>
                                                <small class="form-text text-muted">Selecciona la empresa</small>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label for="phase4TestEnvironment">Entorno</label>
                                                <select id="phase4TestEnvironment" class="form-control">
                                                    <option value="local">LOCAL</option>
                                                    <option value="staging">STAGING</option>
                                                    <option value="production">PROD</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label for="phase4TestModule">M√≥dulo</label>
                                                <select id="phase4TestModule" class="form-control">
                                                    <option value="users">üë• Usuarios</option>
                                                    <option value="attendance">üìÖ Asistencia</option>
                                                    <option value="departments">üè¢ Deptos</option>
                                                    <option value="shifts">‚è∞ Turnos</option>
                                                    <option value="permissions">üîí Permisos</option>
                                                    <option value="vacations">üèñÔ∏è Vacaciones</option>
                                                    <option value="medical">üè• M√©dico</option>
                                                    <option value="organizational">üèóÔ∏è Organizacional (CRUD+SSOT)</option>
                                                    <option value="consent">üìã Consentimientos (SSOT)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label for="phase4TestCycles">Ciclos</label>
                                                <input type="number" id="phase4TestCycles" class="form-control" value="5" min="1" max="100">
                                                <small class="form-text text-muted">Min 50 deploy</small>
                                            </div>
                                        </div>
                                        <div class="col-md-1">
                                            <div class="form-group">
                                                <label for="phase4TestSlowMo">ms</label>
                                                <input type="number" id="phase4TestSlowMo" class="form-control" value="100" min="0" max="1000" step="50">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-group">
                                                <label>&nbsp;</label>
                                                <button id="btnStartPhase4Integrated" class="btn btn-success btn-block">
                                                    ‚ñ∂Ô∏è Iniciar Test
                                                </button>
                                                <button id="btnStopPhase4Integrated" class="btn btn-danger btn-block" style="display: none; margin-top: 5px;">
                                                    ‚èπÔ∏è Detener Test
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Indicador de Estado -->
                                    <div id="phase4RunningIndicator" style="display: none; margin-top: 15px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                            <div>
                                                <strong>Test en ejecuci√≥n...</strong>
                                                <div style="font-size: 0.9rem; color: #666;">El navegador debe estar visible. Si no lo ves, revisa los logs.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Consola de Logs en Tiempo Real -->
                            <div class="card" style="margin-top: 20px;">
                                <div class="card-header bg-dark text-white">
                                    <strong>üìù Logs en Tiempo Real</strong>
                                    <button id="btnClearPhase4Logs" class="btn btn-sm btn-outline-light float-right" style="margin-top: -5px;">
                                        üóëÔ∏è Limpiar
                                    </button>
                                </div>
                                <div class="card-body" style="padding: 0;">
                                    <div id="phase4LogsConsole" style="background: #1e1e1e; color: #d4d4d4; padding: 20px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem;">
                                        <div style="color: #4caf50;">[Sistema] Phase 4 Integrated Manager inicializado</div>
                                        <div style="color: #2196f3;">[Info] Esperando comandos...</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tests Activos -->
                            <div class="card" style="margin-top: 20px;">
                                <div class="card-header bg-info text-white">
                                    <strong>üîÑ Tests Activos</strong>
                                </div>
                                <div class="card-body" id="phase4ActiveTestsList">
                                    <div class="alert alert-info">No hay tests en ejecuci√≥n</div>
                                </div>
                            </div>

                            <!-- Resultados del √öltimo Test -->
                            <div id="lastTestResults" class="card" style="margin-top: 20px; display: none;">
                                <div class="card-header bg-success text-white">
                                    <strong>‚úÖ Resultados del √öltimo Test</strong>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="stat-card text-center">
                                                <h3 id="lastTestTotal" class="text-primary">0</h3>
                                                <p class="text-muted">Total Tests</p>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card text-center">
                                                <h3 id="lastTestPassed" class="text-success">0</h3>
                                                <p class="text-muted">Exitosos</p>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card text-center">
                                                <h3 id="lastTestFailed" class="text-danger">0</h3>
                                                <p class="text-muted">Fallidos</p>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-card text-center">
                                                <h3 id="lastTestSuccessRate" class="text-info">0%</h3>
                                                <p class="text-muted">Tasa de √âxito</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                                        <strong>üìä Detalles:</strong>
                                        <div id="lastTestDetails" style="margin-top: 10px; font-size: 0.9rem;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gu√≠a R√°pida -->
                            <div class="card border-info" style="margin-top: 20px;">
                                <div class="card-header bg-info text-white">
                                    <strong>‚ÑπÔ∏è Gu√≠a R√°pida</strong>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <h6>üñ•Ô∏è Testing LOCAL</h6>
                                            <ul class="small">
                                                <li>Servidor corriendo en 9998</li>
                                                <li>Navegador visible en tu PC</li>
                                                <li>Ideal para desarrollo</li>
                                                <li>5-10 ciclos para debugging</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <h6>üß™ Testing STAGING</h6>
                                            <ul class="small">
                                                <li>Render Preview Environment</li>
                                                <li>50 ciclos obligatorios</li>
                                                <li>Antes de deploy a PROD</li>
                                                <li>Validaci√≥n completa</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <h6>üöÄ Testing PRODUCTION</h6>
                                            <ul class="small">
                                                <li>Solo despu√©s de STAGING OK</li>
                                                <li>Smoke tests (10 ciclos)</li>
                                                <li>Post-deploy validation</li>
                                                <li>Horarios programados</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- DASHBOARD DE M√âTRICAS HIST√ìRICAS -->
                            <div id="testingMetricsDashboard" style="margin-top: 50px; border-top: 3px solid #3498db; padding-top: 30px;">
                                <div class="section-header" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 20px; border-radius: 10px; color: white; margin-bottom: 20px;">
                                    <h3 style="margin: 0;">üìä DASHBOARD DE M√âTRICAS HIST√ìRICAS</h3>
                                    <p style="margin: 10px 0 0 0; opacity: 0.9;">An√°lisis de Performance del Sistema de Testing</p>
                                </div>

                                <!-- Filtros -->
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <strong>üîç Filtros de M√©tricas</strong>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label>Empresa</label>
                                                <select id="metricsCompanyFilter" class="form-control">
                                                    <option value="">Todas las empresas</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label>Entorno</label>
                                                <select id="metricsEnvironmentFilter" class="form-control">
                                                    <option value="">Todos</option>
                                                    <option value="local">LOCAL</option>
                                                    <option value="staging">STAGING</option>
                                                    <option value="production">PRODUCTION</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label>M√≥dulo</label>
                                                <select id="metricsModuleFilter" class="form-control">
                                                    <option value="">Todos</option>
                                                    <option value="users">üë• Usuarios</option>
                                                    <option value="attendance">üìÖ Asistencia</option>
                                                    <option value="departments">üè¢ Deptos</option>
                                                    <option value="shifts">‚è∞ Turnos</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label>√öltimos d√≠as</label>
                                                <select id="metricsDaysFilter" class="form-control">
                                                    <option value="7">7 d√≠as</option>
                                                    <option value="30" selected>30 d√≠as</option>
                                                    <option value="90">90 d√≠as</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-12">
                                                <button id="btnLoadMetrics" class="btn btn-primary btn-block">
                                                    üìä Cargar M√©tricas
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cards de Resumen -->
                                <div class="row mt-4">
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 id="metricTotalExecutions" class="text-primary">-</h3>
                                                <p class="text-muted">Total Ejecuciones</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 id="metricSuccessRate" class="text-success">-</h3>
                                                <p class="text-muted">Success Rate Promedio</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 id="metricAvgDuration" class="text-info">-</h3>
                                                <p class="text-muted">Duraci√≥n Promedio</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card text-center">
                                            <div class="card-body">
                                                <h3 id="metricTotalTickets" class="text-warning">-</h3>
                                                <p class="text-muted">Tickets Generados</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gr√°ficos -->
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-success text-white">
                                                <strong>üìà Success Rate Over Time</strong>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="chartSuccessRate" height="200"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <strong>‚è±Ô∏è Duraci√≥n de Tests</strong>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="chartDuration" height="200"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header bg-info text-white">
                                                <strong>üéØ Tests por M√≥dulo</strong>
                                            </div>
                                            <div class="card-body">
                                                <canvas id="chartByModule" height="100"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabla de Historial -->
                                <div class="card mt-4">
                                    <div class="card-header bg-dark text-white">
                                        <strong>üìú Historial de Ejecuciones</strong>
                                    </div>
                                    <div class="card-body" style="padding: 0;">
                                        <div id="historyTableContainer">
                                            <table class="table table-hover" style="margin: 0;">
                                                <thead style="background: #34495e; color: white;">
                                                    <tr>
                                                        <th>Fecha</th>
                                                        <th>Entorno</th>
                                                        <th>M√≥dulo</th>
                                                        <th>Empresa</th>
                                                        <th>Tests</th>
                                                        <th>Success Rate</th>
                                                        <th>Duraci√≥n</th>
                                                        <th>Estado</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="historyTableBody">
                                                    <tr><td colspan="8" class="text-center">Haz click en "Cargar M√©tricas" para ver el historial</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CONFIGURADOR DE M√ìDULOS -->
                            <div id="modulesConfiguratorContainer" style="margin-top: 50px; border-top: 3px solid #f39c12; padding-top: 30px;">
                                <div class="section-header" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); padding: 20px; border-radius: 10px; color: white; margin-bottom: 20px;">
                                    <h3 style="margin: 0;">üß© CONFIGURADOR DE M√ìDULOS</h3>
                                    <p style="margin: 10px 0 0 0; opacity: 0.9;">Sistema de Bundling y Gesti√≥n</p>
                                </div>
                                <div id="modulesStatsContainer" style="margin-bottom: 20px;"></div>
                                <div class="card">
                                    <div class="card-header" style="background: #f39c12; color: white;">
                                        <strong>üîç Filtros</strong>
                                        <button id="btnRefreshModules" class="btn btn-sm btn-light float-right">üîÑ</button>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <select id="filterCategory" class="form-control">
                                                    <option value="all">Todas las categor√≠as</option>
                                                    <option value="admin">Admin</option>
                                                    <option value="core">Core</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <select id="filterPanel" class="form-control">
                                                    <option value="all">Todos los paneles</option>
                                                    <option value="admin">Solo Admin</option>
                                                    <option value="company">Solo Company</option>
                                                    <option value="both">Ambos</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <select id="filterCore" class="form-control">
                                                    <option value="all">Todos los tipos</option>
                                                    <option value="true">Core (Gratis)</option>
                                                    <option value="false">Premium</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card" style="margin-top: 20px;">
                                    <div class="card-body" style="padding: 0;">
                                        <table class="table table-hover" style="margin: 0;">
                                            <thead style="background: #34495e; color: white;">
                                                <tr>
                                                    <th></th>
                                                    <th>Nombre</th>
                                                    <th>Categor√≠a</th>
                                                    <th>Panel</th>
                                                    <th>Precio</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="modulesTableBody">
                                                <tr><td colspan="6" class="text-center">Cargando...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Pesta√±a Asociados (Partners) -->
                <div id="partners" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">ü§ù Asociados Profesionales & Scoring</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="window.open('/partner-register.html', '_blank')">
                                ‚ûï Nuevo Asociado
                            </button>
                            <button class="btn btn-warning" onclick="calculateAllScoring()">
                                ‚≠ê Calcular Scoring
                            </button>
                            <button class="btn btn-info" onclick="viewLowScorePartners()">
                                ‚ö†Ô∏è Partners Bajo Scoring
                            </button>
                            <button class="btn btn-primary" onclick="partnersAdmin.loadPartners()">
                                üîÑ Actualizar
                            </button>
                        </div>
                    </div>

                    <div class="section-content">
                        <!-- Stats Dashboard de Partners -->
                        <div class="partner-stats-dashboard" style="margin-bottom: 20px;">
                            <div class="vendor-stats">
                                <div class="stat-card">
                                    <div class="stat-value" id="totalPartners">-</div>
                                    <div class="stat-label">Total Partners</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="activePartners">-</div>
                                    <div class="stat-label">Activos</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="avgScoring">-</div>
                                    <div class="stat-label">Scoring Promedio</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="activeSupportPackages">-</div>
                                    <div class="stat-label">Paquetes Soporte</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="activeAuctions">-</div>
                                    <div class="stat-label">Subastas Activas</div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabs Internos de Partners -->
                        <div class="partner-tabs-container">
                            <div class="nav-tabs-secondary">
                                <button class="nav-tab-secondary active" onclick="switchPartnerSubTab('partners-list')">
                                    üë• Asociados
                                </button>
                                <button class="nav-tab-secondary" onclick="switchPartnerSubTab('scoring-dashboard')">
                                    ‚≠ê Scoring
                                </button>
                                <button class="nav-tab-secondary" onclick="switchPartnerSubTab('support-packages')">
                                    üì¶ Paquetes de Soporte
                                </button>
                                <button class="nav-tab-secondary" onclick="switchPartnerSubTab('auctions-list')">
                                    üî® Subastas
                                </button>
                                <button class="nav-tab-secondary" onclick="switchPartnerSubTab('ratings-list')">
                                    ‚≠ê Valoraciones
                                </button>
                            </div>

                            <!-- Sub-Tab: Lista de Partners -->
                            <div id="partners-list" class="partner-subtab-content active">
                                <div style="margin: 20px 0;">
                                    <!-- Filters Container -->
                                    <div id="partners-filters-container" style="margin-bottom: 15px;"></div>

                                    <!-- Partners List Container -->
                                    <div id="partners-list-container">
                                        <div style="text-align: center; padding: 40px; color: #999;">
                                            <div style="font-size: 48px; margin-bottom: 20px;">üîÑ</div>
                                            <p>Cargando asociados...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sub-Tab: Dashboard de Scoring -->
                            <div id="scoring-dashboard" class="partner-subtab-content">
                                <div style="margin: 20px 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3>‚≠ê Dashboard de Scoring de Partners</h3>
                                        <div style="display: flex; gap: 10px;">
                                            <select id="scoringFilterRange" class="filter-input" style="width: 180px;" onchange="loadScoringDashboard()">
                                                <option value="">Todos los rankings</option>
                                                <option value="excellent">Excelente (‚â• 4.5)</option>
                                                <option value="good">Bueno (3.5 - 4.5)</option>
                                                <option value="medium">Medio (2.5 - 3.5)</option>
                                                <option value="low">Bajo (2.0 - 2.5)</option>
                                                <option value="critical">Cr√≠tico (< 2.0)</option>
                                            </select>
                                            <button class="btn btn-sm btn-primary" onclick="exportScoringReport()">
                                                üìä Exportar Reporte
                                            </button>
                                        </div>
                                    </div>
                                    <div id="scoringDashboardContainer">
                                        <table class="data-table" style="width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th>Partner</th>
                                                    <th>Score Total</th>
                                                    <th>‚≠ê Rating Clientes (40%)</th>
                                                    <th>‚è±Ô∏è Tiempo Respuesta (20%)</th>
                                                    <th>‚úÖ Resoluci√≥n (20%)</th>
                                                    <th>üíº Ventas (10%)</th>
                                                    <th>üìÖ Antig√ºedad (10%)</th>
                                                    <th>Estado</th>
                                                    <th>√öltima Actualizaci√≥n</th>
                                                </tr>
                                            </thead>
                                            <tbody id="scoringDashboardBody">
                                                <tr>
                                                    <td colspan="9" style="text-align: center; padding: 40px;">
                                                        Cargando scoring de partners...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Sub-Tab: Paquetes de Soporte -->
                            <div id="support-packages" class="partner-subtab-content">
                                <div style="margin: 20px 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3>üì¶ Gesti√≥n de Paquetes de Soporte</h3>
                                        <div style="display: flex; gap: 10px;">
                                            <select id="packageFilterStatus" class="filter-input" style="width: 150px;" onchange="loadSupportPackages()">
                                                <option value="">Todos los estados</option>
                                                <option value="active">Activos</option>
                                                <option value="lost">Perdidos</option>
                                                <option value="in_auction">En Subasta</option>
                                            </select>
                                            <select id="packageFilterRating" class="filter-input" style="width: 150px;" onchange="loadSupportPackages()">
                                                <option value="">Todos los ratings</option>
                                                <option value="low">Bajo (< 2.0)</option>
                                                <option value="medium">Medio (2.0 - 3.5)</option>
                                                <option value="high">Alto (> 3.5)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="supportPackagesContainer">
                                        <table class="data-table" style="width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Empresa</th>
                                                    <th>Partner Actual</th>
                                                    <th>Partner Original</th>
                                                    <th>Vendedor</th>
                                                    <th>Rating Actual</th>
                                                    <th>Comisi√≥n Mensual</th>
                                                    <th>Monto Estimado</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="supportPackagesBody">
                                                <tr>
                                                    <td colspan="10" style="text-align: center; padding: 40px;">
                                                        Cargando paquetes de soporte...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Sub-Tab: Subastas -->
                            <div id="auctions-list" class="partner-subtab-content">
                                <div style="margin: 20px 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3>üî® Subastas Autom√°ticas de Paquetes de Soporte</h3>
                                        <div style="display: flex; gap: 10px;">
                                            <select id="auctionFilterStatus" class="filter-input" style="width: 150px;" onchange="loadAuctions()">
                                                <option value="">Todos los estados</option>
                                                <option value="active">Activas</option>
                                                <option value="completed">Completadas</option>
                                                <option value="cancelled">Canceladas</option>
                                            </select>
                                            <button class="btn btn-sm btn-info" onclick="showAuctionHelp()">
                                                ‚ùì C√≥mo Funcionan
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Info Box -->
                                    <div style="background: #e7f3ff; border-left: 4px solid #3498db; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                                        <strong>‚ÑπÔ∏è Generaci√≥n Autom√°tica:</strong> Las subastas se crean autom√°ticamente cuando un partner alcanza <strong>&lt; 2.0 ‚≠ê</strong> de valoraci√≥n.
                                        Todos los partners con <em>"Acepta Subastas"</em> activado reciben notificaci√≥n instant√°nea.
                                    </div>

                                    <div id="auctionsContainer">
                                        <table class="data-table" style="width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th style="min-width: 200px;">Informaci√≥n del Paquete</th>
                                                    <th>Empresa</th>
                                                    <th>Empleados</th>
                                                    <th>M√≥dulos Contratados</th>
                                                    <th>Partner Actual</th>
                                                    <th>Rating Actual</th>
                                                    <th>Raz√≥n</th>
                                                    <th>Comisi√≥n Inicial</th>
                                                    <th>Mejor Oferta</th>
                                                    <th>Ofertas</th>
                                                    <th>Tiempo Restante</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="auctionsBody">
                                                <tr>
                                                    <td colspan="14" style="text-align: center; padding: 40px;">
                                                        Cargando subastas...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Sub-Tab: Valoraciones -->
                            <div id="ratings-list" class="partner-subtab-content">
                                <div style="margin: 20px 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3>‚≠ê Valoraciones de Clientes</h3>
                                        <div style="display: flex; gap: 10px;">
                                            <select id="ratingFilterStars" class="filter-input" style="width: 150px;" onchange="loadRatings()">
                                                <option value="">Todas las estrellas</option>
                                                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
                                                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
                                                <option value="3">‚≠ê‚≠ê‚≠ê (3)</option>
                                                <option value="2">‚≠ê‚≠ê (2)</option>
                                                <option value="1">‚≠ê (1)</option>
                                            </select>
                                            <input type="month" id="ratingFilterMonth" class="filter-input" style="width: 150px;" onchange="loadRatings()">
                                        </div>
                                    </div>
                                    <div id="ratingsContainer">
                                        <table class="data-table" style="width: 100%;">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Fecha</th>
                                                    <th>Partner</th>
                                                    <th>Empresa</th>
                                                    <th>Rating</th>
                                                    <th>Categor√≠a</th>
                                                    <th>Comentarios</th>
                                                    <th>Valorado por</th>
                                                </tr>
                                            </thead>
                                            <tbody id="ratingsBody">
                                                <tr>
                                                    <td colspan="8" style="text-align: center; padding: 40px;">
                                                        Cargando valoraciones...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a Plantillas Fiscales -->
                <div id="taxTemplates" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">üèõÔ∏è Plantillas Fiscales por Pa√≠s</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="openNewTaxTemplateModal()">
                                ‚ûï Nueva Plantilla
                            </button>
                            <button class="btn btn-info" onclick="exportAllTaxTemplates()">
                                üì§ Exportar Todas
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="taxTemplatesContainer">
                            <!-- Lista de plantillas se carga aqu√≠ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nueva/Editar Empresa -->
    <div id="companyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Nueva Empresa</h3>
                <button class="close-btn" onclick="closeCompanyModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="companyForm">
                    <div class="form-grid">
                        <div class="company-form">
                            <div class="form-group">
                                <label class="form-label">Nombre de la Empresa *</label>
                                <input type="text" class="form-input" id="companyName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Raz√≥n Social</label>
                                <input type="text" class="form-input" id="legalName">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CUIT *</label>
                                <input type="text" class="form-input" id="taxId" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-input" id="contactEmail" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tel√©fono</label>
                                <input type="text" class="form-input" id="contactPhone">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Direcci√≥n</label>
                                <input type="text" class="form-input" id="address" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pa√≠s</label>
                                <select class="form-input" id="country" onchange="loadProvinces()">
                                    <option value="Argentina">Argentina</option>
                                    <option value="Bolivia">Bolivia</option>
                                    <option value="Brasil">Brasil</option>
                                    <option value="Chile">Chile</option>
                                    <option value="Colombia">Colombia</option>
                                    <option value="Costa Rica">Costa Rica</option>
                                    <option value="Ecuador">Ecuador</option>
                                    <option value="El Salvador">El Salvador</option>
                                    <option value="Espa√±a">Espa√±a</option>
                                    <option value="Guatemala">Guatemala</option>
                                    <option value="Honduras">Honduras</option>
                                    <option value="M√©xico">M√©xico</option>
                                    <option value="Nicaragua">Nicaragua</option>
                                    <option value="Panam√°">Panam√°</option>
                                    <option value="Paraguay">Paraguay</option>
                                    <option value="Per√∫">Per√∫</option>
                                    <option value="Uruguay">Uruguay</option>
                                    <option value="Venezuela">Venezuela</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Provincia</label>
                                <select class="form-input" id="province" onchange="loadCities()">
                                    <option value="">Seleccionar provincia...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ciudad</label>
                                <select class="form-input" id="city" onchange="loadPostalCode()">
                                    <option value="">Seleccionar ciudad...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">C√≥digo Postal</label>
                                <input type="text" class="form-input" id="postalCode" readonly style="background-color: #f8f9fa;">
                            </div>

                            <!-- Secci√≥n de Geolocalizaci√≥n para Empresa -->
                            <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">
                                <h6 style="color: #495057; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                    üåê Geolocalizaci√≥n de la Empresa
                                </h6>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label class="form-label">Latitud</label>
                                        <input type="number" class="form-input" id="companyLatitude" step="any"
                                               placeholder="Ej: -34.6037">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label class="form-label">Longitud</label>
                                        <input type="number" class="form-input" id="companyLongitude" step="any"
                                               placeholder="Ej: -58.3816">
                                    </div>
                                </div>
                                <div style="text-align: center; margin-top: 0.75rem;">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="geocodeCompanyAddress()">
                                        üìç Obtener coordenadas autom√°ticamente
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="showCompanyMap()" style="margin-left: 0.5rem;">
                                        üó∫Ô∏è Ver en mapa
                                    </button>
                                </div>
                                <div style="font-size: 0.8rem; color: #6c757d; margin-top: 0.5rem; text-align: center;">
                                    Las coordenadas se obtienen desde la direcci√≥n de la empresa ingresada arriba
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tipo de Licencia de soporte y asistencia al usuario</label>
                                <select class="form-input" id="licenseType">
                                    <option value="basic">B√°sica</option>
                                    <option value="premium">Premium</option>
                                    <option value="enterprise">Empresarial</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estado</label>
                                <select class="form-input" id="companyStatus">
                                    <option value="cotizado">Cotizado</option>
                                    <option value="active">Activo</option>
                                    <option value="suspended">Suspendido</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vendedor</label>
                                <input type="text" class="form-input" id="vendorDisplay" readonly style="background-color: #f8f9fa; cursor: not-allowed;" placeholder="No asignado">
                                <input type="hidden" id="vendor">
                            </div>

                            <!-- Grid de Comisiones -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <!-- Comisi√≥n de Venta - Porcentaje -->
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label" style="font-size: 0.85rem;">% Comisi√≥n permanente por venta</label>
                                    <input type="number" class="form-input" id="commissionPercentage" min="0" max="100" step="0.1" placeholder="10" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                                </div>
                                <!-- Comisi√≥n de Venta - Monto USD -->
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label" style="font-size: 0.85rem;">üí∞ Comisi√≥n Venta (USD)</label>
                                    <input type="text" class="form-input" id="salesCommissionUSD" readonly style="background-color: #e8f5e9; cursor: not-allowed; font-weight: 600; color: #2e7d32;" placeholder="$0.00">
                                </div>
                                <!-- Comisi√≥n de Soporte - Porcentaje -->
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label" style="font-size: 0.85rem;">% Comisi√≥n Temporal por soporte</label>
                                    <input type="number" class="form-input" id="supportCommissionPercentage" min="0" max="100" step="0.1" placeholder="0" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                                </div>
                                <!-- Comisi√≥n de Soporte - Monto USD -->
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label" style="font-size: 0.85rem;">üõ†Ô∏è Comisi√≥n Soporte (USD)</label>
                                    <input type="text" class="form-input" id="supportCommissionUSD" readonly style="background-color: #e3f2fd; cursor: not-allowed; font-weight: 600; color: #1565c0;" placeholder="$0.00">
                                </div>
                            </div>

                            <div class="modules-section">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h3>üì¶ M√≥dulos del Sistema (<span id="moduleCount">0</span> seleccionados)</h3>
                                    <div class="module-filters">
                                        <button type="button" class="filter-btn active" onclick="filterModules('all')" id="filterAll">Todos</button>
                                        <button type="button" class="filter-btn" onclick="filterModules('contracted')" id="filterContracted">Contratados</button>
                                        <button type="button" class="filter-btn" onclick="filterModules('available')" id="filterAvailable">Disponibles</button>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 15px;">
                                    <div class="employee-counter" style="flex: 1;">
                                        <label class="form-label">Empleados Contratados (para facturaci√≥n):</label>
                                        <input type="number" id="contractedEmployees" value="1" min="1" max="10000" onchange="updateModulePricing()">
                                        <small style="color: #666; font-size: 0.85em; margin-top: 4px; display: block;">
                                            Cantidad de empleados que la empresa paga mensualmente
                                        </small>
                                    </div>
                                    <div class="employee-counter" style="flex: 1;">
                                        <label class="form-label">L√≠mite M√°ximo de Empleados:</label>
                                        <input type="number" id="maxEmployees" value="50" min="1" max="10000">
                                        <small style="color: #666; font-size: 0.85em; margin-top: 4px; display: block;">
                                            L√≠mite t√©cnico del sistema para esta empresa
                                        </small>
                                    </div>
                                </div>
                                <div class="modules-grid" id="modulesGrid">
                                    <!-- M√≥dulos se cargan aqu√≠ -->
                                </div>
                            </div>
                        </div>

                        <div class="pricing-sidebar">
                            <h3>üí∞ Cotizaci√≥n</h3>
                            
                            <div class="tier-info" id="tierInfo">
                                <strong>Tier:</strong> <span id="currentTier">1-50 empleados</span><br>
                                <strong>Descuento:</strong> <span id="currentDiscount">Sin descuento</span>
                            </div>

                            <div class="pricing-summary">
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <span>$ <span id="subtotal">0.00</span></span>
                                </div>
                                <div class="summary-row">
                                    <span>IVA (21%):</span>
                                    <span>$ <span id="tax">0.00</span></span>
                                </div>
                                <div class="summary-row summary-total">
                                    <span>Total Mensual:</span>
                                    <span>$ <span id="total">0.00</span></span>
                                </div>
                            </div>

                            <div class="selected-modules" id="selectedModules">
                                <h4>M√≥dulos Seleccionados (<span id="moduleCount">0</span>):</h4>
                                <div id="selectedModulesList" class="selected-modules"></div>
                            </div>

                            <div id="priceUpdateSection" style="margin: 1rem 0; padding: 1rem; background: #fff3cd; border-radius: 8px; display: none;">
                                <h5 style="color: #856404; margin-bottom: 0.5rem;">‚ö†Ô∏è Actualizar Precios</h5>
                                <p style="font-size: 0.9rem; color: #856404; margin-bottom: 1rem;">Los precios de los m√≥dulos han cambiado desde la contrataci√≥n. ¬øDeseas aplicar los nuevos precios?</p>
                                <label style="display: flex; align-items: center; gap: 0.5rem; color: #856404;">
                                    <input type="checkbox" id="updatePricesCheckbox" onchange="togglePriceUpdate()">
                                    <span>Aplicar precios actuales (se recalcular√° el canon mensual)</span>
                                </label>
                            </div>
                            
                            <div id="moduleModificationSection" style="margin: 1rem 0; padding: 1rem; background: #e3f2fd; border-radius: 8px; display: none;">
                                <h5 style="color: #1565c0; margin-bottom: 0.5rem;">üîß Modificar M√≥dulos</h5>
                                <p style="font-size: 0.9rem; color: #1565c0; margin-bottom: 1rem;">Permite agregar o quitar m√≥dulos ya contratados.</p>
                                <label style="display: flex; align-items: center; gap: 0.5rem; color: #1565c0;">
                                    <input type="checkbox" id="allowModificationCheckbox" onchange="toggleModuleModification()">
                                    <span>Permitir modificar m√≥dulos contratados</span>
                                </label>
                            </div>

                            <!-- Secci√≥n de Gesti√≥n de Sucursales -->
                            <div id="branchesSection" style="margin: 2rem 0; padding: 1.5rem; background: #f3e5f5; border-radius: 12px; border: 2px solid #7b1fa2; box-shadow: 0 4px 8px rgba(123, 31, 162, 0.2);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                    <h4 style="color: #7b1fa2; margin: 0; font-size: 1.2rem; font-weight: 600;">üè¢ Gesti√≥n de Sucursales</h4>
                                    <button type="button" class="btn btn-primary" onclick="openBranchModal()" style="background: #7b1fa2; border-color: #7b1fa2;">
                                        <i class="fas fa-plus"></i> Nueva Sucursal
                                    </button>
                                </div>
                                <div id="branchesContainer" style="margin-top: 1rem;">
                                    <div class="no-branches" style="text-align: center; color: #666; padding: 2rem; background: white; border-radius: 8px; border: 1px dashed #ccc;">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">üè¢</div>
                                        <h5>No hay sucursales registradas</h5>
                                        <p>Haz clic en "Nueva Sucursal" para agregar la primera</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Secci√≥n de Gesti√≥n de Usuarios -->
                            <div id="usersSection" style="margin: 1rem 0; padding: 1rem; background: #e3f2fd; border-radius: 8px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                    <h5 style="color: #1976d2; margin: 0;">üë§ Usuarios Administradores</h5>
                                    <button type="button" class="btn btn-sm btn-info" onclick="loadCompanyUsers()" style="font-size: 0.8rem;">
                                        <i class="fas fa-sync"></i> Actualizar
                                    </button>
                                </div>
                                <div id="usersContainer" style="margin-top: 1rem;">
                                    <div class="no-users" style="text-align: center; color: #666; padding: 1rem;">
                                        Haga clic en "Actualizar" para cargar usuarios
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </form>
            </div>
            <!-- Footer del modal con botones -->
            <div class="modal-footer" style="padding: 0.65rem 2rem; border-top: 1px solid #eee; display: flex; gap: 1rem; justify-content: flex-end; background: #f8f9fa; border-radius: 0 0 20px 20px;">
                <button type="button" class="btn" style="padding: 0.75rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: 600;" onclick="closeCompanyModal()">
                    ‚ùå Cancelar
                </button>
                <button type="button" class="btn btn-success" style="padding: 0.55rem 2rem; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: 600;" id="saveCompanyBtn" onclick="saveCompany()">
                    <span id="saveBtnText">üíæ Guardar Cambios</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo/Editar Vendedor -->
    <div id="vendorModal" class="vendor-modal">
        <div class="vendor-modal-content">
            <div class="modal-header">
                <h3 id="vendorModalTitle">‚ûï Nuevo Vendedor</h3>
                <button class="close-btn" onclick="closeVendorModal()">&times;</button>
            </div>

            <div class="modal-body">
                <form id="vendorForm">
                    <!-- Informaci√≥n Personal -->
                    <div class="vendor-section">
                        <h4 class="section-title">üë§ Informaci√≥n Personal</h4>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="vendorName" class="form-label">Nombre Completo *</label>
                                <input type="text" id="vendorName" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="vendorEmail" class="form-label">Email *</label>
                                <input type="email" id="vendorEmail" class="form-input" required>
                            </div>
                        </div>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="vendorPhone" class="form-label">Tel√©fono</label>
                                <input type="tel" id="vendorPhone" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="vendorCBU" class="form-label">CBU</label>
                                <input type="text" id="vendorCBU" class="form-input" maxlength="22">
                            </div>
                        </div>
                    </div>

                    <!-- Configuraci√≥n de Comisiones -->
                    <div class="vendor-section">
                        <h4 class="section-title">üí∞ Configuraci√≥n de Comisiones</h4>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="vendorSalesCommission" class="form-label">% Comisi√≥n Ventas *</label>
                                <input type="number" id="vendorSalesCommission" class="form-input" min="0" max="100" step="0.1" value="10" required>
                                <small class="form-help">üîí Comisi√≥n fija por ventas (no transferible)</small>
                            </div>
                            <div class="form-group">
                                <label for="vendorSupportCommission" class="form-label">% Comisi√≥n Soporte</label>
                                <input type="number" id="vendorSupportCommission" class="form-input" min="0" max="100" step="0.1" value="5">
                                <small class="form-help">üîÑ Comisi√≥n por asistencia al cliente (transferible)</small>
                            </div>
                        </div>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="vendorAcceptsSupportPackages" class="form-label">Acepta Paquetes de Soporte</label>
                                <select id="vendorAcceptsSupportPackages" class="form-input">
                                    <option value="true">‚úÖ S√≠, acepto dar soporte</option>
                                    <option value="false">‚ùå No, solo ventas</option>
                                </select>
                                <small class="form-help">üìã Define si acepta comisiones por asistencia</small>
                            </div>
                            <div class="form-group">
                                <label for="vendorAcceptsAuctions" class="form-label">Participa en Subastas</label>
                                <select id="vendorAcceptsAuctions" class="form-input">
                                    <option value="true">üéØ S√≠, participo en subastas</option>
                                    <option value="false">üö´ No, no participo</option>
                                </select>
                                <small class="form-help">üîÑ Define si participa en subastas de paquetes reasignados</small>
                            </div>
                        </div>
                    </div>

                    <!-- Configuraci√≥n General -->
                    <div class="vendor-section">
                        <h4 class="section-title">‚öôÔ∏è Configuraci√≥n General</h4>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="vendorStatus" class="form-label">Estado</label>
                                <select id="vendorStatus" class="form-input">
                                    <option value="activo">‚úÖ Activo</option>
                                    <option value="inactivo">‚ùå Inactivo</option>
                                </select>
                            </div>
                            <div class="form-group"></div>
                        </div>
                        <div class="form-group">
                            <label for="vendorNotes" class="form-label">Notas</label>
                            <textarea id="vendorNotes" class="form-input" rows="3" placeholder="Observaciones adicionales..."></textarea>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeVendorModal()">
                    ‚ùå Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="saveVendor()" id="saveVendorBtn">
                    <span id="saveVendorBtnText">üíæ Guardar Vendedor</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================
         MODAL: STAFF APONNT (UNIFICADO PARAMETRIZADO)
         ============================================ -->
    <div id="staffModal" class="vendor-modal" style="display: none;">
        <div class="vendor-modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="staffModalTitle">‚ûï Nuevo Staff Member</h3>
                <button class="close-btn" onclick="closeStaffModal()">&times;</button>
            </div>

            <div class="modal-body">
                <form id="staffForm">
                    <!-- Informaci√≥n Personal -->
                    <div class="vendor-section">
                        <h4 class="section-title">üë§ Informaci√≥n Personal</h4>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="staffFirstName" class="form-label">Nombre *</label>
                                <input type="text" id="staffFirstName" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="staffLastName" class="form-label">Apellido *</label>
                                <input type="text" id="staffLastName" class="form-input" required>
                            </div>
                        </div>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="staffEmail" class="form-label">Email *</label>
                                <input type="email" id="staffEmail" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="staffPhone" class="form-label">Tel√©fono</label>
                                <input type="tel" id="staffPhone" class="form-input">
                            </div>
                        </div>
                    </div>

                    <!-- Rol y Ubicaci√≥n -->
                    <div class="vendor-section">
                        <h4 class="section-title">üè¢ Rol y Ubicaci√≥n</h4>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="staffRole" class="form-label">Rol *</label>
                                <select id="staffRole" class="form-input" required onchange="updateStaffFormFields()">
                                    <option value="">-- Seleccionar Rol --</option>
                                    <!-- Se cargar√° din√°micamente desde API /api/aponnt/staff-data/roles -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="staffCountry" class="form-label">Pa√≠s *</label>
                                <select id="staffCountry" class="form-input" required>
                                    <option value="AR">üá¶üá∑ Argentina</option>
                                    <option value="BR">üáßüá∑ Brasil</option>
                                    <option value="CL">üá®üá± Chile</option>
                                    <option value="MX">üá≤üáΩ M√©xico</option>
                                    <option value="US">üá∫üá∏ Estados Unidos</option>
                                    <option value="ES">üá™üá∏ Espa√±a</option>
                                </select>
                            </div>
                        </div>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="staffSupervisor" class="form-label">Supervisor</label>
                                <select id="staffSupervisor" class="form-input">
                                    <option value="">-- Sin supervisor (reporta a CEO) --</option>
                                    <!-- Se cargar√° din√°micamente -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="staffLanguage" class="form-label">Idioma Preferido</label>
                                <select id="staffLanguage" class="form-input">
                                    <option value="es">Espa√±ol</option>
                                    <option value="en">English</option>
                                    <option value="pt">Portugu√™s</option>
                                    <option value="fr">Fran√ßais</option>
                                    <option value="de">Deutsch</option>
                                    <option value="it">Italiano</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Campos Espec√≠ficos de Vendedor (solo si area=ventas) -->
                    <div class="vendor-section" id="vendorFieldsSection" style="display: none;">
                        <h4 class="section-title">üí∞ Configuraci√≥n de Vendedor</h4>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="staffCBU" class="form-label">CBU</label>
                                <input type="text" id="staffCBU" class="form-input" maxlength="22">
                            </div>
                            <div class="form-group">
                                <label for="staffBankName" class="form-label">Banco</label>
                                <input type="text" id="staffBankName" class="form-input">
                            </div>
                        </div>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="staffWhatsapp" class="form-label">WhatsApp</label>
                                <input type="tel" id="staffWhatsapp" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="staffAcceptsSupportPackages" class="form-label">Acepta Paquetes Soporte</label>
                                <select id="staffAcceptsSupportPackages" class="form-input">
                                    <option value="true">‚úÖ S√≠</option>
                                    <option value="false">‚ùå No</option>
                                </select>
                            </div>
                        </div>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="staffAcceptsAuctions" class="form-label">Participa en Subastas</label>
                                <select id="staffAcceptsAuctions" class="form-input">
                                    <option value="true">‚úÖ S√≠</option>
                                    <option value="false">‚ùå No</option>
                                </select>
                            </div>
                            <div class="form-group"></div>
                        </div>
                    </div>

                    <!-- Estado -->
                    <div class="vendor-section">
                        <h4 class="section-title">‚öôÔ∏è Estado</h4>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="staffStatus" class="form-label">Estado</label>
                                <select id="staffStatus" class="form-input">
                                    <option value="true">‚úÖ Activo</option>
                                    <option value="false">‚ùå Inactivo</option>
                                </select>
                            </div>
                            <div class="form-group"></div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeStaffModal()">
                    ‚ùå Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="saveStaff()" id="saveStaffBtn">
                    <span id="saveStaffBtnText">üíæ Guardar Staff</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Gesti√≥n de Roles de Staff -->
    <div id="staffRoleModal" class="vendor-modal" style="display: none;">
        <div class="vendor-modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="staffRoleModalTitle">‚ûï Nuevo Rol de Staff</h3>
                <button class="close-btn" onclick="closeStaffRoleModal()">&times;</button>
            </div>

            <div class="modal-body">
                <form id="staffRoleForm">
                    <!-- Informaci√≥n B√°sica -->
                    <div class="vendor-section">
                        <h4 class="section-title">üé≠ Informaci√≥n B√°sica del Rol</h4>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="roleCode" class="form-label">C√≥digo de Rol *</label>
                                <input type="text" id="roleCode" class="form-input" required
                                       maxlength="20" style="text-transform: uppercase;"
                                       placeholder="Ej: GR-AR, JV-BR">
                                <small style="color: #666; font-size: 0.85rem;">
                                    Formato sugerido: NIVEL-PA√çS (ej: GR-AR, JV-MX)
                                </small>
                            </div>
                            <div class="form-group">
                                <label for="roleName" class="form-label">Nombre del Rol (espa√±ol) *</label>
                                <input type="text" id="roleName" class="form-input" required
                                       maxlength="100" placeholder="Ej: Gerente Regional Argentina">
                            </div>
                        </div>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="roleLevel" class="form-label">Nivel Jer√°rquico *</label>
                                <select id="roleLevel" class="form-input" required>
                                    <option value="">-- Seleccionar Nivel --</option>
                                    <option value="0">Nivel 0 - CEO (Direcci√≥n Ejecutiva)</option>
                                    <option value="1">Nivel 1 - Gerentes (Gesti√≥n Regional/Global)</option>
                                    <option value="2">Nivel 2 - Jefes (Supervisi√≥n de Equipos)</option>
                                    <option value="3">Nivel 3 - Coordinadores (Coordinaci√≥n Operativa)</option>
                                    <option value="4">Nivel 4 - Operativos (Ejecuci√≥n)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="roleArea" class="form-label">√Årea Organizacional *</label>
                                <select id="roleArea" class="form-input" required>
                                    <option value="">-- Seleccionar √Årea --</option>
                                    <option value="direccion">Direcci√≥n</option>
                                    <option value="ventas">Ventas</option>
                                    <option value="admin">Administraci√≥n</option>
                                    <option value="desarrollo">Desarrollo</option>
                                    <option value="externo">Externo</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="roleDescription" class="form-label">Descripci√≥n del Rol</label>
                            <textarea id="roleDescription" class="form-input" rows="3"
                                      maxlength="500" placeholder="Descripci√≥n opcional del rol y sus responsabilidades"></textarea>
                        </div>
                    </div>

                    <!-- Traducciones i18n (6 idiomas) -->
                    <div class="vendor-section">
                        <h4 class="section-title">üåç Traducciones Multiidioma (i18n)</h4>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                            Configurar el nombre del rol en los 6 idiomas soportados por el sistema.
                        </p>

                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="roleNameES" class="form-label">üá™üá∏ Espa√±ol (es)</label>
                                <input type="text" id="roleNameES" class="form-input" maxlength="100"
                                       placeholder="Ej: Gerente Regional Argentina">
                            </div>
                            <div class="form-group">
                                <label for="roleNameEN" class="form-label">üá∫üá∏ Ingl√©s (en)</label>
                                <input type="text" id="roleNameEN" class="form-input" maxlength="100"
                                       placeholder="Ex: Regional Manager Argentina">
                            </div>
                        </div>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="roleNamePT" class="form-label">üáßüá∑ Portugu√©s (pt)</label>
                                <input type="text" id="roleNamePT" class="form-input" maxlength="100"
                                       placeholder="Ex: Gerente Regional Argentina">
                            </div>
                            <div class="form-group">
                                <label for="roleNameFR" class="form-label">üá´üá∑ Franc√©s (fr)</label>
                                <input type="text" id="roleNameFR" class="form-input" maxlength="100"
                                       placeholder="Ex: Directeur R√©gional Argentine">
                            </div>
                        </div>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="roleNameDE" class="form-label">üá©üá™ Alem√°n (de)</label>
                                <input type="text" id="roleNameDE" class="form-input" maxlength="100"
                                       placeholder="Ex: Regionalleiter Argentinien">
                            </div>
                            <div class="form-group">
                                <label for="roleNameIT" class="form-label">üáÆüáπ Italiano (it)</label>
                                <input type="text" id="roleNameIT" class="form-input" maxlength="100"
                                       placeholder="Ex: Direttore Regionale Argentina">
                            </div>
                        </div>
                    </div>

                    <!-- Alerta si es un rol base protegido -->
                    <div id="baseRoleWarning" style="display: none; margin: 20px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                        <p style="margin: 0; color: #856404; font-size: 0.9rem;">
                            ‚ö†Ô∏è <strong>Rol base protegido:</strong> Este es un rol base del sistema. Solo puedes editar las traducciones i18n.
                        </p>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeStaffRoleModal()">
                    ‚ùå Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="saveStaffRole()" id="saveStaffRoleBtn">
                    <span id="saveStaffRoleBtnText">üíæ Guardar Rol</span>
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteStaffRole()" id="deleteStaffRoleBtn" style="display: none;">
                    üóëÔ∏è Eliminar Rol
                </button>
            </div>
        </div>
    </div>

                <!-- ============================================
                     PESTA√ëA: CONSENTIMIENTOS
                     ============================================ -->
                <div id="consents" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">üìú Gesti√≥n de Consentimientos</h2>
                        <p style="color: #666; margin-top: 10px;">
                            Sistema centralizado de gesti√≥n de consentimientos legales para empleados, vendedores y partners.
                            Cumplimiento GDPR/RGPD y normativas locales.
                        </p>
                    </div>

                    <!-- Stats Container (se llena desde admin-consent-management.js) -->
                    <div id="consent-stats-container" class="row mb-4">
                        <!-- Se renderiza din√°micamente -->
                    </div>

                    <!-- Filters Row -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <input type="text" id="consent-search-input" class="form-control" placeholder="Buscar consentimientos...">
                        </div>
                        <div class="col-md-2">
                            <select id="consent-category-filter" class="form-control">
                                <option value="all">Todas las categor√≠as</option>
                                <option value="privacy">Privacidad</option>
                                <option value="biometric">Biom√©trica</option>
                                <option value="marketing">Marketing</option>
                                <option value="data_sharing">Compartir Datos</option>
                                <option value="communication">Comunicaci√≥n</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select id="consent-status-filter" class="form-control">
                                <option value="all">Todos los estados</option>
                                <option value="active">Activos</option>
                                <option value="inactive">Inactivos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button id="btn-create-consent" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Nuevo Consentimiento
                            </button>
                        </div>
                    </div>

                    <!-- Consents Table (se llena desde admin-consent-management.js) -->
                    <div id="consents-table-container">
                        <div class="text-center" style="padding: 40px;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Cargando consentimientos...</span>
                            </div>
                            <p style="margin-top: 10px; color: #666;">Cargando datos...</p>
                        </div>
                    </div>

                    <!-- Pagination (se llena desde admin-consent-management.js) -->
                    <div id="consents-pagination" class="mt-3">
                        <!-- Se renderiza din√°micamente -->
                    </div>
                </div>

                <!-- ============================================
                     PESTA√ëA: TICKETS DE SOPORTE
                     ============================================ -->
                <div id="supportTickets" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">üé´ Gesti√≥n de Tickets de Soporte</h2>
                        <p style="color: #666; margin-top: 10px;">
                            Sistema avanzado de tickets de soporte con SLA, escalamiento autom√°tico y m√©tricas de rendimiento.
                            Integrado con sistema de notificaciones en tiempo real.
                        </p>
                    </div>

                    <!-- View Toggle Buttons -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="btn-group" role="group">
                                <button id="view-kanban" class="btn btn-primary active">
                                    <i class="fas fa-columns"></i> Kanban
                                </button>
                                <button id="view-list" class="btn btn-outline-primary">
                                    <i class="fas fa-list"></i> Lista
                                </button>
                                <button id="view-calendar" class="btn btn-outline-primary">
                                    <i class="fas fa-calendar"></i> Calendario
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filters Row -->
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <input type="text" id="ticket-search-input" class="form-control" placeholder="Buscar tickets...">
                        </div>
                        <div class="col-md-2">
                            <select id="ticket-status-filter" class="form-control">
                                <option value="all">Todos los estados</option>
                                <option value="open">Abiertos</option>
                                <option value="in_progress">En progreso</option>
                                <option value="resolved">Resueltos</option>
                                <option value="closed">Cerrados</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select id="ticket-priority-filter" class="form-control">
                                <option value="all">Todas las prioridades</option>
                                <option value="urgent">Urgente</option>
                                <option value="high">Alta</option>
                                <option value="normal">Normal</option>
                                <option value="low">Baja</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select id="ticket-company-filter" class="form-control">
                                <option value="all">Todas las empresas</option>
                                <!-- Se llena din√°micamente -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select id="ticket-assigned-filter" class="form-control">
                                <option value="me">Asignados a m√≠</option>
                                <option value="all">Todos</option>
                                <option value="unassigned">Sin asignar</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tickets View Container (se llena desde admin-support-tickets-view.js) -->
                    <div id="tickets-view-container">
                        <div class="text-center" style="padding: 40px;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Cargando tickets...</span>
                            </div>
                            <p style="margin-top: 10px; color: #666;">Cargando datos...</p>
                        </div>
                    </div>
                </div>

                <!-- Pesta√±a Ingenier√≠a -->
                <div id="engineering" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">üèóÔ∏è Engineering Dashboard</h2>
                        <p style="color: #666; margin-top: 10px;">
                            Panel de control de ingenier√≠a con m√©tricas, roadmap, y estado de m√≥dulos del sistema.
                        </p>
                    </div>
                    <div id="engineering-tab-container">
                        <div class="text-center" style="padding: 60px;">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                <span class="sr-only">Cargando Engineering Dashboard...</span>
                            </div>
                            <p style="margin-top: 20px; color: #666;">Cargando metadata del sistema...</p>
                        </div>
                    </div>
                </div>

        </div>
    </div>

    <script>
        // Configuraci√≥n de la API y autenticaci√≥n
        const API_BASE = ''; // Base vac√≠a para usar rutas completas
        let currentUser = null;
        
        // Configurar token temporal para pruebas
        // Token debe ser obtenido mediante login real, no hardcodeado
        
        // Datos de demo para testing offline
        let demoCompanies = [
            {
                id: 1,
                name: "Empresa Demo 1",
                legalName: "Empresa Demo S.A.",
                taxId: "20-12345678-9",
                contactEmail: "admin@demo1.com",
                contactPhone: "011-1234-5678",
                address: "Av. Corrientes 1234",
                licenseType: "enterprise",
                maxEmployees: 100,
                status: "active",
                modules: ["attendance", "payroll", "billing"],
                modulesPricing: {
                    attendance: { name: "Asistencia", price: 500, totalPrice: 50000 },
                    payroll: { name: "N√≥mina", price: 800, totalPrice: 80000 },
                    billing: { name: "Facturaci√≥n", price: 600, totalPrice: 60000 }
                },
                pricing: {
                    tier: "Enterprise",
                    monthlySubtotal: 190000,
                    monthlyTax: 39900,
                    monthlyTotal: 229900,
                    lastUpdated: new Date().toISOString()
                },
                createdAt: new Date().toISOString(),
                currentTier: "enterprise"
            },
            {
                id: 2,
                name: "Empresa Demo 2",
                legalName: "Demo Corp",
                taxId: "20-87654321-0",
                contactEmail: "contact@demo2.com",
                contactPhone: "011-8765-4321",
                address: "Av. Santa Fe 5678",
                licenseType: "professional",
                maxEmployees: 50,
                status: "active",
                modules: ["attendance", "reports"],
                modulesPricing: {
                    attendance: { name: "Asistencia", price: 400, totalPrice: 20000 },
                    reports: { name: "Reportes", price: 300, totalPrice: 15000 }
                },
                pricing: {
                    tier: "Professional",
                    monthlySubtotal: 35000,
                    monthlyTax: 7350,
                    monthlyTotal: 42350,
                    lastUpdated: new Date().toISOString()
                },
                createdAt: new Date().toISOString(),
                currentTier: "professional"
            }
        ];
        
        let demoMode = false; // Forzar modo real // Modo real con base de datos
        let fallbackToDemo = false; // Fallback a demo deshabilitado - usar solo datos reales de PostgreSQL
        
        // Verificaci√≥n de autenticaci√≥n simplificada (se ejecuta en el segundo DOMContentLoaded)

        function checkAuthentication() {
            // Intentar cargar usuario desde localStorage (sistema de login staff)
            const userData = localStorage.getItem('aponnt_user_staff') || localStorage.getItem('aponnt_user_partner');
            const token = localStorage.getItem('aponnt_token_staff') || localStorage.getItem('aponnt_token_partner');

            if (userData && token) {
                try {
                    const user = JSON.parse(userData);
                    currentUser = {
                        id: user.id,
                        username: user.username || user.email,
                        firstName: user.first_name,
                        lastName: user.last_name,
                        fullName: `${user.first_name} ${user.last_name}`,
                        email: user.email,
                        role: user.role,
                        dni: user.dni,
                        userType: localStorage.getItem('aponnt_user_type') || 'staff'
                    };
                    console.log('‚úÖ [AUTH] Usuario cargado desde localStorage:', currentUser);
                    loadUserInfoToHeader();
                } catch (error) {
                    console.error('‚ùå [AUTH] Error parseando datos de usuario:', error);
                    currentUser = { username: 'admin_panel', firstName: 'Panel', lastName: 'Administrativo', role: 'administrador' };
                }
            } else {
                // Fallback: Panel administrativo - acceso directo sin autenticaci√≥n
                currentUser = { username: 'admin_panel', firstName: 'Panel', lastName: 'Administrativo', role: 'administrador' };
                console.log('üîì Acceso directo al panel administrativo (modo fallback)');
                loadUserInfoToHeader(); // Actualizar header con usuario fallback
            }

            // Mostrar interfaz completa
            setupUIForRole();
        }

        // Funci√≥n para cargar info del usuario en el header
        function loadUserInfoToHeader() {
            const userFullNameEl = document.getElementById('userFullName');
            const userRoleAndIdEl = document.getElementById('userRoleAndId');
            const userAvatarIconEl = document.getElementById('userAvatarIcon');

            if (!currentUser) return;

            // Mostrar nombre completo con formato: Apellido, Nombre (ID: xxx)
            if (userFullNameEl) {
                const lastName = currentUser.lastName || '';
                const firstName = currentUser.firstName || '';
                const userId = currentUser.id ? ` (ID: ${String(currentUser.id).substring(0, 8)})` : '';
                // Formato: Apellido, Nombre (ID: xxx)
                const displayName = lastName && firstName
                    ? `${lastName}, ${firstName}${userId}`
                    : currentUser.fullName || `${firstName} ${lastName}${userId}`;
                userFullNameEl.textContent = displayName;
            }

            // Mostrar rol con badge de color (ID ya se muestra arriba junto al nombre)
            if (userRoleAndIdEl) {
                // Extraer rol como string (puede venir como objeto o string)
                let roleKey = currentUser.role;
                if (typeof roleKey === 'object' && roleKey !== null) {
                    roleKey = roleKey.name || roleKey.role || roleKey.key || 'admin';
                }
                roleKey = String(roleKey).toLowerCase();

                const roleNames = {
                    'admin': 'Administrador',
                    'supervisor': 'Supervisor',
                    'leader': 'L√≠der de Equipo',
                    'vendor': 'Vendedor',
                    'soporte': 'Soporte',
                    'administrativo': 'Administrativo',
                    'marketing': 'Marketing',
                    'administrador': 'Administrador Master',
                    'super admin': 'Super Admin',
                    'super_admin': 'Super Admin'
                };
                const roleColors = {
                    'admin': '#e74c3c',
                    'supervisor': '#3498db',
                    'leader': '#9b59b6',
                    'vendor': '#2ecc71',
                    'soporte': '#f39c12',
                    'administrativo': '#34495e',
                    'marketing': '#e67e22',
                    'administrador': '#c0392b',
                    'super admin': '#8e44ad',
                    'super_admin': '#8e44ad'
                };
                const roleName = roleNames[roleKey] || roleKey;
                const roleColor = roleColors[roleKey] || '#7f8c8d';

                userRoleAndIdEl.innerHTML = `
                    <span style="display: inline-block; padding: 2px 8px; background: ${roleColor}; border-radius: 10px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                        ${roleName}
                    </span>
                `;
            }

            // Actualizar √≠cono seg√∫n rol
            if (userAvatarIconEl) {
                const roleIcons = {
                    'admin': 'üëë',
                    'supervisor': 'üë®‚Äçüíº',
                    'leader': 'üë®‚Äçüè´',
                    'vendor': 'üíº',
                    'soporte': 'üõ†Ô∏è',
                    'administrativo': 'üìã',
                    'marketing': 'üì¢',
                    'administrador': 'üëë'
                };
                const icon = roleIcons[currentUser.role] || 'üë§';
                userAvatarIconEl.querySelector('span').textContent = icon;
            }

            // Actualizar subt√≠tulo del dashboard con nombre del usuario (formato: Apellido, Nombre)
            const dashboardSubtitle = document.getElementById('dashboardSubtitle');
            if (dashboardSubtitle) {
                const lastName = currentUser.lastName || '';
                const firstName = currentUser.firstName || '';
                const userIdShort = currentUser.id ? ` [${String(currentUser.id).substring(0, 6)}]` : '';
                const userName = lastName && firstName
                    ? `${lastName}, ${firstName}${userIdShort}`
                    : currentUser.fullName || `${firstName} ${lastName}${userIdShort}`;
                dashboardSubtitle.textContent = `üë§ ${userName}`;
            }

            console.log('‚úÖ [UI] Header actualizado con info del usuario');
        }

        // Funci√≥n de logout
        function handleLogout() {
            if (!confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
                return;
            }

            // Limpiar localStorage
            localStorage.removeItem('aponnt_token_staff');
            localStorage.removeItem('aponnt_token_partner');
            localStorage.removeItem('aponnt_refresh_token_staff');
            localStorage.removeItem('aponnt_refresh_token_partner');
            localStorage.removeItem('aponnt_user_staff');
            localStorage.removeItem('aponnt_user_partner');
            localStorage.removeItem('aponnt_user_type');
            localStorage.removeItem('aponnt_assigned_companies');
            localStorage.removeItem('aponnt_permissions');
            localStorage.removeItem('token');
            localStorage.removeItem('user');

            console.log('üëã [AUTH] Sesi√≥n cerrada');

            // Redirigir a index
            window.location.href = '/index.html';
        }

        async function verifyTokenWithServer(token) {
            try {
                const response = await fetch(`${API_BASE}/auth/verify`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    logout();
                }
                
            } catch (error) {
                console.error('Error verificando token:', error);
                // No desloguear autom√°ticamente por errores de red
            }
        }

        function setupUIForRole() {
            // Configurar t√≠tulo del panel administrativo
            const dashboardTitle = document.querySelector('.dashboard-title');
            if (dashboardTitle) {
                dashboardTitle.innerHTML = `
                    üè¢ Panel Administrativo APONNT
                    <div style="font-size: 0.6em; opacity: 0.8; margin-left: auto;">
                        Acceso Total - Sin Restricciones
                    </div>
                `;
            }

            // Si es administrador, agregar pesta√±a de gesti√≥n de usuarios
            if (currentUser.role === 'administrador') {
                addAdminTabs();
            }

            // Cargar datos del dashboard
            loadDashboardData();
            loadAllSystems();
        }

        function addAdminTabs() {
            const navTabs = document.querySelector('.nav-tabs');
            if (navTabs) {
                const adminTab = document.createElement('button');
                adminTab.className = 'nav-tab';
                adminTab.onclick = () => switchTab('users');
                adminTab.innerHTML = 'üë• Usuarios';
                navTabs.appendChild(adminTab);

                // Agregar contenido de la pesta√±a de usuarios
                const mainContent = document.querySelector('.main-content .section-card');
                if (mainContent) {
                    const usersTab = document.createElement('div');
                    usersTab.id = 'users';
                    usersTab.className = 'tab-content';
                    usersTab.innerHTML = `
                        <div class="section-header">
                            <h2 class="section-title">üë• Gesti√≥n de Usuarios</h2>
                            <button class="btn btn-success" onclick="openNewUserModal()">
                                ‚ûï Nuevo Operador
                            </button>
                        </div>
                        <div class="section-content">
                            <div id="usersContainer">
                                <!-- Lista de usuarios se carga aqu√≠ -->
                            </div>
                        </div>
                    `;
                    mainContent.appendChild(usersTab);
                }
            }
        }

        async function loadOperators() {
            if (currentUser.role !== 'administrador') return;

            try {
                console.log('üë• [LOAD-OPERATORS] Cargando usuarios multi-tenant');
                const response = await fetch(`${API_BASE}/admin/operators`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('üë• [LOAD-OPERATORS] Datos recibidos:', data);

                    // Usar la nueva estructura unificada
                    const allUsers = data.users || [];
                    const usersByCompany = data.usersByCompany || {};

                    console.log(`üë• [LOAD-OPERATORS] Total usuarios: ${allUsers.length}`);
                    console.log('üë• [LOAD-OPERATORS] Usuarios por empresa:', Object.keys(usersByCompany).map(companyId => ({
                        companyId,
                        count: usersByCompany[companyId].length
                    })));

                    // Renderizar todos los usuarios con informaci√≥n de empresa
                    renderOperators(allUsers, usersByCompany);
                } else {
                    console.error('Error cargando operadores:', response.statusText);
                    renderOperators([], {});
                }

            } catch (error) {
                console.error('Error cargando operadores:', error);
                renderOperators([], {});
            }
        }

        function renderOperators(operators, usersByCompany = {}) {
            const container = document.getElementById('usersContainer');
            if (!container) return;

            if (operators.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #7f8c8d;">
                        <div style="font-size: 3em; margin-bottom: 1rem;">üë•</div>
                        <h3>No hay usuarios registrados</h3>
                        <p>Crea tu primer usuario</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="margin-bottom: 1rem;">
                    <h4>üë• Usuarios Multi-Tenant (${operators.length} total)</h4>
                    <p style="color: #666; font-size: 0.9rem;">
                        Usuarios distribuidos en ${Object.keys(usersByCompany).length} empresas activas
                    </p>
                </div>
                <table class="companies-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Nombre Completo</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Empresa</th>
                            <th>Departamento</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Agrupar por empresa para mejor visualizaci√≥n
            Object.keys(usersByCompany).forEach(companyId => {
                const companyUsers = usersByCompany[companyId];
                if (companyUsers.length === 0) return;

                // Encabezado de empresa
                html += `
                    <tr style="background: #f8f9fa; font-weight: bold;">
                        <td colspan="8" style="padding: 0.75rem; border-top: 2px solid #dee2e6;">
                            üè¢ ${companyUsers[0].companyName || `Empresa ${companyId}`} (${companyUsers.length} usuarios)
                        </td>
                    </tr>
                `;

                // Usuarios de la empresa
                companyUsers.forEach(user => {
                    const roleColor = {
                        'admin': '#dc3545',
                        'super_admin': '#6f42c1',
                        'manager': '#fd7e14',
                        'supervisor': '#198754',
                        'employee': '#0d6efd',
                        'vendor': '#20c997'
                    }[user.role] || '#6c757d';

                    html += `
                        <tr>
                            <td><strong>${user.usuario}</strong><br><small style="color: #666;">${user.employeeId}</small></td>
                            <td>${user.fullName}</td>
                            <td>${user.email || '-'}</td>
                            <td>
                                <span style="background: ${roleColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">
                                    ${user.role}
                                </span>
                            </td>
                            <td style="font-size: 0.9rem; color: #666;">${user.companyName}</td>
                            <td style="font-size: 0.9rem; color: #666;">${user.departmentName || 'Sin asignar'}</td>
                            <td>
                                <span class="status-badge ${user.isActive ? 'status-active' : 'status-suspended'}">
                                    ${user.isActive ? 'Activo' : 'Inactivo'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-primary" onclick="editUser(${user.user_id})" style="margin-right: 5px; font-size: 0.8rem;">
                                    ‚úèÔ∏è Editar
                                </button>
                                ${user.role !== 'super_admin' ?
                                    `<button class="btn btn-danger" onclick="deleteUser(${user.user_id}, '${user.usuario}')" style="background: #dc3545; font-size: 0.8rem;">üóëÔ∏è</button>`
                                    :
                                    '<span style="color: #95a5a6; font-size: 0.8rem;">üîí</span>'
                                }
                            </td>
                        </tr>
                    `;
                });
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Funci√≥n logout eliminada - Panel administrativo sin autenticaci√≥n

        // Configuraci√≥n de m√≥dulos y precios
        const pricingConfig = {
            taxRate: 0.21,
            employeeTiers: [
                { min: 1, max: 50, multiplier: 1.0, name: "1-50 empleados", discount: "Sin descuento" },
                { min: 51, max: 100, multiplier: 0.85, name: "51-100 empleados", discount: "15% descuento" },
                { min: 101, max: 999999, multiplier: 0.70, name: "101+ empleados", discount: "30% descuento" }
            ],
            modules: {
                // Los m√≥dulos se cargar√°n din√°micamente desde la API
                // Configuraci√≥n de respaldo en caso de fallo de API:
                'users': { name: 'Usuarios', icon: 'üë•', color: '#4CAF50', basePrice: 2.50, description: 'Gesti√≥n de empleados y perfiles de usuario' },
                'departments': { name: 'Departamentos', icon: 'üè¢', color: '#2196F3', basePrice: 5.00, description: 'Configuraci√≥n y gesti√≥n de departamentos y ubicaciones' },
                'shifts': { name: 'Turnos', icon: 'üïê', color: '#FF9800', basePrice: 8.00, description: 'Gesti√≥n de horarios y jornadas laborales' },
                'attendance': { name: 'Asistencia', icon: 'üìã', color: '#9C27B0', basePrice: 30.00, description: 'Control de ingresos, salidas y asistencia' },
                'facial-biometric': { name: 'Biometr√≠a', icon: 'üé≠', color: '#E91E63', basePrice: 25.00, description: 'Reconocimiento facial para autenticaci√≥n' },
                'medical-dashboard': { name: 'M√©dico', icon: 'üë©‚Äç‚öïÔ∏è', color: '#00BCD4', basePrice: 20.00, description: 'Gesti√≥n de informaci√≥n m√©dica de empleados' },
                'art-management': { name: 'ART', icon: 'üè•', color: '#F44336', basePrice: 18.00, description: 'Administraci√≥n de Aseguradoras de Riesgos del Trabajo' },
                'document-management': { name: 'Documentos', icon: 'üìÑ', color: '#795548', basePrice: 10.00, description: 'Administraci√≥n de documentos y archivos' },
                'legal-dashboard': { name: 'Legal', icon: '‚öñÔ∏è', color: '#3F51B5', basePrice: 15.00, description: 'Gesti√≥n de aspectos legales y normativos' },
                'payroll-liquidation': { name: 'Liquidaci√≥n', icon: 'üí∞', color: '#4CAF50', basePrice: 22.00, description: 'C√°lculo y gesti√≥n de n√≥minas y liquidaciones' },
                'employee-map': { name: 'Mapa Empleados', icon: 'üó∫Ô∏è', color: '#8BC34A', basePrice: 12.00, description: 'Ubicaci√≥n y seguimiento en tiempo real' },
                'training-management': { name: 'Capacitaciones', icon: 'üìö', color: '#FF5722', basePrice: 14.00, description: 'Administraci√≥n de cursos y entrenamientos' },
                'notifications': { name: 'Notificaciones', icon: 'üì±', color: '#FF6B6B', basePrice: 7.00, description: 'Sistema de notificaciones y comunicaciones internas' },
                'job-postings': { name: 'Postulaciones', icon: 'üíº', color: '#6f42c1', basePrice: 9.00, description: 'Gesti√≥n de ofertas de trabajo y candidatos' },
                'settings': { name: 'Configuraci√≥n', icon: '‚öôÔ∏è', color: '#9E9E9E', basePrice: 3.00, description: 'Ajustes generales y configuraciones del sistema' },
                'biometric': { name: 'Biometr√≠a', icon: 'üé≠', color: '#E91E63', basePrice: 20.00, description: 'Reconocimiento biom√©trico avanzado' },
                'reports': { name: 'Reportes', icon: 'üìä', color: '#FF9800', basePrice: 15.00, description: 'Informes y estad√≠sticas avanzadas' },
                'psychological-assessment': { name: 'Evaluaci√≥n Psicol√≥gica', icon: 'üß†', color: '#9b59b6', basePrice: 2500.00, description: 'Sistema de evaluaci√≥n psicol√≥gica integral con detecci√≥n de estr√©s y violencia' },
                'sanctions-management': { name: 'Gesti√≥n de Sanciones', icon: '‚öñÔ∏è', color: '#e74c3c', basePrice: 1800.00, description: 'Sistema completo de gesti√≥n disciplinaria y sanciones' },
                'vacation-management': { name: 'Gesti√≥n de Vacaciones', icon: 'üèñÔ∏è', color: '#27ae60', basePrice: 2200.00, description: 'Sistema integral de gesti√≥n de vacaciones y licencias con programaci√≥n autom√°tica' }
            }
        };

        let companies = [];
        let selectedModules = new Set();
        let invoices = [];
        let paymentMethods = [];
        let notifications = [];
        let currentTab = 'companies';
        let currentEditingCompany = null;

        // ‚úÖ BACKEND AUTO-VERIFICATION v2.3.0 - Railway Compatible
        async function checkBackendStatus() {
            // Detectar si estamos en producci√≥n
            const isProduction = !window.location.port ||
                                window.location.hostname.includes('railway.app') ||
                                window.location.hostname.includes('herokuapp.com') ||
                                window.location.hostname.includes('vercel.app');

            let BACKEND_URL;

            if (isProduction) {
                // üöÇ PRODUCCI√ìN: Usar URL base sin puerto
                BACKEND_URL = `${window.location.protocol}//${window.location.hostname}`;
                console.log('üöÇ [BACKEND-CHECK] Verificando backend en producci√≥n:', BACKEND_URL);
            } else {
                // üíª LOCAL: Usar localhost con puerto
                const BACKEND_PORT = window.DYNAMIC_CONFIG?.port || 9999;
                BACKEND_URL = `http://localhost:${BACKEND_PORT}`;
                console.log('üíª [BACKEND-CHECK] Verificando backend local en puerto:', BACKEND_PORT);
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/v1/health`, {
                    method: 'GET',
                    timeout: 3000
                });

                if (response.ok) {
                    console.log('‚úÖ [BACKEND-CHECK] Backend ejecut√°ndose correctamente');
                    return true;
                } else {
                    throw new Error(`Backend responde con error: ${response.status}`);
                }
            } catch (error) {
                console.warn('‚ùå [BACKEND-CHECK] Backend no disponible:', error.message);
                if (!isProduction) {
                    // Solo mostrar warning en desarrollo local
                    showBackendWarning();
                }
                return false;
            }
        }

        function showBackendWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.id = 'backend-warning';
            warningDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 99999;
                color: white;
                font-family: Arial, sans-serif;
            `;

            warningDiv.innerHTML = `
                <div style="background: #1a1a1a; padding: 30px; border-radius: 10px; text-align: center; max-width: 500px;">
                    <h2 style="color: #ff6b6b; margin-bottom: 20px;">‚ö†Ô∏è Backend No Detectado</h2>
                    <p style="margin-bottom: 15px;">El sistema necesita el backend ejecut√°ndose en puerto <strong>9999</strong></p>
                    <div style="background: #2d2d2d; padding: 15px; border-radius: 5px; margin: 20px 0;">
                        <h3 style="color: #4ecdc4; margin-bottom: 10px;">üöÄ Para iniciar el backend:</h3>
                        <p style="font-family: monospace; background: #000; padding: 10px; border-radius: 3px;">
                            Haz doble clic en: <strong>INICIO_AUTOMATICO.bat</strong>
                        </p>
                        <p style="margin-top: 10px; font-size: 14px; color: #aaa;">
                            O abre terminal y ejecuta: <code>cd backend && PORT=9999 npm start</code>
                        </p>
                    </div>
                    <button onclick="window.location.reload()" style="
                        background: #4ecdc4;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        color: white;
                        cursor: pointer;
                        margin-right: 10px;
                    ">üîÑ Verificar Nuevamente</button>
                    <button onclick="document.getElementById('backend-warning').style.display='none'" style="
                        background: #666;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        color: white;
                        cursor: pointer;
                    ">‚ö†Ô∏è Continuar sin Backend</button>
                </div>
            `;

            document.body.appendChild(warningDiv);
        }

        // Inicializar cuando la p√°gina carga
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîÑ [AUTH] DOMContentLoaded iniciando...');

            // ‚úÖ VERIFICAR AUTENTICACI√ìN APONNT
            const urlParams = new URLSearchParams(window.location.search);
            const userType = urlParams.get('userType');
            const forceLogin = urlParams.get('forceLogin');

            console.log('üîç [AUTH] URL userType:', userType);
            console.log('üîç [AUTH] URL forceLogin:', forceLogin);

            // LIMPIAR localStorage si viene desde index (nuevo login) o si forceLogin=true
            if (userType || forceLogin === 'true') {
                console.log('üßπ [AUTH] Limpiando tokens antiguos para forzar nuevo login');
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('aponnt_token_staff');
                localStorage.removeItem('aponnt_token_partner');
                localStorage.removeItem('aponnt_user_staff');
                localStorage.removeItem('aponnt_user_partner');
                localStorage.removeItem('aponnt_user_type');
                localStorage.removeItem('aponnt_assigned_companies');
                localStorage.removeItem('aponnt_permissions');
                localStorage.removeItem('aponnt_refresh_token_staff');
                localStorage.removeItem('aponnt_refresh_token_partner');
                sessionStorage.clear();
            }

            // Verificar si hay token v√°lido
            const token = localStorage.getItem('token') || localStorage.getItem('aponnt_token_staff') || localStorage.getItem('aponnt_token_partner');
            const user = localStorage.getItem('user') || localStorage.getItem('aponnt_user_staff') || localStorage.getItem('aponnt_user_partner');

            console.log('üîç [AUTH] Token encontrado:', !!token);
            console.log('üîç [AUTH] Usuario encontrado:', !!user);

            // Si NO hay token ‚Üí Mostrar login correspondiente
            if (!token) {
                console.log('üîê [AUTH] Sin token - mostrando login');

                if (typeof AponntLogin === 'undefined') {
                    console.error('‚ùå [AUTH] ERROR CR√çTICO: AponntLogin no est√° definido');
                    alert('ERROR: Sistema de login no disponible. Verifica la consola.');
                    return;
                }

                // CASO 1: Si viene con userType=partner ‚Üí Login de Partner
                if (userType === 'partner') {
                    console.log('üîê [AUTH] CASO 1: Login de Partner');
                    const aponntLogin = new AponntLogin('partner');
                    aponntLogin.showLoginModal();
                    return;
                }

                // CASO 2: Sin userType o userType=staff ‚Üí Login de Staff de Aponnt
                console.log('üîê [AUTH] CASO 2: Login de Staff de Aponnt');
                const aponntLogin = new AponntLogin('staff');
                aponntLogin.showLoginModal();
                return;
            }

            // Cargar datos del usuario desde localStorage
            try {
                const parsedUser = JSON.parse(user);
                currentUser = {
                    id: parsedUser.id,
                    username: parsedUser.username || parsedUser.email,
                    firstName: parsedUser.first_name || parsedUser.firstName,
                    lastName: parsedUser.last_name || parsedUser.lastName,
                    fullName: `${parsedUser.first_name || parsedUser.firstName} ${parsedUser.last_name || parsedUser.lastName}`,
                    email: parsedUser.email,
                    role: parsedUser.role,
                    dni: parsedUser.dni,
                    userType: localStorage.getItem('aponnt_user_type') || 'staff'
                };
                console.log('‚úÖ [AUTH] CASO 3: Usuario autenticado:', currentUser);

                // Actualizar header con datos del usuario
                loadUserInfoToHeader();
            } catch (error) {
                console.error('‚ùå [AUTH] Error parseando datos de usuario:', error);
                window.location.href = '/index.html';
                return;
            }

            // ‚úÖ NUEVO v2.2.0: Verificar backend antes de cargar datos
            const backendActive = await checkBackendStatus();

            if (!backendActive) {
                console.warn('‚ö†Ô∏è [ADMIN] Backend no disponible - continuando con funcionalidad limitada');
            }

            // Configurar interfaz
            setupUIForRole();

            // Cargar m√≥dulos desde API y luego cargar datos del dashboard (solo si backend est√° activo)
            if (backendActive) {
                loadModulesFromAPI().then(() => {
                    loadDashboardData();
                    generateModulesGrid();
                }).catch(error => {
                    console.error('‚ùå [ADMIN] Error cargando m√≥dulos con backend activo:', error);
                    // Fallback: mostrar m√≥dulos b√°sicos sin backend
                    generateModulesGrid();
                });
            } else {
                // Sin backend: mostrar m√≥dulos b√°sicos
                console.log('‚ö†Ô∏è [ADMIN] Generando grid b√°sico sin backend');
                generateModulesGrid();
            }

            loadAllSystems();
            loadVendors(); // Cargar vendedores

            // ‚úÖ NUEVO: Cargar m√≥dulos de Vendor Invoicing y Partner Scoring
            loadVendorInvoicingModule();
            loadPartnerScoringModule();

            // ‚úÖ Inicializar navegaci√≥n de tabs
            initTabsNavigation();
        });

        async function loadAllSystems() {
            await loadPricingFromDatabase(); // Cargar precios actualizados y esperar
            loadBillingSystem();
            loadPaymentSystem();
            loadNotificationSystem();
            generatePricingControls(); // Ahora se ejecuta DESPU√âS de cargar los precios
        }

        // ==================== NAVEGACI√ìN DE TABS ====================

        function scrollTabs(direction) {
            const navTabs = document.getElementById('mainNavTabs');
            const scrollAmount = 300; // P√≠xeles a desplazar

            if (direction === 'left') {
                navTabs.scrollLeft -= scrollAmount;
            } else {
                navTabs.scrollLeft += scrollAmount;
            }

            // Actualizar botones despu√©s del scroll
            setTimeout(updateScrollButtons, 100);
        }

        function updateScrollButtons() {
            const navTabs = document.getElementById('mainNavTabs');
            const leftButton = document.getElementById('tabScrollLeft');
            const rightButton = document.getElementById('tabScrollRight');

            if (!navTabs || !leftButton || !rightButton) return;

            // Deshabilitar bot√≥n izquierdo si est√° al inicio
            leftButton.disabled = navTabs.scrollLeft <= 0;

            // Deshabilitar bot√≥n derecho si est√° al final
            const maxScroll = navTabs.scrollWidth - navTabs.clientWidth;
            rightButton.disabled = navTabs.scrollLeft >= maxScroll - 5; // -5 para margen de error
        }

        // Inicializar navegaci√≥n de tabs al cargar la p√°gina
        function initTabsNavigation() {
            const navTabs = document.getElementById('mainNavTabs');
            if (!navTabs) return;

            // Actualizar botones al hacer scroll
            navTabs.addEventListener('scroll', updateScrollButtons);

            // Actualizar botones inicialmente
            updateScrollButtons();

            // Actualizar botones al redimensionar ventana
            window.addEventListener('resize', updateScrollButtons);
        }

        function switchTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            currentTab = tabName;

            // Cargar contenido espec√≠fico si es necesario
            if (tabName === 'taxTemplates') loadTaxTemplatesSystem();
            if (tabName === 'pricing') loadPricingSystem();
            if (tabName === 'billing') loadBillingSystem();
            if (tabName === 'payments') loadPaymentSystem();
            if (tabName === 'notifications') loadNotificationSystem();
            if (tabName === 'users') loadOperators();
            if (tabName === 'staff') loadStaff();
            if (tabName === 'staffRoles') loadStaffRoles();
        }

        async function loadDashboardData() {
            if (demoMode) {
                // Usar datos de demo para testing
                companies = data.companies || [];
                updateStats();
                renderCompaniesTable();
            } else {
                // Cargar datos reales de la API
                await loadCompaniesFromAPI();
            }
        }

        async function loadCompaniesFromAPI() {
            try {
                console.log('üîÑ Cargando empresas desde:', `${API_BASE}/api/aponnt/dashboard/companies`);
                const response = await fetch(`${API_BASE}/api/aponnt/dashboard/companies`);

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Datos recibidos completos:', data);
                    console.log('üîç data.companies:', data.companies);

                    // Los datos ya vienen procesados desde el backend, usar directamente
                    companies = data.companies || [];

                    console.log(`üìä Empresas transformadas: ${companies.length}`);
                    console.log('üè¢ Empresas array transformado:', companies);

                    // Verificar antes de renderizar
                    console.log('üìù Sobre a llamar renderCompaniesTable con companies.length =', companies.length);
                    updateStats();
                    renderCompaniesTable();
                    console.log('‚úÖ renderCompaniesTable completado');

                    // Cargar m√≥dulos reales para todas las empresas
                    await loadRealModulesForAllCompanies();
                    console.log('‚úÖ M√≥dulos reales cargados en la grilla');
                } else {
                    console.error('‚ùå Error HTTP:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('‚ùå Respuesta del servidor:', errorText);
                    // Fallback a datos demo si hay error
                    if (fallbackToDemo) {
                        companies = [];
                        updateStats();
                        renderCompaniesTable();
                        showNotification('‚ö†Ô∏è Error cargando empresas del servidor', 'warning');
                    } else {
                        showNotification('‚ùå Error de conexi√≥n con la base de datos', 'error');
                    }
                }
            } catch (error) {
                console.error('Error conectando con la API:', error.message, error);
                // Fallback a datos demo si hay error
                if (fallbackToDemo) {
                    companies = [];
                    updateStats();
                    renderCompaniesTable();
                    showNotification('‚ö†Ô∏è Error de conexi√≥n - sin datos disponibles', 'warning');
                } else {
                    showNotification('‚ùå Error de conexi√≥n con la base de datos', 'error');
                }
            }
        }

        function updateStats() {
            const activeCount = companies.filter(c => c.status === 'active').length;
            const trialCount = companies.filter(c => c.status === 'trial').length;
            const suspendedCount = companies.filter(c => c.status === 'suspended').length;

            const totalCompaniesElement = document.getElementById('totalCompanies');
            const activeCompaniesElement = document.getElementById('activeCompanies');
            const trialCompaniesElement = document.getElementById('trialCompanies');
            const suspendedCompaniesElement = document.getElementById('suspendedCompanies');

            if (totalCompaniesElement) totalCompaniesElement.textContent = companies.length;
            if (activeCompaniesElement) activeCompaniesElement.textContent = activeCount;
            if (trialCompaniesElement) trialCompaniesElement.textContent = trialCount;
            if (suspendedCompaniesElement) suspendedCompaniesElement.textContent = suspendedCount;
        }

                        function renderCompaniesTable() {
            console.log('üé® [RENDER] renderCompaniesTable iniciado');
            console.log('üè¢ companies:', companies.length);
            console.log('üëÅÔ∏è Vista actual:', window.currentCompanyView);

            const container = document.getElementById('companiesContainer');
            if (!container) {
                console.error('‚ùå No se encontr√≥ companiesContainer');
                return;
            }

            // Usar el sistema de toggle entre vistas
            if (typeof renderCompaniesWithCurrentView === 'function') {
                renderCompaniesWithCurrentView();
            } else {
                console.warn('‚ö†Ô∏è renderCompaniesWithCurrentView no disponible, usando fallback');
                // Fallback simple
                if (companies.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #7f8c8d;">
                            <div style="font-size: 3em; margin-bottom: 1rem;">üè¢</div>
                            <h3>No hay empresas registradas</h3>
                        </div>
                    `;
                } else if (typeof EnterpriseCompaniesGrid !== 'undefined') {
                    EnterpriseCompaniesGrid.render(companies, container);
                } else {
                    container.innerHTML = '<p>Cargando...</p>';
                }
            }
        }



        // =============================
        // Funci√≥n para cargar m√≥dulos reales desde la BD (TEMPORALMENTE DESHABILITADA)
        async function loadRealModulesForAllCompanies() {
            console.log("üì¶ Funci√≥n de carga de m√≥dulos deshabilitada temporalmente");
            // TODO: Implementar endpoint /api/aponnt/dashboard/companies/:id/modules si es necesario
            return;

            /* CODIGO COMENTADO TEMPORALMENTE PARA EVITAR ERROR 500
            console.log("üì¶ Cargando m√≥dulos reales para todas las empresas...");
            if (!companies || companies.length === 0) {
                console.warn("‚ö†Ô∏è No hay empresas para cargar m√≥dulos");
                return;
            }

            // Cargar los datos reales de m√≥dulos para cada empresa
            for (const company of companies) {
                try {
                    // Validar que company_id existe
                    if (!company.company_id && !company.id) {
                        console.warn(`‚ö†Ô∏è Empresa ${company.name} no tiene company_id v√°lido`);
                        continue;
                    }

                    const companyId = company.company_id || company.id;
                    const response = await fetch(`${API_BASE}/api/aponnt/dashboard/companies/${companyId}/modules`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            console.log(`üìä Datos de m√≥dulos para ${company.name}:`, data);

                            // Actualizar la empresa con los datos reales de m√≥dulos
                            company.modulesSummary = data.summary || {
                                contractedModules: 0,
                                totalSystemModules: 0,
                                activeModules: 0,
                                monthlyTotal: 0
                            };
                            company.pricing = company.pricing || {};

                            // Usar el total con impuestos si est√° disponible, sino calcular
                            const subtotal = data.summary?.monthlyTotal || 0;
                            const totalWithTax = data.summary?.monthlyTotalWithTax || (subtotal * (1 + pricingConfig.taxRate));

                            company.pricing.monthlyTotal = totalWithTax;

                            console.log(`üí∞ Empresa ${company.name}: Subtotal: $${subtotal}, Total con IVA: $${totalWithTax}`);
                        }
                    }
                } catch (error) {
                    console.error(`‚ùå Error cargando m√≥dulos empresa ${company.company_id}:`, error);
                    // Establecer valores por defecto en caso de error
                    company.modulesSummary = { contractedModules: 0, totalSystemModules: 0, activeModules: 0, monthlyTotal: 0 };
                    company.pricing = company.pricing || { monthlyTotal: 0 };
                }
            }

            console.log("‚úÖ Todos los m√≥dulos cargados, re-renderizando tabla...");
            // Volver a renderizar la tabla con los datos actualizados
            renderCompaniesTable();
            */ // FIN DEL CODIGO COMENTADO
        }
        // SISTEMA DE FILTROS AVANZADOS
        // =============================

        let filteredCompanies = []; // Empresas filtradas
        let debounceTimer = null;

        // Mostrar/ocultar panel de filtros
        function toggleFilters() {
            const content = document.getElementById('filtersContent');
            const toggle = document.getElementById('filtersToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'grid';
                toggle.textContent = 'Ocultar Filtros';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'Mostrar Filtros';
            }
        }

        // Aplicar filtros con debounce para texto
        function applyFiltersDebounced() {
            if (debounceTimer) clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                applyFilters();
            }, 300);
        }

        // Aplicar todos los filtros
        function applyFilters() {
            const filters = {
                name: document.getElementById('filterName').value.toLowerCase().trim(),
                cuit: document.getElementById('filterCuit').value.toLowerCase().trim(),
                country: document.getElementById('filterCountry').value,
                province: document.getElementById('filterProvince').value,
                city: document.getElementById('filterCity').value,
                vendor: document.getElementById('filterVendor').value.toLowerCase().trim()
            };

            // Filtrar empresas
            filteredCompanies = companies.filter(company => {
                // Filtro por nombre/raz√≥n social (aproximaci√≥n)
                if (filters.name && !company.name.toLowerCase().includes(filters.name) && 
                    !company.legalName?.toLowerCase().includes(filters.name)) {
                    return false;
                }

                // Filtro por CUIT (aproximaci√≥n)
                if (filters.cuit && !company.taxId?.toLowerCase().includes(filters.cuit)) {
                    return false;
                }

                // Filtro por pa√≠s
                if (filters.country && company.country !== filters.country) {
                    return false;
                }

                // Filtro por provincia
                if (filters.province && company.province !== filters.province) {
                    return false;
                }

                // Filtro por ciudad
                if (filters.city && company.city !== filters.city) {
                    return false;
                }

                // Filtro por vendedor
                if (filters.vendor && !company.vendor?.toLowerCase().includes(filters.vendor)) {
                    return false;
                }

                return true;
            });

            // Renderizar tabla con empresas filtradas
            renderFilteredTable();
            updateResultsInfo();
        }

        // Renderizar tabla con empresas filtradas
        function renderFilteredTable() {
            const container = document.getElementById('companiesContainer');
            const companiesToShow = filteredCompanies.length > 0 || hasActiveFilters() ? filteredCompanies : companies;
            
            if (companiesToShow.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #7f8c8d;">
                        <div style="font-size: 3em; margin-bottom: 1rem;">üîç</div>
                        <h3>No se encontraron empresas</h3>
                        <p>Prueba ajustando los filtros de b√∫squeda</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="companies-table">
                    <thead>
                        <tr>
                            <th>Empresa</th>
                            <th>CUIT</th>
                            <th>Ubicaci√≥n</th>
                            <th>Estado</th>
                            <th>Empleados</th>
                            <th>Plan</th>
                            <th>M√≥dulos</th>
                            <th>Total Mensual</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            companiesToShow.forEach(company => {
                html += `
                    <tr>
                        <td>
                            <div><strong>${company.name}</strong></div>
                            <div style="font-size: 0.9em; color: #666;">${company.legalName || 'N/A'}</div>
                            <div style="font-size: 0.8em; color: #999;">${company.contactEmail || company.email || 'N/A'}</div>
                        </td>
                        <td><span style="font-family: monospace;">${company.taxId || 'N/A'}</span></td>
                        <td>
                            <div style="font-size: 0.9em;">
                                <div><strong>${company.city || 'N/A'}</strong></div>
                                <div style="color: #666;">${company.state || 'N/A'}</div>
                                <div style="color: #999; font-size: 0.8em;">${company.country || 'N/A'}</div>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-${company.status}">
                                ${company.status === 'active' ? 'Activa' : company.status === 'trial' ? 'Prueba' : 'Suspendida'}
                            </span>
                        </td>
                        <td>
                            <div style="font-weight: bold; color: #2e7d32;">${company.currentEmployees || 0}</div>
                            <div style="font-size: 0.8em; color: #666;">empleados activos</div>
                        </td>
                        <td>
                            <div style="font-weight: bold; color: #1976d2;">
                                ${company.licenseType || 'B√°sico'} (${company.maxEmployees || 50})
                            </div>
                            <div style="font-size: 0.8em; color: #666;">
                                Plan de hasta ${company.maxEmployees || 50} empleados
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: bold; color: #2e7d32;">
                                ${company.modulesSummary ? `${company.modulesSummary.contractedModules}/${company.modulesSummary.totalSystemModules}` : 'N/A'}
                            </div>
                            <div style="font-size: 0.8em; color: #666;">
                                M√≥dulos contratados
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: bold; color: var(--primary-color);">
                                U$S ${company.pricing?.monthlyTotal ? Math.floor(company.pricing.monthlyTotal).toLocaleString('en-US') : '0'}<span style="font-size: 0.7em;">.${company.pricing?.monthlyTotal ? (company.pricing.monthlyTotal % 1).toFixed(2).substring(2) : '00'}</span>
                            </div>
                            <div style="font-size: 0.8em; color: #666;">
                                Total mensual con IVA
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-primary" onclick="editCompany(${company.company_id})" style="margin-right: 5px;">
                                ‚úèÔ∏è Editar
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Verificar si hay filtros activos
        function hasActiveFilters() {
            const filters = {
                name: document.getElementById('filterName').value.trim(),
                cuit: document.getElementById('filterCuit').value.trim(),
                country: document.getElementById('filterCountry').value,
                province: document.getElementById('filterProvince').value,
                city: document.getElementById('filterCity').value
            };

            return Object.values(filters).some(value => value !== '');
        }

        // Actualizar informaci√≥n de resultados
        function updateResultsInfo() {
            const info = document.getElementById('resultsInfo');
            const hasFilters = hasActiveFilters();
            
            if (hasFilters) {
                const total = companies.length;
                const filtered = filteredCompanies.length;
                info.textContent = `Mostrando ${filtered} de ${total} empresas`;
                info.style.display = 'block';
            } else {
                info.style.display = 'none';
            }
        }

        // Limpiar todos los filtros
        function clearFilters() {
            const filterNameElement = document.getElementById('filterName');
            const filterCuitElement = document.getElementById('filterCuit');
            const filterCountryElement = document.getElementById('filterCountry');
            const filterProvinceElement = document.getElementById('filterProvince');
            const filterCityElement = document.getElementById('filterCity');
            const filterVendorElement = document.getElementById('filterVendor');

            if (filterNameElement) filterNameElement.value = '';
            if (filterCuitElement) filterCuitElement.value = '';
            if (filterCountryElement) filterCountryElement.value = '';
            if (filterProvinceElement) filterProvinceElement.value = '';
            if (filterCityElement) filterCityElement.value = '';
            if (filterVendorElement) filterVendorElement.value = '';
            
            // Limpiar dropdowns dependientes
            if (filterProvinceElement) {
                filterProvinceElement.innerHTML = '<option value="">Todas las provincias</option>';
            }
            if (filterCityElement) {
                filterCityElement.innerHTML = '<option value="">Todas las ciudades</option>';
            }
            
            // Resetear empresas filtradas
            filteredCompanies = [];
            
            // Renderizar tabla completa
            renderCompaniesTable();
            updateResultsInfo();
        }

        // Cargar provincias para filtro
        function loadFilterProvinces() {
            const countrySelect = document.getElementById('filterCountry');
            const provinceSelect = document.getElementById('filterProvince');
            const citySelect = document.getElementById('filterCity');
            
            const selectedCountry = countrySelect.value;
            
            // Limpiar selects dependientes
            provinceSelect.innerHTML = '<option value="">Todas las provincias</option>';
            citySelect.innerHTML = '<option value="">Todas las ciudades</option>';
            
            if (selectedCountry && geographicalData[selectedCountry]) {
                Object.keys(geographicalData[selectedCountry]).forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    provinceSelect.appendChild(option);
                });
            }
        }

        // Cargar ciudades para filtro
        function loadFilterCities() {
            const countrySelect = document.getElementById('filterCountry');
            const provinceSelect = document.getElementById('filterProvince');
            const citySelect = document.getElementById('filterCity');
            
            const selectedCountry = countrySelect.value;
            const selectedProvince = provinceSelect.value;
            
            // Limpiar select de ciudades
            citySelect.innerHTML = '<option value="">Todas las ciudades</option>';
            
            if (selectedCountry && selectedProvince && 
                geographicalData[selectedCountry] && 
                geographicalData[selectedCountry][selectedProvince]) {
                
                Object.keys(geographicalData[selectedCountry][selectedProvince]).forEach(cityName => {
                    const option = document.createElement('option');
                    option.value = cityName;
                    option.textContent = cityName;
                    citySelect.appendChild(option);
                });
            }
        }

        // Modificar renderCompaniesTable original para usar el nuevo sistema
        const originalRenderCompaniesTable = renderCompaniesTable;
        renderCompaniesTable = function() {
            if (hasActiveFilters()) {
                applyFilters();
            } else {
                originalRenderCompaniesTable();
                updateResultsInfo();
            }
        };

        function openNewCompanyModal() {
            console.log("openNewCompanyModal ejecutado");
            document.getElementById('modalTitle').textContent = 'Nueva Empresa';
            document.getElementById('saveBtnText').textContent = 'üíæ Crear Empresa';
            document.getElementById('companyForm').reset();
            document.getElementById('maxEmployees').value = '1';
            selectedModules.clear();
            currentEditingCompany = null;
            
            // Resetear filtro a "todos" para nueva empresa
            currentModuleFilter = 'all';
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filterAll').classList.add('active');
            
            // Ocultar secciones espec√≠ficas de edici√≥n
            document.getElementById('priceUpdateSection').style.display = 'none';
            document.getElementById('moduleModificationSection').style.display = 'none';
            
            // Inicializar campos geogr√°ficos
            loadProvinces();

            // Limpiar coordenadas para nueva empresa
            document.getElementById('companyLatitude').value = '';
            document.getElementById('companyLongitude').value = '';

            // Limpiar campos de vendedor (display y hidden)
            document.getElementById('vendorDisplay').value = '';
            document.getElementById('vendorDisplay').placeholder = 'No asignado';
            document.getElementById('vendor').value = '';

            generateModulesGrid();
            updatePricingSummary();
            document.getElementById('companyModal').classList.add('show');
        }

        async function editCompany(companyId) {
            const company = companies.find(c => c.id === companyId || c.company_id === companyId);
            if (!company) {
                console.error('‚ùå Empresa no encontrada con ID:', companyId);
                console.log('üìã Empresas disponibles:', companies.map(c => ({id: c.id, company_id: c.company_id, name: c.name})));
                return;
            }

            console.log(`üìù EDITANDO EMPRESA ${companyId}:`, company);
            console.log('üìù Datos disponibles en company object:', Object.keys(company));

            const modalTitle = document.getElementById('modalTitle');
            const saveBtnText = document.getElementById('saveBtnText');

            if (modalTitle) modalTitle.textContent = 'Editar Empresa';
            if (saveBtnText) saveBtnText.textContent = '‚úèÔ∏è Actualizar Empresa';
            document.getElementById('companyName').value = company.name || '';

            // Manejar tanto camelCase como snake_case para compatibilidad
            document.getElementById('legalName').value = company.legalName || company.legal_name || '';
            document.getElementById('taxId').value = company.taxId || company.tax_id || '';
            document.getElementById('contactEmail').value = company.contactEmail || company.contact_email || company.email || '';
            document.getElementById('contactPhone').value = company.contactPhone || company.contact_phone || company.phone || '';
            document.getElementById('address').value = company.address || '';
            document.getElementById('country').value = company.country || 'Argentina';
            
            // Cargar provincias y luego seleccionar la provincia de la empresa
            loadProvinces();
            setTimeout(() => {
                document.getElementById('province').value = company.province || '';
                if (company.province) {
                    loadCities();
                    setTimeout(() => {
                        document.getElementById('city').value = company.city || '';
                        document.getElementById('postalCode').value = company.postalCode || company.postal_code || '';
                    }, 100);
                }
            }, 100);

            // Manejar tanto camelCase como snake_case para todos los campos
            document.getElementById('licenseType').value = company.licenseType || company.license_type || 'basic';
            document.getElementById('contractedEmployees').value = company.contractedEmployees || company.contracted_employees || company.maxEmployees || company.max_employees || 1;
            document.getElementById('maxEmployees').value = company.maxEmployees || company.max_employees || 50;

            // Cargar vendedor asignado con sus datos completos
            await loadAssignedVendorInfo(company.vendor);

            document.getElementById('commissionPercentage').value = company.commissionPercentage || company.commission_percentage || '10';
            document.getElementById('supportCommissionPercentage').value = company.supportCommissionPercentage || company.support_commission_percentage || '0';

            // Cargar comisiones en USD (si existen)
            document.getElementById('salesCommissionUSD').value = company.salesCommissionUSD || company.sales_commission_usd ? `$${(company.salesCommissionUSD || company.sales_commission_usd).toFixed(2)}` : '$0.00';
            document.getElementById('supportCommissionUSD').value = company.supportCommissionUSD || company.support_commission_usd ? `$${(company.supportCommissionUSD || company.support_commission_usd).toFixed(2)}` : '$0.00';

            document.getElementById('companyStatus').value = company.status || 'cotizado';

            // Cargar coordenadas solo si existen en la empresa
            const latElement = document.getElementById('companyLatitude');
            const lngElement = document.getElementById('companyLongitude');

            if (latElement) latElement.value = company.latitude || '';
            if (lngElement) lngElement.value = company.longitude || '';

            // Verificar si hay coordenadas disponibles y mostrar mensaje
            if (company.latitude && company.longitude) {
                console.log(`üìç Coordenadas cargadas para empresa: ${company.latitude}, ${company.longitude}`);
            } else {
                console.log('üìç No hay coordenadas disponibles para esta empresa');
            }

            currentEditingCompany = company;

            // üî• CARGAR M√ìDULOS DESDE COMPANY_MODULES (DATOS REALES)
            console.log(`üì¶ Cargando m√≥dulos reales para empresa ${companyId} desde company_modules...`);

            // Inicializar con fallback
            selectedModules = new Set(company.modules || []);

            // Cargar m√≥dulos reales desde company_modules
            fetch(`/api/aponnt/dashboard/companies/${companyId}/modules`)
                .then(response => response.json())
                .then(moduleData => {
                    if (moduleData.success) {
                        console.log(`‚úÖ M√≥dulos cargados desde company_modules:`, moduleData);

                        // Actualizar selectedModules con m√≥dulos ACTIVOS desde la base de datos
                        const activeModuleKeys = moduleData.modules.active.map(m => m.moduleKey);
                        selectedModules = new Set(activeModuleKeys);

                        console.log(`‚úÖ M√≥dulos activos cargados en selectedModules:`, Array.from(selectedModules));

                        // Guardar informaci√≥n de precios contratados en la empresa
                        company.contractedModulesFromDB = moduleData.modules.all;
                        company.activeModulesFromDB = moduleData.modules.active;
                        company.inactiveModulesFromDB = moduleData.modules.inactive;
                        company.modulesSummaryFromDB = moduleData.summary;

                        console.log(`üìä Empresa ${companyId}: ${activeModuleKeys.length} m√≥dulos activos en company_modules`);
                        console.log(`üí∞ Total mensual desde DB: $${moduleData.summary.monthlyTotal}`);

                        // Actualizar secci√≥n de modificaci√≥n con datos reales
                        const moduleModificationSection = document.getElementById('moduleModificationSection');
                        if (moduleModificationSection && moduleData.summary.totalModules > 0) {
                            moduleModificationSection.style.display = 'block';
                            moduleModificationSection.innerHTML = `
                                <h4>‚ö†Ô∏è Modificaci√≥n de M√≥dulos Contratados</h4>
                                <p><strong>Esta empresa tiene ${moduleData.summary.totalModules} m√≥dulos contratados:</strong></p>
                                <p>‚Ä¢ ${moduleData.summary.activeModules} m√≥dulos ACTIVOS</p>
                                <p>‚Ä¢ ${moduleData.summary.inactiveModules} m√≥dulos INACTIVOS</p>
                                <p>‚Ä¢ Total mensual: <strong>$${moduleData.summary.monthlyTotal.toFixed(2)}</strong></p>
                                <p>Los m√≥dulos contratados aparecen marcados. Para modificarlos, active la casilla:</p>
                                <label>
                                    <input type="checkbox" id="allowModificationCheckbox" onchange="toggleModuleModification()">
                                    Permitir modificaci√≥n de m√≥dulos contratados
                                </label>
                            `;
                        } else if (moduleModificationSection) {
                            moduleModificationSection.style.display = 'none';
                        }

                        // Regenerar grid con datos actualizados
                        generateModulesGrid();
                        updatePricingSummaryWithRealData(moduleData);

                        // Forzar actualizaci√≥n visual para asegurar estados correctos
                        setTimeout(() => {
                            console.log('üîÑ Forzando actualizaci√≥n visual de m√≥dulos...');
                            generateModulesGrid();
                            updatePricingSummary();
                            // Actualizar tambi√©n el detalle con precios hist√≥ricos
                            updatePricingSummaryForCurrentSelection();
                            // Asegurar que los checkboxes est√©n sincronizados
                            setTimeout(() => {
                                syncModuleCheckboxes();
                            }, 50);
                        }, 200);

                    } else {
                        console.warn('‚ö†Ô∏è Error cargando m√≥dulos desde company_modules:', moduleData.error);
                        // Mantener fallback: usar m√≥dulos del objeto company
                        const moduleModificationSection = document.getElementById('moduleModificationSection');
                        if (moduleModificationSection) {
                            if (company.modules && company.modules.length > 0) {
                                moduleModificationSection.style.display = 'block';
                            } else {
                                moduleModificationSection.style.display = 'none';
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error cargando m√≥dulos desde company_modules:', error);
                    // Mantener fallback: usar m√≥dulos del objeto company
                    const moduleModificationSection = document.getElementById('moduleModificationSection');
                    if (company.modules && company.modules.length > 0) {
                        moduleModificationSection.style.display = 'block';
                    } else {
                        moduleModificationSection.style.display = 'none';
                    }
                });

            // Resetear filtro al editar empresa
            currentModuleFilter = 'all';
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filterAll').classList.add('active');
            
            // Verificar si hay cambios en los precios desde la contrataci√≥n
            checkForPriceChanges(company);
            
            // Mostrar modal primero
            document.getElementById('companyModal').classList.add('show');

            // Cargar sucursales de la empresa despu√©s de mostrar el modal
            setTimeout(() => {
                loadCompanyBranches(company.company_id);
            }, 500);
            
            // Cargar usuarios de la empresa autom√°ticamente
            loadCompanyUsers();

            generateModulesGrid();
            updatePricingSummary();
            // Cuando se edita, usar precios hist√≥ricos espec√≠ficos de la empresa
            updatePricingSummaryForCurrentSelection();
        }

        function closeCompanyModal() {
            console.log('üö™ Cerrando modal...');
            document.getElementById('companyModal').classList.remove('show');

            // Limpiar estado
            currentEditingCompany = null;
            selectedModules.clear();

            // Reset form
            document.getElementById('companyForm').reset();

            // Limpiar grids
            const modulesGrid = document.getElementById('modulesGrid');
            if (modulesGrid) modulesGrid.innerHTML = '';

            const pricingSidebar = document.querySelector('.pricing-sidebar');
            if (pricingSidebar) pricingSidebar.innerHTML = '<h3>üí∞ Cotizaci√≥n</h3>';

            console.log('‚úÖ Modal cerrado y estado limpiado');
        }

        let currentModuleFilter = 'all';
        
        function generateModulesGrid() {
            const employeeCount = parseInt(document.getElementById('contractedEmployees').value) || 1;
            const tier = getCurrentTier(employeeCount);
            const grid = document.getElementById('modulesGrid');
            
            let html = '';
            // Usar m√≥dulos reales desde company_modules si est√°n disponibles
            const contractedModules = currentEditingCompany && currentEditingCompany.activeModulesFromDB
                ? new Set(currentEditingCompany.activeModulesFromDB.map(m => m.moduleKey))
                : (currentEditingCompany ? new Set(currentEditingCompany.modules) : new Set());
            
            console.log('üì¶ M√≥dulos contratados desde BD:', Array.from(contractedModules));
            console.log('üìã M√≥dulos seleccionados actuales:', Array.from(selectedModules));

            Object.entries(pricingConfig.modules).forEach(([moduleId, module]) => {
                const price = calculateModulePrice(module.basePrice, tier);
                const isSelected = selectedModules.has(moduleId);
                const wasContracted = contractedModules.has(moduleId);
                const isNewSelection = isSelected && !wasContracted;
                const isRemoving = !isSelected && wasContracted;

                if (isSelected) {
                    console.log(`üîç M√≥dulo ${moduleId}: selected=${isSelected}, wasContracted=${wasContracted}, isNew=${isNewSelection}`);
                }
                
                // Aplicar filtro
                let shouldShow = true;
                if (currentModuleFilter === 'contracted' && !wasContracted) shouldShow = false;
                if (currentModuleFilter === 'available' && wasContracted) shouldShow = false;
                
                if (!shouldShow) return;
                
                let cardClass = 'module-card';
                let statusIndicator = '';
                let clickHandler = `toggleModule('${moduleId}')`;
                
                if (wasContracted && isSelected) {
                    cardClass += ' contracted selected';
                    statusIndicator = '<span class="status-badge contracted">‚úì Contratado</span>';
                } else if (wasContracted && !isSelected) {
                    cardClass += ' contracted removing';
                    statusIndicator = '<span class="status-badge removing">‚ö† Se eliminar√°</span>';
                } else if (isNewSelection) {
                    cardClass += ' selected new';
                    statusIndicator = '<span class="status-badge new">+ Nuevo</span>';
                } else if (isSelected) {
                    cardClass += ' selected';
                } else {
                    cardClass += ' available';
                    statusIndicator = '<span class="status-badge available">Disponible</span>';
                }
                
                // Los m√≥dulos contratados siempre permiten interacci√≥n
                // Solo agregar clase visual para identificarlos como contratados
                if (wasContracted) {
                    cardClass += ' contracted-module';
                }
                
                html += `
                    <div class="${cardClass}" ${clickHandler ? `onclick="${clickHandler}"` : ''} data-module="${moduleId}">
                        <div class="module-header">
                            <div class="module-info">
                                <span class="module-icon"><i class="fas fa-${module.icon || 'cube'}"></i></span>
                                <span class="module-name">${module.name}</span>
                            </div>
                            <div class="module-price">U$S ${price.toFixed(2)}</div>
                        </div>
                        <div class="module-description">${module.description}</div>
                        <div class="module-details">Precio por empleado/mes</div>
                        <div class="module-status">${statusIndicator}</div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div class="no-modules">No hay m√≥dulos para mostrar con el filtro actual</div>';
            }
            
            grid.innerHTML = html;
            
            // Actualizar informaci√≥n del tier
            const currentTierElement = document.getElementById('currentTier');
            const currentDiscountElement = document.getElementById('currentDiscount');

            if (currentTierElement) {
                currentTierElement.textContent = tier.name;
            }
            if (currentDiscountElement) {
                currentDiscountElement.textContent = tier.discount;
            }
            
            // Actualizar contadores de filtros
            updateFilterCounters();
        }
        
        function filterModules(filter) {
            currentModuleFilter = filter;
            
            // Actualizar botones activos
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`).classList.add('active');
            
            generateModulesGrid();
        }
        
        function updateFilterCounters() {
            if (!currentEditingCompany) return;
            
            const contractedCount = currentEditingCompany.activeModulesFromDB
                ? currentEditingCompany.activeModulesFromDB.length
                : (currentEditingCompany.modules ? currentEditingCompany.modules.length : 0);
            const totalCount = Object.keys(pricingConfig.modules).length;
            const availableCount = totalCount - contractedCount;
            
            const filterAllElement = document.getElementById('filterAll');
            const filterContractedElement = document.getElementById('filterContracted');
            const filterAvailableElement = document.getElementById('filterAvailable');

            if (filterAllElement) filterAllElement.textContent = `Todos (${totalCount})`;
            if (filterContractedElement) filterContractedElement.textContent = `Contratados (${contractedCount})`;
            if (filterAvailableElement) filterAvailableElement.textContent = `Disponibles (${availableCount})`;
        }

        function toggleModule(moduleId) {
            console.log('üîÑ toggleModule ejecutado para:', moduleId);

            // Permitir modificar todos los m√≥dulos - los contratados se identifican visualmente

            if (selectedModules.has(moduleId)) {
                selectedModules.delete(moduleId);
                console.log('‚ûñ M√≥dulo deseleccionado:', moduleId);
            } else {
                selectedModules.add(moduleId);
                console.log('‚ûï M√≥dulo seleccionado:', moduleId);
            }

            console.log('üìä M√≥dulos seleccionados actuales:', Array.from(selectedModules));

            generateModulesGrid();
            updatePricingSummary();

            // Actualizar resumen con m√≥dulos seleccionados actuales
            updatePricingSummaryForCurrentSelection();

            console.log('‚úÖ toggleModule completado');
        }

        // Sincronizar checkboxes de m√≥dulos con los datos reales cargados desde la BD
        function syncModuleCheckboxes() {
            console.log('üîÑ Sincronizando checkboxes de m√≥dulos...');

            // Obtener los m√≥dulos contratados reales desde company_modules
            const contractedModules = currentEditingCompany && currentEditingCompany.activeModulesFromDB
                ? new Set(currentEditingCompany.activeModulesFromDB.map(m => m.moduleKey))
                : new Set();

            // Sincronizar cada m√≥dulo
            Object.keys(pricingConfig.modules).forEach(moduleId => {
                const checkbox = document.querySelector(`input[onclick*="${moduleId}"]`);
                const moduleCard = document.querySelector(`.module-card[onclick*="${moduleId}"]`);

                if (checkbox) {
                    const isSelected = selectedModules.has(moduleId);
                    const wasContracted = contractedModules.has(moduleId);

                    // Marcar checkbox seg√∫n selectedModules
                    checkbox.checked = isSelected;

                    // Actualizar clases visuales del card
                    if (moduleCard) {
                        moduleCard.classList.remove('selected', 'contracted', 'new', 'available', 'removing');

                        if (wasContracted && isSelected) {
                            moduleCard.classList.add('contracted', 'selected');
                        } else if (wasContracted && !isSelected) {
                            moduleCard.classList.add('contracted', 'removing');
                        } else if (isSelected && !wasContracted) {
                            moduleCard.classList.add('selected', 'new');
                        } else if (isSelected) {
                            moduleCard.classList.add('selected');
                        } else {
                            moduleCard.classList.add('available');
                        }
                    }

                    console.log(`‚úÖ Sincronizado ${moduleId}: checkbox=${checkbox.checked}, selected=${isSelected}, contracted=${wasContracted}`);
                }
            });

            console.log('‚úÖ Sincronizaci√≥n de checkboxes completada');
        }

        function updateModulePricing() {
            generateModulesGrid();
            updatePricingSummary();

            // Actualizar resumen con m√≥dulos seleccionados actuales
            updatePricingSummaryForCurrentSelection();
        }

        function getCurrentTier(employeeCount) {
            return pricingConfig.employeeTiers.find(tier => 
                employeeCount >= tier.min && employeeCount <= tier.max
            ) || pricingConfig.employeeTiers[0];
        }

        function calculateModulePrice(basePrice, tier) {
            return basePrice * tier.multiplier;
        }

        function updatePricingSummary() {
            console.log('üßÆ updatePricingSummary ejecut√°ndose...');
            const employeeCount = parseInt(document.getElementById('contractedEmployees').value) || 1;
            const tier = getCurrentTier(employeeCount);
            console.log('üë• Empleados:', employeeCount, 'Tier:', tier);

            let subtotal = 0;
            let selectedModulesList = '';

            selectedModules.forEach(moduleId => {
                let price, module;

                // Si estamos editando una empresa y tiene precios hist√≥ricos, usarlos
                if (currentEditingCompany && currentEditingCompany.modulesPricing && currentEditingCompany.modulesPricing[moduleId]) {
                    const historicalModule = currentEditingCompany.modulesPricing[moduleId];
                    price = historicalModule.tierPrice || historicalModule.basePrice;
                    module = {
                        name: historicalModule.name,
                        icon: historicalModule.icon
                    };
                    console.log(`üí∞ Usando precio hist√≥rico para ${moduleId}: $${price}`);
                } else {
                    // Usar precios actuales del sistema
                    module = pricingConfig.modules[moduleId];
                    price = calculateModulePrice(module.basePrice, tier);
                    console.log(`üí∞ Usando precio actual para ${moduleId}: $${price}`);
                }

                const totalPrice = price * employeeCount;
                subtotal += totalPrice;

                selectedModulesList += `
                    <div class="selected-module">
                        <span><i class="fas fa-${module.icon || 'cube'}"></i> ${module.name}</span>
                        <span>$ ${totalPrice.toFixed(2)}</span>
                    </div>
                `;
            });
            
            const tax = subtotal * pricingConfig.taxRate;
            const total = subtotal + tax;

            console.log('üí∞ Valores calculados - Subtotal:', subtotal, 'Tax:', tax, 'Total:', total);

            const subtotalElement = document.getElementById('subtotal');
            const taxElement = document.getElementById('tax');
            const totalElement = document.getElementById('total');
            const moduleCountElement = document.getElementById('moduleCount');
            const selectedModulesListElement = document.getElementById('selectedModulesList');

            if (subtotalElement) subtotalElement.textContent = subtotal.toFixed(2);
            if (taxElement) taxElement.textContent = tax.toFixed(2);
            if (totalElement) totalElement.textContent = total.toFixed(2);
            if (moduleCountElement) moduleCountElement.textContent = selectedModules.size;
            if (selectedModulesListElement) selectedModulesListElement.innerHTML = selectedModulesList;

            // üí∞ CALCULAR COMISIONES EN USD AUTOM√ÅTICAMENTE
            const commissionPercentage = parseFloat(document.getElementById('commissionPercentage').value) || 10;
            const supportCommissionPercentage = parseFloat(document.getElementById('supportCommissionPercentage').value) || 0;

            const salesCommissionUSD = (total * commissionPercentage) / 100;
            const supportCommissionUSD = (total * supportCommissionPercentage) / 100;

            const salesCommissionUSDElement = document.getElementById('salesCommissionUSD');
            const supportCommissionUSDElement = document.getElementById('supportCommissionUSD');

            if (salesCommissionUSDElement) {
                salesCommissionUSDElement.value = `$${salesCommissionUSD.toFixed(2)}`;
            }
            if (supportCommissionUSDElement) {
                supportCommissionUSDElement.value = `$${supportCommissionUSD.toFixed(2)}`;
            }

            console.log('üí∞ Comisiones calculadas - Venta:', salesCommissionUSD, 'Soporte:', supportCommissionUSD);

            // Habilitar bot√≥n guardar siempre
            const saveBtn = document.getElementById('saveCompanyBtn');
            if (saveBtn) {
                saveBtn.disabled = false;
            }
        }

        async function saveCompany() {
            console.log("saveCompany ejecutado");
            const employeeCount = parseInt(document.getElementById('contractedEmployees').value) || 1;
            const tier = getCurrentTier(employeeCount);
            
            // Permitir guardar sin m√≥dulos (solo cambios b√°sicos de empresa)
            
            
            // üåç VALIDACI√ìN OBLIGATORIA DE GEOLOCALIZACI√ìN PARA APK ANDROID
            console.log('üåç Validando geolocalizaci√≥n obligatoria...');

            const address = document.getElementById('address').value?.trim();
            const city = document.getElementById('city').value?.trim();
            const province = document.getElementById('province').value?.trim();
            const latitude = document.getElementById('companyLatitude').value?.trim();
            const longitude = document.getElementById('companyLongitude').value?.trim();

            // Validar campos de direcci√≥n obligatorios
            const missingAddressFields = [];
            if (!address) missingAddressFields.push('Direcci√≥n');
            if (!city) missingAddressFields.push('Ciudad');
            if (!province) missingAddressFields.push('Provincia');

            if (missingAddressFields.length > 0) {
                const message = `‚ùå CAMPOS OBLIGATORIOS FALTANTES:\n\n${missingAddressFields.join(', ')}\n\nEstos campos son necesarios para la geolocalizaci√≥n de la APK Android.`;
                alert(message);

                // Enfocar el primer campo faltante
                const firstMissing = missingAddressFields[0];
                if (firstMissing === 'Direcci√≥n') document.getElementById('address').focus();
                else if (firstMissing === 'Ciudad') document.getElementById('city').focus();
                else if (firstMissing === 'Provincia') document.getElementById('province').focus();

                return;
            }

            // Validar que se haya obtenido geolocalizaci√≥n
            if (!latitude || !longitude || latitude === '' || longitude === '') {
                const confirmMessage = `‚ö†Ô∏è GEOLOCALIZACI√ìN REQUERIDA\n\nNo se han obtenido las coordenadas GPS para esta empresa.\n\nEsto es OBLIGATORIO para que funcione el fichado en la APK Android.\n\n¬øDesea obtener las coordenadas autom√°ticamente ahora?`;

                if (confirm(confirmMessage)) {
                    console.log('üåç Usuario eligi√≥ obtener coordenadas...');
                    await geocodeCompanyAddress();

                    // Verificar si se obtuvieron despu√©s del intento
                    setTimeout(() => {
                        const newLat = document.getElementById('companyLatitude').value?.trim();
                        const newLng = document.getElementById('companyLongitude').value?.trim();

                        if (!newLat || !newLng) {
                            alert('‚ùå NO SE PUDIERON OBTENER COORDENADAS\n\nVerifique que la direcci√≥n sea correcta y completa.\nEjemplo: "Av. Corrientes 1000, Buenos Aires, CABA"');
                            return;
                        } else {
                            console.log('‚úÖ Coordenadas obtenidas, continuando guardado...');
                            // Continuar con el guardado autom√°ticamente
                            setTimeout(() => saveCompany(), 1000);
                        }
                    }, 3000);
                    return; // Detener ejecuci√≥n hasta obtener coordenadas
                } else {
                    alert('‚ùå GUARDADO CANCELADO\n\nDebe obtener las coordenadas GPS para continuar.');
                    return;
                }
            }

            console.log('‚úÖ Validaci√≥n de geolocalizaci√≥n pasada');

        const companyName = document.getElementById('companyName').value;
            const legalName = document.getElementById('legalName').value || companyName;
            const taxId = document.getElementById('taxId').value;
            const contactEmail = document.getElementById('contactEmail').value;
            
            if (!companyName || !taxId || !contactEmail) {
                alert('Por favor complete todos los campos obligatorios.');
                return;
            }
            
            // Calcular precios (con validaci√≥n)
            const subtotalElement = document.getElementById('subtotal');
            const taxElement = document.getElementById('tax');
            const totalElement = document.getElementById('total');

            const subtotal = subtotalElement ? parseFloat(subtotalElement.textContent) || 0 : 0;
            const tax = taxElement ? parseFloat(taxElement.textContent) || 0 : 0;
            let total = totalElement ? parseFloat(totalElement.textContent) || 0 : 0;
            
            // Crear estructura de m√≥dulos con precios hist√≥ricos espec√≠ficos
            const modulesPricing = {};
            selectedModules.forEach(moduleId => {
                const module = pricingConfig.modules[moduleId];
                const price = calculateModulePrice(module.basePrice, tier);
                modulesPricing[moduleId] = {
                    name: module.name,
                    icon: module.icon,
                    basePrice: module.basePrice,
                    tierPrice: price,
                    totalPrice: price * employeeCount,
                    contractedAt: new Date().toISOString()
                };
            });

            const companyData = {
                name: companyName,
                legalName: legalName,
                taxId: taxId,
                contactEmail: contactEmail,
                contactPhone: document.getElementById('contactPhone').value || '',
                address: document.getElementById('address').value || '',
                country: document.getElementById('country').value || 'Argentina',
                province: document.getElementById('province').value || '',
                city: document.getElementById('city').value || '',
                postalCode: document.getElementById('postalCode').value || '',
                latitude: parseFloat(document.getElementById('companyLatitude').value) || null,
                longitude: parseFloat(document.getElementById('companyLongitude').value) || null,
                licenseType: document.getElementById('licenseType').value,
                status: document.getElementById('companyStatus').value,
                vendor: document.getElementById('vendor').value || '',
                commissionPercentage: parseFloat(document.getElementById('commissionPercentage').value) || 10,
                supportCommissionPercentage: parseFloat(document.getElementById('supportCommissionPercentage').value) || 0,
                salesCommissionUSD: parseFloat(document.getElementById('salesCommissionUSD').value.replace('$', '').replace(',', '')) || 0,
                supportCommissionUSD: parseFloat(document.getElementById('supportCommissionUSD').value.replace('$', '').replace(',', '')) || 0,
                contractedEmployees: employeeCount,
                maxEmployees: parseInt(document.getElementById('maxEmployees').value) || 50,
                modules: Array.from(selectedModules),
                modulesPricing: modulesPricing, // Precios hist√≥ricos espec√≠ficos
                pricing: {
                    tier: tier.name,
                    monthlySubtotal: subtotal,
                    monthlyTax: tax,
                    monthlyTotal: total,
                    lastUpdated: new Date().toISOString()
                }
            };

            console.log('üíæ DATOS A GUARDAR:', companyData);
            
            if (currentEditingCompany) {
                // Verificar si se debe actualizar precios
                let updatePrices = document.getElementById('updatePricesCheckbox')?.checked || false;
                
                if (updatePrices) {
                    // Actualizar con precios actuales (se regenera modulesPricing)
                    Object.assign(currentEditingCompany, companyData);
                } else {
                    // Mantener precios hist√≥ricos, solo actualizar otros datos
                    const { modulesPricing, pricing, ...otherData } = companyData;
                    Object.assign(currentEditingCompany, otherData);
                    
                    // Recalcular solo si cambiaron empleados, manteniendo precios hist√≥ricos
                    if (currentEditingCompany.maxEmployees !== employeeCount) {
                        let newSubtotal = 0;

                        // Validar que modulesPricing existe antes de usarlo
                        if (currentEditingCompany.modulesPricing) {
                            Object.values(currentEditingCompany.modulesPricing).forEach(module => {
                            const newTotalPrice = module.tierPrice * employeeCount;
                            module.totalPrice = newTotalPrice;
                            newSubtotal += newTotalPrice;
                            });
                        } else {
                            // Si no hay modulesPricing, usar precios actuales del sistema
                            console.warn('No hay modulesPricing hist√≥rico, usando precios actuales');
                            updatePrices = true; // Forzar actualizaci√≥n con precios actuales
                        }

                        const newTax = newSubtotal * pricingConfig.taxRate;
                        const newTotal = newSubtotal + newTax;
                        
                        currentEditingCompany.pricing = {
                            ...currentEditingCompany.pricing,
                            monthlySubtotal: newSubtotal,
                            monthlyTax: newTax,
                            monthlyTotal: newTotal,
                            lastUpdated: new Date().toISOString()
                        };
                        
                        // Usar el nuevo total para facturas
                        total = newTotal;
                    } else {
                        // Mantener el total actual
                        total = currentEditingCompany.pricing.monthlyTotal;
                    }
                }
                
                // Actualizar facturas existentes con el nuevo precio
                invoices.forEach(invoice => {
                    if (invoice.companyId === currentEditingCompany.id) {
                        invoice.amount = total;
                        invoice.companyName = companyName;
                    }
                });
                
                // Actualizar m√©todos de pago
                const paymentMethod = paymentMethods.find(m => m.companyId === currentEditingCompany.id);
                if (paymentMethod) {
                    paymentMethod.companyName = companyName;
                }
                
                const priceUpdateMsg = updatePrices ? 
                    '\n\n‚ö° Los precios se han actualizado a los valores actuales del sistema.' :
                    '\n\nüìã Se mantuvieron los precios hist√≥ricos de contrataci√≥n.';
                
                // Guardar cambios en la base de datos
                if (!demoMode) {
                    try {
                        console.log("Enviando PUT a API para empresa:", currentEditingCompany.id, companyData);
                        const response = await fetch(`${API_BASE}/api/aponnt/dashboard/companies/${currentEditingCompany.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                            },
                            body: JSON.stringify({
                                ...companyData,
                                selectedModules: Array.from(selectedModules),
                                employeeCount: employeeCount
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            showNotification(`‚úÖ Empresa "${companyName}" actualizada exitosamente en la base de datos`, 'success');
                            console.log("Empresa actualizada:", result);
                            closeCompanyModal();
                            // Actualizar solo la grilla sin recargar toda la p√°gina
                            loadCompaniesFromAPI();
                        } else {
                            const error = await response.json();
                            showNotification(`‚ùå Error actualizando empresa: ${error.error}`, 'error');
                            return;
                        }
                    } catch (error) {
                        console.error('Error actualizando empresa:', error);
                        showNotification('‚ùå Error de conexi√≥n al actualizar la empresa', 'error');
                        return;
                    }
                } else {
                    // Solo en modo demo mostrar alert
                    alert(`‚úÖ Empresa "${companyName}" actualizada exitosamente!\n\nüìä Resumen:\n‚Ä¢ Empleados: ${employeeCount}\n‚Ä¢ Tier: ${tier.name}\n‚Ä¢ M√≥dulos: ${selectedModules.size}\n‚Ä¢ Total mensual: U$S ${total.toFixed(2)} (con IVA incluido)${priceUpdateMsg}`);
                }
                
            } else {
                // Crear nueva empresa
                if (demoMode) {
                    // Modo demo - crear localmente
                    const newCompany = {
                        id: Date.now(),
                        status: 'active',
                        currentEmployees: 0,
                        createdAt: new Date().toISOString().split('T')[0],
                        ...companyData
                    };
                    
                    companies.push(newCompany);
                } else {
                    // Modo real - guardar en API
                        console.log("Enviando POST a API:", companyData);
                    try {
                        const response = await fetch(`${API_BASE}/api/aponnt/dashboard/companies`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                            },
                            body: JSON.stringify(companyData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            showNotification('‚úÖ Empresa creada exitosamente en la base de datos', 'success');
                            closeCompanyModal();
                            // Actualizar solo la grilla sin recargar toda la p√°gina
                            loadCompaniesFromAPI();
                        } else {
                            const error = await response.json();
                            showNotification(`‚ùå Error creando empresa: ${error.error}`, 'error');
                            return;
                        }
                    } catch (error) {
                        console.error('Error guardando empresa:', error);
                        showNotification('‚ùå Error de conexi√≥n al guardar la empresa', 'error');
                        return;
                    }
                }
                
                if (demoMode) {
                    alert(`‚úÖ Empresa "${companyName}" creada exitosamente!\n\nüìä Resumen:\n‚Ä¢ Empleados: ${employeeCount}\n‚Ä¢ Tier: ${tier.name}\n‚Ä¢ M√≥dulos: ${selectedModules.size}\n‚Ä¢ Total mensual: U$S ${total.toFixed(2)} (con IVA incluido)`);
                }
            }
            
            updateStats();
            renderCompaniesTable();
            
            // Recargar todos los sistemas si est√°n en otras pesta√±as
            if (currentTab === 'billing') renderBillingSystem();
            if (currentTab === 'payments') renderPaymentSystem();
            
            closeCompanyModal();
        }

        // Sistema de Facturaci√≥n
        function loadBillingSystem() {
            // Generar facturas de ejemplo
            invoices = companies.map(company => {
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + Math.floor(Math.random() * 60) - 30);
                const isOverdue = dueDate < new Date();
                
                return {
                    id: `INV-${company.company_id}-${new Date().getMonth() + 1}`,
                    companyId: company.company_id,
                    companyName: company.name,
                    amount: company.pricing.monthlyTotal,
                    dueDate: dueDate.toISOString().split('T')[0],
                    status: isOverdue ? 'overdue' : Math.random() > 0.3 ? 'pending' : 'paid',
                    createdAt: new Date().toISOString().split('T')[0],
                    qrCode: `QR-${company.company_id}-${Date.now()}`
                };
            });

            renderBillingSystem();
        }

        function renderBillingSystem() {
            const container = document.getElementById('billingContainer');
            const pendingInvoices = invoices.filter(inv => inv.status === 'pending');
            const overdueInvoices = invoices.filter(inv => inv.status === 'overdue');
            const totalRevenue = invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + inv.amount, 0);

            container.innerHTML = `
                <div class="billing-card">
                    <div class="billing-header">
                        <h3>üìä Resumen de Facturaci√≥n</h3>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; color: var(--success-color);">Ingresos: U$S ${totalRevenue.toFixed(2)}</div>
                            <div style="font-size: 0.9rem; color: #666;">Pendientes: ${pendingInvoices.length} | Vencidas: ${overdueInvoices.length}</div>
                        </div>
                    </div>
                    <div class="invoice-grid">
                        ${invoices.map(invoice => `
                            <div class="invoice-card ${invoice.status}">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <strong>${invoice.id}</strong>
                                    <span class="status-badge status-${invoice.status === 'paid' ? 'active' : invoice.status === 'overdue' ? 'suspended' : 'trial'}">
                                        ${invoice.status === 'paid' ? 'Pagada' : invoice.status === 'overdue' ? 'Vencida' : 'Pendiente'}
                                    </span>
                                </div>
                                <div style="margin-bottom: 0.5rem;">
                                    <strong>${invoice.companyName}</strong><br>
                                    <span style="color: #666;">Vence: ${invoice.dueDate}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 1.1rem; font-weight: bold; color: var(--primary-color);">U$S ${invoice.amount.toFixed(2)}</span>
                                    ${invoice.status === 'pending' ? `<button class="btn btn-primary" onclick="showQRPayment('${invoice.id}')">üí≥ Pagar</button>` : ''}
                                    ${invoice.status === 'overdue' ? `<button class="btn btn-danger" onclick="suspendCompany(${invoice.companyId})">‚ö†Ô∏è Suspender</button>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function generateMonthlyInvoices() {
            const newInvoices = companies.filter(c => c.status === 'active').map(company => {
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 30);
                
                return {
                    id: `INV-${company.company_id}-${new Date().getMonth() + 2}`,
                    companyId: company.company_id,
                    companyName: company.name,
                    amount: company.pricing.monthlyTotal,
                    dueDate: dueDate.toISOString().split('T')[0],
                    status: 'pending',
                    createdAt: new Date().toISOString().split('T')[0],
                    qrCode: `QR-${company.company_id}-${Date.now()}`
                };
            });
            
            invoices = [...invoices, ...newInvoices];
            renderBillingSystem();
            showNotification(`‚úÖ ${newInvoices.length} facturas generadas para el pr√≥ximo mes`, 'success');
        }

        function checkOverduePayments() {
            const overdueCount = invoices.filter(inv => inv.status === 'overdue').length;
            showNotification(`‚ö†Ô∏è ${overdueCount} facturas vencidas encontradas`, overdueCount > 0 ? 'warning' : 'info');
            
            if (overdueCount > 0) {
                switchTab('notifications');
                sendPaymentReminders();
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; margin-left: auto;">&times;</button>
            `;
            
            document.body.insertBefore(notification, document.body.firstChild);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Sistema de Pagos
        function loadPaymentSystem() {
            paymentMethods = companies.map(company => ({
                companyId: company.company_id,
                companyName: company.name,
                qrEnabled: Math.random() > 0.3,
                cardEnabled: Math.random() > 0.5,
                cardType: Math.random() > 0.5 ? 'credit' : 'debit',
                cardLast4: Math.floor(1000 + Math.random() * 9000),
                autopayEnabled: Math.random() > 0.4
            }));
            
            renderPaymentSystem();
        }

        function renderPaymentSystem() {
            const container = document.getElementById('paymentsContainer');
            
            container.innerHTML = `
                <div class="billing-card">
                    <div class="billing-header">
                        <h3>üí≥ M√©todos de Pago por Empresa</h3>
                    </div>
                    <div class="invoice-grid">
                        ${paymentMethods.map(method => `
                            <div class="invoice-card">
                                <h4>${method.companyName}</h4>
                                <div style="margin: 1rem 0;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span>üì± QR Pagos:</span>
                                        <span class="status-badge ${method.qrEnabled ? 'status-active' : 'status-suspended'}">
                                            ${method.qrEnabled ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span>üí≥ Tarjeta:</span>
                                        <span class="status-badge ${method.cardEnabled ? 'status-active' : 'status-suspended'}">
                                            ${method.cardEnabled ? `**** ${method.cardLast4}` : 'No config.'}
                                        </span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span>üîÑ D√©bito Auto:</span>
                                        <span class="status-badge ${method.autopayEnabled ? 'status-active' : 'status-trial'}">
                                            ${method.autopayEnabled ? 'Activo' : 'Manual'}
                                        </span>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="configurePayment(${method.companyId})">
                                    ‚öôÔ∏è Configurar
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function processAutomaticPayments() {
            const autopayInvoices = invoices.filter(inv => {
                const method = paymentMethods.find(m => m.companyId === inv.companyId);
                return inv.status === 'pending' && method?.autopayEnabled;
            });
            
            autopayInvoices.forEach(invoice => {
                invoice.status = 'paid';
            });
            
            renderBillingSystem();
            showNotification(`‚úÖ ${autopayInvoices.length} pagos autom√°ticos procesados`, 'success');
        }

        function showQRPayment(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            
            const qrContent = `
                <div class="qr-payment">
                    <h3>üí≥ Pago con QR - ${invoice.id}</h3>
                    <p><strong>${invoice.companyName}</strong></p>
                    <p>Monto: <strong>U$S ${invoice.amount.toFixed(2)}</strong></p>
                    <div class="qr-code">
                        QR Code\\n${invoice.qrCode}\\n[C√≥digo QR Aqu√≠]
                    </div>
                    <p style="margin-top: 1rem; color: #666;">Escanea el c√≥digo QR con tu app de pagos</p>
                    <button class="btn btn-success" onclick="markAsPaid('${invoice.id}')" style="margin-top: 1rem;">‚úÖ Marcar como Pagado</button>
                </div>
            `;
            
            showModal('Pago con QR', qrContent);
        }

        function markAsPaid(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                invoice.status = 'paid';
                renderBillingSystem();
                closeModal();
                showNotification(`‚úÖ Factura ${invoiceId} marcada como pagada`, 'success');
            }
        }

        function suspendCompany(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (company) {
                company.status = 'suspended';
                updateStats();
                renderCompaniesTable();
                showNotification(`‚ö†Ô∏è Empresa ${company.name} suspendida por falta de pago`, 'warning');
                
                // Agregar notificaci√≥n de suspensi√≥n
                notifications.unshift({
                    id: Date.now(),
                    type: 'suspension',
                    title: 'Servicio Suspendido',
                    message: `La empresa ${company.name} ha sido suspendida por falta de pago`,
                    date: new Date().toISOString(),
                    companyId: companyId
                });
            }
        }

        // Sistema de Notificaciones
        function loadNotificationSystem() {
            // Generar notificaciones de ejemplo
            if (notifications.length === 0) {
                notifications = [
                    {
                        id: 1,
                        type: 'payment_reminder',
                        title: 'Recordatorio de Pago',
                        message: 'Tech Solutions tiene una factura vencida',
                        date: new Date().toISOString(),
                        companyId: 1
                    },
                    {
                        id: 2,
                        type: 'pre_suspension',
                        title: 'Aviso Pre-Suspensi√≥n',
                        message: 'Constructora ABC ser√° suspendida en 3 d√≠as',
                        date: new Date().toISOString(),
                        companyId: 2
                    }
                ];
            }
            
            renderNotificationSystem();
        }

        function renderNotificationSystem() {
            const container = document.getElementById('notificationsContainer');
            
            container.innerHTML = `
                <div class="billing-card">
                    <div class="billing-header">
                        <h3>üìß Historial de Notificaciones</h3>
                        <div>Total: ${notifications.length}</div>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${notifications.map(notification => `
                            <div class="notification ${notification.type === 'suspension' ? 'error' : notification.type === 'pre_suspension' ? 'warning' : 'info'}">
                                <div style="flex: 1;">
                                    <strong>${notification.title}</strong><br>
                                    <span>${notification.message}</span><br>
                                    <small style="color: #666;">${new Date(notification.date).toLocaleString()}</small>
                                </div>
                                <button class="btn btn-primary" onclick="viewCompany(${notification.companyId})">
                                    üëÅÔ∏è Ver Empresa
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function sendPaymentReminders() {
            const overdueInvoices = invoices.filter(inv => inv.status === 'overdue');
            
            overdueInvoices.forEach(invoice => {
                const company = companies.find(c => c.id === invoice.companyId);
                if (company) {
                    notifications.unshift({
                        id: Date.now() + Math.random(),
                        type: 'payment_reminder',
                        title: 'Recordatorio de Pago Enviado',
                        message: `Recordatorio enviado a ${company.name} por factura ${invoice.id}`,
                        date: new Date().toISOString(),
                        companyId: company.company_id
                    });
                    
                    // Programar aviso de pre-suspensi√≥n en 3 d√≠as
                    setTimeout(() => {
                        notifications.unshift({
                            id: Date.now() + Math.random(),
                            type: 'pre_suspension',
                            title: 'Aviso Pre-Suspensi√≥n Programado',
                            message: `${company.name} ser√° suspendida en 3 d√≠as si no paga`,
                            date: new Date().toISOString(),
                            companyId: company.company_id
                        });
                    }, 3000); // 3 segundos para demo
                }
            });
            
            renderNotificationSystem();
            showNotification(`üìß ${overdueInvoices.length} recordatorios de pago enviados`, 'success');
        }

        function viewCompany(companyId) {
            switchTab('companies');
            editCompany(companyId);
        }

        // Sistema de Configuraci√≥n de Precios
        function loadPricingSystem() {
            generatePricingControls();
        }

        function generatePricingControls() {
            const container = document.getElementById('pricingContainer');
            
            console.log('üîÑ Generando controles de precios con datos actuales');
            
            container.innerHTML = `
                <div class="pricing-controls">
                    ${Object.entries(pricingConfig.modules).map(([moduleId, module]) => `
                        <div class="module-pricing">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <span style="font-size: 1.5rem;"><i class="fas fa-${module.icon || 'cube'}"></i></span>
                                <strong>${module.name}</strong>
                            </div>
                            <div class="tier-selector">
                                <button class="tier-btn active" onclick="selectTier('${moduleId}', 0)">1-50</button>
                                <button class="tier-btn" onclick="selectTier('${moduleId}', 1)">51-100</button>
                                <button class="tier-btn" onclick="selectTier('${moduleId}', 2)">101+</button>
                            </div>
                            <input type="number" class="price-input" id="price-${moduleId}-0" 
                                   value="${(module.tierPrices?.tier1 || module.basePrice).toFixed(2)}" step="0.01" min="0" 
                                   onchange="updateModulePrice('${moduleId}', 0, this.value)">
                            <input type="number" class="price-input" id="price-${moduleId}-1" 
                                   value="${(module.tierPrices?.tier2 || module.basePrice * 0.85).toFixed(2)}" step="0.01" min="0" style="display: none;"
                                   onchange="updateModulePrice('${moduleId}', 1, this.value)">
                            <input type="number" class="price-input" id="price-${moduleId}-2" 
                                   value="${(module.tierPrices?.tier3 || module.basePrice * 0.70).toFixed(2)}" step="0.01" min="0" style="display: none;"
                                   onchange="updateModulePrice('${moduleId}', 2, this.value)">
                            <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                                ${module.description}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function selectTier(moduleId, tierIndex) {
            // Actualizar botones activos
            document.querySelectorAll(`[onclick*="selectTier('${moduleId}',"]`).forEach((btn, index) => {
                btn.classList.toggle('active', index === tierIndex);
            });
            
            // Mostrar/ocultar inputs de precio
            for (let i = 0; i < 3; i++) {
                const input = document.getElementById(`price-${moduleId}-${i}`);
                input.style.display = i === tierIndex ? 'block' : 'none';
            }
        }

        function updateModulePrice(moduleId, tier, price) {
            console.log(`Actualizando ${moduleId} - Tier ${tier}: U$S ${price}`);
            
            // Asegurar que existe el objeto tierPrices
            if (!pricingConfig.modules[moduleId].tierPrices) {
                pricingConfig.modules[moduleId].tierPrices = {
                    tier1: pricingConfig.modules[moduleId].basePrice,
                    tier2: pricingConfig.modules[moduleId].basePrice * 0.85,
                    tier3: pricingConfig.modules[moduleId].basePrice * 0.70
                };
            }
            
            // Actualizar precio en memoria
            const tierName = `tier${tier + 1}`;
            pricingConfig.modules[moduleId].tierPrices[tierName] = parseFloat(price);
            
            // Tambi√©n actualizar basePrice si es tier1
            if (tier === 0) {
                pricingConfig.modules[moduleId].basePrice = parseFloat(price);
            }
            
            console.log(`‚úÖ Precio actualizado en memoria: ${moduleId}.${tierName} = ${price}`);
            showNotification(`Precio actualizado: ${pricingConfig.modules[moduleId].name} - Tier ${tier + 1}`, 'success');
        }

        function saveAllPricing() {
            // Guardar configuraci√≥n de precios en la base de datos
            const pricingData = {
                modules: {},
                lastUpdated: new Date().toISOString()
            };
            
            // Recopilar precios de todos los m√≥dulos (usar valores en memoria)
            Object.entries(pricingConfig.modules).forEach(([moduleId, module]) => {
                // Asegurar que existe tierPrices
                if (!module.tierPrices) {
                    module.tierPrices = {
                        tier1: module.basePrice,
                        tier2: module.basePrice * 0.85,
                        tier3: module.basePrice * 0.70
                    };
                }
                
                pricingData.modules[moduleId] = {
                    name: module.name,
                    icon: module.icon,
                    description: module.description,
                    basePrice: module.basePrice,
                    tierPrices: {
                        tier1: module.tierPrices.tier1 || module.basePrice,
                        tier2: module.tierPrices.tier2 || (module.basePrice * 0.85),
                        tier3: module.tierPrices.tier3 || (module.basePrice * 0.70)
                    }
                };
                
                // Sincronizar basePrice con tier1
                pricingConfig.modules[moduleId].basePrice = pricingData.modules[moduleId].tierPrices.tier1;
            });
            
            // Simular guardado en base de datos
            savePricingToDatabase(pricingData);
            showNotification('‚úÖ Configuraci√≥n de precios guardada exitosamente', 'success');
        }
        
        async function savePricingToDatabase(data) {
            try {
                console.log('üí∞ Guardando precios de m√≥dulos...', data);
                
                const response = await fetch(`${API_BASE}/pricing`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token') || ''}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Precios guardados exitosamente:', result);
                    showNotification('‚úÖ Precios de m√≥dulos actualizados correctamente', 'success');
                    
                    // Regenerar controles de precios para mostrar los nuevos valores
                    generatePricingControls();
                    
                    return result;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Error guardando precios:', error);
                console.log('üì¶ Guardando en localStorage como fallback');
                localStorage.setItem('modulesPricing', JSON.stringify(data));
                showNotification('‚ö†Ô∏è Precios guardados localmente (sin conexi√≥n a servidor)', 'warning');
            }
        }
        
        async function loadPricingFromDatabase() {
            try {
                console.log('üì• Cargando precios de m√≥dulos desde servidor...');

                const response = await fetch(`/api/aponnt/dashboard/pricing`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token') || ''}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Precios cargados desde servidor:', result);
                    if (result.success && result.modules) {
                        updatePricingConfig({ modules: result.modules });
                        return true;
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error cargando precios desde servidor:', error);
                console.log('üì¶ Intentando cargar desde localStorage...');
                
                const saved = localStorage.getItem('modulesPricing');
                if (saved) {
                    const data = JSON.parse(saved);
                    console.log('‚úÖ Precios cargados desde localStorage:', data);
                    updatePricingConfig(data);
                    return true;
                }
                
                console.log('‚ùå No hay precios guardados localmente, usando valores por defecto');
                return false;
            }
        }
        
        // Funci√≥n para cargar m√≥dulos desde la API
        async function loadModulesFromAPI() {
            try {
                console.log('üì¶ Cargando m√≥dulos desde la API...');
                const response = await fetch('/api/aponnt/dashboard/companies');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.modules) {
                    console.log(`‚úÖ ${Object.keys(data.modules).length} m√≥dulos cargados desde la API`);

                    // Limpiar m√≥dulos existentes
                    pricingConfig.modules = {};

                    // Convertir m√≥dulos de la API al formato del dashboard
                    Object.entries(data.modules).forEach(([moduleKey, module]) => {
                        pricingConfig.modules[moduleKey] = {
                            name: module.name,
                            icon: module.icon,
                            color: module.color,
                            basePrice: parseFloat(module.basePrice || module.tierPrices?.tier1 || 0),
                            description: module.description,
                            category: module.category || 'general',
                            is_core: module.is_core || false,
                            display_order: module.display_order || 0,
                            features: module.features || [],
                            requirements: module.requirements || []
                        };
                    });

                    console.log('üîÑ Configuraci√≥n de m√≥dulos actualizada desde la API');
                    return true;
                } else {
                    throw new Error('Respuesta inv√°lida de la API');
                }
            } catch (error) {
                console.error('‚ùå Error cargando m√≥dulos desde la API:', error);
                console.log('‚ö†Ô∏è Usando configuraci√≥n de m√≥dulos hardcodeada como respaldo');
                return false;
            }
        }

        // Funci√≥n para cargar m√≥dulos de una empresa espec√≠fica desde la API
        async function loadCompanyModulesFromAPI(companyId) {
            try {
                console.log(`üìä Cargando m√≥dulos para empresa ${companyId}...`);
                const response = await fetch(`/api/v1/dashboard/modules?company_id=${companyId}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.modules) {
                    console.log(`‚úÖ M√≥dulos de empresa ${companyId} cargados: ${data.modules.active.length} activos, ${data.modules.inactive.length} inactivos`);

                    // Retornar los m√≥dulos organizados por estado
                    return {
                        active: data.modules.active,
                        inactive: data.modules.inactive,
                        all: data.modules.all,
                        counts: data.counts
                    };
                } else {
                    throw new Error('Respuesta inv√°lida de la API');
                }
            } catch (error) {
                console.error('‚ùå Error cargando m√≥dulos de empresa desde la API:', error);
                return null;
            }
        }

        function updatePricingConfig(data) {
            Object.entries(data.modules).forEach(([moduleId, moduleData]) => {
                if (pricingConfig.modules[moduleId]) {
                    pricingConfig.modules[moduleId].basePrice = moduleData.tierPrices.tier1;
                    // Actualizar tierPrices en el objeto de configuraci√≥n
                    pricingConfig.modules[moduleId].tierPrices = {
                        tier1: moduleData.tierPrices.tier1,
                        tier2: moduleData.tierPrices.tier2,
                        tier3: moduleData.tierPrices.tier3
                    };
                    // Actualizar inputs si est√°n visibles
                    const input1 = document.getElementById(`price-${moduleId}-0`);
                    const input2 = document.getElementById(`price-${moduleId}-1`);
                    const input3 = document.getElementById(`price-${moduleId}-2`);
                    if (input1) input1.value = moduleData.tierPrices.tier1.toFixed(2);
                    if (input2) input2.value = moduleData.tierPrices.tier2.toFixed(2);
                    if (input3) input3.value = moduleData.tierPrices.tier3.toFixed(2);
                }
            });
            // Regenerar controles con los datos actualizados
            generatePricingControls();
        }

        function configurePayment(companyId) {
            const company = companies.find(c => c.id === companyId);
            const method = paymentMethods.find(m => m.companyId === companyId);
            
            const content = `
                <div style="padding: 1rem;">
                    <h3>Configurar Pagos - ${company.name}</h3>
                    <div style="margin: 1rem 0;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="checkbox" ${method.qrEnabled ? 'checked' : ''} onchange="toggleQR(${companyId}, this.checked)">
                            <span>üì± Habilitar pagos con QR</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="checkbox" ${method.cardEnabled ? 'checked' : ''} onchange="toggleCard(${companyId}, this.checked)">
                            <span>üí≥ Habilitar pagos con tarjeta</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" ${method.autopayEnabled ? 'checked' : ''} onchange="toggleAutopay(${companyId}, this.checked)">
                            <span>üîÑ D√©bito autom√°tico mensual</span>
                        </label>
                    </div>
                    <button class="btn btn-success" onclick="closeModal()" style="width: 100%;">‚úÖ Guardar Configuraci√≥n</button>
                </div>
            `;
            
            showModal('Configuraci√≥n de Pagos', content);
        }

        function toggleQR(companyId, enabled) {
            const method = paymentMethods.find(m => m.companyId === companyId);
            if (method) method.qrEnabled = enabled;
        }

        function toggleCard(companyId, enabled) {
            const method = paymentMethods.find(m => m.companyId === companyId);
            if (method) method.cardEnabled = enabled;
        }

        function toggleAutopay(companyId, enabled) {
            const method = paymentMethods.find(m => m.companyId === companyId);
            if (method) method.autopayEnabled = enabled;
        }

        // Funciones de utilidad
        function showModal(title, content) {
            const modal = document.getElementById('companyModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = modal.querySelector('.modal-body');
            
            modalTitle.textContent = title;
            modalBody.innerHTML = content;
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('companyModal').classList.remove('show');
        }

        // Base de datos geogr√°fica completa de Latinoam√©rica
        const geographicalData = {
            Argentina: {
                'Buenos Aires': {
                    'Ciudad Aut√≥noma de Buenos Aires': '1000',
                    'La Plata': '1900',
                    'Mar del Plata': '7600',
                    'Bah√≠a Blanca': '8000',
                    'Tandil': '7000',
                    'Olavarr√≠a': '7400',
                    'Mercedes': '6600',
                    'Jun√≠n': '6000',
                    'Pergamino': '2700',
                    'San Nicol√°s': '2900',
                    'Quilmes': '1878',
                    'Lan√∫s': '1824',
                    'Mor√≥n': '1708',
                    'San Isidro': '1642',
                    'Tigre': '1648',
                    'Pilar': '1629'
                },
                'C√≥rdoba': {
                    'C√≥rdoba': '5000',
                    'Villa Carlos Paz': '5152',
                    'R√≠o Cuarto': '5800',
                    'Villa Mar√≠a': '5900',
                    'San Francisco': '2400',
                    'Alta Gracia': '5186',
                    'Jes√∫s Mar√≠a': '5220'
                },
                'Santa Fe': {
                    'Santa Fe': '3000',
                    'Rosario': '2000',
                    'Rafaela': '2300',
                    'Venado Tuerto': '2600',
                    'Reconquista': '3560',
                    'Villa Gobernador G√°lvez': '2152',
                    'Esperanza': '3080'
                },
                'Mendoza': {
                    'Mendoza': '5500',
                    'San Rafael': '5600',
                    'Godoy Cruz': '5501',
                    'Luj√°n de Cuyo': '5507',
                    'Maip√∫': '5515',
                    'San Mart√≠n': '5570'
                },
                'Tucum√°n': {
                    'San Miguel de Tucum√°n': '4000',
                    'Taf√≠ Viejo': '4103',
                    'Yerba Buena': '4107',
                    'Banda del R√≠o Sal√≠': '4101',
                    'Concepci√≥n': '4146'
                },
                'Entre R√≠os': {
                    'Paran√°': '3100',
                    'Concordia': '3200',
                    'Gualeguaych√∫': '2840',
                    'Uruguay': '3260',
                    'Concepci√≥n del Uruguay': '3260'
                },
                'Salta': {
                    'Salta': '4400',
                    'San Ram√≥n de la Nueva Or√°n': '4530',
                    'Tartagal': '4560',
                    'Cafayate': '4427',
                    'Met√°n': '4440'
                },
                'Misiones': {
                    'Posadas': '3300',
                    'Ober√°': '3360',
                    'Eldorado': '3380',
                    'Puerto Iguaz√∫': '3370',
                    'Leandro N. Alem': '3315'
                },
                'Chaco': {
                    'Resistencia': '3500',
                    'Barranqueras': '3503',
                    'S√°enz Pe√±a': '3700',
                    'Villa √Ångela': '3540'
                },
                'Corrientes': {
                    'Corrientes': '3400',
                    'Goya': '3450',
                    'Mercedes': '3470',
                    'Paso de los Libres': '3230'
                },
                'Santiago del Estero': {
                    'Santiago del Estero': '4200',
                    'La Banda': '4206',
                    'Termas de R√≠o Hondo': '4220',
                    'A√±atuya': '4650'
                },
                'Jujuy': {
                    'San Salvador de Jujuy': '4600',
                    'Palpal√°': '4612',
                    'Perico': '4611',
                    'San Pedro': '4500'
                },
                'Formosa': {
                    'Formosa': '3600',
                    'Clorinda': '3613',
                    'Piran√©': '3600',
                    'Ingeniero Ju√°rez': '3711'
                },
                'Catamarca': {
                    'San Fernando del Valle de Catamarca': '4700',
                    'Andalgal√°': '4874',
                    'Bel√©n': '4750',
                    'Tinogasta': '5340'
                },
                'La Rioja': {
                    'La Rioja': '5300',
                    'Chilecito': '5360',
                    'Aimogasta': '5310',
                    'Chepes': '5370'
                },
                'San Juan': {
                    'San Juan': '5400',
                    'Chimbas': '5413',
                    'Rivadavia': '5407',
                    'Santa Luc√≠a': '5411'
                },
                'San Luis': {
                    'San Luis': '5700',
                    'Villa Mercedes': '5730',
                    'Merlo': '5881',
                    'Justo Daract': '5750'
                },
                'La Pampa': {
                    'Santa Rosa': '6300',
                    'General Pico': '6360',
                    'Toay': '6303',
                    'Eduardo Castex': '6350'
                },
                'Neuqu√©n': {
                    'Neuqu√©n': '8300',
                    'Plottier': '8316',
                    'Cipolletti': '8324',
                    'Cutral C√≥': '8322'
                },
                'R√≠o Negro': {
                    'Viedma': '8500',
                    'San Carlos de Bariloche': '8400',
                    'General Roca': '8332',
                    'Cipolletti': '8324'
                },
                'Chubut': {
                    'Rawson': '9103',
                    'Comodoro Rivadavia': '9000',
                    'Puerto Madryn': '9120',
                    'Trelew': '9100'
                },
                'Santa Cruz': {
                    'R√≠o Gallegos': '9400',
                    'Caleta Olivia': '9011',
                    'El Calafate': '9405',
                    'Puerto Deseado': '9050'
                },
                'Tierra del Fuego': {
                    'Ushuaia': '9410',
                    'R√≠o Grande': '9420',
                    'Tolhuin': '9412'
                }
            },
            
            Bolivia: {
                'La Paz': {
                    'La Paz': '0001',
                    'El Alto': '0002',
                    'Achocalla': '0003',
                    'Mecapaca': '0004'
                },
                'Santa Cruz': {
                    'Santa Cruz de la Sierra': '1001',
                    'Montero': '1002',
                    'Warnes': '1003',
                    'La Guardia': '1004'
                },
                'Cochabamba': {
                    'Cochabamba': '2001',
                    'Quillacollo': '2002',
                    'Sacaba': '2003',
                    'Colcapirhua': '2004'
                },
                'Oruro': {
                    'Oruro': '3001',
                    'Challapata': '3002'
                },
                'Potos√≠': {
                    'Potos√≠': '4001',
                    'Uyuni': '4002'
                },
                'Tarija': {
                    'Tarija': '5001',
                    'Yacuiba': '5002'
                },
                'Sucre': {
                    'Sucre': '6001'
                },
                'Beni': {
                    'Trinidad': '7001',
                    'Riberalta': '7002'
                },
                'Pando': {
                    'Cobija': '8001'
                }
            },

            Brasil: {
                'S√£o Paulo': {
                    'S√£o Paulo': '01000-000',
                    'Guarulhos': '07000-000',
                    'Campinas': '13000-000',
                    'S√£o Bernardo do Campo': '09000-000',
                    'Santo Andr√©': '09000-000',
                    'Osasco': '06000-000',
                    'Santos': '11000-000',
                    'Ribeir√£o Preto': '14000-000',
                    'Sorocaba': '18000-000',
                    'S√£o Jos√© dos Campos': '12000-000'
                },
                'Rio de Janeiro': {
                    'Rio de Janeiro': '20000-000',
                    'Niter√≥i': '24000-000',
                    'Nova Igua√ßu': '26000-000',
                    'Duque de Caxias': '25000-000',
                    'S√£o Gon√ßalo': '24000-000',
                    'Volta Redonda': '27000-000',
                    'Petr√≥polis': '25000-000',
                    'Campos dos Goytacazes': '28000-000',
                    'Belford Roxo': '26000-000'
                },
                'Minas Gerais': {
                    'Belo Horizonte': '30000-000',
                    'Uberl√¢ndia': '38000-000',
                    'Contagem': '32000-000',
                    'Juiz de Fora': '36000-000',
                    'Betim': '32000-000',
                    'Montes Claros': '39000-000',
                    'Ribeir√£o das Neves': '33000-000',
                    'Uberaba': '38000-000',
                    'Governador Valadares': '35000-000',
                    'Ipatinga': '35000-000'
                },
                'Bahia': {
                    'Salvador': '40000-000',
                    'Feira de Santana': '44000-000',
                    'Vit√≥ria da Conquista': '45000-000',
                    'Cama√ßari': '42000-000',
                    'Juazeiro': '48000-000',
                    'Lauro de Freitas': '42000-000',
                    'Itabuna': '45000-000',
                    'Jequi√©': '45000-000',
                    'Alagoinhas': '48000-000'
                },
                'Paran√°': {
                    'Curitiba': '80000-000',
                    'Londrina': '86000-000',
                    'Maring√°': '87000-000',
                    'Ponta Grossa': '84000-000',
                    'Cascavel': '85000-000',
                    'S√£o Jos√© dos Pinhais': '83000-000',
                    'Foz do Igua√ßu': '85000-000',
                    'Colombo': '83000-000',
                    'Guarapuava': '85000-000'
                },
                'Rio Grande do Sul': {
                    'Porto Alegre': '90000-000',
                    'Caxias do Sul': '95000-000',
                    'Pelotas': '96000-000',
                    'Canoas': '92000-000',
                    'Santa Maria': '97000-000',
                    'Gravata√≠': '94000-000',
                    'Viam√£o': '94000-000',
                    'Novo Hamburgo': '93000-000',
                    'S√£o Leopoldo': '93000-000'
                },
                'Cear√°': {
                    'Fortaleza': '60000-000',
                    'Caucaia': '61000-000',
                    'Juazeiro do Norte': '63000-000',
                    'Maracana√∫': '61000-000',
                    'Sobral': '62000-000',
                    'Crato': '63000-000'
                },
                'Pernambuco': {
                    'Recife': '50000-000',
                    'Jaboat√£o dos Guararapes': '54000-000',
                    'Olinda': '53000-000',
                    'Caruaru': '55000-000',
                    'Petrolina': '56000-000',
                    'Paulista': '53000-000'
                },
                'Par√°': {
                    'Bel√©m': '66000-000',
                    'Ananindeua': '67000-000',
                    'Santar√©m': '68000-000',
                    'Marab√°': '68000-000',
                    'Parauapebas': '68500-000'
                },
                'Santa Catarina': {
                    'Florian√≥polis': '88000-000',
                    'Joinville': '89000-000',
                    'Blumenau': '89000-000',
                    'S√£o Jos√©': '88000-000',
                    'Crici√∫ma': '88800-000',
                    'Chapec√≥': '89800-000'
                },
                'Goi√°s': {
                    'Goi√¢nia': '74000-000',
                    'Aparecida de Goi√¢nia': '74000-000',
                    'An√°polis': '75000-000',
                    'Rio Verde': '75900-000',
                    'Luzi√¢nia': '72800-000'
                },
                'Maranh√£o': {
                    'S√£o Lu√≠s': '65000-000',
                    'Imperatriz': '65900-000',
                    'S√£o Jos√© de Ribamar': '65110-000',
                    'Timon': '65630-000',
                    'Caxias': '65600-000'
                },
                'Esp√≠rito Santo': {
                    'Vit√≥ria': '29000-000',
                    'Vila Velha': '29100-000',
                    'Serra': '29160-000',
                    'Cariacica': '29140-000',
                    'Cachoeiro de Itapemirim': '29300-000'
                }
            },

            Chile: {
                'Regi√≥n de Arica y Parinacota': {
                    'Arica': '1000000',
                    'Putre': '1000001',
                    'Camarones': '1000002',
                    'General Lagos': '1000003'
                },
                'Regi√≥n de Tarapac√°': {
                    'Iquique': '1100000',
                    'Alto Hospicio': '1100001',
                    'Pozo Almonte': '1100002',
                    'Pica': '1100003',
                    'Huara': '1100004'
                },
                'Regi√≥n de Antofagasta': {
                    'Antofagasta': '1240000',
                    'Calama': '1390000',
                    'Tocopilla': '1340000',
                    'Mejillones': '1240001',
                    'Taltal': '1380000',
                    'San Pedro de Atacama': '1410000'
                },
                'Regi√≥n de Atacama': {
                    'Copiap√≥': '1530000',
                    'Vallenar': '1610000',
                    'Caldera': '1570000',
                    'Cha√±aral': '1490000',
                    'Diego de Almagro': '1500000'
                },
                'Regi√≥n de Coquimbo': {
                    'La Serena': '1700000',
                    'Coquimbo': '1780000',
                    'Ovalle': '1840000',
                    'Illapel': '1990000',
                    'Vicu√±a': '1740000'
                },
                'Regi√≥n de Valpara√≠so': {
                    'Valpara√≠so': '2340000',
                    'Vi√±a del Mar': '2520000',
                    'Quilpu√©': '2430000',
                    'Villa Alemana': '2910000',
                    'San Antonio': '2660000',
                    'Quillota': '2260000',
                    'Los Andes': '2100000'
                },
                'Regi√≥n Metropolitana': {
                    'Santiago': '8320000',
                    'Puente Alto': '8150000',
                    'Maip√∫': '9250000',
                    'Las Condes': '7550000',
                    'La Florida': '8240000',
                    'Providencia': '7500000',
                    '√ëu√±oa': '7750000',
                    'San Bernardo': '8050000',
                    'Pe√±alol√©n': '7910000',
                    'Quilicura': '8730000',
                    'Melipilla': '9580000'
                },
                'Regi√≥n del Libertador Bernardo O\'Higgins': {
                    'Rancagua': '2820000',
                    'San Fernando': '3070000',
                    'Rengo': '2940000',
                    'Machal√≠': '2841000',
                    'Graneros': '2900000'
                },
                'Regi√≥n del Maule': {
                    'Talca': '3460000',
                    'Curic√≥': '3340000',
                    'Linares': '3580000',
                    'Cauquenes': '3690000',
                    'Constituci√≥n': '3560000'
                },
                'Regi√≥n del Biob√≠o': {
                    'Concepci√≥n': '4030000',
                    'Talcahuano': '4260000',
                    'Chill√°n': '3780000',
                    'Los √Ångeles': '4440000',
                    'Coronel': '4190000',
                    'San Pedro de la Paz': '4130000',
                    'Tom√©': '4270000'
                },
                'Regi√≥n de La Araucan√≠a': {
                    'Temuco': '4780000',
                    'Villarrica': '4930000',
                    'Angol': '4650000',
                    'Puc√≥n': '4920000',
                    'Victoria': '4730000'
                },
                'Regi√≥n de Los R√≠os': {
                    'Valdivia': '5090000',
                    'La Uni√≥n': '5170000',
                    'R√≠o Bueno': '5310000',
                    'Panguipulli': '5120000'
                },
                'Regi√≥n de Los Lagos': {
                    'Puerto Montt': '5480000',
                    'Osorno': '5290000',
                    'Castro': '5700000',
                    'Puerto Varas': '5550000',
                    'Ancud': '5710000'
                },
                'Regi√≥n de Ays√©n': {
                    'Coyhaique': '5950000',
                    'Puerto Ays√©n': '5960000',
                    'Chile Chico': '6160000'
                },
                'Regi√≥n de Magallanes': {
                    'Punta Arenas': '6200000',
                    'Puerto Natales': '6160000',
                    'Porvenir': '6350000'
                }
            },

            Colombia: {
                'Cundinamarca': {
                    'Bogot√°': '110111',
                    'Soacha': '250754',
                    'Girardot': '251226',
                    'Zipaquir√°': '251001'
                },
                'Antioquia': {
                    'Medell√≠n': '050001',
                    'Bello': '050088',
                    'Itag√º√≠': '050360',
                    'Envigado': '050266'
                },
                'Valle del Cauca': {
                    'Cali': '760001',
                    'Palmira': '760520',
                    'Buenaventura': '760001',
                    'Tulua': '760855'
                },
                'Atl√°ntico': {
                    'Barranquilla': '080001',
                    'Soledad': '080758',
                    'Malambo': '080433'
                },
                'Bol√≠var': {
                    'Cartagena': '130001',
                    'Magangu√©': '130429',
                    'Turbaco': '130833'
                },
                'Santander': {
                    'Bucaramanga': '680001',
                    'Floridablanca': '680276',
                    'Gir√≥n': '680307'
                },
                'Norte de Santander': {
                    'C√∫cuta': '540001',
                    'Villa del Rosario': '540874',
                    'Los Patios': '540405'
                }
            },

            'Costa Rica': {
                'San Jos√©': {
                    'San Jos√©': '10101',
                    'Escaz√∫': '10201',
                    'Desamparados': '10301',
                    'Cartago': '30101'
                },
                'Alajuela': {
                    'Alajuela': '20101',
                    'San Ram√≥n': '20701',
                    'Grecia': '20301'
                },
                'Cartago': {
                    'Cartago': '30101',
                    'Para√≠so': '30201',
                    'Turrialba': '30501'
                },
                'Heredia': {
                    'Heredia': '40101',
                    'Barva': '40201',
                    'Santo Domingo': '40301'
                },
                'Guanacaste': {
                    'Liberia': '50101',
                    'Nicoya': '50501',
                    'Santa Cruz': '50601'
                },
                'Puntarenas': {
                    'Puntarenas': '60101',
                    'Esparza': '60201',
                    'Buenos Aires': '60301'
                },
                'Lim√≥n': {
                    'Lim√≥n': '70101',
                    'Pococ√≠': '70201',
                    'Siquirres': '70301'
                }
            },

            Ecuador: {
                'Pichincha': {
                    'Quito': '170501',
                    'Cayambe': '170150',
                    'Mej√≠a': '170250'
                },
                'Guayas': {
                    'Guayaquil': '090101',
                    'Milagro': '090550',
                    'Dur√°n': '090250'
                },
                'Azuay': {
                    'Cuenca': '010101',
                    'Gualaceo': '010350',
                    'Paute': '010550'
                },
                'Manab√≠': {
                    'Portoviejo': '130101',
                    'Manta': '130550',
                    'Chone': '130250'
                },
                'Los R√≠os': {
                    'Babahoyo': '120101',
                    'Quevedo': '120750',
                    'Ventanas': '120950'
                },
                'Tungurahua': {
                    'Ambato': '180101',
                    'Ba√±os de Agua Santa': '180150',
                    'Pelileo': '180650'
                }
            },

            'El Salvador': {
                'San Salvador': {
                    'San Salvador': 'SS01',
                    'Mejicanos': 'SS02',
                    'Soyapango': 'SS03',
                    'Delgado': 'SS04'
                },
                'La Libertad': {
                    'Santa Tecla': 'LL01',
                    'Antiguo Cuscatl√°n': 'LL02',
                    'Quezaltepeque': 'LL03'
                },
                'San Miguel': {
                    'San Miguel': 'SM01',
                    'Moncagua': 'SM02'
                },
                'Santa Ana': {
                    'Santa Ana': 'SA01',
                    'Metap√°n': 'SA02'
                },
                'Ahuachap√°n': {
                    'Ahuachap√°n': 'AH01',
                    'Atiquizaya': 'AH02'
                }
            },

            Guatemala: {
                'Guatemala': {
                    'Ciudad de Guatemala': '01001',
                    'Mixco': '01002',
                    'Villa Nueva': '01003',
                    'San Miguel Petapa': '01004'
                },
                'Quetzaltenango': {
                    'Quetzaltenango': '09001',
                    'Salcaj√°': '09002',
                    'Olintepeque': '09003'
                },
                'Escuintla': {
                    'Escuintla': '05001',
                    'Santa Luc√≠a Cotzumalguapa': '05002'
                },
                'Alta Verapaz': {
                    'Cob√°n': '16001',
                    'San Pedro Carch√°': '16002'
                },
                'Pet√©n': {
                    'Flores': '17001',
                    'San Benito': '17002'
                }
            },

            Honduras: {
                'Francisco Moraz√°n': {
                    'Tegucigalpa': '0801',
                    'Comayag√ºela': '0802',
                    'Valle de √Ångeles': '0803'
                },
                'Cort√©s': {
                    'San Pedro Sula': '0501',
                    'Choloma': '0502',
                    'La Lima': '0503'
                },
                'Atl√°ntida': {
                    'La Ceiba': '0101',
                    'Tela': '0102',
                    'El Progreso': '0103'
                },
                'Choluteca': {
                    'Choluteca': '0601',
                    'Marcovia': '0602'
                },
                'Olancho': {
                    'Juticalpa': '1501',
                    'Catacamas': '1502'
                }
            },

            M√©xico: {
                'Ciudad de M√©xico': {
                    'Ciudad de M√©xico': '01000',
                    '√Ålvaro Obreg√≥n': '01020',
                    'Azcapotzalco': '02000',
                    'Benito Ju√°rez': '03000'
                },
                'Estado de M√©xico': {
                    'Toluca': '50000',
                    'Ecatepec': '55000',
                    'Naucalpan': '53000',
                    'Nezahualc√≥yotl': '57000'
                },
                'Jalisco': {
                    'Guadalajara': '44100',
                    'Zapopan': '45000',
                    'Tlaquepaque': '45500',
                    'Tonal√°': '45400'
                },
                'Nuevo Le√≥n': {
                    'Monterrey': '64000',
                    'Guadalupe': '67100',
                    'San Nicol√°s de los Garza': '66400'
                },
                'Puebla': {
                    'Puebla': '72000',
                    'Tehuac√°n': '75700',
                    'Atlixco': '74200'
                },
                'Chihuahua': {
                    'Chihuahua': '31000',
                    'Ciudad Ju√°rez': '32000',
                    'Delicias': '33000'
                }
            },

            Nicaragua: {
                'Managua': {
                    'Managua': '10001',
                    'Ciudad Sandino': '10002',
                    'Tipitapa': '10003'
                },
                'Le√≥n': {
                    'Le√≥n': '21001',
                    'La Paz Centro': '21002'
                },
                'Granada': {
                    'Granada': '31001',
                    'Nandaime': '31002'
                },
                'Masaya': {
                    'Masaya': '41001',
                    'Niquinohomo': '41002'
                },
                'Chinandega': {
                    'Chinandega': '12001',
                    'Corinto': '12002'
                }
            },

            Panam√°: {
                'Panam√°': {
                    'Ciudad de Panam√°': '0801',
                    'San Miguelito': '0802',
                    'Pedregal': '0803'
                },
                'Col√≥n': {
                    'Col√≥n': '0301',
                    'Sabanitas': '0302'
                },
                'Chiriqu√≠': {
                    'David': '0401',
                    'Boquete': '0402',
                    'Puerto Armuelles': '0403'
                },
                'Cocl√©': {
                    'Penonom√©': '0201',
                    'Aguadulce': '0202'
                },
                'Veraguas': {
                    'Santiago': '1201',
                    'Son√°': '1202'
                }
            },

            Paraguay: {
                'Central': {
                    'Asunci√≥n': '1001',
                    'Lambar√©': '1002',
                    'San Lorenzo': '1003',
                    'Capiat√°': '1004',
                    'Fernando de la Mora': '1005',
                    'Luque': '1006',
                    'Mariano Roque Alonso': '1007',
                    '√ëemby': '1008',
                    'San Antonio': '1009',
                    'Villa Elisa': '1010'
                },
                'Alto Paran√°': {
                    'Ciudad del Este': '7001',
                    'Hernandarias': '7002',
                    'Minga Guaz√∫': '7003',
                    'Franco': '7004',
                    'Presidente Franco': '7005',
                    'Itakyry': '7006'
                },
                'Itap√∫a': {
                    'Encarnaci√≥n': '6001',
                    'Hohenau': '6002',
                    'Obligado': '6003',
                    'Bella Vista': '6004',
                    'Carmen del Paran√°': '6005'
                },
                'Cordillera': {
                    'Caacup√©': '5001',
                    'Tobat√≠': '5002',
                    'Atyr√°': '5003',
                    'Caraguatay': '5004',
                    'Emboscada': '5005'
                },
                'Guair√°': {
                    'Villarrica': '4001',
                    'Borja': '4002',
                    'Coronel Mart√≠nez': '4003',
                    'F√©lix P√©rez Cardozo': '4004'
                },
                'Paraguar√≠': {
                    'Paraguar√≠': '2001',
                    'Piribebuy': '2002',
                    'Yaguar√≥n': '2003',
                    'Ybycu√≠': '2004'
                },
                'Caaguaz√∫': {
                    'Coronel Oviedo': '3001',
                    'Caaguaz√∫': '3002',
                    'J. Eulogio Estigarribia': '3003',
                    'Nueva Londres': '3004'
                },
                'San Pedro': {
                    'San Pedro del Ycuamandiy√∫': '14001',
                    'Antequera': '14002',
                    'Chor√©': '14003'
                },
                'Concepci√≥n': {
                    'Concepci√≥n': '13001',
                    'Bel√©n': '13002',
                    'Horqueta': '13003'
                },
                'Amambay': {
                    'Pedro Juan Caballero': '16001',
                    'Bella Vista': '16002',
                    'Capit√°n Bado': '16003'
                }
            },

            Per√∫: {
                'Lima': {
                    'Lima': '15001',
                    'Callao': '07001',
                    'San Juan de Lurigancho': '15132',
                    'San Mart√≠n de Porres': '15109'
                },
                'Arequipa': {
                    'Arequipa': '04001',
                    'Cayma': '04003',
                    'Cerro Colorado': '04017'
                },
                'La Libertad': {
                    'Trujillo': '13001',
                    'El Porvenir': '13004',
                    'Florencia de Mora': '13005'
                },
                'Piura': {
                    'Piura': '20001',
                    'Castilla': '20003',
                    'Catacaos': '20004'
                },
                'Lambayeque': {
                    'Chiclayo': '14001',
                    'Jos√© Leonardo Ortiz': '14002',
                    'La Victoria': '14003'
                },
                'Cusco': {
                    'Cusco': '08001',
                    'San Sebasti√°n': '08007',
                    'San Jer√≥nimo': '08006'
                }
            },

            Uruguay: {
                'Montevideo': {
                    'Montevideo': '11000',
                    'Ciudad Vieja': '11100',
                    'Centro': '11200',
                    'Barrio Sur': '11300',
                    'Pocitos': '11300',
                    'Punta Carretas': '11300',
                    'Carrasco': '11500',
                    'Malv√≠n': '11400',
                    'Buceo': '11300'
                },
                'Canelones': {
                    'Canelones': '90000',
                    'Las Piedras': '90200',
                    'Pando': '91000',
                    'Santa Luc√≠a': '90300',
                    'Ciudad de la Costa': '15000',
                    'Barros Blancos': '91700',
                    'La Paz': '91500',
                    'Progreso': '90200',
                    'Atl√°ntida': '15200',
                    'Parque del Plata': '15300'
                },
                'Maldonado': {
                    'Maldonado': '20000',
                    'Punta del Este': '20100',
                    'San Carlos': '20200',
                    'Piri√°polis': '20200',
                    'Pan de Az√∫car': '20300',
                    'Aigu√°': '20400'
                },
                'Salto': {
                    'Salto': '50000',
                    'Constituci√≥n': '50100',
                    'Bel√©n': '50200',
                    'Biassini': '50300'
                },
                'Rivera': {
                    'Rivera': '40000',
                    'Tranqueras': '40100',
                    'Vichadero': '40200',
                    'Minas de Corrales': '40300'
                },
                'Paysand√∫': {
                    'Paysand√∫': '60000',
                    'Guich√≥n': '60100',
                    'Quebracho': '60200',
                    'Lorenzo Geyres': '60300'
                },
                'Tacuaremb√≥': {
                    'Tacuaremb√≥': '45000',
                    'Paso de los Toros': '45100',
                    'San Gregorio de Polanco': '45200'
                },
                'Colonia': {
                    'Colonia del Sacramento': '70000',
                    'Juan Lacaze': '70100',
                    'Nueva Helvecia': '70200',
                    'Rosario': '70300',
                    'Tarariras': '70400'
                },
                'Soriano': {
                    'Mercedes': '75000',
                    'Dolores': '75100',
                    'Cardona': '75200'
                },
                'Rocha': {
                    'Rocha': '27000',
                    'Chuy': '27100',
                    'La Paloma': '27200',
                    'Castillos': '27300'
                },
                'Artigas': {
                    'Artigas': '55000',
                    'Bella Uni√≥n': '55100',
                    'Tom√°s Gomensoro': '55200'
                },
                'Cerro Largo': {
                    'Melo': '37000',
                    'R√≠o Branco': '37100',
                    'Fraile Muerto': '37200'
                },
                'Durazno': {
                    'Durazno': '97000',
                    'Sarand√≠ del Y√≠': '97100',
                    'Villa del Carmen': '97200'
                },
                'Flores': {
                    'Trinidad': '85000',
                    'Ismael Cortinas': '85100'
                },
                'Florida': {
                    'Florida': '94000',
                    '25 de Agosto': '94100',
                    'Sarand√≠ Grande': '94200'
                },
                'Lavalleja': {
                    'Minas': '30000',
                    'Jos√© Pedro Varela': '30100',
                    'Sol√≠s de Mataojo': '30200'
                },
                'R√≠o Negro': {
                    'Fray Bentos': '65000',
                    'Young': '65100',
                    'Nuevo Berl√≠n': '65200'
                },
                'San Jos√©': {
                    'San Jos√© de Mayo': '80000',
                    'Ciudad del Plata': '80100',
                    'Libertad': '80200',
                    'Ecilda Paullier': '80300'
                },
                'Treinta y Tres': {
                    'Treinta y Tres': '33000',
                    'Vergara': '33100',
                    'Santa Clara de Olimar': '33200'
                }
            },

            Espa√±a: {
                'Andaluc√≠a': {
                    'Sevilla': '41001',
                    'M√°laga': '29001',
                    'C√≥rdoba': '14001',
                    'Granada': '18001',
                    'C√°diz': '11001',
                    'Almer√≠a': '04001',
                    'Huelva': '21001',
                    'Ja√©n': '23001',
                    'Jerez de la Frontera': '11401',
                    'Marbella': '29600'
                },
                'Catalu√±a': {
                    'Barcelona': '08001',
                    'L\'Hospitalet de Llobregat': '08901',
                    'Badalona': '08911',
                    'Terrassa': '08221',
                    'Sabadell': '08201',
                    'Lleida': '25001',
                    'Tarragona': '43001',
                    'Girona': '17001',
                    'Manresa': '08240',
                    'Reus': '43201'
                },
                'Comunidad de Madrid': {
                    'Madrid': '28001',
                    'M√≥stoles': '28931',
                    'Alcal√° de Henares': '28801',
                    'Fuenlabrada': '28941',
                    'Legan√©s': '28911',
                    'Getafe': '28901',
                    'Alcorc√≥n': '28921',
                    'Torrej√≥n de Ardoz': '28850',
                    'Parla': '28980',
                    'Alcobendas': '28100'
                },
                'Comunidad Valenciana': {
                    'Valencia': '46001',
                    'Alicante': '03001',
                    'Elche': '03201',
                    'Castell√≥n de la Plana': '12001',
                    'Torrevieja': '03180',
                    'Orihuela': '03300',
                    'Gand√≠a': '46701',
                    'Sagunto': '46500',
                    'Alcoy': '03801',
                    'Villena': '03400'
                },
                'Galicia': {
                    'Vigo': '36201',
                    'A Coru√±a': '15001',
                    'Ourense': '32001',
                    'Lugo': '27001',
                    'Santiago de Compostela': '15701',
                    'Pontevedra': '36001',
                    'Ferrol': '15401',
                    'Nar√≥n': '15570',
                    'Vilagarc√≠a de Arousa': '36600'
                },
                'Pa√≠s Vasco': {
                    'Bilbao': '48001',
                    'Vitoria-Gasteiz': '01001',
                    'San Sebasti√°n': '20001',
                    'Getxo': '48901',
                    'Barakaldo': '48901',
                    'Santurtzi': '48980',
                    'Portugalete': '48920',
                    'Basauri': '48970'
                },
                'Castilla y Le√≥n': {
                    'Valladolid': '47001',
                    'Burgos': '09001',
                    'Salamanca': '37001',
                    'Le√≥n': '24001',
                    'Palencia': '34001',
                    'Zamora': '49001',
                    '√Åvila': '05001',
                    'Segovia': '40001',
                    'Soria': '42001',
                    'Ponferrada': '24400'
                },
                'Arag√≥n': {
                    'Zaragoza': '50001',
                    'Huesca': '22001',
                    'Teruel': '44001',
                    'Calatayud': '50300',
                    'Alca√±iz': '44600',
                    'Barbastro': '22300',
                    'Monz√≥n': '22400',
                    'Jaca': '22700'
                },
                'Asturias': {
                    'Oviedo': '33001',
                    'Gij√≥n': '33201',
                    'Avil√©s': '33401',
                    'Siero': '33510',
                    'Langreo': '33930',
                    'Mieres': '33600',
                    'Sama de Langreo': '33900'
                },
                'Castilla-La Mancha': {
                    'Toledo': '45001',
                    'Albacete': '02001',
                    'Ciudad Real': '13001',
                    'Guadalajara': '19001',
                    'Cuenca': '16001',
                    'Talavera de la Reina': '45600',
                    'Puertollano': '13500'
                },
                'Murcia': {
                    'Murcia': '30001',
                    'Cartagena': '30201',
                    'Lorca': '30800',
                    'Molina de Segura': '30500',
                    'Alcantarilla': '30820',
                    'Mazarr√≥n': '30870'
                },
                'Extremadura': {
                    'Badajoz': '06001',
                    'C√°ceres': '10001',
                    'M√©rida': '06800',
                    'Plasencia': '10600',
                    'Don Benito': '06400',
                    'Villanueva de la Serena': '06700'
                },
                'Baleares': {
                    'Palma': '07001',
                    'Calvi√†': '07180',
                    'Manacor': '07500',
                    'Inca': '07300',
                    'Llucmajor': '07620',
                    'Marratx√≠': '07141'
                },
                'Navarra': {
                    'Pamplona': '31001',
                    'Tudela': '31500',
                    'Bara√±√°in': '31010',
                    'Burlada': '31007',
                    'Estella': '31200'
                },
                'Cantabria': {
                    'Santander': '39001',
                    'Torrelavega': '39300',
                    'Castro-Urdiales': '39700',
                    'Camargo': '39600',
                    'El Astillero': '39610'
                },
                'La Rioja': {
                    'Logro√±o': '26001',
                    'Calahorra': '26500',
                    'Arnedo': '26580',
                    'Haro': '26200'
                },
                'Canarias': {
                    'Las Palmas de Gran Canaria': '35001',
                    'Santa Cruz de Tenerife': '38001',
                    'San Crist√≥bal de La Laguna': '38200',
                    'Telde': '35200',
                    'Santa Luc√≠a de Tirajana': '35110',
                    'Arona': '38640',
                    'Arrecife': '35500'
                },
                'Ceuta': {
                    'Ceuta': '51001'
                },
                'Melilla': {
                    'Melilla': '52001'
                }
            },

            Venezuela: {
                'Distrito Capital': {
                    'Caracas': '1010',
                    'Libertador': '1020',
                    'Chacao': '1060',
                    'Baruta': '1080'
                },
                'Miranda': {
                    'Los Teques': '1201',
                    'Guarenas': '1202',
                    'Guatire': '1203',
                    'Petare': '1204'
                },
                'Zulia': {
                    'Maracaibo': '4001',
                    'San Francisco': '4002',
                    'Cabimas': '4003'
                },
                'Carabobo': {
                    'Valencia': '2001',
                    'Puerto Cabello': '2002',
                    'Guacara': '2003'
                },
                'Lara': {
                    'Barquisimeto': '3001',
                    'Cabudare': '3002',
                    'El Tocuyo': '3003'
                },
                'Aragua': {
                    'Maracay': '2101',
                    'Turmero': '2102',
                    'Villa de Cura': '2103'
                }
            }
        };

        // Funciones para cargar datos geogr√°ficos
        function loadProvinces() {
            const countrySelect = document.getElementById('country');
            const provinceSelect = document.getElementById('province');
            const citySelect = document.getElementById('city');
            const postalCodeInput = document.getElementById('postalCode');
            
            const selectedCountry = countrySelect.value;
            
            // Limpiar selects dependientes
            provinceSelect.innerHTML = '<option value="">Seleccionar provincia...</option>';
            citySelect.innerHTML = '<option value="">Seleccionar ciudad...</option>';
            postalCodeInput.value = '';
            
            if (selectedCountry && geographicalData[selectedCountry]) {
                Object.keys(geographicalData[selectedCountry]).forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    provinceSelect.appendChild(option);
                });
            }
        }

        function loadCities() {
            const countrySelect = document.getElementById('country');
            const provinceSelect = document.getElementById('province');
            const citySelect = document.getElementById('city');
            const postalCodeInput = document.getElementById('postalCode');
            
            const selectedCountry = countrySelect.value;
            const selectedProvince = provinceSelect.value;
            
            // Limpiar selects dependientes
            citySelect.innerHTML = '<option value="">Seleccionar ciudad...</option>';
            postalCodeInput.value = '';
            
            if (selectedCountry && selectedProvince && 
                geographicalData[selectedCountry] && 
                geographicalData[selectedCountry][selectedProvince]) {
                
                Object.keys(geographicalData[selectedCountry][selectedProvince]).forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
        }

        function loadPostalCode() {
            const countrySelect = document.getElementById('country');
            const provinceSelect = document.getElementById('province');
            const citySelect = document.getElementById('city');
            const postalCodeInput = document.getElementById('postalCode');
            
            const selectedCountry = countrySelect.value;
            const selectedProvince = provinceSelect.value;
            const selectedCity = citySelect.value;
            
            if (selectedCountry && selectedProvince && selectedCity &&
                geographicalData[selectedCountry] && 
                geographicalData[selectedCountry][selectedProvince] &&
                geographicalData[selectedCountry][selectedProvince][selectedCity]) {
                
                postalCodeInput.value = geographicalData[selectedCountry][selectedProvince][selectedCity];
            } else {
                postalCodeInput.value = '';
            }
        }
        
        function checkForPriceChanges(company) {
            if (!company.modulesPricing) return;
            
            let hasChanges = false;
            const tier = getCurrentTier(company.maxEmployees);
            
            // Verificar si alg√∫n m√≥dulo tiene precios diferentes a los actuales
            company.modules.forEach(moduleId => {
                const currentPrice = calculateModulePrice(pricingConfig.modules[moduleId].basePrice, tier);
                const historicalPrice = company.modulesPricing[moduleId]?.tierPrice || 0;
                
                if (Math.abs(currentPrice - historicalPrice) > 0.01) {
                    hasChanges = true;
                }
            });
            
            // Mostrar u ocultar la secci√≥n de actualizaci√≥n de precios
            const section = document.getElementById('priceUpdateSection');
            const checkbox = document.getElementById('updatePricesCheckbox');
            
            if (hasChanges) {
                section.style.display = 'block';
                checkbox.checked = false; // Por defecto no aplicar cambios
            } else {
                section.style.display = 'none';
            }
        }
        
        function togglePriceUpdate() {
            const checkbox = document.getElementById('updatePricesCheckbox');
            if (checkbox.checked) {
                // Recalcular precios con valores actuales
                updatePricingSummary();
                showNotification('‚úÖ Se aplicar√°n los precios actuales al guardar', 'info');
            } else {
                // Usar precios hist√≥ricos
                updatePricingSummaryWithHistoricalPrices();
                showNotification('üìã Se mantendr√°n los precios hist√≥ricos', 'info');
            }
        }
        
        function toggleModuleModification() {
            const checkbox = document.getElementById('allowModificationCheckbox');
            if (checkbox.checked) {
                showNotification('üîì Ahora puede modificar m√≥dulos contratados', 'info');
            } else {
                showNotification('üîí M√≥dulos contratados protegidos contra modificaciones', 'info');
                // Restaurar m√≥dulos contratados si fueron deshabilitados
                if (currentEditingCompany) {
                    const contractedModuleKeys = currentEditingCompany.activeModulesFromDB
                        ? currentEditingCompany.activeModulesFromDB.map(m => m.moduleKey)
                        : currentEditingCompany.modules;
                    contractedModuleKeys.forEach(moduleId => {
                        selectedModules.add(moduleId);
                    });
                }
            }
            generateModulesGrid();
        }
        
        // NUEVA FUNCI√ìN: Actualizar resumen con precios reales de la BD
        function updatePricingSummaryWithRealData(moduleData) {
            console.log('üí∞ Actualizando resumen con precios reales de BD:', moduleData);

            if (!moduleData || !moduleData.success) {
                console.warn('‚ö†Ô∏è No hay datos de m√≥dulos, usando c√°lculo est√°ndar');
                updatePricingSummary();
                return;
            }

            // CR√çTICO: Calcular precio_hist√≥rico * empleados_actuales
            const currentEmployees = parseInt(document.getElementById('maxEmployees').value) || 1;
            const activeModules = moduleData.modules?.active || [];

            let realSubtotal = 0;
            activeModules.forEach(module => {
                const historicalPrice = parseFloat(module.contractedPrice || module.tierPrice || 0);
                realSubtotal += historicalPrice * currentEmployees;
            });

            const realTax = realSubtotal * 0.21; // IVA 21%
            const realTotal = realSubtotal + realTax;

            console.log(`üí∞ Modal: ${currentEmployees} empleados * precios hist√≥ricos = $${realSubtotal.toFixed(2)}`);

            // Construir lista de m√≥dulos con precios reales
            let selectedModulesList = '';

            activeModules.forEach(module => {
                const historicalPrice = parseFloat(module.contractedPrice || module.tierPrice || 0);
                const totalPrice = historicalPrice * currentEmployees;
                selectedModulesList += `
                    <div class="pricing-item">
                        <span>${module.name}</span>
                        <span>$ ${historicalPrice.toFixed(2)} √ó ${currentEmployees} = $ ${totalPrice.toFixed(2)}</span>
                    </div>
                `;
            });

            // Actualizar la UI con valores reales
            const pricingSidebar = document.querySelector('.pricing-sidebar');
            if (!pricingSidebar) {
                console.error('‚ùå No se encontr√≥ .pricing-sidebar');
                return;
            }

            pricingSidebar.innerHTML = `
                <h4>üí∞ Resumen de Precios (Valores Reales BD)</h4>
                <div class="selected-modules">
                    <h5>M√≥dulos Contratados:</h5>
                    ${selectedModulesList || '<p style="color: #999;">Sin m√≥dulos seleccionados</p>'}
                </div>
                <div class="pricing-breakdown">
                    <div class="pricing-item">
                        <span>Subtotal:</span>
                        <span>$ ${realSubtotal.toFixed(2)}</span>
                    </div>
                    <div class="pricing-item">
                        <span>IVA (21%):</span>
                        <span>$ ${realTax.toFixed(2)}</span>
                    </div>
                    <div class="pricing-item total">
                        <span><strong>Total Mensual:</strong></span>
                        <span><strong>$ ${realTotal.toFixed(2)}</strong></span>
                    </div>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 0.9em; color: #2e7d32;">
                    ‚úÖ <strong>C√°lculo Correcto: Precios Hist√≥ricos √ó Empleados Actuales</strong><br>
                    Precio por empleado contratado √ó ${currentEmployees} empleados + IVA 21%
                </div>
            `;
        }

        function updatePricingSummaryForCurrentSelection() {
            if (!currentEditingCompany) {
                updatePricingSummary();
                return;
            }

            const employeeCount = parseInt(document.getElementById('contractedEmployees').value) || 1;
            const pricingSidebar = document.querySelector('.pricing-sidebar');
            if (!pricingSidebar) return;

            let realSubtotal = 0;
            let selectedModulesList = '';

            // Calcular precio de m√≥dulos seleccionados
            selectedModules.forEach(moduleKey => {
                const modulePrice = currentEditingCompany.modulesPricing && currentEditingCompany.modulesPricing[moduleKey]
                    ? (currentEditingCompany.modulesPricing[moduleKey].tierPrice || currentEditingCompany.modulesPricing[moduleKey].basePrice)
                    : (pricingConfig.modules[moduleKey] ? pricingConfig.modules[moduleKey].basePrice : 0);

                const totalPrice = modulePrice * employeeCount;
                realSubtotal += totalPrice;

                const moduleName = pricingConfig.modules[moduleKey] ? pricingConfig.modules[moduleKey].name : moduleKey;
                selectedModulesList += `
                    <div class="selected-module">
                        <span>${moduleName}</span>
                        <span>$ ${modulePrice.toFixed(2)} √ó ${employeeCount} = $ ${totalPrice.toFixed(2)}</span>
                    </div>
                `;
            });

            const realTax = realSubtotal * 0.21;
            const realTotal = realSubtotal + realTax;

            pricingSidebar.innerHTML = `
                <h4>üí∞ Resumen de Precios (M√≥dulos Seleccionados)</h4>
                <div class="selected-modules">
                    <h5>M√≥dulos Seleccionados (${selectedModules.size}):</h5>
                    ${selectedModulesList || '<p style="color: #999;">Sin m√≥dulos seleccionados</p>'}
                </div>
                <div class="pricing-breakdown">
                    <div class="pricing-item">
                        <span>Subtotal:</span>
                        <span>$ ${realSubtotal.toFixed(2)}</span>
                    </div>
                    <div class="pricing-item">
                        <span>IVA (21%):</span>
                        <span>$ ${realTax.toFixed(2)}</span>
                    </div>
                    <div class="pricing-item total">
                        <span><strong>Total Mensual:</strong></span>
                        <span><strong>$ ${realTotal.toFixed(2)}</strong></span>
                    </div>
                </div>
                <div class="calculation-info">
                    <small>‚úÖ Precios hist√≥ricos √ó ${employeeCount} empleado${employeeCount !== 1 ? 's' : ''} + IVA 21%</small>
                </div>
            `;

            console.log('üí∞ Resumen actualizado:', { realSubtotal, realTax, realTotal, selectedModules: selectedModules.size });
        }

        function updatePricingSummaryWithHistoricalPrices() {
            if (!currentEditingCompany || !currentEditingCompany.modulesPricing) {
                updatePricingSummary(); // Fallback a precios actuales
                return;
            }
            
            const employeeCount = parseInt(document.getElementById('maxEmployees').value) || 50;
            let subtotal = 0;
            let selectedModulesList = '';
            
            selectedModules.forEach(moduleId => {
                const historicalModule = currentEditingCompany.modulesPricing[moduleId];
                if (historicalModule) {
                    // Usar precio hist√≥rico pero recalcular por empleados actuales
                    const totalPrice = historicalModule.tierPrice * employeeCount;
                    subtotal += totalPrice;
                    
                    selectedModulesList += `
                        <div class="selected-module">
                            <span>${historicalModule.icon} ${historicalModule.name} (hist√≥rico)</span>
                            <span>U$S ${totalPrice.toFixed(2)}</span>
                        </div>
                    `;
                } else {
                    // M√≥dulo nuevo, usar precio actual
                    const module = pricingConfig.modules[moduleId];
                    const tier = getCurrentTier(employeeCount);
                    const price = calculateModulePrice(module.basePrice, tier);
                    const totalPrice = price * employeeCount;
                    subtotal += totalPrice;
                    
                    selectedModulesList += `
                        <div class="selected-module">
                            <span><i class="fas fa-${module.icon || 'cube'}"></i> ${module.name} (nuevo)</span>
                            <span>U$S ${totalPrice.toFixed(2)}</span>
                        </div>
                    `;
                }
            });
            
            const tax = subtotal * pricingConfig.taxRate;
            const total = subtotal + tax;

            console.log('üí∞ Valores calculados - Subtotal:', subtotal, 'Tax:', tax, 'Total:', total);

            const subtotalElement = document.getElementById('subtotal');
            const taxElement = document.getElementById('tax');
            const totalElement = document.getElementById('total');
            const moduleCountElement = document.getElementById('moduleCount');
            const selectedModulesListElement = document.getElementById('selectedModulesList');

            if (subtotalElement) subtotalElement.textContent = subtotal.toFixed(2);
            if (taxElement) taxElement.textContent = tax.toFixed(2);
            if (totalElement) totalElement.textContent = total.toFixed(2);
            if (moduleCountElement) moduleCountElement.textContent = selectedModules.size;
            if (selectedModulesListElement) selectedModulesListElement.innerHTML = selectedModulesList;
            
            // Habilitar bot√≥n guardar siempre
            const saveBtn = document.getElementById('saveCompanyBtn');
            if (saveBtn) {
                saveBtn.disabled = false;
            }
        }

        // Funciones para gesti√≥n de operadores (solo admin)
        function openNewUserModal() {
            if (currentUser.role !== 'administrador') {
                alert('Solo los administradores pueden crear operadores');
                return;
            }

            const modal = document.getElementById('companyModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = modal.querySelector('.modal-body');

            modalTitle.textContent = 'Nuevo Operador';
            modalBody.innerHTML = `
                <form id="userForm">
                    <div class="form-group">
                        <label class="form-label">Usuario *</label>
                        <input type="text" class="form-input" id="newUsername" required placeholder="Nombre de usuario √∫nico">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contrase√±a *</label>
                        <input type="password" class="form-input" id="newPassword" required placeholder="M√≠nimo 6 caracteres">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-input" id="newFirstName" placeholder="Nombre del operador">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Apellido</label>
                        <input type="text" class="form-input" id="newLastName" placeholder="Apellido del operador">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="newEmail" placeholder="Email del operador">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Empresa *</label>
                        <select class="form-input" id="newCompanyId" required>
                            <option value="">Seleccionar empresa...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rol</label>
                        <select class="form-input" id="newRole">
                            <option value="employee">Empleado</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-success" onclick="createOperator()" style="flex: 1;">
                            ‚úÖ Crear Operador
                        </button>
                        <button type="button" class="btn" onclick="closeModal()" style="flex: 1; background: #6c757d; color: white;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </form>
            `;

            // Cargar empresas en el selector
            loadCompaniesForSelector();

            modal.classList.add('show');
        }

        async function loadCompaniesForSelector() {
            try {
                const response = await fetch(`${API_BASE}/companies`);
                const data = await response.json();

                const selector = document.getElementById('newCompanyId');
                if (selector && data.success) {
                    data.companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.company_id;
                        option.textContent = `${company.name} (ID: ${company.company_id})`;
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error cargando empresas:', error);
            }
        }

        async function createOperator() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const firstName = document.getElementById('newFirstName').value.trim();
            const lastName = document.getElementById('newLastName').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const companyId = parseInt(document.getElementById('newCompanyId').value);
            const role = document.getElementById('newRole').value;

            if (!username || !password) {
                alert('Usuario y contrase√±a son requeridos');
                return;
            }

            if (!companyId || isNaN(companyId)) {
                alert('Debe seleccionar una empresa v√°lida');
                return;
            }

            if (password.length < 6) {
                alert('La contrase√±a debe tener al menos 6 caracteres');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/operators`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    },
                    body: JSON.stringify({
                        username,
                        password,
                        firstName: firstName || null,
                        lastName: lastName || null,
                        email: email || null,
                        companyId: companyId,
                        role: role
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert(`‚úÖ Operador "${username}" creado exitosamente`);
                    closeModal();
                    loadOperators();
                } else {
                    alert(data.error || 'Error creando operador');
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }

        async function deleteOperator(operatorId, username) {
            if (!confirm(`¬øEst√° seguro de eliminar al operador "${username}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/operators/${operatorId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert(`‚úÖ Operador "${username}" eliminado exitosamente`);
                    loadOperators();
                } else {
                    alert(data.error || 'Error eliminando operador');
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }

        function editOperator(operatorId) {
            // Funci√≥n para editar operadores (implementar seg√∫n necesidades)
            alert('Funci√≥n de edici√≥n en desarrollo');
        }

        // Funci√≥n para cambiar estado de empresa (solo admin)
        async function changeCompanyStatus(companyId, newStatus, reason = '') {
            if (currentUser.role !== 'administrador') {
                alert('Solo los administradores pueden cambiar el estado de las empresas');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/dashboard/companies/${companyId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    },
                    body: JSON.stringify({ status: newStatus, reason })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert(data.message);
                    loadDashboardData(); // Recargar datos
                } else {
                    alert(data.error || 'Error cambiando estado');
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }

        // Funci√≥n para activar empresa suspendida (solo admin)
        function activateCompany(companyId, companyName) {
            if (currentUser.role !== 'administrador') {
                alert('Solo los administradores pueden activar empresas');
                return;
            }

            if (confirm(`¬øActivar la empresa "${companyName}" aunque tenga pagos pendientes?`)) {
                changeCompanyStatus(companyId, 'active', 'Activada manualmente por administrador');
            }
        }

        // Cerrar modal al hacer clic fuera (solo en el overlay, no en el contenido)
        window.onclick = function(event) {
            const modal = document.getElementById('companyModal');
            const vendorModal = document.getElementById('vendorModal');
            const mapModal = document.getElementById('mapModal');

            // Solo cerrar si el clic es exactamente en el overlay del modal, no en el contenido
            if (event.target === modal) {
                closeCompanyModal();
            } else if (event.target === vendorModal) {
                closeVendorModal();
            } else if (event.target === mapModal) {
                closeMapModal();
            }
        }

        // Prevenir que clics dentro del contenido del modal cierren el modal
        document.addEventListener('DOMContentLoaded', function() {
            // Agregar event listeners para prevenir propagaci√≥n en modal content
            const modalContents = document.querySelectorAll('.modal-content, .vendor-modal-content, .map-modal-content');
            modalContents.forEach(content => {
                content.addEventListener('click', function(event) {
                    event.stopPropagation();
                });

                // Tambi√©n prevenir en inputs y selects dentro del modal
                const inputs = content.querySelectorAll('input, select, textarea, button');
                inputs.forEach(input => {
                    input.addEventListener('click', function(event) {
                        event.stopPropagation();
                    });
                    input.addEventListener('mousedown', function(event) {
                        event.stopPropagation();
                    });
                    input.addEventListener('mouseup', function(event) {
                        event.stopPropagation();
                    });
                });
            });
        });

        // ========================================
        // GESTI√ìN DE SUCURSALES
        // ========================================
        
        let currentCompanyBranches = [];
        let currentEditingBranch = null;
        let branchModal = null;

        // Cargar sucursales de una empresa
        async function loadCompanyBranches(companyId) {
            console.log('üè¢ Cargando sucursales para empresa:', companyId);
            try {
                const response = await fetch(`/api/aponnt/dashboard/branches/${companyId}`);
                console.log('üè¢ Respuesta API sucursales:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    currentCompanyBranches = data.branches || [];
                    console.log('üè¢ Sucursales cargadas:', currentCompanyBranches.length);
                    renderBranchesContainer();
                } else {
                    console.log('üè¢ Error API sucursales:', response.status);
                    currentCompanyBranches = [];
                    renderBranchesContainer();
                }
            } catch (error) {
                console.error('üè¢ Error cargando sucursales:', error);
                currentCompanyBranches = [];
                renderBranchesContainer();
            }
        }

        // Renderizar contenedor de sucursales
        function renderBranchesContainer(retryCount = 0) {
            console.log('üè¢ Renderizando sucursales, cantidad:', currentCompanyBranches.length);
            let container = document.getElementById('branchesContainer');

            if (!container) {
                console.warn('üè¢ Element branchesContainer not found');

                // Buscar la secci√≥n de sucursales padre
                const branchesSection = document.getElementById('branchesSection');
                if (branchesSection) {
                    console.log('üîß Recreando branchesContainer dentro de branchesSection');
                    container = document.createElement('div');
                    container.id = 'branchesContainer';
                    container.style.marginTop = '1rem';
                    branchesSection.appendChild(container);
                } else if (retryCount < 3) {
                    console.log(`üîÑ branchesSection tampoco encontrado, reintentando en 200ms... (intento ${retryCount + 1}/3)`);
                    setTimeout(() => renderBranchesContainer(retryCount + 1), 200);
                    return;
                } else {
                    // Como √∫ltimo recurso, insertar la secci√≥n completa en el modal
                    // PERO SOLO si NO est√° activo el sistema de tabs
                    const modal = document.getElementById('companyModal');
                    if (modal && !modal.classList.contains('tabs-redesign')) {
                        console.log('üö® √öltima opci√≥n: insertando secci√≥n de sucursales completa en el modal');
                        const modalBody = modal.querySelector('.modal-body');
                        if (modalBody) {
                            const branchesHTML = `
                                <div id="branchesSection" style="margin: 2rem 0; padding: 1.5rem; background: #f3e5f5; border-radius: 12px; border: 2px solid #7b1fa2; box-shadow: 0 4px 8px rgba(123, 31, 162, 0.2);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                        <h4 style="color: #7b1fa2; margin: 0; font-size: 1.2rem; font-weight: 600;">üè¢ Gesti√≥n de Sucursales</h4>
                                        <button type="button" class="btn btn-primary" onclick="openBranchModal()" style="background: #7b1fa2; border-color: #7b1fa2;">
                                            <i class="fas fa-plus"></i> Nueva Sucursal
                                        </button>
                                    </div>
                                    <div id="branchesContainer" style="margin-top: 1rem;">
                                    </div>
                                </div>
                            `;
                            modalBody.insertAdjacentHTML('beforeend', branchesHTML);
                            container = document.getElementById('branchesContainer');
                        }
                    } else if (modal && modal.classList.contains('tabs-redesign')) {
                        console.log('‚úÖ Sistema de tabs activo, usando branchesTableBody en Tab Sucursales');
                        // Con tabs, buscar el container espec√≠fico del tab de sucursales
                        container = document.getElementById('branchesTableBody');
                    }

                    if (!container) {
                        console.error('‚ùå No se pudo crear branchesContainer despu√©s de todos los intentos');
                        return;
                    }
                }
            }

            console.log('üè¢ Container encontrado/creado, renderizando...');

            // Detectar si estamos usando el sistema de tabs (tabla) o el modal cl√°sico (cards)
            const isTabsMode = container.id === 'branchesTableBody';

            if (currentCompanyBranches.length === 0) {
                if (isTabsMode) {
                    // Formato tabla para tabs
                    container.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #95a5a6;">
                                No hay sucursales registradas
                            </td>
                        </tr>
                    `;
                } else {
                    // Formato card para modal cl√°sico
                    container.innerHTML = `
                        <div class="no-branches" style="text-align: center; color: #666; padding: 1rem;">
                            No hay sucursales registradas
                        </div>
                    `;
                }
                return;
            }

            let html;

            if (isTabsMode) {
                // Formato TABLA para sistema de tabs
                html = currentCompanyBranches.map(branch => `
                    <tr>
                        <td>${branch.name}</td>
                        <td>${branch.address}</td>
                        <td>${branch.city}, ${branch.province}</td>
                        <td><span class="badge badge-success">Activa</span></td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="editBranch(${branch.id})">
                                ‚úèÔ∏è Editar
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteBranch(${branch.id})">
                                üóëÔ∏è Eliminar
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                // Formato CARD para modal cl√°sico
                html = currentCompanyBranches.map(branch => `
                    <div class="branch-item" style="
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 0.75rem;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        margin-bottom: 0.5rem;
                        background: white;
                    ">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #333;">${branch.name}</div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                üìç ${branch.address}, ${branch.city}, ${branch.province}, ${branch.country}
                            </div>
                            ${branch.latitude && branch.longitude ?
                                `<div style="font-size: 0.7rem; color: #999; margin-top: 0.25rem;">
                                    üåê ${branch.latitude.toFixed(6)}, ${branch.longitude.toFixed(6)}
                                </div>` : ''
                            }
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="editBranch(${branch.id})" style="font-size: 0.7rem;">
                                ‚úèÔ∏è Editar
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteBranch(${branch.id})" style="font-size: 0.7rem;">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            container.innerHTML = html;
        }

        // Abrir modal de sucursal
        function openBranchModal(branchId = null) {
            currentEditingBranch = branchId ? currentCompanyBranches.find(b => b.id === branchId) : null;
            
            const modalHtml = `
                <div id="branchModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 600px; margin: 2% auto; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h4>${currentEditingBranch ? 'Editar Sucursal' : 'Nueva Sucursal'}</h4>
                            <span class="close" onclick="closeBranchModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <form id="branchForm" onsubmit="saveBranch(event)">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Nombre de la Sucursal *</label>
                                        <input type="text" id="branchName" class="form-control" required 
                                               value="${currentEditingBranch ? currentEditingBranch.name : ''}"
                                               placeholder="Ej: Sucursal Centro, Oficina Norte">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label>Direcci√≥n *</label>
                                        <input type="text" id="branchAddress" class="form-control" required 
                                               value="${currentEditingBranch ? currentEditingBranch.address : ''}"
                                               placeholder="Calle y n√∫mero"
                                               onchange="handleAddressChange()">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>C√≥digo Postal</label>
                                        <input type="text" id="branchPostalCode" class="form-control" 
                                               value="${currentEditingBranch ? (currentEditingBranch.postalCode || '') : ''}"
                                               placeholder="1000">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Pa√≠s *</label>
                                        <select id="branchCountry" class="form-control" required onchange="loadBranchProvinces()">
                                            <option value="">Seleccionar pa√≠s</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Provincia/Estado *</label>
                                        <select id="branchProvince" class="form-control" required onchange="loadBranchCities()">
                                            <option value="">Seleccionar provincia</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Ciudad *</label>
                                        <select id="branchCity" class="form-control" required onchange="handleCityChange()">
                                            <option value="">Seleccionar ciudad</option>
                                        </select>
                                    </div>
                                </div>

                                <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 6px;">
                                    <h6 style="color: #495057; margin-bottom: 0.75rem;">üåê Geolocalizaci√≥n</h6>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Latitud</label>
                                            <input type="number" id="branchLatitude" class="form-control" step="any" 
                                                   value="${currentEditingBranch ? (currentEditingBranch.latitude || '') : ''}"
                                                   placeholder="Ej: -34.6037">
                                        </div>
                                        <div class="form-group">
                                            <label>Longitud</label>
                                            <input type="number" id="branchLongitude" class="form-control" step="any"
                                                   value="${currentEditingBranch ? (currentEditingBranch.longitude || '') : ''}"
                                                   placeholder="Ej: -58.3816">
                                        </div>
                                    </div>
                                    <div style="text-align: center; margin-top: 0.75rem;">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="geocodeBranchAddress()">
                                            üìç Obtener coordenadas autom√°ticamente
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="showBranchMap()" style="margin-left: 0.5rem;">
                                            üó∫Ô∏è Ver en mapa
                                        </button>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #6c757d; margin-top: 0.5rem; text-align: center;">
                                        Las coordenadas se pueden obtener autom√°ticamente desde la direcci√≥n o ingresar manualmente
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Tel√©fono</label>
                                        <input type="text" id="branchPhone" class="form-control" 
                                               value="${currentEditingBranch ? (currentEditingBranch.phone || '') : ''}"
                                               placeholder="011-1234-5678">
                                    </div>
                                    <div class="form-group">
                                        <label>Email</label>
                                        <input type="email" id="branchEmail" class="form-control" 
                                               value="${currentEditingBranch ? (currentEditingBranch.email || '') : ''}"
                                               placeholder="sucursal@empresa.com">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="branchIsActive" 
                                               ${currentEditingBranch ? (currentEditingBranch.isActive ? 'checked' : '') : 'checked'}>
                                        <span>Sucursal activa</span>
                                    </label>
                                </div>

                                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                                        ${currentEditingBranch ? '‚úèÔ∏è Actualizar Sucursal' : 'üíæ Crear Sucursal'}
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="closeBranchModal()" style="flex: 0 0 auto;">
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            // Remover modal existente si existe
            if (branchModal) {
                branchModal.remove();
            }

            // Crear nuevo modal
            branchModal = document.createElement('div');
            branchModal.innerHTML = modalHtml;
            document.body.appendChild(branchModal);

            // Cargar datos geogr√°ficos
            loadBranchCountries();
        }

        // Cerrar modal de sucursal
        function closeBranchModal() {
            if (branchModal) {
                branchModal.remove();
                branchModal = null;
            }
            currentEditingBranch = null;
        }

        // Cargar pa√≠ses para sucursales
        function loadBranchCountries() {
            const countrySelect = document.getElementById('branchCountry');
            if (!countrySelect) return;

            const countries = Object.keys(geographicalData);
            countrySelect.innerHTML = '<option value="">Seleccionar pa√≠s</option>';
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });

            // Seleccionar pa√≠s actual si existe
            if (currentEditingBranch && currentEditingBranch.country) {
                countrySelect.value = currentEditingBranch.country;
                loadBranchProvinces();
            } else {
                countrySelect.value = 'Argentina'; // Por defecto
                loadBranchProvinces();
            }
        }

        // Cargar provincias para sucursales
        function loadBranchProvinces() {
            const countrySelect = document.getElementById('branchCountry');
            const provinceSelect = document.getElementById('branchProvince');
            if (!countrySelect || !provinceSelect) return;

            const selectedCountry = countrySelect.value;
            provinceSelect.innerHTML = '<option value="">Seleccionar provincia</option>';
            
            if (selectedCountry && geographicalData[selectedCountry]) {
                const provinces = Object.keys(geographicalData[selectedCountry]);
                provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    provinceSelect.appendChild(option);
                });

                // Seleccionar provincia actual si existe
                if (currentEditingBranch && currentEditingBranch.province) {
                    provinceSelect.value = currentEditingBranch.province;
                    loadBranchCities();
                }
            }
        }

        // Cargar ciudades para sucursales
        function loadBranchCities() {
            const countrySelect = document.getElementById('branchCountry');
            const provinceSelect = document.getElementById('branchProvince');
            const citySelect = document.getElementById('branchCity');
            if (!countrySelect || !provinceSelect || !citySelect) return;

            const selectedCountry = countrySelect.value;
            const selectedProvince = provinceSelect.value;
            citySelect.innerHTML = '<option value="">Seleccionar ciudad</option>';
            
            if (selectedCountry && selectedProvince && 
                geographicalData[selectedCountry] && 
                geographicalData[selectedCountry][selectedProvince]) {
                
                const cities = geographicalData[selectedCountry][selectedProvince];
                Object.keys(cities).forEach(cityName => {
                    const option = document.createElement('option');
                    option.value = cityName;
                    option.textContent = cityName;
                    option.dataset.postalCode = cities[cityName];
                    citySelect.appendChild(option);
                });

                // Seleccionar ciudad actual si existe
                if (currentEditingBranch && currentEditingBranch.city) {
                    citySelect.value = currentEditingBranch.city;
                }
            }
        }

        // Manejar cambio de ciudad para sucursales
        function handleCityChange() {
            const citySelect = document.getElementById('branchCity');
            const postalCodeInput = document.getElementById('branchPostalCode');
            if (!citySelect || !postalCodeInput) return;

            const selectedOption = citySelect.options[citySelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.postalCode) {
                postalCodeInput.value = selectedOption.dataset.postalCode;
            }
        }

        // Manejar cambio de direcci√≥n
        function handleAddressChange() {
            // Limpiar coordenadas cuando cambia la direcci√≥n
            document.getElementById('branchLatitude').value = '';
            document.getElementById('branchLongitude').value = '';
        }

        // Funci√≥n para validar que la provincia pertenezca al pa√≠s seleccionado
        function validateProvinceForCountry(country, province) {
            // Definir provincias v√°lidas por pa√≠s (principales pa√≠ses de Am√©rica Latina)
            const provincesByCountry = {
                'Argentina': [
                    'Buenos Aires', 'Ciudad Aut√≥noma de Buenos Aires', 'Catamarca', 'Chaco', 'Chubut',
                    'C√≥rdoba', 'Corrientes', 'Entre R√≠os', 'Formosa', 'Jujuy', 'La Pampa', 'La Rioja',
                    'Mendoza', 'Misiones', 'Neuqu√©n', 'R√≠o Negro', 'Salta', 'San Juan', 'San Luis',
                    'Santa Cruz', 'Santa Fe', 'Santiago del Estero', 'Tierra del Fuego', 'Tucum√°n'
                ],
                'Brasil': [
                    'Acre', 'Alagoas', 'Amap√°', 'Amazonas', 'Bahia', 'Cear√°', 'Distrito Federal',
                    'Esp√≠rito Santo', 'Goi√°s', 'Maranh√£o', 'Mato Grosso', 'Mato Grosso do Sul',
                    'Minas Gerais', 'Par√°', 'Para√≠ba', 'Paran√°', 'Pernambuco', 'Piau√≠',
                    'Rio de Janeiro', 'Rio Grande do Norte', 'Rio Grande do Sul', 'Rond√¥nia',
                    'Roraima', 'Santa Catarina', 'S√£o Paulo', 'Sergipe', 'Tocantins'
                ],
                'Chile': [
                    'Arica y Parinacota', 'Tarapac√°', 'Antofagasta', 'Atacama', 'Coquimbo',
                    'Valpara√≠so', 'Metropolitana de Santiago', 'O\'Higgins', 'Maule', '√ëuble',
                    'Biob√≠o', 'La Araucan√≠a', 'Los R√≠os', 'Los Lagos', 'Ays√©n', 'Magallanes'
                ],
                'Colombia': [
                    'Amazonas', 'Antioquia', 'Arauca', 'Atl√°ntico', 'Bol√≠var', 'Boyac√°', 'Caldas',
                    'Caquet√°', 'Casanare', 'Cauca', 'Cesar', 'Choc√≥', 'C√≥rdoba', 'Cundinamarca',
                    'Guain√≠a', 'Guaviare', 'Huila', 'La Guajira', 'Magdalena', 'Meta', 'Nari√±o',
                    'Norte de Santander', 'Putumayo', 'Quind√≠o', 'Risaralda', 'San Andr√©s',
                    'Santander', 'Sucre', 'Tolima', 'Valle del Cauca', 'Vaup√©s', 'Vichada'
                ],
                'M√©xico': [
                    'Aguascalientes', 'Baja California', 'Baja California Sur', 'Campeche', 'Chiapas',
                    'Chihuahua', 'Ciudad de M√©xico', 'Coahuila', 'Colima', 'Durango', 'Guanajuato',
                    'Guerrero', 'Hidalgo', 'Jalisco', 'M√©xico', 'Michoac√°n', 'Morelos', 'Nayarit',
                    'Nuevo Le√≥n', 'Oaxaca', 'Puebla', 'Quer√©taro', 'Quintana Roo', 'San Luis Potos√≠',
                    'Sinaloa', 'Sonora', 'Tabasco', 'Tamaulipas', 'Tlaxcala', 'Veracruz', 'Yucat√°n', 'Zacatecas'
                ],
                'Per√∫': [
                    'Amazonas', '√Åncash', 'Apur√≠mac', 'Arequipa', 'Ayacucho', 'Cajamarca', 'Callao',
                    'Cusco', 'Huancavelica', 'Hu√°nuco', 'Ica', 'Jun√≠n', 'La Libertad', 'Lambayeque',
                    'Lima', 'Loreto', 'Madre de Dios', 'Moquegua', 'Pasco', 'Piura', 'Puno',
                    'San Mart√≠n', 'Tacna', 'Tumbes', 'Ucayali'
                ],
                'Espa√±a': [
                    'Andaluc√≠a', 'Arag√≥n', 'Asturias', 'Baleares', 'Canarias', 'Cantabria',
                    'Castilla-La Mancha', 'Castilla y Le√≥n', 'Catalu√±a', 'Extremadura', 'Galicia',
                    'La Rioja', 'Madrid', 'Murcia', 'Navarra', 'Pa√≠s Vasco', 'Valencia'
                ]
            };

            // Si no tenemos datos del pa√≠s, permitir cualquier provincia (para pa√≠ses no listados)
            if (!provincesByCountry[country]) {
                return true;
            }

            // Verificar si la provincia est√° en la lista del pa√≠s
            const validProvinces = provincesByCountry[country];

            // Buscar coincidencia exacta o parcial (para manejar variaciones en escritura)
            return validProvinces.some(validProvince =>
                validProvince.toLowerCase() === province.toLowerCase() ||
                validProvince.toLowerCase().includes(province.toLowerCase()) ||
                province.toLowerCase().includes(validProvince.toLowerCase())
            );
        }

        // Geocodificar direcci√≥n de sucursal
        async function geocodeBranchAddress() {
            const address = document.getElementById('branchAddress').value?.trim();
            const city = document.getElementById('branchCity').value?.trim();
            const province = document.getElementById('branchProvince').value?.trim();
            const country = document.getElementById('branchCountry').value?.trim();

            console.log('üè¢ Datos ingresados para sucursal:', { address, city, province, country });

            // Validaci√≥n m√°s estricta de campos
            const missingFields = [];
            if (!address) missingFields.push('Direcci√≥n');
            if (!city) missingFields.push('Ciudad');
            if (!province) missingFields.push('Provincia/Estado');
            if (!country) missingFields.push('Pa√≠s');

            if (missingFields.length > 0) {
                showNotification(`‚ùå Faltan campos requeridos: ${missingFields.join(', ')}`, 'error');
                return;
            }

            // Validaci√≥n b√°sica de formato
            if (address.length < 3) {
                showNotification('‚ùå La direcci√≥n debe tener al menos 3 caracteres', 'error');
                return;
            }

            if (city.length < 2) {
                showNotification('‚ùå La ciudad debe tener al menos 2 caracteres', 'error');
                return;
            }

            // Validar que la provincia est√© en el pa√≠s seleccionado
            if (!validateProvinceForCountry(country, province)) {
                showNotification(`‚ùå La provincia "${province}" no pertenece a ${country}. Verifique la selecci√≥n.`, 'error');
                return;
            }

            const fullAddress = `${address}, ${city}, ${province}, ${country}`;
            
            showNotification('üåç Obteniendo coordenadas...', 'info');

            try {
                const response = await fetch('/api/aponnt/dashboard/branches/geocode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        address: address,
                        city: city,
                        province: province,
                        country: country
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.coordinates) {
                        document.getElementById('branchLatitude').value = data.coordinates.latitude;
                        document.getElementById('branchLongitude').value = data.coordinates.longitude;

                        showNotification(`‚úÖ ${data.message}`, 'success');

                        console.log('üìç Coordenadas obtenidas:', data.coordinates);
                    } else {
                        // Mostrar el mensaje espec√≠fico de error del backend
                        showNotification(`‚ùå ${data.message || data.error || 'No se pudieron obtener las coordenadas'}`, 'error');
                    }
                } else {
                    // Manejar errores HTTP
                    const errorData = await response.json().catch(() => ({}));
                    showNotification(`‚ùå ${errorData.message || 'Error en el servicio de geolocalizaci√≥n'}`, 'error');
                }
            } catch (error) {
                console.error('Error geocodificando:', error);
                showNotification('‚ùå Error al obtener coordenadas', 'error');
            }
        }

        // Geolocalizar direcci√≥n de empresa
        async function geocodeCompanyAddress() {
            console.log('üåç Iniciando geolocalizaci√≥n de empresa...');

            const address = document.getElementById('address').value?.trim();
            const city = document.getElementById('city').value?.trim();
            const province = document.getElementById('province').value?.trim();
            const country = document.getElementById('country').value?.trim() || 'Argentina';

            // Validaci√≥n exhaustiva con mensajes espec√≠ficos
            const missingFields = [];
            if (!address) missingFields.push('Direcci√≥n (Ej: Av. Corrientes 1000)');
            if (!city) missingFields.push('Ciudad (Ej: Buenos Aires)');
            if (!province) missingFields.push('Provincia/Estado');

            if (missingFields.length > 0) {
                const message = `‚ùå CAMPOS REQUERIDOS PARA GEOLOCALIZACI√ìN:\n\n${missingFields.join('\n')}\n\nESTOS DATOS SON OBLIGATORIOS para que la APK Android pueda ubicar la empresa correctamente.`;
                alert(message);
                return;
            }

            // Validar formato de direcci√≥n
            if (address.length < 5) {
                alert('‚ùå DIRECCI√ìN INCOMPLETA\n\nLa direcci√≥n debe ser m√°s espec√≠fica.\nEjemplo: "Av. Corrientes 1000" o "San Mart√≠n 123"');
                document.getElementById('address').focus();
                return;
            }

            const fullAddress = `${address}, ${city}, ${province}, ${country}`;
            console.log('üåç Direcci√≥n completa a geolocalizar:', fullAddress);

            // Mostrar mensaje de progreso
            const progressMessage = `üåç OBTENIENDO COORDENADAS GPS...\n\nDirecci√≥n: ${fullAddress}\n\nEspere por favor...`;
            console.log(progressMessage);

            try {
                const response = await fetch('/api/aponnt/dashboard/geocode-company', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: address,
                        city: city,
                        province: province,
                        country: country
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.coordinates) {
                        document.getElementById('companyLatitude').value = data.coordinates.latitude;
                        document.getElementById('companyLongitude').value = data.coordinates.longitude;

                        const successMessage = `‚úÖ COORDENADAS GPS OBTENIDAS EXITOSAMENTE\n\nLatitud: ${data.coordinates.latitude}\nLongitud: ${data.coordinates.longitude}\n\nLa APK Android podr√° ubicar esta empresa correctamente.`;
                        alert(successMessage);

                        console.log('üìç Coordenadas de empresa obtenidas:', data.coordinates);
                    } else {
                        // Error espec√≠fico del servicio
                        const errorMessage = `‚ùå NO SE PUDO GEOLOCALIZAR LA DIRECCI√ìN\n\n${data.message || data.error || 'Direcci√≥n no encontrada'}\n\nVERIFIQUE QUE LA DIRECCI√ìN SEA CORRECTA:\n‚Ä¢ Use formato: "Calle N√∫mero"\n‚Ä¢ Ciudad existente\n‚Ä¢ Provincia correcta\n\nEjemplo v√°lido: "Av. Corrientes 1000, Buenos Aires, CABA"`;
                        alert(errorMessage);
                    }
                } else {
                    // Error HTTP
                    const errorData = await response.json().catch(() => ({}));
                    const httpErrorMessage = `‚ùå ERROR EN SERVICIO DE GEOLOCALIZACI√ìN\n\n${errorData.message || 'Error interno del servidor'}\n\nIntente nuevamente en unos momentos.`;
                    alert(httpErrorMessage);
                }
            } catch (error) {
                console.error('‚ùå Error geocodificando empresa:', error);
                const networkErrorMessage = `‚ùå ERROR DE CONEXI√ìN\n\nNo se pudo conectar al servicio de geolocalizaci√≥n.\n\nVerifique su conexi√≥n a internet e intente nuevamente.`;
                alert(networkErrorMessage);
            }
        }

        // Function to validate company address before geocoding
        async function validateAndGeocodeCompanyAddress(address, city, province, country) {
            // Validaci√≥n b√°sica de formato
            if (address.length < 3) {
                showNotification('‚ùå La direcci√≥n de la empresa debe tener al menos 3 caracteres', 'error');
                return;
            }

            if (city.length < 2) {
                showNotification('‚ùå La ciudad debe tener al menos 2 caracteres', 'error');
                return;
            }

            // Validar que la provincia est√© en el pa√≠s seleccionado
            if (!validateProvinceForCountry(country, province)) {
                showNotification(`‚ùå La provincia "${province}" no pertenece a ${country}. Verifique la selecci√≥n.`, 'error');
                return;
            }

            const fullAddress = `${address}, ${city}, ${province}, ${country}`;

            showNotification('üåç Obteniendo coordenadas de la empresa...', 'info');

            try {
                const response = await fetch('/api/aponnt/dashboard/branches/geocode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        address: address,
                        city: city,
                        province: province,
                        country: country
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.coordinates) {
                        document.getElementById('companyLatitude').value = data.coordinates.latitude;
                        document.getElementById('companyLongitude').value = data.coordinates.longitude;

                        showNotification(`‚úÖ Coordenadas de empresa obtenidas: ${data.message}`, 'success');

                        console.log('üìç Coordenadas de empresa obtenidas:', data.coordinates);
                    } else {
                        // Mostrar el mensaje espec√≠fico de error del backend
                        showNotification(`‚ùå ${data.message || data.error || 'No se pudieron obtener las coordenadas de la empresa'}`, 'error');
                    }
                } else {
                    // Manejar errores HTTP
                    const errorData = await response.json().catch(() => ({}));
                    showNotification(`‚ùå ${errorData.message || 'Error en el servicio de geolocalizaci√≥n'}`, 'error');
                }
            } catch (error) {
                console.error('Error geocodificando empresa:', error);
                showNotification('‚ùå Error al obtener coordenadas de empresa', 'error');
            }
        }

        // Mostrar mapa de empresa
        function showCompanyMap() {
            const latitude = document.getElementById('companyLatitude').value;
            const longitude = document.getElementById('companyLongitude').value;
            const companyName = document.getElementById('companyName').value || 'Empresa';
            const address = document.getElementById('address').value || 'Direcci√≥n no especificada';

            if (!latitude || !longitude) {
                showNotification('‚ÑπÔ∏è **IMPORTANTE:** Para abrir el mapa interactivo, primero debe geolocalizar la direcci√≥n de la empresa usando el bot√≥n "üåç Geolocalizar". Las coordenadas precisas son fundamentales para el correcto funcionamiento del fichaje de empleados.', 'info');
                return;
            }

            showMapModal(parseFloat(latitude), parseFloat(longitude), companyName, address, 'empresa');
        }

        // Mostrar mapa de sucursal
        function showBranchMap() {
            const latitude = document.getElementById('branchLatitude').value;
            const longitude = document.getElementById('branchLongitude').value;
            const branchName = document.getElementById('branchName').value || 'Sucursal';
            const address = document.getElementById('branchAddress').value || 'Direcci√≥n no especificada';

            if (!latitude || !longitude) {
                showNotification('‚ÑπÔ∏è **IMPORTANTE:** Para abrir el mapa interactivo, primero debe geolocalizar la direcci√≥n de la sucursal usando el bot√≥n "üåç Geolocalizar". Las coordenadas precisas son fundamentales para el correcto funcionamiento del fichaje de empleados.', 'info');
                return;
            }

            showMapModal(parseFloat(latitude), parseFloat(longitude), branchName, address, 'sucursal');
        }

        // Mostrar modal con mapa interactivo mejorado
        function showMapModal(lat, lng, name, address, type) {
            // Verificar que Leaflet est√© disponible
            if (typeof L === 'undefined') {
                showNotification('‚ùå Error: Librer√≠a de mapas no disponible. Recargue la p√°gina e intente nuevamente.', 'error');
                return;
            }

            const modalHtml = `
                <div id="mapModal" class="modal" style="display: block; z-index: 10000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
                    <div class="modal-content" style="max-width: 900px; margin: 1% auto; height: 90vh; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative;">
                        <div class="modal-header" style="padding: 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <h4 style="margin: 0;">üó∫Ô∏è Ubicaci√≥n de ${type}: ${name}</h4>
                            <span class="close" onclick="closeMapModal()" style="cursor: pointer; font-size: 1.5rem; padding: 5px; hover: color: red;">&times;</span>
                        </div>
                        <div class="modal-search" style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #eee;">
                            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                                <input type="text" id="mapSearchInput" placeholder="üîç Buscar direcci√≥n en el mapa..."
                                       style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                <button onclick="searchLocationOnMap()" style="padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    üîç Buscar
                                </button>
                            </div>
                            <div style="font-size: 0.8rem; color: #666;">
                                üí° <strong>Instrucciones:</strong> Puede buscar una direcci√≥n arriba O hacer clic directamente en el mapa para seleccionar una nueva ubicaci√≥n
                            </div>
                        </div>
                        <div class="modal-body" style="padding: 0; height: calc(100% - 180px); position: relative;">
                            <div id="leafletMap" style="height: 100%; width: 100%; z-index: 1;"></div>
                        </div>
                        <div class="modal-footer" style="padding: 1rem; background: #f8f9fa; border-top: 1px solid #eee;">
                            <div id="mapCurrentLocation" style="margin-bottom: 0.5rem;">
                                <p style="margin: 0; color: #666; font-size: 0.9rem;">üìç <span id="mapCurrentAddress">${address}</span></p>
                                <p style="margin: 0; color: #999; font-size: 0.8rem;">Coordenadas: <span id="mapCurrentCoords">${lat.toFixed(6)}, ${lng.toFixed(6)}</span></p>
                            </div>
                            <div style="text-align: center;">
                                <button id="useSelectedLocationBtn" onclick="useSelectedLocation()"
                                        style="padding: 0.5rem 1rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;"
                                        disabled>
                                    ‚úÖ Usar Esta Ubicaci√≥n
                                </button>
                                <button onclick="closeMapModal()"
                                        style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remover modal existente si existe
            const existingModal = document.getElementById('mapModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Crear nuevo modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            console.log(`üó∫Ô∏è Iniciando mapa interactivo para ${type}: ${name} en ${lat}, ${lng}`);

            // Variables globales para el mapa interactivo
            window.currentMapInstance = null;
            window.currentMapMarker = null;
            window.selectedMapLocation = { lat: lat, lng: lng, address: address, type: type };

            // Inicializar mapa despu√©s de que el modal est√© en el DOM
            setTimeout(() => {
                try {
                    const mapContainer = document.getElementById('leafletMap');
                    if (!mapContainer) {
                        throw new Error('Contenedor del mapa no encontrado');
                    }

                    console.log('üó∫Ô∏è Creando instancia de Leaflet interactivo...');

                    const map = L.map('leafletMap', {
                        center: [lat, lng],
                        zoom: 16,
                        zoomControl: true,
                        scrollWheelZoom: true
                    });

                    console.log('üó∫Ô∏è Agregando capa de tiles...');

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 19
                    }).addTo(map);

                    console.log('üó∫Ô∏è Agregando marcador arrastrable...');

                    // Agregar marcador arrastrable
                    const marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                    marker.bindPopup(`<b>${name}</b><br>${address}`).openPopup();

                    // Almacenar referencias globales
                    window.currentMapInstance = map;
                    window.currentMapMarker = marker;

                    // Eventos del marcador arrastrable
                    marker.on('dragend', async function(e) {
                        const newPos = e.target.getLatLng();
                        console.log('üîÑ Marcador movido a:', newPos.lat, newPos.lng);
                        await updateLocationFromCoordinates(newPos.lat, newPos.lng);
                    });

                    // Evento de clic en el mapa para mover el marcador
                    map.on('click', async function(e) {
                        const newPos = e.latlng;
                        console.log('üëÜ Clic en mapa:', newPos.lat, newPos.lng);

                        // Mover marcador a la nueva posici√≥n
                        marker.setLatLng(newPos);
                        map.panTo(newPos);

                        await updateLocationFromCoordinates(newPos.lat, newPos.lng);
                    });

                    // Hacer que el mapa responda a cambios de tama√±o
                    setTimeout(() => {
                        map.invalidateSize();
                        console.log('üó∫Ô∏è Mapa interactivo inicializado correctamente');
                        showNotification('‚úÖ Mapa interactivo cargado. Haga clic para seleccionar nueva ubicaci√≥n', 'success');
                    }, 200);

                } catch (error) {
                    console.error('‚ùå Error inicializando mapa:', error);
                    showNotification(`‚ùå Error al cargar el mapa: ${error.message}`, 'error');
                    closeMapModal();
                }
            }, 300);
        }

        // Cerrar modal de mapa
        function closeMapModal() {
            try {
                const modal = document.getElementById('mapModal');
                if (modal) {
                    // Limpiar instancia del mapa si existe
                    const mapContainer = document.getElementById('leafletMap');
                    if (mapContainer && mapContainer._leaflet_id) {
                        const map = mapContainer._leaflet_id;
                        if (window.L && window.L.DomUtil) {
                            window.L.DomUtil.get(mapContainer._leaflet_id).remove();
                        }
                    }

                    modal.remove();
                    console.log('üó∫Ô∏è Modal del mapa cerrado correctamente');
                }
            } catch (error) {
                console.error('Error cerrando modal del mapa:', error);
                // Forzar eliminaci√≥n del modal
                const modal = document.getElementById('mapModal');
                if (modal) {
                    modal.remove();
                }
            }
        }

        // Actualizar ubicaci√≥n basada en coordenadas (geocodificaci√≥n inversa)
        async function updateLocationFromCoordinates(lat, lng) {
            try {
                console.log(`üîÑ Obteniendo direcci√≥n para coordenadas: ${lat}, ${lng}`);
                showNotification('üåç Obteniendo direcci√≥n de la ubicaci√≥n seleccionada...', 'info');

                // Usar Nominatim para geocodificaci√≥n inversa
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`, {
                    headers: {
                        'User-Agent': 'Sistema-Biometrico-Empresarial/1.0'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    let addressString = 'Direcci√≥n no disponible';

                    if (data && data.address) {
                        const addr = data.address;
                        const parts = [];

                        // Construir direcci√≥n ordenada
                        if (addr.house_number) parts.push(addr.house_number);
                        if (addr.road) parts.push(addr.road);
                        if (addr.city || addr.town || addr.village) parts.push(addr.city || addr.town || addr.village);
                        if (addr.state) parts.push(addr.state);
                        if (addr.country) parts.push(addr.country);

                        addressString = parts.length > 0 ? parts.join(', ') : data.display_name;
                    }

                    // Actualizar informaci√≥n en el modal - GUARDAMOS TODOS LOS DATOS
                    window.selectedMapLocation = {
                        lat: lat,
                        lng: lng,
                        address: addressString,
                        fullAddressData: data, // üî• IMPORTANTE: Guardamos toda la respuesta de OpenStreetMap
                        type: window.selectedMapLocation?.type || 'ubicaci√≥n'
                    };

                    // Actualizar elementos del DOM
                    const addressElement = document.getElementById('mapCurrentAddress');
                    const coordsElement = document.getElementById('mapCurrentCoords');
                    const useLocationBtn = document.getElementById('useSelectedLocationBtn');

                    if (addressElement) {
                        addressElement.textContent = addressString;
                    }
                    if (coordsElement) {
                        coordsElement.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    }
                    if (useLocationBtn) {
                        useLocationBtn.disabled = false;
                        useLocationBtn.style.background = '#28a745';
                    }

                    // Actualizar popup del marcador
                    if (window.currentMapMarker) {
                        window.currentMapMarker.bindPopup(`<b>Nueva ubicaci√≥n seleccionada</b><br>${addressString}`).openPopup();
                    }

                    showNotification('‚úÖ Direcci√≥n obtenida exitosamente', 'success');
                    console.log('‚úÖ Direcci√≥n obtenida:', addressString);

                } else {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

            } catch (error) {
                console.error('‚ùå Error obteniendo direcci√≥n:', error);

                // Actualizar con coordenadas solamente
                window.selectedMapLocation = {
                    lat: lat,
                    lng: lng,
                    address: `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                    type: window.selectedMapLocation?.type || 'ubicaci√≥n'
                };

                const addressElement = document.getElementById('mapCurrentAddress');
                const coordsElement = document.getElementById('mapCurrentCoords');
                const useLocationBtn = document.getElementById('useSelectedLocationBtn');

                if (addressElement) {
                    addressElement.textContent = `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }
                if (coordsElement) {
                    coordsElement.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }
                if (useLocationBtn) {
                    useLocationBtn.disabled = false;
                    useLocationBtn.style.background = '#28a745';
                }

                showNotification('‚ö†Ô∏è No se pudo obtener la direcci√≥n, pero las coordenadas est√°n disponibles', 'warning');
            }
        }

        // Buscar ubicaci√≥n en el mapa
        async function searchLocationOnMap() {
            const searchInput = document.getElementById('mapSearchInput');
            const searchQuery = searchInput.value.trim();

            if (!searchQuery) {
                showNotification('‚ö†Ô∏è Ingrese una direcci√≥n para buscar', 'warning');
                return;
            }

            try {
                console.log(`üîç Buscando: ${searchQuery}`);
                showNotification('üîç Buscando ubicaci√≥n en el mapa...', 'info');

                // Usar Nominatim para b√∫squeda de direcciones
                const encodedQuery = encodeURIComponent(searchQuery);
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedQuery}&limit=1&addressdetails=1`, {
                    headers: {
                        'User-Agent': 'Sistema-Biometrico-Empresarial/1.0'
                    }
                });

                if (response.ok) {
                    const data = await response.json();

                    if (data && data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lng = parseFloat(result.lon);

                        console.log(`‚úÖ Ubicaci√≥n encontrada: ${lat}, ${lng}`);

                        // Mover mapa y marcador a la nueva ubicaci√≥n
                        if (window.currentMapInstance && window.currentMapMarker) {
                            window.currentMapInstance.setView([lat, lng], 16);
                            window.currentMapMarker.setLatLng([lat, lng]);

                            // Actualizar informaci√≥n de ubicaci√≥n
                            await updateLocationFromCoordinates(lat, lng);
                        }

                        showNotification('‚úÖ Ubicaci√≥n encontrada en el mapa', 'success');

                        // Limpiar input de b√∫squeda
                        searchInput.value = '';

                    } else {
                        throw new Error('No se encontraron resultados para la b√∫squeda');
                    }

                } else {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

            } catch (error) {
                console.error('‚ùå Error en b√∫squeda:', error);
                showNotification(`‚ùå Error buscando ubicaci√≥n: ${error.message}`, 'error');
            }
        }

        // Usar la ubicaci√≥n seleccionada en el mapa
        function useSelectedLocation() {
            if (!window.selectedMapLocation) {
                showNotification('‚ö†Ô∏è No hay ubicaci√≥n seleccionada', 'warning');
                return;
            }

            const location = window.selectedMapLocation;
            console.log('‚úÖ Usando ubicaci√≥n seleccionada:', location);

            try {
                // Determinar si es empresa o sucursal y actualizar campos correspondientes
                if (location.type === 'empresa') {
                    // Actualizar campos de empresa
                    const latField = document.getElementById('companyLatitude');
                    const lngField = document.getElementById('companyLongitude');

                    if (latField) latField.value = location.lat.toFixed(6);
                    if (lngField) lngField.value = location.lng.toFixed(6);

                    // Actualizar direcci√≥n con datos completos de OpenStreetMap
                    if (location.address && location.address !== 'Direcci√≥n no disponible') {
                        updateCompanyAddressFields(location.address, location.fullAddressData);
                    }

                } else if (location.type === 'sucursal') {
                    // Actualizar campos de sucursal
                    const latField = document.getElementById('branchLatitude');
                    const lngField = document.getElementById('branchLongitude');

                    if (latField) latField.value = location.lat.toFixed(6);
                    if (lngField) lngField.value = location.lng.toFixed(6);

                    // Actualizar direcci√≥n con datos completos de OpenStreetMap
                    if (location.address && location.address !== 'Direcci√≥n no disponible') {
                        updateBranchAddressFields(location.address, location.fullAddressData);
                    }
                }

                showNotification('‚úÖ Ubicaci√≥n aplicada exitosamente', 'success');
                closeMapModal();

            } catch (error) {
                console.error('‚ùå Error aplicando ubicaci√≥n:', error);
                showNotification(`‚ùå Error aplicando ubicaci√≥n: ${error.message}`, 'error');
            }
        }

        // Actualizar campos de direcci√≥n de empresa desde la selecci√≥n del mapa
        function updateCompanyAddressFields(addressString, fullAddressData = null) {
            console.log('üè¢ Actualizando campos de empresa:', addressString, fullAddressData);

            // Si tenemos datos completos del API de OpenStreetMap, usarlos
            if (fullAddressData && fullAddressData.address) {
                const addr = fullAddressData.address;
                console.log('üîç Datos completos de OpenStreetMap:', addr);

                // üè† DIRECCI√ìN COMPLETA (calle, n√∫mero, intersecciones)
                const addressField = document.getElementById('address');
                if (addressField) {
                    let streetAddress = '';

                    // N√∫mero de casa/edificio
                    if (addr.house_number) {
                        streetAddress += addr.house_number + ' ';
                    }

                    // Calle principal
                    if (addr.road) {
                        streetAddress += addr.road;
                    } else if (addr.street) {
                        streetAddress += addr.street;
                    } else if (addr.pedestrian) {
                        streetAddress += addr.pedestrian;
                    } else if (addr.path) {
                        streetAddress += addr.path;
                    }

                    // Intersecciones o referencias adicionales
                    if (addr.neighbourhood && !streetAddress.includes(addr.neighbourhood)) {
                        streetAddress += (streetAddress ? ', ' : '') + addr.neighbourhood;
                    }
                    if (addr.suburb && !streetAddress.includes(addr.suburb)) {
                        streetAddress += (streetAddress ? ', ' : '') + addr.suburb;
                    }

                    if (streetAddress.trim()) {
                        addressField.value = streetAddress.trim();
                        console.log('‚úÖ Direcci√≥n actualizada:', streetAddress.trim());
                    } else {
                        addressField.value = addressString;
                        console.log('‚úÖ Direcci√≥n de fallback:', addressString);
                    }
                }

                // üèôÔ∏è CIUDAD (m√∫ltiples variantes de OpenStreetMap)
                const cityField = document.getElementById('city');
                if (cityField) {
                    const city = addr.city ||
                                addr.town ||
                                addr.village ||
                                addr.municipality ||
                                addr.city_district ||
                                addr.district ||
                                addr.county ||
                                '';
                    if (city && (!cityField.value || cityField.value.trim() === '')) {
                        cityField.value = city;
                        console.log('‚úÖ Ciudad actualizada:', city);
                    }
                }

                // üó∫Ô∏è PROVINCIA/ESTADO (m√∫ltiples variantes)
                const provinceField = document.getElementById('province');
                if (provinceField) {
                    const province = addr.state ||
                                   addr.province ||
                                   addr.region ||
                                   addr.state_district ||
                                   addr.administrative_area_level_1 ||
                                   '';
                    if (province && (!provinceField.value || provinceField.value.trim() === '')) {
                        provinceField.value = province;
                        console.log('‚úÖ Provincia actualizada:', province);
                    }
                }

                // üåç PA√çS
                const countryField = document.getElementById('country');
                if (countryField) {
                    const country = addr.country || addr.country_code || '';
                    if (country && (!countryField.value || countryField.value.trim() === '')) {
                        countryField.value = country;
                        console.log('‚úÖ Pa√≠s actualizado:', country);
                    }
                }

                // üìÆ C√ìDIGO POSTAL
                const postalCodeField = document.getElementById('postalCode');
                if (postalCodeField) {
                    const postalCode = addr.postcode || addr.postal_code || '';
                    if (postalCode && (!postalCodeField.value || postalCodeField.value.trim() === '')) {
                        postalCodeField.value = postalCode;
                        console.log('‚úÖ C√≥digo postal actualizado:', postalCode);
                    }
                }

                console.log('‚úÖ Campos de empresa actualizados con datos detallados de OpenStreetMap');

            } else {
                // Solo tenemos la direcci√≥n como string, actualizar campo principal
                const addressField = document.getElementById('address');
                if (addressField) {
                    addressField.value = addressString;
                }
                console.log('‚úÖ Campo principal de empresa actualizado con string b√°sico');
            }
        }

        // Actualizar campos de direcci√≥n de sucursal desde la selecci√≥n del mapa
        function updateBranchAddressFields(addressString, fullAddressData = null) {
            console.log('üè™ Actualizando campos de sucursal:', addressString, fullAddressData);

            // Si tenemos datos completos del API de OpenStreetMap, usarlos
            if (fullAddressData && fullAddressData.address) {
                const addr = fullAddressData.address;
                console.log('üîç Datos completos de OpenStreetMap para sucursal:', addr);

                // üè† DIRECCI√ìN COMPLETA (calle, n√∫mero, intersecciones)
                const addressField = document.getElementById('branchAddress');
                if (addressField) {
                    let streetAddress = '';

                    // N√∫mero de casa/edificio
                    if (addr.house_number) {
                        streetAddress += addr.house_number + ' ';
                    }

                    // Calle principal
                    if (addr.road) {
                        streetAddress += addr.road;
                    } else if (addr.street) {
                        streetAddress += addr.street;
                    } else if (addr.pedestrian) {
                        streetAddress += addr.pedestrian;
                    } else if (addr.path) {
                        streetAddress += addr.path;
                    }

                    // Intersecciones o referencias adicionales
                    if (addr.neighbourhood && !streetAddress.includes(addr.neighbourhood)) {
                        streetAddress += (streetAddress ? ', ' : '') + addr.neighbourhood;
                    }
                    if (addr.suburb && !streetAddress.includes(addr.suburb)) {
                        streetAddress += (streetAddress ? ', ' : '') + addr.suburb;
                    }

                    if (streetAddress.trim()) {
                        addressField.value = streetAddress.trim();
                        console.log('‚úÖ Direcci√≥n de sucursal actualizada:', streetAddress.trim());
                    } else {
                        addressField.value = addressString;
                        console.log('‚úÖ Direcci√≥n de sucursal de fallback:', addressString);
                    }
                }

                // üèôÔ∏è CIUDAD (m√∫ltiples variantes de OpenStreetMap)
                const cityField = document.getElementById('branchCity');
                if (cityField) {
                    const city = addr.city ||
                                addr.town ||
                                addr.village ||
                                addr.municipality ||
                                addr.city_district ||
                                addr.district ||
                                addr.county ||
                                '';
                    if (city && (!cityField.value || cityField.value.trim() === '')) {
                        cityField.value = city;
                        console.log('‚úÖ Ciudad de sucursal actualizada:', city);
                    }
                }

                // üó∫Ô∏è PROVINCIA/ESTADO (m√∫ltiples variantes)
                const provinceField = document.getElementById('branchProvince');
                if (provinceField) {
                    const province = addr.state ||
                                   addr.province ||
                                   addr.region ||
                                   addr.state_district ||
                                   addr.administrative_area_level_1 ||
                                   '';
                    if (province && (!provinceField.value || provinceField.value.trim() === '')) {
                        provinceField.value = province;
                        console.log('‚úÖ Provincia de sucursal actualizada:', province);
                    }
                }

                // üåç PA√çS
                const countryField = document.getElementById('branchCountry');
                if (countryField) {
                    const country = addr.country || addr.country_code || '';
                    if (country && (!countryField.value || countryField.value.trim() === '')) {
                        countryField.value = country;
                        console.log('‚úÖ Pa√≠s de sucursal actualizado:', country);
                    }
                }

                // üìÆ C√ìDIGO POSTAL
                const postalCodeField = document.getElementById('branchPostalCode');
                if (postalCodeField) {
                    const postalCode = addr.postcode || addr.postal_code || '';
                    if (postalCode && (!postalCodeField.value || postalCodeField.value.trim() === '')) {
                        postalCodeField.value = postalCode;
                        console.log('‚úÖ C√≥digo postal de sucursal actualizado:', postalCode);
                    }
                }

                console.log('‚úÖ Campos de sucursal actualizados con datos detallados de OpenStreetMap');

            } else {
                // Solo tenemos la direcci√≥n como string, actualizar campo principal
                const addressField = document.getElementById('branchAddress');
                if (addressField) {
                    addressField.value = addressString;
                }
                console.log('‚úÖ Campo principal de sucursal actualizado con string b√°sico');
            }
        }

        // Tambi√©n agregar listener para cerrar con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const mapModal = document.getElementById('mapModal');
                if (mapModal) {
                    closeMapModal();
                }
            }
        });

        // Agregar listener para Enter en el input de b√∫squeda
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const searchInput = document.getElementById('mapSearchInput');
                if (searchInput && document.activeElement === searchInput) {
                    event.preventDefault();
                    searchLocationOnMap();
                }
            }
        });

        // Funci√≥n para aproximaci√≥n gradual de direcciones
        let geocodingTimeout = null;

        async function approximateLocationFromFields(type = 'empresa') {
            // Cancelar timeout anterior si existe
            if (geocodingTimeout) {
                clearTimeout(geocodingTimeout);
            }

            // Esperar 1 segundo despu√©s de que el usuario deje de escribir
            geocodingTimeout = setTimeout(async () => {
                try {
                    let address = '';
                    let city = '';
                    let province = '';
                    let country = '';
                    let postalCode = '';

                    if (type === 'empresa') {
                        const addressField = document.getElementById('address');
                        const cityField = document.getElementById('city');
                        const provinceField = document.getElementById('province');
                        const countryField = document.getElementById('country');
                        const postalCodeField = document.getElementById('postalCode');

                        address = addressField ? addressField.value.trim() : '';
                        city = cityField ? cityField.value.trim() : '';
                        province = provinceField ? provinceField.value.trim() : '';
                        country = countryField ? countryField.value.trim() : '';
                        postalCode = postalCodeField ? postalCodeField.value.trim() : '';
                    } else {
                        const addressField = document.getElementById('branchAddress');
                        const cityField = document.getElementById('branchCity');
                        const provinceField = document.getElementById('branchProvince');
                        const countryField = document.getElementById('branchCountry');
                        const postalCodeField = document.getElementById('branchPostalCode');

                        address = addressField ? addressField.value.trim() : '';
                        city = cityField ? cityField.value.trim() : '';
                        province = provinceField ? provinceField.value.trim() : '';
                        country = countryField ? countryField.value.trim() : '';
                        postalCode = postalCodeField ? postalCodeField.value.trim() : '';
                    }

                    // Construir direcci√≥n para b√∫squeda progresiva
                    const addressParts = [];
                    if (address) addressParts.push(address);
                    if (city) addressParts.push(city);
                    if (province) addressParts.push(province);
                    if (country) addressParts.push(country);
                    if (postalCode) addressParts.push(postalCode);

                    const searchQuery = addressParts.join(', ');

                    // Solo buscar si tenemos al menos ciudad o pa√≠s
                    if (city || country) {
                        console.log(`üîç Aproximaci√≥n gradual (${type}):`, searchQuery);

                        // Usar la misma API de OpenStreetMap
                        const encodedQuery = encodeURIComponent(searchQuery);
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedQuery}&limit=1&addressdetails=1`, {
                            headers: {
                                'User-Agent': 'Sistema-Biometrico-Empresarial/1.0'
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();

                            if (data && data.length > 0) {
                                const result = data[0];
                                const lat = parseFloat(result.lat);
                                const lng = parseFloat(result.lon);

                                console.log(`‚úÖ Aproximaci√≥n encontrada (${type}):`, lat, lng);
                                console.log('üîç Datos de aproximaci√≥n:', result);

                                // Actualizar coordenadas autom√°ticamente (SIN MOSTRAR MAPA)
                                if (type === 'empresa') {
                                    const latField = document.getElementById('companyLatitude');
                                    const lngField = document.getElementById('companyLongitude');
                                    if (latField) latField.value = lat.toFixed(6);
                                    if (lngField) lngField.value = lng.toFixed(6);

                                    // Tambi√©n completar campos faltantes con datos de la aproximaci√≥n
                                    if (result.address) {
                                        const addr = result.address;

                                        // Solo llenar campos que est√©n vac√≠os
                                        const cityField = document.getElementById('city');
                                        if (cityField && (!cityField.value || cityField.value.trim() === '')) {
                                            const city = addr.city || addr.town || addr.village || addr.municipality || '';
                                            if (city) {
                                                cityField.value = city;
                                                console.log('üèôÔ∏è Ciudad auto-completada (empresa):', city);
                                            }
                                        }

                                        const provinceField = document.getElementById('province');
                                        if (provinceField && (!provinceField.value || provinceField.value.trim() === '')) {
                                            const province = addr.state || addr.province || addr.region || '';
                                            if (province) {
                                                provinceField.value = province;
                                                console.log('üó∫Ô∏è Provincia auto-completada (empresa):', province);
                                            }
                                        }

                                        const countryField = document.getElementById('country');
                                        if (countryField && (!countryField.value || countryField.value.trim() === '')) {
                                            const country = addr.country || '';
                                            if (country) {
                                                countryField.value = country;
                                                console.log('üåç Pa√≠s auto-completado (empresa):', country);
                                            }
                                        }

                                        const postalCodeField = document.getElementById('postalCode');
                                        if (postalCodeField && (!postalCodeField.value || postalCodeField.value.trim() === '')) {
                                            const postalCode = addr.postcode || '';
                                            if (postalCode) {
                                                postalCodeField.value = postalCode;
                                                console.log('üìÆ C√≥digo postal auto-completado (empresa):', postalCode);
                                            }
                                        }
                                    }

                                } else {
                                    const latField = document.getElementById('branchLatitude');
                                    const lngField = document.getElementById('branchLongitude');
                                    if (latField) latField.value = lat.toFixed(6);
                                    if (lngField) lngField.value = lng.toFixed(6);

                                    // Tambi√©n completar campos faltantes con datos de la aproximaci√≥n
                                    if (result.address) {
                                        const addr = result.address;

                                        // Solo llenar campos que est√©n vac√≠os
                                        const cityField = document.getElementById('branchCity');
                                        if (cityField && (!cityField.value || cityField.value.trim() === '')) {
                                            const city = addr.city || addr.town || addr.village || addr.municipality || '';
                                            if (city) {
                                                cityField.value = city;
                                                console.log('üèôÔ∏è Ciudad auto-completada (sucursal):', city);
                                            }
                                        }

                                        const provinceField = document.getElementById('branchProvince');
                                        if (provinceField && (!provinceField.value || provinceField.value.trim() === '')) {
                                            const province = addr.state || addr.province || addr.region || '';
                                            if (province) {
                                                provinceField.value = province;
                                                console.log('üó∫Ô∏è Provincia auto-completada (sucursal):', province);
                                            }
                                        }

                                        const countryField = document.getElementById('branchCountry');
                                        if (countryField && (!countryField.value || countryField.value.trim() === '')) {
                                            const country = addr.country || '';
                                            if (country) {
                                                countryField.value = country;
                                                console.log('üåç Pa√≠s auto-completado (sucursal):', country);
                                            }
                                        }

                                        const postalCodeField = document.getElementById('branchPostalCode');
                                        if (postalCodeField && (!postalCodeField.value || postalCodeField.value.trim() === '')) {
                                            const postalCode = addr.postcode || '';
                                            if (postalCode) {
                                                postalCodeField.value = postalCode;
                                                console.log('üìÆ C√≥digo postal auto-completado (sucursal):', postalCode);
                                            }
                                        }
                                    }
                                }

                                // Mostrar notificaci√≥n sutil
                                showNotification(`üìç Ubicaci√≥n aproximada encontrada para: ${searchQuery}`, 'info');
                            }
                        }
                    }

                } catch (error) {
                    console.log('‚ÑπÔ∏è Aproximaci√≥n no disponible:', error.message);
                    // No mostrar error al usuario, es solo aproximaci√≥n
                }
            }, 1500); // Esperar 1.5 segundos
        }

        // Agregar listeners a los campos de direcci√≥n de empresa
        document.addEventListener('DOMContentLoaded', function() {
            // Empresa
            const companyFields = ['address', 'city', 'province', 'country', 'postalCode'];
            companyFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => approximateLocationFromFields('empresa'));
                }
            });

            // Sucursales
            const branchFields = ['branchAddress', 'branchCity', 'branchProvince', 'branchCountry', 'branchPostalCode'];
            branchFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => approximateLocationFromFields('sucursal'));
                }
            });
        });

        // Guardar sucursal
        async function saveBranch(event) {
            event.preventDefault();

            const companyId = currentEditingCompany ? currentEditingCompany.id : null;
            if (!companyId) {
                showNotification('‚ùå Error: No se puede determinar la empresa', 'error');
                return;
            }

            const branchData = {
                companyId: companyId,
                name: document.getElementById('branchName').value,
                address: document.getElementById('branchAddress').value,
                city: document.getElementById('branchCity').value,
                province: document.getElementById('branchProvince').value,
                country: document.getElementById('branchCountry').value,
                postalCode: document.getElementById('branchPostalCode').value,
                phone: document.getElementById('branchPhone').value.trim() || null,
                email: document.getElementById('branchEmail').value.trim() || null,
                isActive: document.getElementById('branchIsActive').checked
            };

            // Agregar coordenadas si est√°n disponibles
            const latitude = document.getElementById('branchLatitude').value;
            const longitude = document.getElementById('branchLongitude').value;
            if (latitude && longitude) {
                branchData.latitude = parseFloat(latitude);
                branchData.longitude = parseFloat(longitude);
            }

            try {
                let response;
                if (currentEditingBranch) {
                    // Actualizar sucursal existente
                    response = await fetch(`/api/aponnt/dashboard/branches/${currentEditingBranch.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(branchData)
                    });
                } else {
                    // Crear nueva sucursal
                    response = await fetch('/api/aponnt/dashboard/branches', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(branchData)
                    });
                }

                if (response.ok) {
                    showNotification(`‚úÖ Sucursal ${currentEditingBranch ? 'actualizada' : 'creada'} exitosamente`, 'success');
                    closeBranchModal();
                    // Peque√±o delay para asegurar que el modal se cierre antes de recargar
                    setTimeout(() => {
                        loadCompanyBranches(companyId);
                    }, 100);
                } else {
                    const errorData = await response.json();
                    showNotification(`‚ùå Error al ${currentEditingBranch ? 'actualizar' : 'crear'} sucursal: ${errorData.message}`, 'error');
                }
            } catch (error) {
                console.error('Error guardando sucursal:', error);
                showNotification(`‚ùå Error al ${currentEditingBranch ? 'actualizar' : 'crear'} sucursal`, 'error');
            }
        }

        // Editar sucursal
        function editBranch(branchId) {
            openBranchModal(branchId);
        }

        // Eliminar sucursal
        async function deleteBranch(branchId) {
            if (!confirm('¬øEst√° seguro de que desea eliminar esta sucursal?')) {
                return;
            }

            try {
                const response = await fetch(`/api/aponnt/dashboard/branches/${branchId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('‚úÖ Sucursal eliminada exitosamente', 'success');
                    loadCompanyBranches(currentEditingCompany.id);
                } else {
                    const errorData = await response.json();
                    showNotification(`‚ùå Error al eliminar sucursal: ${errorData.message}`, 'error');
                }
            } catch (error) {
                console.error('Error eliminando sucursal:', error);
                showNotification('‚ùå Error al eliminar sucursal', 'error');
            }
        }

        // ==================== FUNCIONES DE GESTI√ìN DE USUARIOS ====================
        
        // Variable para almacenar usuarios de la empresa actual
        let currentCompanyUsers = [];

        // Cargar usuarios de la empresa
        async function loadCompanyUsers() {
            if (!currentEditingCompany) {
                showNotification('‚ö†Ô∏è Seleccione una empresa primero', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/aponnt/dashboard/users/${currentEditingCompany.id}`);
                if (response.ok) {
                    const data = await response.json();
                    currentCompanyUsers = data.users || [];
                    renderUsersContainer();
                    showNotification(`‚úÖ ${currentCompanyUsers.length} usuarios cargados`, 'success');
                } else {
                    currentCompanyUsers = [];
                    renderUsersContainer();
                    showNotification('‚ö†Ô∏è No se pudieron cargar los usuarios', 'warning');
                }
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                currentCompanyUsers = [];
                renderUsersContainer();
                showNotification('‚ùå Error al cargar usuarios', 'error');
            }
        }

        // Renderizar contenedor de usuarios
        function renderUsersContainer() {
            const container = document.getElementById('usersContainer');
            
            if (currentCompanyUsers.length === 0) {
                container.innerHTML = `
                    <div class="no-users" style="text-align: center; color: #666; padding: 1rem;">
                        No hay usuarios administradores registrados
                    </div>
                `;
                return;
            }

            const html = currentCompanyUsers.map(user => `
                <div class="user-item" style="
                    display: flex; 
                    align-items: center; 
                    justify-content: space-between; 
                    padding: 1rem; 
                    border: 1px solid #ddd; 
                    border-radius: 8px; 
                    margin-bottom: 0.75rem;
                    background: white;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                ">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1976d2; font-size: 1rem;">
                            üë§ ${user.usuario}
                        </div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                            üìß ${user.email} | üë®‚Äçüíº ${user.firstName} ${user.lastName}
                        </div>
                        <div style="font-size: 0.8rem; color: #999; margin-top: 0.25rem;">
                            üîë Rol: ${user.role === 'company_admin' ? 'Administrador de Empresa' : user.role}
                            ${user.isCompanyAdmin ? ' | ‚≠ê Admin Principal' : ''}
                        </div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span>üîê <strong>Contrase√±a actual:</strong></span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="password" 
                                           id="currentPassword_${user.user_id}" 
                                           value="123" 
                                           readonly 
                                           style="
                                               font-family: monospace; 
                                               background: #fff; 
                                               border: 1px solid #ddd; 
                                               border-radius: 4px; 
                                               padding: 0.25rem 0.5rem; 
                                               font-size: 0.75rem;
                                               width: 80px;
                                           ">
                                    <button type="button" 
                                            onclick="togglePasswordVisibility('currentPassword_${user.user_id}')" 
                                            style="
                                                background: none; 
                                                border: none; 
                                                cursor: pointer; 
                                                font-size: 0.8rem;
                                                padding: 0.25rem;
                                            ">üëÅÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-left: 1rem;">
                        <button type="button" 
                                class="btn btn-sm btn-warning" 
                                onclick="resetUserPassword(${user.user_id}, '${user.usuario}')"
                                style="font-size: 0.75rem; white-space: nowrap;">
                            üîÑ Resetear a "123"
                        </button>
                        <button type="button" 
                                class="btn btn-sm btn-primary" 
                                onclick="changeUserPassword(${user.user_id}, '${user.usuario}')"
                                style="font-size: 0.75rem; white-space: nowrap;">
                            ‚úèÔ∏è Cambiar
                        </button>
                        <button type="button" 
                                class="btn btn-sm btn-info" 
                                onclick="testUserLogin('${user.usuario}')"
                                style="font-size: 0.75rem; white-space: nowrap;">
                            üß™ Probar Login
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // Alternar visibilidad de contrase√±a
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        }

        // Resetear contrase√±a de usuario a "123"
        async function resetUserPassword(userId, username) {
            if (!confirm(`¬øEst√° seguro de resetear la contrase√±a de "${username}" a "123"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/aponnt/dashboard/users/reset-password/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification(`‚úÖ ${data.message}`, 'success');
                    // Actualizar la vista de contrase√±a
                    const passwordInput = document.getElementById(`currentPassword_${userId}`);
                    if (passwordInput) {
                        passwordInput.value = '123';
                    }
                } else {
                    const errorData = await response.json();
                    showNotification(`‚ùå Error: ${errorData.error}`, 'error');
                }
            } catch (error) {
                console.error('Error reseteando contrase√±a:', error);
                showNotification('‚ùå Error al resetear contrase√±a', 'error');
            }
        }

        // Cambiar contrase√±a de usuario
        async function changeUserPassword(userId, username) {
            const newPassword = prompt(`Ingrese la nueva contrase√±a para "${username}":`);
            if (!newPassword) {
                return;
            }
            
            if (newPassword.length < 3) {
                showNotification('‚ö†Ô∏è La contrase√±a debe tener al menos 3 caracteres', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/aponnt/dashboard/users/change-password/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newPassword: newPassword })
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification(`‚úÖ ${data.message}`, 'success');
                    // Actualizar la vista de contrase√±a
                    const passwordInput = document.getElementById(`currentPassword_${userId}`);
                    if (passwordInput) {
                        passwordInput.value = newPassword;
                    }
                } else {
                    const errorData = await response.json();
                    showNotification(`‚ùå Error: ${errorData.error}`, 'error');
                }
            } catch (error) {
                console.error('Error cambiando contrase√±a:', error);
                showNotification('‚ùå Error al cambiar contrase√±a', 'error');
            }
        }

        /* ‚úÖ C√ìDIGO FUNCIONAL PROTEGIDO - NO MODIFICAR SIN AN√ÅLISIS
         * üìÖ Fecha: 23/SEP/2025 04:05:00
         * üè∑Ô∏è Versi√≥n: v2.1.2-LOGIN
         * üìã Funcionalidad: Sistema de login administrativo - TEST Y VALIDACI√ìN
         */
        // Probar login de usuario
        async function testUserLogin(username) {
            // Obtener la contrase√±a actual del input
            const userId = currentCompanyUsers.find(u => u.username === username)?.id;
            if (!userId) {
                showNotification('‚ùå Usuario no encontrado', 'error');
                return;
            }
            
            const passwordInput = document.getElementById(`currentPassword_${userId}`);
            const password = passwordInput ? passwordInput.value : '123';

            try {
                const response = await fetch('/api/aponnt/dashboard/users/authenticate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        username: username, 
                        password: password 
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification(`‚úÖ Login exitoso para "${username}"! Token generado.`, 'success');
                    console.log('Usuario autenticado:', data.user);
                    console.log('Token:', data.token);
                } else {
                    const errorData = await response.json();
                    showNotification(`‚ùå Login fallido para "${username}": ${errorData.error}`, 'error');
                }
            } catch (error) {
                console.error('Error probando login:', error);
                showNotification('‚ùå Error al probar login', 'error');
            }
        }

        // Cargar usuarios autom√°ticamente al abrir una empresa
        function loadCompanyUsersAutomatically() {
            if (currentEditingCompany) {
                loadCompanyUsers();
            }
        }

        // ==================== FUNCIONES DEL M√ìDULO DE FACTURACI√ìN ====================

        let billingData = [];

        // Generar canon mensual para todas las empresas activas
        async function generateMonthlyCanon() {
            try {
                const loadingBtn = document.querySelector('button[onclick="generateMonthlyCanon()"]');
                if (loadingBtn) {
                    loadingBtn.innerHTML = '‚è≥ Generando...';
                    loadingBtn.disabled = true;
                }

                const currentDate = new Date();
                const month = currentDate.getMonth() + 1;
                const year = currentDate.getFullYear();

                console.log(`üìä Generando canon mensual para ${month}/${year}...`);

                const response = await fetch(`${API_BASE}/dashboard/generate-monthly-invoices`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token') || ''}`
                    },
                    body: JSON.stringify({
                        month: month,
                        year: year,
                        paymentMethod: 'transferencia',
                        vendor: 'Aponnt'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Canon generado exitosamente:', result);
                    showNotification(`‚úÖ ${result.generated} facturas generadas para ${month}/${year}`, 'success');
                    
                    // Recargar datos de facturaci√≥n
                    await loadBillingData();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Error generando canon:', error);
                showNotification('‚ùå Error generando canon mensual', 'error');
            } finally {
                const loadingBtn = document.querySelector('button[onclick="generateMonthlyCanon()"]');
                if (loadingBtn) {
                    loadingBtn.innerHTML = 'üí∞ Generar Canon Mensual';
                    loadingBtn.disabled = false;
                }
            }
        }

        // Cargar datos de facturaci√≥n
        async function loadBillingData() {
            try {
                console.log('üì• Cargando datos de facturaci√≥n...');

                // Obtener filtros (con validaci√≥n de elementos)
                const filterMonthEl = document.getElementById('filterMonth');
                const filterYearEl = document.getElementById('filterYear');
                const filterVendorEl = document.getElementById('filterVendor');
                const filterPaymentStatusEl = document.getElementById('filterPaymentStatus');
                
                const filterMonth = filterMonthEl ? filterMonthEl.value : '';
                const filterYear = filterYearEl ? filterYearEl.value : '';
                const filterVendor = filterVendorEl ? filterVendorEl.value : '';
                const filterPaymentStatus = filterPaymentStatusEl ? filterPaymentStatusEl.value : '';

                // Construir par√°metros de consulta
                const params = new URLSearchParams();
                if (filterMonth) params.append('month', filterMonth);
                if (filterYear) params.append('year', filterYear);
                if (filterVendor) params.append('vendor', filterVendor);
                if (filterPaymentStatus) params.append('isPaid', filterPaymentStatus);

                // Panel administrativo - usar datos mock directamente
                console.log('üîì Modo administrativo - cargando datos mock');
                billingData = generateMockBillingData();
                console.log(`‚úÖ ${billingData.length} pagos cargados (mock)`);

                renderBillingTable();
                calculateBillingTotals();
            } catch (error) {
                console.error('‚ùå Error cargando facturaci√≥n:', error);
                showNotification('‚ùå Error cargando datos de facturaci√≥n', 'error');
                
                // Mostrar datos mock para desarrollo
                billingData = generateMockBillingData();
                renderBillingTable();
                calculateBillingTotals();
                showNotification('‚ö†Ô∏è Usando datos de ejemplo (sin conexi√≥n a servidor)', 'warning');
            }
        }

        // Generar datos mock para desarrollo
        function generateMockBillingData() {
            const mockData = [];
            const companies = JSON.parse(localStorage.getItem('companies') || '[]');
            
            companies.forEach(company => {
                if (company.status === 'active' && company.isActive) {
                    // Calcular total basado en m√≥dulos activos
                    let totalAmount = 0;
                    if (company.modulesPricing) {
                        Object.values(company.modulesPricing).forEach(module => {
                            totalAmount += module.totalPrice || 0;
                        });
                    }
                    
                    if (totalAmount > 0) {
                        const subtotal = totalAmount / 1.21;
                        const commissionAmount = subtotal * (company.commissionPercentage || 10) / 100;
                        const aponntAmount = totalAmount - commissionAmount;
                        
                        mockData.push({
                            id: Date.now() + Math.random(),
                            companyId: company.company_id,
                            companyName: company.name,
                            vendor: company.vendor || 'Sin asignar',
                            month: new Date().getMonth() + 1,
                            year: new Date().getFullYear(),
                            paymentDate: new Date().toISOString().split('T')[0],
                            totalAmount: parseFloat(totalAmount.toFixed(2)),
                            subtotal: parseFloat(subtotal.toFixed(2)),
                            commissionPercentage: company.commissionPercentage || 10,
                            commissionAmount: parseFloat(commissionAmount.toFixed(2)),
                            aponntAmount: parseFloat(aponntAmount.toFixed(2)),
                            totalAmountUSD: 0,
                            paymentMethod: 'transferencia',
                            isPaid: Math.random() > 0.3,
                            notes: ''
                        });
                    }
                }
            });
            
            return mockData;
        }

        // Renderizar tabla de facturaci√≥n
        function renderBillingTable() {
            const container = document.getElementById('billingTableContainer');
            
            // Verificar que el contenedor existe
            if (!container) {
                console.warn('‚ö†Ô∏è Contenedor billingTableContainer no encontrado');
                return;
            }
            
            if (!billingData || billingData.length === 0) {
                container.innerHTML = `
                    <div class="billing-card">
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            üìÑ No hay facturas para mostrar
                            <br><br>
                            <button class="btn btn-primary" onclick="generateMonthlyCanon()">
                                üí∞ Generar Canon Mensual
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <div class="billing-card">
                    <div class="billing-header">
                        <h3>üìã Listado de Facturas</h3>
                        <div>Total: ${billingData.length} registros</div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="billing-table">
                            <thead>
                                <tr>
                                    <th>Empresa</th>
                                    <th>Vendedor</th>
                                    <th>Per√≠odo</th>
                                    <th>Total</th>
                                    <th>Subtotal</th>
                                    <th>Comisi√≥n (%)</th>
                                    <th>Comisi√≥n ($)</th>
                                    <th>Aponnt ($)</th>
                                    <th>Estado</th>
                                    <th>M√©todo Pago</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${billingData.map(payment => `
                                    <tr class="${!payment.isPaid ? 'unpaid' : ''}">
                                        <td><strong>${payment.companyName}</strong></td>
                                        <td>${payment.vendor}</td>
                                        <td>${payment.month}/${payment.year}</td>
                                        <td class="amount">$${payment.totalAmount.toLocaleString()}</td>
                                        <td class="amount">$${payment.subtotal.toLocaleString()}</td>
                                        <td>${payment.commissionPercentage}%</td>
                                        <td class="amount commission">$${payment.commissionAmount.toLocaleString()}</td>
                                        <td class="amount aponnt">$${payment.aponntAmount.toLocaleString()}</td>
                                        <td>
                                            <span class="status ${payment.isPaid ? 'paid' : 'unpaid'}">
                                                ${payment.isPaid ? '‚úÖ Pagado' : '‚è≥ Pendiente'}
                                            </span>
                                        </td>
                                        <td>${payment.paymentMethod}</td>
                                        <td>
                                            <button class="btn-action" onclick="togglePaymentStatus(${payment.id})" 
                                                    title="${payment.isPaid ? 'Marcar como pendiente' : 'Marcar como pagado'}">
                                                ${payment.isPaid ? '‚è≥' : '‚úÖ'}
                                            </button>
                                            <button class="btn-action" onclick="editPayment(${payment.id})" title="Editar">
                                                ‚úèÔ∏è
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        // Calcular totales de facturaci√≥n
        function calculateBillingTotals() {
            const container = document.getElementById('billingTotals');
            if (!container) {
                console.warn('‚ö†Ô∏è Contenedor billingTotals no encontrado');
                return;
            }

            if (!billingData || billingData.length === 0) {
                container.style.display = 'none';
                return;
            }

            const totals = billingData.reduce((acc, payment) => {
                acc.totalClientes += payment.totalAmount || 0;
                acc.totalDolares += payment.totalAmountUSD || 0;
                acc.totalComisiones += payment.commissionAmount || 0;
                acc.totalAponnt += payment.aponntAmount || 0;
                if (payment.isPaid) acc.totalPagado += payment.totalAmount || 0;
                else acc.totalPendiente += payment.totalAmount || 0;
                return acc;
            }, {
                totalClientes: 0,
                totalDolares: 0,
                totalComisiones: 0,
                totalAponnt: 0,
                totalPagado: 0,
                totalPendiente: 0
            });

            container.style.display = 'block';
            container.innerHTML = `
                <div class="billing-card">
                    <div class="billing-header">
                        <h3>üí∞ Totales</h3>
                    </div>
                    <div class="totals-grid">
                        <div class="total-item">
                            <div class="total-value">$${totals.totalClientes.toLocaleString()}</div>
                            <div class="total-label">Total Facturado</div>
                        </div>
                        <div class="total-item">
                            <div class="total-value">$${totals.totalComisiones.toLocaleString()}</div>
                            <div class="total-label">Total Comisiones</div>
                        </div>
                        <div class="total-item">
                            <div class="total-value">$${totals.totalAponnt.toLocaleString()}</div>
                            <div class="total-label">Total Aponnt</div>
                        </div>
                        <div class="total-item">
                            <div class="total-value paid">$${totals.totalPagado.toLocaleString()}</div>
                            <div class="total-label">Total Pagado</div>
                        </div>
                        <div class="total-item">
                            <div class="total-value unpaid">$${totals.totalPendiente.toLocaleString()}</div>
                            <div class="total-label">Total Pendiente</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Limpiar filtros de facturaci√≥n
        function clearBillingFilters() {
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            document.getElementById('filterVendor').value = '';
            document.getElementById('filterPaymentStatus').value = '';
            
            // Recargar todos los datos
            loadBillingData();
        }

        // Cambiar estado de pago
        async function togglePaymentStatus(paymentId) {
            try {
                const payment = billingData.find(p => p.id === paymentId);
                if (!payment) return;

                const newStatus = !payment.isPaid;
                
                const response = await fetch(`${API_BASE}/payments/${paymentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token') || ''}`
                    },
                    body: JSON.stringify({
                        isPaid: newStatus
                    })
                });

                if (response.ok) {
                    payment.isPaid = newStatus;
                    showNotification(`‚úÖ Estado actualizado: ${newStatus ? 'Pagado' : 'Pendiente'}`, 'success');
                    renderBillingTable();
                    calculateBillingTotals();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('‚ùå Error actualizando estado:', error);
                
                // Fallback local para desarrollo
                const payment = billingData.find(p => p.id === paymentId);
                if (payment) {
                    payment.isPaid = !payment.isPaid;
                    renderBillingTable();
                    calculateBillingTotals();
                    showNotification(`‚ö†Ô∏è Estado actualizado localmente: ${payment.isPaid ? 'Pagado' : 'Pendiente'}`, 'warning');
                }
            }
        }

        // Editar pago (placeholder)
        function editPayment(paymentId) {
            const payment = billingData.find(p => p.id === paymentId);
            if (payment) {
                showNotification(`üìù Editar pago de ${payment.companyName} - ${payment.month}/${payment.year}`, 'info');
            }
        }

        // Cargar datos de facturaci√≥n al cambiar de pesta√±a
        function loadBillingSystem() {
            loadBillingData();
        }

        // =======================================
        // FUNCIONES DE EXPORTACI√ìN A EXCEL
        // =======================================

        // Funci√≥n para exportar empresas a Excel
        async function exportCompaniesToExcel() {
            try {
                showNotification('Generando archivo Excel...', 'info');

                // Obtener todas las empresas con filtros aplicados
                const companies = await getAllFilteredCompanies();
                
                if (!companies || companies.length === 0) {
                    showNotification('No hay datos para exportar', 'warning');
                    return;
                }

                // Preparar datos para Excel
                const excelData = companies.map(company => ({
                    'Empresa': company.name,
                    'Email': company.email,
                    'Tel√©fono': company.phone,
                    'Direcci√≥n': company.address,
                    'Pa√≠s': company.country,
                    'Provincia': company.province,
                    'Ciudad': company.city,
                    'CUIT': company.taxId,
                    'Max Empleados': company.maxEmployees,
                    'Vendedor': company.vendor || 'Sin asignar',
                    'Comisi√≥n %': company.commissionPercentage + '%',
                    'CBU': company.cbu || 'No definido',
                    'Estado': company.status === 'active' ? 'Activo' : 
                             company.status === 'cotizado' ? 'Cotizado' : 'Suspendido',
                    'Licencia': company.licenseType,
                    'Fecha Creaci√≥n': new Date(company.created_at).toLocaleDateString('es-AR'),
                    'M√≥dulos Activos': Object.keys(company.activeModules || {}).join(', ')
                }));

                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);

                // Ajustar ancho de columnas
                const colWidths = [
                    { wch: 20 }, // Empresa
                    { wch: 25 }, // Email
                    { wch: 15 }, // Tel√©fono
                    { wch: 30 }, // Direcci√≥n
                    { wch: 12 }, // Pa√≠s
                    { wch: 15 }, // Provincia
                    { wch: 15 }, // Ciudad
                    { wch: 15 }, // CUIT
                    { wch: 12 }, // Max Empleados
                    { wch: 15 }, // Vendedor
                    { wch: 10 }, // Comisi√≥n %
                    { wch: 20 }, // CBU
                    { wch: 10 }, // Estado
                    { wch: 10 }, // Licencia
                    { wch: 15 }, // Fecha Creaci√≥n
                    { wch: 30 }  // M√≥dulos Activos
                ];
                ws['!cols'] = colWidths;

                XLSX.utils.book_append_sheet(wb, ws, 'Empresas');

                // Descargar archivo
                const filename = `Empresas_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);

                showNotification(`Archivo ${filename} descargado exitosamente`, 'success');
            } catch (error) {
                console.error('Error exportando empresas:', error);
                showNotification('Error al generar el archivo Excel', 'error');
            }
        }

        // Funci√≥n para exportar vendedores a Excel
        async function exportVendorsToExcel() {
            try {
                showNotification('Generando archivo Excel...', 'info');

                // Obtener todos los vendedores
                const response = await fetch(`${API_BASE}/api/aponnt/dashboard/vendors`);
                if (!response.ok) throw new Error('Error obteniendo vendedores');
                
                const vendors = await response.json();
                
                if (!vendors || vendors.length === 0) {
                    showNotification('No hay vendedores para exportar', 'warning');
                    return;
                }

                // Preparar datos para Excel
                const excelData = vendors.map(vendor => ({
                    'ID': vendor.id,
                    'Nombre': vendor.name,
                    'Email': vendor.email,
                    'Tel√©fono': vendor.phone || 'No definido',
                    'WhatsApp': vendor.whatsapp || 'No definido',
                    'DNI': vendor.dni || 'No definido',
                    'CUIT': vendor.cuit || 'No definido',
                    'Ingresos Brutos': vendor.ingresosBrutos || 'No definido',
                    'Condici√≥n IVA': vendor.condicionIva || 'No definido',
                    'Comisi√≥n %': vendor.commissionPercentage + '%',
                    'Estado': vendor.isActive ? 'Activo' : 'Inactivo',
                    'Observaciones': vendor.observations || 'Sin observaciones',
                    'Fecha Creaci√≥n': new Date(vendor.created_at).toLocaleDateString('es-AR'),
                    '√öltima Actualizaci√≥n': new Date(vendor.updated_at).toLocaleDateString('es-AR')
                }));

                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);

                // Ajustar ancho de columnas
                const colWidths = [
                    { wch: 8 },  // ID
                    { wch: 20 }, // Nombre
                    { wch: 25 }, // Email
                    { wch: 15 }, // Tel√©fono
                    { wch: 15 }, // WhatsApp
                    { wch: 12 }, // DNI
                    { wch: 15 }, // CUIT
                    { wch: 15 }, // Ingresos Brutos
                    { wch: 15 }, // Condici√≥n IVA
                    { wch: 10 }, // Comisi√≥n %
                    { wch: 10 }, // Estado
                    { wch: 30 }, // Observaciones
                    { wch: 15 }, // Fecha Creaci√≥n
                    { wch: 15 }  // √öltima Actualizaci√≥n
                ];
                ws['!cols'] = colWidths;

                XLSX.utils.book_append_sheet(wb, ws, 'Vendedores');

                // Descargar archivo
                const filename = `Vendedores_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);

                showNotification(`Archivo ${filename} descargado exitosamente`, 'success');
            } catch (error) {
                console.error('Error exportando vendedores:', error);
                showNotification('Error al generar el archivo Excel', 'error');
            }
        }

        // Funci√≥n para exportar facturaci√≥n a Excel
        async function exportBillingToExcel() {
            try {
                showNotification('Generando archivo Excel...', 'info');

                // Obtener filtros aplicados
                const month = document.getElementById('billingFilterMonth')?.value || new Date().getMonth() + 1;
                const year = document.getElementById('billingFilterYear')?.value || new Date().getFullYear();
                const vendor = document.getElementById('billingFilterVendor')?.value || '';
                const status = document.getElementById('billingFilterStatus')?.value || '';

                // Obtener datos de facturaci√≥n
                const response = await fetch(`${API_BASE}/api/aponnt/dashboard/billing?month=${month}&year=${year}&vendor=${vendor}&status=${status}`);
                if (!response.ok) throw new Error('Error obteniendo datos de facturaci√≥n');
                
                const billingData = await response.json();
                
                if (!billingData || billingData.length === 0) {
                    showNotification('No hay datos de facturaci√≥n para exportar', 'warning');
                    return;
                }

                // Preparar datos para Excel
                const excelData = billingData.map(payment => ({
                    'Empresa': payment.companyName,
                    'Vendedor': payment.vendor || 'Sin asignar',
                    'Per√≠odo': `${payment.month}/${payment.year}`,
                    'Total Facturado': `$${payment.totalAmount.toLocaleString()}`,
                    'Subtotal sin IVA': `$${(payment.totalAmount / 1.21).toFixed(2)}`,
                    'Comisi√≥n %': payment.commissionPercentage + '%',
                    'Comisi√≥n Monto': `$${payment.commissionAmount?.toFixed(2) || '0.00'}`,
                    'Monto Aponnt': `$${payment.aponntAmount?.toFixed(2) || '0.00'}`,
                    'Estado Pago': payment.isPaid ? 'Pagado' : 'Pendiente',
                    'M√©todo Pago': payment.paymentMethod || 'No definido',
                    'Fecha Pago': payment.paymentDate ? new Date(payment.paymentDate).toLocaleDateString('es-AR') : 'Sin pagar',
                    'Fecha Vencimiento': payment.dueDate ? new Date(payment.dueDate).toLocaleDateString('es-AR') : 'No definida',
                    'Fecha Creaci√≥n': new Date(payment.created_at).toLocaleDateString('es-AR'),
                    'Observaciones': payment.observations || 'Sin observaciones'
                }));

                // Crear workbook con m√∫ltiples hojas
                const wb = XLSX.utils.book_new();
                
                // Hoja principal de datos
                const ws = XLSX.utils.json_to_sheet(excelData);
                const colWidths = [
                    { wch: 20 }, // Empresa
                    { wch: 15 }, // Vendedor
                    { wch: 10 }, // Per√≠odo
                    { wch: 15 }, // Total Facturado
                    { wch: 15 }, // Subtotal sin IVA
                    { wch: 10 }, // Comisi√≥n %
                    { wch: 15 }, // Comisi√≥n Monto
                    { wch: 15 }, // Monto Aponnt
                    { wch: 12 }, // Estado Pago
                    { wch: 15 }, // M√©todo Pago
                    { wch: 15 }, // Fecha Pago
                    { wch: 15 }, // Fecha Vencimiento
                    { wch: 15 }, // Fecha Creaci√≥n
                    { wch: 30 }  // Observaciones
                ];
                ws['!cols'] = colWidths;
                XLSX.utils.book_append_sheet(wb, ws, 'Facturaci√≥n');

                // Hoja resumen por vendedor
                const vendorSummary = {};
                billingData.forEach(payment => {
                    const vendor = payment.vendor || 'Sin asignar';
                    if (!vendorSummary[vendor]) {
                        vendorSummary[vendor] = {
                            'Vendedor': vendor,
                            'Total Facturado': 0,
                            'Total Comisiones': 0,
                            'Pagos Cobrados': 0,
                            'Pagos Pendientes': 0,
                            'Empresas': new Set()
                        };
                    }
                    vendorSummary[vendor]['Total Facturado'] += payment.totalAmount;
                    vendorSummary[vendor]['Total Comisiones'] += payment.commissionAmount || 0;
                    if (payment.isPaid) {
                        vendorSummary[vendor]['Pagos Cobrados']++;
                    } else {
                        vendorSummary[vendor]['Pagos Pendientes']++;
                    }
                    vendorSummary[vendor]['Empresas'].add(payment.companyName);
                });

                const vendorSummaryData = Object.values(vendorSummary).map(vendor => ({
                    'Vendedor': vendor.Vendedor,
                    'Total Facturado': `$${vendor['Total Facturado'].toLocaleString()}`,
                    'Total Comisiones': `$${vendor['Total Comisiones'].toFixed(2)}`,
                    'Pagos Cobrados': vendor['Pagos Cobrados'],
                    'Pagos Pendientes': vendor['Pagos Pendientes'],
                    'Total Empresas': vendor['Empresas'].size,
                    'Empresas': Array.from(vendor['Empresas']).join(', ')
                }));

                const wsSummary = XLSX.utils.json_to_sheet(vendorSummaryData);
                wsSummary['!cols'] = [
                    { wch: 15 }, // Vendedor
                    { wch: 15 }, // Total Facturado
                    { wch: 15 }, // Total Comisiones
                    { wch: 12 }, // Pagos Cobrados
                    { wch: 12 }, // Pagos Pendientes
                    { wch: 12 }, // Total Empresas
                    { wch: 50 }  // Empresas
                ];
                XLSX.utils.book_append_sheet(wb, wsSummary, 'Resumen por Vendedor');

                // Descargar archivo
                const filename = `Facturacion_${month}_${year}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);

                showNotification(`Archivo ${filename} descargado exitosamente`, 'success');
            } catch (error) {
                console.error('Error exportando facturaci√≥n:', error);
                showNotification('Error al generar el archivo Excel', 'error');
            }
        }

        // Funci√≥n para cargar vendedores en el selector
        async function loadVendorsSelector() {
            try {
                const response = await fetch(`${API_BASE}/api/aponnt/dashboard/vendors`);
                if (!response.ok) throw new Error('Error obteniendo vendedores');

                const vendors = await response.json();
                const vendorSelect = document.getElementById('vendor');

                if (!vendorSelect) return;

                // Verificar que vendors sea un array
                if (!Array.isArray(vendors)) {
                    console.warn('vendors is not an array:', vendors);
                    return;
                }

                // Limpiar opciones existentes excepto la primera
                while (vendorSelect.children.length > 1) {
                    vendorSelect.removeChild(vendorSelect.lastChild);
                }

                // Agregar vendedores activos
                vendors
                    .filter(vendor => vendor && vendor.isActive)
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach(vendor => {
                        const option = document.createElement('option');
                        option.value = vendor.name;
                        option.textContent = `${vendor.name} (${vendor.email})`;
                        vendorSelect.appendChild(option);
                    });

            } catch (error) {
                console.error('Error cargando vendedores:', error);
            }
        }

        // Funci√≥n para cargar datos completos del vendedor asignado (readonly)
        async function loadAssignedVendorInfo(vendorName) {
            const vendorDisplayInput = document.getElementById('vendorDisplay');
            const vendorHiddenInput = document.getElementById('vendor');

            if (!vendorDisplayInput || !vendorHiddenInput) return;

            // Si no hay vendedor asignado
            if (!vendorName) {
                vendorDisplayInput.value = '';
                vendorDisplayInput.placeholder = 'No asignado';
                vendorHiddenInput.value = '';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/aponnt/dashboard/vendors`);
                if (!response.ok) throw new Error('Error obteniendo vendedores');

                const vendors = await response.json();

                // Verificar que vendors sea un array
                if (!Array.isArray(vendors)) {
                    vendorDisplayInput.value = vendorName;
                    vendorHiddenInput.value = vendorName;
                    return;
                }

                // Buscar el vendedor por nombre
                const vendor = vendors.find(v => v && v.name === vendorName);

                if (vendor) {
                    // Mostrar nombre, email y tel√©fono si est√° disponible en el campo visible
                    const vendorInfo = `${vendor.name} - ${vendor.email}${vendor.phone ? ' - Tel: ' + vendor.phone : ''}`;
                    vendorDisplayInput.value = vendorInfo;
                    // Guardar solo el nombre en el campo hidden para enviar al backend
                    vendorHiddenInput.value = vendor.name;
                } else {
                    // Si no se encuentra el vendedor, mostrar solo el nombre
                    vendorDisplayInput.value = vendorName;
                    vendorHiddenInput.value = vendorName;
                }

            } catch (error) {
                console.error('Error cargando datos del vendedor:', error);
                // En caso de error, mostrar solo el nombre
                vendorDisplayInput.value = vendorName || '';
                vendorHiddenInput.value = vendorName || '';
            }
        }

        // Funci√≥n auxiliar para obtener empresas filtradas
        async function getAllFilteredCompanies() {
            try {
                const response = await fetch(`${API_BASE}/dashboard/companies`);
                if (!response.ok) throw new Error('Error obteniendo empresas');
                
                let companies = await response.json();

                // Aplicar filtros si est√°n activos
                const nameFilter = document.getElementById('companyNameFilter')?.value?.toLowerCase() || '';
                const countryFilter = document.getElementById('companyCountryFilter')?.value || '';
                const statusFilter = document.getElementById('companyStatusFilter')?.value || '';
                const vendorFilter = document.getElementById('companyVendorFilter')?.value || '';

                if (nameFilter) {
                    companies = companies.filter(company => 
                        company.name.toLowerCase().includes(nameFilter) ||
                        company.email.toLowerCase().includes(nameFilter)
                    );
                }

                if (countryFilter) {
                    companies = companies.filter(company => company.country === countryFilter);
                }

                if (statusFilter) {
                    companies = companies.filter(company => company.status === statusFilter);
                }

                if (vendorFilter) {
                    companies = companies.filter(company => company.vendor === vendorFilter);
                }

                return companies;
            } catch (error) {
                console.error('Error obteniendo empresas filtradas:', error);
                return [];
            }
        }

        // ==========================================
        // FUNCIONES DE GESTI√ìN DE VENDEDORES
        // ==========================================

        let vendors = [];
        let currentEditingVendor = null;

        // Abrir modal para nuevo vendedor
        function openNewVendorModal() {
            console.log('üÜï Abriendo modal nuevo vendedor');

            currentEditingVendor = null;
            document.getElementById('vendorModalTitle').textContent = '‚ûï Nuevo Vendedor';
            document.getElementById('saveVendorBtnText').textContent = 'üíæ Guardar Vendedor';

            // Limpiar formulario
            document.getElementById('vendorForm').reset();
            document.getElementById('vendorSalesCommission').value = '10';
            document.getElementById('vendorSupportCommission').value = '5';
            document.getElementById('vendorAcceptsSupportPackages').value = 'true';
            document.getElementById('vendorAcceptsAuctions').value = 'true';
            document.getElementById('vendorStatus').value = 'activo';

            // Mostrar modal
            document.getElementById('vendorModal').classList.add('show');
        }

        // Abrir modal para editar vendedor
        function editVendor(vendorId) {
            console.log('‚úèÔ∏è Editando vendedor:', vendorId);

            const vendor = vendors.find(v => v.id == vendorId); // Usar == para comparaci√≥n flexible
            if (!vendor) {
                console.error('Vendedor no encontrado:', vendorId);
                console.log('Vendedores disponibles:', vendors.map(v => ({ id: v.id, name: v.name })));
                return;
            }

            console.log('üîç Estructura vendor para editar:', vendor);

            currentEditingVendor = vendor;
            document.getElementById('vendorModalTitle').textContent = '‚úèÔ∏è Editar Vendedor';
            document.getElementById('saveVendorBtnText').textContent = 'üíæ Actualizar Vendedor';

            // Cargar datos en el formulario usando la estructura correcta de la API
            document.getElementById('vendorName').value = vendor.name || '';
            document.getElementById('vendorEmail').value = vendor.email || '';
            document.getElementById('vendorPhone').value = vendor.phone || vendor.whatsapp || '';
            document.getElementById('vendorSalesCommission').value = vendor.salesCommission?.percentage || vendor.salesCommissionPercentage || vendor.commissionPercentage || 10;
            document.getElementById('vendorSupportCommission').value = vendor.supportCommission?.percentage || vendor.supportCommissionPercentage || 5;
            document.getElementById('vendorAcceptsSupportPackages').value = (vendor.acceptsSupport || vendor.acceptsSupportPackages) !== false ? 'true' : 'false';
            document.getElementById('vendorAcceptsAuctions').value = vendor.acceptsAuctions !== false ? 'true' : 'false';
            document.getElementById('vendorCBU').value = vendor.cbu || '';
            document.getElementById('vendorStatus').value = vendor.isActive !== false ? 'activo' : 'inactivo';
            document.getElementById('vendorNotes').value = vendor.notes || '';

            // Mostrar modal
            document.getElementById('vendorModal').classList.add('show');
        }

        // Cerrar modal de vendedor
        function closeVendorModal() {
            console.log('üö™ Cerrando modal vendedor');
            document.getElementById('vendorModal').classList.remove('show');
            currentEditingVendor = null;
        }

        // Guardar vendedor
        async function saveVendor() {
            console.log('üíæ Guardando vendedor...');

            // Validar formulario
            const name = document.getElementById('vendorName').value.trim();
            const email = document.getElementById('vendorEmail').value.trim();
            const salesCommission = parseFloat(document.getElementById('vendorSalesCommission').value);
            const supportCommission = parseFloat(document.getElementById('vendorSupportCommission').value) || 0;
            const acceptsSupportPackages = document.getElementById('vendorAcceptsSupportPackages').value === 'true';
            const acceptsAuctions = document.getElementById('vendorAcceptsAuctions').value === 'true';

            if (!name) {
                alert('‚ùå El nombre es obligatorio');
                return;
            }

            if (!email) {
                alert('‚ùå El email es obligatorio');
                return;
            }

            if (isNaN(salesCommission) || salesCommission < 0 || salesCommission > 100) {
                alert('‚ùå La comisi√≥n de ventas debe ser un n√∫mero entre 0 y 100');
                return;
            }

            if (supportCommission < 0 || supportCommission > 100) {
                alert('‚ùå La comisi√≥n de soporte debe ser un n√∫mero entre 0 y 100');
                return;
            }

            // Crear objeto vendedor adaptado a estructura aponnt_staff
            // Dividir nombre en first_name y last_name
            const nameParts = name.trim().split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || nameParts[0]; // Si solo hay 1 palabra, usar la misma

            const staffData = {
                first_name: firstName,
                last_name: lastName,
                email: email,
                phone: document.getElementById('vendorPhone').value.trim(),
                whatsapp_number: document.getElementById('vendorPhone').value.trim(), // Usar phone como whatsapp por defecto
                cbu: document.getElementById('vendorCBU').value.trim(),
                accepts_support_packages: acceptsSupportPackages,
                accepts_auctions: acceptsAuctions,
                is_active: document.getElementById('vendorStatus').value === 'activo',
                global_rating: 5.0, // Inicia con 5 estrellas

                // Campos de rol y √°rea (obligatorios para aponnt_staff)
                area: 'ventas',
                level: 4, // Nivel operativo (vendedores)
                country: 'AR', // Por defecto Argentina, luego se puede cambiar en modal completo
                language_preference: 'es',

                // Si estamos editando, incluir role_id del vendedor actual
                // Si es nuevo, necesitaremos buscar el role_id de 'VEND' (se debe hacer en backend)
            };

            // Si estamos editando, preservar campos adicionales
            if (currentEditingVendor) {
                staffData.role_id = currentEditingVendor.role?.role_id;
                staffData.country = currentEditingVendor.country || 'AR';
                staffData.language_preference = currentEditingVendor.language || 'es';
            }

            try {
                const saveBtn = document.getElementById('saveVendorBtn');
                saveBtn.disabled = true;
                saveBtn.innerHTML = '‚è≥ Guardando...';

                let response;
                if (currentEditingVendor) {
                    // Actualizar vendedor existente
                    const staffId = currentEditingVendor.staff_id;
                    response = await fetch(`/api/aponnt/staff-data/${staffId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(staffData)
                    });
                } else {
                    // Crear nuevo vendedor - Buscar role_id de VEND
                    console.log('üîç Buscando role_id para VEND...');
                    const rolesResponse = await fetch('/api/aponnt/staff-data/roles');
                    if (!rolesResponse.ok) {
                        throw new Error('Error obteniendo roles');
                    }
                    const rolesData = await rolesResponse.json();
                    const vendRole = rolesData.data.find(r => r.role_code === 'VEND');

                    if (!vendRole) {
                        throw new Error('Rol VEND no encontrado. Contacte al administrador.');
                    }

                    staffData.role_id = vendRole.role_id;
                    console.log('‚úÖ Role VEND encontrado:', vendRole.role_id);

                    response = await fetch('/api/aponnt/staff-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(staffData)
                    });
                }

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Vendedor guardado:', result);

                    closeVendorModal();
                    loadVendors(); // Recargar lista

                    const action = currentEditingVendor ? 'actualizado' : 'creado';
                    alert(`‚úÖ Vendedor ${action} exitosamente`);
                } else {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch {
                        errorData = await response.text();
                    }

                    console.error('‚ùå Error guardando vendedor:', errorData);

                    // Mostrar mensaje espec√≠fico seg√∫n el error
                    let errorMessage = '‚ùå Error guardando vendedor';
                    if (typeof errorData === 'object' && errorData.error) {
                        if (errorData.error.includes('email') || errorData.error.includes('Ya existe')) {
                            errorMessage = '‚ùå Ya existe un vendedor con este email. Usa un email diferente.';
                        } else {
                            errorMessage = `‚ùå ${errorData.error}`;
                        }
                    } else if (typeof errorData === 'string' && errorData.includes('email')) {
                        errorMessage = '‚ùå Ya existe un vendedor con este email. Usa un email diferente.';
                    }

                    alert(errorMessage);
                }
            } catch (error) {
                console.error('‚ùå Error guardando vendedor:', error);
                alert('‚ùå Error de conexi√≥n. Revisa la consola.');
            } finally {
                const saveBtn = document.getElementById('saveVendorBtn');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<span id="saveVendorBtnText">üíæ Guardar Vendedor</span>';
            }
        }

        // Cargar lista de vendedores con m√©tricas completas
        async function loadVendors() {
            console.log('üìã Cargando vendedores desde aponnt_staff...');

            try {
                // Cargar vendedores desde la nueva tabla aponnt_staff (√°rea=ventas)
                const response = await fetch('/api/aponnt/staff-data?area=ventas');

                if (response.ok) {
                    const data = await response.json();
                    console.log('üì¶ Respuesta API vendedores (aponnt_staff):', data);

                    // La API devuelve { success: true, count: X, data: [...] }
                    const staffVendors = data.data || [];

                    // Mapear campos de aponnt_staff a estructura de vendor
                    vendors = staffVendors.map(staff => ({
                        // IDs y datos b√°sicos
                        id: staff.user_id || staff.staff_id,  // Usar user_id si existe, sino staff_id
                        staff_id: staff.staff_id,
                        user_id: staff.user_id,
                        name: `${staff.first_name} ${staff.last_name}`,
                        email: staff.email,
                        phone: staff.phone,
                        whatsapp: staff.whatsapp_number,

                        // Datos bancarios y estado
                        cbu: staff.cbu,
                        bank_name: staff.bank_name,
                        rating: staff.global_rating || 0,
                        isActive: staff.is_active,
                        status: staff.is_active ? 'activo' : 'inactivo',

                        // Pa√≠s e idioma
                        country: staff.country,
                        language: staff.language_preference,

                        // Configuraci√≥n de vendedor
                        acceptsSupportPackages: staff.accepts_support_packages,
                        acceptsSupport: staff.accepts_support_packages,
                        acceptsAuctions: staff.accepts_auctions,

                        // Rol y jerarqu√≠a
                        role: staff.role,
                        level: staff.level,
                        area: staff.area,
                        supervisor: staff.supervisor,

                        // M√©tricas (por ahora en 0, se cargar√°n despu√©s con vendor_statistics)
                        companies: 0,
                        salesUsers: 0,
                        supportUsers: 0,
                        salesCommission: { percentage: 0, amount: 0 },
                        supportCommission: { percentage: 0, amount: 0 },
                        referralCommission: { referrals: 0, amount: 0 },
                        totalCommission: 0,
                        totalModuleValue: 0,

                        // Comisiones legacy (para retrocompatibilidad)
                        commissionPercentage: 0,
                        salesCommissionPercentage: 0,
                        supportCommissionPercentage: 0
                    }));

                    console.log(`‚úÖ ${vendors.length} vendedores cargados desde aponnt_staff`);
                    renderVendors();
                } else {
                    console.error('‚ùå Error cargando vendedores:', response.status);
                    vendors = [];
                    renderVendors();
                }
            } catch (error) {
                console.error('‚ùå Error cargando vendedores:', error);
                vendors = [];
                renderVendors();
            }
        }

        // Renderizar lista de vendedores
        function renderVendors() {
            const container = document.getElementById('vendorsContainer');

            if (!container) {
                console.warn('‚ö†Ô∏è Contenedor vendorsContainer no encontrado');
                return;
            }

            if (!vendors || vendors.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë•</div>
                        <h3>No hay vendedores registrados</h3>
                        <p>Comienza agregando tu primer vendedor</p>
                        <button class="btn btn-primary" onclick="openNewVendorModal()">
                            ‚ûï Agregar Primer Vendedor
                        </button>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <div class="vendors-table-container">
                    <div class="table-header">
                        <h3 style="font-size: 1rem;">üë• Vendedores (${vendors.length})</h3>
                        <div class="table-actions">
                            <button class="btn btn-success" onclick="openNewVendorModal()">
                                ‚ûï Nuevo Vendedor
                            </button>
                            <button class="btn btn-info" onclick="exportVendorsToExcel()">
                                üìä Exportar Excel
                            </button>
                        </div>
                    </div>

                    <table class="vendors-simple-table">
                        <thead>
                            <tr>
                                <th style="width: 240px;">üë§ Vendedor</th>
                                <th style="width: 80px;">üè¢ Empresas</th>
                                <th style="width: 120px;">üë• Usuarios<br><small>Sales / Support</small></th>
                                <th style="width: 140px;">üí∞ Comisi√≥n Ventas<br><small>Porcentaje / Monto</small></th>
                                <th style="width: 140px;">üõ†Ô∏è Comisi√≥n Soporte<br><small>Porcentaje / Monto</small></th>
                                <th style="width: 140px;">üë• Referidos<br><small>Cantidad / Comisi√≥n</small></th>
                                <th style="width: 120px;">üíµ Total General<br><small>Comisiones</small></th>
                                <th style="width: 130px;">üìä Valor Total<br><small>M√≥dulos</small></th>
                                <th style="width: 110px;">üì± Contacto</th>
                                <th style="width: 120px;">üìã Estado<br><small>CBU / Rating</small></th>
                                <th style="width: 100px;">‚öôÔ∏è Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${vendors.map(vendor => {
                                const isActive = vendor.isActive !== false && vendor.status !== 'inactivo';
                                const salesCommission = vendor.salesCommission || {};
                                const supportCommission = vendor.supportCommission || {};
                                const referralCommission = vendor.referralCommission || {};

                                return `
                                <tr class="${!isActive ? 'inactive-row' : ''}">
                                    <td>
                                        <div class="vendor-info">
                                            <strong>${vendor.name}</strong>
                                            <small>${vendor.email}</small>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <strong style="font-size: 0.5rem;">${vendor.companies || 0}</strong>
                                    </td>
                                    <td class="text-center">
                                        <div style="line-height: 1.2;">
                                            <div><strong style="color: #10b981; font-size: 0.6rem;">${vendor.salesUsers || 0}</strong> <span style="color: #6b7280; font-size: 0.55rem;">ventas</span></div>
                                            <div><strong style="color: #3b82f6; font-size: 0.6rem;">${vendor.supportUsers || 0}</strong> <span style="color: #6b7280; font-size: 0.55rem;">soporte</span></div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div style="line-height: 1.2;">
                                            <span class="badge badge-sales" style="margin-bottom: 2px;">${salesCommission.percentage ? salesCommission.percentage.toFixed(1) : 0}%</span>
                                            <div class="number-cell" style="font-size: 0.425rem;">$${salesCommission.amount ? salesCommission.amount.toLocaleString('es-AR') : 0}</div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div style="line-height: 1.2;">
                                            <span class="badge badge-support" style="margin-bottom: 2px;">${supportCommission.percentage ? supportCommission.percentage.toFixed(1) : 0}%</span>
                                            <div class="number-cell" style="font-size: 0.425rem;">$${supportCommission.amount ? supportCommission.amount.toLocaleString('es-AR') : 0}</div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div style="line-height: 1.2;">
                                            <div><strong style="color: #8b5cf6; font-size: 0.6rem;">${referralCommission.referrals || 0}</strong> <span style="color: #6b7280; font-size: 0.55rem;">referidos</span></div>
                                            <div class="number-cell" style="font-size: 0.55rem; color: #8b5cf6;">$${referralCommission.amount ? referralCommission.amount.toLocaleString('es-AR') : 0}</div>
                                        </div>
                                    </td>
                                    <td class="number-cell">
                                        <strong style="color: #f59e0b; font-size: 0.5rem;">$${vendor.totalCommission ? vendor.totalCommission.toLocaleString('es-AR') : 0}</strong>
                                    </td>
                                    <td class="number-cell">
                                        <strong style="color: #3b82f6; font-size: 0.5rem;">$${vendor.totalModuleValue ? vendor.totalModuleValue.toLocaleString('es-AR') : 0}</strong>
                                    </td>
                                    <td class="text-center">
                                        <div style="line-height: 1.2;">
                                            ${vendor.phone ? `<div style="font-size: 0.55rem;">üìû ${vendor.phone}</div>` : ''}
                                            ${vendor.whatsapp ? `<div style="font-size: 0.55rem;">üì± ${vendor.whatsapp}</div>` : ''}
                                            ${vendor.email ? `<div style="font-size: 0.5rem; color: #6b7280;">‚úâÔ∏è ${vendor.email.split('@')[0]}</div>` : ''}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div style="line-height: 1.2;">
                                            <span class="badge ${isActive ? 'badge-active' : 'badge-inactive'}" style="margin-bottom: 2px;">
                                                ${isActive ? 'Act' : 'Inact'}
                                            </span>
                                            ${vendor.cbu ? `<div style="font-size: 0.4rem; color: #6b7280;">CBU: ...${vendor.cbu.slice(-4)}</div>` : '<div style="font-size: 0.4rem; color: #ef4444;">Sin CBU</div>'}
                                            ${vendor.rating ? `<div style="font-size: 0.4rem; color: #f59e0b;">‚≠ê ${vendor.rating}/5</div>` : ''}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="simple-actions" style="display: flex; gap: 4px; justify-content: center;">
                                            <button class="btn-simple btn-edit" onclick="editVendor('${vendor.id}')" title="Editar" style="font-size: 0.5rem; padding: 3px 4px;">‚úèÔ∏è</button>
                                            <button class="btn-simple btn-delete" onclick="deleteVendor('${vendor.id}')" title="Eliminar" style="font-size: 0.5rem; padding: 3px 4px;">üóëÔ∏è</button>
                                            <button class="btn-simple btn-view" onclick="viewVendorDetails('${vendor.id}')" title="Ver detalles" style="font-size: 0.5rem; padding: 3px 4px;">üëÅÔ∏è</button>
                                        </div>
                                    </td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    </div>
                </div>
            `;

            container.innerHTML = tableHTML;
        }

        /**
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         * ‚úÖ NUEVO: M√ìDULOS DE VENDOR INVOICING Y PARTNER SCORING
         * ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         */

        // Cargar m√≥dulo de Vendor Invoicing System
        async function loadVendorInvoicingModule() {
            try {
                const response = await fetch('/js/modules/vendor-invoicing-system.js');
                const moduleCode = await response.text();
                const script = document.createElement('script');
                script.textContent = moduleCode;
                document.head.appendChild(script);
                console.log('‚úÖ [ADMIN] Vendor Invoicing System m√≥dulo cargado');

                // Inicializar m√≥dulo cuando se active la tab de vendors
                if (typeof VendorInvoicingSystem !== 'undefined' && window.location.hash === '#vendors') {
                    VendorInvoicingSystem.init();
                }
            } catch (error) {
                console.error('‚ùå Error cargando Vendor Invoicing System:', error);
            }
        }

        // Cargar m√≥dulo de Partner Scoring System
        async function loadPartnerScoringModule() {
            try {
                const response = await fetch('/js/modules/partner-scoring-system.js');
                const moduleCode = await response.text();
                const script = document.createElement('script');
                script.textContent = moduleCode;
                document.head.appendChild(script);
                console.log('‚úÖ [ADMIN] Partner Scoring System m√≥dulo cargado');

                // Inicializar m√≥dulo cuando se active la tab de partners
                if (typeof PartnerScoringSystem !== 'undefined' && window.location.hash === '#partners') {
                    PartnerScoringSystem.init();
                }
            } catch (error) {
                console.error('‚ùå Error cargando Partner Scoring System:', error);
            }
        }

        // Ver detalles del vendedor
        function viewVendorDetails(vendorId) {
            const vendor = vendors.find(v => v.id == vendorId);
            if (!vendor) {
                console.error('Vendedor no encontrado:', vendorId);
                alert('‚ùå Vendedor no encontrado');
                return;
            }

            const details = `
üßë‚Äçüíº DETALLES DEL VENDEDOR

üìù Informaci√≥n Personal:
‚Ä¢ ID: ${vendor.id}
‚Ä¢ Nombre: ${vendor.name}
‚Ä¢ Email: ${vendor.email}
‚Ä¢ Tel√©fono: ${vendor.phone || 'No especificado'}

üí∞ Comisiones:
‚Ä¢ Ventas: ${vendor.salesCommissionPercentage || vendor.commissionPercentage || 0}%
‚Ä¢ Soporte: ${vendor.supportCommissionPercentage || 0}%

üì¶ Soporte:
‚Ä¢ Acepta paquetes: ${(vendor.acceptsSupport || vendor.acceptsSupportPackages) ? 'S√≠' : 'No'}
‚Ä¢ Acepta subastas: ${vendor.acceptsAuctions ? 'S√≠' : 'No'}

üí≥ Informaci√≥n Bancaria:
‚Ä¢ CBU: ${vendor.cbu || 'No especificado'}

üìä Estado:
‚Ä¢ Estado: ${vendor.status || 'activo'}
‚Ä¢ Rating Global: ${vendor.globalRating || 0}/5
‚Ä¢ Paquetes de Soporte: ${vendor.totalSupportPackages || 0} total, ${vendor.activeSupportPackages || 0} activos

üìù Notas:
${vendor.notes || 'Sin notas adicionales'}
            `;

            alert(details);
        }

        // Eliminar vendedor
        async function deleteVendor(vendorId) {
            const vendor = vendors.find(v => v.id == vendorId); // Usar == para comparaci√≥n flexible
            if (!vendor) {
                console.error('Vendedor no encontrado para eliminar:', vendorId);
                return;
            }

            if (!confirm(`¬øEst√°s seguro de eliminar al vendedor "${vendor.name}"?`)) {
                return;
            }

            try {
                // Usar staff_id para eliminar (soft delete via is_active = false)
                const staffId = vendor.staff_id;
                const response = await fetch(`/api/aponnt/staff-data/${staffId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    console.log('‚úÖ Vendedor desactivado (soft delete)');
                    loadVendors(); // Recargar lista
                    alert('‚úÖ Vendedor desactivado exitosamente');
                } else {
                    console.error('‚ùå Error eliminando vendedor');
                    alert('‚ùå Error eliminando vendedor');
                }
            } catch (error) {
                console.error('‚ùå Error eliminando vendedor:', error);
                alert('‚ùå Error de conexi√≥n');
            }
        }

        // Ver detalles completos del vendedor
        function viewVendorDetails(vendorId) {
            console.log('üëÅÔ∏è Viendo detalles del vendedor:', vendorId);

            const vendor = vendors.find(v => v.id == vendorId); // Usar == para comparaci√≥n flexible
            if (!vendor) {
                console.error('Vendedor no encontrado:', vendorId);
                alert('‚ùå Vendedor no encontrado');
                return;
            }

            console.log('üîç Estructura completa del vendor:', vendor);
            console.log('üìä Comisiones detectadas:', {
                salesCommission: vendor.salesCommission,
                supportCommission: vendor.supportCommission,
                referralCommission: vendor.referralCommission,
                acceptsSupport: vendor.acceptsSupport,
                acceptsSupportPackages: vendor.acceptsSupportPackages,
                acceptsAuctions: vendor.acceptsAuctions
            });

            // Crear modal de detalles
            const modalHTML = `
                <div id="vendorDetailsModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2>üëÅÔ∏è Detalles del Vendedor: ${vendor.name}</h2>
                            <span class="close" onclick="document.getElementById('vendorDetailsModal').remove()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h3>üìã Informaci√≥n Personal</h3>
                                    <p><strong>Nombre:</strong> ${vendor.name}</p>
                                    <p><strong>Email:</strong> ${vendor.email}</p>
                                    <p><strong>Tel√©fono:</strong> ${vendor.phone || vendor.whatsapp || 'No especificado'}</p>
                                    <p><strong>WhatsApp:</strong> ${vendor.whatsapp || 'No especificado'}</p>
                                    <p><strong>C√≥digo:</strong> ${vendor.vendorCode || vendor.vendor_code || 'Sin c√≥digo'}</p>
                                    <p><strong>Estado:</strong> <span class="badge ${vendor.isActive !== false ? 'badge-active' : 'badge-inactive'}">${vendor.isActive !== false ? 'Activo' : 'Inactivo'}</span></p>
                                </div>
                                <div>
                                    <h3>üè¢ Informaci√≥n Comercial</h3>
                                    <p><strong>Empresas:</strong> ${vendor.companies || 0}</p>
                                    <p><strong>Usuarios Ventas:</strong> ${vendor.salesUsers || 0}</p>
                                    <p><strong>Usuarios Soporte:</strong> ${vendor.supportUsers || 0}</p>
                                    <p><strong>Total Usuarios:</strong> ${vendor.totalUsers || 0}</p>
                                    <p><strong>Rating:</strong> ${vendor.rating ? vendor.rating + '/5 ‚≠ê' : 'Sin rating'}</p>
                                    <p><strong>CBU:</strong> ${vendor.cbu || 'No registrado'}</p>
                                </div>
                            </div>

                            <div style="margin-top: 20px;">
                                <h3>üí∞ Comisiones</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                                        <h4 style="color: #10b981;">üè∑Ô∏è Ventas</h4>
                                        <p><strong>Porcentaje:</strong> ${(vendor.salesCommission?.percentage || vendor.salesCommissionPercentage || vendor.commissionPercentage || 10).toFixed(1)}%</p>
                                        <p><strong>Monto:</strong> $${vendor.salesCommission?.amount?.toLocaleString('es-AR') || 0}</p>
                                    </div>
                                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                                        <h4 style="color: #3b82f6;">üõ†Ô∏è Soporte</h4>
                                        <p><strong>Porcentaje:</strong> ${(vendor.supportCommission?.percentage || vendor.supportCommissionPercentage || 5).toFixed(1)}%</p>
                                        <p><strong>Monto:</strong> $${vendor.supportCommission?.amount?.toLocaleString('es-AR') || 0}</p>
                                    </div>
                                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                                        <h4 style="color: #8b5cf6;">üë• Referidos</h4>
                                        <p><strong>Cantidad:</strong> ${vendor.referralCommission?.referrals || 0}</p>
                                        <p><strong>Monto:</strong> $${vendor.referralCommission?.amount?.toLocaleString('es-AR') || 0}</p>
                                    </div>
                                </div>

                                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <h4>üíµ Totales</h4>
                                    <p><strong>Total Comisiones:</strong> <span style="color: #f59e0b; font-size: 1.2em;">$${vendor.totalCommission?.toLocaleString('es-AR') || 0}</span></p>
                                    <p><strong>Valor Total M√≥dulos:</strong> <span style="color: #3b82f6;">$${vendor.totalModuleValue?.toLocaleString('es-AR') || 0}</span></p>
                                </div>
                            </div>

                            <div style="margin-top: 20px;">
                                <h3>‚öôÔ∏è Configuraciones</h3>
                                <p><strong>Acepta Paquetes de Soporte:</strong> ${(vendor.acceptsSupport || vendor.acceptsSupportPackages) !== false ? '‚úÖ S√≠' : '‚ùå No'}</p>
                                <p><strong>Acepta Subastas:</strong> ${vendor.acceptsAuctions !== false ? '‚úÖ S√≠' : '‚ùå No'}</p>
                                <p><strong>Empresa:</strong> ${vendor.company || 'Sin empresa asignada'}</p>
                                <p><strong>C√≥digo Vendedor:</strong> ${vendor.vendorCode || vendor.vendor_code || 'No asignado'}</p>
                                <p><strong>Estado:</strong> ${vendor.status || (vendor.isActive !== false ? 'Activo' : 'Inactivo')}</p>
                            </div>

                            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <h4>üîç Debug - Propiedades Detectadas</h4>
                                <small style="color: #6b7280;">
                                    <strong>acceptsSupport:</strong> ${vendor.acceptsSupport ? 'true' : 'false'} |
                                    <strong>acceptsSupportPackages:</strong> ${vendor.acceptsSupportPackages ? 'true' : 'false'} |
                                    <strong>acceptsAuctions:</strong> ${vendor.acceptsAuctions ? 'true' : 'false'}
                                </small>
                                <br><small style="color: #6b7280;">
                                    <strong>salesCommission:</strong> ${vendor.salesCommission ? JSON.stringify(vendor.salesCommission) : 'undefined'}<br>
                                    <strong>supportCommission:</strong> ${vendor.supportCommission ? JSON.stringify(vendor.supportCommission) : 'undefined'}
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="editVendor('${vendor.id}'); document.getElementById('vendorDetailsModal').remove();">‚úèÔ∏è Editar</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('vendorDetailsModal').remove()">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;

            // Agregar modal al body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Exportar vendedores a Excel
        function exportVendorsToExcel() {
            console.log('üìä Exportando vendedores a Excel...');

            if (!vendors || vendors.length === 0) {
                alert('‚ö†Ô∏è No hay vendedores para exportar');
                return;
            }

            // Preparar datos para Excel
            const excelData = vendors.map(vendor => ({
                'Nombre': vendor.name,
                'Email': vendor.email,
                'Tel√©fono': vendor.phone || '',
                'Comisi√≥n (%)': vendor.commissionPercentage,
                'CBU': vendor.cbu || '',
                'Estado': vendor.status,
                'Notas': vendor.notes || ''
            }));

            // Crear libro de Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);

            // Ajustar ancho de columnas
            ws['!cols'] = [
                { wch: 25 }, // Nombre
                { wch: 30 }, // Email
                { wch: 15 }, // Tel√©fono
                { wch: 12 }, // Comisi√≥n
                { wch: 22 }, // CBU
                { wch: 10 }, // Estado
                { wch: 40 }  // Notas
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Vendedores');

            // Descargar archivo
            const fileName = `vendedores_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);

            console.log('‚úÖ Excel exportado:', fileName);
        }

        // ============================================
        // FUNCIONES DE GESTI√ìN DE STAFF APONNT
        // ============================================

        let staffMembers = [];
        let staffRoles = [];
        let currentEditingStaff = null;

        // Cargar roles disponibles
        async function loadStaffRoles() {
            try {
                const response = await fetch('/api/aponnt/staff-data/roles');
                if (!response.ok) {
                    console.error('‚ùå Error cargando roles:', response.status);
                    return;
                }

                const data = await response.json();
                staffRoles = data.data || [];

                // Popular select de roles en el modal
                const roleSelect = document.getElementById('staffRole');
                if (roleSelect) {
                    roleSelect.innerHTML = '<option value="">-- Seleccionar Rol --</option>';
                    staffRoles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.role_id;
                        option.textContent = `${role.role_name} (${role.role_code}) - Nivel ${role.level}`;
                        option.dataset.area = role.role_area;
                        option.dataset.level = role.level;
                        roleSelect.appendChild(option);
                    });
                }

                console.log(`‚úÖ ${staffRoles.length} roles cargados`);
            } catch (error) {
                console.error('‚ùå Error cargando roles:', error);
            }
        }

        // Cargar lista de staff
        async function loadStaff() {
            console.log('üìã Cargando staff desde aponnt_staff...');

            try {
                // Obtener filtros
                const area = document.getElementById('staffFilterArea')?.value || '';
                const country = document.getElementById('staffFilterCountry')?.value || '';
                const isActive = document.getElementById('staffFilterStatus')?.value || '';

                // Construir query string
                const params = new URLSearchParams();
                if (area) params.append('area', area);
                if (country) params.append('country', country);
                if (isActive !== '') params.append('is_active', isActive);

                const response = await fetch(`/api/aponnt/staff-data?${params.toString()}`);

                if (response.ok) {
                    const data = await response.json();
                    console.log('üì¶ Respuesta API staff:', data);

                    staffMembers = data.data || [];
                    console.log(`‚úÖ ${staffMembers.length} staff members cargados`);
                    renderStaffTable();
                } else {
                    console.error('‚ùå Error cargando staff:', response.status);
                    staffMembers = [];
                    renderStaffTable();
                }
            } catch (error) {
                console.error('‚ùå Error cargando staff:', error);
                staffMembers = [];
                renderStaffTable();
            }
        }

        // Renderizar tabla de staff
        function renderStaffTable() {
            const container = document.getElementById('staffTableContainer');

            if (!container) {
                console.warn('‚ö†Ô∏è Contenedor staffTableContainer no encontrado');
                return;
            }

            if (!staffMembers || staffMembers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üëî</div>
                        <h3>No hay staff registrado</h3>
                        <p>Comienza agregando el primer staff member</p>
                        <button class="btn btn-primary" onclick="openNewStaffModal()">
                            ‚ûï Agregar Primer Staff
                        </button>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="data-table" style="width: 100%; font-size: 0.9rem;">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>√Årea</th>
                            <th>Pa√≠s</th>
                            <th>Supervisor</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${staffMembers.map(staff => `
                            <tr>
                                <td><strong>${staff.first_name} ${staff.last_name}</strong></td>
                                <td>${staff.email}</td>
                                <td>${staff.role ? staff.role.role_name : 'Sin rol'}</td>
                                <td>
                                    ${staff.area === 'ventas' ? 'üíº Ventas' :
                                      staff.area === 'admin' ? 'üìä Admin' :
                                      staff.area === 'desarrollo' ? 'üíª Desarrollo' :
                                      staff.area === 'externo' ? 'üåê Externo' :
                                      staff.area === 'direccion' ? 'üëî Direcci√≥n' : staff.area}
                                </td>
                                <td>${staff.country}</td>
                                <td>${staff.supervisor ? staff.supervisor.first_name + ' ' + staff.supervisor.last_name : 'CEO'}</td>
                                <td>
                                    <span class="badge ${staff.is_active ? 'badge-active' : 'badge-inactive'}">
                                        ${staff.is_active ? '‚úÖ Activo' : '‚ùå Inactivo'}
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 5px; justify-content: center;">
                                        <button class="btn btn-sm btn-info" onclick="editStaff('${staff.staff_id}')" title="Editar">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteStaff('${staff.staff_id}')" title="Eliminar">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // Abrir modal para nuevo staff
        async function openNewStaffModal() {
            console.log('üÜï Abriendo modal nuevo staff');

            currentEditingStaff = null;
            document.getElementById('staffModalTitle').textContent = '‚ûï Nuevo Staff Member';
            document.getElementById('saveStaffBtnText').textContent = 'üíæ Guardar Staff';

            // Cargar roles si no est√°n cargados
            if (staffRoles.length === 0) {
                await loadStaffRoles();
            }

            // Cargar supervisores potenciales
            await loadPotentialSupervisors();

            // Limpiar formulario
            document.getElementById('staffForm').reset();
            document.getElementById('staffStatus').value = 'true';
            document.getElementById('staffLanguage').value = 'es';
            document.getElementById('staffCountry').value = 'AR';
            document.getElementById('staffAcceptsSupportPackages').value = 'true';
            document.getElementById('staffAcceptsAuctions').value = 'true';

            // Ocultar campos de vendedor por defecto
            document.getElementById('vendorFieldsSection').style.display = 'none';

            // Mostrar modal
            document.getElementById('staffModal').style.display = 'flex';
        }

        // Cargar supervisores potenciales
        async function loadPotentialSupervisors() {
            try {
                const response = await fetch('/api/aponnt/staff-data');
                if (!response.ok) return;

                const data = await response.json();
                const allStaff = data.data || [];

                const supervisorSelect = document.getElementById('staffSupervisor');
                if (supervisorSelect) {
                    supervisorSelect.innerHTML = '<option value="">-- Sin supervisor (reporta a CEO) --</option>';
                    allStaff.forEach(staff => {
                        if (staff.is_active && staff.level <= 2) { // Solo nivel 0, 1, 2 pueden ser supervisores
                            const option = document.createElement('option');
                            option.value = staff.staff_id;
                            option.textContent = `${staff.first_name} ${staff.last_name} (${staff.role?.role_name || 'Sin rol'})`;
                            supervisorSelect.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('‚ùå Error cargando supervisores:', error);
            }
        }

        // Actualizar campos del formulario seg√∫n rol seleccionado
        function updateStaffFormFields() {
            const roleSelect = document.getElementById('staffRole');
            const selectedOption = roleSelect.options[roleSelect.selectedIndex];
            const area = selectedOption?.dataset?.area;

            const vendorFieldsSection = document.getElementById('vendorFieldsSection');

            // Mostrar campos de vendedor solo si el √°rea es 'ventas'
            if (area === 'ventas') {
                vendorFieldsSection.style.display = 'block';
            } else {
                vendorFieldsSection.style.display = 'none';
            }
        }

        // Editar staff
        async function editStaff(staffId) {
            console.log('‚úèÔ∏è Editando staff:', staffId);

            const staff = staffMembers.find(s => s.staff_id === staffId);
            if (!staff) {
                console.error('Staff no encontrado:', staffId);
                return;
            }

            currentEditingStaff = staff;
            document.getElementById('staffModalTitle').textContent = '‚úèÔ∏è Editar Staff Member';
            document.getElementById('saveStaffBtnText').textContent = 'üíæ Actualizar Staff';

            // Cargar roles y supervisores
            if (staffRoles.length === 0) {
                await loadStaffRoles();
            }
            await loadPotentialSupervisors();

            // Cargar datos en el formulario
            document.getElementById('staffFirstName').value = staff.first_name || '';
            document.getElementById('staffLastName').value = staff.last_name || '';
            document.getElementById('staffEmail').value = staff.email || '';
            document.getElementById('staffPhone').value = staff.phone || '';
            document.getElementById('staffRole').value = staff.role?.role_id || '';
            document.getElementById('staffCountry').value = staff.country || 'AR';
            document.getElementById('staffSupervisor').value = staff.reports_to_staff_id || '';
            document.getElementById('staffLanguage').value = staff.language_preference || 'es';
            document.getElementById('staffStatus').value = staff.is_active ? 'true' : 'false';

            // Campos de vendedor
            document.getElementById('staffCBU').value = staff.cbu || '';
            document.getElementById('staffBankName').value = staff.bank_name || '';
            document.getElementById('staffWhatsapp').value = staff.whatsapp_number || '';
            document.getElementById('staffAcceptsSupportPackages').value = staff.accepts_support_packages ? 'true' : 'false';
            document.getElementById('staffAcceptsAuctions').value = staff.accepts_auctions ? 'true' : 'false';

            // Actualizar visibilidad de campos seg√∫n √°rea
            updateStaffFormFields();

            // Mostrar modal
            document.getElementById('staffModal').style.display = 'flex';
        }

        // Cerrar modal de staff
        function closeStaffModal() {
            console.log('üö™ Cerrando modal staff');
            document.getElementById('staffModal').style.display = 'none';
            currentEditingStaff = null;
        }

        // Guardar staff
        async function saveStaff() {
            console.log('üíæ Guardando staff...');

            // Validar campos
            const firstName = document.getElementById('staffFirstName').value.trim();
            const lastName = document.getElementById('staffLastName').value.trim();
            const email = document.getElementById('staffEmail').value.trim();
            const roleId = document.getElementById('staffRole').value;
            const country = document.getElementById('staffCountry').value;

            if (!firstName || !lastName) {
                alert('‚ùå Nombre y apellido son obligatorios');
                return;
            }

            if (!email) {
                alert('‚ùå El email es obligatorio');
                return;
            }

            if (!roleId) {
                alert('‚ùå Debes seleccionar un rol');
                return;
            }

            // Obtener datos del rol seleccionado
            const selectedRole = staffRoles.find(r => r.role_id === roleId);

            // Crear objeto staff
            const staffData = {
                first_name: firstName,
                last_name: lastName,
                email: email,
                phone: document.getElementById('staffPhone').value.trim(),
                role_id: roleId,
                country: country,
                reports_to_staff_id: document.getElementById('staffSupervisor').value || null,
                language_preference: document.getElementById('staffLanguage').value,
                is_active: document.getElementById('staffStatus').value === 'true',

                // Campos denormalizados
                area: selectedRole?.role_area || 'admin',
                level: selectedRole?.level || 4,

                // Campos de vendedor (si aplica)
                cbu: document.getElementById('staffCBU').value.trim(),
                bank_name: document.getElementById('staffBankName').value.trim(),
                whatsapp_number: document.getElementById('staffWhatsapp').value.trim(),
                accepts_support_packages: document.getElementById('staffAcceptsSupportPackages').value === 'true',
                accepts_auctions: document.getElementById('staffAcceptsAuctions').value === 'true'
            };

            try {
                const saveBtn = document.getElementById('saveStaffBtn');
                saveBtn.disabled = true;
                saveBtn.innerHTML = '‚è≥ Guardando...';

                let response;
                if (currentEditingStaff) {
                    // Actualizar staff existente
                    response = await fetch(`/api/aponnt/staff-data/${currentEditingStaff.staff_id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(staffData)
                    });
                } else {
                    // Crear nuevo staff
                    response = await fetch('/api/aponnt/staff-data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(staffData)
                    });
                }

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Staff guardado:', result);

                    closeStaffModal();
                    loadStaff(); // Recargar lista

                    const action = currentEditingStaff ? 'actualizado' : 'creado';
                    alert(`‚úÖ Staff ${action} exitosamente`);
                } else {
                    const errorData = await response.json();
                    console.error('‚ùå Error guardando staff:', errorData);
                    alert(`‚ùå Error: ${errorData.message || 'Error guardando staff'}`);
                }
            } catch (error) {
                console.error('‚ùå Error guardando staff:', error);
                alert('‚ùå Error de conexi√≥n. Revisa la consola.');
            } finally {
                const saveBtn = document.getElementById('saveStaffBtn');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<span id="saveStaffBtnText">üíæ Guardar Staff</span>';
            }
        }

        // Eliminar staff
        async function deleteStaff(staffId) {
            const staff = staffMembers.find(s => s.staff_id === staffId);
            if (!staff) {
                console.error('Staff no encontrado para eliminar:', staffId);
                return;
            }

            if (!confirm(`¬øEst√°s seguro de desactivar a "${staff.first_name} ${staff.last_name}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/aponnt/staff-data/${staffId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    console.log('‚úÖ Staff desactivado');
                    loadStaff(); // Recargar lista
                    alert('‚úÖ Staff desactivado exitosamente');
                } else {
                    console.error('‚ùå Error eliminando staff');
                    alert('‚ùå Error eliminando staff');
                }
            } catch (error) {
                console.error('‚ùå Error eliminando staff:', error);
                alert('‚ùå Error de conexi√≥n');
            }
        }

        // Exportar staff a Excel
        function exportStaffToExcel() {
            console.log('üìä Exportando staff a Excel...');

            if (!staffMembers || staffMembers.length === 0) {
                alert('‚ö†Ô∏è No hay staff para exportar');
                return;
            }

            // Preparar datos para Excel
            const excelData = staffMembers.map(staff => ({
                'Nombre': staff.first_name,
                'Apellido': staff.last_name,
                'Email': staff.email,
                'Tel√©fono': staff.phone || '',
                'Rol': staff.role ? staff.role.role_name : '',
                '√Årea': staff.area,
                'Pa√≠s': staff.country,
                'Supervisor': staff.supervisor ? `${staff.supervisor.first_name} ${staff.supervisor.last_name}` : 'CEO',
                'Estado': staff.is_active ? 'Activo' : 'Inactivo',
                'CBU': staff.cbu || '',
                'WhatsApp': staff.whatsapp_number || ''
            }));

            // Crear libro de Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);

            // Ajustar ancho de columnas
            ws['!cols'] = [
                { wch: 15 }, // Nombre
                { wch: 15 }, // Apellido
                { wch: 30 }, // Email
                { wch: 15 }, // Tel√©fono
                { wch: 25 }, // Rol
                { wch: 15 }, // √Årea
                { wch: 10 }, // Pa√≠s
                { wch: 25 }, // Supervisor
                { wch: 10 }, // Estado
                { wch: 22 }, // CBU
                { wch: 15 }  // WhatsApp
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Staff Aponnt');

            // Descargar archivo
            const fileName = `staff_aponnt_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);

            console.log('‚úÖ Excel exportado:', fileName);
        }

        // ============================================================================
        // GESTI√ìN DE ROLES DE STAFF (STAFF ROLES)
        // ============================================================================

        // Variables globales para roles
        let allStaffRoles = [];
        let currentEditingRole = null;
        const BASE_ROLE_CODES = [
            'CEO', 'GG', 'GR-AR', 'GR-BR', 'GR-CL', 'GR-MX', 'GR-US', 'GR-ES',
            'GA', 'GD', 'JV-AR', 'JV-BR', 'JV-CL', 'JV-MX', 'JV-US', 'JV-ES',
            'CV-AR', 'CV-BR', 'CV-CL', 'CV-MX', 'CV-US', 'CV-ES',
            'VA', 'DA', 'SA', 'FREELANCE'
        ];

        // Cargar roles con filtros
        async function loadStaffRoles() {
            console.log('üìã Cargando roles de staff...');

            try {
                const response = await fetch('/api/aponnt/staff-data/roles');

                if (!response.ok) {
                    console.error('‚ùå Error cargando roles:', response.status);
                    allStaffRoles = [];
                    renderStaffRolesTable();
                    return;
                }

                const data = await response.json();
                allStaffRoles = data.data || [];
                console.log(`‚úÖ ${allStaffRoles.length} roles cargados`);

                // Aplicar filtros del lado del cliente
                const filterArea = document.getElementById('roleFilterArea')?.value || '';
                const filterLevel = document.getElementById('roleFilterLevel')?.value || '';

                let filteredRoles = [...allStaffRoles];

                if (filterArea) {
                    filteredRoles = filteredRoles.filter(role => role.role_area === filterArea);
                }

                if (filterLevel !== '') {
                    filteredRoles = filteredRoles.filter(role => role.level === parseInt(filterLevel));
                }

                renderStaffRolesTable(filteredRoles);

            } catch (error) {
                console.error('‚ùå Error cargando roles:', error);
                allStaffRoles = [];
                renderStaffRolesTable([]);
            }
        }

        // Renderizar tabla de roles
        function renderStaffRolesTable(rolesToDisplay = allStaffRoles) {
            const container = document.getElementById('staffRolesTableContainer');

            if (!rolesToDisplay || rolesToDisplay.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üé≠</div>
                        <h3>No hay roles registrados</h3>
                        <button class="btn btn-primary" onclick="openNewStaffRoleModal()">
                            ‚ûï Agregar Primer Rol
                        </button>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="data-table" style="width: 100%; font-size: 0.9rem;">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Nombre del Rol</th>
                            <th>Nivel</th>
                            <th>√Årea</th>
                            <th>Descripci√≥n</th>
                            <th>Base</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rolesToDisplay.map(role => {
                            const isBaseRole = BASE_ROLE_CODES.includes(role.role_code);
                            const levelLabel = ['CEO', 'Gerente', 'Jefe', 'Coordinador', 'Operativo'][role.level] || `Nivel ${role.level}`;
                            const areaIcon = getAreaIcon(role.role_area);

                            return `
                                <tr>
                                    <td><strong>${role.role_code}</strong></td>
                                    <td>${role.role_name}</td>
                                    <td>
                                        <span class="badge badge-info">
                                            ${role.level} - ${levelLabel}
                                        </span>
                                    </td>
                                    <td>${areaIcon}</td>
                                    <td style="max-width: 200px; font-size: 0.85rem; color: #666;">
                                        ${role.role_description || '<em>Sin descripci√≥n</em>'}
                                    </td>
                                    <td>
                                        ${isBaseRole
                                            ? '<span class="badge badge-warning">üîí Protegido</span>'
                                            : '<span class="badge badge-secondary">üÜì Personalizado</span>'
                                        }
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-info" onclick="editStaffRole('${role.role_id}')">
                                            ‚úèÔ∏è
                                        </button>
                                        ${!isBaseRole
                                            ? `<button class="btn btn-sm btn-danger" onclick="confirmDeleteStaffRole('${role.role_id}')">üóëÔ∏è</button>`
                                            : '<button class="btn btn-sm btn-secondary" disabled title="Rol base protegido">üîí</button>'
                                        }
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // Abrir modal para nuevo rol
        function openNewStaffRoleModal() {
            currentEditingRole = null;
            document.getElementById('staffRoleModalTitle').textContent = '‚ûï Nuevo Rol de Staff';

            // Reset form
            document.getElementById('staffRoleForm').reset();
            document.getElementById('baseRoleWarning').style.display = 'none';
            document.getElementById('deleteStaffRoleBtn').style.display = 'none';

            // Habilitar campos (por si venimos de editar un rol base)
            document.getElementById('roleCode').disabled = false;
            document.getElementById('roleLevel').disabled = false;
            document.getElementById('roleArea').disabled = false;

            // Mostrar modal
            document.getElementById('staffRoleModal').style.display = 'flex';
        }

        // Editar rol existente
        async function editStaffRole(roleId) {
            const role = allStaffRoles.find(r => r.role_id === roleId);
            if (!role) return;

            currentEditingRole = role;
            const isBaseRole = BASE_ROLE_CODES.includes(role.role_code);

            document.getElementById('staffRoleModalTitle').textContent = isBaseRole
                ? 'üîí Editar Rol Base (Solo i18n)'
                : '‚úèÔ∏è Editar Rol Personalizado';

            // Cargar datos b√°sicos
            document.getElementById('roleCode').value = role.role_code || '';
            document.getElementById('roleName').value = role.role_name || '';
            document.getElementById('roleLevel').value = role.level !== null ? role.level : '';
            document.getElementById('roleArea').value = role.role_area || '';
            document.getElementById('roleDescription').value = role.role_description || '';

            // Cargar traducciones i18n
            const i18n = role.role_name_i18n || {};
            document.getElementById('roleNameES').value = i18n.es || role.role_name || '';
            document.getElementById('roleNameEN').value = i18n.en || '';
            document.getElementById('roleNamePT').value = i18n.pt || '';
            document.getElementById('roleNameFR').value = i18n.fr || '';
            document.getElementById('roleNameDE').value = i18n.de || '';
            document.getElementById('roleNameIT').value = i18n.it || '';

            // Si es rol base, deshabilitar campos cr√≠ticos y mostrar warning
            if (isBaseRole) {
                document.getElementById('roleCode').disabled = true;
                document.getElementById('roleLevel').disabled = true;
                document.getElementById('roleArea').disabled = true;
                document.getElementById('baseRoleWarning').style.display = 'block';
                document.getElementById('deleteStaffRoleBtn').style.display = 'none';
            } else {
                document.getElementById('roleCode').disabled = false;
                document.getElementById('roleLevel').disabled = false;
                document.getElementById('roleArea').disabled = false;
                document.getElementById('baseRoleWarning').style.display = 'none';
                document.getElementById('deleteStaffRoleBtn').style.display = 'inline-block';
            }

            // Mostrar modal
            document.getElementById('staffRoleModal').style.display = 'flex';
        }

        // Cerrar modal de roles
        function closeStaffRoleModal() {
            console.log('üö™ Cerrando modal de roles');
            document.getElementById('staffRoleModal').style.display = 'none';
            currentEditingRole = null;
        }

        // Guardar rol (crear o actualizar)
        async function saveStaffRole() {
            console.log('üíæ Guardando rol...');

            // Validar campos obligatorios
            const roleCode = document.getElementById('roleCode').value.trim().toUpperCase();
            const roleName = document.getElementById('roleName').value.trim();
            const level = document.getElementById('roleLevel').value;
            const area = document.getElementById('roleArea').value;

            if (!roleCode || !roleName || level === '' || !area) {
                alert('‚ùå Campos obligatorios faltantes: C√≥digo, Nombre, Nivel y √Årea son requeridos');
                return;
            }

            // Construir objeto i18n
            const i18n = {
                es: document.getElementById('roleNameES').value.trim() || roleName,
                en: document.getElementById('roleNameEN').value.trim() || roleName,
                pt: document.getElementById('roleNamePT').value.trim() || roleName,
                fr: document.getElementById('roleNameFR').value.trim() || roleName,
                de: document.getElementById('roleNameDE').value.trim() || roleName,
                it: document.getElementById('roleNameIT').value.trim() || roleName
            };

            const roleData = {
                role_code: roleCode,
                role_name: roleName,
                level: parseInt(level),
                role_area: area,
                role_description: document.getElementById('roleDescription').value.trim() || null,
                role_name_i18n: i18n
            };

            try {
                const saveBtn = document.getElementById('saveStaffRoleBtn');
                saveBtn.disabled = true;
                saveBtn.innerHTML = '‚è≥ Guardando...';

                let response;
                if (currentEditingRole) {
                    // UPDATE
                    response = await fetch(`/api/aponnt/staff-data/roles/${currentEditingRole.role_id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(roleData)
                    });
                } else {
                    // CREATE
                    response = await fetch('/api/aponnt/staff-data/roles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(roleData)
                    });
                }

                if (response.ok) {
                    closeStaffRoleModal();
                    loadStaffRoles(); // Recargar lista
                    const action = currentEditingRole ? 'actualizado' : 'creado';
                    alert(`‚úÖ Rol ${action} exitosamente`);
                } else {
                    const errorData = await response.json();
                    alert(`‚ùå Error: ${errorData.message || 'Error guardando rol'}`);
                }

            } catch (error) {
                console.error('‚ùå Error guardando rol:', error);
                alert('‚ùå Error de conexi√≥n');
            } finally {
                const saveBtn = document.getElementById('saveStaffRoleBtn');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<span id="saveStaffRoleBtnText">üíæ Guardar Rol</span>';
            }
        }

        // Confirmar eliminaci√≥n de rol
        function confirmDeleteStaffRole(roleId) {
            const role = allStaffRoles.find(r => r.role_id === roleId);
            if (!role) return;

            if (BASE_ROLE_CODES.includes(role.role_code)) {
                alert('‚ö†Ô∏è Los roles base no pueden ser eliminados');
                return;
            }

            if (!confirm(`¬øEst√°s seguro de eliminar el rol "${role.role_name}" (${role.role_code})?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }

            deleteStaffRoleById(roleId);
        }

        // Eliminar rol (solo desde el modal)
        async function deleteStaffRole() {
            if (!currentEditingRole) return;

            if (BASE_ROLE_CODES.includes(currentEditingRole.role_code)) {
                alert('‚ö†Ô∏è Los roles base no pueden ser eliminados');
                return;
            }

            if (!confirm(`¬øEst√°s seguro de eliminar el rol "${currentEditingRole.role_name}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }

            deleteStaffRoleById(currentEditingRole.role_id);
        }

        // Eliminar rol por ID
        async function deleteStaffRoleById(roleId) {
            try {
                const response = await fetch(`/api/aponnt/staff-data/roles/${roleId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    closeStaffRoleModal();
                    loadStaffRoles();
                    alert('‚úÖ Rol eliminado exitosamente');
                } else {
                    const errorData = await response.json();
                    alert(`‚ùå Error: ${errorData.message || 'Error eliminando rol'}`);
                }

            } catch (error) {
                console.error('‚ùå Error eliminando rol:', error);
                alert('‚ùå Error de conexi√≥n');
            }
        }

        // Exportar roles a Excel
        function exportStaffRolesToExcel() {
            if (!allStaffRoles || allStaffRoles.length === 0) {
                alert('‚ö†Ô∏è No hay roles para exportar');
                return;
            }

            const excelData = allStaffRoles.map(role => {
                const isBaseRole = BASE_ROLE_CODES.includes(role.role_code);
                const levelLabel = ['CEO', 'Gerente', 'Jefe', 'Coordinador', 'Operativo'][role.level] || `Nivel ${role.level}`;
                const i18n = role.role_name_i18n || {};

                return {
                    'C√≥digo': role.role_code,
                    'Nombre (ES)': role.role_name,
                    'Nivel': `${role.level} - ${levelLabel}`,
                    '√Årea': role.role_area,
                    'Descripci√≥n': role.role_description || '',
                    'Tipo': isBaseRole ? 'Base (Protegido)' : 'Personalizado',
                    'Nombre (EN)': i18n.en || '',
                    'Nombre (PT)': i18n.pt || '',
                    'Nombre (FR)': i18n.fr || '',
                    'Nombre (DE)': i18n.de || '',
                    'Nombre (IT)': i18n.it || ''
                };
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);

            // Ajustar ancho de columnas
            ws['!cols'] = [
                { wch: 12 }, // C√≥digo
                { wch: 30 }, // Nombre (ES)
                { wch: 20 }, // Nivel
                { wch: 15 }, // √Årea
                { wch: 40 }, // Descripci√≥n
                { wch: 20 }, // Tipo
                { wch: 30 }, // Nombre (EN)
                { wch: 30 }, // Nombre (PT)
                { wch: 30 }, // Nombre (FR)
                { wch: 30 }, // Nombre (DE)
                { wch: 30 }  // Nombre (IT)
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Roles de Staff');

            // Descargar archivo
            const fileName = `roles_staff_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);

            console.log('‚úÖ Excel exportado:', fileName);
        }

        // ============================================================================
        // ORGANIGRAMA DE STAFF (STAFF ORGCHART)
        // ============================================================================

        // Funci√≥n para cambiar entre sub-tabs de Staff
        function switchStaffSubTab(tabName) {
            // Ocultar todos los subtabs
            document.querySelectorAll('.vendor-subtab-content').forEach(tab => {
                if (tab.parentElement.closest('#staff')) {
                    tab.style.display = 'none';
                    tab.classList.remove('active');
                }
            });

            // Remover clase active de todos los botones
            const staffTabsContainer = document.querySelector('#staff .nav-tabs-secondary');
            if (staffTabsContainer) {
                staffTabsContainer.querySelectorAll('.nav-tab-secondary').forEach(btn => {
                    btn.classList.remove('active');
                });
            }

            // Mostrar subtab seleccionado
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.style.display = 'block';
                selectedTab.classList.add('active');
            }

            // Activar bot√≥n
            event?.target?.classList.add('active');

            // Si es el organigrama, renderizarlo
            if (tabName === 'staff-orgchart') {
                renderOrgChart();
            }
        }

        // Renderizar organigrama completo (din√°mico basado en niveles REALES de BD)
        async function renderOrgChart() {
            const container = document.getElementById('orgchartContainer');
            const countryFilter = document.getElementById('orgchartCountryFilter').value;

            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">‚è≥ Cargando organigrama...</div>';

            try {
                // Cargar ROLES y STAFF en paralelo
                const [rolesResponse, staffResponse] = await Promise.all([
                    fetch('/api/aponnt/staff-data/roles'),
                    fetch('/api/aponnt/staff-data')
                ]);

                if (!rolesResponse.ok || !staffResponse.ok) {
                    throw new Error('Error cargando datos');
                }

                const rolesData = await rolesResponse.json();
                const staffData = await staffResponse.json();

                const allRoles = rolesData.data || [];
                const allStaff = staffData.data || [];

                // Crear mapa de staff por role_code
                const staffByRole = {};
                allStaff.forEach(staff => {
                    const roleCode = staff.role?.role_code;
                    if (roleCode) {
                        if (!staffByRole[roleCode]) {
                            staffByRole[roleCode] = [];
                        }
                        staffByRole[roleCode].push(staff);
                    }
                });

                // Agrupar roles por NIVEL REAL (0, 1, 2, 3, 4)
                const rolesByLevel = {};
                allRoles.forEach(role => {
                    const level = role.level;
                    if (!rolesByLevel[level]) {
                        rolesByLevel[level] = [];
                    }
                    rolesByLevel[level].push(role);
                });

                // Determinar pa√≠ses √∫nicos para roles country-specific
                const countries = { 'AR': 'üá¶üá∑', 'BR': 'üáßüá∑', 'CL': 'üá®üá±', 'MX': 'üá≤üáΩ', 'US': 'üá∫üá∏', 'ES': 'üá™üá∏' };

                // Construir HTML del organigrama
                let html = '<div class="orgchart-wrapper">';

                // Renderizar cada nivel (0, 1, 2, 3, 4)
                const levels = Object.keys(rolesByLevel).map(Number).sort((a, b) => a - b);

                const levelNames = {
                    0: 'NIVEL 0: DIRECCI√ìN',
                    1: 'NIVEL 1: GERENTES',
                    2: 'NIVEL 2: JEFES',
                    3: 'NIVEL 3: SUPERVISORES/COORDINADORES',
                    4: 'NIVEL 4: OPERATIVOS'
                };

                levels.forEach(level => {
                    const roles = rolesByLevel[level];

                    html += `<div class="orgchart-level" style="margin-bottom: ${level === 4 ? '15' : '35'}px;">`;

                    // T√≠tulo del nivel
                    html += `<div style="text-align: center; margin-bottom: 8px;">`;
                    html += `<span style="font-size: 0.35rem; font-weight: bold; color: #6b7280; letter-spacing: 0.5px;">${levelNames[level]}</span>`;
                    html += `</div>`;

                    html += `<div class="orgchart-row" style="justify-content: center; flex-wrap: wrap; gap: 6px;">`;

                    roles.forEach(role => {
                        // FILTRAR ROLES ESPEC√çFICOS QUE NO SE DEBEN MOSTRAR
                        const rolesExcluidos = [
                            'Jefe de Facturaci√≥n y Cobranzas',
                            'Facturador',
                            'Cobrador',
                            'Jefe de Contabilidad e Impuestos',
                            'Liquidador de Impuestos',
                            'Contador',
                            'Jefe Legal',
                            'Abogado'
                        ];

                        if (rolesExcluidos.includes(role.role_name)) {
                            return;
                        }

                        const roleCountry = role.is_country_specific ? null : null; // Se infiere del role_code si termina en -AR, -BR, etc.
                        let country = null;
                        if (role.role_code.includes('-')) {
                            const parts = role.role_code.split('-');
                            const potentialCountry = parts[parts.length - 1];
                            if (countries[potentialCountry]) {
                                country = potentialCountry;
                            }
                        }

                        // Filtrar por pa√≠s si aplica
                        if (countryFilter && country && country !== countryFilter) {
                            return;
                        }

                        const staffList = staffByRole[role.role_code] || [];

                        // Para nivel 4 (operativos), mostrar m√∫ltiples instancias si hay varios staff
                        if (level === 4 && staffList.length > 0) {
                            staffList.forEach(staff => {
                                html += renderOrgChartNode({
                                    code: role.role_code,
                                    name: role.role_name,
                                    country: country,
                                    role_area: role.role_area  // AGREGADO: pasar √°rea del rol
                                }, staff, level);
                            });
                        } else {
                            // Para niveles 0-3, mostrar solo uno (o vacante si no hay)
                            const staff = staffList[0] || null;
                            html += renderOrgChartNode({
                                code: role.role_code,
                                name: role.role_name,
                                country: country,
                                role_area: role.role_area  // AGREGADO: pasar √°rea del rol
                            }, staff, level);
                        }
                    });

                    html += '</div></div>';
                });

                html += '</div>';

                // Agregar CSS del organigrama
                html += `
                <style>
                    .orgchart-wrapper {
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    }
                    .orgchart-level {
                        position: relative;
                    }
                    .orgchart-row {
                        display: flex;
                        gap: 5px;
                    }
                    .orgchart-node {
                        width: 70px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        padding: 5px;
                        background: white;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                        transition: all 0.3s ease;
                        text-align: center;
                        position: relative;
                    }
                    .orgchart-node:hover {
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        transform: translateY(-2px);
                    }
                    .orgchart-node.level-0 {
                        border-color: #8b5cf6;
                        background: linear-gradient(135deg, #f3e8ff 0%, #ede9fe 100%);
                    }
                    .orgchart-node.level-1 {
                        border-color: #3b82f6;
                        background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
                    }
                    .orgchart-node.level-2 {
                        border-color: #10b981;
                        background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
                    }
                    .orgchart-node.level-3 {
                        border-color: #f59e0b;
                        background: linear-gradient(135deg, #fed7aa 0%, #fef3c7 100%);
                    }
                    .orgchart-node.level-4 {
                        border-color: #6b7280;
                        background: linear-gradient(135deg, #e5e7eb 0%, #f9fafb 100%);
                    }
                    .orgchart-node.vacant {
                        opacity: 0.6;
                        border-style: dashed;
                    }
                    /* ASESORES EXTERNOS - Estilo especial */
                    .orgchart-node.external-advisor {
                        border: 1px dashed #f59e0b !important;
                        background: linear-gradient(135deg, #fff7ed 0%, #fffbeb 100%) !important;
                        box-shadow: 0 1px 4px rgba(245, 158, 11, 0.15) !important;
                    }
                    .orgchart-node.external-advisor:hover {
                        box-shadow: 0 2px 7px rgba(245, 158, 11, 0.25) !important;
                    }
                    .orgchart-role-title {
                        font-size: 0.3rem;
                        font-weight: bold;
                        color: #374151;
                        margin-bottom: 3px;
                        text-transform: uppercase;
                        letter-spacing: 0.2px;
                        line-height: 1.1;
                    }
                    .orgchart-staff-name {
                        font-size: 0.4rem;
                        font-weight: 600;
                        color: #111827;
                        margin-bottom: 2px;
                        line-height: 1.1;
                    }
                    .orgchart-staff-email {
                        font-size: 0.3rem;
                        color: #6b7280;
                        word-break: break-all;
                        line-height: 1.1;
                    }
                    .orgchart-vacant-label {
                        font-size: 0.35rem;
                        color: #9ca3af;
                        font-style: italic;
                    }
                    .orgchart-country-flag {
                        font-size: 0.5rem;
                        margin-bottom: 2px;
                    }
                </style>
                `;

                container.innerHTML = html;

            } catch (error) {
                console.error('‚ùå Error renderizando organigrama:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc2626;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                        <p>Error cargando organigrama</p>
                        <p style="font-size: 0.9rem; color: #666;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Renderizar un nodo individual del organigrama
        function renderOrgChartNode(role, staff, level) {
            const countryFlags = {
                'AR': 'üá¶üá∑',
                'BR': 'üáßüá∑',
                'CL': 'üá®üá±',
                'MX': 'üá≤üáΩ',
                'US': 'üá∫üá∏',
                'ES': 'üá™üá∏'
            };

            const isVacant = !staff;
            const vacantClass = isVacant ? 'vacant' : '';

            // Detectar si es asesor externo (por rol o por contrato)
            const isExternal = role.role_area === 'externo' ||
                              (staff && (staff.contract_type === 'externo' || staff.contract_type === 'freelance'));
            const externalClass = isExternal ? 'external-advisor' : '';

            let html = `<div class="orgchart-node level-${level} ${vacantClass} ${externalClass}">`;

            // Indicador de EXTERNO
            if (isExternal) {
                html += `<div style="position: absolute; top: 2px; right: 2px; font-size: 0.45rem;">üîó</div>`;
                html += `<div style="font-size: 0.25rem; font-weight: bold; color: #f59e0b; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px;">EXTERNO</div>`;
            }

            // Pa√≠s (si aplica)
            if (role.country) {
                html += `<div class="orgchart-country-flag">${countryFlags[role.country] || ''}</div>`;
            }

            // T√≠tulo del rol
            html += `<div class="orgchart-role-title">${role.name}</div>`;

            // Informaci√≥n del staff
            if (staff) {
                html += `
                    <div class="orgchart-staff-name">${staff.first_name} ${staff.last_name}</div>
                    <div class="orgchart-staff-email">${staff.email}</div>
                `;
            } else {
                html += `<div class="orgchart-vacant-label">Vacante</div>`;
            }

            html += '</div>';
            return html;
        }


        // üåç VALIDACI√ìN DE COORDENADAS PARA APK ANDROID
        function validateGeolocationData() {
            const latitude = document.getElementById('companyLatitude').value?.trim();
            const longitude = document.getElementById('companyLongitude').value?.trim();
            const address = document.getElementById('address').value?.trim();

            const geoStatus = document.getElementById('geoLocationStatus') || (() => {
                const statusDiv = document.createElement('div');
                statusDiv.id = 'geoLocationStatus';
                statusDiv.style.cssText = 'margin-top: 10px; padding: 8px; border-radius: 4px; font-size: 12px; font-weight: bold;';

                const latField = document.getElementById('companyLatitude');
                if (latField && latField.parentNode) {
                    latField.parentNode.appendChild(statusDiv);
                }
                return statusDiv;
            })();

            if (!address) {
                geoStatus.innerHTML = '‚ö†Ô∏è Complete la direcci√≥n para geolocalizar';
                geoStatus.style.backgroundColor = '#fff3cd';
                geoStatus.style.color = '#856404';
            } else if (!latitude || !longitude) {
                geoStatus.innerHTML = '‚ùå GEOLOCALIZACI√ìN REQUERIDA para APK Android - <button type="button" onclick="geocodeCompanyAddress()" style="background: #007bff; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer;">Obtener Coordenadas</button>';
                geoStatus.style.backgroundColor = '#f8d7da';
                geoStatus.style.color = '#721c24';
            } else {
                geoStatus.innerHTML = `‚úÖ GPS Configurado: ${parseFloat(latitude).toFixed(6)}, ${parseFloat(longitude).toFixed(6)}`;
                geoStatus.style.backgroundColor = '#d4edda';
                geoStatus.style.color = '#155724';
            }
        }

        // Ejecutar validaci√≥n cuando cambien los campos
        document.addEventListener('DOMContentLoaded', function() {
            const fieldsToWatch = ['address', 'city', 'province', 'companyLatitude', 'companyLongitude'];
            fieldsToWatch.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', validateGeolocationData);
                    field.addEventListener('change', validateGeolocationData);
                }
            });
        });

        // ========================================
        // SISTEMA DE PLANTILLAS FISCALES
        // ========================================

        let taxTemplates = [];
        let currentTaxTemplate = null;

        /**
         * Formatear porcentaje a 2 decimales
         */
        function formatPercentage(percentage) {
            return parseFloat(percentage || 0).toFixed(2);
        }

        /**
         * Cargar sistema de plantillas fiscales
         */
        async function loadTaxTemplatesSystem() {
            console.log('üîÑ Cargando sistema de plantillas fiscales...');
            await loadTaxTemplates();
        }

        /**
         * Cargar todas las plantillas fiscales
         */
        async function loadTaxTemplates() {
            try {
                const response = await fetch(`${API_BASE}/api/siac/tax-templates`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                taxTemplates = result.templates || [];

                renderTaxTemplates();

            } catch (error) {
                console.error('‚ùå Error cargando plantillas fiscales:', error);
                showNotification('Error cargando plantillas fiscales', 'error');

                document.getElementById('taxTemplatesContainer').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <h4>‚ùå Error cargando plantillas</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadTaxTemplates()">
                            üîÑ Reintentar
                        </button>
                    </div>
                `;
            }
        }

        /**
         * Renderizar lista de plantillas fiscales
         */
        function renderTaxTemplates() {
            const container = document.getElementById('taxTemplatesContainer');

            if (taxTemplates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <h4>üèõÔ∏è No hay plantillas fiscales configuradas</h4>
                        <p>Cree plantillas para configurar la matriz impositiva por pa√≠s</p>
                        <button class="btn btn-success" onclick="openNewTaxTemplateModal()" style="margin-top: 1rem;">
                            ‚ûï Crear Primera Plantilla
                        </button>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="tax-templates-grid">
            `;

            taxTemplates.forEach(template => {
                html += `
                    <div class="tax-template-card">
                        <div class="tax-template-header">
                            <div class="tax-template-title">
                                <h3>üèõÔ∏è ${template.templateName}</h3>
                                <span class="country-code">${template.countryCode}</span>
                            </div>
                            <div class="tax-template-actions">
                                <button class="btn btn-sm btn-info" onclick="viewTaxTemplate(${template.id})">
                                    üëÅÔ∏è Ver
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="editTaxTemplate(${template.id})">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTaxTemplate(${template.id})">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>
                        <div class="tax-template-body">
                            <div class="tax-template-info">
                                <div class="info-item">
                                    <span class="info-label">Pa√≠s:</span>
                                    <span class="info-value">${template.country}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Campo ID:</span>
                                    <span class="info-value">${template.taxIdFieldName}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Formato:</span>
                                    <span class="info-value">${template.taxIdFormat || 'No configurado'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Moneda:</span>
                                    <span class="info-value">${template.defaultCurrency}</span>
                                </div>
                            </div>
                            <div class="tax-template-stats">
                                <div class="stat-item">
                                    <span class="stat-value">${template.conditionsCount}</span>
                                    <span class="stat-label">Condiciones</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">${template.conceptsCount}</span>
                                    <span class="stat-label">Conceptos</span>
                                </div>
                            </div>
                        </div>
                        <div class="tax-template-footer">
                            <button class="btn btn-sm btn-success" onclick="addTaxConcept(${template.id})">
                                ‚ûï Agregar Concepto
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="addTaxCondition(${template.id})">
                                ‚ûï Agregar Condici√≥n
                            </button>
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
            `;

            container.innerHTML = html;
        }

        /**
         * Abrir modal para crear nueva plantilla fiscal
         */
        function openNewTaxTemplateModal() {
            const modalHtml = `
                <div id="taxTemplateModal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>üèõÔ∏è Nueva Plantilla Fiscal</h3>
                            <button class="close-btn" onclick="closeTaxTemplateModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="taxTemplateForm">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Pa√≠s *</label>
                                        <input type="text" class="form-input" id="templateCountry" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">C√≥digo Pa√≠s *</label>
                                        <input type="text" class="form-input" id="templateCountryCode" required maxlength="3" placeholder="ARG">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Nombre Plantilla *</label>
                                        <input type="text" class="form-input" id="templateName" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Campo ID Tributario</label>
                                        <input type="text" class="form-input" id="taxIdFieldName" value="CUIT">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Formato ID</label>
                                        <input type="text" class="form-input" id="taxIdFormat" placeholder="XX-XXXXXXXX-X">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Moneda Base</label>
                                        <select class="form-input" id="defaultCurrency">
                                            <option value="ARS">Peso Argentino (ARS)</option>
                                            <option value="USD">D√≥lar Estadounidense (USD)</option>
                                            <option value="EUR">Euro (EUR)</option>
                                            <option value="BRL">Real Brasile√±o (BRL)</option>
                                            <option value="UYU">Peso Uruguayo (UYU)</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeTaxTemplateModal()">Cancelar</button>
                            <button class="btn btn-success" onclick="saveTaxTemplate()">üíæ Crear Plantilla</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * Cerrar modal de plantilla fiscal
         */
        function closeTaxTemplateModal() {
            const modal = document.getElementById('taxTemplateModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Guardar nueva plantilla fiscal
         */
        async function saveTaxTemplate() {
            try {
                const templateData = {
                    country: document.getElementById('templateCountry').value.trim(),
                    countryCode: document.getElementById('templateCountryCode').value.trim().toUpperCase(),
                    templateName: document.getElementById('templateName').value.trim(),
                    taxIdFieldName: document.getElementById('taxIdFieldName').value.trim() || 'CUIT',
                    taxIdFormat: document.getElementById('taxIdFormat').value.trim(),
                    defaultCurrency: document.getElementById('defaultCurrency').value,
                    currencies: [document.getElementById('defaultCurrency').value]
                };

                if (!templateData.country || !templateData.countryCode || !templateData.templateName) {
                    showNotification('Complete todos los campos obligatorios', 'warning');
                    return;
                }

                const response = await fetch(`${API_BASE}/api/siac/tax-templates`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    },
                    body: JSON.stringify(templateData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Error ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ Plantilla fiscal creada:', result);

                showNotification('Plantilla fiscal creada exitosamente', 'success');
                closeTaxTemplateModal();
                await loadTaxTemplates();

            } catch (error) {
                console.error('‚ùå Error creando plantilla fiscal:', error);
                showNotification(`Error creando plantilla: ${error.message}`, 'error');
            }
        }

        /**
         * Ver detalles de plantilla fiscal
         */
        async function viewTaxTemplate(templateId) {
            try {
                const response = await fetch(`${API_BASE}/api/siac/tax-templates/${templateId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                currentTaxTemplate = result.template;

                openTaxTemplateDetailModal(currentTaxTemplate);

            } catch (error) {
                console.error('‚ùå Error obteniendo plantilla fiscal:', error);
                showNotification(`Error cargando plantilla: ${error.message}`, 'error');
            }
        }

        /**
         * Abrir modal de detalle de plantilla fiscal
         */
        function openTaxTemplateDetailModal(template) {
            const modalHtml = `
                <div id="taxTemplateDetailModal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3>üèõÔ∏è ${template.templateName}</h3>
                            <button class="close-btn" onclick="closeTaxTemplateDetailModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="tax-template-detail">
                                <div class="detail-section">
                                    <h4>üìã Informaci√≥n General</h4>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <span class="detail-label">Pa√≠s:</span>
                                            <span class="detail-value">${template.country}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">C√≥digo:</span>
                                            <span class="detail-value">${template.countryCode}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Campo ID:</span>
                                            <span class="detail-value">${template.taxIdFieldName}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Formato:</span>
                                            <span class="detail-value">${template.taxIdFormat || 'No configurado'}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <h4>‚öñÔ∏è Condiciones Impositivas</h4>
                                    <div class="conditions-list">
                                        ${template.conditions && template.conditions.length > 0 ?
                                            template.conditions.map(condition => `
                                                <div class="condition-item">
                                                    <span class="condition-code">${condition.conditionCode}</span>
                                                    <span class="condition-name">${condition.conditionName}</span>
                                                </div>
                                            `).join('') :
                                            '<p class="no-data">No hay condiciones configuradas</p>'
                                        }
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <h4>üí∞ Conceptos Impositivos</h4>
                                    <div class="concepts-list">
                                        ${template.concepts && template.concepts.length > 0 ?
                                            template.concepts.map(concept => `
                                                <div class="concept-item">
                                                    <div class="concept-header">
                                                        <span class="concept-name">${concept.conceptName}</span>
                                                        <span class="concept-order">Orden: ${concept.calculationOrder}</span>
                                                    </div>
                                                    <div class="concept-details">
                                                        <span>Base: ${concept.baseAmount}</span>
                                                        <span>Tipo: ${concept.conceptType}</span>
                                                    </div>
                                                    ${concept.rates && concept.rates.length > 0 ?
                                                        `<div class="rates-list">
                                                            ${concept.rates.map(rate => `
                                                                <div class="rate-item">
                                                                    <span>${rate.rateName}</span>
                                                                    <span class="rate-percentage">${formatPercentage(rate.ratePercentage)}%</span>
                                                                </div>
                                                            `).join('')}
                                                        </div>` :
                                                        '<p class="no-rates">Sin al√≠cuotas configuradas</p>'
                                                    }
                                                </div>
                                            `).join('') :
                                            '<p class="no-data">No hay conceptos configurados</p>'
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeTaxTemplateDetailModal()">Cerrar</button>
                            <button class="btn btn-warning" onclick="editTaxTemplate(${template.id})">‚úèÔ∏è Editar</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * Cerrar modal de detalle
         */
        function closeTaxTemplateDetailModal() {
            const modal = document.getElementById('taxTemplateDetailModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Editar plantilla fiscal
         */
        async function editTaxTemplate(templateId) {
            try {
                // Obtener datos actuales de la plantilla
                const response = await fetch(`${API_BASE}/api/siac/tax-templates/${templateId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                const template = result.template;

                openEditTaxTemplateModal(template);

            } catch (error) {
                console.error('‚ùå Error obteniendo plantilla para editar:', error);
                showNotification(`Error cargando plantilla: ${error.message}`, 'error');
            }
        }

        /**
         * Abrir modal para editar plantilla fiscal
         */
        function openEditTaxTemplateModal(template) {
            const modalHtml = `
                <div id="editTaxTemplateModal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>‚úèÔ∏è Editar Plantilla Fiscal</h3>
                            <button class="close-btn" onclick="closeEditTaxTemplateModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="editTaxTemplateForm">
                                <input type="hidden" id="editTemplateId" value="${template.id}">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Pa√≠s *</label>
                                        <input type="text" class="form-input" id="editTemplateCountry" value="${template.country}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">C√≥digo Pa√≠s *</label>
                                        <input type="text" class="form-input" id="editTemplateCountryCode" value="${template.countryCode}" required maxlength="3">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Nombre Plantilla *</label>
                                        <input type="text" class="form-input" id="editTemplateName" value="${template.templateName}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Campo ID Tributario</label>
                                        <input type="text" class="form-input" id="editTaxIdFieldName" value="${template.taxIdFieldName}">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Formato ID</label>
                                        <input type="text" class="form-input" id="editTaxIdFormat" value="${template.taxIdFormat || ''}" placeholder="XX-XXXXXXXX-X">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Moneda Base</label>
                                        <select class="form-input" id="editDefaultCurrency">
                                            <option value="ARS" ${template.defaultCurrency === 'ARS' ? 'selected' : ''}>Peso Argentino (ARS)</option>
                                            <option value="USD" ${template.defaultCurrency === 'USD' ? 'selected' : ''}>D√≥lar Estadounidense (USD)</option>
                                            <option value="EUR" ${template.defaultCurrency === 'EUR' ? 'selected' : ''}>Euro (EUR)</option>
                                            <option value="BRL" ${template.defaultCurrency === 'BRL' ? 'selected' : ''}>Real Brasile√±o (BRL)</option>
                                            <option value="UYU" ${template.defaultCurrency === 'UYU' ? 'selected' : ''}>Peso Uruguayo (UYU)</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeEditTaxTemplateModal()">Cancelar</button>
                            <button class="btn btn-success" onclick="updateTaxTemplate()">üíæ Guardar Cambios</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * Cerrar modal de editar plantilla
         */
        function closeEditTaxTemplateModal() {
            const modal = document.getElementById('editTaxTemplateModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Actualizar plantilla fiscal
         */
        async function updateTaxTemplate() {
            try {
                const templateId = document.getElementById('editTemplateId').value;
                const templateData = {
                    country: document.getElementById('editTemplateCountry').value.trim(),
                    countryCode: document.getElementById('editTemplateCountryCode').value.trim().toUpperCase(),
                    templateName: document.getElementById('editTemplateName').value.trim(),
                    taxIdFieldName: document.getElementById('editTaxIdFieldName').value.trim() || 'CUIT',
                    taxIdFormat: document.getElementById('editTaxIdFormat').value.trim(),
                    defaultCurrency: document.getElementById('editDefaultCurrency').value,
                    currencies: [document.getElementById('editDefaultCurrency').value]
                };

                if (!templateData.country || !templateData.countryCode || !templateData.templateName) {
                    showNotification('Complete todos los campos obligatorios', 'warning');
                    return;
                }

                const response = await fetch(`${API_BASE}/api/siac/tax-templates/${templateId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    },
                    body: JSON.stringify(templateData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Error ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ Plantilla fiscal actualizada:', result);

                showNotification('Plantilla fiscal actualizada exitosamente', 'success');
                closeEditTaxTemplateModal();
                await loadTaxTemplates();

            } catch (error) {
                console.error('‚ùå Error actualizando plantilla fiscal:', error);
                showNotification(`Error actualizando plantilla: ${error.message}`, 'error');
            }
        }

        /**
         * Eliminar plantilla fiscal
         */
        async function deleteTaxTemplate(templateId) {
            const template = taxTemplates.find(t => t.id === templateId);
            if (!template) return;

            if (!confirm(`¬øEst√° seguro de eliminar la plantilla fiscal de ${template.country}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/siac/tax-templates/${templateId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                showNotification('Plantilla fiscal eliminada exitosamente', 'success');
                await loadTaxTemplates();

            } catch (error) {
                console.error('‚ùå Error eliminando plantilla fiscal:', error);
                showNotification(`Error eliminando plantilla: ${error.message}`, 'error');
            }
        }

        /**
         * Agregar concepto impositivo
         */
        function addTaxConcept(templateId) {
            openAddTaxConceptModal(templateId);
        }

        /**
         * Abrir modal para agregar concepto impositivo
         */
        function openAddTaxConceptModal(templateId) {
            const modalHtml = `
                <div id="addTaxConceptModal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>üí∞ Nuevo Concepto Impositivo</h3>
                            <button class="close-btn" onclick="closeAddTaxConceptModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="addTaxConceptForm">
                                <input type="hidden" id="conceptTemplateId" value="${templateId}">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">C√≥digo Concepto *</label>
                                        <input type="text" class="form-input" id="conceptCode" required placeholder="IVA">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Nombre Concepto *</label>
                                        <input type="text" class="form-input" id="conceptName" required placeholder="Impuesto al Valor Agregado">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Descripci√≥n</label>
                                        <textarea class="form-input" id="conceptDescription" rows="2" placeholder="Descripci√≥n del concepto impositivo"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Orden de C√°lculo *</label>
                                        <input type="number" class="form-input" id="calculationOrder" value="1" min="1" required>
                                        <small style="color: #666;">Orden en que se calcula (1 = primero)</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Base Imponible *</label>
                                        <select class="form-input" id="baseAmount" required>
                                            <option value="neto_sin_descuentos">Neto sin descuentos</option>
                                            <option value="neto_final">Neto final (con descuentos)</option>
                                            <option value="subtotal">Subtotal</option>
                                            <option value="total">Total</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Tipo de Concepto *</label>
                                        <select class="form-input" id="conceptType" required>
                                            <option value="tax">Impuesto</option>
                                            <option value="retention">Retenci√≥n</option>
                                            <option value="perception">Percepci√≥n</option>
                                            <option value="discount">Descuento</option>
                                            <option value="surcharge">Recargo</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Al√≠cuota/Porcentaje (%)</label>
                                        <input type="number" class="form-input" id="defaultRate" step="0.01" min="0" max="100" placeholder="21.00">
                                        <small style="color: #666;">Porcentaje por defecto (ej: 21% para IVA)</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Monto Fijo (Opcional)</label>
                                        <input type="number" class="form-input" id="fixedAmount" step="0.01" min="0" placeholder="0.00">
                                        <small style="color: #666;">Si tiene monto fijo en lugar de %</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Nombre de Al√≠cuota</label>
                                        <input type="text" class="form-input" id="rateName" placeholder="General">
                                        <small style="color: #666;">Nombre descriptivo (General, Reducida, etc.)</small>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeAddTaxConceptModal()">Cancelar</button>
                            <button class="btn btn-success" onclick="saveTaxConcept()">üíæ Crear Concepto</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * Cerrar modal de agregar concepto
         */
        function closeAddTaxConceptModal() {
            const modal = document.getElementById('addTaxConceptModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Guardar concepto impositivo
         */
        async function saveTaxConcept() {
            try {
                const templateId = document.getElementById('conceptTemplateId').value;
                const conceptData = {
                    conceptCode: document.getElementById('conceptCode').value.trim(),
                    conceptName: document.getElementById('conceptName').value.trim(),
                    description: document.getElementById('conceptDescription').value.trim(),
                    calculationOrder: parseInt(document.getElementById('calculationOrder').value),
                    baseAmount: document.getElementById('baseAmount').value,
                    conceptType: document.getElementById('conceptType').value
                };

                if (!conceptData.conceptCode || !conceptData.conceptName || !conceptData.calculationOrder) {
                    showNotification('Complete todos los campos obligatorios', 'warning');
                    return;
                }

                // Crear el concepto primero
                const response = await fetch(`${API_BASE}/api/siac/tax-templates/${templateId}/concepts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    },
                    body: JSON.stringify(conceptData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Error ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ Concepto impositivo creado:', result);

                // Si se especific√≥ una al√≠cuota/porcentaje, crear la rate autom√°ticamente
                const defaultRate = parseFloat(document.getElementById('defaultRate').value);
                const fixedAmount = parseFloat(document.getElementById('fixedAmount').value);
                const rateName = document.getElementById('rateName').value.trim();

                if (defaultRate > 0 || fixedAmount > 0) {
                    const rateData = {
                        rateCode: conceptData.conceptCode + '_DEFAULT',
                        rateName: rateName || 'General',
                        ratePercentage: defaultRate || 0,
                        minimumAmount: fixedAmount || 0,
                        maximumAmount: null,
                        isDefault: true
                    };

                    console.log('Creando al√≠cuota autom√°ticamente:', rateData);

                    const rateResponse = await fetch(`${API_BASE}/api/siac/tax-templates/concepts/${result.concept.id}/rates`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                        },
                        body: JSON.stringify(rateData)
                    });

                    if (rateResponse.ok) {
                        console.log('‚úÖ Al√≠cuota creada autom√°ticamente');
                        showNotification('Concepto y al√≠cuota creados exitosamente', 'success');
                    } else {
                        console.warn('‚ö†Ô∏è Concepto creado pero fall√≥ la al√≠cuota');
                        showNotification('Concepto creado (al√≠cuota pendiente)', 'warning');
                    }
                } else {
                    showNotification('Concepto impositivo creado exitosamente', 'success');
                }

                closeAddTaxConceptModal();
                await loadTaxTemplates();

            } catch (error) {
                console.error('‚ùå Error creando concepto impositivo:', error);

                // Manejo espec√≠fico para duplicados
                if (error.message && error.message.includes('llave duplicada')) {
                    showNotification(`‚ùå Ya existe un concepto con el c√≥digo "${document.getElementById('conceptCode').value.trim()}". Use un c√≥digo diferente.`, 'error');
                } else if (error.message && error.message.includes('Error 400')) {
                    showNotification('‚ùå Ya existe un concepto con ese c√≥digo. Use un c√≥digo diferente.', 'error');
                } else {
                    showNotification(`Error creando concepto: ${error.message}`, 'error');
                }
            }
        }

        /**
         * Agregar condici√≥n impositiva
         */
        function addTaxCondition(templateId) {
            openAddTaxConditionModal(templateId);
        }

        /**
         * Abrir modal para agregar condici√≥n impositiva
         */
        function openAddTaxConditionModal(templateId) {
            const modalHtml = `
                <div id="addTaxConditionModal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3>‚öñÔ∏è Nueva Condici√≥n Impositiva</h3>
                            <button class="close-btn" onclick="closeAddTaxConditionModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="addTaxConditionForm">
                                <input type="hidden" id="conditionTemplateId" value="${templateId}">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">C√≥digo Condici√≥n *</label>
                                        <input type="text" class="form-input" id="conditionCode" required placeholder="RI">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Nombre Condici√≥n *</label>
                                        <input type="text" class="form-input" id="conditionName" required placeholder="Responsable Inscripto">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Descripci√≥n</label>
                                        <textarea class="form-input" id="conditionDescription" rows="3" placeholder="Descripci√≥n detallada de la condici√≥n impositiva"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Orden de Visualizaci√≥n</label>
                                        <input type="number" class="form-input" id="displayOrder" value="1" min="1">
                                        <small style="color: #666;">Orden en la lista (1 = primero)</small>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeAddTaxConditionModal()">Cancelar</button>
                            <button class="btn btn-success" onclick="saveTaxCondition()">üíæ Crear Condici√≥n</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * Cerrar modal de agregar condici√≥n
         */
        function closeAddTaxConditionModal() {
            const modal = document.getElementById('addTaxConditionModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Guardar condici√≥n impositiva
         */
        async function saveTaxCondition() {
            try {
                const templateId = document.getElementById('conditionTemplateId').value;
                const conditionData = {
                    conditionCode: document.getElementById('conditionCode').value.trim(),
                    conditionName: document.getElementById('conditionName').value.trim(),
                    description: document.getElementById('conditionDescription').value.trim(),
                    displayOrder: parseInt(document.getElementById('displayOrder').value) || 1
                };

                if (!conditionData.conditionCode || !conditionData.conditionName) {
                    showNotification('Complete todos los campos obligatorios', 'warning');
                    return;
                }

                const response = await fetch(`${API_BASE}/api/siac/tax-templates/${templateId}/conditions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    },
                    body: JSON.stringify(conditionData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Error ${response.status}`);
                }

                const result = await response.json();
                console.log('‚úÖ Condici√≥n impositiva creada:', result);

                showNotification('Condici√≥n impositiva creada exitosamente', 'success');
                closeAddTaxConditionModal();
                await loadTaxTemplates();

            } catch (error) {
                console.error('‚ùå Error creando condici√≥n impositiva:', error);
                showNotification(`Error creando condici√≥n: ${error.message}`, 'error');
            }
        }

        /**
         * Exportar todas las plantillas fiscales
         */
        async function exportAllTaxTemplates() {
            try {
                const dataStr = JSON.stringify(taxTemplates, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `plantillas_fiscales_${new Date().toISOString().split('T')[0]}.json`;
                link.click();

                URL.revokeObjectURL(url);
                showNotification('Plantillas fiscales exportadas exitosamente', 'success');

            } catch (error) {
                console.error('‚ùå Error exportando plantillas:', error);
                showNotification(`Error exportando: ${error.message}`, 'error');
            }
        }

        // ==========================================
        // HERRAMIENTAS DE SOPORTE (PHASE 4 INTEGRATED TESTING)
        // ==========================================

        let currentOperation = null;

        </script>

    <!-- Partners Admin Panel Module -->
    <script src="js/modules/partners-admin-panel.js"></script>

    <!-- Phase 4 Integrated Manager Module (√öNICO SISTEMA DE TESTING) -->
    <script src="js/modules/phase4-integrated-manager.js"></script>
    <script src="js/modules/testing-metrics-dashboard.js"></script>

    <!-- Configurador de M√≥dulos Module -->
    <script src="js/modules/configurador-modulos.js"></script>

    <!-- üèÜ TECH STACK BADGES - Marketing Subliminal Profesional -->

    <!-- ‚úÖ Consent Management Module (Phase 7) -->
    <script src="js/modules/admin-consent-management.js"></script>

    <!-- ‚úÖ Support Tickets View Module (Phase 7) -->
    <script src="js/modules/admin-support-tickets-view.js"></script>

    <!-- üìä Frappe Gantt Library -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>

    <!-- üèóÔ∏è Engineering Dashboard Module -->
    <script src="js/modules/engineering-dashboard.js"></script>
    <!-- üóÑÔ∏è Database Sync Module -->
    <script src="js/modules/database-sync.js"></script>
    <!-- üöÄ Deployment Sync Module -->
    <script src="js/modules/deployment-sync.js"></script>

    <script>
        // Inicializar m√≥dulos cuando se cargan sus tabs respectivas
        (function() {
            const originalSwitchTabForTesting = window.switchTab;
            window.switchTab = function(tabName) {
                // Llamar a la funci√≥n original primero
                if (originalSwitchTabForTesting) {
                    originalSwitchTabForTesting(tabName);
                }

                // Si se cambi√≥ a supportTools, inicializar ambos sistemas
                if (tabName === 'supportTools') {
                    // Inicializar Visible Testing Manager
                    setTimeout(() => {
                        if (window.VisibleTestingManager && typeof window.VisibleTestingManager.init === 'function') {
                            window.VisibleTestingManager.init();
                        }
                    }, 200);

                    // Inicializar Configurador de M√≥dulos
                    setTimeout(() => {
                        if (window.ModulesConfigurator && typeof window.ModulesConfigurator.init === 'function') {
                            window.ModulesConfigurator.init();
                        }
                    }, 300);
                }

                // ‚úÖ PHASE 7: Inicializar Consent Management
                if (tabName === 'consents' && !window.consentMgmtInitialized) {
                    setTimeout(() => {
                        if (window.consentMgmt && typeof window.consentMgmt.init === 'function') {
                            console.log('üìú Inicializando Consent Management Module...');
                            window.consentMgmt.init();
                            window.consentMgmtInitialized = true;
                        } else {
                            console.warn('‚ö†Ô∏è consentMgmt no est√° disponible');
                        }
                    }, 200);
                }

                // ‚úÖ PHASE 7: Inicializar Support Tickets View
                if (tabName === 'supportTickets' && !window.adminTicketsInitialized) {
                    setTimeout(() => {
                        if (window.adminTickets && typeof window.adminTickets.init === 'function') {
                            console.log('üé´ Inicializando Admin Support Tickets Module...');
                            window.adminTickets.init();
                            window.adminTicketsInitialized = true;
                        } else {
                            console.warn('‚ö†Ô∏è adminTickets no est√° disponible');
                        }
                    }, 200);
                }

                // ‚úÖ Inicializar Engineering Dashboard en Tab
                if (tabName === 'engineering' && !window.engineeringTabInitialized) {
                    setTimeout(() => {
                        if (typeof EngineeringDashboard !== 'undefined') {
                            console.log('üèóÔ∏è [TAB] Inicializando Engineering Dashboard en tab...');
                            const tabContainer = document.getElementById('engineering-tab-container');
                            if (tabContainer) {
                                // Crear container para el dashboard
                                const dashContainer = document.createElement('div');
                                dashContainer.id = 'engineering-dashboard-container';
                                tabContainer.innerHTML = '';
                                tabContainer.appendChild(dashContainer);

                                // Inicializar el dashboard
                                EngineeringDashboard.init();
                                window.engineeringTabInitialized = true;
                            }
                        } else {
                            console.warn('‚ö†Ô∏è EngineeringDashboard no est√° disponible');
                        }
                    }, 200);
                }
            };
        })();
    </script>

    <!-- Translation System V4 -->
    <script src="js/translation-system-v4.js"></script>
    <script>
        // Initialize Translation System for panel-administrativo.html (manual selector only)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåç [ADMIN] Inicializando sistema de traducci√≥n...');

            // Wait for translator to be ready
            setTimeout(() => {
                if (typeof SmartTranslationSystem !== 'undefined' && window.translator) {
                    console.log('‚úÖ [ADMIN] Translator disponible');

                    // Create language selector in container
                    const container = document.getElementById('languageSelectorContainer');
                    if (container && window.translator) {
                        const selector = window.translator.createLanguageSelector();
                        if (selector) {
                            // Style selector for panel-administrativo (adapt to scaled header)
                            selector.style.cssText = `
                                background: rgba(59, 130, 246, 0.1);
                                border: 1px solid rgba(59, 130, 246, 0.3);
                                border-radius: 6px;
                                color: #1e293b;
                                padding: 0.4rem 0.6rem;
                                font-size: 0.9rem;
                                cursor: pointer;
                                min-width: 100px;
                                font-weight: 500;
                            `;
                            container.appendChild(selector);
                            console.log('‚úÖ [ADMIN] Selector de idioma agregado');

                            // Translate initial interface
                            window.translator.updateInterface();
                        }
                    }
                } else {
                    console.warn('‚ö†Ô∏è [ADMIN] Translator no disponible');
                }
            }, 500);
        });
    </script>
    <!-- üé® ENTERPRISE COMPANIES GRID - Bloomberg/SAP Fiori Style -->
    <script src="/js/modules/enterprise-companies-grid.js"></script>

    <!-- üîÑ VIEW TOGGLE & READ-ONLY VIEWER - Grid/Table Toggle + View Button -->
    <script src="/js/modules/view-toggle-and-readonly.js"></script>

    <!-- üìë COMPANY MODAL TABS REDESIGN - Enterprise Tab System -->
    <script src="/js/modules/company-modal-tabs-redesign.js"></script>
</body>
</html><!-- Version: 1763816963 -->
