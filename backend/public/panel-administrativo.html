<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - Sistema Completo de Gestión y Facturación</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Leaflet CSS y JS para mapas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Configuración dinámica de puertos - DEBE CARGAR PRIMERO -->
    <script src="js/port-config.js"></script>

    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --light-bg: #f8f9fa;
            --white: #ffffff;
            --dark-text: #2c3e50;
            --border-color: #e9ecef;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .dashboard-title {
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .dashboard-subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 0.5rem;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 0.5rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 0;
        }

        .nav-tab {
            flex: 1;
            padding: 1rem 1.5rem;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border-right: 1px solid #e9ecef;
        }

        .nav-tab:last-child {
            border-right: none;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .billing-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .billing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f8f9fa;
        }

        .invoice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .invoice-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 1rem;
            border-left: 4px solid var(--primary-color);
        }

        .invoice-card.overdue {
            border-left-color: var(--danger-color);
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
        }

        .invoice-card.paid {
            border-left-color: var(--success-color);
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        }

        .qr-payment {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 15px;
            margin: 1rem 0;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 1rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #666;
        }

        .pricing-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .module-pricing {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tier-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tier-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .tier-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .price-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .notification {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notification.success { background: #d4edda; color: #155724; }
        .notification.warning { background: #fff3cd; color: #856404; }
        .notification.error { background: #f8d7da; color: #721c24; }
        .notification.info { background: #d1ecf1; color: #0c5460; }

        .section-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 600;
        }

        .section-content {
            padding: 2rem;
        }

        /* ==================== ESTILOS MÓDULO DE FACTURACIÓN ==================== */
        
        .billing-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .billing-table th {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .billing-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem;
            vertical-align: middle;
        }
        
        .billing-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .billing-table tr.unpaid {
            background-color: #fff5f5;
        }
        
        .billing-table tr.unpaid:hover {
            background-color: #ffebee;
        }
        
        .billing-table .amount {
            text-align: right;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
        
        .billing-table .commission {
            color: #ff9800;
        }
        
        .billing-table .aponnt {
            color: #2196f3;
        }
        
        .status {
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status.paid {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status.unpaid {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .btn-action {
            background: none;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            margin: 0 0.25rem;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .btn-action:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .total-item {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border-left: 4px solid var(--primary-color);
        }
        
        .total-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .total-value.paid {
            color: var(--success-color);
        }
        
        .total-value.unpaid {
            color: var(--danger-color);
        }
        
        .total-label {
            font-size: 0.85rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .billing-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #666;
        }
        
        .filter-input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .btn-filter {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .btn-filter.primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-filter.primary:hover {
            background: var(--secondary-color);
        }
        
        .btn-filter.secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-filter.secondary:hover {
            background: #545b62;
        }
        
        .billing-generation {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .generation-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .generation-description {
            color: #666;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        /* ==================== ESTILOS MÓDULO DE VENDEDORES ==================== */
        
        .vendor-controls {
            margin-bottom: 2rem;
        }
        
        .vendor-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            border-left: 4px solid var(--primary-color);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .preliquidation-generator {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .preliquidation-generator h3 {
            margin: 0 0 1rem 0;
            color: #b8860b;
        }
        
        .preliq-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .preliq-results {
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .vendors-grid {
            display: block;
            width: 100%;
        }
        
        .vendor-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .vendor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .vendor-card.inactive {
            opacity: 0.6;
            border-left-color: #dc3545;
        }
        
        .vendor-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .vendor-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .vendor-email {
            color: #666;
            font-size: 0.9rem;
        }
        
        .vendor-status {
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .vendor-status.active {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .vendor-status.inactive {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .vendor-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }
        
        .vendor-detail {
            display: flex;
            flex-direction: column;
        }
        
        .vendor-detail-label {
            color: #666;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .vendor-detail-value {
            color: #333;
        }
        
        .vendor-commission {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .commission-percentage {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .commission-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .vendor-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-vendor {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 80px;
        }
        
        .btn-vendor.primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-vendor.secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-vendor.success {
            background: #28a745;
            color: white;
        }
        
        .btn-vendor.warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-vendor:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        .preliq-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--success-color);
        }
        
        .preliq-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .preliq-vendor {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .preliq-amount {
            font-weight: bold;
            color: var(--success-color);
        }
        
        .preliq-details {
            font-size: 0.85rem;
            color: #666;
        }
        
        .vendor-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .vendor-modal.show {
            display: flex;
        }
        
        .vendor-modal-content {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            max-width: 800px;
            width: 95%;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
        }
        
        .vendor-form {
            display: grid;
            gap: 1rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .form-input {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }

        .form-help {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
            line-height: 1.3;
        }

        .vendor-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            margin: 0 0 1.2rem 0;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .vendor-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .vendor-section .form-group {
            margin-bottom: 0;
        }

        .vendor-section .form-label {
            font-weight: 500;
            color: #343a40;
            margin-bottom: 0.5rem;
        }

        .vendor-section .form-help {
            color: #6c757d;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* Estilos para tabla de vendedores */
        .vendors-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 1rem 0;
            width: 100%;
        }

        .vendors-table-container .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vendors-table-container .table-header h3 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 600;
        }

        .vendors-table-container .table-actions {
            display: flex;
            gap: 0.5rem;
        }

        .vendors-table {
            display: grid;
            grid-template-columns: 2fr 2fr 1.5fr 1fr 1fr 1fr 1fr 1.5fr;
            width: 100%;
        }

        .vendors-table .table-header-row {
            display: contents;
        }

        .vendors-table .table-cell.header {
            background: #f8f9fa;
            padding: 1rem;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            font-size: 0.9rem;
        }

        .vendors-table .table-row {
            display: contents;
        }

        .vendors-table .table-row:hover .table-cell:not(.header) {
            background-color: #f8f9fa;
        }

        .vendors-table .table-row.inactive-row .table-cell:not(.header) {
            opacity: 0.6;
            background-color: #f8f8f8;
        }

        .vendors-table .table-cell {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .vendor-name-cell {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .vendor-notes {
            color: #6c757d;
            font-size: 0.75rem;
            font-style: italic;
        }

        .commission-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
            text-align: center;
        }

        .commission-badge.sales {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .commission-badge.support {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }

        .auction-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.8rem;
            text-align: center;
        }

        .auction-badge.accepts {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .auction-badge.rejects {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .status-badge.activo {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactivo {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            margin: 1rem 0;
            color: #495057;
        }

        .empty-state p {
            margin-bottom: 2rem;
        }
        
        .form-select {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            background: white;
        }
        
        .form-textarea {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #f0f0f0;
        }
        
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }
        
        .close-modal:hover {
            color: #333;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        }

        .companies-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .companies-table th,
        .companies-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .companies-table th {
            background: var(--light-bg);
            font-weight: 600;
            color: var(--dark-text);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-active { background: #d4edda; color: #155724; }
        .status-trial { background: #fff3cd; color: #856404; }
        .status-suspended { background: #f8d7da; color: #721c24; }

        /* Filtros de búsqueda */
        .filters-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .filters-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .filters-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filters-toggle {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .filters-toggle:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }

        .filters-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--dark-text);
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .filter-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            grid-column: 1 / -1;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .btn-filter {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-filter.primary {
            background: #007bff;
            color: white;
        }

        .btn-filter.primary:hover {
            background: #0056b3;
        }

        .btn-filter.secondary {
            background: #6c757d;
            color: white;
        }

        .btn-filter.secondary:hover {
            background: #545b62;
        }

        .results-info {
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #1565c0;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            width: 95%;
            max-width: 1400px;
            max-height: 95vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            opacity: 0.8;
        }

        .close-btn:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            align-items: start;
            height: 80vh;
            overflow: hidden;
        }

        .company-form {
            max-height: 80vh;
            overflow-y: auto;
            padding-right: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark-text);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modules-section h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--dark-text);
        }

        .employee-counter {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .employee-counter input {
            width: 120px;
            padding: 8px 12px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .module-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .module-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .module-card.selected {
            border-color: var(--success-color);
            background: rgba(39, 174, 96, 0.05);
        }
        
        /* Estados de módulos */
        .module-card.contracted {
            border-color: #2196f3;
            background: rgba(33, 150, 243, 0.05);
        }
        
        .module-card.contracted.selected {
            border-color: #2196f3;
            background: rgba(33, 150, 243, 0.1);
        }
        
        .module-card.removing {
            border-color: #ff9800;
            background: rgba(255, 152, 0, 0.05);
            opacity: 0.7;
        }
        
        .module-card.new {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.05);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        .module-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .module-card.disabled:hover {
            transform: none;
            border-color: var(--border-color);
        }
        
        /* Filtros de módulos */
        .module-filters {
            display: flex;
            gap: 8px;
        }
        
        .filter-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .filter-btn:hover {
            background: #e0e0e0;
        }
        
        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* Estados de módulos */
        .module-status {
            margin-top: 8px;
            display: flex;
            justify-content: flex-end;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-badge.contracted {
            background: rgba(33, 150, 243, 0.15);
            color: #1565c0;
        }
        
        .status-badge.new {
            background: rgba(76, 175, 80, 0.15);
            color: #2e7d32;
        }
        
        .status-badge.removing {
            background: rgba(255, 152, 0, 0.15);
            color: #e65100;
        }
        
        .status-badge.available {
            background: rgba(158, 158, 158, 0.15);
            color: #424242;
        }
        
        .no-modules {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-style: italic;
        }

        .module-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .module-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .module-icon {
            font-size: 1.4rem;
        }

        .module-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .module-price {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
            min-width: 70px;
            text-align: center;
        }

        .module-description {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
        }

        .module-details {
            font-size: 0.75rem;
            color: #999;
        }

        .pricing-sidebar {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            position: sticky;
            top: 1rem;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            max-height: 80vh;
            overflow-y: auto;
        }

        .pricing-sidebar h3 {
            font-size: 1.3rem;

        /* Tabla simple de vendedores - Expandida y optimizada */
        .vendors-simple-table {
            width: 100%;
            max-width: none;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            font-size: 0.45rem; /* Reducido a la mitad */
            margin-right: 0;
        }

        .vendors-simple-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 6px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.2rem !important; /* Más pequeño con !important */
            border: none;
            white-space: nowrap;
        }

        .vendors-simple-table td {
            padding: 5px 6px; /* Reducido a la mitad */
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            font-size: 0.44rem; /* Reducido a la mitad */
        }

        .vendors-simple-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .vendors-simple-table tr.inactive-row {
            opacity: 0.7;
            background: rgba(255, 0, 0, 0.02);
        }

        .badge {
            padding: 2px 5px; /* Reducido a la mitad */
            border-radius: 6px;
            font-size: 0.39rem; /* Reducido a la mitad */
            font-weight: 600;
            text-align: center;
            display: inline-block;
            min-width: 22px; /* Reducido a la mitad */
        }

        /* Estilos específicos para celdas compactas */
        .vendors-simple-table .compact-cell {
            padding: 4px 3px; /* Reducido a la mitad */
            text-align: center;
        }

        .vendors-simple-table .number-cell {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 500;
            min-width: 40px; /* Reducido a la mitad */
        }

        .vendors-simple-table .vendor-info {
            line-height: 1.1;
            max-width: 100px; /* Reducido a la mitad */
        }

        .vendors-simple-table .vendor-info strong {
            font-size: 0.45rem; /* Reducido a la mitad */
            display: block;
            margin-bottom: 1px;
        }

        .vendors-simple-table .vendor-info small {
            color: #666;
            font-size: 0.39rem; /* Reducido a la mitad */
        }

        /* Estilos para botones compactos */
        .btn-simple {
            border: none;
            background: transparent;
            cursor: pointer;
            margin: 0 1px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .btn-simple:hover {
            background: rgba(0,0,0,0.1);
            transform: scale(1.1);
        }

        /* Mejoras adicionales para la tabla expandida */
        .vendors-simple-table thead th small {
            font-size: 0.6rem;
            opacity: 0.8;
            font-weight: 400;
        }

        /* Responsive para pantallas más pequeñas */
        @media (max-width: 1600px) {
            .vendors-simple-table {
                font-size: 0.425rem;
            }

            .vendors-simple-table th {
                font-size: 0.25rem;
                padding: 5px 4px;
            }

            .vendors-simple-table td {
                padding: 4px 3px;
                font-size: 0.41rem;
            }

            /* Ajustar anchos de columnas en pantallas medianas */
            .vendors-simple-table th:first-child,
            .vendors-simple-table td:first-child {
                width: 100px;
            }
        }

        @media (max-width: 1200px) {
            .vendors-simple-table {
                font-size: 0.4rem;
            }

            .vendors-simple-table th {
                font-size: 0.2rem;
                padding: 4px 3px;
            }

            .vendors-simple-table td {
                padding: 3px 2px;
                font-size: 0.39rem;
            }
        }

        /* Clases de utilidad adicionales */
        .text-center {
            text-align: center;
        }

        .badge-sales {
            background: #10b981;
            color: white;
        }

        .badge-support {
            background: #3b82f6;
            color: white;
        }

        .badge-referral {
            background: #8b5cf6;
            color: white;
        }

        .badge-active {
            background: #10b981;
            color: white;
        }

        .badge-inactive {
            background: #ef4444;
            color: white;
        }

        .simple-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .btn-simple {
            padding: 5px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .btn-edit {
            background: var(--primary-color);
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-simple:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
            margin-bottom: 1rem;
            color: var(--dark-text);
            text-align: center;
        }

        .tier-info {
            background: rgba(39, 174, 96, 0.1);
            border-left: 4px solid var(--success-color);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .pricing-summary {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .summary-total {
            border-top: 2px solid var(--border-color);
            padding-top: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .selected-modules {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.75rem;
        }

        .selected-modules h4 {
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .pricing-breakdown {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pricing-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .pricing-item:last-child {
            border-bottom: none;
        }

        .pricing-item.total {
            border-top: 2px solid var(--primary-color);
            margin-top: 0.5rem;
            padding-top: 0.8rem;
            font-size: 1rem;
            color: var(--primary-color);
        }

        .pricing-sidebar h4 {
            background: var(--primary-color);
            color: white;
            padding: 0.8rem;
            margin: -1.5rem -1.5rem 1rem -1.5rem;
            border-radius: 15px 15px 0 0;
            font-size: 1rem;
            text-align: center;
        }

        .pricing-sidebar h5 {
            font-size: 0.9rem;
            color: var(--dark-text);
            margin-bottom: 0.8rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.4rem;
        }

        .contracted-module {
            border: 2px solid #4CAF50 !important;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05)) !important;
        }

        .contracted-module:hover {
            border-color: #45a049 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .selected-module {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.75rem;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .modules-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-title {
                font-size: 1.8rem;
            }
        }

        /* Estilos para exportación a Excel */
        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .export-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        /* ========================================= */
        /* ESTILOS ESPECÍFICOS PARA SIAC CONFIG    */
        /* ========================================= */

        .siac-company-selector {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .siac-status-bar {
            margin-top: 1rem;
            padding: 0.8rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .siac-status-bar.active {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .siac-status-bar.inactive {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: currentColor;
        }

        .siac-config-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .siac-section {
            margin-bottom: 3rem;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }

        .siac-section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .siac-section-header h3 {
            margin: 0;
            font-size: 1.3em;
            font-weight: 600;
        }

        .siac-section-desc {
            font-size: 0.9em;
            opacity: 0.9;
            flex-basis: 100%;
            margin-top: 0.5rem;
        }

        .siac-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            padding: 2rem;
            background: #f8f9fa;
        }

        .siac-config-group {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .siac-config-group h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .terminals-container, .sessions-container {
            padding: 2rem;
            background: #f8f9fa;
        }

        .terminal-card, .session-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-color);
        }

        .terminal-header, .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .terminal-title, .session-title {
            font-weight: 600;
            color: var(--dark-text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .terminal-config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .session-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .session-stat {
            text-align: center;
            padding: 0.8rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .session-stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .session-stat-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 0.2rem;
        }

        .siac-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            padding: 2rem;
            border-top: 1px solid #e9ecef;
            margin-top: 2rem;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85em;
        }

        .status-active {
            color: var(--success-color);
            font-weight: 600;
        }

        .status-inactive {
            color: var(--danger-color);
            font-weight: 600;
        }

        .terminal-status {
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .terminal-status.active {
            background: #d4edda;
            color: #155724;
        }

        .terminal-status.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .siac-config-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1rem;
            }

            .terminal-config-grid {
                grid-template-columns: 1fr;
            }

            .siac-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .siac-section-header {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
            }
        }
        /* ==============================
           TAX TEMPLATES STYLES
           ============================== */

        .tax-templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .tax-template-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .tax-template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: #007bff;
        }

        .tax-template-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .tax-template-title {
            flex-grow: 1;
        }

        .tax-template-title h3 {
            margin: 0;
            color: #333;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .country-code {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .tax-template-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tax-template-body {
            margin-bottom: 1rem;
        }

        .tax-template-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-label {
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
        }

        .info-value {
            font-weight: 600;
            color: #333;
        }

        .tax-template-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tax-template-footer {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            border-top: 1px solid #eee;
            padding-top: 1rem;
        }

        /* Detail Modal Styles */
        .tax-template-detail {
            max-width: 100%;
        }

        .detail-section {
            margin-bottom: 2rem;
        }

        .detail-section h4 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 8px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
            display: block;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-weight: 600;
            color: #333;
        }

        .conditions-list, .concepts-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .condition-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .condition-code {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .condition-name {
            flex-grow: 1;
            font-weight: 500;
        }

        .concept-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid #ffc107;
        }

        .concept-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .concept-name {
            font-weight: 600;
            color: #333;
        }

        .concept-order {
            background: #ffc107;
            color: #333;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .concept-details {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            color: #666;
        }

        .rates-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .rate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .rate-percentage {
            background: #17a2b8;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .no-data, .no-rates {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 1rem;
        }

        @media (max-width: 768px) {
            .tax-templates-grid {
                grid-template-columns: 1fr;
            }

            .tax-template-info {
                grid-template-columns: 1fr;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .concept-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

    </style>

    <!-- Google Maps API (para módulo de Departamentos) -->
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"
            onload="console.log('✅ Google Maps cargado correctamente')"
            onerror="console.error('❌ Error cargando Google Maps')">
    </script>
    <script>
        // Callback dummy para Google Maps
        function initMap() {
            console.log('🗺️ Google Maps API inicializada');
        }
    </script>
</head>
<body>
    <div class="dashboard-header">
        <div class="dashboard-container">
            <h1 class="dashboard-title">
                🏢 Panel Administrativo
            </h1>
            <p class="dashboard-subtitle">Sistema Completo de Gestión, Facturación y Pagos</p>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Estadísticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">🏢</div>
                <div class="stat-number" id="totalCompanies">0</div>
                <div class="stat-label">Total Empresas</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">✅</div>
                <div class="stat-number" id="activeCompanies">0</div>
                <div class="stat-label">Empresas Activas</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🔄</div>
                <div class="stat-number" id="trialCompanies">0</div>
                <div class="stat-label">En Prueba</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⚠️</div>
                <div class="stat-number" id="suspendedCompanies">0</div>
                <div class="stat-label">Suspendidas</div>
            </div>
        </div>

        <!-- Sistema de Pestañas -->
        <div class="main-content">
            <div class="section-card">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="switchTab('companies')">🏢 Empresas</button>
                    <button class="nav-tab" onclick="switchTab('taxTemplates')">🏛️ Plantillas Fiscales</button>
                    <button class="nav-tab" onclick="switchTab('vendors')">👥 Vendedores</button>
                    <button class="nav-tab" onclick="switchTab('pricing')">💰 Precios</button>
                    <button class="nav-tab" onclick="switchTab('billing')">🧾 Facturación</button>
                    <button class="nav-tab" onclick="switchTab('payments')">💳 Pagos</button>
                    <button class="nav-tab" onclick="switchTab('notifications')">🔔 Notificaciones</button>
                </div>

                <!-- Pestaña Empresas -->
                <div id="companies" class="tab-content active">
                    <div class="section-header">
                        <h2 class="section-title">📊 Empresas Registradas</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="export-btn" onclick="exportCompaniesToExcel()">
                                📊 Exportar Excel
                            </button>
                            <button class="btn btn-success" onclick="openNewCompanyModal()">
                                ➕ Nueva Empresa
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <!-- Panel de Filtros -->
                        <div class="filters-panel">
                            <div class="filters-header">
                                <div class="filters-title">
                                    🔍 Filtros de Búsqueda
                                </div>
                                <button class="filters-toggle" onclick="toggleFilters()" id="filtersToggle">
                                    Ocultar Filtros
                                </button>
                            </div>
                            <div class="filters-content" id="filtersContent">
                                <div class="filter-group">
                                    <label class="filter-label">Razón Social</label>
                                    <input type="text" class="filter-input" id="filterName" placeholder="Buscar por nombre..." onkeyup="applyFiltersDebounced()">
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">CUIT</label>
                                    <input type="text" class="filter-input" id="filterCuit" placeholder="Buscar por CUIT..." onkeyup="applyFiltersDebounced()">
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">País</label>
                                    <select class="filter-input" id="filterCountry" onchange="loadFilterProvinces(); applyFilters();">
                                        <option value="">Todos los países</option>
                                        <option value="Argentina">Argentina</option>
                                        <option value="Bolivia">Bolivia</option>
                                        <option value="Brasil">Brasil</option>
                                        <option value="Chile">Chile</option>
                                        <option value="Colombia">Colombia</option>
                                        <option value="Costa Rica">Costa Rica</option>
                                        <option value="Ecuador">Ecuador</option>
                                        <option value="El Salvador">El Salvador</option>
                                        <option value="España">España</option>
                                        <option value="Guatemala">Guatemala</option>
                                        <option value="Honduras">Honduras</option>
                                        <option value="México">México</option>
                                        <option value="Nicaragua">Nicaragua</option>
                                        <option value="Panamá">Panamá</option>
                                        <option value="Paraguay">Paraguay</option>
                                        <option value="Perú">Perú</option>
                                        <option value="Uruguay">Uruguay</option>
                                        <option value="Venezuela">Venezuela</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Provincia/Estado</label>
                                    <select class="filter-input" id="filterProvince" onchange="loadFilterCities(); applyFilters();">
                                        <option value="">Todas las provincias</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Ciudad</label>
                                    <select class="filter-input" id="filterCity" onchange="applyFilters();">
                                        <option value="">Todas las ciudades</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="filter-label">Vendedor</label>
                                    <input type="text" class="filter-input" id="filterVendor" placeholder="Buscar por vendedor..." onkeyup="applyFiltersDebounced()">
                                </div>
                                <div class="filter-actions">
                                    <button class="btn-filter secondary" onclick="clearFilters()">Limpiar Filtros</button>
                                    <button class="btn-filter primary" onclick="applyFilters()">🔍 Buscar</button>
                                </div>
                            </div>
                        </div>

                        <!-- Información de resultados -->
                        <div id="resultsInfo" class="results-info" style="display: none;"></div>

                        <div id="companiesContainer">
                            <!-- Tabla de empresas se carga aquí -->
                        </div>
                    </div>
                </div>

                <!-- Pestaña Vendedores -->
                <div id="vendors" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">👥 Gestión de Vendedores</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="export-btn" onclick="exportVendorsToExcel()">
                                📊 Exportar Excel
                            </button>
                            <button class="btn btn-success" onclick="openNewVendorModal()">
                                ➕ Nuevo Vendedor
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <!-- Panel de Control de Vendedores -->
                        <div class="vendor-controls">
                            <div class="vendor-stats" id="vendorStats">
                                <div class="stat-card">
                                    <div class="stat-value">-</div>
                                    <div class="stat-label">Total Vendedores</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">-</div>
                                    <div class="stat-label">Vendedores Activos</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">$-</div>
                                    <div class="stat-label">Comisiones del Mes</div>
                                </div>
                            </div>
                            
                            <!-- Generador de Preliquidaciones -->
                            <div class="preliquidation-generator">
                                <h3>💰 Generar Preliquidaciones</h3>
                                <div class="preliq-controls">
                                    <select id="preliqMonth" class="filter-input">
                                        <option value="">Mes</option>
                                        <option value="1">Enero</option>
                                        <option value="2">Febrero</option>
                                        <option value="3">Marzo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Mayo</option>
                                        <option value="6">Junio</option>
                                        <option value="7">Julio</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Septiembre</option>
                                        <option value="10">Octubre</option>
                                        <option value="11">Noviembre</option>
                                        <option value="12">Diciembre</option>
                                    </select>
                                    <input type="number" id="preliqYear" class="filter-input" placeholder="Año" min="2020" max="2030">
                                    <button class="btn btn-primary" onclick="generateAllPreliquidations()">
                                        📊 Generar Todas
                                    </button>
                                </div>
                                <div id="preliquidationResults" class="preliq-results"></div>
                            </div>
                        </div>

                        <!-- Lista de Vendedores -->
                        <div id="vendorsContainer" class="vendors-grid">
                            <!-- Los vendedores se cargarán aquí dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- Pestaña Precios -->
                <div id="pricing" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">💰 Configuración de Precios</h2>
                        <button class="btn btn-success" onclick="saveAllPricing()">
                            💾 Guardar Cambios
                        </button>
                    </div>
                    <div class="section-content">
                        <div id="pricingContainer">
                            <!-- Controles de precios se cargan aquí -->
                        </div>
                    </div>
                </div>

                <!-- Pestaña Facturación -->
                <div id="billing" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">🧾 Sistema de Facturación</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="export-btn" onclick="exportBillingToExcel()">
                                📊 Exportar Excel
                            </button>
                            <button class="btn btn-success" onclick="generateMonthlyInvoices()">
                                📊 Generar Facturas Mes
                            </button>
                            <button class="btn btn-primary" onclick="checkOverduePayments()">
                                ⚠️ Verificar Vencidos
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="billingContainer">
                            <!-- Filtros de facturación -->
                            <div class="filters-section">
                                <div class="filters-header">
                                    <h3>🔍 Filtros de Facturas</h3>
                                </div>
                                <div class="filters-content">
                                    <div class="filter-group">
                                        <label class="filter-label">Mes</label>
                                        <select class="filter-input" id="billingMonth">
                                            <option value="">Todos los meses</option>
                                            <option value="1">Enero</option>
                                            <option value="2">Febrero</option>
                                            <option value="3">Marzo</option>
                                            <option value="4">Abril</option>
                                            <option value="5">Mayo</option>
                                            <option value="6">Junio</option>
                                            <option value="7">Julio</option>
                                            <option value="8">Agosto</option>
                                            <option value="9">Septiembre</option>
                                            <option value="10">Octubre</option>
                                            <option value="11">Noviembre</option>
                                            <option value="12">Diciembre</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label class="filter-label">Año</label>
                                        <select class="filter-input" id="billingYear">
                                            <option value="">Todos los años</option>
                                            <option value="2024">2024</option>
                                            <option value="2025">2025</option>
                                            <option value="2026">2026</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label class="filter-label">Vendedor</label>
                                        <input type="text" class="filter-input" id="billingVendor" placeholder="Filtrar por vendedor">
                                    </div>
                                    <div class="filter-group">
                                        <label class="filter-label">Estado de Pago</label>
                                        <select class="filter-input" id="billingPaymentStatus">
                                            <option value="">Todos</option>
                                            <option value="paid">Pagado</option>
                                            <option value="pending">Pendiente</option>
                                        </select>
                                    </div>
                                    <div class="filter-actions">
                                        <button class="btn-filter primary" onclick="loadBillingData()">🔍 Buscar</button>
                                        <button class="btn-filter secondary" onclick="clearBillingFilters()">Limpiar</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Generación de facturas -->
                            <div class="generate-invoices-section" style="margin-top: 2rem;">
                                <div class="filters-header">
                                    <h3>📊 Generar Canon Mensual</h3>
                                </div>
                                <div class="filters-content">
                                    <div class="filter-group">
                                        <label class="filter-label">Mes a generar</label>
                                        <select class="filter-input" id="generateMonth">
                                            <option value="">Seleccionar mes</option>
                                            <option value="1">Enero</option>
                                            <option value="2">Febrero</option>
                                            <option value="3">Marzo</option>
                                            <option value="4">Abril</option>
                                            <option value="5">Mayo</option>
                                            <option value="6">Junio</option>
                                            <option value="7">Julio</option>
                                            <option value="8">Agosto</option>
                                            <option value="9">Septiembre</option>
                                            <option value="10">Octubre</option>
                                            <option value="11">Noviembre</option>
                                            <option value="12">Diciembre</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label class="filter-label">Año a generar</label>
                                        <select class="filter-input" id="generateYear">
                                            <option value="2024">2024</option>
                                            <option value="2025" selected>2025</option>
                                            <option value="2026">2026</option>
                                        </select>
                                    </div>
                                    <div class="filter-actions">
                                        <button class="btn btn-success" onclick="generateMonthlyCanon()">📊 Generar Canon Mensual</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Resumen de totales -->
                            <div id="billingTotals" style="display: none; margin-top: 2rem;">
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-icon">💰</div>
                                        <div class="stat-number" id="totalFacturado">$0</div>
                                        <div class="stat-label">Total Facturado</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon">💸</div>
                                        <div class="stat-number" id="totalComisiones">$0</div>
                                        <div class="stat-label">Total Comisiones</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon">🏢</div>
                                        <div class="stat-number" id="totalAponnt">$0</div>
                                        <div class="stat-label">Total Aponnt</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-icon">✅</div>
                                        <div class="stat-number" id="totalPagado">$0</div>
                                        <div class="stat-label">Total Pagado</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tabla de facturas -->
                            <div id="billingTableContainer" style="margin-top: 2rem;">
                                <!-- La tabla se carga dinámicamente aquí -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pestaña Pagos -->
                <div id="payments" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">💳 Sistema de Pagos</h2>
                        <button class="btn btn-success" onclick="processAutomaticPayments()">
                            🔄 Procesar Pagos Automáticos
                        </button>
                    </div>
                    <div class="section-content">
                        <div id="paymentsContainer">
                            <!-- Sistema de pagos se carga aquí -->
                        </div>
                    </div>
                </div>

                <!-- Pestaña Notificaciones -->
                <div id="notifications" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">🔔 Sistema de Notificaciones</h2>
                        <button class="btn btn-success" onclick="sendPaymentReminders()">
                            📧 Enviar Recordatorios
                        </button>
                    </div>
                    <div class="section-content">
                        <div id="notificationsContainer">
                            <!-- Sistema de notificaciones se carga aquí -->
                        </div>
                    </div>
                </div>

                <!-- Pestaña Plantillas Fiscales -->
                <div id="taxTemplates" class="tab-content">
                    <div class="section-header">
                        <h2 class="section-title">🏛️ Plantillas Fiscales por País</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="openNewTaxTemplateModal()">
                                ➕ Nueva Plantilla
                            </button>
                            <button class="btn btn-info" onclick="exportAllTaxTemplates()">
                                📤 Exportar Todas
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="taxTemplatesContainer">
                            <!-- Lista de plantillas se carga aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nueva/Editar Empresa -->
    <div id="companyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Nueva Empresa</h3>
                <button class="close-btn" onclick="closeCompanyModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="companyForm">
                    <div class="form-grid">
                        <div class="company-form">
                            <div class="form-group">
                                <label class="form-label">Nombre de la Empresa *</label>
                                <input type="text" class="form-input" id="companyName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Razón Social</label>
                                <input type="text" class="form-input" id="legalName">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CUIT *</label>
                                <input type="text" class="form-input" id="taxId" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-input" id="contactEmail" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Teléfono</label>
                                <input type="text" class="form-input" id="contactPhone">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Dirección</label>
                                <input type="text" class="form-input" id="address" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">País</label>
                                <select class="form-input" id="country" onchange="loadProvinces()">
                                    <option value="Argentina">Argentina</option>
                                    <option value="Bolivia">Bolivia</option>
                                    <option value="Brasil">Brasil</option>
                                    <option value="Chile">Chile</option>
                                    <option value="Colombia">Colombia</option>
                                    <option value="Costa Rica">Costa Rica</option>
                                    <option value="Ecuador">Ecuador</option>
                                    <option value="El Salvador">El Salvador</option>
                                    <option value="España">España</option>
                                    <option value="Guatemala">Guatemala</option>
                                    <option value="Honduras">Honduras</option>
                                    <option value="México">México</option>
                                    <option value="Nicaragua">Nicaragua</option>
                                    <option value="Panamá">Panamá</option>
                                    <option value="Paraguay">Paraguay</option>
                                    <option value="Perú">Perú</option>
                                    <option value="Uruguay">Uruguay</option>
                                    <option value="Venezuela">Venezuela</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Provincia</label>
                                <select class="form-input" id="province" onchange="loadCities()">
                                    <option value="">Seleccionar provincia...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ciudad</label>
                                <select class="form-input" id="city" onchange="loadPostalCode()">
                                    <option value="">Seleccionar ciudad...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Código Postal</label>
                                <input type="text" class="form-input" id="postalCode" readonly style="background-color: #f8f9fa;">
                            </div>

                            <!-- Sección de Geolocalización para Empresa -->
                            <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">
                                <h6 style="color: #495057; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                    🌐 Geolocalización de la Empresa
                                </h6>
                                <div class="form-row">
                                    <div class="form-group" style="flex: 1;">
                                        <label class="form-label">Latitud</label>
                                        <input type="number" class="form-input" id="companyLatitude" step="any"
                                               placeholder="Ej: -34.6037">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label class="form-label">Longitud</label>
                                        <input type="number" class="form-input" id="companyLongitude" step="any"
                                               placeholder="Ej: -58.3816">
                                    </div>
                                </div>
                                <div style="text-align: center; margin-top: 0.75rem;">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="geocodeCompanyAddress()">
                                        📍 Obtener coordenadas automáticamente
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="showCompanyMap()" style="margin-left: 0.5rem;">
                                        🗺️ Ver en mapa
                                    </button>
                                </div>
                                <div style="font-size: 0.8rem; color: #6c757d; margin-top: 0.5rem; text-align: center;">
                                    Las coordenadas se obtienen desde la dirección de la empresa ingresada arriba
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tipo de Licencia</label>
                                <select class="form-input" id="licenseType">
                                    <option value="basic">Básica</option>
                                    <option value="premium">Premium</option>
                                    <option value="enterprise">Empresarial</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estado</label>
                                <select class="form-input" id="companyStatus">
                                    <option value="cotizado">Cotizado</option>
                                    <option value="active">Activo</option>
                                    <option value="suspended">Suspendido</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vendedor</label>
                                <select class="form-input" id="vendor">
                                    <option value="">Seleccionar vendedor...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">% Comisión</label>
                                <input type="number" class="form-input" id="commissionPercentage" min="0" max="100" step="0.1" placeholder="10">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CBU (Cuenta Bancaria)</label>
                                <input type="text" class="form-input" id="cbu" placeholder="Número de CBU">
                            </div>

                            <div class="modules-section">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h3>📦 Módulos del Sistema (<span id="moduleCount">0</span> seleccionados)</h3>
                                    <div class="module-filters">
                                        <button type="button" class="filter-btn active" onclick="filterModules('all')" id="filterAll">Todos</button>
                                        <button type="button" class="filter-btn" onclick="filterModules('contracted')" id="filterContracted">Contratados</button>
                                        <button type="button" class="filter-btn" onclick="filterModules('available')" id="filterAvailable">Disponibles</button>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 15px;">
                                    <div class="employee-counter" style="flex: 1;">
                                        <label class="form-label">Empleados Contratados (para facturación):</label>
                                        <input type="number" id="contractedEmployees" value="1" min="1" max="10000" onchange="updateModulePricing()">
                                        <small style="color: #666; font-size: 0.85em; margin-top: 4px; display: block;">
                                            Cantidad de empleados que la empresa paga mensualmente
                                        </small>
                                    </div>
                                    <div class="employee-counter" style="flex: 1;">
                                        <label class="form-label">Límite Máximo de Empleados:</label>
                                        <input type="number" id="maxEmployees" value="50" min="1" max="10000">
                                        <small style="color: #666; font-size: 0.85em; margin-top: 4px; display: block;">
                                            Límite técnico del sistema para esta empresa
                                        </small>
                                    </div>
                                </div>
                                <div class="modules-grid" id="modulesGrid">
                                    <!-- Módulos se cargan aquí -->
                                </div>
                            </div>
                        </div>

                        <div class="pricing-sidebar">
                            <h3>💰 Cotización</h3>
                            
                            <div class="tier-info" id="tierInfo">
                                <strong>Tier:</strong> <span id="currentTier">1-50 empleados</span><br>
                                <strong>Descuento:</strong> <span id="currentDiscount">Sin descuento</span>
                            </div>

                            <div class="pricing-summary">
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <span>$ <span id="subtotal">0.00</span></span>
                                </div>
                                <div class="summary-row">
                                    <span>IVA (21%):</span>
                                    <span>$ <span id="tax">0.00</span></span>
                                </div>
                                <div class="summary-row summary-total">
                                    <span>Total Mensual:</span>
                                    <span>$ <span id="total">0.00</span></span>
                                </div>
                            </div>

                            <div class="selected-modules" id="selectedModules">
                                <h4>Módulos Seleccionados (<span id="moduleCount">0</span>):</h4>
                                <div id="selectedModulesList" class="selected-modules"></div>
                            </div>

                            <div id="priceUpdateSection" style="margin: 1rem 0; padding: 1rem; background: #fff3cd; border-radius: 8px; display: none;">
                                <h5 style="color: #856404; margin-bottom: 0.5rem;">⚠️ Actualizar Precios</h5>
                                <p style="font-size: 0.9rem; color: #856404; margin-bottom: 1rem;">Los precios de los módulos han cambiado desde la contratación. ¿Deseas aplicar los nuevos precios?</p>
                                <label style="display: flex; align-items: center; gap: 0.5rem; color: #856404;">
                                    <input type="checkbox" id="updatePricesCheckbox" onchange="togglePriceUpdate()">
                                    <span>Aplicar precios actuales (se recalculará el canon mensual)</span>
                                </label>
                            </div>
                            
                            <div id="moduleModificationSection" style="margin: 1rem 0; padding: 1rem; background: #e3f2fd; border-radius: 8px; display: none;">
                                <h5 style="color: #1565c0; margin-bottom: 0.5rem;">🔧 Modificar Módulos</h5>
                                <p style="font-size: 0.9rem; color: #1565c0; margin-bottom: 1rem;">Permite agregar o quitar módulos ya contratados.</p>
                                <label style="display: flex; align-items: center; gap: 0.5rem; color: #1565c0;">
                                    <input type="checkbox" id="allowModificationCheckbox" onchange="toggleModuleModification()">
                                    <span>Permitir modificar módulos contratados</span>
                                </label>
                            </div>

                            <!-- Sección de Gestión de Sucursales -->
                            <div id="branchesSection" style="margin: 2rem 0; padding: 1.5rem; background: #f3e5f5; border-radius: 12px; border: 2px solid #7b1fa2; box-shadow: 0 4px 8px rgba(123, 31, 162, 0.2);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                    <h4 style="color: #7b1fa2; margin: 0; font-size: 1.2rem; font-weight: 600;">🏢 Gestión de Sucursales</h4>
                                    <button type="button" class="btn btn-primary" onclick="openBranchModal()" style="background: #7b1fa2; border-color: #7b1fa2;">
                                        <i class="fas fa-plus"></i> Nueva Sucursal
                                    </button>
                                </div>
                                <div id="branchesContainer" style="margin-top: 1rem;">
                                    <div class="no-branches" style="text-align: center; color: #666; padding: 2rem; background: white; border-radius: 8px; border: 1px dashed #ccc;">
                                        <div style="font-size: 2rem; margin-bottom: 1rem;">🏢</div>
                                        <h5>No hay sucursales registradas</h5>
                                        <p>Haz clic en "Nueva Sucursal" para agregar la primera</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sección de Gestión de Usuarios -->
                            <div id="usersSection" style="margin: 1rem 0; padding: 1rem; background: #e3f2fd; border-radius: 8px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                    <h5 style="color: #1976d2; margin: 0;">👤 Usuarios Administradores</h5>
                                    <button type="button" class="btn btn-sm btn-info" onclick="loadCompanyUsers()" style="font-size: 0.8rem;">
                                        <i class="fas fa-sync"></i> Actualizar
                                    </button>
                                </div>
                                <div id="usersContainer" style="margin-top: 1rem;">
                                    <div class="no-users" style="text-align: center; color: #666; padding: 1rem;">
                                        Haga clic en "Actualizar" para cargar usuarios
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </form>
            </div>
            <!-- Footer del modal con botones -->
            <div class="modal-footer" style="padding: 1rem 2rem; border-top: 1px solid #eee; display: flex; gap: 1rem; justify-content: flex-end; background: #f8f9fa; border-radius: 0 0 20px 20px;">
                <button type="button" class="btn" style="padding: 0.75rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 8px; font-weight: 600;" onclick="closeCompanyModal()">
                    ❌ Cancelar
                </button>
                <button type="button" class="btn btn-success" style="padding: 0.75rem 2rem; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: 600;" id="saveCompanyBtn" onclick="saveCompany()">
                    <span id="saveBtnText">💾 Guardar Cambios</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo/Editar Vendedor -->
    <div id="vendorModal" class="vendor-modal">
        <div class="vendor-modal-content">
            <div class="modal-header">
                <h3 id="vendorModalTitle">➕ Nuevo Vendedor</h3>
                <button class="close-btn" onclick="closeVendorModal()">&times;</button>
            </div>

            <div class="modal-body">
                <form id="vendorForm">
                    <!-- Información Personal -->
                    <div class="vendor-section">
                        <h4 class="section-title">👤 Información Personal</h4>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="vendorName" class="form-label">Nombre Completo *</label>
                                <input type="text" id="vendorName" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="vendorEmail" class="form-label">Email *</label>
                                <input type="email" id="vendorEmail" class="form-input" required>
                            </div>
                        </div>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="vendorPhone" class="form-label">Teléfono</label>
                                <input type="tel" id="vendorPhone" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="vendorCBU" class="form-label">CBU</label>
                                <input type="text" id="vendorCBU" class="form-input" maxlength="22">
                            </div>
                        </div>
                    </div>

                    <!-- Configuración de Comisiones -->
                    <div class="vendor-section">
                        <h4 class="section-title">💰 Configuración de Comisiones</h4>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="vendorSalesCommission" class="form-label">% Comisión Ventas *</label>
                                <input type="number" id="vendorSalesCommission" class="form-input" min="0" max="100" step="0.1" value="10" required>
                                <small class="form-help">🔒 Comisión fija por ventas (no transferible)</small>
                            </div>
                            <div class="form-group">
                                <label for="vendorSupportCommission" class="form-label">% Comisión Soporte</label>
                                <input type="number" id="vendorSupportCommission" class="form-input" min="0" max="100" step="0.1" value="5">
                                <small class="form-help">🔄 Comisión por asistencia al cliente (transferible)</small>
                            </div>
                        </div>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="vendorAcceptsSupportPackages" class="form-label">Acepta Paquetes de Soporte</label>
                                <select id="vendorAcceptsSupportPackages" class="form-input">
                                    <option value="true">✅ Sí, acepto dar soporte</option>
                                    <option value="false">❌ No, solo ventas</option>
                                </select>
                                <small class="form-help">📋 Define si acepta comisiones por asistencia</small>
                            </div>
                            <div class="form-group">
                                <label for="vendorAcceptsAuctions" class="form-label">Participa en Subastas</label>
                                <select id="vendorAcceptsAuctions" class="form-input">
                                    <option value="true">🎯 Sí, participo en subastas</option>
                                    <option value="false">🚫 No, no participo</option>
                                </select>
                                <small class="form-help">🔄 Define si participa en subastas de paquetes reasignados</small>
                            </div>
                        </div>
                    </div>

                    <!-- Configuración General -->
                    <div class="vendor-section">
                        <h4 class="section-title">⚙️ Configuración General</h4>
                        <div class="vendor-grid-2">
                            <div class="form-group">
                                <label for="vendorStatus" class="form-label">Estado</label>
                                <select id="vendorStatus" class="form-input">
                                    <option value="activo">✅ Activo</option>
                                    <option value="inactivo">❌ Inactivo</option>
                                </select>
                            </div>
                            <div class="form-group"></div>
                        </div>
                        <div class="form-group">
                            <label for="vendorNotes" class="form-label">Notas</label>
                            <textarea id="vendorNotes" class="form-input" rows="3" placeholder="Observaciones adicionales..."></textarea>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeVendorModal()">
                    ❌ Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="saveVendor()" id="saveVendorBtn">
                    <span id="saveVendorBtnText">💾 Guardar Vendedor</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuración de la API y autenticación
        const API_BASE = ''; // Base vacía para usar rutas completas
        let currentUser = null;
        
        // Configurar token temporal para pruebas
        // Token debe ser obtenido mediante login real, no hardcodeado
        
        // Datos de demo para testing offline
        let demoCompanies = [
            {
                id: 1,
                name: "Empresa Demo 1",
                legalName: "Empresa Demo S.A.",
                taxId: "20-12345678-9",
                contactEmail: "admin@demo1.com",
                contactPhone: "011-1234-5678",
                address: "Av. Corrientes 1234",
                licenseType: "enterprise",
                maxEmployees: 100,
                status: "active",
                modules: ["attendance", "payroll", "billing"],
                modulesPricing: {
                    attendance: { name: "Asistencia", price: 500, totalPrice: 50000 },
                    payroll: { name: "Nómina", price: 800, totalPrice: 80000 },
                    billing: { name: "Facturación", price: 600, totalPrice: 60000 }
                },
                pricing: {
                    tier: "Enterprise",
                    monthlySubtotal: 190000,
                    monthlyTax: 39900,
                    monthlyTotal: 229900,
                    lastUpdated: new Date().toISOString()
                },
                createdAt: new Date().toISOString(),
                currentTier: "enterprise"
            },
            {
                id: 2,
                name: "Empresa Demo 2",
                legalName: "Demo Corp",
                taxId: "20-87654321-0",
                contactEmail: "contact@demo2.com",
                contactPhone: "011-8765-4321",
                address: "Av. Santa Fe 5678",
                licenseType: "professional",
                maxEmployees: 50,
                status: "active",
                modules: ["attendance", "reports"],
                modulesPricing: {
                    attendance: { name: "Asistencia", price: 400, totalPrice: 20000 },
                    reports: { name: "Reportes", price: 300, totalPrice: 15000 }
                },
                pricing: {
                    tier: "Professional",
                    monthlySubtotal: 35000,
                    monthlyTax: 7350,
                    monthlyTotal: 42350,
                    lastUpdated: new Date().toISOString()
                },
                createdAt: new Date().toISOString(),
                currentTier: "professional"
            }
        ];
        
        let demoMode = false; // Forzar modo real // Modo real con base de datos
        let fallbackToDemo = false; // Fallback a demo deshabilitado - usar solo datos reales de PostgreSQL
        
        // Verificación de autenticación simplificada (se ejecuta en el segundo DOMContentLoaded)

        function checkAuthentication() {
            // Panel administrativo - acceso directo sin autenticación
            currentUser = { username: 'admin_panel', firstName: 'Panel Administrativo', role: 'administrador' };
            console.log('🔓 Acceso directo al panel administrativo');

            // Mostrar interfaz completa
            setupUIForRole();
        }

        async function verifyTokenWithServer(token) {
            try {
                const response = await fetch(`${API_BASE}/auth/verify`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    logout();
                }
                
            } catch (error) {
                console.error('Error verificando token:', error);
                // No desloguear automáticamente por errores de red
            }
        }

        function setupUIForRole() {
            // Configurar título del panel administrativo
            const dashboardTitle = document.querySelector('.dashboard-title');
            if (dashboardTitle) {
                dashboardTitle.innerHTML = `
                    🏢 Panel Administrativo APONNT
                    <div style="font-size: 0.6em; opacity: 0.8; margin-left: auto;">
                        Acceso Total - Sin Restricciones
                    </div>
                `;
            }

            // Si es administrador, agregar pestaña de gestión de usuarios
            if (currentUser.role === 'administrador') {
                addAdminTabs();
            }

            // Cargar datos del dashboard
            loadDashboardData();
            loadAllSystems();
        }

        function addAdminTabs() {
            const navTabs = document.querySelector('.nav-tabs');
            if (navTabs) {
                const adminTab = document.createElement('button');
                adminTab.className = 'nav-tab';
                adminTab.onclick = () => switchTab('users');
                adminTab.innerHTML = '👥 Usuarios';
                navTabs.appendChild(adminTab);

                // Agregar contenido de la pestaña de usuarios
                const mainContent = document.querySelector('.main-content .section-card');
                if (mainContent) {
                    const usersTab = document.createElement('div');
                    usersTab.id = 'users';
                    usersTab.className = 'tab-content';
                    usersTab.innerHTML = `
                        <div class="section-header">
                            <h2 class="section-title">👥 Gestión de Usuarios</h2>
                            <button class="btn btn-success" onclick="openNewUserModal()">
                                ➕ Nuevo Operador
                            </button>
                        </div>
                        <div class="section-content">
                            <div id="usersContainer">
                                <!-- Lista de usuarios se carga aquí -->
                            </div>
                        </div>
                    `;
                    mainContent.appendChild(usersTab);
                }
            }
        }

        async function loadOperators() {
            if (currentUser.role !== 'administrador') return;

            try {
                console.log('👥 [LOAD-OPERATORS] Cargando usuarios multi-tenant');
                const response = await fetch(`${API_BASE}/admin/operators`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('👥 [LOAD-OPERATORS] Datos recibidos:', data);

                    // Usar la nueva estructura unificada
                    const allUsers = data.users || [];
                    const usersByCompany = data.usersByCompany || {};

                    console.log(`👥 [LOAD-OPERATORS] Total usuarios: ${allUsers.length}`);
                    console.log('👥 [LOAD-OPERATORS] Usuarios por empresa:', Object.keys(usersByCompany).map(companyId => ({
                        companyId,
                        count: usersByCompany[companyId].length
                    })));

                    // Renderizar todos los usuarios con información de empresa
                    renderOperators(allUsers, usersByCompany);
                } else {
                    console.error('Error cargando operadores:', response.statusText);
                    renderOperators([], {});
                }

            } catch (error) {
                console.error('Error cargando operadores:', error);
                renderOperators([], {});
            }
        }

        function renderOperators(operators, usersByCompany = {}) {
            const container = document.getElementById('usersContainer');
            if (!container) return;

            if (operators.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #7f8c8d;">
                        <div style="font-size: 3em; margin-bottom: 1rem;">👥</div>
                        <h3>No hay usuarios registrados</h3>
                        <p>Crea tu primer usuario</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="margin-bottom: 1rem;">
                    <h4>👥 Usuarios Multi-Tenant (${operators.length} total)</h4>
                    <p style="color: #666; font-size: 0.9rem;">
                        Usuarios distribuidos en ${Object.keys(usersByCompany).length} empresas activas
                    </p>
                </div>
                <table class="companies-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Nombre Completo</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Empresa</th>
                            <th>Departamento</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Agrupar por empresa para mejor visualización
            Object.keys(usersByCompany).forEach(companyId => {
                const companyUsers = usersByCompany[companyId];
                if (companyUsers.length === 0) return;

                // Encabezado de empresa
                html += `
                    <tr style="background: #f8f9fa; font-weight: bold;">
                        <td colspan="8" style="padding: 0.75rem; border-top: 2px solid #dee2e6;">
                            🏢 ${companyUsers[0].companyName || `Empresa ${companyId}`} (${companyUsers.length} usuarios)
                        </td>
                    </tr>
                `;

                // Usuarios de la empresa
                companyUsers.forEach(user => {
                    const roleColor = {
                        'admin': '#dc3545',
                        'super_admin': '#6f42c1',
                        'manager': '#fd7e14',
                        'supervisor': '#198754',
                        'employee': '#0d6efd',
                        'vendor': '#20c997'
                    }[user.role] || '#6c757d';

                    html += `
                        <tr>
                            <td><strong>${user.usuario}</strong><br><small style="color: #666;">${user.employeeId}</small></td>
                            <td>${user.fullName}</td>
                            <td>${user.email || '-'}</td>
                            <td>
                                <span style="background: ${roleColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">
                                    ${user.role}
                                </span>
                            </td>
                            <td style="font-size: 0.9rem; color: #666;">${user.companyName}</td>
                            <td style="font-size: 0.9rem; color: #666;">${user.departmentName || 'Sin asignar'}</td>
                            <td>
                                <span class="status-badge ${user.isActive ? 'status-active' : 'status-suspended'}">
                                    ${user.isActive ? 'Activo' : 'Inactivo'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-primary" onclick="editUser(${user.user_id})" style="margin-right: 5px; font-size: 0.8rem;">
                                    ✏️ Editar
                                </button>
                                ${user.role !== 'super_admin' ?
                                    `<button class="btn btn-danger" onclick="deleteUser(${user.user_id}, '${user.usuario}')" style="background: #dc3545; font-size: 0.8rem;">🗑️</button>`
                                    :
                                    '<span style="color: #95a5a6; font-size: 0.8rem;">🔒</span>'
                                }
                            </td>
                        </tr>
                    `;
                });
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Función logout eliminada - Panel administrativo sin autenticación

        // Configuración de módulos y precios
        const pricingConfig = {
            taxRate: 0.21,
            employeeTiers: [
                { min: 1, max: 50, multiplier: 1.0, name: "1-50 empleados", discount: "Sin descuento" },
                { min: 51, max: 100, multiplier: 0.85, name: "51-100 empleados", discount: "15% descuento" },
                { min: 101, max: 999999, multiplier: 0.70, name: "101+ empleados", discount: "30% descuento" }
            ],
            modules: {
                // Los módulos se cargarán dinámicamente desde la API
                // Configuración de respaldo en caso de fallo de API:
                'users': { name: 'Usuarios', icon: '👥', color: '#4CAF50', basePrice: 2.50, description: 'Gestión de empleados y perfiles de usuario' },
                'departments': { name: 'Departamentos', icon: '🏢', color: '#2196F3', basePrice: 5.00, description: 'Configuración y gestión de departamentos y ubicaciones' },
                'shifts': { name: 'Turnos', icon: '🕐', color: '#FF9800', basePrice: 8.00, description: 'Gestión de horarios y jornadas laborales' },
                'attendance': { name: 'Asistencia', icon: '📋', color: '#9C27B0', basePrice: 30.00, description: 'Control de ingresos, salidas y asistencia' },
                'facial-biometric': { name: 'Biometría', icon: '🎭', color: '#E91E63', basePrice: 25.00, description: 'Reconocimiento facial para autenticación' },
                'medical-dashboard': { name: 'Médico', icon: '👩‍⚕️', color: '#00BCD4', basePrice: 20.00, description: 'Gestión de información médica de empleados' },
                'art-management': { name: 'ART', icon: '🏥', color: '#F44336', basePrice: 18.00, description: 'Administración de Aseguradoras de Riesgos del Trabajo' },
                'document-management': { name: 'Documentos', icon: '📄', color: '#795548', basePrice: 10.00, description: 'Administración de documentos y archivos' },
                'legal-dashboard': { name: 'Legal', icon: '⚖️', color: '#3F51B5', basePrice: 15.00, description: 'Gestión de aspectos legales y normativos' },
                'payroll-liquidation': { name: 'Liquidación', icon: '💰', color: '#4CAF50', basePrice: 22.00, description: 'Cálculo y gestión de nóminas y liquidaciones' },
                'employee-map': { name: 'Mapa Empleados', icon: '🗺️', color: '#8BC34A', basePrice: 12.00, description: 'Ubicación y seguimiento en tiempo real' },
                'training-management': { name: 'Capacitaciones', icon: '📚', color: '#FF5722', basePrice: 14.00, description: 'Administración de cursos y entrenamientos' },
                'notifications': { name: 'Notificaciones', icon: '📱', color: '#FF6B6B', basePrice: 7.00, description: 'Sistema de notificaciones y comunicaciones internas' },
                'job-postings': { name: 'Postulaciones', icon: '💼', color: '#6f42c1', basePrice: 9.00, description: 'Gestión de ofertas de trabajo y candidatos' },
                'settings': { name: 'Configuración', icon: '⚙️', color: '#9E9E9E', basePrice: 3.00, description: 'Ajustes generales y configuraciones del sistema' },
                'biometric': { name: 'Biometría', icon: '🎭', color: '#E91E63', basePrice: 20.00, description: 'Reconocimiento biométrico avanzado' },
                'reports': { name: 'Reportes', icon: '📊', color: '#FF9800', basePrice: 15.00, description: 'Informes y estadísticas avanzadas' },
                'psychological-assessment': { name: 'Evaluación Psicológica', icon: '🧠', color: '#9b59b6', basePrice: 2500.00, description: 'Sistema de evaluación psicológica integral con detección de estrés y violencia' },
                'sanctions-management': { name: 'Gestión de Sanciones', icon: '⚖️', color: '#e74c3c', basePrice: 1800.00, description: 'Sistema completo de gestión disciplinaria y sanciones' },
                'vacation-management': { name: 'Gestión de Vacaciones', icon: '🏖️', color: '#27ae60', basePrice: 2200.00, description: 'Sistema integral de gestión de vacaciones y licencias con programación automática' }
            }
        };

        let companies = [];
        let selectedModules = new Set();
        let invoices = [];
        let paymentMethods = [];
        let notifications = [];
        let currentTab = 'companies';
        let currentEditingCompany = null;

        // ✅ BACKEND AUTO-VERIFICATION v2.3.0 - Railway Compatible
        async function checkBackendStatus() {
            // Detectar si estamos en producción
            const isProduction = !window.location.port ||
                                window.location.hostname.includes('railway.app') ||
                                window.location.hostname.includes('herokuapp.com') ||
                                window.location.hostname.includes('vercel.app');

            let BACKEND_URL;

            if (isProduction) {
                // 🚂 PRODUCCIÓN: Usar URL base sin puerto
                BACKEND_URL = `${window.location.protocol}//${window.location.hostname}`;
                console.log('🚂 [BACKEND-CHECK] Verificando backend en producción:', BACKEND_URL);
            } else {
                // 💻 LOCAL: Usar localhost con puerto
                const BACKEND_PORT = window.DYNAMIC_CONFIG?.port || 9999;
                BACKEND_URL = `http://localhost:${BACKEND_PORT}`;
                console.log('💻 [BACKEND-CHECK] Verificando backend local en puerto:', BACKEND_PORT);
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/v1/health`, {
                    method: 'GET',
                    timeout: 3000
                });

                if (response.ok) {
                    console.log('✅ [BACKEND-CHECK] Backend ejecutándose correctamente');
                    return true;
                } else {
                    throw new Error(`Backend responde con error: ${response.status}`);
                }
            } catch (error) {
                console.warn('❌ [BACKEND-CHECK] Backend no disponible:', error.message);
                if (!isProduction) {
                    // Solo mostrar warning en desarrollo local
                    showBackendWarning();
                }
                return false;
            }
        }

        function showBackendWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.id = 'backend-warning';
            warningDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 99999;
                color: white;
                font-family: Arial, sans-serif;
            `;

            warningDiv.innerHTML = `
                <div style="background: #1a1a1a; padding: 30px; border-radius: 10px; text-align: center; max-width: 500px;">
                    <h2 style="color: #ff6b6b; margin-bottom: 20px;">⚠️ Backend No Detectado</h2>
                    <p style="margin-bottom: 15px;">El sistema necesita el backend ejecutándose en puerto <strong>9999</strong></p>
                    <div style="background: #2d2d2d; padding: 15px; border-radius: 5px; margin: 20px 0;">
                        <h3 style="color: #4ecdc4; margin-bottom: 10px;">🚀 Para iniciar el backend:</h3>
                        <p style="font-family: monospace; background: #000; padding: 10px; border-radius: 3px;">
                            Haz doble clic en: <strong>INICIO_AUTOMATICO.bat</strong>
                        </p>
                        <p style="margin-top: 10px; font-size: 14px; color: #aaa;">
                            O abre terminal y ejecuta: <code>cd backend && PORT=9999 npm start</code>
                        </p>
                    </div>
                    <button onclick="window.location.reload()" style="
                        background: #4ecdc4;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        color: white;
                        cursor: pointer;
                        margin-right: 10px;
                    ">🔄 Verificar Nuevamente</button>
                    <button onclick="document.getElementById('backend-warning').style.display='none'" style="
                        background: #666;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        color: white;
                        cursor: pointer;
                    ">⚠️ Continuar sin Backend</button>
                </div>
            `;

            document.body.appendChild(warningDiv);
        }

        // Inicializar cuando la página carga
        document.addEventListener('DOMContentLoaded', async function() {
            // ✅ NUEVO v2.2.0: Verificar backend antes de cargar datos
            const backendActive = await checkBackendStatus();

            if (!backendActive) {
                console.warn('⚠️ [ADMIN] Backend no disponible - continuando con funcionalidad limitada');
            }

            // Configurar usuario por defecto
            currentUser = { username: 'admin', firstName: 'Admin', role: 'administrador' };
            console.log('👤 Usuario configurado:', currentUser);

            // Configurar interfaz
            setupUIForRole();

            // Cargar módulos desde API y luego cargar datos del dashboard (solo si backend está activo)
            if (backendActive) {
                loadModulesFromAPI().then(() => {
                    loadDashboardData();
                    generateModulesGrid();
                }).catch(error => {
                    console.error('❌ [ADMIN] Error cargando módulos con backend activo:', error);
                    // Fallback: mostrar módulos básicos sin backend
                    generateModulesGrid();
                });
            } else {
                // Sin backend: mostrar módulos básicos
                console.log('⚠️ [ADMIN] Generando grid básico sin backend');
                generateModulesGrid();
            }

            loadAllSystems();
            loadVendors(); // Cargar vendedores
        });

        async function loadAllSystems() {
            await loadPricingFromDatabase(); // Cargar precios actualizados y esperar
            loadBillingSystem();
            loadPaymentSystem();
            loadNotificationSystem();
            generatePricingControls(); // Ahora se ejecuta DESPUÉS de cargar los precios
        }

        function switchTab(tabName) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar pestaña seleccionada
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            currentTab = tabName;

            // Cargar contenido específico si es necesario
            if (tabName === 'taxTemplates') loadTaxTemplatesSystem();
            if (tabName === 'pricing') loadPricingSystem();
            if (tabName === 'billing') loadBillingSystem();
            if (tabName === 'payments') loadPaymentSystem();
            if (tabName === 'notifications') loadNotificationSystem();
            if (tabName === 'users') loadOperators();
        }

        async function loadDashboardData() {
            if (demoMode) {
                // Usar datos de demo para testing
                companies = data.companies || [];
                updateStats();
                renderCompaniesTable();
            } else {
                // Cargar datos reales de la API
                await loadCompaniesFromAPI();
            }
        }

        async function loadCompaniesFromAPI() {
            try {
                console.log('🔄 Cargando empresas desde:', `${API_BASE}/api/aponnt/dashboard/companies`);
                const response = await fetch(`${API_BASE}/api/aponnt/dashboard/companies`);

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Datos recibidos completos:', data);
                    console.log('🔍 data.companies:', data.companies);

                    // Los datos ya vienen procesados desde el backend, usar directamente
                    companies = data.companies || [];

                    console.log(`📊 Empresas transformadas: ${companies.length}`);
                    console.log('🏢 Empresas array transformado:', companies);

                    // Verificar antes de renderizar
                    console.log('📝 Sobre a llamar renderCompaniesTable con companies.length =', companies.length);
                    updateStats();
                    renderCompaniesTable();
                    console.log('✅ renderCompaniesTable completado');

                    // Cargar módulos reales para todas las empresas
                    await loadRealModulesForAllCompanies();
                    console.log('✅ Módulos reales cargados en la grilla');
                } else {
                    console.error('❌ Error HTTP:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('❌ Respuesta del servidor:', errorText);
                    // Fallback a datos demo si hay error
                    if (fallbackToDemo) {
                        companies = [];
                        updateStats();
                        renderCompaniesTable();
                        showNotification('⚠️ Error cargando empresas del servidor', 'warning');
                    } else {
                        showNotification('❌ Error de conexión con la base de datos', 'error');
                    }
                }
            } catch (error) {
                console.error('Error conectando con la API:', error.message, error);
                // Fallback a datos demo si hay error
                if (fallbackToDemo) {
                    companies = [];
                    updateStats();
                    renderCompaniesTable();
                    showNotification('⚠️ Error de conexión - sin datos disponibles', 'warning');
                } else {
                    showNotification('❌ Error de conexión con la base de datos', 'error');
                }
            }
        }

        function updateStats() {
            const activeCount = companies.filter(c => c.status === 'active').length;
            const trialCount = companies.filter(c => c.status === 'trial').length;
            const suspendedCount = companies.filter(c => c.status === 'suspended').length;

            const totalCompaniesElement = document.getElementById('totalCompanies');
            const activeCompaniesElement = document.getElementById('activeCompanies');
            const trialCompaniesElement = document.getElementById('trialCompanies');
            const suspendedCompaniesElement = document.getElementById('suspendedCompanies');

            if (totalCompaniesElement) totalCompaniesElement.textContent = companies.length;
            if (activeCompaniesElement) activeCompaniesElement.textContent = activeCount;
            if (trialCompaniesElement) trialCompaniesElement.textContent = trialCount;
            if (suspendedCompaniesElement) suspendedCompaniesElement.textContent = suspendedCount;
        }

        function renderCompaniesTable() {
            console.log('🎨 renderCompaniesTable iniciado');
            console.log('🏢 companies variable actual:', companies);
            console.log('📊 companies.length:', companies.length);

            const container = document.getElementById('companiesContainer');
            console.log('📦 container elemento:', container);

            if (companies.length === 0) {
                console.log('⚠️ companies.length === 0, mostrando mensaje vacío');
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #7f8c8d;">
                        <div style="font-size: 3em; margin-bottom: 1rem;">🏢</div>
                        <h3>No hay empresas registradas</h3>
                        <p>Comienza creando tu primera empresa</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="companies-table">
                    <thead>
                        <tr>
                            <th>Empresa</th>
                            <th>CUIT</th>
                            <th>Estado</th>
                            <th>Empleados</th>
                            <th>Plan</th>
                            <th>Módulos</th>
                            <th>Total Mensual</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            companies.forEach(company => {
                html += `
                    <tr>
                        <td>
                            <div><strong>${company.name}</strong></div>
                            <div style="font-size: 0.9em; color: #666;">${company.legalName}</div>
                            <div style="font-size: 0.8em; color: #999;">${company.contactEmail}</div>
                        </td>
                        <td>${company.taxId}</td>
                        <td>
                            <span class="status-badge status-${company.status}">
                                ${company.status === 'active' ? 'Activa' : company.status === 'trial' ? 'Prueba' : 'Suspendida'}
                            </span>
                        </td>
                        <td>
                            <div style="font-weight: bold; color: #2e7d32;">${company.currentEmployees || 0}</div>
                            <div style="font-size: 0.8em; color: #666;">usuarios activos</div>
                            <div style="font-weight: bold; color: #1976d2; margin-top: 4px;">${company.contractedEmployees || company.maxEmployees || 1}</div>
                            <div style="font-size: 0.8em; color: #666;">empleados contratados</div>
                        </td>
                        <td>
                            <div style="font-weight: bold; color: #1976d2;">
                                ${company.licenseType || 'Básico'} (${company.maxEmployees})
                            </div>
                            <div style="font-size: 0.8em; color: #666;">
                                Plan de hasta ${company.maxEmployees} empleados
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: bold; color: #2e7d32;">
                                ${company.modulesSummary ? `${company.modulesSummary.contractedModules}/${company.modulesSummary.totalSystemModules}` : 'N/A'}
                            </div>
                            <div style="font-size: 0.8em; color: #666;">
                                Módulos contratados
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: bold; color: var(--primary-color);">
                                U$S ${company.pricing.monthlyTotal.toFixed(2)}
                            </div>
                            <div style="font-size: 0.8em; color: #666;">
                                Total mensual con IVA
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-primary" onclick="editCompany(${company.company_id})" style="margin-right: 5px;">
                                ✏️ Editar
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
            // Ya no es necesario cargar módulos por separado - vienen del backend
        }

        // =============================
        // Función para cargar módulos reales desde la BD
        async function loadRealModulesForAllCompanies() {
            console.log("📦 Cargando módulos reales para todas las empresas...");
            if (!companies || companies.length === 0) {
                console.warn("⚠️ No hay empresas para cargar módulos");
                return;
            }

            // Cargar los datos reales de módulos para cada empresa
            for (const company of companies) {
                try {
                    const response = await fetch(`${API_BASE}/api/aponnt/dashboard/companies/${company.company_id}/modules`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            console.log(`📊 Datos de módulos para ${company.name}:`, data);

                            // Actualizar la empresa con los datos reales de módulos
                            company.modulesSummary = data.summary || {
                                contractedModules: 0,
                                totalSystemModules: 0,
                                activeModules: 0,
                                monthlyTotal: 0
                            };
                            company.pricing = company.pricing || {};

                            // Usar el total con impuestos si está disponible, sino calcular
                            const subtotal = data.summary?.monthlyTotal || 0;
                            const totalWithTax = data.summary?.monthlyTotalWithTax || (subtotal * (1 + pricingConfig.taxRate));

                            company.pricing.monthlyTotal = totalWithTax;

                            console.log(`💰 Empresa ${company.name}: Subtotal: $${subtotal}, Total con IVA: $${totalWithTax}`);
                        }
                    }
                } catch (error) {
                    console.error(`❌ Error cargando módulos empresa ${company.company_id}:`, error);
                    // Establecer valores por defecto en caso de error
                    company.modulesSummary = { contractedModules: 0, totalSystemModules: 0, activeModules: 0, monthlyTotal: 0 };
                    company.pricing = company.pricing || { monthlyTotal: 0 };
                }
            }

            console.log("✅ Todos los módulos cargados, re-renderizando tabla...");
            // Volver a renderizar la tabla con los datos actualizados
            renderCompaniesTable();
        }
        // SISTEMA DE FILTROS AVANZADOS
        // =============================

        let filteredCompanies = []; // Empresas filtradas
        let debounceTimer = null;

        // Mostrar/ocultar panel de filtros
        function toggleFilters() {
            const content = document.getElementById('filtersContent');
            const toggle = document.getElementById('filtersToggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'grid';
                toggle.textContent = 'Ocultar Filtros';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'Mostrar Filtros';
            }
        }

        // Aplicar filtros con debounce para texto
        function applyFiltersDebounced() {
            if (debounceTimer) clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                applyFilters();
            }, 300);
        }

        // Aplicar todos los filtros
        function applyFilters() {
            const filters = {
                name: document.getElementById('filterName').value.toLowerCase().trim(),
                cuit: document.getElementById('filterCuit').value.toLowerCase().trim(),
                country: document.getElementById('filterCountry').value,
                province: document.getElementById('filterProvince').value,
                city: document.getElementById('filterCity').value,
                vendor: document.getElementById('filterVendor').value.toLowerCase().trim()
            };

            // Filtrar empresas
            filteredCompanies = companies.filter(company => {
                // Filtro por nombre/razón social (aproximación)
                if (filters.name && !company.name.toLowerCase().includes(filters.name) && 
                    !company.legalName?.toLowerCase().includes(filters.name)) {
                    return false;
                }

                // Filtro por CUIT (aproximación)
                if (filters.cuit && !company.taxId?.toLowerCase().includes(filters.cuit)) {
                    return false;
                }

                // Filtro por país
                if (filters.country && company.country !== filters.country) {
                    return false;
                }

                // Filtro por provincia
                if (filters.province && company.province !== filters.province) {
                    return false;
                }

                // Filtro por ciudad
                if (filters.city && company.city !== filters.city) {
                    return false;
                }

                // Filtro por vendedor
                if (filters.vendor && !company.vendor?.toLowerCase().includes(filters.vendor)) {
                    return false;
                }

                return true;
            });

            // Renderizar tabla con empresas filtradas
            renderFilteredTable();
            updateResultsInfo();
        }

        // Renderizar tabla con empresas filtradas
        function renderFilteredTable() {
            const container = document.getElementById('companiesContainer');
            const companiesToShow = filteredCompanies.length > 0 || hasActiveFilters() ? filteredCompanies : companies;
            
            if (companiesToShow.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #7f8c8d;">
                        <div style="font-size: 3em; margin-bottom: 1rem;">🔍</div>
                        <h3>No se encontraron empresas</h3>
                        <p>Prueba ajustando los filtros de búsqueda</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="companies-table">
                    <thead>
                        <tr>
                            <th>Empresa</th>
                            <th>CUIT</th>
                            <th>Ubicación</th>
                            <th>Estado</th>
                            <th>Empleados</th>
                            <th>Plan</th>
                            <th>Módulos</th>
                            <th>Total Mensual</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            companiesToShow.forEach(company => {
                html += `
                    <tr>
                        <td>
                            <div><strong>${company.name}</strong></div>
                            <div style="font-size: 0.9em; color: #666;">${company.legalName || 'N/A'}</div>
                            <div style="font-size: 0.8em; color: #999;">${company.contactEmail || company.email || 'N/A'}</div>
                        </td>
                        <td><span style="font-family: monospace;">${company.taxId || 'N/A'}</span></td>
                        <td>
                            <div style="font-size: 0.9em;">
                                <div><strong>${company.city || 'N/A'}</strong></div>
                                <div style="color: #666;">${company.state || 'N/A'}</div>
                                <div style="color: #999; font-size: 0.8em;">${company.country || 'N/A'}</div>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-${company.status}">
                                ${company.status === 'active' ? 'Activa' : company.status === 'trial' ? 'Prueba' : 'Suspendida'}
                            </span>
                        </td>
                        <td>
                            <div style="font-weight: bold; color: #2e7d32;">${company.currentEmployees || 0}</div>
                            <div style="font-size: 0.8em; color: #666;">empleados activos</div>
                        </td>
                        <td>
                            <div style="font-weight: bold; color: #1976d2;">
                                ${company.licenseType || 'Básico'} (${company.maxEmployees || 50})
                            </div>
                            <div style="font-size: 0.8em; color: #666;">
                                Plan de hasta ${company.maxEmployees || 50} empleados
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: bold; color: #2e7d32;">
                                ${company.modulesSummary ? `${company.modulesSummary.contractedModules}/${company.modulesSummary.totalSystemModules}` : 'N/A'}
                            </div>
                            <div style="font-size: 0.8em; color: #666;">
                                Módulos contratados
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: bold; color: var(--primary-color);">
                                U$S ${company.pricing?.monthlyTotal?.toFixed(2) || '0.00'}
                            </div>
                            <div style="font-size: 0.8em; color: #666;">
                                Total mensual con IVA
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-primary" onclick="editCompany(${company.company_id})" style="margin-right: 5px;">
                                ✏️ Editar
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Verificar si hay filtros activos
        function hasActiveFilters() {
            const filters = {
                name: document.getElementById('filterName').value.trim(),
                cuit: document.getElementById('filterCuit').value.trim(),
                country: document.getElementById('filterCountry').value,
                province: document.getElementById('filterProvince').value,
                city: document.getElementById('filterCity').value
            };

            return Object.values(filters).some(value => value !== '');
        }

        // Actualizar información de resultados
        function updateResultsInfo() {
            const info = document.getElementById('resultsInfo');
            const hasFilters = hasActiveFilters();
            
            if (hasFilters) {
                const total = companies.length;
                const filtered = filteredCompanies.length;
                info.textContent = `Mostrando ${filtered} de ${total} empresas`;
                info.style.display = 'block';
            } else {
                info.style.display = 'none';
            }
        }

        // Limpiar todos los filtros
        function clearFilters() {
            const filterNameElement = document.getElementById('filterName');
            const filterCuitElement = document.getElementById('filterCuit');
            const filterCountryElement = document.getElementById('filterCountry');
            const filterProvinceElement = document.getElementById('filterProvince');
            const filterCityElement = document.getElementById('filterCity');
            const filterVendorElement = document.getElementById('filterVendor');

            if (filterNameElement) filterNameElement.value = '';
            if (filterCuitElement) filterCuitElement.value = '';
            if (filterCountryElement) filterCountryElement.value = '';
            if (filterProvinceElement) filterProvinceElement.value = '';
            if (filterCityElement) filterCityElement.value = '';
            if (filterVendorElement) filterVendorElement.value = '';
            
            // Limpiar dropdowns dependientes
            if (filterProvinceElement) {
                filterProvinceElement.innerHTML = '<option value="">Todas las provincias</option>';
            }
            if (filterCityElement) {
                filterCityElement.innerHTML = '<option value="">Todas las ciudades</option>';
            }
            
            // Resetear empresas filtradas
            filteredCompanies = [];
            
            // Renderizar tabla completa
            renderCompaniesTable();
            updateResultsInfo();
        }

        // Cargar provincias para filtro
        function loadFilterProvinces() {
            const countrySelect = document.getElementById('filterCountry');
            const provinceSelect = document.getElementById('filterProvince');
            const citySelect = document.getElementById('filterCity');
            
            const selectedCountry = countrySelect.value;
            
            // Limpiar selects dependientes
            provinceSelect.innerHTML = '<option value="">Todas las provincias</option>';
            citySelect.innerHTML = '<option value="">Todas las ciudades</option>';
            
            if (selectedCountry && geographicalData[selectedCountry]) {
                Object.keys(geographicalData[selectedCountry]).forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    provinceSelect.appendChild(option);
                });
            }
        }

        // Cargar ciudades para filtro
        function loadFilterCities() {
            const countrySelect = document.getElementById('filterCountry');
            const provinceSelect = document.getElementById('filterProvince');
            const citySelect = document.getElementById('filterCity');
            
            const selectedCountry = countrySelect.value;
            const selectedProvince = provinceSelect.value;
            
            // Limpiar select de ciudades
            citySelect.innerHTML = '<option value="">Todas las ciudades</option>';
            
            if (selectedCountry && selectedProvince && 
                geographicalData[selectedCountry] && 
                geographicalData[selectedCountry][selectedProvince]) {
                
                Object.keys(geographicalData[selectedCountry][selectedProvince]).forEach(cityName => {
                    const option = document.createElement('option');
                    option.value = cityName;
                    option.textContent = cityName;
                    citySelect.appendChild(option);
                });
            }
        }

        // Modificar renderCompaniesTable original para usar el nuevo sistema
        const originalRenderCompaniesTable = renderCompaniesTable;
        renderCompaniesTable = function() {
            if (hasActiveFilters()) {
                applyFilters();
            } else {
                originalRenderCompaniesTable();
                updateResultsInfo();
            }
        };

        function openNewCompanyModal() {
            console.log("openNewCompanyModal ejecutado");
            document.getElementById('modalTitle').textContent = 'Nueva Empresa';
            document.getElementById('saveBtnText').textContent = '💾 Crear Empresa';
            document.getElementById('companyForm').reset();
            document.getElementById('maxEmployees').value = '1';
            selectedModules.clear();
            currentEditingCompany = null;
            
            // Resetear filtro a "todos" para nueva empresa
            currentModuleFilter = 'all';
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filterAll').classList.add('active');
            
            // Ocultar secciones específicas de edición
            document.getElementById('priceUpdateSection').style.display = 'none';
            document.getElementById('moduleModificationSection').style.display = 'none';
            
            // Inicializar campos geográficos
            loadProvinces();

            // Limpiar coordenadas para nueva empresa
            document.getElementById('companyLatitude').value = '';
            document.getElementById('companyLongitude').value = '';

            // Cargar vendedores en el selector
            loadVendorsSelector();

            generateModulesGrid();
            updatePricingSummary();
            document.getElementById('companyModal').classList.add('show');
        }

        function editCompany(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (!company) return;

            console.log(`📝 EDITANDO EMPRESA ${companyId}:`, company);
            console.log('📝 Datos disponibles en company object:', Object.keys(company));

            const modalTitle = document.getElementById('modalTitle');
            const saveBtnText = document.getElementById('saveBtnText');

            if (modalTitle) modalTitle.textContent = 'Editar Empresa';
            if (saveBtnText) saveBtnText.textContent = '✏️ Actualizar Empresa';
            document.getElementById('companyName').value = company.name || '';

            // Manejar tanto camelCase como snake_case para compatibilidad
            document.getElementById('legalName').value = company.legalName || company.legal_name || '';
            document.getElementById('taxId').value = company.taxId || company.tax_id || '';
            document.getElementById('contactEmail').value = company.contactEmail || company.contact_email || company.email || '';
            document.getElementById('contactPhone').value = company.contactPhone || company.contact_phone || company.phone || '';
            document.getElementById('address').value = company.address || '';
            document.getElementById('country').value = company.country || 'Argentina';
            
            // Cargar provincias y luego seleccionar la provincia de la empresa
            loadProvinces();
            setTimeout(() => {
                document.getElementById('province').value = company.province || '';
                if (company.province) {
                    loadCities();
                    setTimeout(() => {
                        document.getElementById('city').value = company.city || '';
                        document.getElementById('postalCode').value = company.postalCode || company.postal_code || '';
                    }, 100);
                }
            }, 100);

            // Manejar tanto camelCase como snake_case para todos los campos
            document.getElementById('licenseType').value = company.licenseType || company.license_type || 'basic';
            document.getElementById('contractedEmployees').value = company.contractedEmployees || company.contracted_employees || company.maxEmployees || company.max_employees || 1;
            document.getElementById('maxEmployees').value = company.maxEmployees || company.max_employees || 50;
            document.getElementById('vendor').value = company.vendor || '';
            document.getElementById('commissionPercentage').value = company.commissionPercentage || company.commission_percentage || '10';
            document.getElementById('cbu').value = company.cbu || '';
            document.getElementById('companyStatus').value = company.status || 'cotizado';

            // Cargar coordenadas solo si existen en la empresa
            const latElement = document.getElementById('companyLatitude');
            const lngElement = document.getElementById('companyLongitude');

            if (latElement) latElement.value = company.latitude || '';
            if (lngElement) lngElement.value = company.longitude || '';

            // Verificar si hay coordenadas disponibles y mostrar mensaje
            if (company.latitude && company.longitude) {
                console.log(`📍 Coordenadas cargadas para empresa: ${company.latitude}, ${company.longitude}`);
            } else {
                console.log('📍 No hay coordenadas disponibles para esta empresa');
            }

            currentEditingCompany = company;

            // 🔥 CARGAR MÓDULOS DESDE COMPANY_MODULES (DATOS REALES)
            console.log(`📦 Cargando módulos reales para empresa ${companyId} desde company_modules...`);

            // Inicializar con fallback
            selectedModules = new Set(company.modules || []);

            // Cargar módulos reales desde company_modules
            fetch(`/api/aponnt/dashboard/companies/${companyId}/modules`)
                .then(response => response.json())
                .then(moduleData => {
                    if (moduleData.success) {
                        console.log(`✅ Módulos cargados desde company_modules:`, moduleData);

                        // Actualizar selectedModules con módulos ACTIVOS desde la base de datos
                        const activeModuleKeys = moduleData.modules.active.map(m => m.moduleKey);
                        selectedModules = new Set(activeModuleKeys);

                        console.log(`✅ Módulos activos cargados en selectedModules:`, Array.from(selectedModules));

                        // Guardar información de precios contratados en la empresa
                        company.contractedModulesFromDB = moduleData.modules.all;
                        company.activeModulesFromDB = moduleData.modules.active;
                        company.inactiveModulesFromDB = moduleData.modules.inactive;
                        company.modulesSummaryFromDB = moduleData.summary;

                        console.log(`📊 Empresa ${companyId}: ${activeModuleKeys.length} módulos activos en company_modules`);
                        console.log(`💰 Total mensual desde DB: $${moduleData.summary.monthlyTotal}`);

                        // Actualizar sección de modificación con datos reales
                        const moduleModificationSection = document.getElementById('moduleModificationSection');
                        if (moduleModificationSection && moduleData.summary.totalModules > 0) {
                            moduleModificationSection.style.display = 'block';
                            moduleModificationSection.innerHTML = `
                                <h4>⚠️ Modificación de Módulos Contratados</h4>
                                <p><strong>Esta empresa tiene ${moduleData.summary.totalModules} módulos contratados:</strong></p>
                                <p>• ${moduleData.summary.activeModules} módulos ACTIVOS</p>
                                <p>• ${moduleData.summary.inactiveModules} módulos INACTIVOS</p>
                                <p>• Total mensual: <strong>$${moduleData.summary.monthlyTotal.toFixed(2)}</strong></p>
                                <p>Los módulos contratados aparecen marcados. Para modificarlos, active la casilla:</p>
                                <label>
                                    <input type="checkbox" id="allowModificationCheckbox" onchange="toggleModuleModification()">
                                    Permitir modificación de módulos contratados
                                </label>
                            `;
                        } else if (moduleModificationSection) {
                            moduleModificationSection.style.display = 'none';
                        }

                        // Regenerar grid con datos actualizados
                        generateModulesGrid();
                        updatePricingSummaryWithRealData(moduleData);

                        // Forzar actualización visual para asegurar estados correctos
                        setTimeout(() => {
                            console.log('🔄 Forzando actualización visual de módulos...');
                            generateModulesGrid();
                            updatePricingSummary();
                            // Actualizar también el detalle con precios históricos
                            updatePricingSummaryForCurrentSelection();
                            // Asegurar que los checkboxes estén sincronizados
                            setTimeout(() => {
                                syncModuleCheckboxes();
                            }, 50);
                        }, 200);

                    } else {
                        console.warn('⚠️ Error cargando módulos desde company_modules:', moduleData.error);
                        // Mantener fallback: usar módulos del objeto company
                        const moduleModificationSection = document.getElementById('moduleModificationSection');
                        if (moduleModificationSection) {
                            if (company.modules && company.modules.length > 0) {
                                moduleModificationSection.style.display = 'block';
                            } else {
                                moduleModificationSection.style.display = 'none';
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('❌ Error cargando módulos desde company_modules:', error);
                    // Mantener fallback: usar módulos del objeto company
                    const moduleModificationSection = document.getElementById('moduleModificationSection');
                    if (company.modules && company.modules.length > 0) {
                        moduleModificationSection.style.display = 'block';
                    } else {
                        moduleModificationSection.style.display = 'none';
                    }
                });

            // Resetear filtro al editar empresa
            currentModuleFilter = 'all';
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filterAll').classList.add('active');
            
            // Verificar si hay cambios en los precios desde la contratación
            checkForPriceChanges(company);
            
            // Mostrar modal primero
            document.getElementById('companyModal').classList.add('show');

            // Cargar sucursales de la empresa después de mostrar el modal
            setTimeout(() => {
                loadCompanyBranches(company.company_id);
            }, 500);
            
            // Cargar usuarios de la empresa automáticamente
            loadCompanyUsers();

            // Cargar vendedores en el selector
            loadVendorsSelector();

            generateModulesGrid();
            updatePricingSummary();
            // Cuando se edita, usar precios históricos específicos de la empresa
            updatePricingSummaryForCurrentSelection();
        }

        function closeCompanyModal() {
            console.log('🚪 Cerrando modal...');
            document.getElementById('companyModal').classList.remove('show');

            // Limpiar estado
            currentEditingCompany = null;
            selectedModules.clear();

            // Reset form
            document.getElementById('companyForm').reset();

            // Limpiar grids
            const modulesGrid = document.getElementById('modulesGrid');
            if (modulesGrid) modulesGrid.innerHTML = '';

            const pricingSidebar = document.querySelector('.pricing-sidebar');
            if (pricingSidebar) pricingSidebar.innerHTML = '<h3>💰 Cotización</h3>';

            console.log('✅ Modal cerrado y estado limpiado');
        }

        let currentModuleFilter = 'all';
        
        function generateModulesGrid() {
            const employeeCount = parseInt(document.getElementById('contractedEmployees').value) || 1;
            const tier = getCurrentTier(employeeCount);
            const grid = document.getElementById('modulesGrid');
            
            let html = '';
            // Usar módulos reales desde company_modules si están disponibles
            const contractedModules = currentEditingCompany && currentEditingCompany.activeModulesFromDB
                ? new Set(currentEditingCompany.activeModulesFromDB.map(m => m.moduleKey))
                : (currentEditingCompany ? new Set(currentEditingCompany.modules) : new Set());
            
            console.log('📦 Módulos contratados desde BD:', Array.from(contractedModules));
            console.log('📋 Módulos seleccionados actuales:', Array.from(selectedModules));

            Object.entries(pricingConfig.modules).forEach(([moduleId, module]) => {
                const price = calculateModulePrice(module.basePrice, tier);
                const isSelected = selectedModules.has(moduleId);
                const wasContracted = contractedModules.has(moduleId);
                const isNewSelection = isSelected && !wasContracted;
                const isRemoving = !isSelected && wasContracted;

                if (isSelected) {
                    console.log(`🔍 Módulo ${moduleId}: selected=${isSelected}, wasContracted=${wasContracted}, isNew=${isNewSelection}`);
                }
                
                // Aplicar filtro
                let shouldShow = true;
                if (currentModuleFilter === 'contracted' && !wasContracted) shouldShow = false;
                if (currentModuleFilter === 'available' && wasContracted) shouldShow = false;
                
                if (!shouldShow) return;
                
                let cardClass = 'module-card';
                let statusIndicator = '';
                let clickHandler = `toggleModule('${moduleId}')`;
                
                if (wasContracted && isSelected) {
                    cardClass += ' contracted selected';
                    statusIndicator = '<span class="status-badge contracted">✓ Contratado</span>';
                } else if (wasContracted && !isSelected) {
                    cardClass += ' contracted removing';
                    statusIndicator = '<span class="status-badge removing">⚠ Se eliminará</span>';
                } else if (isNewSelection) {
                    cardClass += ' selected new';
                    statusIndicator = '<span class="status-badge new">+ Nuevo</span>';
                } else if (isSelected) {
                    cardClass += ' selected';
                } else {
                    cardClass += ' available';
                    statusIndicator = '<span class="status-badge available">Disponible</span>';
                }
                
                // Los módulos contratados siempre permiten interacción
                // Solo agregar clase visual para identificarlos como contratados
                if (wasContracted) {
                    cardClass += ' contracted-module';
                }
                
                html += `
                    <div class="${cardClass}" ${clickHandler ? `onclick="${clickHandler}"` : ''} data-module="${moduleId}">
                        <div class="module-header">
                            <div class="module-info">
                                <span class="module-icon">${module.icon}</span>
                                <span class="module-name">${module.name}</span>
                            </div>
                            <div class="module-price">U$S ${price.toFixed(2)}</div>
                        </div>
                        <div class="module-description">${module.description}</div>
                        <div class="module-details">Precio por empleado/mes</div>
                        <div class="module-status">${statusIndicator}</div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div class="no-modules">No hay módulos para mostrar con el filtro actual</div>';
            }
            
            grid.innerHTML = html;
            
            // Actualizar información del tier
            const currentTierElement = document.getElementById('currentTier');
            const currentDiscountElement = document.getElementById('currentDiscount');

            if (currentTierElement) {
                currentTierElement.textContent = tier.name;
            }
            if (currentDiscountElement) {
                currentDiscountElement.textContent = tier.discount;
            }
            
            // Actualizar contadores de filtros
            updateFilterCounters();
        }
        
        function filterModules(filter) {
            currentModuleFilter = filter;
            
            // Actualizar botones activos
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`).classList.add('active');
            
            generateModulesGrid();
        }
        
        function updateFilterCounters() {
            if (!currentEditingCompany) return;
            
            const contractedCount = currentEditingCompany.activeModulesFromDB
                ? currentEditingCompany.activeModulesFromDB.length
                : (currentEditingCompany.modules ? currentEditingCompany.modules.length : 0);
            const totalCount = Object.keys(pricingConfig.modules).length;
            const availableCount = totalCount - contractedCount;
            
            const filterAllElement = document.getElementById('filterAll');
            const filterContractedElement = document.getElementById('filterContracted');
            const filterAvailableElement = document.getElementById('filterAvailable');

            if (filterAllElement) filterAllElement.textContent = `Todos (${totalCount})`;
            if (filterContractedElement) filterContractedElement.textContent = `Contratados (${contractedCount})`;
            if (filterAvailableElement) filterAvailableElement.textContent = `Disponibles (${availableCount})`;
        }

        function toggleModule(moduleId) {
            console.log('🔄 toggleModule ejecutado para:', moduleId);

            // Permitir modificar todos los módulos - los contratados se identifican visualmente

            if (selectedModules.has(moduleId)) {
                selectedModules.delete(moduleId);
                console.log('➖ Módulo deseleccionado:', moduleId);
            } else {
                selectedModules.add(moduleId);
                console.log('➕ Módulo seleccionado:', moduleId);
            }

            console.log('📊 Módulos seleccionados actuales:', Array.from(selectedModules));

            generateModulesGrid();
            updatePricingSummary();

            // Actualizar resumen con módulos seleccionados actuales
            updatePricingSummaryForCurrentSelection();

            console.log('✅ toggleModule completado');
        }

        // Sincronizar checkboxes de módulos con los datos reales cargados desde la BD
        function syncModuleCheckboxes() {
            console.log('🔄 Sincronizando checkboxes de módulos...');

            // Obtener los módulos contratados reales desde company_modules
            const contractedModules = currentEditingCompany && currentEditingCompany.activeModulesFromDB
                ? new Set(currentEditingCompany.activeModulesFromDB.map(m => m.moduleKey))
                : new Set();

            // Sincronizar cada módulo
            Object.keys(pricingConfig.modules).forEach(moduleId => {
                const checkbox = document.querySelector(`input[onclick*="${moduleId}"]`);
                const moduleCard = document.querySelector(`.module-card[onclick*="${moduleId}"]`);

                if (checkbox) {
                    const isSelected = selectedModules.has(moduleId);
                    const wasContracted = contractedModules.has(moduleId);

                    // Marcar checkbox según selectedModules
                    checkbox.checked = isSelected;

                    // Actualizar clases visuales del card
                    if (moduleCard) {
                        moduleCard.classList.remove('selected', 'contracted', 'new', 'available', 'removing');

                        if (wasContracted && isSelected) {
                            moduleCard.classList.add('contracted', 'selected');
                        } else if (wasContracted && !isSelected) {
                            moduleCard.classList.add('contracted', 'removing');
                        } else if (isSelected && !wasContracted) {
                            moduleCard.classList.add('selected', 'new');
                        } else if (isSelected) {
                            moduleCard.classList.add('selected');
                        } else {
                            moduleCard.classList.add('available');
                        }
                    }

                    console.log(`✅ Sincronizado ${moduleId}: checkbox=${checkbox.checked}, selected=${isSelected}, contracted=${wasContracted}`);
                }
            });

            console.log('✅ Sincronización de checkboxes completada');
        }

        function updateModulePricing() {
            generateModulesGrid();
            updatePricingSummary();

            // Actualizar resumen con módulos seleccionados actuales
            updatePricingSummaryForCurrentSelection();
        }

        function getCurrentTier(employeeCount) {
            return pricingConfig.employeeTiers.find(tier => 
                employeeCount >= tier.min && employeeCount <= tier.max
            ) || pricingConfig.employeeTiers[0];
        }

        function calculateModulePrice(basePrice, tier) {
            return basePrice * tier.multiplier;
        }

        function updatePricingSummary() {
            console.log('🧮 updatePricingSummary ejecutándose...');
            const employeeCount = parseInt(document.getElementById('contractedEmployees').value) || 1;
            const tier = getCurrentTier(employeeCount);
            console.log('👥 Empleados:', employeeCount, 'Tier:', tier);

            let subtotal = 0;
            let selectedModulesList = '';

            selectedModules.forEach(moduleId => {
                let price, module;

                // Si estamos editando una empresa y tiene precios históricos, usarlos
                if (currentEditingCompany && currentEditingCompany.modulesPricing && currentEditingCompany.modulesPricing[moduleId]) {
                    const historicalModule = currentEditingCompany.modulesPricing[moduleId];
                    price = historicalModule.tierPrice || historicalModule.basePrice;
                    module = {
                        name: historicalModule.name,
                        icon: historicalModule.icon
                    };
                    console.log(`💰 Usando precio histórico para ${moduleId}: $${price}`);
                } else {
                    // Usar precios actuales del sistema
                    module = pricingConfig.modules[moduleId];
                    price = calculateModulePrice(module.basePrice, tier);
                    console.log(`💰 Usando precio actual para ${moduleId}: $${price}`);
                }

                const totalPrice = price * employeeCount;
                subtotal += totalPrice;

                selectedModulesList += `
                    <div class="selected-module">
                        <span>${module.icon} ${module.name}</span>
                        <span>$ ${totalPrice.toFixed(2)}</span>
                    </div>
                `;
            });
            
            const tax = subtotal * pricingConfig.taxRate;
            const total = subtotal + tax;

            console.log('💰 Valores calculados - Subtotal:', subtotal, 'Tax:', tax, 'Total:', total);

            const subtotalElement = document.getElementById('subtotal');
            const taxElement = document.getElementById('tax');
            const totalElement = document.getElementById('total');
            const moduleCountElement = document.getElementById('moduleCount');
            const selectedModulesListElement = document.getElementById('selectedModulesList');

            if (subtotalElement) subtotalElement.textContent = subtotal.toFixed(2);
            if (taxElement) taxElement.textContent = tax.toFixed(2);
            if (totalElement) totalElement.textContent = total.toFixed(2);
            if (moduleCountElement) moduleCountElement.textContent = selectedModules.size;
            if (selectedModulesListElement) selectedModulesListElement.innerHTML = selectedModulesList;
            
            // Habilitar botón guardar siempre
            const saveBtn = document.getElementById('saveCompanyBtn');
            if (saveBtn) {
                saveBtn.disabled = false;
            }
        }

        async function saveCompany() {
            console.log("saveCompany ejecutado");
            const employeeCount = parseInt(document.getElementById('contractedEmployees').value) || 1;
            const tier = getCurrentTier(employeeCount);
            
            // Permitir guardar sin módulos (solo cambios básicos de empresa)
            
            
            // 🌍 VALIDACIÓN OBLIGATORIA DE GEOLOCALIZACIÓN PARA APK ANDROID
            console.log('🌍 Validando geolocalización obligatoria...');

            const address = document.getElementById('address').value?.trim();
            const city = document.getElementById('city').value?.trim();
            const province = document.getElementById('province').value?.trim();
            const latitude = document.getElementById('companyLatitude').value?.trim();
            const longitude = document.getElementById('companyLongitude').value?.trim();

            // Validar campos de dirección obligatorios
            const missingAddressFields = [];
            if (!address) missingAddressFields.push('Dirección');
            if (!city) missingAddressFields.push('Ciudad');
            if (!province) missingAddressFields.push('Provincia');

            if (missingAddressFields.length > 0) {
                const message = `❌ CAMPOS OBLIGATORIOS FALTANTES:\n\n${missingAddressFields.join(', ')}\n\nEstos campos son necesarios para la geolocalización de la APK Android.`;
                alert(message);

                // Enfocar el primer campo faltante
                const firstMissing = missingAddressFields[0];
                if (firstMissing === 'Dirección') document.getElementById('address').focus();
                else if (firstMissing === 'Ciudad') document.getElementById('city').focus();
                else if (firstMissing === 'Provincia') document.getElementById('province').focus();

                return;
            }

            // Validar que se haya obtenido geolocalización
            if (!latitude || !longitude || latitude === '' || longitude === '') {
                const confirmMessage = `⚠️ GEOLOCALIZACIÓN REQUERIDA\n\nNo se han obtenido las coordenadas GPS para esta empresa.\n\nEsto es OBLIGATORIO para que funcione el fichado en la APK Android.\n\n¿Desea obtener las coordenadas automáticamente ahora?`;

                if (confirm(confirmMessage)) {
                    console.log('🌍 Usuario eligió obtener coordenadas...');
                    await geocodeCompanyAddress();

                    // Verificar si se obtuvieron después del intento
                    setTimeout(() => {
                        const newLat = document.getElementById('companyLatitude').value?.trim();
                        const newLng = document.getElementById('companyLongitude').value?.trim();

                        if (!newLat || !newLng) {
                            alert('❌ NO SE PUDIERON OBTENER COORDENADAS\n\nVerifique que la dirección sea correcta y completa.\nEjemplo: "Av. Corrientes 1000, Buenos Aires, CABA"');
                            return;
                        } else {
                            console.log('✅ Coordenadas obtenidas, continuando guardado...');
                            // Continuar con el guardado automáticamente
                            setTimeout(() => saveCompany(), 1000);
                        }
                    }, 3000);
                    return; // Detener ejecución hasta obtener coordenadas
                } else {
                    alert('❌ GUARDADO CANCELADO\n\nDebe obtener las coordenadas GPS para continuar.');
                    return;
                }
            }

            console.log('✅ Validación de geolocalización pasada');

        const companyName = document.getElementById('companyName').value;
            const legalName = document.getElementById('legalName').value || companyName;
            const taxId = document.getElementById('taxId').value;
            const contactEmail = document.getElementById('contactEmail').value;
            
            if (!companyName || !taxId || !contactEmail) {
                alert('Por favor complete todos los campos obligatorios.');
                return;
            }
            
            // Calcular precios (con validación)
            const subtotalElement = document.getElementById('subtotal');
            const taxElement = document.getElementById('tax');
            const totalElement = document.getElementById('total');

            const subtotal = subtotalElement ? parseFloat(subtotalElement.textContent) || 0 : 0;
            const tax = taxElement ? parseFloat(taxElement.textContent) || 0 : 0;
            let total = totalElement ? parseFloat(totalElement.textContent) || 0 : 0;
            
            // Crear estructura de módulos con precios históricos específicos
            const modulesPricing = {};
            selectedModules.forEach(moduleId => {
                const module = pricingConfig.modules[moduleId];
                const price = calculateModulePrice(module.basePrice, tier);
                modulesPricing[moduleId] = {
                    name: module.name,
                    icon: module.icon,
                    basePrice: module.basePrice,
                    tierPrice: price,
                    totalPrice: price * employeeCount,
                    contractedAt: new Date().toISOString()
                };
            });

            const companyData = {
                name: companyName,
                legalName: legalName,
                taxId: taxId,
                contactEmail: contactEmail,
                contactPhone: document.getElementById('contactPhone').value || '',
                address: document.getElementById('address').value || '',
                country: document.getElementById('country').value || 'Argentina',
                province: document.getElementById('province').value || '',
                city: document.getElementById('city').value || '',
                postalCode: document.getElementById('postalCode').value || '',
                latitude: parseFloat(document.getElementById('companyLatitude').value) || null,
                longitude: parseFloat(document.getElementById('companyLongitude').value) || null,
                licenseType: document.getElementById('licenseType').value,
                status: document.getElementById('companyStatus').value,
                vendor: document.getElementById('vendor').value || '',
                commissionPercentage: parseFloat(document.getElementById('commissionPercentage').value) || 10,
                cbu: document.getElementById('cbu').value || '',
                contractedEmployees: employeeCount,
                maxEmployees: parseInt(document.getElementById('maxEmployees').value) || 50,
                modules: Array.from(selectedModules),
                modulesPricing: modulesPricing, // Precios históricos específicos
                pricing: {
                    tier: tier.name,
                    monthlySubtotal: subtotal,
                    monthlyTax: tax,
                    monthlyTotal: total,
                    lastUpdated: new Date().toISOString()
                }
            };

            console.log('💾 DATOS A GUARDAR:', companyData);
            
            if (currentEditingCompany) {
                // Verificar si se debe actualizar precios
                let updatePrices = document.getElementById('updatePricesCheckbox')?.checked || false;
                
                if (updatePrices) {
                    // Actualizar con precios actuales (se regenera modulesPricing)
                    Object.assign(currentEditingCompany, companyData);
                } else {
                    // Mantener precios históricos, solo actualizar otros datos
                    const { modulesPricing, pricing, ...otherData } = companyData;
                    Object.assign(currentEditingCompany, otherData);
                    
                    // Recalcular solo si cambiaron empleados, manteniendo precios históricos
                    if (currentEditingCompany.maxEmployees !== employeeCount) {
                        let newSubtotal = 0;

                        // Validar que modulesPricing existe antes de usarlo
                        if (currentEditingCompany.modulesPricing) {
                            Object.values(currentEditingCompany.modulesPricing).forEach(module => {
                            const newTotalPrice = module.tierPrice * employeeCount;
                            module.totalPrice = newTotalPrice;
                            newSubtotal += newTotalPrice;
                            });
                        } else {
                            // Si no hay modulesPricing, usar precios actuales del sistema
                            console.warn('No hay modulesPricing histórico, usando precios actuales');
                            updatePrices = true; // Forzar actualización con precios actuales
                        }

                        const newTax = newSubtotal * pricingConfig.taxRate;
                        const newTotal = newSubtotal + newTax;
                        
                        currentEditingCompany.pricing = {
                            ...currentEditingCompany.pricing,
                            monthlySubtotal: newSubtotal,
                            monthlyTax: newTax,
                            monthlyTotal: newTotal,
                            lastUpdated: new Date().toISOString()
                        };
                        
                        // Usar el nuevo total para facturas
                        total = newTotal;
                    } else {
                        // Mantener el total actual
                        total = currentEditingCompany.pricing.monthlyTotal;
                    }
                }
                
                // Actualizar facturas existentes con el nuevo precio
                invoices.forEach(invoice => {
                    if (invoice.companyId === currentEditingCompany.id) {
                        invoice.amount = total;
                        invoice.companyName = companyName;
                    }
                });
                
                // Actualizar métodos de pago
                const paymentMethod = paymentMethods.find(m => m.companyId === currentEditingCompany.id);
                if (paymentMethod) {
                    paymentMethod.companyName = companyName;
                }
                
                const priceUpdateMsg = updatePrices ? 
                    '\n\n⚡ Los precios se han actualizado a los valores actuales del sistema.' :
                    '\n\n📋 Se mantuvieron los precios históricos de contratación.';
                
                // Guardar cambios en la base de datos
                if (!demoMode) {
                    try {
                        console.log("Enviando PUT a API para empresa:", currentEditingCompany.id, companyData);
                        const response = await fetch(`${API_BASE}/api/aponnt/dashboard/companies/${currentEditingCompany.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                            },
                            body: JSON.stringify({
                                ...companyData,
                                selectedModules: Array.from(selectedModules),
                                employeeCount: employeeCount
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            showNotification(`✅ Empresa "${companyName}" actualizada exitosamente en la base de datos`, 'success');
                            console.log("Empresa actualizada:", result);
                            closeCompanyModal();
                            // Actualizar solo la grilla sin recargar toda la página
                            loadCompaniesFromAPI();
                        } else {
                            const error = await response.json();
                            showNotification(`❌ Error actualizando empresa: ${error.error}`, 'error');
                            return;
                        }
                    } catch (error) {
                        console.error('Error actualizando empresa:', error);
                        showNotification('❌ Error de conexión al actualizar la empresa', 'error');
                        return;
                    }
                } else {
                    // Solo en modo demo mostrar alert
                    alert(`✅ Empresa "${companyName}" actualizada exitosamente!\n\n📊 Resumen:\n• Empleados: ${employeeCount}\n• Tier: ${tier.name}\n• Módulos: ${selectedModules.size}\n• Total mensual: U$S ${total.toFixed(2)} (con IVA incluido)${priceUpdateMsg}`);
                }
                
            } else {
                // Crear nueva empresa
                if (demoMode) {
                    // Modo demo - crear localmente
                    const newCompany = {
                        id: Date.now(),
                        status: 'active',
                        currentEmployees: 0,
                        createdAt: new Date().toISOString().split('T')[0],
                        ...companyData
                    };
                    
                    companies.push(newCompany);
                } else {
                    // Modo real - guardar en API
                        console.log("Enviando POST a API:", companyData);
                    try {
                        const response = await fetch(`${API_BASE}/api/aponnt/dashboard/companies`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                            },
                            body: JSON.stringify(companyData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            showNotification('✅ Empresa creada exitosamente en la base de datos', 'success');
                            closeCompanyModal();
                            // Actualizar solo la grilla sin recargar toda la página
                            loadCompaniesFromAPI();
                        } else {
                            const error = await response.json();
                            showNotification(`❌ Error creando empresa: ${error.error}`, 'error');
                            return;
                        }
                    } catch (error) {
                        console.error('Error guardando empresa:', error);
                        showNotification('❌ Error de conexión al guardar la empresa', 'error');
                        return;
                    }
                }
                
                if (demoMode) {
                    alert(`✅ Empresa "${companyName}" creada exitosamente!\n\n📊 Resumen:\n• Empleados: ${employeeCount}\n• Tier: ${tier.name}\n• Módulos: ${selectedModules.size}\n• Total mensual: U$S ${total.toFixed(2)} (con IVA incluido)`);
                }
            }
            
            updateStats();
            renderCompaniesTable();
            
            // Recargar todos los sistemas si están en otras pestañas
            if (currentTab === 'billing') renderBillingSystem();
            if (currentTab === 'payments') renderPaymentSystem();
            
            closeCompanyModal();
        }

        // Sistema de Facturación
        function loadBillingSystem() {
            // Generar facturas de ejemplo
            invoices = companies.map(company => {
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + Math.floor(Math.random() * 60) - 30);
                const isOverdue = dueDate < new Date();
                
                return {
                    id: `INV-${company.company_id}-${new Date().getMonth() + 1}`,
                    companyId: company.company_id,
                    companyName: company.name,
                    amount: company.pricing.monthlyTotal,
                    dueDate: dueDate.toISOString().split('T')[0],
                    status: isOverdue ? 'overdue' : Math.random() > 0.3 ? 'pending' : 'paid',
                    createdAt: new Date().toISOString().split('T')[0],
                    qrCode: `QR-${company.company_id}-${Date.now()}`
                };
            });

            renderBillingSystem();
        }

        function renderBillingSystem() {
            const container = document.getElementById('billingContainer');
            const pendingInvoices = invoices.filter(inv => inv.status === 'pending');
            const overdueInvoices = invoices.filter(inv => inv.status === 'overdue');
            const totalRevenue = invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + inv.amount, 0);

            container.innerHTML = `
                <div class="billing-card">
                    <div class="billing-header">
                        <h3>📊 Resumen de Facturación</h3>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; color: var(--success-color);">Ingresos: U$S ${totalRevenue.toFixed(2)}</div>
                            <div style="font-size: 0.9rem; color: #666;">Pendientes: ${pendingInvoices.length} | Vencidas: ${overdueInvoices.length}</div>
                        </div>
                    </div>
                    <div class="invoice-grid">
                        ${invoices.map(invoice => `
                            <div class="invoice-card ${invoice.status}">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <strong>${invoice.id}</strong>
                                    <span class="status-badge status-${invoice.status === 'paid' ? 'active' : invoice.status === 'overdue' ? 'suspended' : 'trial'}">
                                        ${invoice.status === 'paid' ? 'Pagada' : invoice.status === 'overdue' ? 'Vencida' : 'Pendiente'}
                                    </span>
                                </div>
                                <div style="margin-bottom: 0.5rem;">
                                    <strong>${invoice.companyName}</strong><br>
                                    <span style="color: #666;">Vence: ${invoice.dueDate}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 1.1rem; font-weight: bold; color: var(--primary-color);">U$S ${invoice.amount.toFixed(2)}</span>
                                    ${invoice.status === 'pending' ? `<button class="btn btn-primary" onclick="showQRPayment('${invoice.id}')">💳 Pagar</button>` : ''}
                                    ${invoice.status === 'overdue' ? `<button class="btn btn-danger" onclick="suspendCompany(${invoice.companyId})">⚠️ Suspender</button>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function generateMonthlyInvoices() {
            const newInvoices = companies.filter(c => c.status === 'active').map(company => {
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 30);
                
                return {
                    id: `INV-${company.company_id}-${new Date().getMonth() + 2}`,
                    companyId: company.company_id,
                    companyName: company.name,
                    amount: company.pricing.monthlyTotal,
                    dueDate: dueDate.toISOString().split('T')[0],
                    status: 'pending',
                    createdAt: new Date().toISOString().split('T')[0],
                    qrCode: `QR-${company.company_id}-${Date.now()}`
                };
            });
            
            invoices = [...invoices, ...newInvoices];
            renderBillingSystem();
            showNotification(`✅ ${newInvoices.length} facturas generadas para el próximo mes`, 'success');
        }

        function checkOverduePayments() {
            const overdueCount = invoices.filter(inv => inv.status === 'overdue').length;
            showNotification(`⚠️ ${overdueCount} facturas vencidas encontradas`, overdueCount > 0 ? 'warning' : 'info');
            
            if (overdueCount > 0) {
                switchTab('notifications');
                sendPaymentReminders();
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; margin-left: auto;">&times;</button>
            `;
            
            document.body.insertBefore(notification, document.body.firstChild);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Sistema de Pagos
        function loadPaymentSystem() {
            paymentMethods = companies.map(company => ({
                companyId: company.company_id,
                companyName: company.name,
                qrEnabled: Math.random() > 0.3,
                cardEnabled: Math.random() > 0.5,
                cardType: Math.random() > 0.5 ? 'credit' : 'debit',
                cardLast4: Math.floor(1000 + Math.random() * 9000),
                autopayEnabled: Math.random() > 0.4
            }));
            
            renderPaymentSystem();
        }

        function renderPaymentSystem() {
            const container = document.getElementById('paymentsContainer');
            
            container.innerHTML = `
                <div class="billing-card">
                    <div class="billing-header">
                        <h3>💳 Métodos de Pago por Empresa</h3>
                    </div>
                    <div class="invoice-grid">
                        ${paymentMethods.map(method => `
                            <div class="invoice-card">
                                <h4>${method.companyName}</h4>
                                <div style="margin: 1rem 0;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span>📱 QR Pagos:</span>
                                        <span class="status-badge ${method.qrEnabled ? 'status-active' : 'status-suspended'}">
                                            ${method.qrEnabled ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span>💳 Tarjeta:</span>
                                        <span class="status-badge ${method.cardEnabled ? 'status-active' : 'status-suspended'}">
                                            ${method.cardEnabled ? `**** ${method.cardLast4}` : 'No config.'}
                                        </span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span>🔄 Débito Auto:</span>
                                        <span class="status-badge ${method.autopayEnabled ? 'status-active' : 'status-trial'}">
                                            ${method.autopayEnabled ? 'Activo' : 'Manual'}
                                        </span>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="configurePayment(${method.companyId})">
                                    ⚙️ Configurar
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function processAutomaticPayments() {
            const autopayInvoices = invoices.filter(inv => {
                const method = paymentMethods.find(m => m.companyId === inv.companyId);
                return inv.status === 'pending' && method?.autopayEnabled;
            });
            
            autopayInvoices.forEach(invoice => {
                invoice.status = 'paid';
            });
            
            renderBillingSystem();
            showNotification(`✅ ${autopayInvoices.length} pagos automáticos procesados`, 'success');
        }

        function showQRPayment(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            
            const qrContent = `
                <div class="qr-payment">
                    <h3>💳 Pago con QR - ${invoice.id}</h3>
                    <p><strong>${invoice.companyName}</strong></p>
                    <p>Monto: <strong>U$S ${invoice.amount.toFixed(2)}</strong></p>
                    <div class="qr-code">
                        QR Code\\n${invoice.qrCode}\\n[Código QR Aquí]
                    </div>
                    <p style="margin-top: 1rem; color: #666;">Escanea el código QR con tu app de pagos</p>
                    <button class="btn btn-success" onclick="markAsPaid('${invoice.id}')" style="margin-top: 1rem;">✅ Marcar como Pagado</button>
                </div>
            `;
            
            showModal('Pago con QR', qrContent);
        }

        function markAsPaid(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                invoice.status = 'paid';
                renderBillingSystem();
                closeModal();
                showNotification(`✅ Factura ${invoiceId} marcada como pagada`, 'success');
            }
        }

        function suspendCompany(companyId) {
            const company = companies.find(c => c.id === companyId);
            if (company) {
                company.status = 'suspended';
                updateStats();
                renderCompaniesTable();
                showNotification(`⚠️ Empresa ${company.name} suspendida por falta de pago`, 'warning');
                
                // Agregar notificación de suspensión
                notifications.unshift({
                    id: Date.now(),
                    type: 'suspension',
                    title: 'Servicio Suspendido',
                    message: `La empresa ${company.name} ha sido suspendida por falta de pago`,
                    date: new Date().toISOString(),
                    companyId: companyId
                });
            }
        }

        // Sistema de Notificaciones
        function loadNotificationSystem() {
            // Generar notificaciones de ejemplo
            if (notifications.length === 0) {
                notifications = [
                    {
                        id: 1,
                        type: 'payment_reminder',
                        title: 'Recordatorio de Pago',
                        message: 'Tech Solutions tiene una factura vencida',
                        date: new Date().toISOString(),
                        companyId: 1
                    },
                    {
                        id: 2,
                        type: 'pre_suspension',
                        title: 'Aviso Pre-Suspensión',
                        message: 'Constructora ABC será suspendida en 3 días',
                        date: new Date().toISOString(),
                        companyId: 2
                    }
                ];
            }
            
            renderNotificationSystem();
        }

        function renderNotificationSystem() {
            const container = document.getElementById('notificationsContainer');
            
            container.innerHTML = `
                <div class="billing-card">
                    <div class="billing-header">
                        <h3>📧 Historial de Notificaciones</h3>
                        <div>Total: ${notifications.length}</div>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${notifications.map(notification => `
                            <div class="notification ${notification.type === 'suspension' ? 'error' : notification.type === 'pre_suspension' ? 'warning' : 'info'}">
                                <div style="flex: 1;">
                                    <strong>${notification.title}</strong><br>
                                    <span>${notification.message}</span><br>
                                    <small style="color: #666;">${new Date(notification.date).toLocaleString()}</small>
                                </div>
                                <button class="btn btn-primary" onclick="viewCompany(${notification.companyId})">
                                    👁️ Ver Empresa
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function sendPaymentReminders() {
            const overdueInvoices = invoices.filter(inv => inv.status === 'overdue');
            
            overdueInvoices.forEach(invoice => {
                const company = companies.find(c => c.id === invoice.companyId);
                if (company) {
                    notifications.unshift({
                        id: Date.now() + Math.random(),
                        type: 'payment_reminder',
                        title: 'Recordatorio de Pago Enviado',
                        message: `Recordatorio enviado a ${company.name} por factura ${invoice.id}`,
                        date: new Date().toISOString(),
                        companyId: company.company_id
                    });
                    
                    // Programar aviso de pre-suspensión en 3 días
                    setTimeout(() => {
                        notifications.unshift({
                            id: Date.now() + Math.random(),
                            type: 'pre_suspension',
                            title: 'Aviso Pre-Suspensión Programado',
                            message: `${company.name} será suspendida en 3 días si no paga`,
                            date: new Date().toISOString(),
                            companyId: company.company_id
                        });
                    }, 3000); // 3 segundos para demo
                }
            });
            
            renderNotificationSystem();
            showNotification(`📧 ${overdueInvoices.length} recordatorios de pago enviados`, 'success');
        }

        function viewCompany(companyId) {
            switchTab('companies');
            editCompany(companyId);
        }

        // Sistema de Configuración de Precios
        function loadPricingSystem() {
            generatePricingControls();
        }

        function generatePricingControls() {
            const container = document.getElementById('pricingContainer');
            
            console.log('🔄 Generando controles de precios con datos actuales');
            
            container.innerHTML = `
                <div class="pricing-controls">
                    ${Object.entries(pricingConfig.modules).map(([moduleId, module]) => `
                        <div class="module-pricing">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <span style="font-size: 1.5rem;">${module.icon}</span>
                                <strong>${module.name}</strong>
                            </div>
                            <div class="tier-selector">
                                <button class="tier-btn active" onclick="selectTier('${moduleId}', 0)">1-50</button>
                                <button class="tier-btn" onclick="selectTier('${moduleId}', 1)">51-100</button>
                                <button class="tier-btn" onclick="selectTier('${moduleId}', 2)">101+</button>
                            </div>
                            <input type="number" class="price-input" id="price-${moduleId}-0" 
                                   value="${(module.tierPrices?.tier1 || module.basePrice).toFixed(2)}" step="0.01" min="0" 
                                   onchange="updateModulePrice('${moduleId}', 0, this.value)">
                            <input type="number" class="price-input" id="price-${moduleId}-1" 
                                   value="${(module.tierPrices?.tier2 || module.basePrice * 0.85).toFixed(2)}" step="0.01" min="0" style="display: none;"
                                   onchange="updateModulePrice('${moduleId}', 1, this.value)">
                            <input type="number" class="price-input" id="price-${moduleId}-2" 
                                   value="${(module.tierPrices?.tier3 || module.basePrice * 0.70).toFixed(2)}" step="0.01" min="0" style="display: none;"
                                   onchange="updateModulePrice('${moduleId}', 2, this.value)">
                            <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                                ${module.description}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function selectTier(moduleId, tierIndex) {
            // Actualizar botones activos
            document.querySelectorAll(`[onclick*="selectTier('${moduleId}',"]`).forEach((btn, index) => {
                btn.classList.toggle('active', index === tierIndex);
            });
            
            // Mostrar/ocultar inputs de precio
            for (let i = 0; i < 3; i++) {
                const input = document.getElementById(`price-${moduleId}-${i}`);
                input.style.display = i === tierIndex ? 'block' : 'none';
            }
        }

        function updateModulePrice(moduleId, tier, price) {
            console.log(`Actualizando ${moduleId} - Tier ${tier}: U$S ${price}`);
            
            // Asegurar que existe el objeto tierPrices
            if (!pricingConfig.modules[moduleId].tierPrices) {
                pricingConfig.modules[moduleId].tierPrices = {
                    tier1: pricingConfig.modules[moduleId].basePrice,
                    tier2: pricingConfig.modules[moduleId].basePrice * 0.85,
                    tier3: pricingConfig.modules[moduleId].basePrice * 0.70
                };
            }
            
            // Actualizar precio en memoria
            const tierName = `tier${tier + 1}`;
            pricingConfig.modules[moduleId].tierPrices[tierName] = parseFloat(price);
            
            // También actualizar basePrice si es tier1
            if (tier === 0) {
                pricingConfig.modules[moduleId].basePrice = parseFloat(price);
            }
            
            console.log(`✅ Precio actualizado en memoria: ${moduleId}.${tierName} = ${price}`);
            showNotification(`Precio actualizado: ${pricingConfig.modules[moduleId].name} - Tier ${tier + 1}`, 'success');
        }

        function saveAllPricing() {
            // Guardar configuración de precios en la base de datos
            const pricingData = {
                modules: {},
                lastUpdated: new Date().toISOString()
            };
            
            // Recopilar precios de todos los módulos (usar valores en memoria)
            Object.entries(pricingConfig.modules).forEach(([moduleId, module]) => {
                // Asegurar que existe tierPrices
                if (!module.tierPrices) {
                    module.tierPrices = {
                        tier1: module.basePrice,
                        tier2: module.basePrice * 0.85,
                        tier3: module.basePrice * 0.70
                    };
                }
                
                pricingData.modules[moduleId] = {
                    name: module.name,
                    icon: module.icon,
                    description: module.description,
                    basePrice: module.basePrice,
                    tierPrices: {
                        tier1: module.tierPrices.tier1 || module.basePrice,
                        tier2: module.tierPrices.tier2 || (module.basePrice * 0.85),
                        tier3: module.tierPrices.tier3 || (module.basePrice * 0.70)
                    }
                };
                
                // Sincronizar basePrice con tier1
                pricingConfig.modules[moduleId].basePrice = pricingData.modules[moduleId].tierPrices.tier1;
            });
            
            // Simular guardado en base de datos
            savePricingToDatabase(pricingData);
            showNotification('✅ Configuración de precios guardada exitosamente', 'success');
        }
        
        async function savePricingToDatabase(data) {
            try {
                console.log('💰 Guardando precios de módulos...', data);
                
                const response = await fetch(`${API_BASE}/pricing`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token') || ''}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Precios guardados exitosamente:', result);
                    showNotification('✅ Precios de módulos actualizados correctamente', 'success');
                    
                    // Regenerar controles de precios para mostrar los nuevos valores
                    generatePricingControls();
                    
                    return result;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('❌ Error guardando precios:', error);
                console.log('📦 Guardando en localStorage como fallback');
                localStorage.setItem('modulesPricing', JSON.stringify(data));
                showNotification('⚠️ Precios guardados localmente (sin conexión a servidor)', 'warning');
            }
        }
        
        async function loadPricingFromDatabase() {
            try {
                console.log('📥 Cargando precios de módulos desde servidor...');

                const response = await fetch(`/api/aponnt/dashboard/pricing`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token') || ''}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Precios cargados desde servidor:', result);
                    if (result.success && result.modules) {
                        updatePricingConfig({ modules: result.modules });
                        return true;
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.warn('⚠️ Error cargando precios desde servidor:', error);
                console.log('📦 Intentando cargar desde localStorage...');
                
                const saved = localStorage.getItem('modulesPricing');
                if (saved) {
                    const data = JSON.parse(saved);
                    console.log('✅ Precios cargados desde localStorage:', data);
                    updatePricingConfig(data);
                    return true;
                }
                
                console.log('❌ No hay precios guardados localmente, usando valores por defecto');
                return false;
            }
        }
        
        // Función para cargar módulos desde la API
        async function loadModulesFromAPI() {
            try {
                console.log('📦 Cargando módulos desde la API...');
                const response = await fetch('/api/aponnt/dashboard/companies');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.modules) {
                    console.log(`✅ ${Object.keys(data.modules).length} módulos cargados desde la API`);

                    // Limpiar módulos existentes
                    pricingConfig.modules = {};

                    // Convertir módulos de la API al formato del dashboard
                    Object.entries(data.modules).forEach(([moduleKey, module]) => {
                        pricingConfig.modules[moduleKey] = {
                            name: module.name,
                            icon: module.icon,
                            color: module.color,
                            basePrice: parseFloat(module.basePrice || module.tierPrices?.tier1 || 0),
                            description: module.description,
                            category: module.category || 'general',
                            is_core: module.is_core || false,
                            display_order: module.display_order || 0,
                            features: module.features || [],
                            requirements: module.requirements || []
                        };
                    });

                    console.log('🔄 Configuración de módulos actualizada desde la API');
                    return true;
                } else {
                    throw new Error('Respuesta inválida de la API');
                }
            } catch (error) {
                console.error('❌ Error cargando módulos desde la API:', error);
                console.log('⚠️ Usando configuración de módulos hardcodeada como respaldo');
                return false;
            }
        }

        // Función para cargar módulos de una empresa específica desde la API
        async function loadCompanyModulesFromAPI(companyId) {
            try {
                console.log(`📊 Cargando módulos para empresa ${companyId}...`);
                const response = await fetch(`/api/v1/dashboard/modules?company_id=${companyId}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.modules) {
                    console.log(`✅ Módulos de empresa ${companyId} cargados: ${data.modules.active.length} activos, ${data.modules.inactive.length} inactivos`);

                    // Retornar los módulos organizados por estado
                    return {
                        active: data.modules.active,
                        inactive: data.modules.inactive,
                        all: data.modules.all,
                        counts: data.counts
                    };
                } else {
                    throw new Error('Respuesta inválida de la API');
                }
            } catch (error) {
                console.error('❌ Error cargando módulos de empresa desde la API:', error);
                return null;
            }
        }

        function updatePricingConfig(data) {
            Object.entries(data.modules).forEach(([moduleId, moduleData]) => {
                if (pricingConfig.modules[moduleId]) {
                    pricingConfig.modules[moduleId].basePrice = moduleData.tierPrices.tier1;
                    // Actualizar tierPrices en el objeto de configuración
                    pricingConfig.modules[moduleId].tierPrices = {
                        tier1: moduleData.tierPrices.tier1,
                        tier2: moduleData.tierPrices.tier2,
                        tier3: moduleData.tierPrices.tier3
                    };
                    // Actualizar inputs si están visibles
                    const input1 = document.getElementById(`price-${moduleId}-0`);
                    const input2 = document.getElementById(`price-${moduleId}-1`);
                    const input3 = document.getElementById(`price-${moduleId}-2`);
                    if (input1) input1.value = moduleData.tierPrices.tier1.toFixed(2);
                    if (input2) input2.value = moduleData.tierPrices.tier2.toFixed(2);
                    if (input3) input3.value = moduleData.tierPrices.tier3.toFixed(2);
                }
            });
            // Regenerar controles con los datos actualizados
            generatePricingControls();
        }

        function configurePayment(companyId) {
            const company = companies.find(c => c.id === companyId);
            const method = paymentMethods.find(m => m.companyId === companyId);
            
            const content = `
                <div style="padding: 1rem;">
                    <h3>Configurar Pagos - ${company.name}</h3>
                    <div style="margin: 1rem 0;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="checkbox" ${method.qrEnabled ? 'checked' : ''} onchange="toggleQR(${companyId}, this.checked)">
                            <span>📱 Habilitar pagos con QR</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="checkbox" ${method.cardEnabled ? 'checked' : ''} onchange="toggleCard(${companyId}, this.checked)">
                            <span>💳 Habilitar pagos con tarjeta</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" ${method.autopayEnabled ? 'checked' : ''} onchange="toggleAutopay(${companyId}, this.checked)">
                            <span>🔄 Débito automático mensual</span>
                        </label>
                    </div>
                    <button class="btn btn-success" onclick="closeModal()" style="width: 100%;">✅ Guardar Configuración</button>
                </div>
            `;
            
            showModal('Configuración de Pagos', content);
        }

        function toggleQR(companyId, enabled) {
            const method = paymentMethods.find(m => m.companyId === companyId);
            if (method) method.qrEnabled = enabled;
        }

        function toggleCard(companyId, enabled) {
            const method = paymentMethods.find(m => m.companyId === companyId);
            if (method) method.cardEnabled = enabled;
        }

        function toggleAutopay(companyId, enabled) {
            const method = paymentMethods.find(m => m.companyId === companyId);
            if (method) method.autopayEnabled = enabled;
        }

        // Funciones de utilidad
        function showModal(title, content) {
            const modal = document.getElementById('companyModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = modal.querySelector('.modal-body');
            
            modalTitle.textContent = title;
            modalBody.innerHTML = content;
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('companyModal').classList.remove('show');
        }

        // Base de datos geográfica completa de Latinoamérica
        const geographicalData = {
            Argentina: {
                'Buenos Aires': {
                    'Ciudad Autónoma de Buenos Aires': '1000',
                    'La Plata': '1900',
                    'Mar del Plata': '7600',
                    'Bahía Blanca': '8000',
                    'Tandil': '7000',
                    'Olavarría': '7400',
                    'Mercedes': '6600',
                    'Junín': '6000',
                    'Pergamino': '2700',
                    'San Nicolás': '2900',
                    'Quilmes': '1878',
                    'Lanús': '1824',
                    'Morón': '1708',
                    'San Isidro': '1642',
                    'Tigre': '1648',
                    'Pilar': '1629'
                },
                'Córdoba': {
                    'Córdoba': '5000',
                    'Villa Carlos Paz': '5152',
                    'Río Cuarto': '5800',
                    'Villa María': '5900',
                    'San Francisco': '2400',
                    'Alta Gracia': '5186',
                    'Jesús María': '5220'
                },
                'Santa Fe': {
                    'Santa Fe': '3000',
                    'Rosario': '2000',
                    'Rafaela': '2300',
                    'Venado Tuerto': '2600',
                    'Reconquista': '3560',
                    'Villa Gobernador Gálvez': '2152',
                    'Esperanza': '3080'
                },
                'Mendoza': {
                    'Mendoza': '5500',
                    'San Rafael': '5600',
                    'Godoy Cruz': '5501',
                    'Luján de Cuyo': '5507',
                    'Maipú': '5515',
                    'San Martín': '5570'
                },
                'Tucumán': {
                    'San Miguel de Tucumán': '4000',
                    'Tafí Viejo': '4103',
                    'Yerba Buena': '4107',
                    'Banda del Río Salí': '4101',
                    'Concepción': '4146'
                },
                'Entre Ríos': {
                    'Paraná': '3100',
                    'Concordia': '3200',
                    'Gualeguaychú': '2840',
                    'Uruguay': '3260',
                    'Concepción del Uruguay': '3260'
                },
                'Salta': {
                    'Salta': '4400',
                    'San Ramón de la Nueva Orán': '4530',
                    'Tartagal': '4560',
                    'Cafayate': '4427',
                    'Metán': '4440'
                },
                'Misiones': {
                    'Posadas': '3300',
                    'Oberá': '3360',
                    'Eldorado': '3380',
                    'Puerto Iguazú': '3370',
                    'Leandro N. Alem': '3315'
                },
                'Chaco': {
                    'Resistencia': '3500',
                    'Barranqueras': '3503',
                    'Sáenz Peña': '3700',
                    'Villa Ángela': '3540'
                },
                'Corrientes': {
                    'Corrientes': '3400',
                    'Goya': '3450',
                    'Mercedes': '3470',
                    'Paso de los Libres': '3230'
                },
                'Santiago del Estero': {
                    'Santiago del Estero': '4200',
                    'La Banda': '4206',
                    'Termas de Río Hondo': '4220',
                    'Añatuya': '4650'
                },
                'Jujuy': {
                    'San Salvador de Jujuy': '4600',
                    'Palpalá': '4612',
                    'Perico': '4611',
                    'San Pedro': '4500'
                },
                'Formosa': {
                    'Formosa': '3600',
                    'Clorinda': '3613',
                    'Pirané': '3600',
                    'Ingeniero Juárez': '3711'
                },
                'Catamarca': {
                    'San Fernando del Valle de Catamarca': '4700',
                    'Andalgalá': '4874',
                    'Belén': '4750',
                    'Tinogasta': '5340'
                },
                'La Rioja': {
                    'La Rioja': '5300',
                    'Chilecito': '5360',
                    'Aimogasta': '5310',
                    'Chepes': '5370'
                },
                'San Juan': {
                    'San Juan': '5400',
                    'Chimbas': '5413',
                    'Rivadavia': '5407',
                    'Santa Lucía': '5411'
                },
                'San Luis': {
                    'San Luis': '5700',
                    'Villa Mercedes': '5730',
                    'Merlo': '5881',
                    'Justo Daract': '5750'
                },
                'La Pampa': {
                    'Santa Rosa': '6300',
                    'General Pico': '6360',
                    'Toay': '6303',
                    'Eduardo Castex': '6350'
                },
                'Neuquén': {
                    'Neuquén': '8300',
                    'Plottier': '8316',
                    'Cipolletti': '8324',
                    'Cutral Có': '8322'
                },
                'Río Negro': {
                    'Viedma': '8500',
                    'San Carlos de Bariloche': '8400',
                    'General Roca': '8332',
                    'Cipolletti': '8324'
                },
                'Chubut': {
                    'Rawson': '9103',
                    'Comodoro Rivadavia': '9000',
                    'Puerto Madryn': '9120',
                    'Trelew': '9100'
                },
                'Santa Cruz': {
                    'Río Gallegos': '9400',
                    'Caleta Olivia': '9011',
                    'El Calafate': '9405',
                    'Puerto Deseado': '9050'
                },
                'Tierra del Fuego': {
                    'Ushuaia': '9410',
                    'Río Grande': '9420',
                    'Tolhuin': '9412'
                }
            },
            
            Bolivia: {
                'La Paz': {
                    'La Paz': '0001',
                    'El Alto': '0002',
                    'Achocalla': '0003',
                    'Mecapaca': '0004'
                },
                'Santa Cruz': {
                    'Santa Cruz de la Sierra': '1001',
                    'Montero': '1002',
                    'Warnes': '1003',
                    'La Guardia': '1004'
                },
                'Cochabamba': {
                    'Cochabamba': '2001',
                    'Quillacollo': '2002',
                    'Sacaba': '2003',
                    'Colcapirhua': '2004'
                },
                'Oruro': {
                    'Oruro': '3001',
                    'Challapata': '3002'
                },
                'Potosí': {
                    'Potosí': '4001',
                    'Uyuni': '4002'
                },
                'Tarija': {
                    'Tarija': '5001',
                    'Yacuiba': '5002'
                },
                'Sucre': {
                    'Sucre': '6001'
                },
                'Beni': {
                    'Trinidad': '7001',
                    'Riberalta': '7002'
                },
                'Pando': {
                    'Cobija': '8001'
                }
            },

            Brasil: {
                'São Paulo': {
                    'São Paulo': '01000-000',
                    'Guarulhos': '07000-000',
                    'Campinas': '13000-000',
                    'São Bernardo do Campo': '09000-000',
                    'Santo André': '09000-000',
                    'Osasco': '06000-000',
                    'Santos': '11000-000',
                    'Ribeirão Preto': '14000-000',
                    'Sorocaba': '18000-000',
                    'São José dos Campos': '12000-000'
                },
                'Rio de Janeiro': {
                    'Rio de Janeiro': '20000-000',
                    'Niterói': '24000-000',
                    'Nova Iguaçu': '26000-000',
                    'Duque de Caxias': '25000-000',
                    'São Gonçalo': '24000-000',
                    'Volta Redonda': '27000-000',
                    'Petrópolis': '25000-000',
                    'Campos dos Goytacazes': '28000-000',
                    'Belford Roxo': '26000-000'
                },
                'Minas Gerais': {
                    'Belo Horizonte': '30000-000',
                    'Uberlândia': '38000-000',
                    'Contagem': '32000-000',
                    'Juiz de Fora': '36000-000',
                    'Betim': '32000-000',
                    'Montes Claros': '39000-000',
                    'Ribeirão das Neves': '33000-000',
                    'Uberaba': '38000-000',
                    'Governador Valadares': '35000-000',
                    'Ipatinga': '35000-000'
                },
                'Bahia': {
                    'Salvador': '40000-000',
                    'Feira de Santana': '44000-000',
                    'Vitória da Conquista': '45000-000',
                    'Camaçari': '42000-000',
                    'Juazeiro': '48000-000',
                    'Lauro de Freitas': '42000-000',
                    'Itabuna': '45000-000',
                    'Jequié': '45000-000',
                    'Alagoinhas': '48000-000'
                },
                'Paraná': {
                    'Curitiba': '80000-000',
                    'Londrina': '86000-000',
                    'Maringá': '87000-000',
                    'Ponta Grossa': '84000-000',
                    'Cascavel': '85000-000',
                    'São José dos Pinhais': '83000-000',
                    'Foz do Iguaçu': '85000-000',
                    'Colombo': '83000-000',
                    'Guarapuava': '85000-000'
                },
                'Rio Grande do Sul': {
                    'Porto Alegre': '90000-000',
                    'Caxias do Sul': '95000-000',
                    'Pelotas': '96000-000',
                    'Canoas': '92000-000',
                    'Santa Maria': '97000-000',
                    'Gravataí': '94000-000',
                    'Viamão': '94000-000',
                    'Novo Hamburgo': '93000-000',
                    'São Leopoldo': '93000-000'
                },
                'Ceará': {
                    'Fortaleza': '60000-000',
                    'Caucaia': '61000-000',
                    'Juazeiro do Norte': '63000-000',
                    'Maracanaú': '61000-000',
                    'Sobral': '62000-000',
                    'Crato': '63000-000'
                },
                'Pernambuco': {
                    'Recife': '50000-000',
                    'Jaboatão dos Guararapes': '54000-000',
                    'Olinda': '53000-000',
                    'Caruaru': '55000-000',
                    'Petrolina': '56000-000',
                    'Paulista': '53000-000'
                },
                'Pará': {
                    'Belém': '66000-000',
                    'Ananindeua': '67000-000',
                    'Santarém': '68000-000',
                    'Marabá': '68000-000',
                    'Parauapebas': '68500-000'
                },
                'Santa Catarina': {
                    'Florianópolis': '88000-000',
                    'Joinville': '89000-000',
                    'Blumenau': '89000-000',
                    'São José': '88000-000',
                    'Criciúma': '88800-000',
                    'Chapecó': '89800-000'
                },
                'Goiás': {
                    'Goiânia': '74000-000',
                    'Aparecida de Goiânia': '74000-000',
                    'Anápolis': '75000-000',
                    'Rio Verde': '75900-000',
                    'Luziânia': '72800-000'
                },
                'Maranhão': {
                    'São Luís': '65000-000',
                    'Imperatriz': '65900-000',
                    'São José de Ribamar': '65110-000',
                    'Timon': '65630-000',
                    'Caxias': '65600-000'
                },
                'Espírito Santo': {
                    'Vitória': '29000-000',
                    'Vila Velha': '29100-000',
                    'Serra': '29160-000',
                    'Cariacica': '29140-000',
                    'Cachoeiro de Itapemirim': '29300-000'
                }
            },

            Chile: {
                'Región de Arica y Parinacota': {
                    'Arica': '1000000',
                    'Putre': '1000001',
                    'Camarones': '1000002',
                    'General Lagos': '1000003'
                },
                'Región de Tarapacá': {
                    'Iquique': '1100000',
                    'Alto Hospicio': '1100001',
                    'Pozo Almonte': '1100002',
                    'Pica': '1100003',
                    'Huara': '1100004'
                },
                'Región de Antofagasta': {
                    'Antofagasta': '1240000',
                    'Calama': '1390000',
                    'Tocopilla': '1340000',
                    'Mejillones': '1240001',
                    'Taltal': '1380000',
                    'San Pedro de Atacama': '1410000'
                },
                'Región de Atacama': {
                    'Copiapó': '1530000',
                    'Vallenar': '1610000',
                    'Caldera': '1570000',
                    'Chañaral': '1490000',
                    'Diego de Almagro': '1500000'
                },
                'Región de Coquimbo': {
                    'La Serena': '1700000',
                    'Coquimbo': '1780000',
                    'Ovalle': '1840000',
                    'Illapel': '1990000',
                    'Vicuña': '1740000'
                },
                'Región de Valparaíso': {
                    'Valparaíso': '2340000',
                    'Viña del Mar': '2520000',
                    'Quilpué': '2430000',
                    'Villa Alemana': '2910000',
                    'San Antonio': '2660000',
                    'Quillota': '2260000',
                    'Los Andes': '2100000'
                },
                'Región Metropolitana': {
                    'Santiago': '8320000',
                    'Puente Alto': '8150000',
                    'Maipú': '9250000',
                    'Las Condes': '7550000',
                    'La Florida': '8240000',
                    'Providencia': '7500000',
                    'Ñuñoa': '7750000',
                    'San Bernardo': '8050000',
                    'Peñalolén': '7910000',
                    'Quilicura': '8730000',
                    'Melipilla': '9580000'
                },
                'Región del Libertador Bernardo O\'Higgins': {
                    'Rancagua': '2820000',
                    'San Fernando': '3070000',
                    'Rengo': '2940000',
                    'Machalí': '2841000',
                    'Graneros': '2900000'
                },
                'Región del Maule': {
                    'Talca': '3460000',
                    'Curicó': '3340000',
                    'Linares': '3580000',
                    'Cauquenes': '3690000',
                    'Constitución': '3560000'
                },
                'Región del Biobío': {
                    'Concepción': '4030000',
                    'Talcahuano': '4260000',
                    'Chillán': '3780000',
                    'Los Ángeles': '4440000',
                    'Coronel': '4190000',
                    'San Pedro de la Paz': '4130000',
                    'Tomé': '4270000'
                },
                'Región de La Araucanía': {
                    'Temuco': '4780000',
                    'Villarrica': '4930000',
                    'Angol': '4650000',
                    'Pucón': '4920000',
                    'Victoria': '4730000'
                },
                'Región de Los Ríos': {
                    'Valdivia': '5090000',
                    'La Unión': '5170000',
                    'Río Bueno': '5310000',
                    'Panguipulli': '5120000'
                },
                'Región de Los Lagos': {
                    'Puerto Montt': '5480000',
                    'Osorno': '5290000',
                    'Castro': '5700000',
                    'Puerto Varas': '5550000',
                    'Ancud': '5710000'
                },
                'Región de Aysén': {
                    'Coyhaique': '5950000',
                    'Puerto Aysén': '5960000',
                    'Chile Chico': '6160000'
                },
                'Región de Magallanes': {
                    'Punta Arenas': '6200000',
                    'Puerto Natales': '6160000',
                    'Porvenir': '6350000'
                }
            },

            Colombia: {
                'Cundinamarca': {
                    'Bogotá': '110111',
                    'Soacha': '250754',
                    'Girardot': '251226',
                    'Zipaquirá': '251001'
                },
                'Antioquia': {
                    'Medellín': '050001',
                    'Bello': '050088',
                    'Itagüí': '050360',
                    'Envigado': '050266'
                },
                'Valle del Cauca': {
                    'Cali': '760001',
                    'Palmira': '760520',
                    'Buenaventura': '760001',
                    'Tulua': '760855'
                },
                'Atlántico': {
                    'Barranquilla': '080001',
                    'Soledad': '080758',
                    'Malambo': '080433'
                },
                'Bolívar': {
                    'Cartagena': '130001',
                    'Magangué': '130429',
                    'Turbaco': '130833'
                },
                'Santander': {
                    'Bucaramanga': '680001',
                    'Floridablanca': '680276',
                    'Girón': '680307'
                },
                'Norte de Santander': {
                    'Cúcuta': '540001',
                    'Villa del Rosario': '540874',
                    'Los Patios': '540405'
                }
            },

            'Costa Rica': {
                'San José': {
                    'San José': '10101',
                    'Escazú': '10201',
                    'Desamparados': '10301',
                    'Cartago': '30101'
                },
                'Alajuela': {
                    'Alajuela': '20101',
                    'San Ramón': '20701',
                    'Grecia': '20301'
                },
                'Cartago': {
                    'Cartago': '30101',
                    'Paraíso': '30201',
                    'Turrialba': '30501'
                },
                'Heredia': {
                    'Heredia': '40101',
                    'Barva': '40201',
                    'Santo Domingo': '40301'
                },
                'Guanacaste': {
                    'Liberia': '50101',
                    'Nicoya': '50501',
                    'Santa Cruz': '50601'
                },
                'Puntarenas': {
                    'Puntarenas': '60101',
                    'Esparza': '60201',
                    'Buenos Aires': '60301'
                },
                'Limón': {
                    'Limón': '70101',
                    'Pococí': '70201',
                    'Siquirres': '70301'
                }
            },

            Ecuador: {
                'Pichincha': {
                    'Quito': '170501',
                    'Cayambe': '170150',
                    'Mejía': '170250'
                },
                'Guayas': {
                    'Guayaquil': '090101',
                    'Milagro': '090550',
                    'Durán': '090250'
                },
                'Azuay': {
                    'Cuenca': '010101',
                    'Gualaceo': '010350',
                    'Paute': '010550'
                },
                'Manabí': {
                    'Portoviejo': '130101',
                    'Manta': '130550',
                    'Chone': '130250'
                },
                'Los Ríos': {
                    'Babahoyo': '120101',
                    'Quevedo': '120750',
                    'Ventanas': '120950'
                },
                'Tungurahua': {
                    'Ambato': '180101',
                    'Baños de Agua Santa': '180150',
                    'Pelileo': '180650'
                }
            },

            'El Salvador': {
                'San Salvador': {
                    'San Salvador': 'SS01',
                    'Mejicanos': 'SS02',
                    'Soyapango': 'SS03',
                    'Delgado': 'SS04'
                },
                'La Libertad': {
                    'Santa Tecla': 'LL01',
                    'Antiguo Cuscatlán': 'LL02',
                    'Quezaltepeque': 'LL03'
                },
                'San Miguel': {
                    'San Miguel': 'SM01',
                    'Moncagua': 'SM02'
                },
                'Santa Ana': {
                    'Santa Ana': 'SA01',
                    'Metapán': 'SA02'
                },
                'Ahuachapán': {
                    'Ahuachapán': 'AH01',
                    'Atiquizaya': 'AH02'
                }
            },

            Guatemala: {
                'Guatemala': {
                    'Ciudad de Guatemala': '01001',
                    'Mixco': '01002',
                    'Villa Nueva': '01003',
                    'San Miguel Petapa': '01004'
                },
                'Quetzaltenango': {
                    'Quetzaltenango': '09001',
                    'Salcajá': '09002',
                    'Olintepeque': '09003'
                },
                'Escuintla': {
                    'Escuintla': '05001',
                    'Santa Lucía Cotzumalguapa': '05002'
                },
                'Alta Verapaz': {
                    'Cobán': '16001',
                    'San Pedro Carchá': '16002'
                },
                'Petén': {
                    'Flores': '17001',
                    'San Benito': '17002'
                }
            },

            Honduras: {
                'Francisco Morazán': {
                    'Tegucigalpa': '0801',
                    'Comayagüela': '0802',
                    'Valle de Ángeles': '0803'
                },
                'Cortés': {
                    'San Pedro Sula': '0501',
                    'Choloma': '0502',
                    'La Lima': '0503'
                },
                'Atlántida': {
                    'La Ceiba': '0101',
                    'Tela': '0102',
                    'El Progreso': '0103'
                },
                'Choluteca': {
                    'Choluteca': '0601',
                    'Marcovia': '0602'
                },
                'Olancho': {
                    'Juticalpa': '1501',
                    'Catacamas': '1502'
                }
            },

            México: {
                'Ciudad de México': {
                    'Ciudad de México': '01000',
                    'Álvaro Obregón': '01020',
                    'Azcapotzalco': '02000',
                    'Benito Juárez': '03000'
                },
                'Estado de México': {
                    'Toluca': '50000',
                    'Ecatepec': '55000',
                    'Naucalpan': '53000',
                    'Nezahualcóyotl': '57000'
                },
                'Jalisco': {
                    'Guadalajara': '44100',
                    'Zapopan': '45000',
                    'Tlaquepaque': '45500',
                    'Tonalá': '45400'
                },
                'Nuevo León': {
                    'Monterrey': '64000',
                    'Guadalupe': '67100',
                    'San Nicolás de los Garza': '66400'
                },
                'Puebla': {
                    'Puebla': '72000',
                    'Tehuacán': '75700',
                    'Atlixco': '74200'
                },
                'Chihuahua': {
                    'Chihuahua': '31000',
                    'Ciudad Juárez': '32000',
                    'Delicias': '33000'
                }
            },

            Nicaragua: {
                'Managua': {
                    'Managua': '10001',
                    'Ciudad Sandino': '10002',
                    'Tipitapa': '10003'
                },
                'León': {
                    'León': '21001',
                    'La Paz Centro': '21002'
                },
                'Granada': {
                    'Granada': '31001',
                    'Nandaime': '31002'
                },
                'Masaya': {
                    'Masaya': '41001',
                    'Niquinohomo': '41002'
                },
                'Chinandega': {
                    'Chinandega': '12001',
                    'Corinto': '12002'
                }
            },

            Panamá: {
                'Panamá': {
                    'Ciudad de Panamá': '0801',
                    'San Miguelito': '0802',
                    'Pedregal': '0803'
                },
                'Colón': {
                    'Colón': '0301',
                    'Sabanitas': '0302'
                },
                'Chiriquí': {
                    'David': '0401',
                    'Boquete': '0402',
                    'Puerto Armuelles': '0403'
                },
                'Coclé': {
                    'Penonomé': '0201',
                    'Aguadulce': '0202'
                },
                'Veraguas': {
                    'Santiago': '1201',
                    'Soná': '1202'
                }
            },

            Paraguay: {
                'Central': {
                    'Asunción': '1001',
                    'Lambaré': '1002',
                    'San Lorenzo': '1003',
                    'Capiatá': '1004',
                    'Fernando de la Mora': '1005',
                    'Luque': '1006',
                    'Mariano Roque Alonso': '1007',
                    'Ñemby': '1008',
                    'San Antonio': '1009',
                    'Villa Elisa': '1010'
                },
                'Alto Paraná': {
                    'Ciudad del Este': '7001',
                    'Hernandarias': '7002',
                    'Minga Guazú': '7003',
                    'Franco': '7004',
                    'Presidente Franco': '7005',
                    'Itakyry': '7006'
                },
                'Itapúa': {
                    'Encarnación': '6001',
                    'Hohenau': '6002',
                    'Obligado': '6003',
                    'Bella Vista': '6004',
                    'Carmen del Paraná': '6005'
                },
                'Cordillera': {
                    'Caacupé': '5001',
                    'Tobatí': '5002',
                    'Atyrá': '5003',
                    'Caraguatay': '5004',
                    'Emboscada': '5005'
                },
                'Guairá': {
                    'Villarrica': '4001',
                    'Borja': '4002',
                    'Coronel Martínez': '4003',
                    'Félix Pérez Cardozo': '4004'
                },
                'Paraguarí': {
                    'Paraguarí': '2001',
                    'Piribebuy': '2002',
                    'Yaguarón': '2003',
                    'Ybycuí': '2004'
                },
                'Caaguazú': {
                    'Coronel Oviedo': '3001',
                    'Caaguazú': '3002',
                    'J. Eulogio Estigarribia': '3003',
                    'Nueva Londres': '3004'
                },
                'San Pedro': {
                    'San Pedro del Ycuamandiyú': '14001',
                    'Antequera': '14002',
                    'Choré': '14003'
                },
                'Concepción': {
                    'Concepción': '13001',
                    'Belén': '13002',
                    'Horqueta': '13003'
                },
                'Amambay': {
                    'Pedro Juan Caballero': '16001',
                    'Bella Vista': '16002',
                    'Capitán Bado': '16003'
                }
            },

            Perú: {
                'Lima': {
                    'Lima': '15001',
                    'Callao': '07001',
                    'San Juan de Lurigancho': '15132',
                    'San Martín de Porres': '15109'
                },
                'Arequipa': {
                    'Arequipa': '04001',
                    'Cayma': '04003',
                    'Cerro Colorado': '04017'
                },
                'La Libertad': {
                    'Trujillo': '13001',
                    'El Porvenir': '13004',
                    'Florencia de Mora': '13005'
                },
                'Piura': {
                    'Piura': '20001',
                    'Castilla': '20003',
                    'Catacaos': '20004'
                },
                'Lambayeque': {
                    'Chiclayo': '14001',
                    'José Leonardo Ortiz': '14002',
                    'La Victoria': '14003'
                },
                'Cusco': {
                    'Cusco': '08001',
                    'San Sebastián': '08007',
                    'San Jerónimo': '08006'
                }
            },

            Uruguay: {
                'Montevideo': {
                    'Montevideo': '11000',
                    'Ciudad Vieja': '11100',
                    'Centro': '11200',
                    'Barrio Sur': '11300',
                    'Pocitos': '11300',
                    'Punta Carretas': '11300',
                    'Carrasco': '11500',
                    'Malvín': '11400',
                    'Buceo': '11300'
                },
                'Canelones': {
                    'Canelones': '90000',
                    'Las Piedras': '90200',
                    'Pando': '91000',
                    'Santa Lucía': '90300',
                    'Ciudad de la Costa': '15000',
                    'Barros Blancos': '91700',
                    'La Paz': '91500',
                    'Progreso': '90200',
                    'Atlántida': '15200',
                    'Parque del Plata': '15300'
                },
                'Maldonado': {
                    'Maldonado': '20000',
                    'Punta del Este': '20100',
                    'San Carlos': '20200',
                    'Piriápolis': '20200',
                    'Pan de Azúcar': '20300',
                    'Aiguá': '20400'
                },
                'Salto': {
                    'Salto': '50000',
                    'Constitución': '50100',
                    'Belén': '50200',
                    'Biassini': '50300'
                },
                'Rivera': {
                    'Rivera': '40000',
                    'Tranqueras': '40100',
                    'Vichadero': '40200',
                    'Minas de Corrales': '40300'
                },
                'Paysandú': {
                    'Paysandú': '60000',
                    'Guichón': '60100',
                    'Quebracho': '60200',
                    'Lorenzo Geyres': '60300'
                },
                'Tacuarembó': {
                    'Tacuarembó': '45000',
                    'Paso de los Toros': '45100',
                    'San Gregorio de Polanco': '45200'
                },
                'Colonia': {
                    'Colonia del Sacramento': '70000',
                    'Juan Lacaze': '70100',
                    'Nueva Helvecia': '70200',
                    'Rosario': '70300',
                    'Tarariras': '70400'
                },
                'Soriano': {
                    'Mercedes': '75000',
                    'Dolores': '75100',
                    'Cardona': '75200'
                },
                'Rocha': {
                    'Rocha': '27000',
                    'Chuy': '27100',
                    'La Paloma': '27200',
                    'Castillos': '27300'
                },
                'Artigas': {
                    'Artigas': '55000',
                    'Bella Unión': '55100',
                    'Tomás Gomensoro': '55200'
                },
                'Cerro Largo': {
                    'Melo': '37000',
                    'Río Branco': '37100',
                    'Fraile Muerto': '37200'
                },
                'Durazno': {
                    'Durazno': '97000',
                    'Sarandí del Yí': '97100',
                    'Villa del Carmen': '97200'
                },
                'Flores': {
                    'Trinidad': '85000',
                    'Ismael Cortinas': '85100'
                },
                'Florida': {
                    'Florida': '94000',
                    '25 de Agosto': '94100',
                    'Sarandí Grande': '94200'
                },
                'Lavalleja': {
                    'Minas': '30000',
                    'José Pedro Varela': '30100',
                    'Solís de Mataojo': '30200'
                },
                'Río Negro': {
                    'Fray Bentos': '65000',
                    'Young': '65100',
                    'Nuevo Berlín': '65200'
                },
                'San José': {
                    'San José de Mayo': '80000',
                    'Ciudad del Plata': '80100',
                    'Libertad': '80200',
                    'Ecilda Paullier': '80300'
                },
                'Treinta y Tres': {
                    'Treinta y Tres': '33000',
                    'Vergara': '33100',
                    'Santa Clara de Olimar': '33200'
                }
            },

            España: {
                'Andalucía': {
                    'Sevilla': '41001',
                    'Málaga': '29001',
                    'Córdoba': '14001',
                    'Granada': '18001',
                    'Cádiz': '11001',
                    'Almería': '04001',
                    'Huelva': '21001',
                    'Jaén': '23001',
                    'Jerez de la Frontera': '11401',
                    'Marbella': '29600'
                },
                'Cataluña': {
                    'Barcelona': '08001',
                    'L\'Hospitalet de Llobregat': '08901',
                    'Badalona': '08911',
                    'Terrassa': '08221',
                    'Sabadell': '08201',
                    'Lleida': '25001',
                    'Tarragona': '43001',
                    'Girona': '17001',
                    'Manresa': '08240',
                    'Reus': '43201'
                },
                'Comunidad de Madrid': {
                    'Madrid': '28001',
                    'Móstoles': '28931',
                    'Alcalá de Henares': '28801',
                    'Fuenlabrada': '28941',
                    'Leganés': '28911',
                    'Getafe': '28901',
                    'Alcorcón': '28921',
                    'Torrejón de Ardoz': '28850',
                    'Parla': '28980',
                    'Alcobendas': '28100'
                },
                'Comunidad Valenciana': {
                    'Valencia': '46001',
                    'Alicante': '03001',
                    'Elche': '03201',
                    'Castellón de la Plana': '12001',
                    'Torrevieja': '03180',
                    'Orihuela': '03300',
                    'Gandía': '46701',
                    'Sagunto': '46500',
                    'Alcoy': '03801',
                    'Villena': '03400'
                },
                'Galicia': {
                    'Vigo': '36201',
                    'A Coruña': '15001',
                    'Ourense': '32001',
                    'Lugo': '27001',
                    'Santiago de Compostela': '15701',
                    'Pontevedra': '36001',
                    'Ferrol': '15401',
                    'Narón': '15570',
                    'Vilagarcía de Arousa': '36600'
                },
                'País Vasco': {
                    'Bilbao': '48001',
                    'Vitoria-Gasteiz': '01001',
                    'San Sebastián': '20001',
                    'Getxo': '48901',
                    'Barakaldo': '48901',
                    'Santurtzi': '48980',
                    'Portugalete': '48920',
                    'Basauri': '48970'
                },
                'Castilla y León': {
                    'Valladolid': '47001',
                    'Burgos': '09001',
                    'Salamanca': '37001',
                    'León': '24001',
                    'Palencia': '34001',
                    'Zamora': '49001',
                    'Ávila': '05001',
                    'Segovia': '40001',
                    'Soria': '42001',
                    'Ponferrada': '24400'
                },
                'Aragón': {
                    'Zaragoza': '50001',
                    'Huesca': '22001',
                    'Teruel': '44001',
                    'Calatayud': '50300',
                    'Alcañiz': '44600',
                    'Barbastro': '22300',
                    'Monzón': '22400',
                    'Jaca': '22700'
                },
                'Asturias': {
                    'Oviedo': '33001',
                    'Gijón': '33201',
                    'Avilés': '33401',
                    'Siero': '33510',
                    'Langreo': '33930',
                    'Mieres': '33600',
                    'Sama de Langreo': '33900'
                },
                'Castilla-La Mancha': {
                    'Toledo': '45001',
                    'Albacete': '02001',
                    'Ciudad Real': '13001',
                    'Guadalajara': '19001',
                    'Cuenca': '16001',
                    'Talavera de la Reina': '45600',
                    'Puertollano': '13500'
                },
                'Murcia': {
                    'Murcia': '30001',
                    'Cartagena': '30201',
                    'Lorca': '30800',
                    'Molina de Segura': '30500',
                    'Alcantarilla': '30820',
                    'Mazarrón': '30870'
                },
                'Extremadura': {
                    'Badajoz': '06001',
                    'Cáceres': '10001',
                    'Mérida': '06800',
                    'Plasencia': '10600',
                    'Don Benito': '06400',
                    'Villanueva de la Serena': '06700'
                },
                'Baleares': {
                    'Palma': '07001',
                    'Calvià': '07180',
                    'Manacor': '07500',
                    'Inca': '07300',
                    'Llucmajor': '07620',
                    'Marratxí': '07141'
                },
                'Navarra': {
                    'Pamplona': '31001',
                    'Tudela': '31500',
                    'Barañáin': '31010',
                    'Burlada': '31007',
                    'Estella': '31200'
                },
                'Cantabria': {
                    'Santander': '39001',
                    'Torrelavega': '39300',
                    'Castro-Urdiales': '39700',
                    'Camargo': '39600',
                    'El Astillero': '39610'
                },
                'La Rioja': {
                    'Logroño': '26001',
                    'Calahorra': '26500',
                    'Arnedo': '26580',
                    'Haro': '26200'
                },
                'Canarias': {
                    'Las Palmas de Gran Canaria': '35001',
                    'Santa Cruz de Tenerife': '38001',
                    'San Cristóbal de La Laguna': '38200',
                    'Telde': '35200',
                    'Santa Lucía de Tirajana': '35110',
                    'Arona': '38640',
                    'Arrecife': '35500'
                },
                'Ceuta': {
                    'Ceuta': '51001'
                },
                'Melilla': {
                    'Melilla': '52001'
                }
            },

            Venezuela: {
                'Distrito Capital': {
                    'Caracas': '1010',
                    'Libertador': '1020',
                    'Chacao': '1060',
                    'Baruta': '1080'
                },
                'Miranda': {
                    'Los Teques': '1201',
                    'Guarenas': '1202',
                    'Guatire': '1203',
                    'Petare': '1204'
                },
                'Zulia': {
                    'Maracaibo': '4001',
                    'San Francisco': '4002',
                    'Cabimas': '4003'
                },
                'Carabobo': {
                    'Valencia': '2001',
                    'Puerto Cabello': '2002',
                    'Guacara': '2003'
                },
                'Lara': {
                    'Barquisimeto': '3001',
                    'Cabudare': '3002',
                    'El Tocuyo': '3003'
                },
                'Aragua': {
                    'Maracay': '2101',
                    'Turmero': '2102',
                    'Villa de Cura': '2103'
                }
            }
        };

        // Funciones para cargar datos geográficos
        function loadProvinces() {
            const countrySelect = document.getElementById('country');
            const provinceSelect = document.getElementById('province');
            const citySelect = document.getElementById('city');
            const postalCodeInput = document.getElementById('postalCode');
            
            const selectedCountry = countrySelect.value;
            
            // Limpiar selects dependientes
            provinceSelect.innerHTML = '<option value="">Seleccionar provincia...</option>';
            citySelect.innerHTML = '<option value="">Seleccionar ciudad...</option>';
            postalCodeInput.value = '';
            
            if (selectedCountry && geographicalData[selectedCountry]) {
                Object.keys(geographicalData[selectedCountry]).forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    provinceSelect.appendChild(option);
                });
            }
        }

        function loadCities() {
            const countrySelect = document.getElementById('country');
            const provinceSelect = document.getElementById('province');
            const citySelect = document.getElementById('city');
            const postalCodeInput = document.getElementById('postalCode');
            
            const selectedCountry = countrySelect.value;
            const selectedProvince = provinceSelect.value;
            
            // Limpiar selects dependientes
            citySelect.innerHTML = '<option value="">Seleccionar ciudad...</option>';
            postalCodeInput.value = '';
            
            if (selectedCountry && selectedProvince && 
                geographicalData[selectedCountry] && 
                geographicalData[selectedCountry][selectedProvince]) {
                
                Object.keys(geographicalData[selectedCountry][selectedProvince]).forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
        }

        function loadPostalCode() {
            const countrySelect = document.getElementById('country');
            const provinceSelect = document.getElementById('province');
            const citySelect = document.getElementById('city');
            const postalCodeInput = document.getElementById('postalCode');
            
            const selectedCountry = countrySelect.value;
            const selectedProvince = provinceSelect.value;
            const selectedCity = citySelect.value;
            
            if (selectedCountry && selectedProvince && selectedCity &&
                geographicalData[selectedCountry] && 
                geographicalData[selectedCountry][selectedProvince] &&
                geographicalData[selectedCountry][selectedProvince][selectedCity]) {
                
                postalCodeInput.value = geographicalData[selectedCountry][selectedProvince][selectedCity];
            } else {
                postalCodeInput.value = '';
            }
        }
        
        function checkForPriceChanges(company) {
            if (!company.modulesPricing) return;
            
            let hasChanges = false;
            const tier = getCurrentTier(company.maxEmployees);
            
            // Verificar si algún módulo tiene precios diferentes a los actuales
            company.modules.forEach(moduleId => {
                const currentPrice = calculateModulePrice(pricingConfig.modules[moduleId].basePrice, tier);
                const historicalPrice = company.modulesPricing[moduleId]?.tierPrice || 0;
                
                if (Math.abs(currentPrice - historicalPrice) > 0.01) {
                    hasChanges = true;
                }
            });
            
            // Mostrar u ocultar la sección de actualización de precios
            const section = document.getElementById('priceUpdateSection');
            const checkbox = document.getElementById('updatePricesCheckbox');
            
            if (hasChanges) {
                section.style.display = 'block';
                checkbox.checked = false; // Por defecto no aplicar cambios
            } else {
                section.style.display = 'none';
            }
        }
        
        function togglePriceUpdate() {
            const checkbox = document.getElementById('updatePricesCheckbox');
            if (checkbox.checked) {
                // Recalcular precios con valores actuales
                updatePricingSummary();
                showNotification('✅ Se aplicarán los precios actuales al guardar', 'info');
            } else {
                // Usar precios históricos
                updatePricingSummaryWithHistoricalPrices();
                showNotification('📋 Se mantendrán los precios históricos', 'info');
            }
        }
        
        function toggleModuleModification() {
            const checkbox = document.getElementById('allowModificationCheckbox');
            if (checkbox.checked) {
                showNotification('🔓 Ahora puede modificar módulos contratados', 'info');
            } else {
                showNotification('🔒 Módulos contratados protegidos contra modificaciones', 'info');
                // Restaurar módulos contratados si fueron deshabilitados
                if (currentEditingCompany) {
                    const contractedModuleKeys = currentEditingCompany.activeModulesFromDB
                        ? currentEditingCompany.activeModulesFromDB.map(m => m.moduleKey)
                        : currentEditingCompany.modules;
                    contractedModuleKeys.forEach(moduleId => {
                        selectedModules.add(moduleId);
                    });
                }
            }
            generateModulesGrid();
        }
        
        // NUEVA FUNCIÓN: Actualizar resumen con precios reales de la BD
        function updatePricingSummaryWithRealData(moduleData) {
            console.log('💰 Actualizando resumen con precios reales de BD:', moduleData);

            if (!moduleData || !moduleData.success) {
                console.warn('⚠️ No hay datos de módulos, usando cálculo estándar');
                updatePricingSummary();
                return;
            }

            // CRÍTICO: Calcular precio_histórico * empleados_actuales
            const currentEmployees = parseInt(document.getElementById('maxEmployees').value) || 1;
            const activeModules = moduleData.modules?.active || [];

            let realSubtotal = 0;
            activeModules.forEach(module => {
                const historicalPrice = parseFloat(module.contractedPrice || module.tierPrice || 0);
                realSubtotal += historicalPrice * currentEmployees;
            });

            const realTax = realSubtotal * 0.21; // IVA 21%
            const realTotal = realSubtotal + realTax;

            console.log(`💰 Modal: ${currentEmployees} empleados * precios históricos = $${realSubtotal.toFixed(2)}`);

            // Construir lista de módulos con precios reales
            let selectedModulesList = '';

            activeModules.forEach(module => {
                const historicalPrice = parseFloat(module.contractedPrice || module.tierPrice || 0);
                const totalPrice = historicalPrice * currentEmployees;
                selectedModulesList += `
                    <div class="pricing-item">
                        <span>${module.name}</span>
                        <span>$ ${historicalPrice.toFixed(2)} × ${currentEmployees} = $ ${totalPrice.toFixed(2)}</span>
                    </div>
                `;
            });

            // Actualizar la UI con valores reales
            const pricingSidebar = document.querySelector('.pricing-sidebar');
            if (!pricingSidebar) {
                console.error('❌ No se encontró .pricing-sidebar');
                return;
            }

            pricingSidebar.innerHTML = `
                <h4>💰 Resumen de Precios (Valores Reales BD)</h4>
                <div class="selected-modules">
                    <h5>Módulos Contratados:</h5>
                    ${selectedModulesList || '<p style="color: #999;">Sin módulos seleccionados</p>'}
                </div>
                <div class="pricing-breakdown">
                    <div class="pricing-item">
                        <span>Subtotal:</span>
                        <span>$ ${realSubtotal.toFixed(2)}</span>
                    </div>
                    <div class="pricing-item">
                        <span>IVA (21%):</span>
                        <span>$ ${realTax.toFixed(2)}</span>
                    </div>
                    <div class="pricing-item total">
                        <span><strong>Total Mensual:</strong></span>
                        <span><strong>$ ${realTotal.toFixed(2)}</strong></span>
                    </div>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 0.9em; color: #2e7d32;">
                    ✅ <strong>Cálculo Correcto: Precios Históricos × Empleados Actuales</strong><br>
                    Precio por empleado contratado × ${currentEmployees} empleados + IVA 21%
                </div>
            `;
        }

        function updatePricingSummaryForCurrentSelection() {
            if (!currentEditingCompany) {
                updatePricingSummary();
                return;
            }

            const employeeCount = parseInt(document.getElementById('contractedEmployees').value) || 1;
            const pricingSidebar = document.querySelector('.pricing-sidebar');
            if (!pricingSidebar) return;

            let realSubtotal = 0;
            let selectedModulesList = '';

            // Calcular precio de módulos seleccionados
            selectedModules.forEach(moduleKey => {
                const modulePrice = currentEditingCompany.modulesPricing && currentEditingCompany.modulesPricing[moduleKey]
                    ? (currentEditingCompany.modulesPricing[moduleKey].tierPrice || currentEditingCompany.modulesPricing[moduleKey].basePrice)
                    : (pricingConfig.modules[moduleKey] ? pricingConfig.modules[moduleKey].basePrice : 0);

                const totalPrice = modulePrice * employeeCount;
                realSubtotal += totalPrice;

                const moduleName = pricingConfig.modules[moduleKey] ? pricingConfig.modules[moduleKey].name : moduleKey;
                selectedModulesList += `
                    <div class="selected-module">
                        <span>${moduleName}</span>
                        <span>$ ${modulePrice.toFixed(2)} × ${employeeCount} = $ ${totalPrice.toFixed(2)}</span>
                    </div>
                `;
            });

            const realTax = realSubtotal * 0.21;
            const realTotal = realSubtotal + realTax;

            pricingSidebar.innerHTML = `
                <h4>💰 Resumen de Precios (Módulos Seleccionados)</h4>
                <div class="selected-modules">
                    <h5>Módulos Seleccionados (${selectedModules.size}):</h5>
                    ${selectedModulesList || '<p style="color: #999;">Sin módulos seleccionados</p>'}
                </div>
                <div class="pricing-breakdown">
                    <div class="pricing-item">
                        <span>Subtotal:</span>
                        <span>$ ${realSubtotal.toFixed(2)}</span>
                    </div>
                    <div class="pricing-item">
                        <span>IVA (21%):</span>
                        <span>$ ${realTax.toFixed(2)}</span>
                    </div>
                    <div class="pricing-item total">
                        <span><strong>Total Mensual:</strong></span>
                        <span><strong>$ ${realTotal.toFixed(2)}</strong></span>
                    </div>
                </div>
                <div class="calculation-info">
                    <small>✅ Precios históricos × ${employeeCount} empleado${employeeCount !== 1 ? 's' : ''} + IVA 21%</small>
                </div>
            `;

            console.log('💰 Resumen actualizado:', { realSubtotal, realTax, realTotal, selectedModules: selectedModules.size });
        }

        function updatePricingSummaryWithHistoricalPrices() {
            if (!currentEditingCompany || !currentEditingCompany.modulesPricing) {
                updatePricingSummary(); // Fallback a precios actuales
                return;
            }
            
            const employeeCount = parseInt(document.getElementById('maxEmployees').value) || 50;
            let subtotal = 0;
            let selectedModulesList = '';
            
            selectedModules.forEach(moduleId => {
                const historicalModule = currentEditingCompany.modulesPricing[moduleId];
                if (historicalModule) {
                    // Usar precio histórico pero recalcular por empleados actuales
                    const totalPrice = historicalModule.tierPrice * employeeCount;
                    subtotal += totalPrice;
                    
                    selectedModulesList += `
                        <div class="selected-module">
                            <span>${historicalModule.icon} ${historicalModule.name} (histórico)</span>
                            <span>U$S ${totalPrice.toFixed(2)}</span>
                        </div>
                    `;
                } else {
                    // Módulo nuevo, usar precio actual
                    const module = pricingConfig.modules[moduleId];
                    const tier = getCurrentTier(employeeCount);
                    const price = calculateModulePrice(module.basePrice, tier);
                    const totalPrice = price * employeeCount;
                    subtotal += totalPrice;
                    
                    selectedModulesList += `
                        <div class="selected-module">
                            <span>${module.icon} ${module.name} (nuevo)</span>
                            <span>U$S ${totalPrice.toFixed(2)}</span>
                        </div>
                    `;
                }
            });
            
            const tax = subtotal * pricingConfig.taxRate;
            const total = subtotal + tax;

            console.log('💰 Valores calculados - Subtotal:', subtotal, 'Tax:', tax, 'Total:', total);

            const subtotalElement = document.getElementById('subtotal');
            const taxElement = document.getElementById('tax');
            const totalElement = document.getElementById('total');
            const moduleCountElement = document.getElementById('moduleCount');
            const selectedModulesListElement = document.getElementById('selectedModulesList');

            if (subtotalElement) subtotalElement.textContent = subtotal.toFixed(2);
            if (taxElement) taxElement.textContent = tax.toFixed(2);
            if (totalElement) totalElement.textContent = total.toFixed(2);
            if (moduleCountElement) moduleCountElement.textContent = selectedModules.size;
            if (selectedModulesListElement) selectedModulesListElement.innerHTML = selectedModulesList;
            
            // Habilitar botón guardar siempre
            const saveBtn = document.getElementById('saveCompanyBtn');
            if (saveBtn) {
                saveBtn.disabled = false;
            }
        }

        // Funciones para gestión de operadores (solo admin)
        function openNewUserModal() {
            if (currentUser.role !== 'administrador') {
                alert('Solo los administradores pueden crear operadores');
                return;
            }

            const modal = document.getElementById('companyModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = modal.querySelector('.modal-body');

            modalTitle.textContent = 'Nuevo Operador';
            modalBody.innerHTML = `
                <form id="userForm">
                    <div class="form-group">
                        <label class="form-label">Usuario *</label>
                        <input type="text" class="form-input" id="newUsername" required placeholder="Nombre de usuario único">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contraseña *</label>
                        <input type="password" class="form-input" id="newPassword" required placeholder="Mínimo 6 caracteres">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-input" id="newFirstName" placeholder="Nombre del operador">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Apellido</label>
                        <input type="text" class="form-input" id="newLastName" placeholder="Apellido del operador">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="newEmail" placeholder="Email del operador">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Empresa *</label>
                        <select class="form-input" id="newCompanyId" required>
                            <option value="">Seleccionar empresa...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rol</label>
                        <select class="form-input" id="newRole">
                            <option value="employee">Empleado</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-success" onclick="createOperator()" style="flex: 1;">
                            ✅ Crear Operador
                        </button>
                        <button type="button" class="btn" onclick="closeModal()" style="flex: 1; background: #6c757d; color: white;">
                            ❌ Cancelar
                        </button>
                    </div>
                </form>
            `;

            // Cargar empresas en el selector
            loadCompaniesForSelector();

            modal.classList.add('show');
        }

        async function loadCompaniesForSelector() {
            try {
                const response = await fetch(`${API_BASE}/companies`);
                const data = await response.json();

                const selector = document.getElementById('newCompanyId');
                if (selector && data.success) {
                    data.companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.company_id;
                        option.textContent = `${company.name} (ID: ${company.company_id})`;
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error cargando empresas:', error);
            }
        }

        async function createOperator() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const firstName = document.getElementById('newFirstName').value.trim();
            const lastName = document.getElementById('newLastName').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const companyId = parseInt(document.getElementById('newCompanyId').value);
            const role = document.getElementById('newRole').value;

            if (!username || !password) {
                alert('Usuario y contraseña son requeridos');
                return;
            }

            if (!companyId || isNaN(companyId)) {
                alert('Debe seleccionar una empresa válida');
                return;
            }

            if (password.length < 6) {
                alert('La contraseña debe tener al menos 6 caracteres');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/operators`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    },
                    body: JSON.stringify({
                        username,
                        password,
                        firstName: firstName || null,
                        lastName: lastName || null,
                        email: email || null,
                        companyId: companyId,
                        role: role
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert(`✅ Operador "${username}" creado exitosamente`);
                    closeModal();
                    loadOperators();
                } else {
                    alert(data.error || 'Error creando operador');
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión');
            }
        }

        async function deleteOperator(operatorId, username) {
            if (!confirm(`¿Está seguro de eliminar al operador "${username}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/operators/${operatorId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert(`✅ Operador "${username}" eliminado exitosamente`);
                    loadOperators();
                } else {
                    alert(data.error || 'Error eliminando operador');
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión');
            }
        }

        function editOperator(operatorId) {
            // Función para editar operadores (implementar según necesidades)
            alert('Función de edición en desarrollo');
        }

        // Función para cambiar estado de empresa (solo admin)
        async function changeCompanyStatus(companyId, newStatus, reason = '') {
            if (currentUser.role !== 'administrador') {
                alert('Solo los administradores pueden cambiar el estado de las empresas');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/dashboard/companies/${companyId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    },
                    body: JSON.stringify({ status: newStatus, reason })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert(data.message);
                    loadDashboardData(); // Recargar datos
                } else {
                    alert(data.error || 'Error cambiando estado');
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexión');
            }
        }

        // Función para activar empresa suspendida (solo admin)
        function activateCompany(companyId, companyName) {
            if (currentUser.role !== 'administrador') {
                alert('Solo los administradores pueden activar empresas');
                return;
            }

            if (confirm(`¿Activar la empresa "${companyName}" aunque tenga pagos pendientes?`)) {
                changeCompanyStatus(companyId, 'active', 'Activada manualmente por administrador');
            }
        }

        // Cerrar modal al hacer clic fuera (solo en el overlay, no en el contenido)
        window.onclick = function(event) {
            const modal = document.getElementById('companyModal');
            const vendorModal = document.getElementById('vendorModal');
            const mapModal = document.getElementById('mapModal');

            // Solo cerrar si el clic es exactamente en el overlay del modal, no en el contenido
            if (event.target === modal) {
                closeCompanyModal();
            } else if (event.target === vendorModal) {
                closeVendorModal();
            } else if (event.target === mapModal) {
                closeMapModal();
            }
        }

        // Prevenir que clics dentro del contenido del modal cierren el modal
        document.addEventListener('DOMContentLoaded', function() {
            // Agregar event listeners para prevenir propagación en modal content
            const modalContents = document.querySelectorAll('.modal-content, .vendor-modal-content, .map-modal-content');
            modalContents.forEach(content => {
                content.addEventListener('click', function(event) {
                    event.stopPropagation();
                });

                // También prevenir en inputs y selects dentro del modal
                const inputs = content.querySelectorAll('input, select, textarea, button');
                inputs.forEach(input => {
                    input.addEventListener('click', function(event) {
                        event.stopPropagation();
                    });
                    input.addEventListener('mousedown', function(event) {
                        event.stopPropagation();
                    });
                    input.addEventListener('mouseup', function(event) {
                        event.stopPropagation();
                    });
                });
            });
        });

        // ========================================
        // GESTIÓN DE SUCURSALES
        // ========================================
        
        let currentCompanyBranches = [];
        let currentEditingBranch = null;
        let branchModal = null;

        // Cargar sucursales de una empresa
        async function loadCompanyBranches(companyId) {
            console.log('🏢 Cargando sucursales para empresa:', companyId);
            try {
                const response = await fetch(`/api/aponnt/dashboard/branches/${companyId}`);
                console.log('🏢 Respuesta API sucursales:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    currentCompanyBranches = data.branches || [];
                    console.log('🏢 Sucursales cargadas:', currentCompanyBranches.length);
                    renderBranchesContainer();
                } else {
                    console.log('🏢 Error API sucursales:', response.status);
                    currentCompanyBranches = [];
                    renderBranchesContainer();
                }
            } catch (error) {
                console.error('🏢 Error cargando sucursales:', error);
                currentCompanyBranches = [];
                renderBranchesContainer();
            }
        }

        // Renderizar contenedor de sucursales
        function renderBranchesContainer(retryCount = 0) {
            console.log('🏢 Renderizando sucursales, cantidad:', currentCompanyBranches.length);
            let container = document.getElementById('branchesContainer');

            if (!container) {
                console.warn('🏢 Element branchesContainer not found');

                // Buscar la sección de sucursales padre
                const branchesSection = document.getElementById('branchesSection');
                if (branchesSection) {
                    console.log('🔧 Recreando branchesContainer dentro de branchesSection');
                    container = document.createElement('div');
                    container.id = 'branchesContainer';
                    container.style.marginTop = '1rem';
                    branchesSection.appendChild(container);
                } else if (retryCount < 3) {
                    console.log(`🔄 branchesSection tampoco encontrado, reintentando en 200ms... (intento ${retryCount + 1}/3)`);
                    setTimeout(() => renderBranchesContainer(retryCount + 1), 200);
                    return;
                } else {
                    // Como último recurso, insertar la sección completa en el modal
                    console.log('🚨 Última opción: insertando sección de sucursales completa en el modal');
                    const modal = document.getElementById('companyModal');
                    if (modal) {
                        const modalBody = modal.querySelector('.modal-body');
                        if (modalBody) {
                            const branchesHTML = `
                                <div id="branchesSection" style="margin: 2rem 0; padding: 1.5rem; background: #f3e5f5; border-radius: 12px; border: 2px solid #7b1fa2; box-shadow: 0 4px 8px rgba(123, 31, 162, 0.2);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                        <h4 style="color: #7b1fa2; margin: 0; font-size: 1.2rem; font-weight: 600;">🏢 Gestión de Sucursales</h4>
                                        <button type="button" class="btn btn-primary" onclick="openBranchModal()" style="background: #7b1fa2; border-color: #7b1fa2;">
                                            <i class="fas fa-plus"></i> Nueva Sucursal
                                        </button>
                                    </div>
                                    <div id="branchesContainer" style="margin-top: 1rem;">
                                    </div>
                                </div>
                            `;
                            modalBody.insertAdjacentHTML('beforeend', branchesHTML);
                            container = document.getElementById('branchesContainer');
                        }
                    }

                    if (!container) {
                        console.error('❌ No se pudo crear branchesContainer después de todos los intentos');
                        return;
                    }
                }
            }

            console.log('🏢 Container encontrado/creado, renderizando...');

            if (currentCompanyBranches.length === 0) {
                container.innerHTML = `
                    <div class="no-branches" style="text-align: center; color: #666; padding: 1rem;">
                        No hay sucursales registradas
                    </div>
                `;
                return;
            }

            const html = currentCompanyBranches.map(branch => `
                <div class="branch-item" style="
                    display: flex; 
                    align-items: center; 
                    justify-content: space-between; 
                    padding: 0.75rem; 
                    border: 1px solid #ddd; 
                    border-radius: 6px; 
                    margin-bottom: 0.5rem;
                    background: white;
                ">
                    <div style="flex: 1;">
                        <div style="font-weight: 500; color: #333;">${branch.name}</div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                            📍 ${branch.address}, ${branch.city}, ${branch.province}, ${branch.country}
                        </div>
                        ${branch.latitude && branch.longitude ? 
                            `<div style="font-size: 0.7rem; color: #999; margin-top: 0.25rem;">
                                🌐 ${branch.latitude.toFixed(6)}, ${branch.longitude.toFixed(6)}
                            </div>` : ''
                        }
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editBranch(${branch.id})" style="font-size: 0.7rem;">
                            ✏️ Editar
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteBranch(${branch.id})" style="font-size: 0.7rem;">
                            🗑️ Eliminar
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Abrir modal de sucursal
        function openBranchModal(branchId = null) {
            currentEditingBranch = branchId ? currentCompanyBranches.find(b => b.id === branchId) : null;
            
            const modalHtml = `
                <div id="branchModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 600px; margin: 2% auto; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h4>${currentEditingBranch ? 'Editar Sucursal' : 'Nueva Sucursal'}</h4>
                            <span class="close" onclick="closeBranchModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <form id="branchForm" onsubmit="saveBranch(event)">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Nombre de la Sucursal *</label>
                                        <input type="text" id="branchName" class="form-control" required 
                                               value="${currentEditingBranch ? currentEditingBranch.name : ''}"
                                               placeholder="Ej: Sucursal Centro, Oficina Norte">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label>Dirección *</label>
                                        <input type="text" id="branchAddress" class="form-control" required 
                                               value="${currentEditingBranch ? currentEditingBranch.address : ''}"
                                               placeholder="Calle y número"
                                               onchange="handleAddressChange()">
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>Código Postal</label>
                                        <input type="text" id="branchPostalCode" class="form-control" 
                                               value="${currentEditingBranch ? (currentEditingBranch.postalCode || '') : ''}"
                                               placeholder="1000">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label>País *</label>
                                        <select id="branchCountry" class="form-control" required onchange="loadBranchProvinces()">
                                            <option value="">Seleccionar país</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Provincia/Estado *</label>
                                        <select id="branchProvince" class="form-control" required onchange="loadBranchCities()">
                                            <option value="">Seleccionar provincia</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Ciudad *</label>
                                        <select id="branchCity" class="form-control" required onchange="handleCityChange()">
                                            <option value="">Seleccionar ciudad</option>
                                        </select>
                                    </div>
                                </div>

                                <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 6px;">
                                    <h6 style="color: #495057; margin-bottom: 0.75rem;">🌐 Geolocalización</h6>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Latitud</label>
                                            <input type="number" id="branchLatitude" class="form-control" step="any" 
                                                   value="${currentEditingBranch ? (currentEditingBranch.latitude || '') : ''}"
                                                   placeholder="Ej: -34.6037">
                                        </div>
                                        <div class="form-group">
                                            <label>Longitud</label>
                                            <input type="number" id="branchLongitude" class="form-control" step="any"
                                                   value="${currentEditingBranch ? (currentEditingBranch.longitude || '') : ''}"
                                                   placeholder="Ej: -58.3816">
                                        </div>
                                    </div>
                                    <div style="text-align: center; margin-top: 0.75rem;">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="geocodeBranchAddress()">
                                            📍 Obtener coordenadas automáticamente
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="showBranchMap()" style="margin-left: 0.5rem;">
                                            🗺️ Ver en mapa
                                        </button>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #6c757d; margin-top: 0.5rem; text-align: center;">
                                        Las coordenadas se pueden obtener automáticamente desde la dirección o ingresar manualmente
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Teléfono</label>
                                        <input type="text" id="branchPhone" class="form-control" 
                                               value="${currentEditingBranch ? (currentEditingBranch.phone || '') : ''}"
                                               placeholder="011-1234-5678">
                                    </div>
                                    <div class="form-group">
                                        <label>Email</label>
                                        <input type="email" id="branchEmail" class="form-control" 
                                               value="${currentEditingBranch ? (currentEditingBranch.email || '') : ''}"
                                               placeholder="sucursal@empresa.com">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="branchIsActive" 
                                               ${currentEditingBranch ? (currentEditingBranch.isActive ? 'checked' : '') : 'checked'}>
                                        <span>Sucursal activa</span>
                                    </label>
                                </div>

                                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                                        ${currentEditingBranch ? '✏️ Actualizar Sucursal' : '💾 Crear Sucursal'}
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="closeBranchModal()" style="flex: 0 0 auto;">
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            // Remover modal existente si existe
            if (branchModal) {
                branchModal.remove();
            }

            // Crear nuevo modal
            branchModal = document.createElement('div');
            branchModal.innerHTML = modalHtml;
            document.body.appendChild(branchModal);

            // Cargar datos geográficos
            loadBranchCountries();
        }

        // Cerrar modal de sucursal
        function closeBranchModal() {
            if (branchModal) {
                branchModal.remove();
                branchModal = null;
            }
            currentEditingBranch = null;
        }

        // Cargar países para sucursales
        function loadBranchCountries() {
            const countrySelect = document.getElementById('branchCountry');
            if (!countrySelect) return;

            const countries = Object.keys(geographicalData);
            countrySelect.innerHTML = '<option value="">Seleccionar país</option>';
            
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });

            // Seleccionar país actual si existe
            if (currentEditingBranch && currentEditingBranch.country) {
                countrySelect.value = currentEditingBranch.country;
                loadBranchProvinces();
            } else {
                countrySelect.value = 'Argentina'; // Por defecto
                loadBranchProvinces();
            }
        }

        // Cargar provincias para sucursales
        function loadBranchProvinces() {
            const countrySelect = document.getElementById('branchCountry');
            const provinceSelect = document.getElementById('branchProvince');
            if (!countrySelect || !provinceSelect) return;

            const selectedCountry = countrySelect.value;
            provinceSelect.innerHTML = '<option value="">Seleccionar provincia</option>';
            
            if (selectedCountry && geographicalData[selectedCountry]) {
                const provinces = Object.keys(geographicalData[selectedCountry]);
                provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    provinceSelect.appendChild(option);
                });

                // Seleccionar provincia actual si existe
                if (currentEditingBranch && currentEditingBranch.province) {
                    provinceSelect.value = currentEditingBranch.province;
                    loadBranchCities();
                }
            }
        }

        // Cargar ciudades para sucursales
        function loadBranchCities() {
            const countrySelect = document.getElementById('branchCountry');
            const provinceSelect = document.getElementById('branchProvince');
            const citySelect = document.getElementById('branchCity');
            if (!countrySelect || !provinceSelect || !citySelect) return;

            const selectedCountry = countrySelect.value;
            const selectedProvince = provinceSelect.value;
            citySelect.innerHTML = '<option value="">Seleccionar ciudad</option>';
            
            if (selectedCountry && selectedProvince && 
                geographicalData[selectedCountry] && 
                geographicalData[selectedCountry][selectedProvince]) {
                
                const cities = geographicalData[selectedCountry][selectedProvince];
                Object.keys(cities).forEach(cityName => {
                    const option = document.createElement('option');
                    option.value = cityName;
                    option.textContent = cityName;
                    option.dataset.postalCode = cities[cityName];
                    citySelect.appendChild(option);
                });

                // Seleccionar ciudad actual si existe
                if (currentEditingBranch && currentEditingBranch.city) {
                    citySelect.value = currentEditingBranch.city;
                }
            }
        }

        // Manejar cambio de ciudad para sucursales
        function handleCityChange() {
            const citySelect = document.getElementById('branchCity');
            const postalCodeInput = document.getElementById('branchPostalCode');
            if (!citySelect || !postalCodeInput) return;

            const selectedOption = citySelect.options[citySelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.postalCode) {
                postalCodeInput.value = selectedOption.dataset.postalCode;
            }
        }

        // Manejar cambio de dirección
        function handleAddressChange() {
            // Limpiar coordenadas cuando cambia la dirección
            document.getElementById('branchLatitude').value = '';
            document.getElementById('branchLongitude').value = '';
        }

        // Función para validar que la provincia pertenezca al país seleccionado
        function validateProvinceForCountry(country, province) {
            // Definir provincias válidas por país (principales países de América Latina)
            const provincesByCountry = {
                'Argentina': [
                    'Buenos Aires', 'Ciudad Autónoma de Buenos Aires', 'Catamarca', 'Chaco', 'Chubut',
                    'Córdoba', 'Corrientes', 'Entre Ríos', 'Formosa', 'Jujuy', 'La Pampa', 'La Rioja',
                    'Mendoza', 'Misiones', 'Neuquén', 'Río Negro', 'Salta', 'San Juan', 'San Luis',
                    'Santa Cruz', 'Santa Fe', 'Santiago del Estero', 'Tierra del Fuego', 'Tucumán'
                ],
                'Brasil': [
                    'Acre', 'Alagoas', 'Amapá', 'Amazonas', 'Bahia', 'Ceará', 'Distrito Federal',
                    'Espírito Santo', 'Goiás', 'Maranhão', 'Mato Grosso', 'Mato Grosso do Sul',
                    'Minas Gerais', 'Pará', 'Paraíba', 'Paraná', 'Pernambuco', 'Piauí',
                    'Rio de Janeiro', 'Rio Grande do Norte', 'Rio Grande do Sul', 'Rondônia',
                    'Roraima', 'Santa Catarina', 'São Paulo', 'Sergipe', 'Tocantins'
                ],
                'Chile': [
                    'Arica y Parinacota', 'Tarapacá', 'Antofagasta', 'Atacama', 'Coquimbo',
                    'Valparaíso', 'Metropolitana de Santiago', 'O\'Higgins', 'Maule', 'Ñuble',
                    'Biobío', 'La Araucanía', 'Los Ríos', 'Los Lagos', 'Aysén', 'Magallanes'
                ],
                'Colombia': [
                    'Amazonas', 'Antioquia', 'Arauca', 'Atlántico', 'Bolívar', 'Boyacá', 'Caldas',
                    'Caquetá', 'Casanare', 'Cauca', 'Cesar', 'Chocó', 'Córdoba', 'Cundinamarca',
                    'Guainía', 'Guaviare', 'Huila', 'La Guajira', 'Magdalena', 'Meta', 'Nariño',
                    'Norte de Santander', 'Putumayo', 'Quindío', 'Risaralda', 'San Andrés',
                    'Santander', 'Sucre', 'Tolima', 'Valle del Cauca', 'Vaupés', 'Vichada'
                ],
                'México': [
                    'Aguascalientes', 'Baja California', 'Baja California Sur', 'Campeche', 'Chiapas',
                    'Chihuahua', 'Ciudad de México', 'Coahuila', 'Colima', 'Durango', 'Guanajuato',
                    'Guerrero', 'Hidalgo', 'Jalisco', 'México', 'Michoacán', 'Morelos', 'Nayarit',
                    'Nuevo León', 'Oaxaca', 'Puebla', 'Querétaro', 'Quintana Roo', 'San Luis Potosí',
                    'Sinaloa', 'Sonora', 'Tabasco', 'Tamaulipas', 'Tlaxcala', 'Veracruz', 'Yucatán', 'Zacatecas'
                ],
                'Perú': [
                    'Amazonas', 'Áncash', 'Apurímac', 'Arequipa', 'Ayacucho', 'Cajamarca', 'Callao',
                    'Cusco', 'Huancavelica', 'Huánuco', 'Ica', 'Junín', 'La Libertad', 'Lambayeque',
                    'Lima', 'Loreto', 'Madre de Dios', 'Moquegua', 'Pasco', 'Piura', 'Puno',
                    'San Martín', 'Tacna', 'Tumbes', 'Ucayali'
                ],
                'España': [
                    'Andalucía', 'Aragón', 'Asturias', 'Baleares', 'Canarias', 'Cantabria',
                    'Castilla-La Mancha', 'Castilla y León', 'Cataluña', 'Extremadura', 'Galicia',
                    'La Rioja', 'Madrid', 'Murcia', 'Navarra', 'País Vasco', 'Valencia'
                ]
            };

            // Si no tenemos datos del país, permitir cualquier provincia (para países no listados)
            if (!provincesByCountry[country]) {
                return true;
            }

            // Verificar si la provincia está en la lista del país
            const validProvinces = provincesByCountry[country];

            // Buscar coincidencia exacta o parcial (para manejar variaciones en escritura)
            return validProvinces.some(validProvince =>
                validProvince.toLowerCase() === province.toLowerCase() ||
                validProvince.toLowerCase().includes(province.toLowerCase()) ||
                province.toLowerCase().includes(validProvince.toLowerCase())
            );
        }

        // Geocodificar dirección de sucursal
        async function geocodeBranchAddress() {
            const address = document.getElementById('branchAddress').value?.trim();
            const city = document.getElementById('branchCity').value?.trim();
            const province = document.getElementById('branchProvince').value?.trim();
            const country = document.getElementById('branchCountry').value?.trim();

            console.log('🏢 Datos ingresados para sucursal:', { address, city, province, country });

            // Validación más estricta de campos
            const missingFields = [];
            if (!address) missingFields.push('Dirección');
            if (!city) missingFields.push('Ciudad');
            if (!province) missingFields.push('Provincia/Estado');
            if (!country) missingFields.push('País');

            if (missingFields.length > 0) {
                showNotification(`❌ Faltan campos requeridos: ${missingFields.join(', ')}`, 'error');
                return;
            }

            // Validación básica de formato
            if (address.length < 3) {
                showNotification('❌ La dirección debe tener al menos 3 caracteres', 'error');
                return;
            }

            if (city.length < 2) {
                showNotification('❌ La ciudad debe tener al menos 2 caracteres', 'error');
                return;
            }

            // Validar que la provincia esté en el país seleccionado
            if (!validateProvinceForCountry(country, province)) {
                showNotification(`❌ La provincia "${province}" no pertenece a ${country}. Verifique la selección.`, 'error');
                return;
            }

            const fullAddress = `${address}, ${city}, ${province}, ${country}`;
            
            showNotification('🌍 Obteniendo coordenadas...', 'info');

            try {
                const response = await fetch('/api/aponnt/dashboard/branches/geocode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        address: address,
                        city: city,
                        province: province,
                        country: country
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.coordinates) {
                        document.getElementById('branchLatitude').value = data.coordinates.latitude;
                        document.getElementById('branchLongitude').value = data.coordinates.longitude;

                        showNotification(`✅ ${data.message}`, 'success');

                        console.log('📍 Coordenadas obtenidas:', data.coordinates);
                    } else {
                        // Mostrar el mensaje específico de error del backend
                        showNotification(`❌ ${data.message || data.error || 'No se pudieron obtener las coordenadas'}`, 'error');
                    }
                } else {
                    // Manejar errores HTTP
                    const errorData = await response.json().catch(() => ({}));
                    showNotification(`❌ ${errorData.message || 'Error en el servicio de geolocalización'}`, 'error');
                }
            } catch (error) {
                console.error('Error geocodificando:', error);
                showNotification('❌ Error al obtener coordenadas', 'error');
            }
        }

        // Geolocalizar dirección de empresa
        async function geocodeCompanyAddress() {
            console.log('🌍 Iniciando geolocalización de empresa...');

            const address = document.getElementById('address').value?.trim();
            const city = document.getElementById('city').value?.trim();
            const province = document.getElementById('province').value?.trim();
            const country = document.getElementById('country').value?.trim() || 'Argentina';

            // Validación exhaustiva con mensajes específicos
            const missingFields = [];
            if (!address) missingFields.push('Dirección (Ej: Av. Corrientes 1000)');
            if (!city) missingFields.push('Ciudad (Ej: Buenos Aires)');
            if (!province) missingFields.push('Provincia/Estado');

            if (missingFields.length > 0) {
                const message = `❌ CAMPOS REQUERIDOS PARA GEOLOCALIZACIÓN:\n\n${missingFields.join('\n')}\n\nESTOS DATOS SON OBLIGATORIOS para que la APK Android pueda ubicar la empresa correctamente.`;
                alert(message);
                return;
            }

            // Validar formato de dirección
            if (address.length < 5) {
                alert('❌ DIRECCIÓN INCOMPLETA\n\nLa dirección debe ser más específica.\nEjemplo: "Av. Corrientes 1000" o "San Martín 123"');
                document.getElementById('address').focus();
                return;
            }

            const fullAddress = `${address}, ${city}, ${province}, ${country}`;
            console.log('🌍 Dirección completa a geolocalizar:', fullAddress);

            // Mostrar mensaje de progreso
            const progressMessage = `🌍 OBTENIENDO COORDENADAS GPS...\n\nDirección: ${fullAddress}\n\nEspere por favor...`;
            console.log(progressMessage);

            try {
                const response = await fetch('/api/aponnt/dashboard/geocode-company', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: address,
                        city: city,
                        province: province,
                        country: country
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.coordinates) {
                        document.getElementById('companyLatitude').value = data.coordinates.latitude;
                        document.getElementById('companyLongitude').value = data.coordinates.longitude;

                        const successMessage = `✅ COORDENADAS GPS OBTENIDAS EXITOSAMENTE\n\nLatitud: ${data.coordinates.latitude}\nLongitud: ${data.coordinates.longitude}\n\nLa APK Android podrá ubicar esta empresa correctamente.`;
                        alert(successMessage);

                        console.log('📍 Coordenadas de empresa obtenidas:', data.coordinates);
                    } else {
                        // Error específico del servicio
                        const errorMessage = `❌ NO SE PUDO GEOLOCALIZAR LA DIRECCIÓN\n\n${data.message || data.error || 'Dirección no encontrada'}\n\nVERIFIQUE QUE LA DIRECCIÓN SEA CORRECTA:\n• Use formato: "Calle Número"\n• Ciudad existente\n• Provincia correcta\n\nEjemplo válido: "Av. Corrientes 1000, Buenos Aires, CABA"`;
                        alert(errorMessage);
                    }
                } else {
                    // Error HTTP
                    const errorData = await response.json().catch(() => ({}));
                    const httpErrorMessage = `❌ ERROR EN SERVICIO DE GEOLOCALIZACIÓN\n\n${errorData.message || 'Error interno del servidor'}\n\nIntente nuevamente en unos momentos.`;
                    alert(httpErrorMessage);
                }
            } catch (error) {
                console.error('❌ Error geocodificando empresa:', error);
                const networkErrorMessage = `❌ ERROR DE CONEXIÓN\n\nNo se pudo conectar al servicio de geolocalización.\n\nVerifique su conexión a internet e intente nuevamente.`;
                alert(networkErrorMessage);
            }
        }

        // Function to validate company address before geocoding
        async function validateAndGeocodeCompanyAddress(address, city, province, country) {
            // Validación básica de formato
            if (address.length < 3) {
                showNotification('❌ La dirección de la empresa debe tener al menos 3 caracteres', 'error');
                return;
            }

            if (city.length < 2) {
                showNotification('❌ La ciudad debe tener al menos 2 caracteres', 'error');
                return;
            }

            // Validar que la provincia esté en el país seleccionado
            if (!validateProvinceForCountry(country, province)) {
                showNotification(`❌ La provincia "${province}" no pertenece a ${country}. Verifique la selección.`, 'error');
                return;
            }

            const fullAddress = `${address}, ${city}, ${province}, ${country}`;

            showNotification('🌍 Obteniendo coordenadas de la empresa...', 'info');

            try {
                const response = await fetch('/api/aponnt/dashboard/branches/geocode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        address: address,
                        city: city,
                        province: province,
                        country: country
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.coordinates) {
                        document.getElementById('companyLatitude').value = data.coordinates.latitude;
                        document.getElementById('companyLongitude').value = data.coordinates.longitude;

                        showNotification(`✅ Coordenadas de empresa obtenidas: ${data.message}`, 'success');

                        console.log('📍 Coordenadas de empresa obtenidas:', data.coordinates);
                    } else {
                        // Mostrar el mensaje específico de error del backend
                        showNotification(`❌ ${data.message || data.error || 'No se pudieron obtener las coordenadas de la empresa'}`, 'error');
                    }
                } else {
                    // Manejar errores HTTP
                    const errorData = await response.json().catch(() => ({}));
                    showNotification(`❌ ${errorData.message || 'Error en el servicio de geolocalización'}`, 'error');
                }
            } catch (error) {
                console.error('Error geocodificando empresa:', error);
                showNotification('❌ Error al obtener coordenadas de empresa', 'error');
            }
        }

        // Mostrar mapa de empresa
        function showCompanyMap() {
            const latitude = document.getElementById('companyLatitude').value;
            const longitude = document.getElementById('companyLongitude').value;
            const companyName = document.getElementById('companyName').value || 'Empresa';
            const address = document.getElementById('address').value || 'Dirección no especificada';

            if (!latitude || !longitude) {
                showNotification('ℹ️ **IMPORTANTE:** Para abrir el mapa interactivo, primero debe geolocalizar la dirección de la empresa usando el botón "🌍 Geolocalizar". Las coordenadas precisas son fundamentales para el correcto funcionamiento del fichaje de empleados.', 'info');
                return;
            }

            showMapModal(parseFloat(latitude), parseFloat(longitude), companyName, address, 'empresa');
        }

        // Mostrar mapa de sucursal
        function showBranchMap() {
            const latitude = document.getElementById('branchLatitude').value;
            const longitude = document.getElementById('branchLongitude').value;
            const branchName = document.getElementById('branchName').value || 'Sucursal';
            const address = document.getElementById('branchAddress').value || 'Dirección no especificada';

            if (!latitude || !longitude) {
                showNotification('ℹ️ **IMPORTANTE:** Para abrir el mapa interactivo, primero debe geolocalizar la dirección de la sucursal usando el botón "🌍 Geolocalizar". Las coordenadas precisas son fundamentales para el correcto funcionamiento del fichaje de empleados.', 'info');
                return;
            }

            showMapModal(parseFloat(latitude), parseFloat(longitude), branchName, address, 'sucursal');
        }

        // Mostrar modal con mapa interactivo mejorado
        function showMapModal(lat, lng, name, address, type) {
            // Verificar que Leaflet esté disponible
            if (typeof L === 'undefined') {
                showNotification('❌ Error: Librería de mapas no disponible. Recargue la página e intente nuevamente.', 'error');
                return;
            }

            const modalHtml = `
                <div id="mapModal" class="modal" style="display: block; z-index: 10000; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
                    <div class="modal-content" style="max-width: 900px; margin: 1% auto; height: 90vh; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative;">
                        <div class="modal-header" style="padding: 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <h4 style="margin: 0;">🗺️ Ubicación de ${type}: ${name}</h4>
                            <span class="close" onclick="closeMapModal()" style="cursor: pointer; font-size: 1.5rem; padding: 5px; hover: color: red;">&times;</span>
                        </div>
                        <div class="modal-search" style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #eee;">
                            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                                <input type="text" id="mapSearchInput" placeholder="🔍 Buscar dirección en el mapa..."
                                       style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                <button onclick="searchLocationOnMap()" style="padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    🔍 Buscar
                                </button>
                            </div>
                            <div style="font-size: 0.8rem; color: #666;">
                                💡 <strong>Instrucciones:</strong> Puede buscar una dirección arriba O hacer clic directamente en el mapa para seleccionar una nueva ubicación
                            </div>
                        </div>
                        <div class="modal-body" style="padding: 0; height: calc(100% - 180px); position: relative;">
                            <div id="leafletMap" style="height: 100%; width: 100%; z-index: 1;"></div>
                        </div>
                        <div class="modal-footer" style="padding: 1rem; background: #f8f9fa; border-top: 1px solid #eee;">
                            <div id="mapCurrentLocation" style="margin-bottom: 0.5rem;">
                                <p style="margin: 0; color: #666; font-size: 0.9rem;">📍 <span id="mapCurrentAddress">${address}</span></p>
                                <p style="margin: 0; color: #999; font-size: 0.8rem;">Coordenadas: <span id="mapCurrentCoords">${lat.toFixed(6)}, ${lng.toFixed(6)}</span></p>
                            </div>
                            <div style="text-align: center;">
                                <button id="useSelectedLocationBtn" onclick="useSelectedLocation()"
                                        style="padding: 0.5rem 1rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;"
                                        disabled>
                                    ✅ Usar Esta Ubicación
                                </button>
                                <button onclick="closeMapModal()"
                                        style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    ❌ Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remover modal existente si existe
            const existingModal = document.getElementById('mapModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Crear nuevo modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            console.log(`🗺️ Iniciando mapa interactivo para ${type}: ${name} en ${lat}, ${lng}`);

            // Variables globales para el mapa interactivo
            window.currentMapInstance = null;
            window.currentMapMarker = null;
            window.selectedMapLocation = { lat: lat, lng: lng, address: address, type: type };

            // Inicializar mapa después de que el modal esté en el DOM
            setTimeout(() => {
                try {
                    const mapContainer = document.getElementById('leafletMap');
                    if (!mapContainer) {
                        throw new Error('Contenedor del mapa no encontrado');
                    }

                    console.log('🗺️ Creando instancia de Leaflet interactivo...');

                    const map = L.map('leafletMap', {
                        center: [lat, lng],
                        zoom: 16,
                        zoomControl: true,
                        scrollWheelZoom: true
                    });

                    console.log('🗺️ Agregando capa de tiles...');

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 19
                    }).addTo(map);

                    console.log('🗺️ Agregando marcador arrastrable...');

                    // Agregar marcador arrastrable
                    const marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                    marker.bindPopup(`<b>${name}</b><br>${address}`).openPopup();

                    // Almacenar referencias globales
                    window.currentMapInstance = map;
                    window.currentMapMarker = marker;

                    // Eventos del marcador arrastrable
                    marker.on('dragend', async function(e) {
                        const newPos = e.target.getLatLng();
                        console.log('🔄 Marcador movido a:', newPos.lat, newPos.lng);
                        await updateLocationFromCoordinates(newPos.lat, newPos.lng);
                    });

                    // Evento de clic en el mapa para mover el marcador
                    map.on('click', async function(e) {
                        const newPos = e.latlng;
                        console.log('👆 Clic en mapa:', newPos.lat, newPos.lng);

                        // Mover marcador a la nueva posición
                        marker.setLatLng(newPos);
                        map.panTo(newPos);

                        await updateLocationFromCoordinates(newPos.lat, newPos.lng);
                    });

                    // Hacer que el mapa responda a cambios de tamaño
                    setTimeout(() => {
                        map.invalidateSize();
                        console.log('🗺️ Mapa interactivo inicializado correctamente');
                        showNotification('✅ Mapa interactivo cargado. Haga clic para seleccionar nueva ubicación', 'success');
                    }, 200);

                } catch (error) {
                    console.error('❌ Error inicializando mapa:', error);
                    showNotification(`❌ Error al cargar el mapa: ${error.message}`, 'error');
                    closeMapModal();
                }
            }, 300);
        }

        // Cerrar modal de mapa
        function closeMapModal() {
            try {
                const modal = document.getElementById('mapModal');
                if (modal) {
                    // Limpiar instancia del mapa si existe
                    const mapContainer = document.getElementById('leafletMap');
                    if (mapContainer && mapContainer._leaflet_id) {
                        const map = mapContainer._leaflet_id;
                        if (window.L && window.L.DomUtil) {
                            window.L.DomUtil.get(mapContainer._leaflet_id).remove();
                        }
                    }

                    modal.remove();
                    console.log('🗺️ Modal del mapa cerrado correctamente');
                }
            } catch (error) {
                console.error('Error cerrando modal del mapa:', error);
                // Forzar eliminación del modal
                const modal = document.getElementById('mapModal');
                if (modal) {
                    modal.remove();
                }
            }
        }

        // Actualizar ubicación basada en coordenadas (geocodificación inversa)
        async function updateLocationFromCoordinates(lat, lng) {
            try {
                console.log(`🔄 Obteniendo dirección para coordenadas: ${lat}, ${lng}`);
                showNotification('🌍 Obteniendo dirección de la ubicación seleccionada...', 'info');

                // Usar Nominatim para geocodificación inversa
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`, {
                    headers: {
                        'User-Agent': 'Sistema-Biometrico-Empresarial/1.0'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    let addressString = 'Dirección no disponible';

                    if (data && data.address) {
                        const addr = data.address;
                        const parts = [];

                        // Construir dirección ordenada
                        if (addr.house_number) parts.push(addr.house_number);
                        if (addr.road) parts.push(addr.road);
                        if (addr.city || addr.town || addr.village) parts.push(addr.city || addr.town || addr.village);
                        if (addr.state) parts.push(addr.state);
                        if (addr.country) parts.push(addr.country);

                        addressString = parts.length > 0 ? parts.join(', ') : data.display_name;
                    }

                    // Actualizar información en el modal - GUARDAMOS TODOS LOS DATOS
                    window.selectedMapLocation = {
                        lat: lat,
                        lng: lng,
                        address: addressString,
                        fullAddressData: data, // 🔥 IMPORTANTE: Guardamos toda la respuesta de OpenStreetMap
                        type: window.selectedMapLocation?.type || 'ubicación'
                    };

                    // Actualizar elementos del DOM
                    const addressElement = document.getElementById('mapCurrentAddress');
                    const coordsElement = document.getElementById('mapCurrentCoords');
                    const useLocationBtn = document.getElementById('useSelectedLocationBtn');

                    if (addressElement) {
                        addressElement.textContent = addressString;
                    }
                    if (coordsElement) {
                        coordsElement.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    }
                    if (useLocationBtn) {
                        useLocationBtn.disabled = false;
                        useLocationBtn.style.background = '#28a745';
                    }

                    // Actualizar popup del marcador
                    if (window.currentMapMarker) {
                        window.currentMapMarker.bindPopup(`<b>Nueva ubicación seleccionada</b><br>${addressString}`).openPopup();
                    }

                    showNotification('✅ Dirección obtenida exitosamente', 'success');
                    console.log('✅ Dirección obtenida:', addressString);

                } else {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

            } catch (error) {
                console.error('❌ Error obteniendo dirección:', error);

                // Actualizar con coordenadas solamente
                window.selectedMapLocation = {
                    lat: lat,
                    lng: lng,
                    address: `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}`,
                    type: window.selectedMapLocation?.type || 'ubicación'
                };

                const addressElement = document.getElementById('mapCurrentAddress');
                const coordsElement = document.getElementById('mapCurrentCoords');
                const useLocationBtn = document.getElementById('useSelectedLocationBtn');

                if (addressElement) {
                    addressElement.textContent = `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }
                if (coordsElement) {
                    coordsElement.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }
                if (useLocationBtn) {
                    useLocationBtn.disabled = false;
                    useLocationBtn.style.background = '#28a745';
                }

                showNotification('⚠️ No se pudo obtener la dirección, pero las coordenadas están disponibles', 'warning');
            }
        }

        // Buscar ubicación en el mapa
        async function searchLocationOnMap() {
            const searchInput = document.getElementById('mapSearchInput');
            const searchQuery = searchInput.value.trim();

            if (!searchQuery) {
                showNotification('⚠️ Ingrese una dirección para buscar', 'warning');
                return;
            }

            try {
                console.log(`🔍 Buscando: ${searchQuery}`);
                showNotification('🔍 Buscando ubicación en el mapa...', 'info');

                // Usar Nominatim para búsqueda de direcciones
                const encodedQuery = encodeURIComponent(searchQuery);
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedQuery}&limit=1&addressdetails=1`, {
                    headers: {
                        'User-Agent': 'Sistema-Biometrico-Empresarial/1.0'
                    }
                });

                if (response.ok) {
                    const data = await response.json();

                    if (data && data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lng = parseFloat(result.lon);

                        console.log(`✅ Ubicación encontrada: ${lat}, ${lng}`);

                        // Mover mapa y marcador a la nueva ubicación
                        if (window.currentMapInstance && window.currentMapMarker) {
                            window.currentMapInstance.setView([lat, lng], 16);
                            window.currentMapMarker.setLatLng([lat, lng]);

                            // Actualizar información de ubicación
                            await updateLocationFromCoordinates(lat, lng);
                        }

                        showNotification('✅ Ubicación encontrada en el mapa', 'success');

                        // Limpiar input de búsqueda
                        searchInput.value = '';

                    } else {
                        throw new Error('No se encontraron resultados para la búsqueda');
                    }

                } else {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

            } catch (error) {
                console.error('❌ Error en búsqueda:', error);
                showNotification(`❌ Error buscando ubicación: ${error.message}`, 'error');
            }
        }

        // Usar la ubicación seleccionada en el mapa
        function useSelectedLocation() {
            if (!window.selectedMapLocation) {
                showNotification('⚠️ No hay ubicación seleccionada', 'warning');
                return;
            }

            const location = window.selectedMapLocation;
            console.log('✅ Usando ubicación seleccionada:', location);

            try {
                // Determinar si es empresa o sucursal y actualizar campos correspondientes
                if (location.type === 'empresa') {
                    // Actualizar campos de empresa
                    const latField = document.getElementById('companyLatitude');
                    const lngField = document.getElementById('companyLongitude');

                    if (latField) latField.value = location.lat.toFixed(6);
                    if (lngField) lngField.value = location.lng.toFixed(6);

                    // Actualizar dirección con datos completos de OpenStreetMap
                    if (location.address && location.address !== 'Dirección no disponible') {
                        updateCompanyAddressFields(location.address, location.fullAddressData);
                    }

                } else if (location.type === 'sucursal') {
                    // Actualizar campos de sucursal
                    const latField = document.getElementById('branchLatitude');
                    const lngField = document.getElementById('branchLongitude');

                    if (latField) latField.value = location.lat.toFixed(6);
                    if (lngField) lngField.value = location.lng.toFixed(6);

                    // Actualizar dirección con datos completos de OpenStreetMap
                    if (location.address && location.address !== 'Dirección no disponible') {
                        updateBranchAddressFields(location.address, location.fullAddressData);
                    }
                }

                showNotification('✅ Ubicación aplicada exitosamente', 'success');
                closeMapModal();

            } catch (error) {
                console.error('❌ Error aplicando ubicación:', error);
                showNotification(`❌ Error aplicando ubicación: ${error.message}`, 'error');
            }
        }

        // Actualizar campos de dirección de empresa desde la selección del mapa
        function updateCompanyAddressFields(addressString, fullAddressData = null) {
            console.log('🏢 Actualizando campos de empresa:', addressString, fullAddressData);

            // Si tenemos datos completos del API de OpenStreetMap, usarlos
            if (fullAddressData && fullAddressData.address) {
                const addr = fullAddressData.address;
                console.log('🔍 Datos completos de OpenStreetMap:', addr);

                // 🏠 DIRECCIÓN COMPLETA (calle, número, intersecciones)
                const addressField = document.getElementById('address');
                if (addressField) {
                    let streetAddress = '';

                    // Número de casa/edificio
                    if (addr.house_number) {
                        streetAddress += addr.house_number + ' ';
                    }

                    // Calle principal
                    if (addr.road) {
                        streetAddress += addr.road;
                    } else if (addr.street) {
                        streetAddress += addr.street;
                    } else if (addr.pedestrian) {
                        streetAddress += addr.pedestrian;
                    } else if (addr.path) {
                        streetAddress += addr.path;
                    }

                    // Intersecciones o referencias adicionales
                    if (addr.neighbourhood && !streetAddress.includes(addr.neighbourhood)) {
                        streetAddress += (streetAddress ? ', ' : '') + addr.neighbourhood;
                    }
                    if (addr.suburb && !streetAddress.includes(addr.suburb)) {
                        streetAddress += (streetAddress ? ', ' : '') + addr.suburb;
                    }

                    if (streetAddress.trim()) {
                        addressField.value = streetAddress.trim();
                        console.log('✅ Dirección actualizada:', streetAddress.trim());
                    } else {
                        addressField.value = addressString;
                        console.log('✅ Dirección de fallback:', addressString);
                    }
                }

                // 🏙️ CIUDAD (múltiples variantes de OpenStreetMap)
                const cityField = document.getElementById('city');
                if (cityField) {
                    const city = addr.city ||
                                addr.town ||
                                addr.village ||
                                addr.municipality ||
                                addr.city_district ||
                                addr.district ||
                                addr.county ||
                                '';
                    if (city && (!cityField.value || cityField.value.trim() === '')) {
                        cityField.value = city;
                        console.log('✅ Ciudad actualizada:', city);
                    }
                }

                // 🗺️ PROVINCIA/ESTADO (múltiples variantes)
                const provinceField = document.getElementById('province');
                if (provinceField) {
                    const province = addr.state ||
                                   addr.province ||
                                   addr.region ||
                                   addr.state_district ||
                                   addr.administrative_area_level_1 ||
                                   '';
                    if (province && (!provinceField.value || provinceField.value.trim() === '')) {
                        provinceField.value = province;
                        console.log('✅ Provincia actualizada:', province);
                    }
                }

                // 🌍 PAÍS
                const countryField = document.getElementById('country');
                if (countryField) {
                    const country = addr.country || addr.country_code || '';
                    if (country && (!countryField.value || countryField.value.trim() === '')) {
                        countryField.value = country;
                        console.log('✅ País actualizado:', country);
                    }
                }

                // 📮 CÓDIGO POSTAL
                const postalCodeField = document.getElementById('postalCode');
                if (postalCodeField) {
                    const postalCode = addr.postcode || addr.postal_code || '';
                    if (postalCode && (!postalCodeField.value || postalCodeField.value.trim() === '')) {
                        postalCodeField.value = postalCode;
                        console.log('✅ Código postal actualizado:', postalCode);
                    }
                }

                console.log('✅ Campos de empresa actualizados con datos detallados de OpenStreetMap');

            } else {
                // Solo tenemos la dirección como string, actualizar campo principal
                const addressField = document.getElementById('address');
                if (addressField) {
                    addressField.value = addressString;
                }
                console.log('✅ Campo principal de empresa actualizado con string básico');
            }
        }

        // Actualizar campos de dirección de sucursal desde la selección del mapa
        function updateBranchAddressFields(addressString, fullAddressData = null) {
            console.log('🏪 Actualizando campos de sucursal:', addressString, fullAddressData);

            // Si tenemos datos completos del API de OpenStreetMap, usarlos
            if (fullAddressData && fullAddressData.address) {
                const addr = fullAddressData.address;
                console.log('🔍 Datos completos de OpenStreetMap para sucursal:', addr);

                // 🏠 DIRECCIÓN COMPLETA (calle, número, intersecciones)
                const addressField = document.getElementById('branchAddress');
                if (addressField) {
                    let streetAddress = '';

                    // Número de casa/edificio
                    if (addr.house_number) {
                        streetAddress += addr.house_number + ' ';
                    }

                    // Calle principal
                    if (addr.road) {
                        streetAddress += addr.road;
                    } else if (addr.street) {
                        streetAddress += addr.street;
                    } else if (addr.pedestrian) {
                        streetAddress += addr.pedestrian;
                    } else if (addr.path) {
                        streetAddress += addr.path;
                    }

                    // Intersecciones o referencias adicionales
                    if (addr.neighbourhood && !streetAddress.includes(addr.neighbourhood)) {
                        streetAddress += (streetAddress ? ', ' : '') + addr.neighbourhood;
                    }
                    if (addr.suburb && !streetAddress.includes(addr.suburb)) {
                        streetAddress += (streetAddress ? ', ' : '') + addr.suburb;
                    }

                    if (streetAddress.trim()) {
                        addressField.value = streetAddress.trim();
                        console.log('✅ Dirección de sucursal actualizada:', streetAddress.trim());
                    } else {
                        addressField.value = addressString;
                        console.log('✅ Dirección de sucursal de fallback:', addressString);
                    }
                }

                // 🏙️ CIUDAD (múltiples variantes de OpenStreetMap)
                const cityField = document.getElementById('branchCity');
                if (cityField) {
                    const city = addr.city ||
                                addr.town ||
                                addr.village ||
                                addr.municipality ||
                                addr.city_district ||
                                addr.district ||
                                addr.county ||
                                '';
                    if (city && (!cityField.value || cityField.value.trim() === '')) {
                        cityField.value = city;
                        console.log('✅ Ciudad de sucursal actualizada:', city);
                    }
                }

                // 🗺️ PROVINCIA/ESTADO (múltiples variantes)
                const provinceField = document.getElementById('branchProvince');
                if (provinceField) {
                    const province = addr.state ||
                                   addr.province ||
                                   addr.region ||
                                   addr.state_district ||
                                   addr.administrative_area_level_1 ||
                                   '';
                    if (province && (!provinceField.value || provinceField.value.trim() === '')) {
                        provinceField.value = province;
                        console.log('✅ Provincia de sucursal actualizada:', province);
                    }
                }

                // 🌍 PAÍS
                const countryField = document.getElementById('branchCountry');
                if (countryField) {
                    const country = addr.country || addr.country_code || '';
                    if (country && (!countryField.value || countryField.value.trim() === '')) {
                        countryField.value = country;
                        console.log('✅ País de sucursal actualizado:', country);
                    }
                }

                // 📮 CÓDIGO POSTAL
                const postalCodeField = document.getElementById('branchPostalCode');
                if (postalCodeField) {
                    const postalCode = addr.postcode || addr.postal_code || '';
                    if (postalCode && (!postalCodeField.value || postalCodeField.value.trim() === '')) {
                        postalCodeField.value = postalCode;
                        console.log('✅ Código postal de sucursal actualizado:', postalCode);
                    }
                }

                console.log('✅ Campos de sucursal actualizados con datos detallados de OpenStreetMap');

            } else {
                // Solo tenemos la dirección como string, actualizar campo principal
                const addressField = document.getElementById('branchAddress');
                if (addressField) {
                    addressField.value = addressString;
                }
                console.log('✅ Campo principal de sucursal actualizado con string básico');
            }
        }

        // También agregar listener para cerrar con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const mapModal = document.getElementById('mapModal');
                if (mapModal) {
                    closeMapModal();
                }
            }
        });

        // Agregar listener para Enter en el input de búsqueda
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const searchInput = document.getElementById('mapSearchInput');
                if (searchInput && document.activeElement === searchInput) {
                    event.preventDefault();
                    searchLocationOnMap();
                }
            }
        });

        // Función para aproximación gradual de direcciones
        let geocodingTimeout = null;

        async function approximateLocationFromFields(type = 'empresa') {
            // Cancelar timeout anterior si existe
            if (geocodingTimeout) {
                clearTimeout(geocodingTimeout);
            }

            // Esperar 1 segundo después de que el usuario deje de escribir
            geocodingTimeout = setTimeout(async () => {
                try {
                    let address = '';
                    let city = '';
                    let province = '';
                    let country = '';
                    let postalCode = '';

                    if (type === 'empresa') {
                        const addressField = document.getElementById('address');
                        const cityField = document.getElementById('city');
                        const provinceField = document.getElementById('province');
                        const countryField = document.getElementById('country');
                        const postalCodeField = document.getElementById('postalCode');

                        address = addressField ? addressField.value.trim() : '';
                        city = cityField ? cityField.value.trim() : '';
                        province = provinceField ? provinceField.value.trim() : '';
                        country = countryField ? countryField.value.trim() : '';
                        postalCode = postalCodeField ? postalCodeField.value.trim() : '';
                    } else {
                        const addressField = document.getElementById('branchAddress');
                        const cityField = document.getElementById('branchCity');
                        const provinceField = document.getElementById('branchProvince');
                        const countryField = document.getElementById('branchCountry');
                        const postalCodeField = document.getElementById('branchPostalCode');

                        address = addressField ? addressField.value.trim() : '';
                        city = cityField ? cityField.value.trim() : '';
                        province = provinceField ? provinceField.value.trim() : '';
                        country = countryField ? countryField.value.trim() : '';
                        postalCode = postalCodeField ? postalCodeField.value.trim() : '';
                    }

                    // Construir dirección para búsqueda progresiva
                    const addressParts = [];
                    if (address) addressParts.push(address);
                    if (city) addressParts.push(city);
                    if (province) addressParts.push(province);
                    if (country) addressParts.push(country);
                    if (postalCode) addressParts.push(postalCode);

                    const searchQuery = addressParts.join(', ');

                    // Solo buscar si tenemos al menos ciudad o país
                    if (city || country) {
                        console.log(`🔍 Aproximación gradual (${type}):`, searchQuery);

                        // Usar la misma API de OpenStreetMap
                        const encodedQuery = encodeURIComponent(searchQuery);
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedQuery}&limit=1&addressdetails=1`, {
                            headers: {
                                'User-Agent': 'Sistema-Biometrico-Empresarial/1.0'
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();

                            if (data && data.length > 0) {
                                const result = data[0];
                                const lat = parseFloat(result.lat);
                                const lng = parseFloat(result.lon);

                                console.log(`✅ Aproximación encontrada (${type}):`, lat, lng);
                                console.log('🔍 Datos de aproximación:', result);

                                // Actualizar coordenadas automáticamente (SIN MOSTRAR MAPA)
                                if (type === 'empresa') {
                                    const latField = document.getElementById('companyLatitude');
                                    const lngField = document.getElementById('companyLongitude');
                                    if (latField) latField.value = lat.toFixed(6);
                                    if (lngField) lngField.value = lng.toFixed(6);

                                    // También completar campos faltantes con datos de la aproximación
                                    if (result.address) {
                                        const addr = result.address;

                                        // Solo llenar campos que estén vacíos
                                        const cityField = document.getElementById('city');
                                        if (cityField && (!cityField.value || cityField.value.trim() === '')) {
                                            const city = addr.city || addr.town || addr.village || addr.municipality || '';
                                            if (city) {
                                                cityField.value = city;
                                                console.log('🏙️ Ciudad auto-completada (empresa):', city);
                                            }
                                        }

                                        const provinceField = document.getElementById('province');
                                        if (provinceField && (!provinceField.value || provinceField.value.trim() === '')) {
                                            const province = addr.state || addr.province || addr.region || '';
                                            if (province) {
                                                provinceField.value = province;
                                                console.log('🗺️ Provincia auto-completada (empresa):', province);
                                            }
                                        }

                                        const countryField = document.getElementById('country');
                                        if (countryField && (!countryField.value || countryField.value.trim() === '')) {
                                            const country = addr.country || '';
                                            if (country) {
                                                countryField.value = country;
                                                console.log('🌍 País auto-completado (empresa):', country);
                                            }
                                        }

                                        const postalCodeField = document.getElementById('postalCode');
                                        if (postalCodeField && (!postalCodeField.value || postalCodeField.value.trim() === '')) {
                                            const postalCode = addr.postcode || '';
                                            if (postalCode) {
                                                postalCodeField.value = postalCode;
                                                console.log('📮 Código postal auto-completado (empresa):', postalCode);
                                            }
                                        }
                                    }

                                } else {
                                    const latField = document.getElementById('branchLatitude');
                                    const lngField = document.getElementById('branchLongitude');
                                    if (latField) latField.value = lat.toFixed(6);
                                    if (lngField) lngField.value = lng.toFixed(6);

                                    // También completar campos faltantes con datos de la aproximación
                                    if (result.address) {
                                        const addr = result.address;

                                        // Solo llenar campos que estén vacíos
                                        const cityField = document.getElementById('branchCity');
                                        if (cityField && (!cityField.value || cityField.value.trim() === '')) {
                                            const city = addr.city || addr.town || addr.village || addr.municipality || '';
                                            if (city) {
                                                cityField.value = city;
                                                console.log('🏙️ Ciudad auto-completada (sucursal):', city);
                                            }
                                        }

                                        const provinceField = document.getElementById('branchProvince');
                                        if (provinceField && (!provinceField.value || provinceField.value.trim() === '')) {
                                            const province = addr.state || addr.province || addr.region || '';
                                            if (province) {
                                                provinceField.value = province;
                                                console.log('🗺️ Provincia auto-completada (sucursal):', province);
                                            }
                                        }

                                        const countryField = document.getElementById('branchCountry');
                                        if (countryField && (!countryField.value || countryField.value.trim() === '')) {
                                            const country = addr.country || '';
                                            if (country) {
                                                countryField.value = country;
                                                console.log('🌍 País auto-completado (sucursal):', country);
                                            }
                                        }

                                        const postalCodeField = document.getElementById('branchPostalCode');
                                        if (postalCodeField && (!postalCodeField.value || postalCodeField.value.trim() === '')) {
                                            const postalCode = addr.postcode || '';
                                            if (postalCode) {
                                                postalCodeField.value = postalCode;
                                                console.log('📮 Código postal auto-completado (sucursal):', postalCode);
                                            }
                                        }
                                    }
                                }

                                // Mostrar notificación sutil
                                showNotification(`📍 Ubicación aproximada encontrada para: ${searchQuery}`, 'info');
                            }
                        }
                    }

                } catch (error) {
                    console.log('ℹ️ Aproximación no disponible:', error.message);
                    // No mostrar error al usuario, es solo aproximación
                }
            }, 1500); // Esperar 1.5 segundos
        }

        // Agregar listeners a los campos de dirección de empresa
        document.addEventListener('DOMContentLoaded', function() {
            // Empresa
            const companyFields = ['address', 'city', 'province', 'country', 'postalCode'];
            companyFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => approximateLocationFromFields('empresa'));
                }
            });

            // Sucursales
            const branchFields = ['branchAddress', 'branchCity', 'branchProvince', 'branchCountry', 'branchPostalCode'];
            branchFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => approximateLocationFromFields('sucursal'));
                }
            });
        });

        // Guardar sucursal
        async function saveBranch(event) {
            event.preventDefault();

            const companyId = currentEditingCompany ? currentEditingCompany.id : null;
            if (!companyId) {
                showNotification('❌ Error: No se puede determinar la empresa', 'error');
                return;
            }

            const branchData = {
                companyId: companyId,
                name: document.getElementById('branchName').value,
                address: document.getElementById('branchAddress').value,
                city: document.getElementById('branchCity').value,
                province: document.getElementById('branchProvince').value,
                country: document.getElementById('branchCountry').value,
                postalCode: document.getElementById('branchPostalCode').value,
                phone: document.getElementById('branchPhone').value.trim() || null,
                email: document.getElementById('branchEmail').value.trim() || null,
                isActive: document.getElementById('branchIsActive').checked
            };

            // Agregar coordenadas si están disponibles
            const latitude = document.getElementById('branchLatitude').value;
            const longitude = document.getElementById('branchLongitude').value;
            if (latitude && longitude) {
                branchData.latitude = parseFloat(latitude);
                branchData.longitude = parseFloat(longitude);
            }

            try {
                let response;
                if (currentEditingBranch) {
                    // Actualizar sucursal existente
                    response = await fetch(`/api/aponnt/dashboard/branches/${currentEditingBranch.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(branchData)
                    });
                } else {
                    // Crear nueva sucursal
                    response = await fetch('/api/aponnt/dashboard/branches', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(branchData)
                    });
                }

                if (response.ok) {
                    showNotification(`✅ Sucursal ${currentEditingBranch ? 'actualizada' : 'creada'} exitosamente`, 'success');
                    closeBranchModal();
                    // Pequeño delay para asegurar que el modal se cierre antes de recargar
                    setTimeout(() => {
                        loadCompanyBranches(companyId);
                    }, 100);
                } else {
                    const errorData = await response.json();
                    showNotification(`❌ Error al ${currentEditingBranch ? 'actualizar' : 'crear'} sucursal: ${errorData.message}`, 'error');
                }
            } catch (error) {
                console.error('Error guardando sucursal:', error);
                showNotification(`❌ Error al ${currentEditingBranch ? 'actualizar' : 'crear'} sucursal`, 'error');
            }
        }

        // Editar sucursal
        function editBranch(branchId) {
            openBranchModal(branchId);
        }

        // Eliminar sucursal
        async function deleteBranch(branchId) {
            if (!confirm('¿Está seguro de que desea eliminar esta sucursal?')) {
                return;
            }

            try {
                const response = await fetch(`/api/aponnt/dashboard/branches/${branchId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('✅ Sucursal eliminada exitosamente', 'success');
                    loadCompanyBranches(currentEditingCompany.id);
                } else {
                    const errorData = await response.json();
                    showNotification(`❌ Error al eliminar sucursal: ${errorData.message}`, 'error');
                }
            } catch (error) {
                console.error('Error eliminando sucursal:', error);
                showNotification('❌ Error al eliminar sucursal', 'error');
            }
        }

        // ==================== FUNCIONES DE GESTIÓN DE USUARIOS ====================
        
        // Variable para almacenar usuarios de la empresa actual
        let currentCompanyUsers = [];

        // Cargar usuarios de la empresa
        async function loadCompanyUsers() {
            if (!currentEditingCompany) {
                showNotification('⚠️ Seleccione una empresa primero', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/aponnt/dashboard/users/${currentEditingCompany.id}`);
                if (response.ok) {
                    const data = await response.json();
                    currentCompanyUsers = data.users || [];
                    renderUsersContainer();
                    showNotification(`✅ ${currentCompanyUsers.length} usuarios cargados`, 'success');
                } else {
                    currentCompanyUsers = [];
                    renderUsersContainer();
                    showNotification('⚠️ No se pudieron cargar los usuarios', 'warning');
                }
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                currentCompanyUsers = [];
                renderUsersContainer();
                showNotification('❌ Error al cargar usuarios', 'error');
            }
        }

        // Renderizar contenedor de usuarios
        function renderUsersContainer() {
            const container = document.getElementById('usersContainer');
            
            if (currentCompanyUsers.length === 0) {
                container.innerHTML = `
                    <div class="no-users" style="text-align: center; color: #666; padding: 1rem;">
                        No hay usuarios administradores registrados
                    </div>
                `;
                return;
            }

            const html = currentCompanyUsers.map(user => `
                <div class="user-item" style="
                    display: flex; 
                    align-items: center; 
                    justify-content: space-between; 
                    padding: 1rem; 
                    border: 1px solid #ddd; 
                    border-radius: 8px; 
                    margin-bottom: 0.75rem;
                    background: white;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                ">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1976d2; font-size: 1rem;">
                            👤 ${user.usuario}
                        </div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                            📧 ${user.email} | 👨‍💼 ${user.firstName} ${user.lastName}
                        </div>
                        <div style="font-size: 0.8rem; color: #999; margin-top: 0.25rem;">
                            🔑 Rol: ${user.role === 'company_admin' ? 'Administrador de Empresa' : user.role}
                            ${user.isCompanyAdmin ? ' | ⭐ Admin Principal' : ''}
                        </div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <span>🔐 <strong>Contraseña actual:</strong></span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="password" 
                                           id="currentPassword_${user.user_id}" 
                                           value="123" 
                                           readonly 
                                           style="
                                               font-family: monospace; 
                                               background: #fff; 
                                               border: 1px solid #ddd; 
                                               border-radius: 4px; 
                                               padding: 0.25rem 0.5rem; 
                                               font-size: 0.75rem;
                                               width: 80px;
                                           ">
                                    <button type="button" 
                                            onclick="togglePasswordVisibility('currentPassword_${user.user_id}')" 
                                            style="
                                                background: none; 
                                                border: none; 
                                                cursor: pointer; 
                                                font-size: 0.8rem;
                                                padding: 0.25rem;
                                            ">👁️</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-left: 1rem;">
                        <button type="button" 
                                class="btn btn-sm btn-warning" 
                                onclick="resetUserPassword(${user.user_id}, '${user.usuario}')"
                                style="font-size: 0.75rem; white-space: nowrap;">
                            🔄 Resetear a "123"
                        </button>
                        <button type="button" 
                                class="btn btn-sm btn-primary" 
                                onclick="changeUserPassword(${user.user_id}, '${user.usuario}')"
                                style="font-size: 0.75rem; white-space: nowrap;">
                            ✏️ Cambiar
                        </button>
                        <button type="button" 
                                class="btn btn-sm btn-info" 
                                onclick="testUserLogin('${user.usuario}')"
                                style="font-size: 0.75rem; white-space: nowrap;">
                            🧪 Probar Login
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // Alternar visibilidad de contraseña
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        }

        // Resetear contraseña de usuario a "123"
        async function resetUserPassword(userId, username) {
            if (!confirm(`¿Está seguro de resetear la contraseña de "${username}" a "123"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/aponnt/dashboard/users/reset-password/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification(`✅ ${data.message}`, 'success');
                    // Actualizar la vista de contraseña
                    const passwordInput = document.getElementById(`currentPassword_${userId}`);
                    if (passwordInput) {
                        passwordInput.value = '123';
                    }
                } else {
                    const errorData = await response.json();
                    showNotification(`❌ Error: ${errorData.error}`, 'error');
                }
            } catch (error) {
                console.error('Error reseteando contraseña:', error);
                showNotification('❌ Error al resetear contraseña', 'error');
            }
        }

        // Cambiar contraseña de usuario
        async function changeUserPassword(userId, username) {
            const newPassword = prompt(`Ingrese la nueva contraseña para "${username}":`);
            if (!newPassword) {
                return;
            }
            
            if (newPassword.length < 3) {
                showNotification('⚠️ La contraseña debe tener al menos 3 caracteres', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/aponnt/dashboard/users/change-password/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newPassword: newPassword })
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification(`✅ ${data.message}`, 'success');
                    // Actualizar la vista de contraseña
                    const passwordInput = document.getElementById(`currentPassword_${userId}`);
                    if (passwordInput) {
                        passwordInput.value = newPassword;
                    }
                } else {
                    const errorData = await response.json();
                    showNotification(`❌ Error: ${errorData.error}`, 'error');
                }
            } catch (error) {
                console.error('Error cambiando contraseña:', error);
                showNotification('❌ Error al cambiar contraseña', 'error');
            }
        }

        /* ✅ CÓDIGO FUNCIONAL PROTEGIDO - NO MODIFICAR SIN ANÁLISIS
         * 📅 Fecha: 23/SEP/2025 04:05:00
         * 🏷️ Versión: v2.1.2-LOGIN
         * 📋 Funcionalidad: Sistema de login administrativo - TEST Y VALIDACIÓN
         */
        // Probar login de usuario
        async function testUserLogin(username) {
            // Obtener la contraseña actual del input
            const userId = currentCompanyUsers.find(u => u.username === username)?.id;
            if (!userId) {
                showNotification('❌ Usuario no encontrado', 'error');
                return;
            }
            
            const passwordInput = document.getElementById(`currentPassword_${userId}`);
            const password = passwordInput ? passwordInput.value : '123';

            try {
                const response = await fetch('/api/aponnt/dashboard/users/authenticate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        username: username, 
                        password: password 
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification(`✅ Login exitoso para "${username}"! Token generado.`, 'success');
                    console.log('Usuario autenticado:', data.user);
                    console.log('Token:', data.token);
                } else {
                    const errorData = await response.json();
                    showNotification(`❌ Login fallido para "${username}": ${errorData.error}`, 'error');
                }
            } catch (error) {
                console.error('Error probando login:', error);
                showNotification('❌ Error al probar login', 'error');
            }
        }

        // Cargar usuarios automáticamente al abrir una empresa
        function loadCompanyUsersAutomatically() {
            if (currentEditingCompany) {
                loadCompanyUsers();
            }
        }

        // ==================== FUNCIONES DEL MÓDULO DE FACTURACIÓN ====================

        let billingData = [];

        // Generar canon mensual para todas las empresas activas
        async function generateMonthlyCanon() {
            try {
                const loadingBtn = document.querySelector('button[onclick="generateMonthlyCanon()"]');
                if (loadingBtn) {
                    loadingBtn.innerHTML = '⏳ Generando...';
                    loadingBtn.disabled = true;
                }

                const currentDate = new Date();
                const month = currentDate.getMonth() + 1;
                const year = currentDate.getFullYear();

                console.log(`📊 Generando canon mensual para ${month}/${year}...`);

                const response = await fetch(`${API_BASE}/dashboard/generate-monthly-invoices`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token') || ''}`
                    },
                    body: JSON.stringify({
                        month: month,
                        year: year,
                        paymentMethod: 'transferencia',
                        vendor: 'Aponnt'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Canon generado exitosamente:', result);
                    showNotification(`✅ ${result.generated} facturas generadas para ${month}/${year}`, 'success');
                    
                    // Recargar datos de facturación
                    await loadBillingData();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('❌ Error generando canon:', error);
                showNotification('❌ Error generando canon mensual', 'error');
            } finally {
                const loadingBtn = document.querySelector('button[onclick="generateMonthlyCanon()"]');
                if (loadingBtn) {
                    loadingBtn.innerHTML = '💰 Generar Canon Mensual';
                    loadingBtn.disabled = false;
                }
            }
        }

        // Cargar datos de facturación
        async function loadBillingData() {
            try {
                console.log('📥 Cargando datos de facturación...');

                // Obtener filtros (con validación de elementos)
                const filterMonthEl = document.getElementById('filterMonth');
                const filterYearEl = document.getElementById('filterYear');
                const filterVendorEl = document.getElementById('filterVendor');
                const filterPaymentStatusEl = document.getElementById('filterPaymentStatus');
                
                const filterMonth = filterMonthEl ? filterMonthEl.value : '';
                const filterYear = filterYearEl ? filterYearEl.value : '';
                const filterVendor = filterVendorEl ? filterVendorEl.value : '';
                const filterPaymentStatus = filterPaymentStatusEl ? filterPaymentStatusEl.value : '';

                // Construir parámetros de consulta
                const params = new URLSearchParams();
                if (filterMonth) params.append('month', filterMonth);
                if (filterYear) params.append('year', filterYear);
                if (filterVendor) params.append('vendor', filterVendor);
                if (filterPaymentStatus) params.append('isPaid', filterPaymentStatus);

                // Panel administrativo - usar datos mock directamente
                console.log('🔓 Modo administrativo - cargando datos mock');
                billingData = generateMockBillingData();
                console.log(`✅ ${billingData.length} pagos cargados (mock)`);

                renderBillingTable();
                calculateBillingTotals();
            } catch (error) {
                console.error('❌ Error cargando facturación:', error);
                showNotification('❌ Error cargando datos de facturación', 'error');
                
                // Mostrar datos mock para desarrollo
                billingData = generateMockBillingData();
                renderBillingTable();
                calculateBillingTotals();
                showNotification('⚠️ Usando datos de ejemplo (sin conexión a servidor)', 'warning');
            }
        }

        // Generar datos mock para desarrollo
        function generateMockBillingData() {
            const mockData = [];
            const companies = JSON.parse(localStorage.getItem('companies') || '[]');
            
            companies.forEach(company => {
                if (company.status === 'active' && company.isActive) {
                    // Calcular total basado en módulos activos
                    let totalAmount = 0;
                    if (company.modulesPricing) {
                        Object.values(company.modulesPricing).forEach(module => {
                            totalAmount += module.totalPrice || 0;
                        });
                    }
                    
                    if (totalAmount > 0) {
                        const subtotal = totalAmount / 1.21;
                        const commissionAmount = subtotal * (company.commissionPercentage || 10) / 100;
                        const aponntAmount = totalAmount - commissionAmount;
                        
                        mockData.push({
                            id: Date.now() + Math.random(),
                            companyId: company.company_id,
                            companyName: company.name,
                            vendor: company.vendor || 'Sin asignar',
                            month: new Date().getMonth() + 1,
                            year: new Date().getFullYear(),
                            paymentDate: new Date().toISOString().split('T')[0],
                            totalAmount: parseFloat(totalAmount.toFixed(2)),
                            subtotal: parseFloat(subtotal.toFixed(2)),
                            commissionPercentage: company.commissionPercentage || 10,
                            commissionAmount: parseFloat(commissionAmount.toFixed(2)),
                            aponntAmount: parseFloat(aponntAmount.toFixed(2)),
                            totalAmountUSD: 0,
                            paymentMethod: 'transferencia',
                            isPaid: Math.random() > 0.3,
                            notes: ''
                        });
                    }
                }
            });
            
            return mockData;
        }

        // Renderizar tabla de facturación
        function renderBillingTable() {
            const container = document.getElementById('billingTableContainer');
            
            // Verificar que el contenedor existe
            if (!container) {
                console.warn('⚠️ Contenedor billingTableContainer no encontrado');
                return;
            }
            
            if (!billingData || billingData.length === 0) {
                container.innerHTML = `
                    <div class="billing-card">
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            📄 No hay facturas para mostrar
                            <br><br>
                            <button class="btn btn-primary" onclick="generateMonthlyCanon()">
                                💰 Generar Canon Mensual
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <div class="billing-card">
                    <div class="billing-header">
                        <h3>📋 Listado de Facturas</h3>
                        <div>Total: ${billingData.length} registros</div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="billing-table">
                            <thead>
                                <tr>
                                    <th>Empresa</th>
                                    <th>Vendedor</th>
                                    <th>Período</th>
                                    <th>Total</th>
                                    <th>Subtotal</th>
                                    <th>Comisión (%)</th>
                                    <th>Comisión ($)</th>
                                    <th>Aponnt ($)</th>
                                    <th>Estado</th>
                                    <th>Método Pago</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${billingData.map(payment => `
                                    <tr class="${!payment.isPaid ? 'unpaid' : ''}">
                                        <td><strong>${payment.companyName}</strong></td>
                                        <td>${payment.vendor}</td>
                                        <td>${payment.month}/${payment.year}</td>
                                        <td class="amount">$${payment.totalAmount.toLocaleString()}</td>
                                        <td class="amount">$${payment.subtotal.toLocaleString()}</td>
                                        <td>${payment.commissionPercentage}%</td>
                                        <td class="amount commission">$${payment.commissionAmount.toLocaleString()}</td>
                                        <td class="amount aponnt">$${payment.aponntAmount.toLocaleString()}</td>
                                        <td>
                                            <span class="status ${payment.isPaid ? 'paid' : 'unpaid'}">
                                                ${payment.isPaid ? '✅ Pagado' : '⏳ Pendiente'}
                                            </span>
                                        </td>
                                        <td>${payment.paymentMethod}</td>
                                        <td>
                                            <button class="btn-action" onclick="togglePaymentStatus(${payment.id})" 
                                                    title="${payment.isPaid ? 'Marcar como pendiente' : 'Marcar como pagado'}">
                                                ${payment.isPaid ? '⏳' : '✅'}
                                            </button>
                                            <button class="btn-action" onclick="editPayment(${payment.id})" title="Editar">
                                                ✏️
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        // Calcular totales de facturación
        function calculateBillingTotals() {
            const container = document.getElementById('billingTotals');
            if (!container) {
                console.warn('⚠️ Contenedor billingTotals no encontrado');
                return;
            }

            if (!billingData || billingData.length === 0) {
                container.style.display = 'none';
                return;
            }

            const totals = billingData.reduce((acc, payment) => {
                acc.totalClientes += payment.totalAmount || 0;
                acc.totalDolares += payment.totalAmountUSD || 0;
                acc.totalComisiones += payment.commissionAmount || 0;
                acc.totalAponnt += payment.aponntAmount || 0;
                if (payment.isPaid) acc.totalPagado += payment.totalAmount || 0;
                else acc.totalPendiente += payment.totalAmount || 0;
                return acc;
            }, {
                totalClientes: 0,
                totalDolares: 0,
                totalComisiones: 0,
                totalAponnt: 0,
                totalPagado: 0,
                totalPendiente: 0
            });

            container.style.display = 'block';
            container.innerHTML = `
                <div class="billing-card">
                    <div class="billing-header">
                        <h3>💰 Totales</h3>
                    </div>
                    <div class="totals-grid">
                        <div class="total-item">
                            <div class="total-value">$${totals.totalClientes.toLocaleString()}</div>
                            <div class="total-label">Total Facturado</div>
                        </div>
                        <div class="total-item">
                            <div class="total-value">$${totals.totalComisiones.toLocaleString()}</div>
                            <div class="total-label">Total Comisiones</div>
                        </div>
                        <div class="total-item">
                            <div class="total-value">$${totals.totalAponnt.toLocaleString()}</div>
                            <div class="total-label">Total Aponnt</div>
                        </div>
                        <div class="total-item">
                            <div class="total-value paid">$${totals.totalPagado.toLocaleString()}</div>
                            <div class="total-label">Total Pagado</div>
                        </div>
                        <div class="total-item">
                            <div class="total-value unpaid">$${totals.totalPendiente.toLocaleString()}</div>
                            <div class="total-label">Total Pendiente</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Limpiar filtros de facturación
        function clearBillingFilters() {
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            document.getElementById('filterVendor').value = '';
            document.getElementById('filterPaymentStatus').value = '';
            
            // Recargar todos los datos
            loadBillingData();
        }

        // Cambiar estado de pago
        async function togglePaymentStatus(paymentId) {
            try {
                const payment = billingData.find(p => p.id === paymentId);
                if (!payment) return;

                const newStatus = !payment.isPaid;
                
                const response = await fetch(`${API_BASE}/payments/${paymentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token') || ''}`
                    },
                    body: JSON.stringify({
                        isPaid: newStatus
                    })
                });

                if (response.ok) {
                    payment.isPaid = newStatus;
                    showNotification(`✅ Estado actualizado: ${newStatus ? 'Pagado' : 'Pendiente'}`, 'success');
                    renderBillingTable();
                    calculateBillingTotals();
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('❌ Error actualizando estado:', error);
                
                // Fallback local para desarrollo
                const payment = billingData.find(p => p.id === paymentId);
                if (payment) {
                    payment.isPaid = !payment.isPaid;
                    renderBillingTable();
                    calculateBillingTotals();
                    showNotification(`⚠️ Estado actualizado localmente: ${payment.isPaid ? 'Pagado' : 'Pendiente'}`, 'warning');
                }
            }
        }

        // Editar pago (placeholder)
        function editPayment(paymentId) {
            const payment = billingData.find(p => p.id === paymentId);
            if (payment) {
                showNotification(`📝 Editar pago de ${payment.companyName} - ${payment.month}/${payment.year}`, 'info');
            }
        }

        // Cargar datos de facturación al cambiar de pestaña
        function loadBillingSystem() {
            loadBillingData();
        }

        // =======================================
        // FUNCIONES DE EXPORTACIÓN A EXCEL
        // =======================================

        // Función para exportar empresas a Excel
        async function exportCompaniesToExcel() {
            try {
                showNotification('Generando archivo Excel...', 'info');

                // Obtener todas las empresas con filtros aplicados
                const companies = await getAllFilteredCompanies();
                
                if (!companies || companies.length === 0) {
                    showNotification('No hay datos para exportar', 'warning');
                    return;
                }

                // Preparar datos para Excel
                const excelData = companies.map(company => ({
                    'Empresa': company.name,
                    'Email': company.email,
                    'Teléfono': company.phone,
                    'Dirección': company.address,
                    'País': company.country,
                    'Provincia': company.province,
                    'Ciudad': company.city,
                    'CUIT': company.taxId,
                    'Max Empleados': company.maxEmployees,
                    'Vendedor': company.vendor || 'Sin asignar',
                    'Comisión %': company.commissionPercentage + '%',
                    'CBU': company.cbu || 'No definido',
                    'Estado': company.status === 'active' ? 'Activo' : 
                             company.status === 'cotizado' ? 'Cotizado' : 'Suspendido',
                    'Licencia': company.licenseType,
                    'Fecha Creación': new Date(company.created_at).toLocaleDateString('es-AR'),
                    'Módulos Activos': Object.keys(company.activeModules || {}).join(', ')
                }));

                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);

                // Ajustar ancho de columnas
                const colWidths = [
                    { wch: 20 }, // Empresa
                    { wch: 25 }, // Email
                    { wch: 15 }, // Teléfono
                    { wch: 30 }, // Dirección
                    { wch: 12 }, // País
                    { wch: 15 }, // Provincia
                    { wch: 15 }, // Ciudad
                    { wch: 15 }, // CUIT
                    { wch: 12 }, // Max Empleados
                    { wch: 15 }, // Vendedor
                    { wch: 10 }, // Comisión %
                    { wch: 20 }, // CBU
                    { wch: 10 }, // Estado
                    { wch: 10 }, // Licencia
                    { wch: 15 }, // Fecha Creación
                    { wch: 30 }  // Módulos Activos
                ];
                ws['!cols'] = colWidths;

                XLSX.utils.book_append_sheet(wb, ws, 'Empresas');

                // Descargar archivo
                const filename = `Empresas_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);

                showNotification(`Archivo ${filename} descargado exitosamente`, 'success');
            } catch (error) {
                console.error('Error exportando empresas:', error);
                showNotification('Error al generar el archivo Excel', 'error');
            }
        }

        // Función para exportar vendedores a Excel
        async function exportVendorsToExcel() {
            try {
                showNotification('Generando archivo Excel...', 'info');

                // Obtener todos los vendedores
                const response = await fetch(`${API_BASE}/api/aponnt/dashboard/vendors`);
                if (!response.ok) throw new Error('Error obteniendo vendedores');
                
                const vendors = await response.json();
                
                if (!vendors || vendors.length === 0) {
                    showNotification('No hay vendedores para exportar', 'warning');
                    return;
                }

                // Preparar datos para Excel
                const excelData = vendors.map(vendor => ({
                    'ID': vendor.id,
                    'Nombre': vendor.name,
                    'Email': vendor.email,
                    'Teléfono': vendor.phone || 'No definido',
                    'WhatsApp': vendor.whatsapp || 'No definido',
                    'DNI': vendor.dni || 'No definido',
                    'CUIT': vendor.cuit || 'No definido',
                    'Ingresos Brutos': vendor.ingresosBrutos || 'No definido',
                    'Condición IVA': vendor.condicionIva || 'No definido',
                    'Comisión %': vendor.commissionPercentage + '%',
                    'Estado': vendor.isActive ? 'Activo' : 'Inactivo',
                    'Observaciones': vendor.observations || 'Sin observaciones',
                    'Fecha Creación': new Date(vendor.created_at).toLocaleDateString('es-AR'),
                    'Última Actualización': new Date(vendor.updated_at).toLocaleDateString('es-AR')
                }));

                // Crear workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);

                // Ajustar ancho de columnas
                const colWidths = [
                    { wch: 8 },  // ID
                    { wch: 20 }, // Nombre
                    { wch: 25 }, // Email
                    { wch: 15 }, // Teléfono
                    { wch: 15 }, // WhatsApp
                    { wch: 12 }, // DNI
                    { wch: 15 }, // CUIT
                    { wch: 15 }, // Ingresos Brutos
                    { wch: 15 }, // Condición IVA
                    { wch: 10 }, // Comisión %
                    { wch: 10 }, // Estado
                    { wch: 30 }, // Observaciones
                    { wch: 15 }, // Fecha Creación
                    { wch: 15 }  // Última Actualización
                ];
                ws['!cols'] = colWidths;

                XLSX.utils.book_append_sheet(wb, ws, 'Vendedores');

                // Descargar archivo
                const filename = `Vendedores_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);

                showNotification(`Archivo ${filename} descargado exitosamente`, 'success');
            } catch (error) {
                console.error('Error exportando vendedores:', error);
                showNotification('Error al generar el archivo Excel', 'error');
            }
        }

        // Función para exportar facturación a Excel
        async function exportBillingToExcel() {
            try {
                showNotification('Generando archivo Excel...', 'info');

                // Obtener filtros aplicados
                const month = document.getElementById('billingFilterMonth')?.value || new Date().getMonth() + 1;
                const year = document.getElementById('billingFilterYear')?.value || new Date().getFullYear();
                const vendor = document.getElementById('billingFilterVendor')?.value || '';
                const status = document.getElementById('billingFilterStatus')?.value || '';

                // Obtener datos de facturación
                const response = await fetch(`${API_BASE}/api/aponnt/dashboard/billing?month=${month}&year=${year}&vendor=${vendor}&status=${status}`);
                if (!response.ok) throw new Error('Error obteniendo datos de facturación');
                
                const billingData = await response.json();
                
                if (!billingData || billingData.length === 0) {
                    showNotification('No hay datos de facturación para exportar', 'warning');
                    return;
                }

                // Preparar datos para Excel
                const excelData = billingData.map(payment => ({
                    'Empresa': payment.companyName,
                    'Vendedor': payment.vendor || 'Sin asignar',
                    'Período': `${payment.month}/${payment.year}`,
                    'Total Facturado': `$${payment.totalAmount.toLocaleString()}`,
                    'Subtotal sin IVA': `$${(payment.totalAmount / 1.21).toFixed(2)}`,
                    'Comisión %': payment.commissionPercentage + '%',
                    'Comisión Monto': `$${payment.commissionAmount?.toFixed(2) || '0.00'}`,
                    'Monto Aponnt': `$${payment.aponntAmount?.toFixed(2) || '0.00'}`,
                    'Estado Pago': payment.isPaid ? 'Pagado' : 'Pendiente',
                    'Método Pago': payment.paymentMethod || 'No definido',
                    'Fecha Pago': payment.paymentDate ? new Date(payment.paymentDate).toLocaleDateString('es-AR') : 'Sin pagar',
                    'Fecha Vencimiento': payment.dueDate ? new Date(payment.dueDate).toLocaleDateString('es-AR') : 'No definida',
                    'Fecha Creación': new Date(payment.created_at).toLocaleDateString('es-AR'),
                    'Observaciones': payment.observations || 'Sin observaciones'
                }));

                // Crear workbook con múltiples hojas
                const wb = XLSX.utils.book_new();
                
                // Hoja principal de datos
                const ws = XLSX.utils.json_to_sheet(excelData);
                const colWidths = [
                    { wch: 20 }, // Empresa
                    { wch: 15 }, // Vendedor
                    { wch: 10 }, // Período
                    { wch: 15 }, // Total Facturado
                    { wch: 15 }, // Subtotal sin IVA
                    { wch: 10 }, // Comisión %
                    { wch: 15 }, // Comisión Monto
                    { wch: 15 }, // Monto Aponnt
                    { wch: 12 }, // Estado Pago
                    { wch: 15 }, // Método Pago
                    { wch: 15 }, // Fecha Pago
                    { wch: 15 }, // Fecha Vencimiento
                    { wch: 15 }, // Fecha Creación
                    { wch: 30 }  // Observaciones
                ];
                ws['!cols'] = colWidths;
                XLSX.utils.book_append_sheet(wb, ws, 'Facturación');

                // Hoja resumen por vendedor
                const vendorSummary = {};
                billingData.forEach(payment => {
                    const vendor = payment.vendor || 'Sin asignar';
                    if (!vendorSummary[vendor]) {
                        vendorSummary[vendor] = {
                            'Vendedor': vendor,
                            'Total Facturado': 0,
                            'Total Comisiones': 0,
                            'Pagos Cobrados': 0,
                            'Pagos Pendientes': 0,
                            'Empresas': new Set()
                        };
                    }
                    vendorSummary[vendor]['Total Facturado'] += payment.totalAmount;
                    vendorSummary[vendor]['Total Comisiones'] += payment.commissionAmount || 0;
                    if (payment.isPaid) {
                        vendorSummary[vendor]['Pagos Cobrados']++;
                    } else {
                        vendorSummary[vendor]['Pagos Pendientes']++;
                    }
                    vendorSummary[vendor]['Empresas'].add(payment.companyName);
                });

                const vendorSummaryData = Object.values(vendorSummary).map(vendor => ({
                    'Vendedor': vendor.Vendedor,
                    'Total Facturado': `$${vendor['Total Facturado'].toLocaleString()}`,
                    'Total Comisiones': `$${vendor['Total Comisiones'].toFixed(2)}`,
                    'Pagos Cobrados': vendor['Pagos Cobrados'],
                    'Pagos Pendientes': vendor['Pagos Pendientes'],
                    'Total Empresas': vendor['Empresas'].size,
                    'Empresas': Array.from(vendor['Empresas']).join(', ')
                }));

                const wsSummary = XLSX.utils.json_to_sheet(vendorSummaryData);
                wsSummary['!cols'] = [
                    { wch: 15 }, // Vendedor
                    { wch: 15 }, // Total Facturado
                    { wch: 15 }, // Total Comisiones
                    { wch: 12 }, // Pagos Cobrados
                    { wch: 12 }, // Pagos Pendientes
                    { wch: 12 }, // Total Empresas
                    { wch: 50 }  // Empresas
                ];
                XLSX.utils.book_append_sheet(wb, wsSummary, 'Resumen por Vendedor');

                // Descargar archivo
                const filename = `Facturacion_${month}_${year}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);

                showNotification(`Archivo ${filename} descargado exitosamente`, 'success');
            } catch (error) {
                console.error('Error exportando facturación:', error);
                showNotification('Error al generar el archivo Excel', 'error');
            }
        }

        // Función para cargar vendedores en el selector
        async function loadVendorsSelector() {
            try {
                const response = await fetch(`${API_BASE}/api/aponnt/dashboard/vendors`);
                if (!response.ok) throw new Error('Error obteniendo vendedores');
                
                const vendors = await response.json();
                const vendorSelect = document.getElementById('vendor');

                if (!vendorSelect) return;

                // Verificar que vendors sea un array
                if (!Array.isArray(vendors)) {
                    console.warn('vendors is not an array:', vendors);
                    return;
                }

                // Limpiar opciones existentes excepto la primera
                while (vendorSelect.children.length > 1) {
                    vendorSelect.removeChild(vendorSelect.lastChild);
                }

                // Agregar vendedores activos
                vendors
                    .filter(vendor => vendor && vendor.isActive)
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach(vendor => {
                        const option = document.createElement('option');
                        option.value = vendor.name;
                        option.textContent = `${vendor.name} (${vendor.email})`;
                        vendorSelect.appendChild(option);
                    });
                
            } catch (error) {
                console.error('Error cargando vendedores:', error);
            }
        }

        // Función auxiliar para obtener empresas filtradas
        async function getAllFilteredCompanies() {
            try {
                const response = await fetch(`${API_BASE}/dashboard/companies`);
                if (!response.ok) throw new Error('Error obteniendo empresas');
                
                let companies = await response.json();

                // Aplicar filtros si están activos
                const nameFilter = document.getElementById('companyNameFilter')?.value?.toLowerCase() || '';
                const countryFilter = document.getElementById('companyCountryFilter')?.value || '';
                const statusFilter = document.getElementById('companyStatusFilter')?.value || '';
                const vendorFilter = document.getElementById('companyVendorFilter')?.value || '';

                if (nameFilter) {
                    companies = companies.filter(company => 
                        company.name.toLowerCase().includes(nameFilter) ||
                        company.email.toLowerCase().includes(nameFilter)
                    );
                }

                if (countryFilter) {
                    companies = companies.filter(company => company.country === countryFilter);
                }

                if (statusFilter) {
                    companies = companies.filter(company => company.status === statusFilter);
                }

                if (vendorFilter) {
                    companies = companies.filter(company => company.vendor === vendorFilter);
                }

                return companies;
            } catch (error) {
                console.error('Error obteniendo empresas filtradas:', error);
                return [];
            }
        }

        // ==========================================
        // FUNCIONES DE GESTIÓN DE VENDEDORES
        // ==========================================

        let vendors = [];
        let currentEditingVendor = null;

        // Abrir modal para nuevo vendedor
        function openNewVendorModal() {
            console.log('🆕 Abriendo modal nuevo vendedor');

            currentEditingVendor = null;
            document.getElementById('vendorModalTitle').textContent = '➕ Nuevo Vendedor';
            document.getElementById('saveVendorBtnText').textContent = '💾 Guardar Vendedor';

            // Limpiar formulario
            document.getElementById('vendorForm').reset();
            document.getElementById('vendorSalesCommission').value = '10';
            document.getElementById('vendorSupportCommission').value = '5';
            document.getElementById('vendorAcceptsSupportPackages').value = 'true';
            document.getElementById('vendorAcceptsAuctions').value = 'true';
            document.getElementById('vendorStatus').value = 'activo';

            // Mostrar modal
            document.getElementById('vendorModal').classList.add('show');
        }

        // Abrir modal para editar vendedor
        function editVendor(vendorId) {
            console.log('✏️ Editando vendedor:', vendorId);

            const vendor = vendors.find(v => v.id == vendorId); // Usar == para comparación flexible
            if (!vendor) {
                console.error('Vendedor no encontrado:', vendorId);
                console.log('Vendedores disponibles:', vendors.map(v => ({ id: v.id, name: v.name })));
                return;
            }

            console.log('🔍 Estructura vendor para editar:', vendor);

            currentEditingVendor = vendor;
            document.getElementById('vendorModalTitle').textContent = '✏️ Editar Vendedor';
            document.getElementById('saveVendorBtnText').textContent = '💾 Actualizar Vendedor';

            // Cargar datos en el formulario usando la estructura correcta de la API
            document.getElementById('vendorName').value = vendor.name || '';
            document.getElementById('vendorEmail').value = vendor.email || '';
            document.getElementById('vendorPhone').value = vendor.phone || vendor.whatsapp || '';
            document.getElementById('vendorSalesCommission').value = vendor.salesCommission?.percentage || vendor.salesCommissionPercentage || vendor.commissionPercentage || 10;
            document.getElementById('vendorSupportCommission').value = vendor.supportCommission?.percentage || vendor.supportCommissionPercentage || 5;
            document.getElementById('vendorAcceptsSupportPackages').value = (vendor.acceptsSupport || vendor.acceptsSupportPackages) !== false ? 'true' : 'false';
            document.getElementById('vendorAcceptsAuctions').value = vendor.acceptsAuctions !== false ? 'true' : 'false';
            document.getElementById('vendorCBU').value = vendor.cbu || '';
            document.getElementById('vendorStatus').value = vendor.isActive !== false ? 'activo' : 'inactivo';
            document.getElementById('vendorNotes').value = vendor.notes || '';

            // Mostrar modal
            document.getElementById('vendorModal').classList.add('show');
        }

        // Cerrar modal de vendedor
        function closeVendorModal() {
            console.log('🚪 Cerrando modal vendedor');
            document.getElementById('vendorModal').classList.remove('show');
            currentEditingVendor = null;
        }

        // Guardar vendedor
        async function saveVendor() {
            console.log('💾 Guardando vendedor...');

            // Validar formulario
            const name = document.getElementById('vendorName').value.trim();
            const email = document.getElementById('vendorEmail').value.trim();
            const salesCommission = parseFloat(document.getElementById('vendorSalesCommission').value);
            const supportCommission = parseFloat(document.getElementById('vendorSupportCommission').value) || 0;
            const acceptsSupportPackages = document.getElementById('vendorAcceptsSupportPackages').value === 'true';
            const acceptsAuctions = document.getElementById('vendorAcceptsAuctions').value === 'true';

            if (!name) {
                alert('❌ El nombre es obligatorio');
                return;
            }

            if (!email) {
                alert('❌ El email es obligatorio');
                return;
            }

            if (isNaN(salesCommission) || salesCommission < 0 || salesCommission > 100) {
                alert('❌ La comisión de ventas debe ser un número entre 0 y 100');
                return;
            }

            if (supportCommission < 0 || supportCommission > 100) {
                alert('❌ La comisión de soporte debe ser un número entre 0 y 100');
                return;
            }

            // Crear objeto vendedor
            const vendorData = {
                name: name,
                email: email,
                phone: document.getElementById('vendorPhone').value.trim(),
                salesCommissionPercentage: salesCommission,
                supportCommissionPercentage: supportCommission,
                acceptsSupportPackages: acceptsSupportPackages,
                acceptsAuctions: acceptsAuctions,
                cbu: document.getElementById('vendorCBU').value.trim(),
                status: document.getElementById('vendorStatus').value,
                notes: document.getElementById('vendorNotes').value.trim(),
                // Campos para el sistema de calificaciones
                globalRating: 5.0, // Inicia con 5 estrellas
                totalSupportPackages: 0,
                activeSupportPackages: 0
            };

            try {
                const saveBtn = document.getElementById('saveVendorBtn');
                saveBtn.disabled = true;
                saveBtn.innerHTML = '⏳ Guardando...';

                let response;
                if (currentEditingVendor) {
                    // Actualizar vendedor existente
                    response = await fetch(`/api/aponnt/dashboard/vendors/${currentEditingVendor.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(vendorData)
                    });
                } else {
                    // Crear nuevo vendedor
                    response = await fetch('/api/aponnt/dashboard/vendors', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(vendorData)
                    });
                }

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Vendedor guardado:', result);

                    closeVendorModal();
                    loadVendors(); // Recargar lista

                    const action = currentEditingVendor ? 'actualizado' : 'creado';
                    alert(`✅ Vendedor ${action} exitosamente`);
                } else {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch {
                        errorData = await response.text();
                    }

                    console.error('❌ Error guardando vendedor:', errorData);

                    // Mostrar mensaje específico según el error
                    let errorMessage = '❌ Error guardando vendedor';
                    if (typeof errorData === 'object' && errorData.error) {
                        if (errorData.error.includes('email') || errorData.error.includes('Ya existe')) {
                            errorMessage = '❌ Ya existe un vendedor con este email. Usa un email diferente.';
                        } else {
                            errorMessage = `❌ ${errorData.error}`;
                        }
                    } else if (typeof errorData === 'string' && errorData.includes('email')) {
                        errorMessage = '❌ Ya existe un vendedor con este email. Usa un email diferente.';
                    }

                    alert(errorMessage);
                }
            } catch (error) {
                console.error('❌ Error guardando vendedor:', error);
                alert('❌ Error de conexión. Revisa la consola.');
            } finally {
                const saveBtn = document.getElementById('saveVendorBtn');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<span id="saveVendorBtnText">💾 Guardar Vendedor</span>';
            }
        }

        // Cargar lista de vendedores con métricas completas
        async function loadVendors() {
            console.log('📋 Cargando vendedores con métricas...');

            try {
                // Intentar cargar vendedores con métricas completas
                let response = await fetch('/api/vendor-automation/vendors-metrics');
                if (!response.ok) {
                    // Fallback al endpoint original
                    response = await fetch('/api/aponnt/dashboard/vendors');
                }

                if (response.ok) {
                    const data = await response.json();
                    console.log('📦 Respuesta API vendedores:', data);

                    // La API puede devolver un objeto con vendors o directamente un array
                    if (Array.isArray(data)) {
                        vendors = data;
                    } else if (data.vendors && Array.isArray(data.vendors)) {
                        vendors = data.vendors;
                    } else if (data.data && Array.isArray(data.data)) {
                        vendors = data.data;
                    } else if (data.vendorsMetrics && Array.isArray(data.vendorsMetrics)) {
                        vendors = data.vendorsMetrics;
                    } else {
                        console.warn('⚠️ Formato inesperado de respuesta, usando array vacío');
                        vendors = [];
                    }

                    console.log(`✅ ${vendors.length} vendedores cargados`);
                    renderVendors();
                } else {
                    console.error('❌ Error cargando vendedores:', response.status);
                    vendors = [];
                    renderVendors();
                }
            } catch (error) {
                console.error('❌ Error cargando vendedores:', error);
                vendors = [];
                renderVendors();
            }
        }

        // Renderizar lista de vendedores
        function renderVendors() {
            const container = document.getElementById('vendorsContainer');

            if (!container) {
                console.warn('⚠️ Contenedor vendorsContainer no encontrado');
                return;
            }

            if (!vendors || vendors.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">👥</div>
                        <h3>No hay vendedores registrados</h3>
                        <p>Comienza agregando tu primer vendedor</p>
                        <button class="btn btn-primary" onclick="openNewVendorModal()">
                            ➕ Agregar Primer Vendedor
                        </button>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <div class="vendors-table-container">
                    <div class="table-header">
                        <h3>👥 Vendedores (${vendors.length})</h3>
                        <div class="table-actions">
                            <button class="btn btn-success" onclick="openNewVendorModal()">
                                ➕ Nuevo Vendedor
                            </button>
                            <button class="btn btn-info" onclick="exportVendorsToExcel()">
                                📊 Exportar Excel
                            </button>
                        </div>
                    </div>

                    <table class="vendors-simple-table">
                        <thead>
                            <tr>
                                <th style="width: 240px;">👤 Vendedor</th>
                                <th style="width: 80px;">🏢 Empresas</th>
                                <th style="width: 120px;">👥 Usuarios<br><small>Sales / Support</small></th>
                                <th style="width: 140px;">💰 Comisión Ventas<br><small>Porcentaje / Monto</small></th>
                                <th style="width: 140px;">🛠️ Comisión Soporte<br><small>Porcentaje / Monto</small></th>
                                <th style="width: 140px;">👥 Referidos<br><small>Cantidad / Comisión</small></th>
                                <th style="width: 120px;">💵 Total General<br><small>Comisiones</small></th>
                                <th style="width: 130px;">📊 Valor Total<br><small>Módulos</small></th>
                                <th style="width: 110px;">📱 Contacto</th>
                                <th style="width: 120px;">📋 Estado<br><small>CBU / Rating</small></th>
                                <th style="width: 100px;">⚙️ Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${vendors.map(vendor => {
                                const isActive = vendor.isActive !== false && vendor.status !== 'inactivo';
                                const salesCommission = vendor.salesCommission || {};
                                const supportCommission = vendor.supportCommission || {};
                                const referralCommission = vendor.referralCommission || {};

                                return `
                                <tr class="${!isActive ? 'inactive-row' : ''}">
                                    <td>
                                        <div class="vendor-info">
                                            <strong>${vendor.name}</strong>
                                            <small>${vendor.email}</small>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <strong style="font-size: 0.5rem;">${vendor.companies || 0}</strong>
                                    </td>
                                    <td class="text-center">
                                        <div style="line-height: 1.2;">
                                            <div><strong style="color: #10b981; font-size: 0.6rem;">${vendor.salesUsers || 0}</strong> <span style="color: #6b7280; font-size: 0.55rem;">ventas</span></div>
                                            <div><strong style="color: #3b82f6; font-size: 0.6rem;">${vendor.supportUsers || 0}</strong> <span style="color: #6b7280; font-size: 0.55rem;">soporte</span></div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div style="line-height: 1.2;">
                                            <span class="badge badge-sales" style="margin-bottom: 2px;">${salesCommission.percentage ? salesCommission.percentage.toFixed(1) : 0}%</span>
                                            <div class="number-cell" style="font-size: 0.425rem;">$${salesCommission.amount ? salesCommission.amount.toLocaleString('es-AR') : 0}</div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div style="line-height: 1.2;">
                                            <span class="badge badge-support" style="margin-bottom: 2px;">${supportCommission.percentage ? supportCommission.percentage.toFixed(1) : 0}%</span>
                                            <div class="number-cell" style="font-size: 0.425rem;">$${supportCommission.amount ? supportCommission.amount.toLocaleString('es-AR') : 0}</div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div style="line-height: 1.2;">
                                            <div><strong style="color: #8b5cf6; font-size: 0.6rem;">${referralCommission.referrals || 0}</strong> <span style="color: #6b7280; font-size: 0.55rem;">referidos</span></div>
                                            <div class="number-cell" style="font-size: 0.55rem; color: #8b5cf6;">$${referralCommission.amount ? referralCommission.amount.toLocaleString('es-AR') : 0}</div>
                                        </div>
                                    </td>
                                    <td class="number-cell">
                                        <strong style="color: #f59e0b; font-size: 0.5rem;">$${vendor.totalCommission ? vendor.totalCommission.toLocaleString('es-AR') : 0}</strong>
                                    </td>
                                    <td class="number-cell">
                                        <strong style="color: #3b82f6; font-size: 0.5rem;">$${vendor.totalModuleValue ? vendor.totalModuleValue.toLocaleString('es-AR') : 0}</strong>
                                    </td>
                                    <td class="text-center">
                                        <div style="line-height: 1.2;">
                                            ${vendor.phone ? `<div style="font-size: 0.55rem;">📞 ${vendor.phone}</div>` : ''}
                                            ${vendor.whatsapp ? `<div style="font-size: 0.55rem;">📱 ${vendor.whatsapp}</div>` : ''}
                                            ${vendor.email ? `<div style="font-size: 0.5rem; color: #6b7280;">✉️ ${vendor.email.split('@')[0]}</div>` : ''}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div style="line-height: 1.2;">
                                            <span class="badge ${isActive ? 'badge-active' : 'badge-inactive'}" style="margin-bottom: 2px;">
                                                ${isActive ? 'Act' : 'Inact'}
                                            </span>
                                            ${vendor.cbu ? `<div style="font-size: 0.4rem; color: #6b7280;">CBU: ...${vendor.cbu.slice(-4)}</div>` : '<div style="font-size: 0.4rem; color: #ef4444;">Sin CBU</div>'}
                                            ${vendor.rating ? `<div style="font-size: 0.4rem; color: #f59e0b;">⭐ ${vendor.rating}/5</div>` : ''}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="simple-actions" style="display: flex; gap: 4px; justify-content: center;">
                                            <button class="btn-simple btn-edit" onclick="editVendor('${vendor.id}')" title="Editar" style="font-size: 0.5rem; padding: 3px 4px;">✏️</button>
                                            <button class="btn-simple btn-delete" onclick="deleteVendor('${vendor.id}')" title="Eliminar" style="font-size: 0.5rem; padding: 3px 4px;">🗑️</button>
                                            <button class="btn-simple btn-view" onclick="viewVendorDetails('${vendor.id}')" title="Ver detalles" style="font-size: 0.5rem; padding: 3px 4px;">👁️</button>
                                        </div>
                                    </td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    </div>
                </div>
            `;

            container.innerHTML = tableHTML;
        }

        // Ver detalles del vendedor
        function viewVendorDetails(vendorId) {
            const vendor = vendors.find(v => v.id == vendorId);
            if (!vendor) {
                console.error('Vendedor no encontrado:', vendorId);
                alert('❌ Vendedor no encontrado');
                return;
            }

            const details = `
🧑‍💼 DETALLES DEL VENDEDOR

📝 Información Personal:
• ID: ${vendor.id}
• Nombre: ${vendor.name}
• Email: ${vendor.email}
• Teléfono: ${vendor.phone || 'No especificado'}

💰 Comisiones:
• Ventas: ${vendor.salesCommissionPercentage || vendor.commissionPercentage || 0}%
• Soporte: ${vendor.supportCommissionPercentage || 0}%

📦 Soporte:
• Acepta paquetes: ${(vendor.acceptsSupport || vendor.acceptsSupportPackages) ? 'Sí' : 'No'}
• Acepta subastas: ${vendor.acceptsAuctions ? 'Sí' : 'No'}

💳 Información Bancaria:
• CBU: ${vendor.cbu || 'No especificado'}

📊 Estado:
• Estado: ${vendor.status || 'activo'}
• Rating Global: ${vendor.globalRating || 0}/5
• Paquetes de Soporte: ${vendor.totalSupportPackages || 0} total, ${vendor.activeSupportPackages || 0} activos

📝 Notas:
${vendor.notes || 'Sin notas adicionales'}
            `;

            alert(details);
        }

        // Eliminar vendedor
        async function deleteVendor(vendorId) {
            const vendor = vendors.find(v => v.id == vendorId); // Usar == para comparación flexible
            if (!vendor) {
                console.error('Vendedor no encontrado para eliminar:', vendorId);
                return;
            }

            if (!confirm(`¿Estás seguro de eliminar al vendedor "${vendor.name}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/aponnt/dashboard/vendors/${vendorId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    console.log('✅ Vendedor eliminado');
                    loadVendors(); // Recargar lista
                    alert('✅ Vendedor eliminado exitosamente');
                } else {
                    console.error('❌ Error eliminando vendedor');
                    alert('❌ Error eliminando vendedor');
                }
            } catch (error) {
                console.error('❌ Error eliminando vendedor:', error);
                alert('❌ Error de conexión');
            }
        }

        // Ver detalles completos del vendedor
        function viewVendorDetails(vendorId) {
            console.log('👁️ Viendo detalles del vendedor:', vendorId);

            const vendor = vendors.find(v => v.id == vendorId); // Usar == para comparación flexible
            if (!vendor) {
                console.error('Vendedor no encontrado:', vendorId);
                alert('❌ Vendedor no encontrado');
                return;
            }

            console.log('🔍 Estructura completa del vendor:', vendor);
            console.log('📊 Comisiones detectadas:', {
                salesCommission: vendor.salesCommission,
                supportCommission: vendor.supportCommission,
                referralCommission: vendor.referralCommission,
                acceptsSupport: vendor.acceptsSupport,
                acceptsSupportPackages: vendor.acceptsSupportPackages,
                acceptsAuctions: vendor.acceptsAuctions
            });

            // Crear modal de detalles
            const modalHTML = `
                <div id="vendorDetailsModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2>👁️ Detalles del Vendedor: ${vendor.name}</h2>
                            <span class="close" onclick="document.getElementById('vendorDetailsModal').remove()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h3>📋 Información Personal</h3>
                                    <p><strong>Nombre:</strong> ${vendor.name}</p>
                                    <p><strong>Email:</strong> ${vendor.email}</p>
                                    <p><strong>Teléfono:</strong> ${vendor.phone || vendor.whatsapp || 'No especificado'}</p>
                                    <p><strong>WhatsApp:</strong> ${vendor.whatsapp || 'No especificado'}</p>
                                    <p><strong>Código:</strong> ${vendor.vendorCode || vendor.vendor_code || 'Sin código'}</p>
                                    <p><strong>Estado:</strong> <span class="badge ${vendor.isActive !== false ? 'badge-active' : 'badge-inactive'}">${vendor.isActive !== false ? 'Activo' : 'Inactivo'}</span></p>
                                </div>
                                <div>
                                    <h3>🏢 Información Comercial</h3>
                                    <p><strong>Empresas:</strong> ${vendor.companies || 0}</p>
                                    <p><strong>Usuarios Ventas:</strong> ${vendor.salesUsers || 0}</p>
                                    <p><strong>Usuarios Soporte:</strong> ${vendor.supportUsers || 0}</p>
                                    <p><strong>Total Usuarios:</strong> ${vendor.totalUsers || 0}</p>
                                    <p><strong>Rating:</strong> ${vendor.rating ? vendor.rating + '/5 ⭐' : 'Sin rating'}</p>
                                    <p><strong>CBU:</strong> ${vendor.cbu || 'No registrado'}</p>
                                </div>
                            </div>

                            <div style="margin-top: 20px;">
                                <h3>💰 Comisiones</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                                        <h4 style="color: #10b981;">🏷️ Ventas</h4>
                                        <p><strong>Porcentaje:</strong> ${(vendor.salesCommission?.percentage || vendor.salesCommissionPercentage || vendor.commissionPercentage || 10).toFixed(1)}%</p>
                                        <p><strong>Monto:</strong> $${vendor.salesCommission?.amount?.toLocaleString('es-AR') || 0}</p>
                                    </div>
                                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                                        <h4 style="color: #3b82f6;">🛠️ Soporte</h4>
                                        <p><strong>Porcentaje:</strong> ${(vendor.supportCommission?.percentage || vendor.supportCommissionPercentage || 5).toFixed(1)}%</p>
                                        <p><strong>Monto:</strong> $${vendor.supportCommission?.amount?.toLocaleString('es-AR') || 0}</p>
                                    </div>
                                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                                        <h4 style="color: #8b5cf6;">👥 Referidos</h4>
                                        <p><strong>Cantidad:</strong> ${vendor.referralCommission?.referrals || 0}</p>
                                        <p><strong>Monto:</strong> $${vendor.referralCommission?.amount?.toLocaleString('es-AR') || 0}</p>
                                    </div>
                                </div>

                                <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <h4>💵 Totales</h4>
                                    <p><strong>Total Comisiones:</strong> <span style="color: #f59e0b; font-size: 1.2em;">$${vendor.totalCommission?.toLocaleString('es-AR') || 0}</span></p>
                                    <p><strong>Valor Total Módulos:</strong> <span style="color: #3b82f6;">$${vendor.totalModuleValue?.toLocaleString('es-AR') || 0}</span></p>
                                </div>
                            </div>

                            <div style="margin-top: 20px;">
                                <h3>⚙️ Configuraciones</h3>
                                <p><strong>Acepta Paquetes de Soporte:</strong> ${(vendor.acceptsSupport || vendor.acceptsSupportPackages) !== false ? '✅ Sí' : '❌ No'}</p>
                                <p><strong>Acepta Subastas:</strong> ${vendor.acceptsAuctions !== false ? '✅ Sí' : '❌ No'}</p>
                                <p><strong>Empresa:</strong> ${vendor.company || 'Sin empresa asignada'}</p>
                                <p><strong>Código Vendedor:</strong> ${vendor.vendorCode || vendor.vendor_code || 'No asignado'}</p>
                                <p><strong>Estado:</strong> ${vendor.status || (vendor.isActive !== false ? 'Activo' : 'Inactivo')}</p>
                            </div>

                            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <h4>🔍 Debug - Propiedades Detectadas</h4>
                                <small style="color: #6b7280;">
                                    <strong>acceptsSupport:</strong> ${vendor.acceptsSupport ? 'true' : 'false'} |
                                    <strong>acceptsSupportPackages:</strong> ${vendor.acceptsSupportPackages ? 'true' : 'false'} |
                                    <strong>acceptsAuctions:</strong> ${vendor.acceptsAuctions ? 'true' : 'false'}
                                </small>
                                <br><small style="color: #6b7280;">
                                    <strong>salesCommission:</strong> ${vendor.salesCommission ? JSON.stringify(vendor.salesCommission) : 'undefined'}<br>
                                    <strong>supportCommission:</strong> ${vendor.supportCommission ? JSON.stringify(vendor.supportCommission) : 'undefined'}
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="editVendor('${vendor.id}'); document.getElementById('vendorDetailsModal').remove();">✏️ Editar</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('vendorDetailsModal').remove()">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;

            // Agregar modal al body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Exportar vendedores a Excel
        function exportVendorsToExcel() {
            console.log('📊 Exportando vendedores a Excel...');

            if (!vendors || vendors.length === 0) {
                alert('⚠️ No hay vendedores para exportar');
                return;
            }

            // Preparar datos para Excel
            const excelData = vendors.map(vendor => ({
                'Nombre': vendor.name,
                'Email': vendor.email,
                'Teléfono': vendor.phone || '',
                'Comisión (%)': vendor.commissionPercentage,
                'CBU': vendor.cbu || '',
                'Estado': vendor.status,
                'Notas': vendor.notes || ''
            }));

            // Crear libro de Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);

            // Ajustar ancho de columnas
            ws['!cols'] = [
                { wch: 25 }, // Nombre
                { wch: 30 }, // Email
                { wch: 15 }, // Teléfono
                { wch: 12 }, // Comisión
                { wch: 22 }, // CBU
                { wch: 10 }, // Estado
                { wch: 40 }  // Notas
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Vendedores');

            // Descargar archivo
            const fileName = `vendedores_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);

            console.log('✅ Excel exportado:', fileName);
        }

    
        // 🌍 VALIDACIÓN DE COORDENADAS PARA APK ANDROID
        function validateGeolocationData() {
            const latitude = document.getElementById('companyLatitude').value?.trim();
            const longitude = document.getElementById('companyLongitude').value?.trim();
            const address = document.getElementById('address').value?.trim();

            const geoStatus = document.getElementById('geoLocationStatus') || (() => {
                const statusDiv = document.createElement('div');
                statusDiv.id = 'geoLocationStatus';
                statusDiv.style.cssText = 'margin-top: 10px; padding: 8px; border-radius: 4px; font-size: 12px; font-weight: bold;';

                const latField = document.getElementById('companyLatitude');
                if (latField && latField.parentNode) {
                    latField.parentNode.appendChild(statusDiv);
                }
                return statusDiv;
            })();

            if (!address) {
                geoStatus.innerHTML = '⚠️ Complete la dirección para geolocalizar';
                geoStatus.style.backgroundColor = '#fff3cd';
                geoStatus.style.color = '#856404';
            } else if (!latitude || !longitude) {
                geoStatus.innerHTML = '❌ GEOLOCALIZACIÓN REQUERIDA para APK Android - <button type="button" onclick="geocodeCompanyAddress()" style="background: #007bff; color: white; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer;">Obtener Coordenadas</button>';
                geoStatus.style.backgroundColor = '#f8d7da';
                geoStatus.style.color = '#721c24';
            } else {
                geoStatus.innerHTML = `✅ GPS Configurado: ${parseFloat(latitude).toFixed(6)}, ${parseFloat(longitude).toFixed(6)}`;
                geoStatus.style.backgroundColor = '#d4edda';
                geoStatus.style.color = '#155724';
            }
        }

        // Ejecutar validación cuando cambien los campos
        document.addEventListener('DOMContentLoaded', function() {
            const fieldsToWatch = ['address', 'city', 'province', 'companyLatitude', 'companyLongitude'];
            fieldsToWatch.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', validateGeolocationData);
                    field.addEventListener('change', validateGeolocationData);
                }
            });
        });

        // ========================================
        // SISTEMA DE PLANTILLAS FISCALES
        // ========================================

        let taxTemplates = [];
        let currentTaxTemplate = null;

        /**
         * Formatear porcentaje a 2 decimales
         */
        function formatPercentage(percentage) {
            return parseFloat(percentage || 0).toFixed(2);
        }

        /**
         * Cargar sistema de plantillas fiscales
         */
        async function loadTaxTemplatesSystem() {
            console.log('🔄 Cargando sistema de plantillas fiscales...');
            await loadTaxTemplates();
        }

        /**
         * Cargar todas las plantillas fiscales
         */
        async function loadTaxTemplates() {
            try {
                const response = await fetch(`${API_BASE}/api/siac/tax-templates`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                taxTemplates = result.templates || [];

                renderTaxTemplates();

            } catch (error) {
                console.error('❌ Error cargando plantillas fiscales:', error);
                showNotification('Error cargando plantillas fiscales', 'error');

                document.getElementById('taxTemplatesContainer').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <h4>❌ Error cargando plantillas</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadTaxTemplates()">
                            🔄 Reintentar
                        </button>
                    </div>
                `;
            }
        }

        /**
         * Renderizar lista de plantillas fiscales
         */
        function renderTaxTemplates() {
            const container = document.getElementById('taxTemplatesContainer');

            if (taxTemplates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <h4>🏛️ No hay plantillas fiscales configuradas</h4>
                        <p>Cree plantillas para configurar la matriz impositiva por país</p>
                        <button class="btn btn-success" onclick="openNewTaxTemplateModal()" style="margin-top: 1rem;">
                            ➕ Crear Primera Plantilla
                        </button>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="tax-templates-grid">
            `;

            taxTemplates.forEach(template => {
                html += `
                    <div class="tax-template-card">
                        <div class="tax-template-header">
                            <div class="tax-template-title">
                                <h3>🏛️ ${template.templateName}</h3>
                                <span class="country-code">${template.countryCode}</span>
                            </div>
                            <div class="tax-template-actions">
                                <button class="btn btn-sm btn-info" onclick="viewTaxTemplate(${template.id})">
                                    👁️ Ver
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="editTaxTemplate(${template.id})">
                                    ✏️ Editar
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTaxTemplate(${template.id})">
                                    🗑️ Eliminar
                                </button>
                            </div>
                        </div>
                        <div class="tax-template-body">
                            <div class="tax-template-info">
                                <div class="info-item">
                                    <span class="info-label">País:</span>
                                    <span class="info-value">${template.country}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Campo ID:</span>
                                    <span class="info-value">${template.taxIdFieldName}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Formato:</span>
                                    <span class="info-value">${template.taxIdFormat || 'No configurado'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Moneda:</span>
                                    <span class="info-value">${template.defaultCurrency}</span>
                                </div>
                            </div>
                            <div class="tax-template-stats">
                                <div class="stat-item">
                                    <span class="stat-value">${template.conditionsCount}</span>
                                    <span class="stat-label">Condiciones</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">${template.conceptsCount}</span>
                                    <span class="stat-label">Conceptos</span>
                                </div>
                            </div>
                        </div>
                        <div class="tax-template-footer">
                            <button class="btn btn-sm btn-success" onclick="addTaxConcept(${template.id})">
                                ➕ Agregar Concepto
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="addTaxCondition(${template.id})">
                                ➕ Agregar Condición
                            </button>
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
            `;

            container.innerHTML = html;
        }

        /**
         * Abrir modal para crear nueva plantilla fiscal
         */
        function openNewTaxTemplateModal() {
            const modalHtml = `
                <div id="taxTemplateModal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>🏛️ Nueva Plantilla Fiscal</h3>
                            <button class="close-btn" onclick="closeTaxTemplateModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="taxTemplateForm">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">País *</label>
                                        <input type="text" class="form-input" id="templateCountry" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Código País *</label>
                                        <input type="text" class="form-input" id="templateCountryCode" required maxlength="3" placeholder="ARG">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Nombre Plantilla *</label>
                                        <input type="text" class="form-input" id="templateName" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Campo ID Tributario</label>
                                        <input type="text" class="form-input" id="taxIdFieldName" value="CUIT">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Formato ID</label>
                                        <input type="text" class="form-input" id="taxIdFormat" placeholder="XX-XXXXXXXX-X">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Moneda Base</label>
                                        <select class="form-input" id="defaultCurrency">
                                            <option value="ARS">Peso Argentino (ARS)</option>
                                            <option value="USD">Dólar Estadounidense (USD)</option>
                                            <option value="EUR">Euro (EUR)</option>
                                            <option value="BRL">Real Brasileño (BRL)</option>
                                            <option value="UYU">Peso Uruguayo (UYU)</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeTaxTemplateModal()">Cancelar</button>
                            <button class="btn btn-success" onclick="saveTaxTemplate()">💾 Crear Plantilla</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * Cerrar modal de plantilla fiscal
         */
        function closeTaxTemplateModal() {
            const modal = document.getElementById('taxTemplateModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Guardar nueva plantilla fiscal
         */
        async function saveTaxTemplate() {
            try {
                const templateData = {
                    country: document.getElementById('templateCountry').value.trim(),
                    countryCode: document.getElementById('templateCountryCode').value.trim().toUpperCase(),
                    templateName: document.getElementById('templateName').value.trim(),
                    taxIdFieldName: document.getElementById('taxIdFieldName').value.trim() || 'CUIT',
                    taxIdFormat: document.getElementById('taxIdFormat').value.trim(),
                    defaultCurrency: document.getElementById('defaultCurrency').value,
                    currencies: [document.getElementById('defaultCurrency').value]
                };

                if (!templateData.country || !templateData.countryCode || !templateData.templateName) {
                    showNotification('Complete todos los campos obligatorios', 'warning');
                    return;
                }

                const response = await fetch(`${API_BASE}/api/siac/tax-templates`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    },
                    body: JSON.stringify(templateData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Error ${response.status}`);
                }

                const result = await response.json();
                console.log('✅ Plantilla fiscal creada:', result);

                showNotification('Plantilla fiscal creada exitosamente', 'success');
                closeTaxTemplateModal();
                await loadTaxTemplates();

            } catch (error) {
                console.error('❌ Error creando plantilla fiscal:', error);
                showNotification(`Error creando plantilla: ${error.message}`, 'error');
            }
        }

        /**
         * Ver detalles de plantilla fiscal
         */
        async function viewTaxTemplate(templateId) {
            try {
                const response = await fetch(`${API_BASE}/api/siac/tax-templates/${templateId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                currentTaxTemplate = result.template;

                openTaxTemplateDetailModal(currentTaxTemplate);

            } catch (error) {
                console.error('❌ Error obteniendo plantilla fiscal:', error);
                showNotification(`Error cargando plantilla: ${error.message}`, 'error');
            }
        }

        /**
         * Abrir modal de detalle de plantilla fiscal
         */
        function openTaxTemplateDetailModal(template) {
            const modalHtml = `
                <div id="taxTemplateDetailModal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3>🏛️ ${template.templateName}</h3>
                            <button class="close-btn" onclick="closeTaxTemplateDetailModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="tax-template-detail">
                                <div class="detail-section">
                                    <h4>📋 Información General</h4>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <span class="detail-label">País:</span>
                                            <span class="detail-value">${template.country}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Código:</span>
                                            <span class="detail-value">${template.countryCode}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Campo ID:</span>
                                            <span class="detail-value">${template.taxIdFieldName}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Formato:</span>
                                            <span class="detail-value">${template.taxIdFormat || 'No configurado'}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <h4>⚖️ Condiciones Impositivas</h4>
                                    <div class="conditions-list">
                                        ${template.conditions && template.conditions.length > 0 ?
                                            template.conditions.map(condition => `
                                                <div class="condition-item">
                                                    <span class="condition-code">${condition.conditionCode}</span>
                                                    <span class="condition-name">${condition.conditionName}</span>
                                                </div>
                                            `).join('') :
                                            '<p class="no-data">No hay condiciones configuradas</p>'
                                        }
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <h4>💰 Conceptos Impositivos</h4>
                                    <div class="concepts-list">
                                        ${template.concepts && template.concepts.length > 0 ?
                                            template.concepts.map(concept => `
                                                <div class="concept-item">
                                                    <div class="concept-header">
                                                        <span class="concept-name">${concept.conceptName}</span>
                                                        <span class="concept-order">Orden: ${concept.calculationOrder}</span>
                                                    </div>
                                                    <div class="concept-details">
                                                        <span>Base: ${concept.baseAmount}</span>
                                                        <span>Tipo: ${concept.conceptType}</span>
                                                    </div>
                                                    ${concept.rates && concept.rates.length > 0 ?
                                                        `<div class="rates-list">
                                                            ${concept.rates.map(rate => `
                                                                <div class="rate-item">
                                                                    <span>${rate.rateName}</span>
                                                                    <span class="rate-percentage">${formatPercentage(rate.ratePercentage)}%</span>
                                                                </div>
                                                            `).join('')}
                                                        </div>` :
                                                        '<p class="no-rates">Sin alícuotas configuradas</p>'
                                                    }
                                                </div>
                                            `).join('') :
                                            '<p class="no-data">No hay conceptos configurados</p>'
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeTaxTemplateDetailModal()">Cerrar</button>
                            <button class="btn btn-warning" onclick="editTaxTemplate(${template.id})">✏️ Editar</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * Cerrar modal de detalle
         */
        function closeTaxTemplateDetailModal() {
            const modal = document.getElementById('taxTemplateDetailModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Editar plantilla fiscal
         */
        async function editTaxTemplate(templateId) {
            try {
                // Obtener datos actuales de la plantilla
                const response = await fetch(`${API_BASE}/api/siac/tax-templates/${templateId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                const template = result.template;

                openEditTaxTemplateModal(template);

            } catch (error) {
                console.error('❌ Error obteniendo plantilla para editar:', error);
                showNotification(`Error cargando plantilla: ${error.message}`, 'error');
            }
        }

        /**
         * Abrir modal para editar plantilla fiscal
         */
        function openEditTaxTemplateModal(template) {
            const modalHtml = `
                <div id="editTaxTemplateModal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>✏️ Editar Plantilla Fiscal</h3>
                            <button class="close-btn" onclick="closeEditTaxTemplateModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="editTaxTemplateForm">
                                <input type="hidden" id="editTemplateId" value="${template.id}">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">País *</label>
                                        <input type="text" class="form-input" id="editTemplateCountry" value="${template.country}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Código País *</label>
                                        <input type="text" class="form-input" id="editTemplateCountryCode" value="${template.countryCode}" required maxlength="3">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Nombre Plantilla *</label>
                                        <input type="text" class="form-input" id="editTemplateName" value="${template.templateName}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Campo ID Tributario</label>
                                        <input type="text" class="form-input" id="editTaxIdFieldName" value="${template.taxIdFieldName}">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Formato ID</label>
                                        <input type="text" class="form-input" id="editTaxIdFormat" value="${template.taxIdFormat || ''}" placeholder="XX-XXXXXXXX-X">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Moneda Base</label>
                                        <select class="form-input" id="editDefaultCurrency">
                                            <option value="ARS" ${template.defaultCurrency === 'ARS' ? 'selected' : ''}>Peso Argentino (ARS)</option>
                                            <option value="USD" ${template.defaultCurrency === 'USD' ? 'selected' : ''}>Dólar Estadounidense (USD)</option>
                                            <option value="EUR" ${template.defaultCurrency === 'EUR' ? 'selected' : ''}>Euro (EUR)</option>
                                            <option value="BRL" ${template.defaultCurrency === 'BRL' ? 'selected' : ''}>Real Brasileño (BRL)</option>
                                            <option value="UYU" ${template.defaultCurrency === 'UYU' ? 'selected' : ''}>Peso Uruguayo (UYU)</option>
                                        </select>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeEditTaxTemplateModal()">Cancelar</button>
                            <button class="btn btn-success" onclick="updateTaxTemplate()">💾 Guardar Cambios</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * Cerrar modal de editar plantilla
         */
        function closeEditTaxTemplateModal() {
            const modal = document.getElementById('editTaxTemplateModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Actualizar plantilla fiscal
         */
        async function updateTaxTemplate() {
            try {
                const templateId = document.getElementById('editTemplateId').value;
                const templateData = {
                    country: document.getElementById('editTemplateCountry').value.trim(),
                    countryCode: document.getElementById('editTemplateCountryCode').value.trim().toUpperCase(),
                    templateName: document.getElementById('editTemplateName').value.trim(),
                    taxIdFieldName: document.getElementById('editTaxIdFieldName').value.trim() || 'CUIT',
                    taxIdFormat: document.getElementById('editTaxIdFormat').value.trim(),
                    defaultCurrency: document.getElementById('editDefaultCurrency').value,
                    currencies: [document.getElementById('editDefaultCurrency').value]
                };

                if (!templateData.country || !templateData.countryCode || !templateData.templateName) {
                    showNotification('Complete todos los campos obligatorios', 'warning');
                    return;
                }

                const response = await fetch(`${API_BASE}/api/siac/tax-templates/${templateId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    },
                    body: JSON.stringify(templateData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Error ${response.status}`);
                }

                const result = await response.json();
                console.log('✅ Plantilla fiscal actualizada:', result);

                showNotification('Plantilla fiscal actualizada exitosamente', 'success');
                closeEditTaxTemplateModal();
                await loadTaxTemplates();

            } catch (error) {
                console.error('❌ Error actualizando plantilla fiscal:', error);
                showNotification(`Error actualizando plantilla: ${error.message}`, 'error');
            }
        }

        /**
         * Eliminar plantilla fiscal
         */
        async function deleteTaxTemplate(templateId) {
            const template = taxTemplates.find(t => t.id === templateId);
            if (!template) return;

            if (!confirm(`¿Está seguro de eliminar la plantilla fiscal de ${template.country}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/siac/tax-templates/${templateId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                showNotification('Plantilla fiscal eliminada exitosamente', 'success');
                await loadTaxTemplates();

            } catch (error) {
                console.error('❌ Error eliminando plantilla fiscal:', error);
                showNotification(`Error eliminando plantilla: ${error.message}`, 'error');
            }
        }

        /**
         * Agregar concepto impositivo
         */
        function addTaxConcept(templateId) {
            openAddTaxConceptModal(templateId);
        }

        /**
         * Abrir modal para agregar concepto impositivo
         */
        function openAddTaxConceptModal(templateId) {
            const modalHtml = `
                <div id="addTaxConceptModal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>💰 Nuevo Concepto Impositivo</h3>
                            <button class="close-btn" onclick="closeAddTaxConceptModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="addTaxConceptForm">
                                <input type="hidden" id="conceptTemplateId" value="${templateId}">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Código Concepto *</label>
                                        <input type="text" class="form-input" id="conceptCode" required placeholder="IVA">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Nombre Concepto *</label>
                                        <input type="text" class="form-input" id="conceptName" required placeholder="Impuesto al Valor Agregado">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Descripción</label>
                                        <textarea class="form-input" id="conceptDescription" rows="2" placeholder="Descripción del concepto impositivo"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Orden de Cálculo *</label>
                                        <input type="number" class="form-input" id="calculationOrder" value="1" min="1" required>
                                        <small style="color: #666;">Orden en que se calcula (1 = primero)</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Base Imponible *</label>
                                        <select class="form-input" id="baseAmount" required>
                                            <option value="neto_sin_descuentos">Neto sin descuentos</option>
                                            <option value="neto_final">Neto final (con descuentos)</option>
                                            <option value="subtotal">Subtotal</option>
                                            <option value="total">Total</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Tipo de Concepto *</label>
                                        <select class="form-input" id="conceptType" required>
                                            <option value="tax">Impuesto</option>
                                            <option value="retention">Retención</option>
                                            <option value="perception">Percepción</option>
                                            <option value="discount">Descuento</option>
                                            <option value="surcharge">Recargo</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Alícuota/Porcentaje (%)</label>
                                        <input type="number" class="form-input" id="defaultRate" step="0.01" min="0" max="100" placeholder="21.00">
                                        <small style="color: #666;">Porcentaje por defecto (ej: 21% para IVA)</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Monto Fijo (Opcional)</label>
                                        <input type="number" class="form-input" id="fixedAmount" step="0.01" min="0" placeholder="0.00">
                                        <small style="color: #666;">Si tiene monto fijo en lugar de %</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Nombre de Alícuota</label>
                                        <input type="text" class="form-input" id="rateName" placeholder="General">
                                        <small style="color: #666;">Nombre descriptivo (General, Reducida, etc.)</small>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeAddTaxConceptModal()">Cancelar</button>
                            <button class="btn btn-success" onclick="saveTaxConcept()">💾 Crear Concepto</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * Cerrar modal de agregar concepto
         */
        function closeAddTaxConceptModal() {
            const modal = document.getElementById('addTaxConceptModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Guardar concepto impositivo
         */
        async function saveTaxConcept() {
            try {
                const templateId = document.getElementById('conceptTemplateId').value;
                const conceptData = {
                    conceptCode: document.getElementById('conceptCode').value.trim(),
                    conceptName: document.getElementById('conceptName').value.trim(),
                    description: document.getElementById('conceptDescription').value.trim(),
                    calculationOrder: parseInt(document.getElementById('calculationOrder').value),
                    baseAmount: document.getElementById('baseAmount').value,
                    conceptType: document.getElementById('conceptType').value
                };

                if (!conceptData.conceptCode || !conceptData.conceptName || !conceptData.calculationOrder) {
                    showNotification('Complete todos los campos obligatorios', 'warning');
                    return;
                }

                // Crear el concepto primero
                const response = await fetch(`${API_BASE}/api/siac/tax-templates/${templateId}/concepts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    },
                    body: JSON.stringify(conceptData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Error ${response.status}`);
                }

                const result = await response.json();
                console.log('✅ Concepto impositivo creado:', result);

                // Si se especificó una alícuota/porcentaje, crear la rate automáticamente
                const defaultRate = parseFloat(document.getElementById('defaultRate').value);
                const fixedAmount = parseFloat(document.getElementById('fixedAmount').value);
                const rateName = document.getElementById('rateName').value.trim();

                if (defaultRate > 0 || fixedAmount > 0) {
                    const rateData = {
                        rateCode: conceptData.conceptCode + '_DEFAULT',
                        rateName: rateName || 'General',
                        ratePercentage: defaultRate || 0,
                        minimumAmount: fixedAmount || 0,
                        maximumAmount: null,
                        isDefault: true
                    };

                    console.log('Creando alícuota automáticamente:', rateData);

                    const rateResponse = await fetch(`${API_BASE}/api/siac/tax-templates/concepts/${result.concept.id}/rates`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                        },
                        body: JSON.stringify(rateData)
                    });

                    if (rateResponse.ok) {
                        console.log('✅ Alícuota creada automáticamente');
                        showNotification('Concepto y alícuota creados exitosamente', 'success');
                    } else {
                        console.warn('⚠️ Concepto creado pero falló la alícuota');
                        showNotification('Concepto creado (alícuota pendiente)', 'warning');
                    }
                } else {
                    showNotification('Concepto impositivo creado exitosamente', 'success');
                }

                closeAddTaxConceptModal();
                await loadTaxTemplates();

            } catch (error) {
                console.error('❌ Error creando concepto impositivo:', error);

                // Manejo específico para duplicados
                if (error.message && error.message.includes('llave duplicada')) {
                    showNotification(`❌ Ya existe un concepto con el código "${document.getElementById('conceptCode').value.trim()}". Use un código diferente.`, 'error');
                } else if (error.message && error.message.includes('Error 400')) {
                    showNotification('❌ Ya existe un concepto con ese código. Use un código diferente.', 'error');
                } else {
                    showNotification(`Error creando concepto: ${error.message}`, 'error');
                }
            }
        }

        /**
         * Agregar condición impositiva
         */
        function addTaxCondition(templateId) {
            openAddTaxConditionModal(templateId);
        }

        /**
         * Abrir modal para agregar condición impositiva
         */
        function openAddTaxConditionModal(templateId) {
            const modalHtml = `
                <div id="addTaxConditionModal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3>⚖️ Nueva Condición Impositiva</h3>
                            <button class="close-btn" onclick="closeAddTaxConditionModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="addTaxConditionForm">
                                <input type="hidden" id="conditionTemplateId" value="${templateId}">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Código Condición *</label>
                                        <input type="text" class="form-input" id="conditionCode" required placeholder="RI">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Nombre Condición *</label>
                                        <input type="text" class="form-input" id="conditionName" required placeholder="Responsable Inscripto">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Descripción</label>
                                        <textarea class="form-input" id="conditionDescription" rows="3" placeholder="Descripción detallada de la condición impositiva"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Orden de Visualización</label>
                                        <input type="number" class="form-input" id="displayOrder" value="1" min="1">
                                        <small style="color: #666;">Orden en la lista (1 = primero)</small>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeAddTaxConditionModal()">Cancelar</button>
                            <button class="btn btn-success" onclick="saveTaxCondition()">💾 Crear Condición</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * Cerrar modal de agregar condición
         */
        function closeAddTaxConditionModal() {
            const modal = document.getElementById('addTaxConditionModal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Guardar condición impositiva
         */
        async function saveTaxCondition() {
            try {
                const templateId = document.getElementById('conditionTemplateId').value;
                const conditionData = {
                    conditionCode: document.getElementById('conditionCode').value.trim(),
                    conditionName: document.getElementById('conditionName').value.trim(),
                    description: document.getElementById('conditionDescription').value.trim(),
                    displayOrder: parseInt(document.getElementById('displayOrder').value) || 1
                };

                if (!conditionData.conditionCode || !conditionData.conditionName) {
                    showNotification('Complete todos los campos obligatorios', 'warning');
                    return;
                }

                const response = await fetch(`${API_BASE}/api/siac/tax-templates/${templateId}/conditions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('aponnt_token')}`
                    },
                    body: JSON.stringify(conditionData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `Error ${response.status}`);
                }

                const result = await response.json();
                console.log('✅ Condición impositiva creada:', result);

                showNotification('Condición impositiva creada exitosamente', 'success');
                closeAddTaxConditionModal();
                await loadTaxTemplates();

            } catch (error) {
                console.error('❌ Error creando condición impositiva:', error);
                showNotification(`Error creando condición: ${error.message}`, 'error');
            }
        }

        /**
         * Exportar todas las plantillas fiscales
         */
        async function exportAllTaxTemplates() {
            try {
                const dataStr = JSON.stringify(taxTemplates, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `plantillas_fiscales_${new Date().toISOString().split('T')[0]}.json`;
                link.click();

                URL.revokeObjectURL(url);
                showNotification('Plantillas fiscales exportadas exitosamente', 'success');

            } catch (error) {
                console.error('❌ Error exportando plantillas:', error);
                showNotification(`Error exportando: ${error.message}`, 'error');
            }
        }

        </script>
</body>
</html>