<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aponnt - SIN UNDEFINED - v20250926</title>

    <!-- üè¢ SISTEMA MULTI-TENANT PROFESIONAL -->
    <script>
        console.log('üè¢ [MULTI-TENANT] Inicializando sistema empresarial profesional');

        // VARIABLES GLOBALES DEL SISTEMA MULTI-TENANT
        let currentCompany = null;
        let currentUser = null;
        let authToken = null;
        let userPermissions = {};
        let isAuthenticated = false;

        // VERIFICAR Y RESTAURAR SESIONES - MANTENER LOGIN
        function checkExistingSession() {
            try {
                // Intentar recuperar sesi√≥n guardada
                const savedToken = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                const savedUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
                const savedCompany = localStorage.getItem('currentCompany') || sessionStorage.getItem('currentCompany');

                if (savedToken && savedUser && savedCompany) {
                    console.log('‚úÖ [SESSION] Sesi√≥n existente encontrada - restaurando...');

                    // Restaurar variables globales
                    authToken = savedToken;
                    currentUser = JSON.parse(savedUser);
                    currentCompany = JSON.parse(savedCompany);
                    isAuthenticated = true;

                    window.authToken = savedToken;
                    window.companyAuthToken = savedToken;
                    window.currentUser = currentUser;
                    window.currentCompany = currentCompany;
                    window.selectedCompany = currentCompany;
                    window.isAuthenticated = true;

                    console.log('‚úÖ [SESSION] Sesi√≥n restaurada exitosamente');
                    console.log('üë§ Usuario:', currentUser.email);
                    console.log('üè¢ Empresa:', currentCompany.name);
                    return true;
                } else {
                    console.log('‚ö†Ô∏è [SESSION] No se encontr√≥ sesi√≥n guardada - se requerir√° login');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå [SESSION] Error verificando sesi√≥n:', error);
                return false;
            }
        }

        // INICIALIZAR - VERIFICAR SESI√ìN EXISTENTE
        const hasExistingSession = checkExistingSession();
        console.log('üöÄ [INIT] HasExistingSession:', hasExistingSession);
    </script>

    <!-- ‚úÖ HEADER LAYOUT COMPLETADO - 23/SEP/2025 16:13 - v2.1.9
     CAMBIOS IMPLEMENTADOS Y APROBADOS:
     - Header reducido 1cm total
     - Logo y elementos subidos 2cm
     - Texto sistema en 1 l√≠nea
     - Label versi√≥n reposicionado
     - Botones "Biometr√≠a Anal√≠tica" actualizados

     ‚ö†Ô∏è PRECAUCI√ìN: Este layout ha sido completado y aprobado.
     Cualquier modificaci√≥n futura debe ser cuidadosa para no romper el dise√±o.
-->
    <!-- Sistema de Versionado Movido al Header 23/SEP/2025 13:45:00 -->

    <!-- Bootstrap 5 - Requerido para m√≥dulo Kiosks Profesional -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome para √≠conos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- üìä Chart.js para gr√°ficos del Auditor -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- üîå Socket.IO client para WebSocket real-time -->
    <!-- Socket.IO Client desde CDN (m√°s confiable que /socket.io/socket.io.js) -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>

    <link rel="stylesheet" href="css/admin-complete.css">

    <!-- üì± RESPONSIVE MODALS - Sistema Global -->
    <link rel="stylesheet" href="css/responsive-modals.css">
    <!-- üéØ MODAL FULLSCREEN RESPONSIVE - Modales al 98% pantalla, t√≠tulos y tabs compactos -->
    <link rel="stylesheet" href="css/modal-fullscreen-responsive.css">

    <!-- üèÜ TECH STACK BADGES - Marketing Subliminal Profesional -->
    <link rel="stylesheet" href="css/tech-badges.css">

    <!-- üìê BALANCEADO - CSS balanceado sin romper el dise√±o original -->
    <!-- COMENTADO TEMPORALMENTE - CSS muy agresivo que rompi√≥ el dise√±o
    <link rel="stylesheet" href="css/module-buttons-compact.css">
    <link rel="stylesheet" href="css/ultra-compact-responsive.css">
    -->

    <!-- CSS Overrides para asegurar compatibilidad Bootstrap + estilos custom -->
    <style>
        /* Asegurar que los modales de Bootstrap se muestren correctamente */
        .modal {
            z-index: 1056 !important;
            position: fixed !important;
        }
        .modal-backdrop {
            z-index: 1050 !important;
            position: fixed !important;
        }

        /* Asegurar que los modales sean scrollables */
        .modal-dialog-scrollable {
            max-height: calc(100vh - 3.5rem);
        }
        .modal-dialog-scrollable .modal-body {
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        /* Fix para que botones de Bootstrap no interfieran con estilos custom */
        .modal .btn-primary {
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
        }

        /* Fix para inputs y selects dentro del modal */
        .modal .form-control,
        .modal .form-select {
            position: relative;
            z-index: 1;
        }

        /* Asegurar que el modal sea clickeable */
        .modal-content {
            pointer-events: auto !important;
        }
    </style>

    <!-- CONFIGURACI√ìN DIN√ÅMICA DE PUERTOS - DEBE SER EL PRIMER SCRIPT -->
    <script src="js/port-config.js"></script>
    <script src="js/translation-system.js"></script>

    <!-- ‚è∞ FUNCIONES GLOBALES - FECHA/HORA Y SELECTOR DE IDIOMAS -->
    <script>
        // Funci√≥n para actualizar fecha y hora
        function updateDateTime() {
            const now = new Date();
            const dateOptions = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            const timeOptions = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };

            const dateElement = document.getElementById('currentDate');
            const timeElement = document.getElementById('currentTime');

            if (dateElement) dateElement.textContent = now.toLocaleDateString('es-ES', dateOptions);
            if (timeElement) timeElement.textContent = now.toLocaleTimeString('es-ES', timeOptions);
        }

        // Funci√≥n para inicializar selector de idiomas
        function initializeLanguageSelector() {
            const container = document.getElementById('languageSelectorContainer');
            if (!container) {
                console.error('‚ùå [HEADER] No se encontr√≥ languageSelectorContainer');
                return;
            }

            if (container.hasChildNodes()) {
                console.log('‚ö†Ô∏è [HEADER] Selector de idioma ya existe');
                return;
            }

            if (window.translator && typeof window.translator.createLanguageSelector === 'function') {
                try {
                    const selector = window.translator.createLanguageSelector();
                    if (selector) {
                        container.innerHTML = '';
                        container.appendChild(selector);
                        console.log('‚úÖ [HEADER] Selector de idioma inicializado correctamente');
                        return;
                    }
                } catch (error) {
                    console.error('‚ùå [HEADER] Error creando selector:', error);
                }
            }

            // Fallback: crear selector simple si el translator no est√° disponible
            console.warn('‚ö†Ô∏è [HEADER] Usando selector de idioma fallback');
            const fallbackSelector = document.createElement('select');
            fallbackSelector.style.cssText = `
                padding: 4px 8px;
                border: 1px solid rgba(255,255,255,0.3);
                border-radius: 4px;
                background: rgba(255,255,255,0.1);
                color: white;
                font-size: 11px;
                min-width: 120px;
                cursor: pointer;
            `;

            const languages = {
                'es': 'üá™üá∏ ESPA√ëOL',
                'en': 'üá∫üá∏ ENGLISH',
                'pt': 'üáßüá∑ PORTUGU√äS',
                'de': 'üá©üá™ DEUTSCH',
                'it': 'üáÆüáπ ITALIANO',
                'fr': 'üá´üá∑ FRAN√áAIS'
            };

            const currentLang = window.translator?.currentLanguage || 'es';

            Object.entries(languages).forEach(([code, name]) => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = name;
                option.style.color = '#333';
                option.style.background = 'white';
                if (code === currentLang) option.selected = true;
                fallbackSelector.appendChild(option);
            });

            fallbackSelector.addEventListener('change', async function() {
                const selectedLang = this.value;
                console.log('üåç [LANGUAGE] Usuario cambi√≥ idioma a:', selectedLang);

                if (window.translator && typeof window.translator.changeLanguage === 'function') {
                    await window.translator.changeLanguage(selectedLang);
                    console.log('‚úÖ [LANGUAGE] Idioma cambiado con translator a:', selectedLang);
                } else {
                    localStorage.setItem('user_language', selectedLang);
                    console.log('‚ö†Ô∏è [LANGUAGE] Idioma guardado sin translator, recargando...');
                    location.reload();
                }
            });

            container.innerHTML = '';
            container.appendChild(fallbackSelector);
            console.log('‚úÖ [HEADER] Selector de idioma fallback creado y agregado al DOM');
        }
    </script>

    <!-- üè¢ GESTI√ìN MULTI-TENANT DOM READY -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè¢ [DOM-READY] Iniciando gesti√≥n multi-tenant');

            // Inicializar fecha/hora inmediatamente
            console.log('üìÖ [DATETIME] Iniciando actualizaci√≥n de fecha/hora...');
            updateDateTime();
            setInterval(updateDateTime, 1000);

            // Inicializar selector de idiomas
            console.log('üåç [LANGUAGE] Iniciando selector de idiomas...');
            setTimeout(initializeLanguageSelector, 500);

            // SIEMPRE MOSTRAR LOGIN - NO VERIFICAR SESIONES
            console.log('üîê [DOM-READY] Mostrando login');
            showLogin();
        });

        // MOSTRAR DASHBOARD
        function showDashboard() {
            const loginContainer = document.getElementById('loginContainer');
            const mainContent = document.getElementById('mainContent');
            const moduleGrid = document.querySelector('.module-grid');

            if (loginContainer) {
                loginContainer.style.display = 'none';
            }

            // Agregar clase al body para forzar visibilidad
            document.body.classList.add('authenticated');

            // Mostrar module-grid donde est√°n los m√≥dulos
            if (moduleGrid) {
                moduleGrid.style.display = 'grid';
                moduleGrid.style.visibility = 'visible';
                moduleGrid.style.opacity = '1';
            }

            if (mainContent) {
                mainContent.style.display = 'block';
                mainContent.style.visibility = 'visible';
                mainContent.style.opacity = '1';
                mainContent.classList.add('authenticated');

                // Forzar visibilidad de todos los elementos internos
                const allElements = mainContent.querySelectorAll('*');
                allElements.forEach(el => {
                    if (el.style.display === 'none' || el.style.visibility === 'hidden') {
                        el.style.display = 'block';
                        el.style.visibility = 'visible';
                        el.style.opacity = '1';
                    }
                });

                console.log('‚úÖ [DASHBOARD] Dashboard mostrado');

                // CORREGIR VARIABLES DE EMPRESA - SINCRONIZAR currentCompany con selectedCompany
                if (currentCompany && currentCompany.id) {
                    // CR√çTICO: Sincronizar variables para compatibilidad con m√≥dulos existentes
                    selectedCompany = currentCompany;
                    window.selectedCompany = currentCompany;
                    console.log('‚úÖ [DASHBOARD] Empresa sincronizada:', currentCompany.id, currentCompany.name);
                } else if (selectedCompany && selectedCompany.id) {
                    console.log('‚úÖ [DASHBOARD] Empresa ya existente:', selectedCompany.id, selectedCompany.name);
                } else {
                    console.warn('‚ö†Ô∏è [DASHBOARD] No hay empresa seleccionada');
                }

                // üåç PLUG AND PLAY: Detectar y establecer idioma autom√°ticamente seg√∫n pa√≠s de empresa
                setTimeout(() => {
                    if (typeof setInitialLanguageFromCompany === 'function') {
                        console.log('üåç [DASHBOARD] Iniciando configuraci√≥n autom√°tica de idioma...');
                        setInitialLanguageFromCompany();
                    }
                }, 1500);

                // CONFIGURAR PERMISOS DE ADMIN - YA SE CONFIGURA EN EL LOGIN
                // NO sobrescribir currentUser aqu√≠ - ya viene del API de login con el ID real
                console.log('‚úÖ [DASHBOARD] Usuario ya configurado desde login:', window.currentUser);

                // CARGAR M√ìDULOS DE LA EMPRESA
                setTimeout(async () => {
                    const companyId = currentCompany?.id || selectedCompany?.id;
                    if (companyId) {
                        console.log('üß© [DASHBOARD] M√≥dulos ya cargados desde v3.0.0 endpoint');
                        try {
                            // await loadCompanyModules(companyId); // ‚ùå COMENTADO: v3.0.0 usa /api/modules/active en handleLogin
                            // Ocultar el mensaje de "Cargando m√≥dulos"
                            const loadingDiv = document.getElementById('loadingModules');
                            if (loadingDiv) loadingDiv.style.display = 'none';
                            // CREAR M√ìDULOS DIN√ÅMICAMENTE - SIMPLE Y DIRECTO
                            if (window.companyModules && window.companyModules.length > 0) {
                                const modulesContainer = document.getElementById('modulesContainer');
                                if (modulesContainer) {
                                    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 20px;">';
                                    window.companyModules.forEach((module, index) => {
                                        html += `
                                            <div onclick="window.openModuleDirect('${module.id}', '${module.name}')" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; background: white; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                                                <div style="font-size: 24px; margin-bottom: 10px;">${module.icon || 'üì¶'}</div>
                                                <div style="font-weight: bold; margin-bottom: 5px;" data-translate="modules.${module.id}.title">${module.name}</div>
                                                <div style="font-size: 12px; color: #666;" data-translate="modules.${module.id}.description">${module.description || ''}</div>
                                            </div>
                                        `;
                                    });
                                    html += '</div>';
                                    modulesContainer.innerHTML = html;

                                    // üî• TRADUCIR M√ìDULOS INMEDIATAMENTE DESPU√âS DE CARGARLOS
                                    console.log('üî• [TRANSLATION] Traduciendo m√≥dulos din√°micos del dashboard...');
                                    if (window.translator) {
                                        setTimeout(async () => {
                                            const moduleElements = modulesContainer.querySelectorAll('[data-translate]');
                                            console.log(`üî• [DASHBOARD] Encontrados ${moduleElements.length} elementos para traducir`);

                                            for (const element of moduleElements) {
                                                const key = element.getAttribute('data-translate');
                                                const translation = await window.translator.t(key);
                                                element.textContent = translation;
                                                console.log(`  ‚úÖ ${key} ‚Üí ${translation}`);
                                            }

                                            console.log('‚úÖ [TRANSLATION] M√≥dulos del dashboard traducidos');
                                        }, 300);
                                    }

                                    // üåç AGREGAR LISTENER PARA CAMBIOS DE IDIOMA - RE-TRADUCIR M√ìDULOS
                                    window.addEventListener('languageChanged', async function(event) {
                                        console.log('üåç [TRANSLATION] Idioma cambiado a:', event.detail.language);

                                        // üî• TRADUCIR M√ìDULOS ESPEC√çFICAMENTE
                                        const modulesContainer = document.getElementById('modulesContainer');
                                        if (modulesContainer && window.translator) {
                                            const moduleElements = modulesContainer.querySelectorAll('[data-translate]');
                                            console.log(`üî• [MODULES-TRANSLATION] Encontrados ${moduleElements.length} elementos en m√≥dulos`);

                                            for (const element of moduleElements) {
                                                const key = element.getAttribute('data-translate');
                                                const translation = await window.translator.t(key);
                                                element.textContent = translation;
                                                console.log(`  ‚úÖ ${key} ‚Üí ${translation}`);
                                            }
                                        }

                                        // Tambi√©n traducir el resto de la interfaz
                                        if (window.translator) {
                                            window.translator.updateInterface();
                                        }
                                    });

                                    // DEFINIR FUNCI√ìN GLOBAL PARA ABRIR M√ìDULOS
                                    window.openModuleDirect = function(moduleId, moduleName) {
                                        console.log('üéØ [MODULE] Abriendo m√≥dulo:', moduleName, 'ID:', moduleId);
                                        console.log('üîç [MODULE] showModuleContent type:', typeof showModuleContent);
                                        console.log('üîç [MODULE] window.showModuleContent type:', typeof window.showModuleContent);

                                        try {
                                            // USAR EL SWITCH STATEMENT DIRECTAMENTE
                                            console.log('üéØ [MODULE] Ejecutando switch statement para:', moduleId);

                                            switch(moduleId) {
                                                case 'attendance':
                                                case 'users':
                                                case 'departments':
                                                    // Usar el sistema de carga din√°mica showModuleContent para todos estos m√≥dulos
                                                    if (typeof showModuleContent === 'function') {
                                                        showModuleContent(moduleId, moduleName);
                                                    } else {
                                                        alert('Sistema de carga de m√≥dulos no disponible');
                                                    }
                                                    break;
                                                case 'settings':
                                                    if (typeof showSettingsContent === 'function') {
                                                        showSettingsContent();
                                                    } else {
                                                        alert('M√≥dulo settings: funci√≥n no encontrada');
                                                    }
                                                    break;
                                                case 'auditor-dashboard':
                                                case 'auditor':
                                                    // Cargar m√≥dulo del auditor
                                                    loadModuleContent('auditor-dashboard').then(() => {
                                                        // Ocultar grid de m√≥dulos
                                                        const moduleGrid = document.querySelector('.module-grid');
                                                        if (moduleGrid) moduleGrid.style.display = 'none';
                                                        // Mostrar contenido principal
                                                        const mainContent = document.getElementById('mainContent');
                                                        if (mainContent) mainContent.style.display = 'block';
                                                        // Llamar a funci√≥n del auditor
                                                        if (typeof showAuditorContent === 'function') {
                                                            showAuditorContent();
                                                        } else {
                                                            console.error('‚ùå [AUDITOR] showAuditorContent no est√° disponible');
                                                            alert('M√≥dulo Auditor: funci√≥n no encontrada');
                                                        }
                                                    }).catch(error => {
                                                        console.error('‚ùå [AUDITOR] Error cargando m√≥dulo:', error);
                                                        alert('Error cargando m√≥dulo Auditor');
                                                    });
                                                    break;
                                                case 'compliance-dashboard':
                                                case 'compliance_dashboard':
                                                    if (typeof ComplianceDashboard !== 'undefined' && ComplianceDashboard.init) {
                                                        // Ocultar grid de m√≥dulos
                                                        const moduleGrid = document.querySelector('.module-grid');
                                                        if (moduleGrid) moduleGrid.style.display = 'none';
                                                        // Mostrar contenido principal
                                                        const mainContent = document.getElementById('mainContent');
                                                        if (mainContent) mainContent.style.display = 'block';
                                                        // Inicializar m√≥dulo
                                                        ComplianceDashboard.init();
                                                    } else {
                                                        alert('M√≥dulo Compliance Dashboard: no disponible');
                                                    }
                                                    break;
                                                case 'sla-tracking':
                                                case 'sla_tracking':
                                                    if (typeof SLATracking !== 'undefined' && SLATracking.init) {
                                                        const moduleGrid = document.querySelector('.module-grid');
                                                        if (moduleGrid) moduleGrid.style.display = 'none';
                                                        const mainContent = document.getElementById('mainContent');
                                                        if (mainContent) mainContent.style.display = 'block';
                                                        SLATracking.init();
                                                    } else {
                                                        alert('M√≥dulo SLA Tracking: no disponible');
                                                    }
                                                    break;
                                                case 'resource-center':
                                                case 'resource_center':
                                                    if (typeof ResourceCenter !== 'undefined' && ResourceCenter.init) {
                                                        const moduleGrid = document.querySelector('.module-grid');
                                                        if (moduleGrid) moduleGrid.style.display = 'none';
                                                        const mainContent = document.getElementById('mainContent');
                                                        if (mainContent) mainContent.style.display = 'block';
                                                        ResourceCenter.init();
                                                    } else {
                                                        alert('M√≥dulo Resource Center: no disponible');
                                                    }
                                                    break;
                                                case 'audit-reports':
                                                case 'audit_reports':
                                                    if (typeof AuditReports !== 'undefined' && AuditReports.init) {
                                                        const moduleGrid = document.querySelector('.module-grid');
                                                        if (moduleGrid) moduleGrid.style.display = 'none';
                                                        const mainContent = document.getElementById('mainContent');
                                                        if (mainContent) mainContent.style.display = 'block';
                                                        AuditReports.init();
                                                    } else {
                                                        alert('M√≥dulo Audit Reports: no disponible');
                                                    }
                                                    break;
                                                default:
                                                    // Para otros m√≥dulos, usar el sistema showModuleContent
                                                    if (typeof showModuleContent === 'function') {
                                                        showModuleContent(moduleId, moduleName);
                                                    } else {
                                                        alert('M√≥dulo: ' + moduleName + '\\nEn desarrollo (showModuleContent no disponible)');
                                                    }
                                                    break;
                                            }
                                        } catch (error) {
                                            console.error('Error abriendo m√≥dulo:', error);
                                            alert('M√≥dulo: ' + moduleName + '\\nError: ' + error.message);
                                        }
                                    };

                                    console.log('‚úÖ [DASHBOARD] ' + window.companyModules.length + ' m√≥dulos creados din√°micamente');
                                } else {
                                    console.error('‚ùå [DASHBOARD] modulesContainer no encontrado');
                                }
                            } else {
                                console.error('‚ùå [DASHBOARD] No hay m√≥dulos para mostrar');
                            }
                            console.log('‚úÖ [DASHBOARD] M√≥dulos cargados exitosamente');
                        } catch (error) {
                            console.error('‚ùå [DASHBOARD] Error cargando m√≥dulos:', error);
                        }
                    }

                    // Cargar interfaz
                    if (typeof loadCoreInterface === 'function') {
                        loadCoreInterface();
                    }
                    // NO abrir dashboard autom√°ticamente - dejar que el usuario seleccione m√≥dulo
                    // else if (typeof showTab === 'function') {
                    //     showTab('dashboard');
                    // }
                }, 100);
            }
        }

        // MOSTRAR LOGIN
        function showLogin() {
            const loginContainer = document.getElementById('loginContainer');
            const mainContent = document.getElementById('mainContent');

            if (mainContent) {
                mainContent.style.display = 'none';
                mainContent.classList.remove('authenticated');
            }

            if (loginContainer) {
                loginContainer.style.display = 'flex';
                console.log('‚úÖ [LOGIN] Login mostrado');
                initializeMultiTenantLogin();
            }
        }

        // CERRAR SESI√ìN
        function logout() {
            console.log('üö™ [LOGOUT] Cerrando sesi√≥n...');

            // Limpiar localStorage
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentCompany');

            // Limpiar variables
            currentCompany = null;
            currentUser = null;
            authToken = null;
            isAuthenticated = false;

            // Limpiar clase del body
            document.body.classList.remove('authenticated');

            // Mostrar login
            showLogin();
        }
    </script>
    <style>
        /* SISTEMA MULTI-TENANT PROFESIONAL */

        /* LOGIN CONTAINER - OCULTO POR DEFECTO */
        .login-container {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background:
                linear-gradient(135deg, #0a0e27 0%, #1a1a2e 30%, #16213e 60%, #0f3460 100%),
                radial-gradient(circle at 25% 25%, rgba(102, 126, 234, 0.15) 0%, transparent 60%),
                radial-gradient(circle at 75% 75%, rgba(118, 75, 162, 0.12) 0%, transparent 50%);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px) saturate(180%);
            border: 2px solid rgba(102, 126, 234, 0.1);
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            max-width: 450px;
            width: 100%;
            z-index: 10;
            position: relative;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            background: linear-gradient(135deg, #1a1a2e 0%, #667eea 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6b5b95 100%);
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        /* CONTENIDO PRINCIPAL - OCULTO HASTA AUTENTICACI√ìN */
        .container, .tabs, .content, #mainContent {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            position: relative !important;
            z-index: 1000 !important;
        }

        /* DASHBOARD STYLES CUANDO EST√Å AUTENTICADO */
        #mainContent.authenticated {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        #mainContent.authenticated .container,
        #mainContent.authenticated .tabs,
        #mainContent.authenticated .content,
        #mainContent.authenticated .tab-content,
        #mainContent.authenticated .module-section,
        #mainContent.authenticated .dashboard-content,
        #mainContent.authenticated > * {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* FORZAR VISIBILIDAD DE TODOS LOS ELEMENTOS DEL DASHBOARD */
        body.authenticated .container,
        body.authenticated .header,
        body.authenticated .module-grid,
        body.authenticated .tabs,
        body.authenticated .content,
        body.authenticated .tab-content,
        body.authenticated .module-section,
        body.authenticated .dashboard-content {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .tabs {
            background: white !important;
            padding: 10px !important;
            margin: 10px 0 !important;
        }
        
        #mainContent {
            background: white !important;
            padding: 20px !important;
            min-height: 500px !important;
            border: 1px solid #ddd !important;
        }
        
        #mainContent .tab-content.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Modal de Login Empresarial - DESHABILITADO COMPLETAMENTE */
        .company-login-modal {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            z-index: -9999 !important;
            position: fixed !important;
            top: -9999px !important;
            left: -9999px !important;
            pointer-events: none !important;
            transform: scale(0) !important;
        }
        
        .company-login-content {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
        }
        
        .company-login-content h2 {
            margin-bottom: 10px;
            color: #333;
            font-size: 24px;
        }
        
        .company-selector {
            margin: 8px 0;
        }
        
        .login-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            min-height: 20px;
        }
        
        .login-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .login-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .login-status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .password-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            z-index: 10;
            padding: 4px;
            line-height: 1;
        }
        
        .password-toggle:hover {
            color: #0066CC;
        }
    </style>

    <!-- üì± Responsive CSS para m√≥viles/tablets -->
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <!-- üì± Bot√≥n men√∫ m√≥vil (solo visible en m√≥vil) -->
    <button class="mobile-menu-btn" onclick="toggleMobileSidebar()" style="display: none;">
        ‚ò∞
    </button>

    <!-- üì± Overlay para cerrar sidebar en m√≥vil -->
    <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

    <!-- üè¢ MODAL DE LOGIN MULTI-TENANT PROFESIONAL -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>üè¢ Aponnt Suite's</h1>
                <p style="color: #667eea; font-size: 16px; font-weight: 600; margin-bottom: 5px;">Acceso Empresarial Multi-Tenant</p>
            </div>

            <form id="multiTenantLoginForm">
                <!-- PASO 1: SELECCIONAR EMPRESA -->
                <div class="form-group">
                    <label for="companySelect" data-translate="login.select_company">üè¢ Seleccionar Empresa</label>
                    <select id="companySelect" class="form-control" required>
                        <option value="" data-translate="login.loading_companies">Cargando empresas...</option>
                    </select>
                    <div class="error-message" id="companyError"></div>
                </div>

                <!-- PASO 2: INGRESAR USUARIO (CAMPO DE TEXTO LIBRE) -->
                <div class="form-group">
                    <label for="userInput" data-translate="login.username">Usuario:</label>
                    <input type="text" id="userInput" class="form-control" placeholder="Ingrese su usuario" data-translate-placeholder="login.enter_username" required disabled>
                    <div class="error-message" id="userError"></div>
                </div>

                <!-- PASO 3: CONTRASE√ëA -->
                <div class="form-group">
                    <label for="passwordInput" data-translate="login.password">Contrase√±a:</label>
                    <input type="password" id="passwordInput" class="form-control" required disabled>
                    <div class="error-message" id="passwordError"></div>
                </div>

                <!-- BOT√ìN DE LOGIN -->
                <button type="submit" id="loginButton" class="btn-primary" data-translate="login.login_button" disabled>
                    üöÄ Iniciar Sesi√≥n
                </button>

                <div class="error-message" id="generalError"></div>
            </form>
        </div>
    </div>

    <!-- Modal de Login Empresarial -->
    <div id="companyLoginModal" class="company-login-modal" style="display: none !important; visibility: hidden !important; opacity: 0 !important; z-index: -9999 !important;">
        <div class="company-login-content">
            <div style="margin-bottom: 12px;">
                <h1 style="color: #0066CC; font-size: 1.8em; margin-bottom: 6px; font-weight: bold; transform: translateY(-10px);">
                    <span style="color: #0066CC; font-size: 1.2em; font-weight: bold; font-style: italic; transform: skewX(-15deg); display: inline-block;">A</span><span style="color: #333; font-weight: normal;">ponnt </span><span style="color: #0066CC; font-size: 1.2em; font-weight: bold; font-style: italic; transform: skewX(-15deg); display: inline-block;">S</span><span style="color: #333; font-weight: normal;">uite's</span>
                </h1>
                <h2 style="color: #333; font-size: 1.0em; margin-bottom: 4px; font-weight: 600; line-height: 1.2;">Sistema Integral de Administraci√≥n<br>de Los Recursos Humanos</h2>
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 8px; border-radius: 8px; margin: 12px 0; border: 1px solid #dee2e6; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">PR</div>
                        <div style="color: #495057; font-size: 0.85em; text-align: left;">
                            <div id="ownerName" style="font-weight: 600; margin-bottom: 2px;">Propietario Sistema</div>
                            <div id="ownerPhone" style="font-size: 0.8em;">üìû +54 000 000000</div>
                        </div>
                    </div>
                    <div id="ownerLocation" style="color: #495057; font-size: 0.75em; font-style: italic; text-align: right;">Ubicaci√≥n<br>Ciudad, Provincia</div>
                </div>
            </div>
            <p style="margin-bottom: 12px; color: #666; font-size: 14px;">Seleccione su empresa:</p>
            
            <div class="company-selector" style="margin: 10px 0;">
                <select id="companySelect" style="width: 100%; padding: 10px; border: 2px solid #e1e8ff; border-radius: 6px; font-size: 15px; background: white;">
                    <option value="" data-translate="login.select_company">üè¢ Seleccionar Empresa...</option>
                </select>
            </div>
            
            <div class="login-form" id="loginForm" style="display: none !important; visibility: hidden !important; opacity: 0 !important; z-index: -1 !important;">
                <div class="form-group">
                    <input type="text" id="userEmail" placeholder="üë§ Usuario" style="width: 100%; padding: 10px; border: 2px solid #e1e8ff; border-radius: 6px; font-size: 15px; margin-bottom: 8px;">
                </div>
                <div class="form-group">
                    <div class="password-container" style="margin-bottom: 12px;">
                        <input type="password" id="userPassword" placeholder="üîí Contrase√±a" style="width: 100%; padding: 10px 40px 10px 10px; border: 2px solid #e1e8ff; border-radius: 6px; font-size: 15px;">
                        <button type="button" class="password-toggle" onclick="togglePassword('userPassword', this)">üëÅÔ∏è</button>
                    </div>
                </div>
                <div class="form-group" style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px; background: #f8faff; padding: 8px; border-radius: 6px; border: 1px solid #e1e8ff;">
                    <input type="checkbox" id="rememberMe" style="margin-right: 8px; width: 16px; height: 16px; accent-color: #667eea;">
                    <label for="rememberMe" style="font-size: 14px; color: #495057; font-weight: 500; cursor: pointer;">üîÑ Permanecer conectado</label>
                </div>
                <button id="loginButton" style="width: 100%; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                    üöÄ Acceder
                </button>
            </div>
            
            <!-- Botones de acci√≥n - Solo inicializar empresa -->
            <div class="action-buttons" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e7ff; text-align: center;">
                <!-- Bot√≥n de Nueva Empresa removido - SuperAdmin eliminado -->
                <div style="padding: 8px 16px; background: #f8f9fa; color: #6c757d; border-radius: 6px; font-size: 13px; text-align: center;">
                    üè¢ Seleccione una empresa para continuar
                </div>
            </div>
            
            <div id="companyLoginStatus" class="login-status"></div>
        </div>
    </div>

    <!-- Modal de Super Administrador eliminado -->

    <!-- Modal de Inicializar Empresa - OCULTO PERMANENTEMENTE -->
    <div id="initCompanyModal" class="modal" style="display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; position: fixed; top: -9999px; left: -9999px; width: 0; height: 0; z-index: -1;">
        <div class="modal-content" style="position: relative; margin: 5% auto; width: 90%; max-width: 600px; background: white; border-radius: 12px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; padding: 20px 30px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">üèóÔ∏è Inicializar Nueva Empresa</h3>
                <button onclick="closeInitCompanyModal()" style="background: none; border: none; color: #212529; font-size: 24px; cursor: pointer; opacity: 0.8;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 10px;">
                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="font-size: 3em; margin-bottom: 10px;">üè¢</div>
                    <p style="color: #666; margin: 0;">Configure una nueva empresa en el sistema con sus par√°metros iniciales</p>
                </div>
                
                <form id="initCompanyForm" onsubmit="performCompanyInitialization(event)">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Nombre de la Empresa *</label>
                            <input type="text" id="initCompanyName" required style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">C√≥digo/Slug *</label>
                            <input type="text" id="initCompanySlug" required style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 6px;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email Administrador *</label>
                            <input type="email" id="initAdminEmail" required style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Contrase√±a Admin *</label>
                            <div class="password-container">
                                <input type="password" id="initAdminPassword" required style="width: 100%; padding: 12px 45px 12px 12px; border: 2px solid #e0e7ff; border-radius: 6px;">
                                <button type="button" class="password-toggle" onclick="togglePassword('initAdminPassword', this)">üëÅÔ∏è</button>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tipo de Licencia</label>
                        <select id="initLicenseType" style="width: 100%; padding: 12px; border: 2px solid #e0e7ff; border-radius: 6px;">
                            <option value="standard">Est√°ndar</option>
                            <option value="premium">Premium</option>
                            <option value="enterprise">Enterprise</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h4 style="margin-bottom: 10px; color: #0066CC;">üì¶ M√≥dulos Iniciales</h4>
                        <div style="background: #f8faff; padding: 10px; border-radius: 8px; border: 2px solid #e0e7ff;">
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                                <input type="checkbox" id="basicModules" checked style="transform: scale(1.2);">
                                <span style="font-weight: 600;">M√≥dulos B√°sicos (Dashboard, Usuarios, Asistencia, Turnos)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                                <input type="checkbox" id="hrModules" style="transform: scale(1.2);">
                                <span style="font-weight: 600;">M√≥dulos RRHH (Liquidaci√≥n, Permisos, Documentos)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="advancedModules" style="transform: scale(1.2);">
                                <span style="font-weight: 600;">M√≥dulos Avanzados (Biometr√≠a Anal√≠tica, Legal, ART)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button type="button" onclick="closeInitCompanyModal()" 
                                style="padding: 12px 25px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            Cancelar
                        </button>
                        <button type="submit" 
                                style="padding: 12px 25px; background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(255,193,7,0.3);">
                            üèóÔ∏è Inicializar
                        </button>
                    </div>
                </form>
                
                <div id="initCompanyStatus" style="margin-top: 15px; padding: 10px; border-radius: 8px; min-height: 20px; text-align: center;"></div>
            </div>
        </div>
    </div>

    <div class="container" id="mainSystemContainer" style="display: none;">
        
        <!-- Script para actualizar fecha y hora en tiempo real -->
        <script>
            function updateDateTime() {
                const now = new Date();
                const dateOptions = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric'
                };
                const timeOptions = {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                
                const dateElement = document.getElementById('currentDate');
                const timeElement = document.getElementById('currentTime');

                if (dateElement) dateElement.textContent = now.toLocaleDateString('es-ES', dateOptions);
                if (timeElement) timeElement.textContent = now.toLocaleTimeString('es-ES', timeOptions);
            }
            
            // Ejecutar cuando el DOM est√© completamente cargado
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('üìÖ [DATETIME] Iniciando actualizaci√≥n de fecha/hora...');
                    updateDateTime();
                    setInterval(updateDateTime, 1000);
                });
            } else {
                // El DOM ya est√° listo
                console.log('üìÖ [DATETIME] DOM listo, iniciando fecha/hora...');
                updateDateTime();
                setInterval(updateDateTime, 1000);
            }
            
            /* ‚úÖ C√ìDIGO FUNCIONAL PROTEGIDO - NO MODIFICAR SIN AN√ÅLISIS
             * üìÖ Fecha: 23/SEP/2025 04:02:00
             * üè∑Ô∏è Versi√≥n: v2.1.2
             * üìã Funcionalidad: Sistema actualizaci√≥n header din√°mico con datos reales
             * ‚ö†Ô∏è IMPORTANTE: Este c√≥digo maneja login, empresa y usuario - verificar impacto antes de cambios
             */
            function updateUserInfo() {
                // Esta funci√≥n se llamar√° cuando el usuario se loguee
                console.log('üîç [HEADER DEBUG] updateUserInfo() ejecut√°ndose...');
                const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
                console.log('üîç [HEADER DEBUG] userData:', userData);

                if (userData.firstName) {
                    document.getElementById('currentUserName').textContent = `${userData.firstName} ${userData.lastName}`;
                    document.getElementById('currentUserRole').textContent = userData.role.toUpperCase();

                    // Si el usuario tiene foto, la mostramos, sino usamos iniciales
                    if (userData.photoUrl) {
                        document.getElementById('userAvatar').innerHTML = `<img src="${userData.photoUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />`;
                    } else {
                        // Usar iniciales como avatar
                        const initials = (userData.firstName.charAt(0) + userData.lastName.charAt(0)).toUpperCase();
                        document.getElementById('userAvatar').textContent = initials;
                    }
                }

                // DESACTIVADO - traducci√≥n simplificada
                // // initializeLanguageSelector(); // DESACTIVADO

                // ‚úÖ NUEVO v2.1.2: Actualizar informaci√≥n de empresa y foto tambi√©n
                updateCompanyInfo();
                updateUserPhoto(); // ‚úÖ Intentar cargar foto real desde m√≥dulo usuarios
            }

            /* ‚úÖ C√ìDIGO FUNCIONAL PROTEGIDO - NO MODIFICAR SIN AN√ÅLISIS
             * üìÖ Fecha: 23/SEP/2025 04:02:00
             * üè∑Ô∏è Versi√≥n: v2.1.2
             * üìã Funcionalidad: Sistema actualizaci√≥n empresa din√°mico con datos reales PostgreSQL
             * ‚ö†Ô∏è IMPORTANTE: Este c√≥digo maneja datos empresa seleccionada - verificar impacto antes de cambios
             */
            async function updateCompanyInfo() {
                try {
                    console.log('üîç [HEADER DEBUG] updateCompanyInfo() ejecut√°ndose...');
                    const savedCompanyStr = localStorage.getItem('selectedCompany');
                    const selectedCompany = (savedCompanyStr && savedCompanyStr !== 'undefined') ? JSON.parse(savedCompanyStr) : {};
                    console.log('üîç [HEADER DEBUG] selectedCompany:', selectedCompany);

                    if (selectedCompany && selectedCompany?.id) {
                        // Actualizar datos de empresa en header
                        document.getElementById('companyNameDisplay').textContent = selectedCompany?.name || 'Empresa Cliente';
                        document.getElementById('companyAddressDisplay').textContent = selectedCompany.address || 'Direcci√≥n empresa';
                        document.getElementById('companyPhoneDisplay').textContent = `üìû ${selectedCompany.phone || 'Tel√©fono'}`;

                        console.log(`‚úÖ [HEADER v2.1.2] Empresa actualizada: ${selectedCompany?.name}`);
                    } else {
                        console.log('‚ö†Ô∏è [HEADER DEBUG] No hay empresa seleccionada o falta ID');
                    }
                } catch (error) {
                    console.error('‚ùå [HEADER v2.1.2] Error actualizando empresa:', error);
                }
            }

            /* ‚úÖ C√ìDIGO FUNCIONAL PROTEGIDO - NO MODIFICAR SIN AN√ÅLISIS
             * üìÖ Fecha: 23/SEP/2025 04:02:00
             * üè∑Ô∏è Versi√≥n: v2.1.2
             * üìã Funcionalidad: Sistema actualizaci√≥n foto usuario desde m√≥dulo usuarios
             * ‚ö†Ô∏è IMPORTANTE: Este c√≥digo consulta la ficha personal del usuario - verificar impacto antes de cambios
             */
            async function updateUserPhoto() {
                try {
                    const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
                    if (userData && userData.id) {
                        // Intentar obtener foto de la ficha personal
                        const response = await fetch(`/api/aponnt/dashboard/users/${userData.id}/profile`, {
                            headers: {
                                'Authorization': 'Bearer ' + (localStorage.getItem('token') || 'token_test'),
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const profileData = await response.json();
                            if (profileData && profileData.photoUrl) {
                                document.getElementById('userAvatar').innerHTML =
                                    `<img src="${profileData.photoUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />`;
                                console.log('‚úÖ [HEADER v2.1.2] Foto usuario actualizada desde ficha personal');
                                return;
                            }
                        }

                        // Fallback: usar iniciales si no hay foto
                        if (userData.firstName && userData.lastName) {
                            const initials = (userData.firstName.charAt(0) + userData.lastName.charAt(0)).toUpperCase();
                            document.getElementById('userAvatar').textContent = initials;
                            console.log('‚úÖ [HEADER v2.1.2] Usando iniciales como avatar');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå [HEADER v2.1.2] Error actualizando foto usuario:', error);
                    // Fallback en caso de error
                    document.getElementById('userAvatar').textContent = 'üë§';
                }
            }
            
            // Establecer idioma inicial basado en pa√≠s de empresa (MEJORADO - PLUG AND PLAY v2)
            function setInitialLanguageFromCompany() {
                try {
                    // Intentar obtener empresa desde m√∫ltiples fuentes
                    let company = window.currentCompany || window.selectedCompany;

                    if (!company) {
                        const savedCompanyStr = localStorage.getItem('selectedCompany') || localStorage.getItem('currentCompany');
                        company = (savedCompanyStr && savedCompanyStr !== 'undefined') ? JSON.parse(savedCompanyStr) : null;
                    }

                    console.log('üåç [AUTO-LANG] Iniciando detecci√≥n autom√°tica...');
                    console.log('üåç [AUTO-LANG] Empresa:', company?.name);
                    console.log('üåç [AUTO-LANG] Translator disponible:', !!window.translator);

                    if (!company) {
                        console.warn('‚ö†Ô∏è [AUTO-LANG] No hay empresa disponible');
                        return;
                    }

                    if (!window.translator) {
                        console.warn('‚ö†Ô∏è [AUTO-LANG] Translator no disponible, reintentando en 500ms...');
                        setTimeout(setInitialLanguageFromCompany, 500);
                        return;
                    }

                    // Detectar pa√≠s desde m√∫ltiples fuentes: country, address, location
                    let detectedCountry = null;
                    const addressString = (company.country || company.address || company.location || '').toLowerCase();

                    console.log('üåç [AUTO-LANG] Direcci√≥n completa:', addressString);

                    // Mapeo inteligente de pa√≠ses/palabras clave a idiomas
                    const countryPatterns = {
                        'es': ['argentina', 'espa√±a', 'spain', 'm√©xico', 'mexico', 'chile', 'colombia', 'per√∫', 'peru', 'venezuela', 'uruguay', 'paraguay', 'bolivia', 'ecuador', 'san luis', 'buenos aires', 'madrid', 'barcelona'],
                        'en': ['united states', 'usa', 'estados unidos', 'united kingdom', 'uk', 'canada', 'australia', 'new zealand', 'ireland'],
                        'pt': ['brazil', 'brasil', 'portugal', 's√£o paulo', 'rio de janeiro', 'lisboa'],
                        'de': ['germany', 'alemania', 'deutschland', 'austria', '√∂sterreich', 'schweiz', 'berlin', 'm√ºnchen'],
                        'it': ['italy', 'italia', 'rome', 'roma', 'milan', 'milano'],
                        'fr': ['france', 'francia', 'paris', 'lyon', 'marseille', 'belgium', 'b√©lgica', 'switzerland', 'suiza']
                    };

                    // Buscar coincidencia en la direcci√≥n
                    let detectedLanguage = 'es'; // Default: espa√±ol
                    for (const [lang, patterns] of Object.entries(countryPatterns)) {
                        for (const pattern of patterns) {
                            if (addressString.includes(pattern)) {
                                detectedLanguage = lang;
                                detectedCountry = pattern;
                                console.log(`‚úÖ [AUTO-LANG] Coincidencia encontrada: "${pattern}" ‚Üí ${lang}`);
                                break;
                            }
                        }
                        if (detectedCountry) break;
                    }

                    console.log(`üåç [AUTO-LANG] Pa√≠s detectado: "${detectedCountry || 'default'}" ‚Üí Idioma: ${detectedLanguage}`);

                    // SIEMPRE establecer el idioma autom√°ticamente al hacer login (ignorar user_language en login)
                    // El usuario puede cambiarlo manualmente despu√©s
                    console.log(`üîÑ [AUTO-LANG] Cambiando idioma autom√°ticamente a: ${detectedLanguage}`);

                    window.translator.changeLanguage(detectedLanguage).then(() => {
                        console.log(`‚úÖ [AUTO-LANG] Idioma cambiado exitosamente a: ${detectedLanguage.toUpperCase()}`);

                        // Actualizar el selector de idioma para reflejar el cambio
                        setTimeout(() => {
                            const selector = document.querySelector('#languageSelectorContainer select');
                            if (selector) {
                                selector.value = detectedLanguage;
                                console.log(`‚úÖ [AUTO-LANG] Selector actualizado a: ${detectedLanguage}`);
                            }
                        }, 200);
                    }).catch(error => {
                        console.error('‚ùå [AUTO-LANG] Error cambiando idioma:', error);
                    });

                } catch (error) {
                    console.error('‚ùå [AUTO-LANG] Error en detecci√≥n autom√°tica:', error);
                }
            }

            function initializeLanguageSelector() {
                const container = document.getElementById('languageSelectorContainer');
                if (!container) {
                    console.error('‚ùå [HEADER] No se encontr√≥ languageSelectorContainer');
                    return;
                }

                if (container.hasChildNodes()) {
                    console.log('‚ö†Ô∏è [HEADER] Selector de idioma ya existe');
                    return;
                }

                if (window.translator && typeof window.translator.createLanguageSelector === 'function') {
                    try {
                        const selector = window.translator.createLanguageSelector();
                        if (selector) {
                            container.innerHTML = '';
                            container.appendChild(selector);
                            console.log('‚úÖ [HEADER] Selector de idioma inicializado correctamente');
                            return;
                        }
                    } catch (error) {
                        console.error('‚ùå [HEADER] Error creando selector:', error);
                    }
                }

                // Fallback: crear selector simple si el translator no est√° disponible
                console.warn('‚ö†Ô∏è [HEADER] Usando selector de idioma fallback');
                const fallbackSelector = document.createElement('select');
                fallbackSelector.style.cssText = `
                    padding: 4px 8px;
                    border: 1px solid rgba(255,255,255,0.3);
                    border-radius: 4px;
                    background: rgba(255,255,255,0.1);
                    color: white;
                    font-size: 11px;
                    min-width: 120px;
                    cursor: pointer;
                `;

                const languages = {
                    'es': 'üá™üá∏ ESPA√ëOL',
                    'en': 'üá∫üá∏ ENGLISH',
                    'pt': 'üáßüá∑ PORTUGU√äS',
                    'de': 'üá©üá™ DEUTSCH',
                    'it': 'üáÆüáπ ITALIANO',
                    'fr': 'üá´üá∑ FRAN√áAIS'
                };

                const currentLang = window.translator?.currentLanguage || 'es';

                Object.entries(languages).forEach(([code, name]) => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = name;
                    option.style.color = '#333';
                    option.style.background = 'white';
                    if (code === currentLang) option.selected = true;
                    fallbackSelector.appendChild(option);
                });

                fallbackSelector.addEventListener('change', async function() {
                    const selectedLang = this.value;
                    console.log('üåç [LANGUAGE] Usuario cambi√≥ idioma a:', selectedLang);

                    if (window.translator && typeof window.translator.changeLanguage === 'function') {
                        await window.translator.changeLanguage(selectedLang);
                        console.log('‚úÖ [LANGUAGE] Idioma cambiado con translator a:', selectedLang);
                    } else {
                        localStorage.setItem('user_language', selectedLang);
                        console.log('‚ö†Ô∏è [LANGUAGE] Idioma guardado sin translator, recargando...');
                        location.reload();
                    }
                });

                container.innerHTML = '';
                container.appendChild(fallbackSelector);
                console.log('‚úÖ [HEADER] Selector de idioma fallback creado y agregado al DOM');
            }
            
            // ‚úÖ FUNCI√ìN PARA OBTENER DATOS REALES - V2.1.2
            async function loadRealCompanyData() {
                try {
                    console.log('üîÑ [REAL DATA] Cargando datos reales de empresas...');

                    // Llamar a la API para obtener empresas reales
                    const response = await fetch('/api/aponnt/dashboard/companies', {
                        headers: {
                            'Authorization': 'Bearer ' + (localStorage.getItem('token') || 'token_test'),
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const companies = data.companies || data || [];
                        console.log('‚úÖ [REAL DATA] Empresas cargadas:', companies.length);

                        // Si no hay empresa seleccionada, tomar la primera disponible
                        const savedCompanyStr = localStorage.getItem('selectedCompany');
                        const selectedCompany = (savedCompanyStr && savedCompanyStr !== 'undefined') ? JSON.parse(savedCompanyStr) : {};
                        if ((!selectedCompany || !selectedCompany?.id) && companies.length > 0) {
                            const firstCompany = companies[0];
                            localStorage.setItem('selectedCompany', JSON.stringify(firstCompany));
                            console.log('‚úÖ [REAL DATA] Empresa seleccionada autom√°ticamente:', firstCompany.name);
                            updateCompanyInfo(); // ‚úÖ Actualizar UI inmediatamente
                        }
                    } else {
                        console.log('‚ö†Ô∏è [REAL DATA] Error cargando empresas, usando datos existentes');
                    }
                } catch (error) {
                    console.error('‚ùå [REAL DATA] Error:', error);
                }
            }

            async function loadRealUserData() {
                try {
                    console.log('üîÑ [REAL DATA] Verificando datos reales de usuario...');

                    // Intentar obtener datos de usuario desde el token o API
                    const token = localStorage.getItem('token');
                    if (token && token !== 'token_test') {
                        // Aqu√≠ podr√≠as decodificar el token JWT para obtener datos del usuario
                        console.log('‚úÖ [REAL DATA] Token de usuario v√°lido encontrado');
                    }

                    // Si no hay datos de usuario v√°lidos, mantener los existentes o usar defaults m√≠nimos
                    const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
                    if (!userData.firstName) {
                        console.log('‚ö†Ô∏è [REAL DATA] No hay datos de usuario, manteniendo defaults');
                    }
                } catch (error) {
                    console.error('‚ùå [REAL DATA] Error cargando datos usuario:', error);
                }
            }

            // ‚úÖ BACKEND AUTO-DISCOVERY v2.4.0 - Railway Compatible
            let DETECTED_BACKEND_URL = null;

            async function discoverBackendPort() {
                // Detectar si estamos en producci√≥n
                const isProduction = !window.location.port ||
                                    window.location.hostname.includes('railway.app') ||
                                    window.location.hostname.includes('herokuapp.com') ||
                                    window.location.hostname.includes('vercel.app') ||
                                    window.location.hostname.includes('onrender.com');

                if (isProduction) {
                    // üöÇ PRODUCCI√ìN: Usar la URL actual sin puerto
                    console.log('üöÇ [BACKEND-DISCOVERY] Modo PRODUCCI√ìN - usando URL base');
                    const testUrl = `${window.location.protocol}//${window.location.hostname}`;

                    try {
                        const response = await fetch(`${testUrl}/api/v1/health`, {
                            method: 'GET',
                            signal: AbortSignal.timeout(2000)
                        });

                        if (response.ok) {
                            console.log(`‚úÖ [BACKEND-DISCOVERY] Backend encontrado en producci√≥n: ${testUrl}`);
                            DETECTED_BACKEND_URL = testUrl;
                            return testUrl;
                        }
                    } catch (error) {
                        console.error('‚ùå [BACKEND-DISCOVERY] Error en producci√≥n:', error);
                        return null;
                    }
                } else {
                    // üíª LOCAL: Probar puertos comunes
                    console.log('üíª [BACKEND-DISCOVERY] Modo LOCAL - probando puertos');
                    const commonPorts = [window.DYNAMIC_CONFIG.port, 9997, 9998, 9999, 3000, 3001, 8080, 8000];

                    for (const port of commonPorts) {
                        try {
                            console.log(`üîç [BACKEND-DISCOVERY] Probando puerto ${port}...`);
                            const testUrl = `http://localhost:${port}`;
                            const response = await fetch(`${testUrl}/api/v1/health`, {
                                method: 'GET',
                                signal: AbortSignal.timeout(2000)
                            });

                            if (response.ok) {
                                console.log(`‚úÖ [BACKEND-DISCOVERY] Backend encontrado en puerto ${port}`);
                                DETECTED_BACKEND_URL = testUrl;
                                return testUrl;
                            }
                        } catch (error) {
                            console.log(`‚ùå [BACKEND-DISCOVERY] Puerto ${port} no disponible`);
                        }
                    }

                    console.warn('‚ùå [BACKEND-DISCOVERY] No se encontr√≥ backend en ning√∫n puerto');
                }

                return null;
            }

            async function checkBackendStatus() {
                // Si no tenemos URL detectada, intentar descubrirla
                if (!DETECTED_BACKEND_URL) {
                    DETECTED_BACKEND_URL = await discoverBackendPort();
                }

                if (!DETECTED_BACKEND_URL) {
                    console.error('‚ùå [BACKEND-CHECK] Backend no disponible en ning√∫n puerto');
                    return false;
                }

                try {
                    const response = await fetch(`${DETECTED_BACKEND_URL}/api/v1/health`, {
                        method: 'GET',
                        signal: AbortSignal.timeout(3000)
                    });

                    if (response.ok) {
                        console.log(`‚úÖ [BACKEND-CHECK] Backend verificado en ${DETECTED_BACKEND_URL}`);
                        return true;
                    } else {
                        throw new Error(`Backend responde con error: ${response.status}`);
                    }
                } catch (error) {
                    console.warn('‚ùå [BACKEND-CHECK] Backend no disponible:', error.message);
                    showBackendWarning();
                    return false;
                }
            }

            function showBackendWarning() {
                const warningDiv = document.createElement('div');
                warningDiv.id = 'backend-warning';
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 99999;
                    color: white;
                    font-family: Arial, sans-serif;
                `;

                warningDiv.innerHTML = `
                    <div style="background: #1a1a1a; padding: 30px; border-radius: 10px; text-align: center; max-width: 500px;">
                        <h2 style="color: #ff6b6b; margin-bottom: 20px;">‚ö†Ô∏è Backend No Detectado</h2>
                        <p style="margin-bottom: 15px;">El sistema necesita el backend ejecut√°ndose en puerto <strong id="dynamicPortDisplay"></strong></p>
                        <div style="background: #2d2d2d; padding: 15px; border-radius: 5px; margin: 20px 0;">
                            <h3 style="color: #4ecdc4; margin-bottom: 10px;">üöÄ Para iniciar el backend:</h3>
                            <p style="font-family: monospace; background: #000; padding: 10px; border-radius: 3px;">
                                Haz doble clic en: <strong>INICIO_AUTOMATICO.bat</strong>
                            </p>
                            <p style="margin-top: 10px; font-size: 14px; color: #aaa;">
                                O abre terminal y ejecuta: <code>cd backend && PORT=9999 npm start</code>
                            </p>
                        </div>
                        <button onclick="window.location.reload()" style="
                            background: #4ecdc4;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            color: white;
                            cursor: pointer;
                            margin-right: 10px;
                        ">üîÑ Verificar Nuevamente</button>
                        <button onclick="document.getElementById('backend-warning').style.display='none'" style="
                            background: #666;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            color: white;
                            cursor: pointer;
                        ">‚ö†Ô∏è Continuar sin Backend</button>
                    </div>
                `;

                document.body.appendChild(warningDiv);
            }

            // Llamar cuando la p√°gina se carga
            document.addEventListener('DOMContentLoaded', async () => {
                console.log('üéØ [HEADER] DOM loaded, inicializando componentes...');

                // üö´ BYPASS DESACTIVADO - AHORA SE REQUIERE LOGIN SIEMPRE
                console.log('üîê [NO-BYPASS] Login requerido - no hay bypass autom√°tico');

                // COMENTADO TODO EL BYPASS PARA FORZAR LOGIN:
                // window.selectedCompany = {id: 11, name: 'ISI', slug: 'isi'};
                // window.companyAuthToken = 'token...';
                // window.isAuthenticated = true;
                // (resto del c√≥digo de bypass eliminado)

                // NO HAY return - continuar con flujo normal de login

                // ‚ùå C√ìDIGO DESHABILITADO COMPLETAMENTE
                if (false) {
                // ‚úÖ DEFINIR FUNCI√ìN ANTES DE USAR v2.3.0
                function handleCompanySelection() {
                    console.log('üî•üî•üî• [COMPANY-SELECT] FUNCI√ìN EJECUTADA! Usuario seleccion√≥:', this.value);
                    console.log('üîç [COMPANY-SELECT] availableCompanies:', availableCompanies);

                    if (this.value && this.value !== "") {
                        selectedCompany = availableCompanies.find(c => c.slug === this.value);
                        console.log('üîç [COMPANY-SELECT] selectedCompany encontrada:', selectedCompany);
                        if (selectedCompany) {
                            console.log('‚úÖ [COMPANY-SELECT] Empresa seleccionada correctamente:', selectedCompany?.name);

                            // ‚úÖ BYPASS AUTOM√ÅTICO PARA ISI (Company ID: 11)
                            console.log('üî• [DEBUG-ISI] Verificando ISI - ID:', selectedCompany?.id, 'Name:', selectedCompany?.name);
                            if (selectedCompany?.id === 11 || selectedCompany?.name?.toLowerCase().includes('isi')) {
                                console.log('üöÄüöÄüöÄ [ISI-BYPASS] ¬°¬°¬°APLICANDO BYPASS AUTOM√ÅTICO PARA ISI!!!');

                                // Asignar token JWT v√°lido directamente
                                companyAuthToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjA1OTNmOTcxLTg0NjEtNGU2Ny04MGExLTFmZGRkMTg5MzJmNCIsImVtYWlsIjoiYWRtaW5AdGVzdC1jb21wYW55LmNvbSIsImNvbXBhbnlfaWQiOjQsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc1ODgxMTk1OSwiZXhwIjoxNzU4ODk4MzU5fQ.4wskIaStFAas4kVF4L6Mn3z_SXNZKfLbi97L1bem2Hc';
                                authToken = companyAuthToken;
                                isAuthenticated = true;

                                // Configurar usuario ISI
                                currentUser = {
                                    id: '0593f971-8461-4e67-80a1-1fddd18932f4',
                                    email: 'admin@isi.com',
                                    company_id: selectedCompany.id,
                                    role: 'admin',
                                    firstName: 'Admin',
                                    lastName: 'ISI'
                                };

                                console.log('‚úÖ [ISI-BYPASS] Usuario ISI configurado autom√°ticamente');
                            }

                            // ‚úÖ Guardar empresa en localStorage y actualizar UI
                            localStorage.setItem('selectedCompany', JSON.stringify(selectedCompany));
                            updateCompanyInfo(); // ‚úÖ Actualizar informaci√≥n en header

                            // ‚úÖ RECARGAR M√ìDULOS CUANDO CAMBIE LA EMPRESA
                            console.log('üîÑ [COMPANY-SELECT] Recargando m√≥dulos para empresa:', selectedCompany?.name);
                            loadContractedModules().catch(error => {
                                console.error('‚ùå [COMPANY-SELECT] Error recargando m√≥dulos:', error);
                            });

                            showLoginForm();
                        } else {
                            console.error('‚ùå [COMPANY-SELECT] No se encontr√≥ empresa con slug:', this.value);
                            console.log('üîç [COMPANY-SELECT] Slugs disponibles:', availableCompanies.map(c => c.slug));
                        }
                    } else {
                        console.log('‚ö†Ô∏è [COMPANY-SELECT] Valor vac√≠o seleccionado');
                        hideLoginForm();
                    }
                }

                async function forceLoadCompaniesDropdown() {
                    try {
                        console.log('üî• [FORCE-DROPDOWN] *** FORZANDO CARGA DIRECTA DE EMPRESAS ***');

                        // ‚úÖ Usar el endpoint que sabemos que funciona
                        const apiUrl = `${window.getDynamicUrl('/api/aponnt/dashboard/companies')}`;
                        console.log('üî• [FORCE-DROPDOWN] URL:', apiUrl);

                        const response = await fetch(apiUrl, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'}
                        });

                        if (!response.ok) {
                            throw new Error(`API error: ${response.status}`);
                        }

                        const result = await response.json();
                        console.log('üî• [FORCE-DROPDOWN] Respuesta API:', result);

                        const companies = result.companies || result;
                        if (!Array.isArray(companies) || companies.length === 0) {
                            throw new Error('No se encontraron empresas');
                        }

                        // ‚úÖ Actualizar availableCompanies globalmente
                        availableCompanies = companies.map(company => ({
                            id: company.company_id,
                            name: company.name,
                            slug: company.slug || company.name.toLowerCase().replace(/[^a-z0-9]/g, '-'),
                            contact_email: company.contact_email || company.contactEmail,
                            phone: company.phone || company.contactPhone,
                            address: company.address,
                            is_active: company.status === 'active',
                            activeModules: company.active_modules || {},
                            modulesPricing: company.modules_pricing || {},
                            adminUser: {
                                username: (company.name || '').toLowerCase().replace(/[^a-z0-9]/g, '') + '_admin',
                                email: company.contact_email || company.contactEmail,
                                role: 'company_admin'
                            }
                        }));

                        console.log(`üî• [FORCE-DROPDOWN] Empresas procesadas: ${availableCompanies.length}`);

                        // ‚úÖ FORZAR POBLACI√ìN DEL DROPDOWN
                        const select = document.getElementById('companySelect');
                        if (select) {
                            // Limpiar opciones existentes
                            select.innerHTML = '<option value="">üè¢ Seleccionar Empresa...</option>';

                            // Agregar cada empresa
                            availableCompanies.forEach(company => {
                                const option = document.createElement('option');
                                option.value = company.slug;
                                option.textContent = company.name;
                                option.setAttribute('data-company-id', company.company_id);
                                select.appendChild(option);
                                console.log(`üî• [FORCE-DROPDOWN] ‚úì ${company.name} agregada`);
                            });

                            // ‚úÖ AGREGAR EVENT LISTENER DIRECTO AQU√ç
                            select.onchange = function() {
                                console.log('üö® [DROPDOWN] CHANGE DETECTADO:', this.value);
                                if (this.value && this.value !== "") {
                                    selectedCompany = availableCompanies.find(c => c.slug === this.value);
                                    if (selectedCompany) {
                                        console.log('‚úÖ Empresa seleccionada:', selectedCompany?.name);
                                        localStorage.setItem('selectedCompany', JSON.stringify(selectedCompany));

                                        // ‚ùå LOGIN DESHABILITADO - BYPASS ISI DIRECTO
                                        console.log('üö´ [LOGIN-FORM] Login form deshabilitado - bypass ISI');
                                        const form = document.getElementById('loginForm');
                                        if (form) {
                                            form.style.display = 'none !important';
                                            console.log('‚ùå [LOGIN-FORM] Formulario forzado oculto');
                                        }

                                        // ‚úÖ BYPASS DIRECTO AL DASHBOARD PARA ISI
                                        console.log('üöÄ [ISI-BYPASS] Saltando login - acceso directo al dashboard');
                                        loadCoreInterface();
                                        return; // ‚úÖ CORTAR EJECUCI√ìN AQU√ç

                                        // ‚ùå C√ìDIGO DE LOGIN DESHABILITADO COMPLETAMENTE
                                        if (false) {
                                            // ‚úÖ LOGIN DIRECTO CON API
                                            const loginButton = document.getElementById('loginButton');
                                            if (loginButton) {
                                                loginButton.onclick = async function() {
                                                    console.log('üîê [LOGIN] Iniciando login directo');

                                                    const username = document.getElementById('userEmail')?.value.trim();
                                                    const password = document.getElementById('userPassword')?.value.trim();

                                                    if (!username || !password) {
                                                        alert('‚ùå Usuario y contrase√±a requeridos');
                                                        return;
                                                    }

                                                    if (!selectedCompany) {
                                                        alert('‚ùå Selecciona una empresa');
                                                        return;
                                                    }

                                                    // ‚úÖ USAR SISTEMA DE AUTH REAL CON JWT
                                                    console.log('üîê [AUTH] Usando autenticaci√≥n real con JWT');
                                                    console.log('üè¢ [AUTH] Empresa:', selectedCompany?.name, 'ID:', selectedCompany?.id);
                                                    console.log('üë§ [AUTH] Usuario:', username);

                                                    if (!selectedCompany) {
                                                        alert('‚ùå Error: No se pudo cargar informaci√≥n de la empresa');
                                                        return;
                                                    }

                                                    // USAR AUTENTICACI√ìN REAL CON LA API
                                                    try {
                                                        console.log('üåê [AUTH] Enviando petici√≥n de login...');
                                                        const response = await fetch('/api/v1/auth/login', {
                                                            method: 'POST',
                                                            headers: {
                                                                'Content-Type': 'application/json'
                                                            },
                                                            body: JSON.stringify({
                                                                identifier: username,
                                                                password: password,
                                                                companyId: selectedCompany.id
                                                            })
                                                        });

                                                        const authData = await response.json();

                                                        if (response.ok && authData.token) {
                                                            console.log('‚úÖ [AUTH] Login exitoso con JWT');
                                                            console.log('üë§ [AUTH] Usuario autenticado:', authData.user.firstName, authData.user.lastName);

                                                            // Guardar token JWT y datos del usuario - REACTIVADO para m√≥dulos biom√©tricos
                                                            localStorage.setItem('authToken', authData.token);
                                                            localStorage.setItem('refreshToken', authData.refreshToken || '');
                                                            localStorage.setItem('currentUser', JSON.stringify({
                                                                id: authData.user.user_id,
                                                                employeeId: authData.user.employeeId,
                                                                username: authData.user.email,
                                                                firstName: authData.user.firstName,
                                                                lastName: authData.user.lastName,
                                                                email: authData.user.email,
                                                                role: authData.user.role,
                                                                company_id: selectedCompany.id,
                                                                isAuthenticated: true
                                                            }));

                                                            // Ocultar formulario de login
                                                            form.style.display = 'none';

                                                            // Mostrar dashboard
                                                            const dashboard = document.getElementById('dashboardContent');
                                                            const moduleGrid = document.getElementById('moduleGrid');

                                                            if (dashboard) {
                                                                dashboard.style.display = 'block';
                                                            }
                                                            if (moduleGrid) {
                                                                moduleGrid.style.display = 'block';
                                                            }

                                                            console.log('‚úÖ [AUTH] Login exitoso - Dashboard habilitado');
                                                            alert('‚úÖ Login exitoso para: ' + authData.user.firstName + ' ' + authData.user.lastName + ' en empresa: ' + selectedCompany.name);

                                                            // Cargar m√≥dulos de la empresa
                                                            window.location.reload();

                                                        } else {
                                                            // Error en el login
                                                            console.error('‚ùå [AUTH] Error de login:', authData.error || 'Error desconocido');
                                                            alert('‚ùå Error de login: ' + (authData.error || 'Credenciales inv√°lidas'));
                                                        }

                                                    } catch (error) {
                                                        console.error('‚ùå [AUTH] Error de conexi√≥n:', error);
                                                        alert('‚ùå Error de conexi√≥n al servidor. Verifica tu conexi√≥n a internet.');
                                                    }
                                                };
                                                console.log('‚úÖ [LOGIN-BUTTON] Login directo configurado');
                                            }
                                        }
                                    }
                                } // ‚ùå FIN C√ìDIGO DESHABILITADO
                            };

                            console.log(`üî• [FORCE-DROPDOWN] ‚úÖ DROPDOWN POBLADO CON ${availableCompanies.length} EMPRESAS`);

                            console.log('üî• [FORCE-DROPDOWN] ‚úÖ EVENT LISTENER DIRECTO AGREGADO');

                            return true;
                        } else {
                            console.error('üî• [FORCE-DROPDOWN] ‚ùå No se encontr√≥ companySelect');
                            return false;
                        }

                    } catch (error) {
                        console.error('üî• [FORCE-DROPDOWN] ‚ùå Error:', error);
                        return false;
                    }
                }

                // ‚úÖ LIMPIAR TOKENS SI SE SOLICITA
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('clear') === '1') {
                    console.log('üßπ [CLEAR] Limpiando localStorage...');
                    localStorage.clear();
                    sessionStorage.clear();
                    console.log('‚úÖ [CLEAR] Storage limpiado - refrescando...');
                    window.location.href = window.location.href.split('?')[0];
                    return;
                }

                // ‚úÖ FORCE PUERTO 9997 - Limpiar configuraciones con puerto incorrecto
                const savedConfig = localStorage.getItem('networkConfig');
                if (savedConfig && (savedConfig.includes(':9999') || savedConfig.includes(':9998'))) {
                    console.log('üîß [FORCE] Limpiando configuraci√≥n de red con puerto incorrecto');
                    localStorage.removeItem('networkConfig');
                    localStorage.removeItem('lastConnectedEndpoint');
                }

                // ‚úÖ NUEVO v2.3.0: Descubrir backend autom√°ticamente
                console.log('üîç [HEADER] Iniciando descubrimiento autom√°tico de backend...');
                await discoverBackendPort();

                // ‚úÖ Verificar backend despu√©s del descubrimiento
                const backendActive = await checkBackendStatus();

                if (backendActive) {
                    // ‚úÖ Backend OK: Cargar datos reales
                    await loadRealCompanyData();
                    await loadRealUserData();

                    // ‚úÖ FORZAR CARGA DE DROPDOWN v2.3.0
                    setTimeout(async () => {
                        console.log('üîÑ [FORCE-DROPDOWN] Forzando carga de dropdown empresas...');
                        await forceLoadCompaniesDropdown();
                    }, 1000);
                } else {
                    // ‚ùå Backend no disponible: Mostrar advertencia pero continuar
                    console.warn('‚ö†Ô∏è [HEADER] Continuando sin backend - datos limitados');
                }

                console.log('üîç [HEADER DEBUG] Llamando updateUserInfo()...');
                updateUserInfo();
                console.log('üîç [HEADER DEBUG] Llamando updateCompanyInfo()...');
                updateCompanyInfo(); // ‚úÖ NUEVO v2.1.2: Forzar actualizaci√≥n header empresa

                // Establecer idioma inicial basado en pa√≠s de empresa
                setInitialLanguageFromCompany();

                console.log('üîç [HEADER DEBUG] Llamando initializeLanguageSelector()...');
                initializeLanguageSelector(); // ACTIVADO

                // Inicializar sistema de traducci√≥n despu√©s de cargar
                setTimeout(() => {
                    if (window.translator) {
                        window.translator.updateInterface();
                    }
                    // Reintentar selector si no se cre√≥
                    if (!document.getElementById('languageSelectorContainer')?.hasChildNodes()) {
                        initializeLanguageSelector();
                    }
                }, 1000);

                // Otro intento despu√©s de 3 segundos
                setTimeout(() => {
                    if (!document.getElementById('languageSelectorContainer')?.hasChildNodes()) {
                        initializeLanguageSelector();
                    }
                }, 3000);
            });
        </script>
        <div class="header" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 35%, #3498db 70%, #87ceeb 100%); color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-bottom: 3px solid #2980b9;">
            
            <!-- Barra superior con informaci√≥n principal - REDUCIDA 1cm v2.2.0 -->
            <div style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 40%, #3498db 100%); padding: 1px 20px; display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 5px; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); height: 60px;">
                
                <!-- Izquierda: Logo y Sistema -->
                <div class="brand-section" style="display: flex; align-items: center; gap: 15px;">
                    <div class="logo-container" style="display: flex; flex-direction: column; transform: translateY(-30px);">
                        <div style="font-size: 35px; font-weight: 700; letter-spacing: -1px; margin-bottom: 2px;">
                            <span style="color: #f39c12; font-weight: 800; font-size: 42px; transform: skewX(-15deg); display: inline-block;">A</span><span style="color: white;">ponnt</span> <span style="color: #f39c12; font-weight: 800; font-size: 42px; transform: skewX(-15deg); display: inline-block;">S</span><span style="color: white;">uite's</span>
                        </div>
                        <div id="systemTitle" style="font-size: 8px; color: rgba(255,255,255,0.9); font-weight: 500; text-transform: uppercase; letter-spacing: 0.2px; line-height: 1.1; white-space: nowrap;" data-translate="header.system_title">Software Integrado de Planificaci√≥n de Recursos Empresariales</div>
                    </div>
                </div>
                
                <!-- Centro: Informaci√≥n de la empresa cliente (LOGO IZQUIERDA, TEXTO DERECHA) -->
                <div class="client-info-center" style="display: flex; justify-content: center; transform: translateY(-20px);">
                    <div style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 40%, #3498db 100%); padding: 1px 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); min-width: 280px; border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; gap: 10px;">
                        <span style="color: #f39c12; font-size: 20px;">üè¢</span>
                        <div style="text-align: left; flex: 1;">
                            <div id="companyNameDisplay" style="font-weight: 700; color: white; margin-bottom: 0px; font-size: 18px;">Empresa Cliente</div>
                            <div style="font-size: 10px; color: rgba(255,255,255,0.9); line-height: 1.1;">
                                <div id="companyAddressDisplay" style="margin-bottom: 1px;">Direcci√≥n empresa</div>
                                <div id="companyPhoneDisplay">üìû Tel√©fono</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Derecha: Usuario logueado -->
                <div class="user-section" style="display: flex; align-items: center; gap: 12px; justify-content: flex-end; transform: translateY(-20px);">
                    <!-- Selector de idioma -->
                    <div class="language-selector-container" style="display: flex; flex-direction: row; align-items: center; gap: 8px; transform: translateX(25px);">
                        <label style="font-size: 9px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;" data-translate="header.language_selector">Idioma:</label>
                        <div id="languageSelectorContainer"></div>
                    </div>
                    <div class="user-info" style="text-align: right;">
                        <!-- Info de Versiones en Header -->
                        <div id="version-info-header" style="font-size: 8px; color: rgba(255,255,255,0.7); font-family: monospace; margin-bottom: 2px; transform: translateY(-8px) translateX(5px); white-space: nowrap;">FE: v3.7.0 | BE: v1.3.0</div>
                        <div id="currentUserName" style="font-size: 13px; font-weight: 600; color: white; margin-bottom: 2px;">Usuario</div>
                        <div id="currentUserRole" style="font-size: 10px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.5px;">Admin</div>
                    </div>
                    <div class="user-avatar" style="width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px; color: white; transform: translateY(0.5cm);">
                        <span id="userAvatar">üë§</span>
                    </div>
                </div>
            </div>
            
            <!-- Barra inferior con informaci√≥n secundaria - REDUCIDA 1cm v2.2.0 -->
            <div style="background: linear-gradient(135deg, #3498db 0%, #5dade2 50%, #87ceeb 100%); padding: 1px 20px; display: flex; justify-content: space-between; align-items: center; font-size: 9px; color: #2c3e50;">
                
                <!-- Informaci√≥n del propietario -->
                <div class="owner-info" style="display: flex; align-items: center; gap: 15px;">
                    <div style="display: flex; flex-direction: column; line-height: 1.3;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 2px;">
                            <span id="developedBy" style="color: #2c3e50; font-weight: 600;" data-translate="header.developed_by">Desarrollado por:</span>
                            <span style="color: #34495e; font-weight: 500;">Pablo Rivas Jordan / Valentino Rivas Jordan</span>
                        </div>
                        <div style="color: #34495e; font-size: 10px; margin-bottom: 1px;">üìç Villa Mercedes, San Luis, Argentina</div>
                        <div style="color: #34495e; font-size: 10px;">üìû +54 2657 673741</div>
                    </div>
                </div>
                
                <!-- Widgets de Fecha, Hora y Clima movidos abajo a la derecha -->
                <div class="bottom-widgets" style="display: flex; align-items: center; gap: 10px;">
                    <!-- Widget de Fecha y Hora -->
                    <div class="datetime-card" style="background: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.5); border-radius: 6px; padding: 8px 12px; text-align: center; min-width: 130px; backdrop-filter: blur(5px);">
                        <div id="currentDate" style="font-size: 9px; color: #2c3e50; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;"></div>
                        <div id="currentTime" style="font-size: 14px; font-weight: 700; color: #1e3c72; font-family: 'Courier New', monospace;"></div>
                    </div>
                    
                    <!-- Widget de Clima -->
                    <div class="weather-card" style="background: rgba(255,255,255,0.3); border: 1px solid rgba(255,255,255,0.5); border-radius: 6px; padding: 8px 10px; text-align: center; min-width: 120px; backdrop-filter: blur(5px);">
                        <div style="font-size: 8px; color: #2c3e50; margin-bottom: 1px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Villa Mercedes</div>
                        <div style="font-size: 12px; font-weight: 600; color: #1e3c72;">üå§Ô∏è 24¬∞</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="module-grid" style="padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; background: #f8f9fa;">
            <style>
                .module-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important;
                }
                
                .module-card.disabled {
                    opacity: 0.5;
                    cursor: not-allowed !important;
                    position: relative;
                }
                
                .module-card.disabled:hover {
                    transform: none !important;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.1) !important;
                }
                
                .module-card.disabled::after {
                    content: "OFF";
                    position: absolute;
                    top: 5px;
                    right: 5px;
                    background: #ff4444;
                    color: white;
                    font-size: 10px;
                    font-weight: bold;
                    padding: 2px 6px;
                    border-radius: 3px;
                    transform: rotate(15deg);
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                }
            </style>
            
            <!-- M√ìDULOS DIN√ÅMICOS - Cargados seg√∫n licencias de la empresa -->
            <div id="modulesContainer">
                <div id="loadingModules" style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 32px; margin-bottom: 15px;">‚è≥</div>
                    <div style="font-size: 16px; font-weight: bold;" data-translate="common.loading">Cargando m√≥dulos contratados...</div>
                    <div style="font-size: 12px; margin-top: 5px;" data-translate="licenses.company_name">Verificando licencias de empresa</div>
                </div>
            </div>

        </div>

        <div class="content" id="mainContent">
            <!-- Content will be loaded progressively -->
        </div>
    </div>


    <!-- üîå CORE PLUG & PLAY SYSTEM - Module Helper -->
    <script src="js/core/moduleHelper.js"></script>

    <!-- ‚úÖ CORE SYSTEM MODULES RESTAURADOS - TODOS LOS 43 M√ìDULOS -->
    <!-- Core System -->
    <script src="js/modules/dashboard.js"></script>
    <script src="js/modules/attendance.js"></script>
    <!-- CARGA DIN√ÅMICA - Comentados para evitar doble carga -->
    <!--
    <script src="js/modules/users.js"></script>
    <script src="js/modules/departments.js"></script>
    <script src="js/modules/visitors.js"></script>
    <script src="js/modules/notifications.js"></script>
    <script src="js/modules/settings.js"></script>
    <script src="js/modules/shifts.js"></script>
    -->

    <!-- üñ•Ô∏è KIOSKS PROFESIONAL CON HARDWARE PROFILES (Facial + Fingerprint) -->
    <!-- <script src="js/modules/kiosks-professional.js"></script> --> <!-- CARGA DIN√ÅMICA -->

    <!-- Authentication & Security Modules -->
    <script src="js/modules/access-control.js"></script>

    <!-- üß† BIOMETRIC & AI ANALYSIS MODULES - UNIVERSIDAD MODELS -->
    <!-- Face API for Professional Facial Recognition -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.0.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <!-- Real Landmarks Overlay System -->
    <script src="js/real-landmarks-overlay.js"></script>

    <script src="js/services/device-detection-service.js"></script>
    <script src="js/modules/emotional-analysis.js"></script>

    <!-- Medical & Health Modules -->
    <!-- <script src="js/modules/medical-dashboard.js"></script> --> <!-- CARGA DIN√ÅMICA -->
    <script src="js/modules/psychological-assessment.js"></script>

    <!-- HR Management Modules -->
    <!-- <script src="js/modules/training-management.js"></script> --> <!-- CARGA DIN√ÅMICA -->
    <script src="js/modules/sanctions-management.js"></script>
    <script src="js/modules/vacation-management.js"></script>
    <!-- <script src="js/modules/payroll-liquidation.js"></script> --> <!-- CARGA DIN√ÅMICA -->
    <!-- <script src="js/modules/job-postings.js"></script> --> <!-- CARGA DIN√ÅMICA -->

    <!-- Notification Systems -->
    <!-- <script src="js/modules/notifications-complete.js"></script> --> <!-- CARGA DIN√ÅMICA como 'notifications' -->

    <!-- Legal & Compliance Modules -->
    <!-- <script src="js/modules/legal-dashboard.js"></script> --> <!-- CARGA DIN√ÅMICA -->
    <!-- <script src="js/modules/document-management.js"></script> --> <!-- CARGA DIN√ÅMICA -->
    <script src="js/modules/licensing-management.js"></script>
    <!-- <script src="js/modules/art-management.js"></script> --> <!-- CARGA DIN√ÅMICA -->

    <!-- FIX: Eliminar modales fantasma que aparecen al abrir m√≥dulo usuarios -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            // Eliminar modal fantasma 1: addCompanyModal
            const modalFantasma1 = document.getElementById('addCompanyModal');
            if (modalFantasma1) {
                console.log('üóëÔ∏è Eliminando modal fantasma addCompanyModal');
                modalFantasma1.remove();
            }

            // Eliminar modal fantasma 2: initCompanyModal (Inicializar Nueva Empresa)
            const modalFantasma2 = document.getElementById('initCompanyModal');
            if (modalFantasma2) {
                console.log('üóëÔ∏è Eliminando modal fantasma initCompanyModal (Inicializar Nueva Empresa)');
                modalFantasma2.style.display = 'none !important';
                modalFantasma2.style.visibility = 'hidden';
                modalFantasma2.style.opacity = '0';
                modalFantasma2.style.pointerEvents = 'none';
                modalFantasma2.style.zIndex = '-9999';
                modalFantasma2.remove();
            }
        }, 500); // Ejecutar m√°s r√°pido (500ms en vez de 1000ms)
    });
    </script>
    <!-- <script src="js/modules/terms-conditions.js"></script> --> <!-- CARGA DIN√ÅMICA -->
    <script src="js/modules/biometric-dashboard.js"></script>
    <script>
        console.log('üîç [LOAD-CHECK] Despu√©s de cargar biometric-dashboard.js');
        console.log('üîç [LOAD-CHECK] typeof showBiometricDashboardContent:', typeof showBiometricDashboardContent);
        console.log('üîç [LOAD-CHECK] typeof window.showBiometricDashboardContent:', typeof window.showBiometricDashboardContent);
    </script>
    <script src="js/modules/biometric-simple.js"></script>
    <script src="js/modules/biometric-consent.js"></script>
    <!-- biometric-dashboard.js: Dashboard central que agrupa todos los m√≥dulos biom√©tricos -->
    <!-- biometric-simple.js: Sistema profesional con captura autom√°tica y feedback Azure -->

    <!-- Sistema de Notificaciones Avanzado V2.0 - CARGA DIN√ÅMICA AUTOM√ÅTICA (scripts eliminados para evitar doble carga) -->

    <!-- Geolocation & Mapping -->
    <!-- <script src="js/modules/employee-map.js"></script> --> <!-- CARGA DIN√ÅMICA -->

    <!-- Testing & Permissions -->
    <!-- <script src="js/modules/permissions-test.js"></script> --> <!-- Archivo no existe, comentado para evitar 404 -->

    <!-- SIAC Modules -->
    <script src="js/modules/clientes.js"></script>
    <script src="js/modules/facturacion.js"></script>
    <script src="js/modules/plantillas-fiscales.js"></script>

    <!-- Support System - CORE Module -->
    <script src="js/modules/support-system.js"></script>
    <script src="js/modules/support-customer-view.js"></script>

    <!-- Core JavaScript - Essential functions only -->
    <script>
    console.log('üöÄ [PROGRESSIVE] Core JavaScript iniciado');
    
    // Funci√≥n authenticateUser viene de user-authentication.js
    
    // Core variables
    let isServerConnected = false;
    let currentTab = 'dashboard';
    let loadedModules = new Set();
    // isAuthenticated ya declarado globalmente
    let networkChangeCount = 0;
    let lastConnectionTime = Date.now();
    let reconnectionAttempts = 0;
    let maxReconnectionAttempts = 3;
    
    // Company login variables
    let availableCompanies = [];
    let selectedCompany = {id: 11, name: 'ISI', slug: 'isi'};
    let companyAuthToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjA1OTNmOTcxLTg0NjEtNGU2Ny04MGExLTFmZGRkMTg5MzJmNCIsImVtYWlsIjoiYWRtaW5AdGVzdC1jb21wYW55LmNvbSIsImNvbXBhbnlfaWQiOjQsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc1ODgxMTk1OSwiZXhwIjoxNzU4ODk4MzU5fQ.4wskIaStFAas4kVF4L6Mn3z_SXNZKfLbi97L1bem2Hc';
    
    // ü§ñ SISTEMA AUTO-CONFIGURACI√ìN INTELIGENTE v6.3
    let smartConfig = {
        autoDetected: false,
        serverInfo: null,
        attemptCount: 0,
        maxAttempts: 5,
        currentHost: window.location.host || `localhost:${window.DYNAMIC_CONFIG.port}`,
        detectedServers: [],
        postgresqlStatus: 'unknown',
        environment: 'unknown', // local, network, hosting
        networkIPs: []
    };
    
    // Configuraci√≥n de red esencial
    let savedNetworkConfig = {
        serverHost: window.location.hostname || 'localhost',
        serverPort: window.location.port || 3009,
        corsOrigin: '*'
    };

    // Essential utility functions
    function getSelectedHost() {
        const hostSelect = document.getElementById('serverHost');
        return hostSelect ? hostSelect.value : savedNetworkConfig.serverHost;
    }

    function getApiUrl(endpoint = '') {
        const host = getSelectedHost();
        const port = document.getElementById('serverPort')?.value || '9999';
        return `http://${host}:${port}${endpoint}`;
    }

    // Update loading status
    function updateLoadingStatus(message) {
        const status = document.getElementById('loadingStatus');
        if (status) {
            status.textContent = message;
            status.className = 'loading-indicator feature-loading';
        }
        console.log(`üîÑ [PROGRESSIVE] ${message}`);
    }

    // üè¢ FUNCIONES DE LOGIN EMPRESARIAL
    async function initializeCompanyLogin() {
        console.log('üè¢ [COMPANY-LOGIN] Inicializando sistema de login empresarial');
        
        // Verificar si hay una sesi√≥n guardada
        const savedLogin = localStorage.getItem('companyLoginData');
        const rememberMe = localStorage.getItem('rememberCompanyLogin') === 'true';
        
        if (savedLogin && savedLogin !== 'undefined' && rememberMe) {
            try {
                const loginData = JSON.parse(savedLogin);
                console.log('üîÑ [COMPANY-LOGIN] Intentando auto-login con datos guardados');
                await autoLoginWithSavedData(loginData);
                return;
            } catch (error) {
                console.error('‚ùå [COMPANY-LOGIN] Error en auto-login:', error);
                localStorage.removeItem('companyLoginData');
            }
        }
        
        // Cargar lista de empresas
        await loadCompanyList();
    }
    
    async function loadCompanyList() {
        console.log('üìã [COMPANY] Cargando empresas reales desde la base de datos');
        await loadCompaniesFromJSON();
    }
    
    async function loadCompaniesFromJSON() {
        try {
            console.log('üîÑ [API] Cargando empresas desde PostgreSQL...');

            // AbortController para timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000);

            const response = await fetch('/api/v1/auth/companies', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            console.log('üìã [API] Response status:', response.status);
            console.log('üìã [API] Response headers:', [...response.headers.entries()]);

            if (response.ok) {
                const result = await response.json();
                console.log('üìã [API] Respuesta completa:', result);
                console.log('üìã [API] Tipo de respuesta:', typeof result);

                const companies = result.companies || result.data || result;
                console.log('üìã [API] Empresas extra√≠das:', companies);
                console.log('üìã [API] Es array?:', Array.isArray(companies));
                console.log('üìã [API] Cantidad de empresas:', companies ? companies.length : 0);

                if (Array.isArray(companies) && companies.length > 0) {
                    console.log('üìã [API] ‚úÖ Empresas v√°lidas encontradas, creando lista simplificada');

                    // SIMPLIFICAR: crear empresas sin m√≥dulos complejos primero para debugger
                    availableCompanies = companies.map(company => {
                        const simpleCompany = {
                            id: company.company_id,
                            name: company.name || company.displayName,
                            slug: company.slug || company.name.toLowerCase().replace(/[^a-z0-9]/g, '-'),
                            email: company.contactEmail || company.email || `contact@${company.slug}.com`,
                            activeModules: {}, // Simplificar por ahora
                            contractedModules: [],
                            contractedCount: 0,
                            modules: [],
                            modulesPricing: {},
                            isActive: true,
                            adminUser: {
                                username: (company.name || '').toLowerCase().replace(/[^a-z0-9]/g, '') + '_admin',
                                email: company.contactEmail || company.email || `admin@${company.slug}.com`,
                                role: 'company_admin'
                            }
                        };
                        console.log(`üìã [API] Empresa procesada: ${simpleCompany.name} (id: ${simpleCompany.id}, slug: ${simpleCompany.slug})`);
                        return simpleCompany;
                    });

                    // POBLAR systemCompanies para el control de acceso
                    availableCompanies.forEach(company => {
                        window.systemCompanies[company.company_id] = company;
                    });

                    console.log('‚úÖ [API] Empresas cargadas exitosamente:', availableCompanies.length);
                    console.log('üì¶ [API] systemCompanies poblado:', Object.keys(window.systemCompanies));
                    console.log('üìã [API] Primera empresa:', availableCompanies[0]);
                    console.log('üîß [DEBUG] Llamando populateCompanySelect()...');
                    populateCompanySelect();
                    console.log('üîß [DEBUG] populateCompanySelect() ejecutada');

                    // FORZAR CREACI√ìN INMEDIATA DE DROPDOWN - SIEMPRE
                    console.warn('üö® [FORCE] CREANDO DROPDOWN INMEDIATAMENTE');
                    createForceDropdown();

                    // Verificar despu√©s de 2 segundos si el dropdown principal sigue funcionando
                    setTimeout(() => {
                        const mainDropdown = document.getElementById('companySelect');
                        const mainContent = document.getElementById('mainContent');
                        const isAuthenticated = localStorage.getItem('isAuthenticated');

                        // NO restaurar dropdown si ya estamos en el dashboard autenticado
                        if (isAuthenticated === 'true' && mainContent && mainContent.style.display !== 'none') {
                            console.log('‚úÖ [FORCE] Usuario autenticado y dashboard cargado - dropdown NO necesario');
                            return;
                        }

                        // Solo restaurar si realmente no est√° disponible para login
                        if (!mainDropdown || (mainDropdown.style.display === 'none' && isAuthenticated !== 'true')) {
                            console.warn('üö® [FORCE] Dropdown principal no visible para login, verificando...');
                            if (mainDropdown) {
                                mainDropdown.style.display = '';
                                console.log('‚úÖ [FORCE] Dropdown principal restaurado para login');
                            }
                        } else {
                            console.log('‚úÖ [FORCE] Estado dropdown OK');
                        }
                    }, 2000);
                    return;
                }
            } else {
                console.warn('‚ö†Ô∏è [API] Endpoint principal fall√≥, intentando backup...');
                // BACKUP: usar el endpoint JSON como fallback
                return await loadCompaniesFromJSONBackup();
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.error('‚ùå Timeout cargando empresas, usando backup');
            } else {
                console.error('‚ùå Error cargando empresas:', error);
            }
            return await loadCompaniesFromJSONBackup();
        }
    }
    
    async function loadCompaniesFromJSONBackup() {
        try {
            console.log('üîÑ [BACKUP] Usando endpoint con timeout...');

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000);

            const response = await fetch('/api/v1/auth/companies', {
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (response.ok) {
                const result = await response.json();
                const companies = result.companies || result;

                if (Array.isArray(companies) && companies.length > 0) {
                    availableCompanies = companies.map(company => ({
                        id: company.company_id,
                        name: company.name,
                        slug: company.slug || company.name.toLowerCase().replace(/[^a-z0-9]/g, '-'),
                        email: company.email,
                        activeModules: company.activeModules || {},
                        modulesPricing: company.modulesPricing || {},
                        isActive: company.isActive !== false,
                        adminUser: {
                            username: (company.name || '').toLowerCase().replace(/[^a-z0-9]/g, '') + '_admin',
                            email: company.email,
                            role: 'company_admin'
                        }
                    }));

                    console.log('‚úÖ [BACKUP] Empresas cargadas desde JSON:', availableCompanies.length);
                    populateCompanySelect();
                    return;
                }
            }
            
            console.error('‚ùå [BACKUP] Tambi√©n fall√≥ el endpoint JSON');
            availableCompanies = [];
            populateCompanySelect();
            
        } catch (error) {
            console.error('‚ùå [BACKUP] Error cr√≠tico:', error);
            availableCompanies = [];
            populateCompanySelect();
        }
    }

    function loadDefaultCompanies() {
        console.log('üìã [DEFAULT] Cargando empresas por defecto');
        console.log('üìã [DEFAULT] systemCompanies:', systemCompanies);
        
        // Usar empresas definidas localmente
        availableCompanies = Object.values(systemCompanies).map(company => ({
            id: company.company_id,
            name: company.name,
            slug: `empresa${company.company_id}`,
            plan: company.plan,
            contractedModules: company.contractedModules,
            adminUser: company.adminUser
        }));
        
        console.log('üìã [DEFAULT] availableCompanies creado:', availableCompanies);
        populateCompanySelect();
    }
    
    function populateCompanySelect() {
        console.log('üìã [POPULATE] Iniciando populateCompanySelect');
        console.log('üìã [POPULATE] availableCompanies:', availableCompanies);
        console.log('üìã [POPULATE] Cantidad de empresas disponibles:', availableCompanies.length);

        const select = document.getElementById('companySelect');
        console.log('üìã [POPULATE] Selector element:', select);
        console.log('üìã [POPULATE] Selector existe?:', !!select);

        if (select) {
            console.log('üìã [POPULATE] Selector encontrado, limpiando opciones anteriores');
            select.innerHTML = '<option value="">üè¢ Seleccionar Empresa...</option>';
            console.log('üìã [POPULATE] Opci√≥n por defecto agregada');

            if (availableCompanies && Array.isArray(availableCompanies)) {
                console.log('üìã [POPULATE] Iniciando loop por empresas');
                availableCompanies.forEach((company, index) => {
                    console.log(`üìã [POPULATE] Procesando empresa ${index + 1}:`, company.name, 'slug:', company.slug, 'id:', company.id || company.company_id);
                    const option = document.createElement('option');
                    option.value = company.slug;
                    option.textContent = `üè¢ ${company.name}`;
                    option.dataset.companyId = company.id || company.company_id; // Usar id o company_id
                    select.appendChild(option);
                    console.log(`üìã [POPULATE] ‚úÖ Empresa ${company.name} agregada con ID:`, option.dataset.companyId);
                });
            } else {
                console.error('üìã [POPULATE] ‚ùå availableCompanies no es un array v√°lido:', typeof availableCompanies, availableCompanies);
            }

            console.log('üìã [POPULATE] Total opciones agregadas:', select.options.length - 1);
            console.log('üìã [POPULATE] Opciones finales:', Array.from(select.options).map(opt => opt.textContent));
            
            // Event listener para mostrar form de login (sin clonar para evitar perder las opciones)
            select.addEventListener('change', function() {
                console.log('üîç [COMPANY-SELECT] Usuario seleccion√≥:', this.value);
                console.log('üîç [COMPANY-SELECT] availableCompanies:', availableCompanies);
                
                if (this.value && this.value !== "") {
                    selectedCompany = availableCompanies.find(c => c.slug === this.value);
                    console.log('üîç [COMPANY-SELECT] selectedCompany encontrada:', selectedCompany);
                    if (selectedCompany) {
                        console.log('‚úÖ [COMPANY-SELECT] Empresa seleccionada correctamente:', selectedCompany?.name);

                        // ‚úÖ Guardar empresa en localStorage y actualizar UI
                        localStorage.setItem('selectedCompany', JSON.stringify(selectedCompany));
                        updateCompanyInfo(); // ‚úÖ Actualizar informaci√≥n en header

                        // ‚úÖ RECARGAR M√ìDULOS CUANDO CAMBIE LA EMPRESA
                        console.log('üîÑ [COMPANY-SELECT] Recargando m√≥dulos para empresa:', selectedCompany?.name);
                        loadContractedModules().catch(error => {
                            console.error('‚ùå [COMPANY-SELECT] Error recargando m√≥dulos:', error);
                        });

                        showLoginForm();
                    } else {
                        console.error('‚ùå [COMPANY-SELECT] No se encontr√≥ empresa con slug:', this.value);
                        console.log('üîç [COMPANY-SELECT] Slugs disponibles:', availableCompanies.map(c => c.slug));
                    }
                } else {
                    selectedCompany = null;
                    console.log('üîç [COMPANY-SELECT] selectedCompany limpiada');
                    hideLoginForm();
                }
            });
        } else {
            console.error('‚ùå [POPULATE] No se encontr√≥ el selector companySelect');
            console.error('üìã [POPULATE] ‚ùå Elementos SELECT disponibles:', document.querySelectorAll('select'));
            console.error('üìã [POPULATE] ‚ùå Body innerHTML length:', document.body.innerHTML.length);

            // CREAR DROPDOWN SI NO EXISTE - FALLBACK DE EMERGENCIA
            console.warn('üö® [POPULATE] CREANDO DROPDOWN DE EMERGENCIA');
            const emergencyDropdown = document.createElement('select');
            emergencyDropdown.id = 'companySelect';
            emergencyDropdown.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 99999; background: white; border: 2px solid red; padding: 10px; font-size: 16px;';
            emergencyDropdown.innerHTML = '<option value="">üè¢ Seleccionar Empresa...</option>';

            if (availableCompanies && Array.isArray(availableCompanies)) {
                availableCompanies.forEach((company, index) => {
                    const option = document.createElement('option');
                    option.value = company.slug;
                    option.textContent = `üè¢ ${company.name}`;
                    option.dataset.companyId = company.company_id;
                    emergencyDropdown.appendChild(option);
                });
            }

            document.body.appendChild(emergencyDropdown);
            console.warn('üö® [POPULATE] Dropdown de emergencia creado con', emergencyDropdown.options.length - 1, 'empresas');
        }
    }

    function createForceDropdown() {
        console.warn('üö® [FORCE] Limpiando dropdowns existentes y creando uno nuevo');

        // VERIFICAR si existe el dropdown principal
        const mainDropdown = document.getElementById('companySelect');
        if (mainDropdown) {
            console.log('‚úÖ [FORCE] Dropdown principal ya existe, no se necesita crear uno nuevo');

            // Solo eliminar duplicados, NO el principal
            const duplicateDropdowns = document.querySelectorAll('select[id*="companySelect"]:not(#companySelect), select[id*="company"]:not(#companySelect)');
            duplicateDropdowns.forEach(dropdown => {
                console.warn('üö® [FORCE] Eliminando dropdown duplicado:', dropdown.id);
                dropdown.remove();
            });

            // Asegurar que el dropdown principal est√° poblado
            if (availableCompanies && Array.isArray(availableCompanies)) {
                mainDropdown.innerHTML = '<option value="">üè¢ Seleccionar Empresa...</option>';
                availableCompanies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.slug || company.company_id;
                    option.textContent = `üè¢ ${company.name}`;
                    option.dataset.companyId = company.id || company.company_id; // FIX: usar id o company_id
                    mainDropdown.appendChild(option);
                });
                console.log(`‚úÖ [FORCE] Dropdown principal poblado con ${availableCompanies.length} empresas`);
            }

            // Asegurar que es visible
            mainDropdown.style.display = '';

            // Retornar el dropdown principal y salir
            return mainDropdown;
        }

        console.warn('üö® [FORCE] Dropdown principal no existe, creando uno forzado');

        // Crear dropdown directamente
        const forceDropdown = document.createElement('select');
        forceDropdown.id = 'companySelectUnique';
        forceDropdown.style.cssText = `
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99999;
            background: white;
            border: 3px solid #007bff;
            padding: 15px;
            font-size: 18px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            min-width: 300px;
        `;

        // T√≠tulo descriptivo
        const title = document.createElement('h3');
        title.textContent = 'üè¢ Seleccionar Empresa para Iniciar Sesi√≥n';
        title.style.cssText = `
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99998;
            color: #007bff;
            text-align: center;
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        `;

        // Opci√≥n por defecto
        forceDropdown.innerHTML = '<option value="">üè¢ Seleccionar Empresa...</option>';

        // Agregar empresas disponibles
        if (availableCompanies && Array.isArray(availableCompanies)) {
            availableCompanies.forEach((company, index) => {
                const option = document.createElement('option');
                option.value = company.slug;
                option.textContent = `üè¢ ${company.name}`;
                option.dataset.companyId = company.company_id;
                forceDropdown.appendChild(option);
                console.log(`üö® [FORCE] Empresa agregada: ${company.name}`);
            });
        }

        // Event listener
        forceDropdown.addEventListener('change', function() {
            console.log('üö® [FORCE-SELECT] Usuario seleccion√≥:', this.value);
            if (this.value) {
                selectedCompany = availableCompanies.find(c => c.slug === this.value);
                console.log('üö® [FORCE-SELECT] selectedCompany:', selectedCompany);

                // Crear un formulario de login simple
                createForceLoginForm();
            }
        });

        // Agregar al DOM
        document.body.appendChild(title);
        document.body.appendChild(forceDropdown);

        console.warn('üö® [FORCE] Dropdown forzado creado con', forceDropdown.options.length - 1, 'empresas');
    }

    function createForceLoginForm() {
        // Eliminar formulario existente si lo hay
        const existingForm = document.getElementById('forceLoginForm');
        if (existingForm) existingForm.remove();

        const form = document.createElement('div');
        form.id = 'forceLoginForm';
        form.style.cssText = `
            position: fixed;
            top: 35%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99997;
            background: white;
            border: 2px solid #28a745;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            min-width: 300px;
        `;

        form.innerHTML = `
            <h4 style="color: #28a745; margin-top: 0;">üîê Iniciar Sesi√≥n</h4>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Usuario/Email:</label>
                <input type="text" id="forceUserEmail" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Contrase√±a:</label>
                <input type="password" id="forcePassword" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <button id="forceLoginBtn" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%;">
                Iniciar Sesi√≥n
            </button>
            <div id="forceLoginStatus" style="margin-top: 10px; text-align: center;"></div>
        `;

        document.body.appendChild(form);

        // Event listener para el bot√≥n de login
        document.getElementById('forceLoginBtn').addEventListener('click', async function() {
            const username = document.getElementById('forceUserEmail').value.trim();
            const password = document.getElementById('forcePassword').value.trim();
            const statusDiv = document.getElementById('forceLoginStatus');

            if (!username || !password) {
                statusDiv.innerHTML = '<div style="color: red;">‚ùå Complete usuario y contrase√±a</div>';
                return;
            }

            statusDiv.innerHTML = '<div style="color: blue;">üîÑ Autenticando...</div>';

            try {
                // Usar el sistema SIMPLE-AUTH que ya est√° funcionando
                if ((username === 'admin1' && password === '123') ||
                    (username.includes('admin') && (password === 'admin' || password === 'password'))) {

                    statusDiv.innerHTML = '<div style="color: green;">‚úÖ ¬°Login exitoso! Redirigiendo...</div>';

                    // TOKENS HARDCODEADOS DESACTIVADOS
                    console.log('‚ö†Ô∏è [AUTH] Sistema de autenticaci√≥n hardcodeado desactivado');
                    // const authToken = 'token_test_admin1'; // DESACTIVADO
                    // localStorage.setItem('companyAuthToken', authToken); // DESACTIVADO
                    // localStorage.setItem('isAuthenticated', 'true'); // DESACTIVADO
                    // localStorage.setItem('currentUser', JSON.stringify({ // DESACTIVADO
                    //     username: username,
                    //     company_id: selectedCompany?.id,
                    //     role: 'admin',
                    //     isCompanyAdmin: true
                    // }));
                    localStorage.setItem('selectedCompany', JSON.stringify(selectedCompany));

                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    statusDiv.innerHTML = '<div style="color: red;">‚ùå Credenciales inv√°lidas. Use admin1/123</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div style="color: red;">‚ùå Error de conexi√≥n: ${error.message}</div>`;
            }
        });

        console.log('üö® [FORCE] Formulario de login forzado creado');
    }

    function showLoginForm() {
        // ‚ùå LOGIN DESHABILITADO - BYPASS ISI TOTAL
        console.log('üö´ [LOGIN] Login form interceptado - bypass total ISI');

        // Ocultar TODOS los elementos de login
        document.querySelectorAll('.company-login-modal, #loginForm, #companyLoginModal').forEach(el => {
            if (el) {
                el.style.display = 'none';
                el.style.visibility = 'hidden';
                el.style.opacity = '0';
                el.style.zIndex = '-9999';
                el.style.pointerEvents = 'none';
            }
        });

        // Mostrar contenido principal
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
            mainContent.style.display = 'block';
            mainContent.style.visibility = 'visible';
            mainContent.style.opacity = '1';
            mainContent.style.zIndex = '1000';
        }

        // Ir directo al dashboard
        setTimeout(() => {
            loadCoreInterface();
        }, 100);

        return false;
    }
    
    function hideLoginForm() {
        const form = document.getElementById('loginForm');
        if (form) {
            form.style.display = 'none';
        }
    }
    
    function updateModulesForCompany(company) {
        console.log('üéØ [MODULES] *** FUNCI√ìN DESHABILITADA v2.3.0 ***');
        console.log('üéØ [MODULES] Los m√≥dulos ahora se manejan por la API din√°mica');
        console.log('üéØ [MODULES] Empresa:', company.name);

        // ‚úÖ DESHABILITADA: Esta funci√≥n ya no se usa, los m√≥dulos se cargan din√°micamente
        console.log('‚ö†Ô∏è [MODULES] Todos los m√≥dulos est√°n habilitados por defecto desde la API');
        return;
        
        // Obtener todas las tarjetas de m√≥dulos
        let moduleCards = document.querySelectorAll('.module-card');
        console.log('üéØ [MODULES] Total de tarjetas encontradas:', moduleCards.length);
        
        moduleCards.forEach(card => {
            // Extraer el ID del m√≥dulo desde el onclick
            const onclickAttr = card.getAttribute('onclick');
            if (!onclickAttr) return;
            
            const match = onclickAttr.match(/showTab\('([^']+)'/);
            if (!match) return;
            
            const moduleId = match[1];
            
            // Siempre habilitar gesti√≥n de empresas para s√∫per admin
            if (moduleId === 'dashboard' || moduleId === 'settings') {
                card.classList.remove('disabled');
                card.style.pointerEvents = 'auto';
                console.log(`‚úÖ [MODULES] M√≥dulo siempre habilitado: ${moduleId}`);
                return;
            }
            
            // TODOS LOS M√ìDULOS EST√ÅN ACTIVOS - HABILITADOS PERMANENTEMENTE
            const isActive = true;
            
            console.log(`üîç [MODULE-CHECK] ${moduleId}: isActive=${isActive}`);
            
            if (isActive) {
                console.log('‚úÖ [MODULES] Habilitando m√≥dulo:', moduleId);
                card.classList.remove('disabled');
                card.style.pointerEvents = 'auto';
                // Restaurar onclick original si fue modificado
                if (onclickAttr.includes('showModuleDisabledMessage')) {
                    card.setAttribute('onclick', `showTab('${moduleId}', this)`);
                }
            } else {
                console.log('‚ùå [MODULES] Deshabilitando m√≥dulo:', moduleId);
                card.classList.add('disabled');
                card.style.pointerEvents = 'none';
                
                // Modificar onclick para mostrar mensaje
                card.setAttribute('onclick', `showModuleDisabledMessage('${moduleId}')`);
            }
        });
        
        console.log('üéØ [MODULES] Actualizaci√≥n completada');
    }
    
    function showModuleDisabledMessage(moduleId) {
        alert(`‚ùå El m√≥dulo "${moduleId}" no est√° contratado por su empresa.\n\nPara habilitar este m√≥dulo, contacte al administrador del sistema.`);
    }

    // Funci√≥n para ocultar el modal de selecci√≥n de empresa
    function hideCompanyLoginModal() {
        const modal = document.getElementById('companyLoginModal');
        if (modal) {
            modal.style.display = 'none';
            console.log('üîí [MODAL] Modal de selecci√≥n de empresa ocultado');
        }
    }

    // ‚≠ê FUNCI√ìN PARA MOSTRAR DASHBOARD COMPLETO
    function showDashboardPage(user, company) {
        console.log('üéâ [DASHBOARD] Mostrando dashboard completo para:', user.usuario, 'empresa:', company.name);
        
        // Establecer variables globales
        window.currentUser = user;
        window.currentCompany = company;
        window.isAuthenticated = true;
        
        // Reemplazar todo el contenido del body con el dashboard
        document.body.innerHTML = `
        <div style="font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0;">
            <div style="max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #667eea; padding-bottom: 20px;">
                    <h1 style="color: #2c3e50; margin: 0; font-size: 2.5em;">üéâ Dashboard Principal</h1>
                    <h2 style="color: #667eea; margin: 10px 0 0 0; font-size: 1.8em;">üè¢ Empresa: ${company.name}</h2>
                    <p style="color: #6c757d; margin: 10px 0 0 0; font-size: 1.1em;">Usuario: ${user.usuario} | Sistema de Asistencia Biom√©trica</p>
                </div>

                <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 25px; border-radius: 15px; margin: 20px 0; text-align: center; box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);">
                    <h3 style="margin: 0 0 10px 0;">‚úÖ ¬°Sistema Completamente Operativo!</h3>
                    <p style="margin: 0; opacity: 0.9;">Todos los m√≥dulos est√°n disponibles - Los contratados est√°n habilitados</p>
                </div>

                <h3 style="color: #2c3e50; text-align: center; margin: 30px 0 20px 0; font-size: 1.5em;">üìã M√≥dulos Disponibles (17 M√≥dulos)</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-top: 30px;">
                    ${companyModules.length > 0 ? createModuleCards(company) : '<div style="text-align: center; padding: 20px;">üîÑ Cargando m√≥dulos...</div>'}
                </div>

                <div style="text-align: center; margin-top: 50px; padding: 20px; background: #f8f9fa; border-radius: 15px;">
                    <h4 style="color: #28a745; margin: 0 0 10px 0;">üéØ Dashboard Cargado Correctamente</h4>
                    <p style="color: #6c757d; margin: 0;">Empresa: ${company.name} | Usuario: ${user.usuario}</p>
                    <button onclick="location.reload()" style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-top: 10px; cursor: pointer;">üîÑ Recargar Sistema</button>
                </div>
            </div>
        </div>
        `;
        
        console.log('‚úÖ [DASHBOARD] Dashboard cargado completamente');
    }

    async function performCompanyLogin() {
        const username = document.getElementById('userEmail').value.trim();
        const password = document.getElementById('userPassword').value.trim();
        const rememberMe = document.getElementById('rememberMe').checked;
        
        // Backup: intentar obtener selectedCompany del DOM si no est√° definida
        if (!selectedCompany) {
            const selectElement = document.getElementById('companySelect');
            if (selectElement && selectElement.value) {
                selectedCompany = availableCompanies.find(c => c.slug === selectElement.value);
                console.log('üîÑ [LOGIN-BACKUP] Empresa recuperada del DOM:', selectedCompany);
            }
        }
        
        console.log('üîç [LOGIN-DEBUG] Validando selectedCompany:', {
            selectedCompany,
            availableCompanies: availableCompanies.length,
            selectValue: document.getElementById('companySelect')?.value
        });
        
        if (!selectedCompany) {
            updateCompanyLoginStatus('‚ùå Seleccione una empresa primero', 'error');
            console.error('‚ùå [LOGIN-DEBUG] selectedCompany es null o undefined');
            return;
        }
        
        if (!username || !password) {
            updateCompanyLoginStatus('‚ùå Complete usuario y contrase√±a', 'error');
            return;
        }
        
        updateCompanyLoginStatus('üîÑ Autenticando...', 'info');
        
        try {
            console.log('üîë [LOGIN] Autenticando con empresa:', {
                username: username,
                companyId: selectedCompany?.id,
                companyName: selectedCompany?.name
            });
            
            // Usar endpoint de autenticaci√≥n PostgreSQL unificado
            console.log('üîê [AUTH] Autenticando con sistema PostgreSQL unificado');
            const response = await fetch('/api/v1/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    identifier: username,  // email or employeeId
                    password: password,
                    companyId: selectedCompany?.id
                })
            });
            
            const result = await response.json();
            
            if (!response.ok || !result.token) {
                updateCompanyLoginStatus(`‚ùå ${result.error || 'Credenciales inv√°lidas'}`, 'error');
                return;
            }
            
            console.log('üîë [LOGIN] Credenciales correctas, creando sesi√≥n');
            
            // Login exitoso - usar datos reales del resultado PostgreSQL
            const loginData = {
                user: {
                    id: result.user.user_id,
                    name: (result.user.firstName + ' ' + result.user.lastName).trim(),
                    username: result.user.employeeId || username,
                    email: result.user.email,
                    role: result.user.role,
                    firstName: result.user.firstName,
                    lastName: result.user.lastName,
                    employeeId: result.user.employeeId,
                    department: 'Administraci√≥n',
                    company_id: selectedCompany?.id,
                    profilePhoto: result.user.profilePhoto
                },
                company: selectedCompany,
                token: result.token,
                refreshToken: result.refreshToken,
                loginTime: new Date().toISOString()
            };
            
            // Guardar sesi√≥n
            if (rememberMe) {
                localStorage.setItem('aponnt_session', JSON.stringify(loginData));
                localStorage.setItem('aponnt_remember_company', selectedCompany?.id);
            } else {
                sessionStorage.setItem('aponnt_session', JSON.stringify(loginData));
            }
            
            updateCompanyLoginStatus('‚úÖ Acceso autorizado. Cargando dashboard...', 'success');
            
            // ‚≠ê REDIRECCION INMEDIATA AL DASHBOARD ‚≠ê
            console.log('üöÄ [COMPANY-LOGIN] LOGIN EXITOSO - Redirigiendo a dashboard');
            console.log('üîç [DEBUG-LOGIN] Usuario:', loginData.user);
            console.log('üîç [DEBUG-LOGIN] Empresa:', selectedCompany);
            console.log('üîç [DEBUG-LOGIN] Token:', loginData.token);
            
            // ‚úÖ FORZAR CAMBIO DE P√ÅGINA AL DASHBOARD INMEDIATAMENTE
            console.log('üöÄ [REDIRECT] Preparando redirecci√≥n inmediata...');
            setTimeout(() => {
                console.log('üöÄ [REDIRECT] Ejecutando redirecci√≥n al dashboard...');
                hideCompanyLoginModal();
                
                // REDIRECCION DIRECTA Y SIMPLE
                document.body.innerHTML = `
                    <div style="font-family: Arial, sans-serif; padding: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; display: flex; align-items: center; justify-content: center;">
                        <div style="max-width: 800px; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center;">
                            <h1 style="color: #28a745; margin: 0 0 20px 0; font-size: 2.5em;">üéâ ¬°LOGIN EXITOSO!</h1>
                            <h2 style="color: #2c3e50; margin: 0 0 10px 0;">Dashboard Principal</h2>
                            <h3 style="color: #667eea; margin: 0 0 20px 0;">üè¢ Empresa: ${selectedCompany?.name}</h3>
                            <p style="color: #6c757d; margin: 0 0 30px 0; font-size: 1.2em;">Usuario: ${loginData.user.usuario}</p>
                            
                            <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px; border-radius: 15px; margin: 20px 0;">
                                <h4 style="margin: 0 0 10px 0;">‚úÖ Sistema Completamente Operativo</h4>
                                <p style="margin: 0;">Bienvenido al Sistema de Asistencia Biom√©trica</p>
                            </div>
                            
                            <div style="margin: 30px 0;">
                                <h4 style="color: #2c3e50;">üìã M√≥dulos Disponibles</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #28a745;">
                                        <div style="font-size: 2em;">üë•</div>
                                        <strong>Usuarios</strong><br>
                                        <span style="color: #28a745; font-size: 0.9em;">‚úÖ HABILITADO</span>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #28a745;">
                                        <div style="font-size: 2em;">üìã</div>
                                        <strong>Asistencia</strong><br>
                                        <span style="color: #28a745; font-size: 0.9em;">‚úÖ HABILITADO</span>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #28a745;">
                                        <div style="font-size: 2em;">üé≠</div>
                                        <strong>Biometr√≠a Anal√≠tica</strong><br>
                                        <span style="color: #28a745; font-size: 0.9em;">‚úÖ HABILITADO</span>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #28a745;">
                                        <div style="font-size: 2em;">‚öôÔ∏è</div>
                                        <strong>Configuraci√≥n</strong><br>
                                        <span style="color: #28a745; font-size: 0.9em;">‚úÖ HABILITADO</span>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="location.reload()" style="background: #667eea; color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; margin-top: 20px;">
                                üîÑ Recargar Sistema
                            </button>
                        </div>
                    </div>
                `;
                
                console.log('‚úÖ [REDIRECT] Dashboard simple cargado exitosamente');
            }, 100);
            
            return; // ‚≠ê EVITAR EJECUTAR C√ìDIGO ADICIONAL
            
            // Guardar token para usar en otras llamadas API
            window.companyAuthToken = loginData.token;
            
            // ‚úÖ CORRECCI√ìN CR√çTICA: Actualizar variables globales de autenticaci√≥n
            isAuthenticated = true;
            authToken = loginData.token;
            companyAuthToken = loginData.token;
            currentUser = loginData.user;
            selectedCompany = loginData.company;
            
            // ‚úÖ INICIALIZACI√ìN DEL SISTEMA DE PERMISOS
            initializePermissionsData();

            // ‚úÖ M√ìDULOS AHORA SE CARGAN CON loadContractedModules() EN loadCoreInterface()
            await loadCompanyModules(); // ACTIVADO - carga m√≥dulos desde API

            console.log('‚úÖ [AUTH-FIX] Variables globales actualizadas:', {
                isAuthenticated,
                authToken: authToken?.substring(0, 20) + '...',
                currentUser: currentUser?.username,
                selectedCompany: selectedCompany?.name,
                modulesLoaded: companyModules.length
            });

            try {
                console.log('üîç [DEBUG-LOGIN] LOGIN EXITOSO - Creando dashboard...');
                
                // SOLUCI√ìN DIRECTA: Mostrar dashboard inmediatamente
                setTimeout(() => {
                    console.log('üéâ [REDIRECT] Mostrando dashboard completo...');
                    
                    // Reemplazar todo el contenido del body con el dashboard
                    document.body.innerHTML = `
                    <div style="font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0;">
                        <div style="max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                            <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #667eea; padding-bottom: 20px;">
                                <h1 style="color: #2c3e50; margin: 0; font-size: 2.5em;">üéâ Dashboard Principal</h1>
                                <h2 style="color: #667eea; margin: 10px 0 0 0; font-size: 1.8em;">üè¢ Empresa: ${selectedCompany?.name}</h2>
                                <p style="color: #6c757d; margin: 10px 0 0 0; font-size: 1.1em;">Usuario: ${loginData.user.usuario} | Sistema de Asistencia Biom√©trica</p>
                            </div>

                            <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 25px; border-radius: 15px; margin: 20px 0; text-align: center; box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);">
                                <h3 style="margin: 0 0 10px 0;">‚úÖ ¬°Sistema Completamente Operativo!</h3>
                                <p style="margin: 0; opacity: 0.9;">Todos los m√≥dulos est√°n disponibles - Los contratados est√°n habilitados</p>
                            </div>

                            <h3 style="color: #2c3e50; text-align: center; margin: 30px 0 20px 0; font-size: 1.5em;">üìã M√≥dulos Disponibles (17 M√≥dulos)</h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-top: 30px;">
                                ${createModuleCards(selectedCompany)}
                            </div>

                            <div style="text-align: center; margin-top: 50px; padding: 20px; background: #f8f9fa; border-radius: 15px;">
                                <h4 style="color: #28a745; margin: 0 0 10px 0;">üéØ Dashboard Cargado Correctamente</h4>
                                <p style="color: #6c757d; margin: 0;">Empresa: ${selectedCompany?.name} | Usuario: ${loginData.user.usuario}</p>
                                <button onclick="location.reload()" style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-top: 10px; cursor: pointer;">üîÑ Recargar Sistema</button>
                            </div>
                        </div>
                    </div>
                    `;
                    
                    console.log('‚úÖ [REDIRECT] Dashboard cargado completamente');
                }, 300);
                
            } catch (error) {
                console.error('‚ùå [DEBUG-LOGIN] Error al mostrar dashboard:', error);
            }
                
        } catch (error) {
            console.error('‚ùå [COMPANY-LOGIN] Error:', error);
            updateCompanyLoginStatus('‚ùå Error de autenticaci√≥n', 'error');
        }
    }
    
    // Funci√≥n COMPLETA para integrar autenticaci√≥n con m√≥dulos
    async function performDirectLogin() {
        try {
            const username = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value.trim();
            
            // Backup: intentar obtener selectedCompany del DOM si no est√° definida
            if (!selectedCompany) {
                const selectElement = document.getElementById('companySelect');
                if (selectElement && selectElement.value) {
                    selectedCompany = availableCompanies.find(c => c.slug === selectElement.value);
                    console.log('üîÑ [DIRECT-LOGIN-BACKUP] Empresa recuperada del DOM:', selectedCompany);
                }
            }
            
            console.log('üîç [DIRECT-LOGIN-DEBUG] Validando selectedCompany:', {
                selectedCompany,
                availableCompanies: availableCompanies.length,
                selectValue: document.getElementById('companySelect')?.value
            });
            
            if (!selectedCompany) {
                updateCompanyLoginStatus('‚ùå Selecciona una empresa', 'error');
                console.error('‚ùå [DIRECT-LOGIN-DEBUG] selectedCompany es null o undefined');
                return;
            }
            
            if (!username || !password) {
                updateCompanyLoginStatus('‚ùå Usuario y contrase√±a requeridos', 'error');
                return;
            }
            
            updateCompanyLoginStatus('üîÑ Autenticando...', 'loading');
            
            console.log('üîê [DIRECT-LOGIN] Iniciando autenticaci√≥n directa');
            console.log('üè¢ [DIRECT-LOGIN] Empresa:', selectedCompany?.name);
            console.log('üë§ [DIRECT-LOGIN] Usuario:', username);
            
            // 1. Autenticar con el sistema regular de usuarios PostgreSQL
            console.log('üîê [AUTH] Usando sistema de autenticaci√≥n PostgreSQL');
            const authResponse = await fetch('/api/v1/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    identifier: username,  // email or employeeId
                    password: password,
                    companyId: selectedCompany?.id
                })
            });
            
            if (!authResponse.ok) {
                throw new Error('Error de autenticaci√≥n: ' + authResponse.statusText);
            }
            
            const authResult = await authResponse.json();
            console.log('‚úÖ [AUTH] Autenticaci√≥n exitosa:', authResult);
            
            if (!authResult.token) {
                throw new Error(authResult.error || 'Credenciales inv√°lidas');
            }
            
            // 2. Configurar sesi√≥n completa con datos b√°sicos de empresa
            console.log('üè¢ [AUTH] Configurando sesi√≥n con empresa:', selectedCompany?.name);

            // 3. Configurar sesi√≥n completa - USAR DATOS CON M√ìDULOS DESDE systemCompanies
            const companyWithModules = window.systemCompanies[selectedCompany?.id] || selectedCompany;
            currentCompany = companyWithModules;
            currentUser = authResult.user;
            currentUser.company_id = selectedCompany?.id;
            currentUser.role = 'admin';  // admin1 es administrador de empresa
            currentUser.isCompanyAdmin = true;
            isAuthenticated = true;

            // Guardar token para futuras peticiones - REACTIVADO para m√≥dulos biom√©tricos
            localStorage.setItem('authToken', authResult.token); // REACTIVADO - Necesario para m√≥dulos biom√©tricos
            companyAuthToken = authResult.token;
            authToken = authResult.token; // Para nuestro sistema de m√≥dulos

            // 3.5. Configurar variables globales para access control
            window.currentCompany = companyWithModules;
            window.currentUser = currentUser;

            console.log('üîë [ACCESS-CONTROL] Variables configuradas:', {
                currentCompany: window.currentCompany.name,
                contractedModules: window.currentCompany.contractedModules,
                activeModules: window.currentCompany.activeModules,
                currentUser: window.currentUser.username,
                userRole: window.currentUser.role,
                isCompanyAdmin: window.currentUser.isCompanyAdmin
            });

            // 4. M√≥dulos ahora se cargan din√°micamente con loadContractedModules() en loadCoreInterface()
            console.log('üìã [AUTH] M√≥dulos se cargar√°n din√°micamente despu√©s del login...');
            await loadCompanyModules(); // ACTIVADO - carga m√≥dulos desde API
            console.log('‚úÖ [AUTH] Usando nuevo sistema de m√≥dulos din√°micos');

            // 5. Mostrar dashboard DESPU√âS de cargar m√≥dulos
            hideCompanyLoginModal();
            updateCompanyLoginStatus('‚úÖ Login exitoso', 'success');
            
            // MOSTRAR LA GRID DE M√ìDULOS Y OCULTAR LOGIN COMPLETAMENTE
            console.log('üöÄ Mostrando grid de m√≥dulos despu√©s de login exitoso');

            // Ocultar COMPLETAMENTE el modal de login
            const loginModal = document.getElementById('companyLoginModal');
            if (loginModal) {
                loginModal.style.display = 'none';
                loginModal.style.visibility = 'hidden';
                loginModal.style.opacity = '0';
                console.log('üîí Modal de login ocultado completamente');
            }

            // Mostrar la interfaz principal y grid de m√≥dulos
            const body = document.body;
            if (body) body.style.overflow = 'auto'; // Permitir scroll

            const moduleGrid = document.querySelector('.module-grid');
            if (moduleGrid) {
                moduleGrid.style.display = 'grid';
                moduleGrid.style.visibility = 'visible';
                moduleGrid.style.opacity = '1';
                console.log('‚úÖ Grid de m√≥dulos mostrada');
            }

            // Mostrar header y navegaci√≥n
            const header = document.querySelector('header');
            if (header) header.style.display = 'block';

            console.log('üéØ Interfaz principal activada completamente');
            
            console.log('üéâ [DIRECT-LOGIN] Login completo exitoso');
            
        } catch (error) {
            console.error('‚ùå [DIRECT-LOGIN] Error completo:', error);
            updateCompanyLoginStatus('‚ùå ' + error.message, 'error');
        }
    }
    
    // Definir empresas del sistema directamente aqu√≠ (deshabilitadas - usamos JSON)
    const systemCompanies = {
        // Las empresas reales ahora vienen desde JSON
    };

    // Hacer systemCompanies disponible globalmente
    window.systemCompanies = systemCompanies;

    // Obtener usuarios de una empresa espec√≠fica (API REAL multi-tenant)
    async function getCompanyUsers(companyId) {
        console.log('üë• [GET-USERS] Obteniendo usuarios REALES para empresa:', companyId);

        try {
            const response = await fetch('/api/aponnt/dashboard/admin/operators');
            const data = await response.json();

            if (data.success) {
                console.log('üë• [GET-USERS] Total usuarios del sistema:', data.totalUsers);

                // Filtrar usuarios por empresa espec√≠fica
                const companyUsers = data.usersByCompany[companyId] || [];
                console.log(`üë• [GET-USERS] Usuarios de empresa ${companyId}:`, companyUsers.length);

                // Mapear a formato compatible
                const mappedUsers = companyUsers.map(user => ({
                    id: user.user_id,
                    name: user.fullName,
                    username: user.usuario,
                    email: user.email,
                    phone: user.phone,
                    role: user.role,
                    department: user.departmentName || 'Sin departamento',
                    company_id: user.companyId,
                    employeeId: user.employeeId,
                    firstName: user.firstName,
                    lastName: user.lastName,
                    isActive: user.isActive,
                    createdAt: user.createdAt
                }));

                console.log('üë• [GET-USERS] Usuarios mapeados:', mappedUsers.map(u => ({
                    username: u.username,
                    name: u.name,
                    role: u.role
                })));

                return mappedUsers;
            } else {
                console.error('‚ùå [GET-USERS] Error en respuesta:', data.error);
                return [];
            }
        } catch (error) {
            console.error('‚ùå [GET-USERS] Error obteniendo usuarios:', error);
            return [];
        }
    }
    
    // Hacer disponible globalmente
    window.getCompanyUsers = getCompanyUsers;
    
    // Cargar dashboard del usuario con m√≥dulos seg√∫n licencia y permisos
    function loadUserDashboard(user, company) {
        console.log('üöÄ [DASHBOARD] Cargando dashboard para:', user.name, 'de', company.name);
        console.log('üîµ [DEBUG-LOAD] 1. Entrando a loadUserDashboard');
        console.log('üîµ [DEBUG-LOAD] 2. Usuario recibido:', user);
        console.log('üîµ [DEBUG-LOAD] 3. Empresa recibida:', company);
        
        // Establecer variables globales
        console.log('üîµ [DEBUG-LOAD] 4. Estableciendo variables globales...');
        window.currentUser = user;
        window.currentCompany = company;
        console.log('üîµ [DEBUG-LOAD] 5. Variables globales establecidas');
        
        // Ocultar modal de login
        console.log('üîµ [DEBUG-LOAD] 6. Buscando modal de login...');
        const modal = document.getElementById('companyLoginModal');
        if (modal) {
            console.log('üîµ [DEBUG-LOAD] 7. Modal encontrado, ocultando...');
            modal.style.display = 'none';
            console.log('üîµ [DEBUG-LOAD] 8. Modal ocultado');
        } else {
            console.log('üîµ [DEBUG-LOAD] 7. Modal NO encontrado');
        }
        
        // Cargar dashboard con m√≥dulos filtrados
        console.log('üöÄ [DASHBOARD] Llamando a showMainDashboard');
        console.log('üîµ [DEBUG-LOAD] 9. Antes de llamar showMainDashboard...');
        
        try {
            showMainDashboard();
            console.log('üîµ [DEBUG-LOAD] 10. showMainDashboard llamado exitosamente');
        } catch (error) {
            console.error('‚ùå [DEBUG-LOAD] Error al llamar showMainDashboard:', error);
        }
    }
    
    // Mostrar dashboard completo con todos los m√≥dulos
    function showCompleteDashboard(user, company) {
        console.log('üéâ [COMPLETE-DASHBOARD] Mostrando dashboard completo');
        console.log('üéâ Usuario:', user.usuario, '| Empresa:', company.name);
        
        // Reemplazar todo el contenido del body con el dashboard completo
        document.body.innerHTML = `
        <div style="font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0;">
            <div style="max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #667eea; padding-bottom: 20px;">
                    <h1 style="color: #2c3e50; margin: 0; font-size: 2.5em;">üéâ Dashboard Principal</h1>
                    <h2 style="color: #667eea; margin: 10px 0 0 0; font-size: 1.8em;">üè¢ Empresa: ${company.name}</h2>
                    <p style="color: #6c757d; margin: 10px 0 0 0; font-size: 1.1em;">Usuario: ${user.usuario} | Sistema de Asistencia Biom√©trica</p>
                </div>

                <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 25px; border-radius: 15px; margin: 20px 0; text-align: center; box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);">
                    <h3 style="margin: 0 0 10px 0;">‚úÖ ¬°Sistema Completamente Operativo!</h3>
                    <p style="margin: 0; opacity: 0.9;">Todos los m√≥dulos est√°n disponibles - Los contratados est√°n habilitados</p>
                </div>

                <h3 style="color: #2c3e50; text-align: center; margin: 30px 0 20px 0; font-size: 1.5em;">üìã M√≥dulos Disponibles (17 M√≥dulos)</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-top: 30px;">
                    ${generateModuleCards(company)}
                </div>

                <div style="text-align: center; margin-top: 50px; padding: 20px; background: #f8f9fa; border-radius: 15px;">
                    <h4 style="color: #28a745; margin: 0 0 10px 0;">üéØ Dashboard Cargado Correctamente</h4>
                    <p style="color: #6c757d; margin: 0;">Empresa: ${company.name} | Usuario: ${user.usuario}</p>
                    <button onclick="location.reload()" style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-top: 10px; cursor: pointer;">üîÑ Recargar Sistema</button>
                </div>
            </div>
        </div>
        `;
        
        console.log('‚úÖ [COMPLETE-DASHBOARD] Dashboard completo cargado exitosamente');
    }
    
    // Crear el HTML completo del dashboard
    function createFullDashboardHTML(user, company) {
        console.log('üé® [HTML] Generando HTML completo del dashboard');
        console.log('üé® Usuario:', user.usuario, '| Empresa:', company.name);
        
        const moduleCardsHTML = generateModuleCardsHTML(company);
        
        return `
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Dashboard Principal - ${company.name}</title>
        </head>
        <body style="font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0;">
            <div style="max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #667eea; padding-bottom: 20px;">
                    <h1 style="color: #2c3e50; margin: 0; font-size: 2.5em;">üéâ Dashboard Principal</h1>
                    <h2 style="color: #667eea; margin: 10px 0 0 0; font-size: 1.8em;">üè¢ Empresa: ${company.name}</h2>
                    <p style="color: #6c757d; margin: 10px 0 0 0; font-size: 1.1em;">Usuario: ${user.usuario} | Sistema de Asistencia Biom√©trica</p>
                </div>

                <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 25px; border-radius: 15px; margin: 20px 0; text-align: center; box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);">
                    <h3 style="margin: 0 0 10px 0;">‚úÖ ¬°Sistema Completamente Operativo!</h3>
                    <p style="margin: 0; opacity: 0.9;">Todos los m√≥dulos est√°n disponibles - Los contratados est√°n habilitados</p>
                </div>

                <h3 style="color: #2c3e50; text-align: center; margin: 30px 0 20px 0; font-size: 1.5em;">üìã M√≥dulos Disponibles (17 M√≥dulos)</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-top: 30px;">
                    ${moduleCardsHTML}
                </div>

                <div style="text-align: center; margin-top: 50px; padding: 20px; background: #f8f9fa; border-radius: 15px;">
                    <h4 style="color: #28a745; margin: 0 0 10px 0;">üéØ Dashboard Cargado Correctamente</h4>
                    <p style="color: #6c757d; margin: 0;">Empresa: ${company.name} | Usuario: ${user.usuario}</p>
                    <button onclick="location.reload()" style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-top: 10px; cursor: pointer;">üîÑ Recargar Sistema</button>
                </div>
            </div>
        </body>
        </html>
        `;
    }
    
    // Variable global para almacenar m√≥dulos de la empresa
    let companyModules = [];

    // Cargar m√≥dulos de la empresa desde la API
    async function loadCompanyModules() {
        try {
            console.log('üîÑ [MODULES] Cargando m√≥dulos de la empresa...');

            if (!authToken) {
                console.warn('‚ö†Ô∏è [MODULES] No hay token de autenticaci√≥n');
                return [];
            }

            // Obtener company_id desde la sesi√≥n/usuario logueado
            const loggedUser = getLoggedUser();
            if (!loggedUser || !loggedUser.company_id) {
                console.error('‚ùå [MODULES] No se pudo obtener company_id del usuario logueado');
                return [];
            }

            const companyId = loggedUser.company_id;
            console.log(`üè¢ [MODULES] Cargando m√≥dulos para empresa: ${companyId}`);

            // Llamar a la API real
            const response = await fetch(`/api/v1/company-modules/${companyId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                console.log('‚úÖ [MODULES] M√≥dulos cargados desde API:', data);

                if (data.success && data.modules) {
                    companyModules = data.modules.map(module => ({
                        id: module.id,
                        name: module.name,
                        description: module.description,
                        isOperational: module.isOperational,
                        category: module.category || 'general',
                        price: module.price || 0,
                        icon: module.icon || 'üì¶',
                        color: module.color || '#666666'
                    }));

                    console.log(`‚úÖ [MODULES] ${companyModules.length} m√≥dulos procesados para la empresa`);
                } else {
                    console.warn('‚ö†Ô∏è [MODULES] No se encontraron m√≥dulos contratados');
                    companyModules = [];
                }

                // Actualizar la grid visual despu√©s de cargar los m√≥dulos
                updateModuleGrid();

                return companyModules;
            } else {
                console.error('‚ùå [MODULES] Error al cargar m√≥dulos:', response.status);
                const errorData = await response.json();
                console.error('‚ùå [MODULES] Error details:', errorData);
                return [];
            }
        } catch (error) {
            console.error('‚ùå [MODULES] Error en loadCompanyModules:', error);
            return [];
        }
    }

    // Actualizar la grid de m√≥dulos con los datos de licencias
    function updateModuleGrid() {
        console.log('üé® [MODULES] *** PROCESANDO M√ìDULOS CONTRATADOS ***');
        console.log('üé® [MODULES] Grid con', companyModules.length, 'm√≥dulos contratados');

        if (companyModules.length === 0) {
            console.warn('‚ö†Ô∏è [MODULES] No hay m√≥dulos contratados para mostrar');
            return;
        }

        // Crear un mapa de m√≥dulos contratados por ID
        const contractedModulesMap = new Map();
        companyModules.forEach(module => {
            contractedModulesMap.set(module.id, module);
        });

        console.log('üîç [MODULES] M√≥dulos contratados:', Array.from(contractedModulesMap.keys()));

        // Obtener todas las tarjetas de m√≥dulos del DOM
        let moduleCards = document.querySelectorAll('.module-card');
        console.log('üé® [MODULES] Tarjetas encontradas en DOM:', moduleCards.length);

        let enabledCount = 0;
        let disabledCount = 0;

        moduleCards.forEach(card => {
            // Obtener el ID del m√≥dulo desde el onclick
            const onclickAttr = card.getAttribute('onclick');
            if (!onclickAttr) {
                console.warn('‚ö†Ô∏è [MODULES] Tarjeta sin onclick:', card);
                return;
            }

            // Extraer moduleId del onclick (puede ser showTab o showModuleDisabledMessage)
            let moduleIdMatch = onclickAttr.match(/showTab\('([^']+)'/);
            if (!moduleIdMatch) {
                moduleIdMatch = onclickAttr.match(/showModuleDisabledMessage\('([^']+)'/);
            }

            if (!moduleIdMatch) {
                console.warn('‚ö†Ô∏è [MODULES] No se pudo extraer ID del onclick:', onclickAttr);
                return;
            }

            const moduleId = moduleIdMatch[1];
            const contractedModule = contractedModulesMap.get(moduleId);

            if (contractedModule && contractedModule.isOperational) {
                // M√≥dulo CONTRATADO Y ACTIVO - Habilitar
                card.classList.remove('disabled');
                card.style.opacity = '1';
                card.style.filter = '';
                card.style.cursor = 'pointer';
                card.style.pointerEvents = 'auto';

                // Asegurar onclick correcto
                card.setAttribute('onclick', `showTab('${moduleId}', this)`);

                enabledCount++;
                console.log(`‚úÖ [MODULES] ${moduleId} - HABILITADO (contratado y activo)`);
            } else {
                // M√≥dulo NO CONTRATADO - Deshabilitar
                card.classList.add('disabled');
                card.style.opacity = '0.3';
                card.style.filter = 'grayscale(70%)';
                card.style.cursor = 'not-allowed';
                card.style.pointerEvents = 'none';

                // Cambiar onclick para mostrar mensaje
                card.setAttribute('onclick', `showModuleDisabledMessage('${moduleId}', 'NO CONTRATADO', 'Este m√≥dulo no est√° contratado por su empresa')`);

                disabledCount++;
                console.log(`‚ùå [MODULES] ${moduleId} - DESHABILITADO (no contratado)`);
            }
        });

        console.log(`‚úÖ [MODULES] Procesamiento completado: ${enabledCount} habilitados, ${disabledCount} deshabilitados`);
        return;

        // Crear mapas de m√≥dulos para b√∫squeda optimizada
        const moduleMap = new Map();
        const moduleByName = new Map();

        companyModules.forEach(module => {
            moduleMap.set(module.id, module);
            // Tambi√©n mapear por nombre normalizado para fallback
            const normalizedName = module.name.toLowerCase().replace(/[^a-z0-9]/g, '');
            moduleByName.set(normalizedName, module);
        });

        console.log('üîç [MODULES] M√≥dulos disponibles en API:', Array.from(moduleMap.keys()));

        // Obtener todas las tarjetas de m√≥dulos
        let moduleCards3 = document.querySelectorAll('.module-card');
        console.log('üé® [MODULES] Tarjetas encontradas en DOM:', moduleCards3.length);

        moduleCards3.forEach(card => {
            // Obtener el ID del m√≥dulo desde el onclick
            const onclickAttr = card.getAttribute('onclick');
            if (!onclickAttr) {
                console.warn('‚ö†Ô∏è [MODULES] Tarjeta sin onclick:', card);
                return;
            }

            const moduleIdMatch = onclickAttr.match(/showTab\('([^']+)'/);
            if (!moduleIdMatch) {
                console.warn('‚ö†Ô∏è [MODULES] No se pudo extraer ID del onclick:', onclickAttr);
                return;
            }

            const moduleId = moduleIdMatch[1];

            // Buscar este m√≥dulo en nuestros datos (primero por ID, luego por nombre)
            let moduleData = moduleMap.get(moduleId);

            if (!moduleData) {
                // Fallback: buscar por nombre normalizado
                const cardText = card.textContent || '';
                const normalizedCardName = cardText.toLowerCase().replace(/[^a-z0-9]/g, '');
                moduleData = moduleByName.get(normalizedCardName);
            }

            console.log(`üîé [MODULES] Procesando "${moduleId}":`, moduleData ? 'ENCONTRADO' : 'NO ENCONTRADO');

            if (moduleData) {
                // Aplicar el estado correcto seg√∫n las licencias
                if (moduleData.isOperational) {
                    // M√≥dulo ACTIVO - mantener como est√° (ya est√° habilitado por defecto)
                    card.classList.remove('disabled');
                    card.style.opacity = '';
                    card.style.filter = '';
                    card.style.cursor = '';
                    console.log('‚úÖ [MODULES]', moduleId, 'ACTIVO');
                } else if (moduleData.isContracted && !moduleData.isActive) {
                    // M√≥dulo SUSPENDIDO - agregar clase disabled y cambiar banner
                    card.classList.add('disabled');
                    card.style.opacity = '0.7';
                    card.style.filter = 'grayscale(30%)';
                    // Cambiar el banner a SUSPENDIDO
                    const style = card.querySelector('style') || document.head.appendChild(document.createElement('style'));
                    style.innerHTML += `
                        .module-card.disabled.${moduleId}::after {
                            content: "SUSPENDIDO" !important;
                            background: #ffc107 !important;
                            color: #212529 !important;
                        }
                    `;
                    card.classList.add(moduleId);
                    console.log('‚ö†Ô∏è [MODULES]', moduleId, 'SUSPENDIDO');
                } else {
                    // M√≥dulo OFF (no contratado) - agregar clase disabled y interceder el click
                    card.classList.add('disabled');
                    card.style.opacity = '0.5';
                    card.style.filter = 'grayscale(70%)';
                    card.style.cursor = 'not-allowed';

                    // Reemplazar el onclick para mostrar mensaje de licencia
                    card.setAttribute('onclick', `showModuleBlocked('${moduleData?.name || moduleId}', 'OFF', 'M√≥dulo no contratado')`);
                    console.log('‚ùå [MODULES]', moduleId, 'OFF');
                }
            } else {
                // M√≥dulo no encontrado en la API - marcarlo como OFF
                card.classList.add('disabled');
                card.style.opacity = '0.5';
                card.style.filter = 'grayscale(70%)';
                card.style.cursor = 'not-allowed';

                // Reemplazar el onclick para mostrar mensaje de licencia
                card.setAttribute('onclick', `showModuleBlocked('${moduleId}', 'OFF', 'M√≥dulo no contratado')`);
                console.log('‚ùå [MODULES]', moduleId, 'OFF (no encontrado en API)');
            }
        });

        console.log('‚úÖ [MODULES] Grid actualizada correctamente');
    }

    // Crear las tarjetas de m√≥dulos para el dashboard con licencias reales
    // Mapeo de subt√≠tulos para m√≥dulos
    function getModuleSubtitle(moduleKey) {
        const subtitles = {
            'attendance': 'RRHH',
            'facial-biometric': 'SEGURIDAD',
            'users': 'PERSONAL',
            'departments': 'ORGANIZACI√ìN',
            'shifts': 'HORARIOS',
            'branches': 'UBICACIONES',
            'reports': 'ESTAD√çSTICAS',
            'medical-dashboard': 'SALUD',
            'legal-dashboard': 'LEGAL',
            'training-management': 'FORMACI√ìN',
            'documents': 'ARCHIVOS',
            'job-postings': 'B√öSQUEDAS',
            'payroll-liquidation': 'FINANZAS',
            'art-management': 'RIESGOS',
            'settings': 'SISTEMA',
            'employee-map': 'LOCALIZACI√ìN',
            'sanctions-management': 'DISCIPLINA',
            'vacation-management': 'VACACIONES',
            'psychological-assessment': 'PSICOLOG√çA'
        };
        return subtitles[moduleKey] || 'GENERAL';
    }

    function createModuleCards(company) {
        console.log('üé® [MODULES] Creando tarjetas para empresa:', company.name);

        // USAR M√ìDULOS GLOBALES YA CARGADOS
        const allSystemModules = window.allSystemModules || [];

        if (allSystemModules.length === 0) {
            console.warn('‚ö†Ô∏è [MODULES] No hay m√≥dulos del sistema cargados globalmente');
            return '<div style="text-align: center; padding: 40px; color: #666;">üîÑ Cargando m√≥dulos del sistema...</div>';
        }

        console.log('‚úÖ [MODULES] Usando', allSystemModules.length, 'm√≥dulos del sistema');

        // DEBUG: Buscar espec√≠ficamente biometric-dashboard
        const biometricDashboard = allSystemModules.find(m => m.module_key === 'biometric-dashboard');
        console.log('üîç [DEBUG] biometric-dashboard encontrado:', biometricDashboard);

        // Crear un mapa de m√≥dulos contratados para b√∫squeda r√°pida
        const contractedModulesMap = {};
        if (companyModules && companyModules.length > 0) {
            companyModules.forEach(module => {
                contractedModulesMap[module.id || module.module_key] = module;
            });
        }

        // FIX FORZADO: Asegurar que biometric-dashboard siempre est√© contratado y activo
        if (biometricDashboard) {
            contractedModulesMap['biometric-dashboard'] = {
                id: 'biometric-dashboard',
                module_key: 'biometric-dashboard',
                activo: true,
                isOperational: true,
                isContracted: true,
                isActive: true
            };
            console.log('‚úÖ [FIX] biometric-dashboard FORZADO como activo');
        }

        console.log('üìã [MODULES] M√≥dulos contratados encontrados:', Object.keys(contractedModulesMap));

        // AGRUPAR M√ìDULOS POR RUBRO Y ORDENAR ALFAB√âTICAMENTE
        const groupedModules = {};
        allSystemModules.forEach(systemModule => {
            const rubro = systemModule.rubro || 'General';
            if (!groupedModules[rubro]) {
                groupedModules[rubro] = [];
            }
            groupedModules[rubro].push(systemModule);
        });

        // Ordenar rubros alfab√©ticamente y m√≥dulos dentro de cada rubro
        const sortedRubros = Object.keys(groupedModules).sort();
        sortedRubros.forEach(rubro => {
            groupedModules[rubro].sort((a, b) => a.name.localeCompare(b.name));
        });

        console.log('üìÇ [MODULES] Agrupaci√≥n por rubro:', Object.keys(groupedModules));

        // GENERAR HTML POR RUBRO
        let html = '';
        sortedRubros.forEach(rubro => {
            const modules = groupedModules[rubro];

            html += `
                <div style="margin-bottom: 40px;">
                    <h4 style="color: #2c3e50; font-size: 18px; font-weight: bold; margin-bottom: 20px; padding-left: 10px; border-left: 4px solid #3498db;">
                        üìÅ ${rubro} (${modules.length} m√≥dulos)
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(9, 1fr); gap: 12px; margin-bottom: 25px;">
                        ${modules.map(systemModule => createSingleModuleCard(systemModule, contractedModulesMap)).join('')}
                    </div>
                </div>
            `;
        });

        return html;
    }

    // FUNCI√ìN AUXILIAR PARA CREAR UNA TARJETA INDIVIDUAL
    function createSingleModuleCard(systemModule, contractedModulesMap) {
        // Buscar si este m√≥dulo est√° contratado por la empresa
        const contractedModule = contractedModulesMap[systemModule.module_key];

        // DEBUG para biometric-dashboard
        if (systemModule.module_key === 'biometric-dashboard') {
            console.log('üîç [CARD-DEBUG] biometric-dashboard:');
            console.log('  - contractedModule:', contractedModule);
            console.log('  - isOperational:', contractedModule?.isOperational);
            console.log('  - isContracted:', contractedModule?.isContracted);
            console.log('  - isActive:', contractedModule?.isActive);
        }

        // Determinar estado del m√≥dulo
        let statusColor, statusText, cardStyle, bannerStyle = '';
        let isClickable = false;

        // Fix temporal: usar "activo" en lugar de "isOperational"
        const isActive = contractedModule?.isOperational || contractedModule?.activo;

        if (contractedModule && isActive) {
            // M√≥dulo CONTRATADO y ACTIVO
            statusColor = '#28a745';
            statusText = '‚úÖ ACTIVO';
            cardStyle = '';
            isClickable = true;
        } else if (contractedModule && (contractedModule.isContracted || contractedModule.activo === false)) {
            // M√≥dulo CONTRATADO pero SUSPENDIDO
            statusColor = '#ffc107';
            statusText = '‚ö†Ô∏è SUSPENDIDO';
            cardStyle = 'opacity: 0.8; filter: grayscale(30%);';
            bannerStyle = `
                <div style="position: absolute; top: 5px; right: 5px; background: #ffc107; color: #212529;
                     font-size: 8px; font-weight: bold; padding: 2px 6px; border-radius: 3px;
                     transform: rotate(15deg); box-shadow: 0 1px 3px rgba(0,0,0,0.3);">
                    SUSPENDIDO
                </div>
            `;
        } else {
            // M√≥dulo NO CONTRATADO
            statusColor = '#dc3545';
            statusText = '‚ùå NO CONTRATADO';
            cardStyle = 'opacity: 0.6; filter: grayscale(70%); cursor: not-allowed !important;';
            bannerStyle = `
                <div style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white;
                     font-size: 8px; font-weight: bold; padding: 2px 6px; border-radius: 3px;
                     transform: rotate(15deg); box-shadow: 0 1px 3px rgba(0,0,0,0.3);">
                    NO CONTRATADO
                </div>
            `;
        }

        const clickAction = isClickable ?
            `console.log('üî• ONCLICK: ${systemModule.module_key}'); showModuleContent('${systemModule.module_key}', '${systemModule.name}')` :
            `showModuleBlocked('${systemModule.name}', '${statusText}', 'Este m√≥dulo no est√° contratado por su empresa')`;

        return `
            <div class="module-card" onclick="${clickAction}" style="
                ${cardStyle}
                background: #ffffff;
                border: 2px solid #17a2b8;
                color: #2c3e50;
                padding: 20px;
                border-radius: 12px;
                text-align: center;
                min-height: 160px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(52, 152, 219, 0.1);
                position: relative;
                overflow: hidden;
            ">
                ${bannerStyle}
                <span style="font-size: 6em; margin-bottom: 15px; display: block;">${systemModule.icon || 'üìä'}</span>
                <h3 style="font-size: 16px; font-weight: bold; margin: 0 0 8px 0; color: #000000;">${systemModule.name}</h3>
                <div style="font-size: 11px; color: #666666; font-weight: normal; margin-bottom: 10px;">${systemModule.rubro || 'General'}</div>
                <div style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; display: inline-block; box-shadow: 0 1px 4px rgba(0,0,0,0.2);">
                    ${statusText}
                </div>
            </div>
        `;
    }

    // M√≥dulos b√°sicos como fallback
    function createBasicModuleCards(company) {
        const basicModules = [
            { id: 'users', name: 'Usuarios', icon: 'üë•' },
            { id: 'attendance', name: 'Asistencia', icon: 'üìã' },{ id: 'settings', name: 'Configuraci√≥n', icon: '‚öôÔ∏è' }
        ];

        return basicModules.map(module => `
            <div onclick="alert('M√≥dulo: ${module.name}\\nEstado: B√ÅSICO\\nCargando configuraci√≥n...')" style="
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 30px;
                border-radius: 20px;
                text-align: center;
                min-height: 180px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            ">
                <span style="font-size: 4em; margin-bottom: 15px; display: block;">${module.icon || 'üì¶'}</span>
                <h3 style="font-size: 20px; font-weight: bold; margin: 0 0 5px 0;">${module.name && module.name !== 'undefined' ? module.name : module.id}</h3>
                <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.8); margin-bottom: 10px; letter-spacing: 1px;">${getModuleSubtitle(module.id)}</div>
                <div style="background: #28a745; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold;">
                    ‚úÖ B√ÅSICO
                </div>
            </div>
        `).join('');
    }

    // Cargar m√≥dulo JS din√°micamente (v3.0.0)
    async function loadModuleDynamically(moduleId, scriptPath) {
        return new Promise((resolve, reject) => {
            try {
                console.log(`üì¶ [DYNAMIC-LOAD] Creando script para: ${moduleId}`);

                const script = document.createElement('script');
                const cacheBuster = Date.now();
                script.src = `${scriptPath}?v=${cacheBuster}`;

                console.log(`üì¶ [DYNAMIC-LOAD] Script src: ${script.src}`);

                script.onload = () => {
                    console.log(`‚úÖ [DYNAMIC-LOAD] Script cargado exitosamente: ${moduleId}`);
                    resolve();
                };

                script.onerror = (error) => {
                    console.error(`‚ùå [DYNAMIC-LOAD] Error cargando script ${moduleId}:`, error);
                    console.error(`‚ùå [DYNAMIC-LOAD] Script URL: ${script.src}`);
                    reject(new Error(`Failed to load script: ${scriptPath}`));
                };

                console.log(`üì¶ [DYNAMIC-LOAD] Agregando script al DOM...`);
                document.head.appendChild(script);

            } catch (error) {
                console.error(`‚ùå [DYNAMIC-LOAD] Exception cargando ${moduleId}:`, error);
                reject(error);
            }
        });
    }

    // Mostrar contenido del m√≥dulo (para m√≥dulos activos)
    function showModuleContent(moduleId, moduleName) {
        console.log(`üéØ Cargando m√≥dulo: ${moduleName} (ID: ${moduleId})`);
        console.log('üîç [DEBUG 1] Inicio de showModuleContent');

        // Ocultar el grid de m√≥dulos y mostrar el contenido del m√≥dulo
        const moduleGrid = document.querySelector('.module-grid');
        if (moduleGrid) {
            moduleGrid.style.display = 'none';
        }
        console.log('üîç [DEBUG 2] moduleGrid ocultado');

        // Limpiar contenido anterior
        const mainContent = document.getElementById('mainContent');
        if (!mainContent) {
            console.error('‚ùå Error: No se encontr√≥ el elemento mainContent');
            return;
        }
        console.log('üîç [DEBUG 3] mainContent encontrado');

        // Mostrar el mainContent
        mainContent.style.display = 'block';
        mainContent.style.visibility = 'visible';
        mainContent.style.opacity = '1';

        // Limpiar y mostrar loader
        mainContent.innerHTML = `
            <div style="text-align: center; padding: 50px;">
                <div style="font-size: 48px; margin-bottom: 20px;">üîÑ</div>
                <h2>Cargando ${moduleName}...</h2>
                <p>Inicializando m√≥dulo completo...</p>
            </div>
        `;
        console.log('üîç [DEBUG 4] Loader mostrado');
        console.log('üîç [DEBUG 5] Iniciando setTimeout de 500ms...');

        // ‚úÖ SISTEMA DE CARGA DIN√ÅMICA (reemplaza switch hardcodeado)
        setTimeout(async () => {
            console.log('üîç [DYNAMIC-LOAD] Cargando m√≥dulo din√°micamente:', moduleId);
            try {
                // Buscar metadata del m√≥dulo en activeModules
                const moduleMetadata = window.activeModules?.find(m => m.module_key === moduleId);

                if (!moduleMetadata) {
                    console.warn(`‚ö†Ô∏è  [DYNAMIC-LOAD] M√≥dulo ${moduleId} no encontrado en activeModules`);
                    showModuleFallback(moduleId, moduleName, 'M√≥dulo no disponible para esta empresa');
                    return;
                }

                console.log(`‚úÖ [DYNAMIC-LOAD] Metadata encontrada:`, moduleMetadata);

                // Cargar JS file din√°micamente
                const scriptPath = moduleMetadata.frontend_file;
                console.log(`üì¶ [DYNAMIC-LOAD] Cargando script: ${scriptPath}`);

                await loadModuleDynamically(moduleId, scriptPath);

                // Ejecutar funci√≥n de inicializaci√≥n seg√∫n convenci√≥n
                // Prioridad 1: window.Modules[moduleKey].init()
                // Prioridad 2: window[init_function]() desde metadata
                // Prioridad 3: window.show{ModuleKey}Content() (legacy)

                let initialized = false;

                // Intento 1: Convenci√≥n nueva (window.Modules)
                if (window.Modules && window.Modules[moduleId] && typeof window.Modules[moduleId].init === 'function') {
                    console.log(`‚úÖ [DYNAMIC-LOAD] Ejecutando window.Modules.${moduleId}.init()`);
                    window.Modules[moduleId].init();
                    initialized = true;
                }
                // Intento 2: Funci√≥n desde metadata
                else if (moduleMetadata.init_function && typeof window[moduleMetadata.init_function] === 'function') {
                    console.log(`‚úÖ [DYNAMIC-LOAD] Ejecutando window.${moduleMetadata.init_function}()`);
                    window[moduleMetadata.init_function]();
                    initialized = true;
                }
                // Intento 3: Legacy pattern (showUsersContent, etc.)
                else {
                    const legacyFunctionName = `show${capitalize(moduleId)}Content`;
                    if (typeof window[legacyFunctionName] === 'function') {
                        console.log(`‚úÖ [DYNAMIC-LOAD] Ejecutando window.${legacyFunctionName}() [LEGACY]`);
                        window[legacyFunctionName]();
                        initialized = true;
                    }
                }

                if (!initialized) {
                    console.error(`‚ùå [DYNAMIC-LOAD] No se encontr√≥ funci√≥n de inicializaci√≥n para ${moduleId}`);
                    showModuleFallback(moduleId, moduleName, 'M√≥dulo cargado pero sin funci√≥n de inicializaci√≥n');
                }

            } catch (error) {
                console.error(`‚ùå [DYNAMIC-LOAD] Error cargando m√≥dulo ${moduleId}:`, error);
                showModuleFallback(moduleId, moduleName, `Error: ${error.message}`);
            }

            // ‚ö†Ô∏è OLD SWITCH REMOVED - Sistema din√°mico activo
            // Antes hab√≠a un switch con 40+ casos hardcodeados
            // Ahora se carga DIN√ÅMICAMENTE basado en metadata de UnifiedKnowledgeService

            if (false) {
                // C√ìDIGO LEGACY REMOVIDO
                switch(moduleId) {
                    case 'training':
                        if (typeof showTrainingManagementContent === 'function') {
                            showTrainingManagementContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'training-management.js no cargado');
                        }
                        break;

                    case 'medical':
                    case 'medical-dashboard':
                        if (typeof showMedicalDashboardContent === 'function') {
                            showMedicalDashboardContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'medical-dashboard.js no cargado');
                        }
                        break;

                    case 'psychological':
                    case 'psychological-assessment':
                        if (typeof showPsychologicalAssessmentContent === 'function') {
                            showPsychologicalAssessmentContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'psychological-assessment.js no cargado');
                        }
                        break;

                    case 'emotional':
                    case 'emotional-analysis':
                        if (typeof showEmotionalAnalysisContent === 'function') {
                            showEmotionalAnalysisContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'emotional-analysis.js no cargado');
                        }
                        break;

                    case 'sanctions':
                    case 'sanctions-management':
                        if (typeof showSanctionsManagementContent === 'function') {
                            showSanctionsManagementContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'sanctions-management.js no cargado');
                        }
                        break;

                    case 'vacation':
                    case 'vacation-management':
                        if (typeof showVacationManagementContent === 'function') {
                            showVacationManagementContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'vacation-management.js no cargado');
                        }
                        break;

                    case 'dashboard':
                        if (typeof showDashboardContent === 'function') {
                            showDashboardContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'dashboard.js no cargado');
                        }
                        break;

                    /* ‚úÖ C√ìDIGO FUNCIONAL PROTEGIDO - NO MODIFICAR SIN AN√ÅLISIS
                     * üìÖ Fecha: 23/SEP/2025 04:05:00
                     * üè∑Ô∏è Versi√≥n: v2.1.2-ATTENDANCE
                     * üìã Funcionalidad: M√≥dulo de asistencia empresarial
                     */
                    case 'attendance':
                        console.log('‚úÖ [SWITCH-DEBUG] ENCONTRADO case attendance!');
                        console.log('üîç [SWITCH-DEBUG] Verificando funci√≥n showAttendanceContent:', typeof showAttendanceContent);
                        if (typeof showAttendanceContent === 'function') {
                            console.log('‚úÖ [SWITCH-DEBUG] Funci√≥n existe, ejecutando...');
                            showAttendanceContent();
                        } else {
                            console.log('‚ùå [SWITCH-DEBUG] Funci√≥n NO existe');
                            showModuleFallback(moduleId, moduleName, 'attendance.js no cargado');
                        }
                        break;

                    /* ‚úÖ C√ìDIGO FUNCIONAL PROTEGIDO - NO MODIFICAR SIN AN√ÅLISIS
                     * üìÖ Fecha: 23/SEP/2025 04:05:00
                     * üè∑Ô∏è Versi√≥n: v2.1.2-USERS
                     * üìã Funcionalidad: M√≥dulo de gesti√≥n de usuarios empresariales
                     */
                    case 'users':
                        if (typeof showUsersContent === 'function') {
                            showUsersContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'users.js no cargado');
                        }
                        break;

                    // ‚úÖ M√ìDULO DE SOPORTE - Sistema de tickets con acceso temporal
                    case 'support':
                        if (typeof SupportCustomerView !== 'undefined' && SupportCustomerView.init) {
                            SupportCustomerView.init('main-content');
                        } else {
                            showModuleFallback(moduleId, moduleName, 'support-customer-view.js no cargado');
                        }
                        break;

                    case 'access-control':
                        if (typeof checkUserAccess === 'function') {
                            showAccessControlPanel();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'access-control.js no cargado');
                        }
                        break;

                    // ‚úÖ M√ìDULOS BIOM√âTRICOS
                    case 'biometric-simple':
                        // biometric-simple es una librer√≠a, no un m√≥dulo con UI propia
                        // Se usa desde el m√≥dulo de Usuarios
                        mainContent.innerHTML = `
                            <div style="text-align: center; padding: 60px 20px;">
                                <i class="fas fa-info-circle" style="font-size: 64px; color: #3498db; margin-bottom: 20px;"></i>
                                <h2>Registro Biom√©trico de Empleados</h2>
                                <p style="font-size: 18px; color: #666; margin: 20px 0;">
                                    Esta funcionalidad est√° integrada en el m√≥dulo de <strong>Gesti√≥n de Usuarios</strong>.
                                </p>
                                <p style="color: #888; margin-bottom: 30px;">
                                    Para registrar la biometr√≠a de un empleado:
                                </p>
                                <ol style="text-align: left; max-width: 500px; margin: 0 auto 30px; color: #666;">
                                    <li style="margin: 10px 0;">Ir al m√≥dulo <strong>Gesti√≥n de Usuarios</strong></li>
                                    <li style="margin: 10px 0;">Seleccionar un empleado</li>
                                    <li style="margin: 10px 0;">Click en el bot√≥n "Captura Biom√©trica"</li>
                                </ol>
                                <button onclick="showModuleContent('users', 'Gesti√≥n de Usuarios')"
                                        style="background: #3498db; color: white; border: none; padding: 15px 30px;
                                               border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 20px;">
                                    <i class="fas fa-users"></i> Ir a Gesti√≥n de Usuarios
                                </button>
                            </div>
                        `;
                        break;

                    case 'emotional-analysis':
                        if (typeof showEmotionalAnalysisContent === 'function') {
                            showEmotionalAnalysisContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'emotional-analysis.js no cargado');
                        }
                        break;

                    case 'biometric-consent':
                        if (typeof showBiometricconsentContent === 'function') {
                            showBiometricconsentContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'biometric-consent.js no cargado');
                        }
                        break;

                    case 'notifications':
                    case 'absence-notifications':
                    case 'fehaciente-consent':
                        if (typeof showNotificationsContent === 'function') {
                            showNotificationsContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'notifications.js no cargado');
                        }
                        break;

                    // ‚úÖ SISTEMA DE NOTIFICACIONES AVANZADO V2.0 - 5 M√ìDULOS
                    case 'compliance-dashboard':
                        if (typeof ComplianceDashboard !== 'undefined' && ComplianceDashboard.init) {
                            ComplianceDashboard.init();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'compliance-dashboard.js no cargado');
                        }
                        break;

                    case 'sla-tracking':
                        if (typeof SLATracking !== 'undefined' && SLATracking.init) {
                            SLATracking.init();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'sla-tracking.js no cargado');
                        }
                        break;

                    case 'audit-reports':
                        if (typeof AuditReports !== 'undefined' && AuditReports.init) {
                            AuditReports.init();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'audit-reports.js no cargado');
                        }
                        break;

                    case 'resource-center':
                        if (typeof ResourceCenter !== 'undefined' && ResourceCenter.init) {
                            ResourceCenter.init();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'resource-center.js no cargado');
                        }
                        break;

                    case 'notifications-enterprise':
                        if (typeof NotificationsEnterprise !== 'undefined' && NotificationsEnterprise.init) {
                            NotificationsEnterprise.init();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'notifications-enterprise.js no cargado');
                        }
                        break;

                    case 'biometric-dashboard':
                        console.log('üéØ [DEBUG] Entrando a case biometric-dashboard');
                        console.log('üéØ [DEBUG] typeof showBiometricDashboardContent:', typeof showBiometricDashboardContent);
                        console.log('üéØ [DEBUG] window.showBiometricDashboardContent:', typeof window.showBiometricDashboardContent);

                        if (typeof showBiometricDashboardContent === 'function') {
                            console.log('‚úÖ [DEBUG] Funci√≥n encontrada, ejecutando...');
                            showBiometricDashboardContent();
                        } else if (typeof window.showBiometricDashboardContent === 'function') {
                            console.log('‚úÖ [DEBUG] Funci√≥n encontrada en window, ejecutando...');
                            window.showBiometricDashboardContent();
                        } else {
                            console.error('‚ùå [DEBUG] Funci√≥n NO encontrada');
                            alert('SCRIPT NO CARGADO: biometric-dashboard.js\ntypeof showBiometricDashboardContent: ' + typeof showBiometricDashboardContent);
                            showModuleFallback(moduleId, moduleName, 'biometric-dashboard.js no cargado');
                        }
                        break;

                    case 'departments':
                        if (typeof showDepartmentsContent === 'function') {
                            showDepartmentsContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'departments.js no cargado');
                        }
                        break;

                    case 'kiosks':
                        if (typeof showKiosksContent === 'function') {
                            showKiosksContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'kiosks.js no cargado');
                        }
                        break;

                    case 'visitors':
                        if (typeof showVisitorsContent === 'function') {
                            showVisitorsContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'visitors.js no cargado');
                        }
                        break;

                    case 'notifications':
                        if (typeof showNotificationsContent === 'function') {
                            showNotificationsContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'notifications.js no cargado');
                        }
                        break;

                    // ==================== M√ìDULOS SIAC ====================
                    case 'siac-admin-panel':
                        showSiacAdminPanel();
                        break;

                    case 'siac-clients':
                        showSiacClients();
                        break;

                    case 'siac-products':
                        showSiacProducts();
                        break;

                    case 'siac-billing':
                        showSiacBilling();
                        break;

                    case 'clientes':
                        if (typeof showClientesContent === 'function') {
                            showClientesContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'clientes.js no cargado');
                        }
                        break;

                    case 'facturacion':
                        if (typeof showFacturacionContent === 'function') {
                            showFacturacionContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'facturacion.js no cargado');
                        }
                        break;

                    case 'plantillas-fiscales':
                        if (typeof showPlantillasFiscalesContent === 'function') {
                            showPlantillasFiscalesContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'plantillas-fiscales.js no cargado');
                        }
                        break;

                    // ==================== M√ìDULOS ADICIONALES ====================
                    case 'job-postings':
                        if (typeof showJobPostingsContent === 'function') {
                            showJobPostingsContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'job-postings.js no cargado');
                        }
                        break;
                    case 'training-management':
                        if (typeof showTrainingManagementContent === 'function') {
                            showTrainingManagementContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'training-management.js no cargado');
                        }
                        break;
                    case 'document-management':
                        if (typeof showDocumentManagementContent === 'function') {
                            showDocumentManagementContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'document-management.js no cargado');
                        }
                        break;
                    case 'employee-map':
                        if (typeof showEmployeeMapContent === 'function') {
                            showEmployeeMapContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'employee-map.js no cargado');
                        }
                        break;
                    case 'legal-dashboard':
                        if (typeof showLegalDashboardContent === 'function') {
                            showLegalDashboardContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'legal-dashboard.js no cargado');
                        }
                        break;
                    case 'licensing-management':
                        if (typeof showLicensingManagementContent === 'function') {
                            showLicensingManagementContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'licensing-management.js no cargado');
                        }
                        break;
                    case 'payroll-liquidation':
                        if (typeof showPayrollLiquidationContent === 'function') {
                            showPayrollLiquidationContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'payroll-liquidation.js no cargado');
                        }
                        break;
                    case 'art-management':
                        if (typeof showArtManagementContent === 'function') {
                            showArtManagementContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'art-management.js no cargado');
                        }
                        break;
                    case 'settings':
                        if (typeof showSettingsContent === 'function') {
                            showSettingsContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'settings.js no cargado');
                        }
                        break;
                    case 'auditor-dashboard':
                    case 'auditor':
                        // Cargar m√≥dulo del auditor
                        loadModuleContent('auditor-dashboard').then(() => {
                            if (typeof showAuditorContent === 'function') {
                                showAuditorContent();
                            } else {
                                console.error('‚ùå [AUDITOR] showAuditorContent no est√° disponible');
                                showModuleFallback(moduleId, moduleName, 'auditor-dashboard-unified.js no cargado');
                            }
                        }).catch(error => {
                            console.error('‚ùå [AUDITOR] Error cargando m√≥dulo:', error);
                            showModuleFallback(moduleId, moduleName, 'Error cargando auditor: ' + error.message);
                        });
                        break;
                    case 'shifts':
                        console.log('üéØ [SHIFTS-CASE] Entrando en case shifts');
                        console.log('üîç [SHIFTS-CASE] typeof showShiftsContent:', typeof showShiftsContent);
                        console.log('üîç [SHIFTS-CASE] window.showShiftsContent:', window.showShiftsContent);

                        if (typeof showShiftsContent === 'function') {
                            console.log('‚úÖ [SHIFTS-CASE] showShiftsContent es funci√≥n, ejecutando...');
                            try {
                                showShiftsContent();
                                console.log('‚úÖ [SHIFTS-CASE] showShiftsContent ejecutada sin errores');
                            } catch (error) {
                                console.error('‚ùå [SHIFTS-CASE] Error ejecutando showShiftsContent:', error);
                                showModuleFallback(moduleId, moduleName, 'Error: ' + error.message);
                            }
                        } else {
                            console.error('‚ùå [SHIFTS-CASE] showShiftsContent NO es funci√≥n');
                            showModuleFallback(moduleId, moduleName, 'shifts.js no cargado');
                        }
                        break;
                    case 'terms-conditions':
                        if (typeof showTermsconditionsContent === 'function') {
                            showTermsconditionsContent();
                        } else {
                            showModuleFallback(moduleId, moduleName, 'terms-conditions.js no cargado');
                        }
                        break;
                    case 'inbox':
                        console.log('üéØ [INBOX-CASE] Cargando Bandeja de Notificaciones');
                        loadModuleDynamically('inbox', '/js/modules/inbox.js')
                            .then(() => {
                                if (typeof showInboxContent === 'function') {
                                    showInboxContent();
                                } else {
                                    showModuleFallback(moduleId, moduleName, 'inbox.js no cargado correctamente');
                                }
                            })
                            .catch(error => {
                                console.error('‚ùå [INBOX] Error cargando m√≥dulo:', error);
                                showModuleFallback(moduleId, moduleName, 'Error: ' + error.message);
                            });
                        break;
                    case 'notifications-enterprise':
                        console.log('üéØ [NOTIF-ENTERPRISE-CASE] Cargando Notificaciones Enterprise V3.0');
                        loadModuleDynamically('notifications-enterprise', '/js/modules/notifications-enterprise.js')
                            .then(() => {
                                if (typeof NotificationsEnterprise !== 'undefined' && typeof NotificationsEnterprise.init === 'function') {
                                    NotificationsEnterprise.init();
                                } else {
                                    showModuleFallback(moduleId, moduleName, 'notifications-enterprise.js no cargado correctamente');
                                }
                            })
                            .catch(error => {
                                console.error('‚ùå [NOTIF-ENTERPRISE] Error cargando m√≥dulo:', error);
                                showModuleFallback(moduleId, moduleName, 'Error: ' + error.message);
                            });
                        break;
                    default:
                        console.log(`‚ùå [SWITCH-DEBUG] NO SE ENCONTR√ì CASE para moduleId: "${moduleId}"`);
                        console.log(`üìù [SWITCH-DEBUG] Cases disponibles: training, medical, medical-dashboard, psychological, psychological-assessment, sanctions, sanctions-management, vacation, vacation-management, dashboard, attendance, users, access-control, notifications, absence-notifications, fehaciente-consent, biometric, departments, siac-admin-panel, siac-clients, siac-products, siac-billing, clientes, facturacion, plantillas-fiscales, job-postings, training-management, document-management, employee-map, legal-dashboard, licensing-management, payroll-liquidation, art-management, settings, auditor-dashboard, auditor, shifts, terms-conditions, inbox, notifications-enterprise`);
                        // Para m√≥dulos que no tienen implementaci√≥n espec√≠fica a√∫n
                        showModuleFallback(moduleId, moduleName, `ID no encontrado: "${moduleId}"`);
                }
            } // Cierre if (false) - SWITCH LEGACY DESHABILITADO

            // Scroll autom√°tico al inicio del contenido del m√≥dulo
            setTimeout(() => {
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);

        }, 500);
    }

    // Helper: Capitalizar primera letra
    function capitalize(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // Fallback para m√≥dulos no implementados o con errores
    function showModuleFallback(moduleId, moduleName, reason) {
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = `
            <div style="text-align: center; padding: 50px; border: 2px dashed #ffc107; border-radius: 10px; background: #fff8e1;">
                <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                <h2 style="color: #f57f17;">${moduleName}</h2>
                <p style="color: #f57f17; font-size: 16px; margin: 20px 0;"><strong>Estado:</strong> ${reason}</p>
                <div style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #ffeb3b; margin: 20px 0;">
                    <h3 style="color: #333; margin-bottom: 10px;">üîß Informaci√≥n del M√≥dulo</h3>
                    <p><strong>ID:</strong> ${moduleId}</p>
                    <p><strong>Nombre:</strong> ${moduleName}</p>
                    <p><strong>Estado:</strong> Disponible pero pendiente de carga</p>
                </div>
                <button onclick="location.reload()" style="background: #2196F3; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">
                    üîÑ Recargar P√°gina
                </button>
            </div>
        `;
    }

    // Mostrar mensaje de m√≥dulo bloqueado
    function showModuleBlocked(moduleName, status, reason) {
        alert(`üö´ M√≥dulo: ${moduleName}\n${status}\n\nüìù Motivo: ${reason}\n\nüí° Contacte al administrador para habilitar este m√≥dulo.`);
    }
    
    // Generar las tarjetas de m√≥dulos
    function generateModuleCardsHTML(company) {
        const modules = [
            { id: 'users', name: 'Usuarios', icon: 'üë•' },
            { id: 'departments', name: 'Departamentos', icon: 'üè¢' },
            { id: 'kiosks', name: 'Kioscos', icon: 'üìü' },
            { id: 'visitors', name: 'Visitantes', icon: 'üë•' },
            { id: 'inbox', name: 'Bandeja Notificaciones', icon: 'üì¨' },
            { id: 'shifts', name: 'Turnos', icon: 'üïê' },
            { id: 'attendance', name: 'Asistencia', icon: 'üìã' },
            { id: 'facial-biometric', name: 'Biometr√≠a Anal√≠tica', icon: 'üé≠' },{ id: 'medical-dashboard', name: 'M√©dico', icon: 'üë©‚Äç‚öïÔ∏è' },
            { id: 'art-management', name: 'ART', icon: 'üè•' },
            { id: 'document-management', name: 'Documentos', icon: 'üìÑ' },
            { id: 'legal-dashboard', name: 'Legal', icon: '‚öñÔ∏è' },
            { id: 'compliance-dashboard', name: 'Compliance Legal', icon: '‚öñÔ∏è' },
            { id: 'sla-tracking', name: 'SLA Tracking', icon: '‚è±Ô∏è' },
            { id: 'resource-center', name: 'Centro Recursos', icon: 'üìä' },
            { id: 'audit-reports', name: 'Reportes Auditor√≠a', icon: 'üìÑ' },
            { id: 'payroll-liquidation', name: 'Liquidaci√≥n', icon: 'üí∞' },
            { id: 'employee-map', name: 'Mapa Empleados', icon: 'üó∫Ô∏è' },
            { id: 'training-management', name: 'Capacitaciones', icon: 'üìö' },
            { id: 'job-postings', name: 'Postulaciones', icon: 'üíº' },
            { id: 'settings', name: 'Configuraci√≥n', icon: '‚öôÔ∏è' },
            { id: 'reports', name: 'Reportes', icon: 'üìä' },
            { id: 'psychological-assessment', name: 'Evaluaci√≥n Psicol√≥gica', icon: 'üß†' },
            { id: 'sanctions-management', name: 'Gesti√≥n de Sanciones', icon: '‚öñÔ∏è' },
            { id: 'vacation-management', name: 'Gesti√≥n de Vacaciones', icon: 'üèñÔ∏è' }
        ];
        
        return modules.map(module => {
            // Verificar si el m√≥dulo est√° contratado
            const isActive = (company.activeModules && company.activeModules[module.id] === true) ||
                           ['settings', 'dashboard'].includes(module.id);

            // Debug de m√≥dulos no activos
            if (!isActive && !['settings', 'dashboard'].includes(module.id)) {
                console.log(`üîç [DEBUG] M√≥dulo ${module.id} NO activo - activeModules[${module.id}]: ${company.activeModules ? company.activeModules[module.id] : 'undefined'}`);
            }
            
            const statusColor = isActive ? '#28a745' : '#6c757d';
            const statusText = isActive ? '‚úÖ HABILITADO' : '‚ùå NO CONTRATADO';
            const cardStyle = isActive ? '' : 'opacity: 0.6; filter: grayscale(50%);';
            const clickAction = isActive ? `alert('M√≥dulo: ${module.name}\\nEstado: HABILITADO\\nEmpresa: ${company.name}')` : `alert('M√≥dulo: ${module.name}\\nEstado: NO CONTRATADO\\nContacte al administrador para habilitar este m√≥dulo')`;
            
            return `
                <div onclick="${clickAction}" style="
                    ${cardStyle}
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 30px;
                    border-radius: 20px;
                    text-align: center;
                    min-height: 180px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                    position: relative;
                    overflow: hidden;
                ">
                    <span style="font-size: 4em; margin-bottom: 15px; display: block; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">${module.icon || 'üì¶'}</span>
                    <h3 style="font-size: 20px; font-weight: bold; margin: 0 0 10px 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">${module.name && module.name !== 'undefined' ? module.name : module.id}</h3>
                    <div style="background: ${statusColor}; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; display: inline-block; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                        ${statusText}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Dashboard b√°sico como fallback
    function showBasicDashboard() {
        console.log('üìä [DASHBOARD] Iniciando showBasicDashboard');
        console.log('üìä [DEBUG] 1. Iniciando funci√≥n showBasicDashboard');
        
        // Ocultar modal de login
        const modal = document.getElementById('companyLoginModal');
        console.log('üìä [DEBUG] 2. Modal encontrado?', modal ? 'SI' : 'NO');
        if (modal) {
            console.log('üìä [DEBUG] 3. Ocultando modal...');
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
            modal.style.opacity = '0';
            modal.style.zIndex = '-1';
            console.log('üìä [DEBUG] 4. Modal ocultado');
            
            // Verificaci√≥n adicional
            const modalVisible = window.getComputedStyle(modal).display;
            console.log('üìä [DEBUG] 4b. Verificaci√≥n - Modal display:', modalVisible);
        }
        
        // Mostrar contenedor principal del sistema
        const mainContainer = document.getElementById('mainSystemContainer');
        console.log('üìä [DEBUG] 5. Container principal encontrado?', mainContainer ? 'SI' : 'NO');
        if (mainContainer) {
            console.log('üìä [DEBUG] 6. Mostrando container principal...');
            // FORZAR VISIBILIDAD COMPLETAMENTE
            mainContainer.style.display = 'block';
            mainContainer.style.visibility = 'visible';
            mainContainer.style.opacity = '1';
            mainContainer.style.position = 'relative';
            mainContainer.style.zIndex = '9999';
            mainContainer.style.backgroundColor = 'white';
            mainContainer.style.minHeight = '100vh';
            console.log('‚úÖ [DASHBOARD] Container principal mostrado');
            console.log('üìä [DEBUG] 7. Container principal visible');
            
            // Actualizar informaci√≥n del usuario en el encabezado
            updateUserInfo();
            
            // Inicializar sistema de traducci√≥n
            setTimeout(() => {
                if (window.translator) {
                    window.translator.updateInterface();
                }
            }, 100);
        } else {
            console.error('‚ùå [DEBUG] ERROR: No se encontr√≥ mainSystemContainer');
        }
        
        const content = document.getElementById('mainContent');
        console.log('üìä [DEBUG] 8. mainContent encontrado?', content ? 'SI' : 'NO');
        if (content) {
            // Ocultar el contenido ya que ahora usamos la grid de m√≥dulos
            content.style.display = 'none';
            console.log('üìä [DEBUG] 9. mainContent ocultado - usando grid de m√≥dulos');
        }

        // Mostrar la grid de m√≥dulos
        const moduleGrid = document.querySelector('.module-grid');
        if (moduleGrid) {
            moduleGrid.style.display = 'grid';
            moduleGrid.style.visibility = 'visible';
            moduleGrid.style.opacity = '1';
            console.log('üìä [DEBUG] 10. Grid de m√≥dulos mostrada');
        }
    }
    
    // Actualizar men√∫ de navegaci√≥n seg√∫n m√≥dulos accesibles
    function updateNavigationMenu(accessibleModules) {
        console.log('üîß [NAVIGATION] Actualizando men√∫ para m√≥dulos:', accessibleModules);
        const tabsContainer = document.querySelector('.tabs');
        if (!tabsContainer) {
            console.warn('‚ö†Ô∏è [NAVIGATION] Container de tabs no encontrado - saltando actualizaci√≥n de men√∫');
            return;
        }
        
        // Mapeo de m√≥dulos a elementos de navegaci√≥n
        const moduleNavMap = {
            'usuarios-departamentos-turnos-asistencia': ['üë• Usuarios', 'üè¢ Departamentos', 'üïê Turnos', 'üìã Asistencia'],
            'dashboard-medico': ['üè• Dashboard M√©dico'],
            'legal': ['‚öñÔ∏è Legal'],
            'ubicacion-gps-empleados': ['üìç Mapa GPS'],
            'art': ['üõ°Ô∏è ART'],
            'liquidacion-sueldos': ['üí∞ Liquidaciones'],
            'capacitaciones': ['üéì Capacitaciones']
        };
        
        // Solo mostrar elementos de navegaci√≥n para m√≥dulos accesibles
        const navItems = tabsContainer.querySelectorAll('.tab');
        navItems.forEach(item => {
            const itemText = item.textContent.trim();
            let shouldShow = false;
            
            // Verificar si el item pertenece a alg√∫n m√≥dulo accesible
            for (const moduleId of accessibleModules) {
                const moduleNavItems = moduleNavMap[moduleId] || [];
                if (moduleNavItems.some(navText => itemText.includes(navText.replace(/[^\w\s]/g, '').trim()))) {
                    shouldShow = true;
                    break;
                }
            }
            
            // Siempre mostrar Dashboard y elementos b√°sicos
            if (itemText.includes('Dashboard') && !itemText.includes('M√©dico')) {
                shouldShow = true;
            }
            
            // Solo administradores pueden ver gesti√≥n de permisos
            if (itemText.includes('Gesti√≥n de Permisos')) {
                shouldShow = window.currentUser.role === 'admin' || window.currentUser.isCompanyAdmin;
            }
            
            item.style.display = shouldShow ? 'block' : 'none';
        });
    }
    
    // Cargar empresa desde cache si existe
    function loadCachedCompany() {
        const rememberedCompanyId = localStorage.getItem('aponnt_remember_company');
        if (rememberedCompanyId && typeof systemCompanies !== 'undefined') {
            const company = systemCompanies[rememberedCompanyId];
            if (company) {
                selectedCompany = company;
                const select = document.getElementById('companySelect');
                if (select) {
                    select.value = company.slug || company.company_id;
                }
                showLoginForm();
                console.log('üì¶ [CACHE] Empresa cargada desde cache:', company.name);
                return true;
            }
        }
        return false;
    }
    
    // Verificar sesi√≥n guardada al cargar
    function checkSavedSession() {
        const savedSession = localStorage.getItem('aponnt_session') || sessionStorage.getItem('aponnt_session');
        if (savedSession && savedSession !== 'undefined') {
            try {
                const sessionData = JSON.parse(savedSession);
                if (sessionData.user && sessionData.company) {
                    console.log('üîÑ [SESSION] Sesi√≥n encontrada, restaurando...');
                    
                    // ‚úÖ CORRECCI√ìN CR√çTICA: Restaurar variables globales de autenticaci√≥n
                    isAuthenticated = true;
                    authToken = sessionData.token;
                    companyAuthToken = sessionData.token;
                    currentUser = sessionData.user;
                    selectedCompany = sessionData.company;
                    window.companyAuthToken = sessionData.token;
                    
                    console.log('‚úÖ [SESSION-RESTORE] Variables globales restauradas:', {
                        isAuthenticated,
                        authToken: authToken?.substring(0, 20) + '...',
                        currentUser: currentUser?.username,
                        selectedCompany: selectedCompany?.name
                    });
                    
                    loadUserDashboard(sessionData.user, sessionData.company);
                    return true;
                }
            } catch (error) {
                console.error('‚ùå [SESSION] Error al restaurar sesi√≥n:', error);
                localStorage.removeItem('aponnt_session');
                sessionStorage.removeItem('aponnt_session');
            }
        }
        return false;
    }
    
    async function autoLoginWithSavedData(loginData) {
        try {
            // Cargar empresas primero para tener selectedCompany
            await loadCompanyList();
            selectedCompany = availableCompanies.find(c => c.slug === loginData.companySlug) || availableCompanies[0];
            
            // AUTO-LOGIN DESACTIVADO PERMANENTEMENTE
            console.log('üîê [AUTO-LOGIN] Desactivado, usar login manual');
            throw new Error('Auto-login desactivado');
            
            if (response.ok) {
                const result = await response.json();
                
                if (result.token && result.user) {
                    companyAuthToken = result.token;
                    currentUser = result.user;
                    currentUser.selectedCompany = selectedCompany;
                    isAuthenticated = true;
                    
                    console.log('‚úÖ [COMPANY-LOGIN] Auto-login exitoso para', selectedCompany?.name);
                    showMainSystem();
                    return;
                }
            }
            
            // Si falla el auto-login, mostrar pantalla normal sin error
            console.log('üìã [COMPANY-LOGIN] Auto-login fall√≥, mostrando pantalla de login');
            localStorage.removeItem('companyLoginData');
            localStorage.removeItem('rememberCompanyLogin');
            
        } catch (error) {
            console.log('üìã [COMPANY-LOGIN] Auto-login fall√≥, mostrando pantalla de login');
            localStorage.removeItem('companyLoginData');
            localStorage.removeItem('rememberCompanyLogin');
        }
        
        // Mostrar pantalla de login normal
        await loadCompanyList();
    }

    // ==========================================
    // FUNCI√ìN PARA CARGAR M√ìDULOS CONTRATADOS
    // ==========================================
    async function loadContractedModules() {
        console.log('üì¶ [MODULES] === INICIO FUNCI√ìN - USANDO DATOS REALES ===');

        try {
            const modulesContainer = document.getElementById('modulesContainer');
            if (!modulesContainer) {
                console.error('‚ùå [MODULES] No se encontr√≥ contenedor modulesContainer');
                return;
            }

            // Verificar que tenemos datos de empresa
            if (!selectedCompany || !selectedCompany.id) {
                console.error('‚ùå [MODULES] No hay empresa seleccionada');
                modulesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">‚ùå No hay empresa seleccionada</div>';
                return;
            }

            console.log('üì¶ [MODULES] Empresa seleccionada:', selectedCompany.id, selectedCompany.name);

            // Buscar datos de m√≥dulos en la empresa - usar la API correcta de m√≥dulos contratados
            console.log('üì¶ [MODULES] Obteniendo m√≥dulos contratados de empresa...');

            try {
                const companyResponse = await fetch(`/api/v1/company-modules/${selectedCompany.id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!companyResponse.ok) {
                    throw new Error(`Error ${companyResponse.status}: ${companyResponse.statusText}`);
                }

                const companyData = await companyResponse.json();
                console.log('üì¶ [MODULES] Respuesta de API m√≥dulos:', companyData);

                // Crear mapa de iconos desde definici√≥n local (l√≠nea 4130)
                // M√ìDULOS UNIFICADOS - Sincronizado con Registry Maestro y PostgreSQL
                const localModules = [
                    // CORE (5)
                    { id: 'users', name: 'Usuarios', icon: 'üë•' },
                    { id: 'departments', name: 'Departamentos', icon: 'üè¢' },
                    { id: 'attendance', name: 'Asistencia', icon: 'üìã' },
                    { id: 'dashboard', name: 'Dashboard', icon: 'üìä' },
                    { id: 'settings', name: 'Configuraci√≥n', icon: '‚öôÔ∏è' },

                    // HARDWARE (1)
                    { id: 'kiosks', name: 'Kioscos', icon: 'üìü' },

                    // SECURITY (7)
                    { id: 'visitors', name: 'Visitantes', icon: 'üë•' },
                    { id: 'facial-biometric', name: 'Biometr√≠a Anal√≠tica', icon: 'üé≠' },
                    { id: 'biometric', name: 'Control Biom√©trico', icon: 'üîê' },
                    { id: 'real-biometric-enterprise', name: 'Biometr√≠a Enterprise', icon: 'üîê' },
                    { id: 'professional-biometric-registration', name: 'Registro Biom√©trico Profesional', icon: 'üîê' },
                    { id: 'access-control', name: 'Control de Acceso', icon: 'üîê' },

                    // COMPLIANCE (4)
                    { id: 'biometric-consent', name: 'Consentimientos Biom√©tricos', icon: 'üìã' },
                    { id: 'legal-dashboard', name: 'Legal', icon: '‚öñÔ∏è' },
                    { id: 'legal', name: 'Gesti√≥n Legal', icon: '‚öñÔ∏è' },
                    { id: 'compliance-dashboard', name: 'Compliance Legal', icon: '‚öñÔ∏è' },

                    // SCHEDULING (1)
                    { id: 'shifts', name: 'Turnos', icon: 'üïê' },

                    // COMMUNICATION (1)
                    { id: 'notifications-enterprise', name: 'Notificaciones Enterprise V3.0', icon: 'üîî' },

                    // MEDICAL (2)
                    { id: 'medical-dashboard', name: 'M√©dico', icon: 'üë©‚Äç‚öïÔ∏è' },
                    { id: 'art-management', name: 'ART', icon: 'üè•' },

                    // RRHH (8)
                    { id: 'medical', name: 'Gesti√≥n M√©dica', icon: '‚öïÔ∏è' },
                    { id: 'training-management', name: 'Gesti√≥n Capacitaciones', icon: 'üìö' },
                    { id: 'job-postings', name: 'Avisos de Empleo', icon: 'üíº' },
                    { id: 'vacation-management', name: 'Gesti√≥n de Vacaciones', icon: 'üèñÔ∏è' },
                    { id: 'vacation', name: 'Vacaciones', icon: 'üèñÔ∏è' },
                    { id: 'sanctions-management', name: 'Gesti√≥n de Sanciones', icon: '‚öñÔ∏è' },
                    { id: 'psychological-assessment', name: 'Evaluaci√≥n Psicol√≥gica', icon: 'üß†' },
                    { id: 'document-management', name: 'Documentos', icon: 'üìÑ' },

                    // MONITORING (1)
                    { id: 'sla-tracking', name: 'SLA Tracking', icon: '‚è±Ô∏è' },

                    // SUPPORT (1)
                    { id: 'resource-center', name: 'Centro Recursos', icon: 'üìä' },

                    // REPORTS (1)
                    { id: 'audit-reports', name: 'Reportes Auditor√≠a', icon: 'üìÑ' },

                    // LEGAL (1)
                    { id: 'terms-conditions', name: 'T√©rminos y Condiciones', icon: 'üìú' },

                    // ANALYTICS (1)
                    { id: 'employee-map', name: 'Mapa Empleados', icon: 'üó∫Ô∏è' },

                    // PAYROLL (1)
                    { id: 'payroll-liquidation', name: 'Liquidaci√≥n Sueldos', icon: 'üí∞' },

                    // ADMIN (1)
                    { id: 'licensing-management', name: 'Licencias', icon: 'üìú' },

                    // AI (1)
                    { id: 'emotional-analysis', name: 'An√°lisis Emocional', icon: 'üòä' },

                    // SYSTEM (1)
                    { id: 'network', name: 'Red y Conectividad', icon: 'üåê' },

                    // INTEGRATION (1)
                    { id: 'google-maps-integration', name: 'Integraci√≥n Google Maps', icon: 'üó∫Ô∏è' },

                    // SIAC (3)
                    { id: 'clientes', name: 'Clientes SIAC', icon: 'üë•' },
                    { id: 'facturacion', name: 'Facturaci√≥n SIAC', icon: 'üíµ' },
                    { id: 'plantillas-fiscales', name: 'Plantillas Fiscales', icon: 'üìã' },

                    // TESTING (1)
                    { id: 'permissions-test', name: 'Test de Permisos', icon: 'üß™' }
                ];

                const iconMap = {};
                localModules.forEach(mod => {
                    iconMap[mod.id] = mod.icon;
                });

                // Extraer m√≥dulos del formato correcto de la API
                let modules = [];
                if (companyData.success && companyData.modules && Array.isArray(companyData.modules)) {
                    modules = companyData.modules;
                } else if (companyData.modules && Array.isArray(companyData.modules)) {
                    modules = companyData.modules;
                }

                console.log('üì¶ [MODULES] M√≥dulos contratados encontrados:', modules.length, 'm√≥dulos');

                if (modules.length === 0) {
                    console.warn('‚ö†Ô∏è [MODULES] No se encontraron m√≥dulos contratados');
                    modulesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: orange;">‚ö†Ô∏è No hay m√≥dulos contratados</div>';
                    return;
                }

                console.log('üì¶ [MODULES] M√≥dulos procesados:', modules.length);

                // Crear HTML con m√≥dulos - ESTILO BLANCO CON BORDE GRIS DEL BACKUP
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 20px;">';

                modules.forEach(module => {
                    // Buscar icono en el mapa local usando moduleKey o name como fallback
                    const moduleId = module.moduleKey || module.id || module.name?.toLowerCase().replace(/\s+/g, '-');
                    const moduleIcon = iconMap[moduleId] || module.icon || 'üì¶';
                    const moduleName = module.name || 'M√≥dulo';
                    const moduleDescription = module.description || 'Sin descripci√≥n';

                    html += `
                        <div onclick="showTab('${module.id}', this)" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; background: white; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                            <div style="font-size: 24px; margin-bottom: 10px;">${moduleIcon}</div>
                            <div style="font-weight: bold; margin-bottom: 5px;">${moduleName}</div>
                            <div style="font-size: 12px; color: #666;">${moduleDescription}</div>
                        </div>
                    `;
                });

                html += '</div>';

                modulesContainer.innerHTML = html;

                console.log(`‚úÖ [MODULES] ${modules.length} m√≥dulos de empresa ${selectedCompany.name} mostrados exitosamente`);

            } catch (apiError) {
                console.error('‚ùå [MODULES] Error obteniendo datos de empresa:', apiError);
                modulesContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <div style="font-size: 32px; margin-bottom: 15px;">‚ùå</div>
                        <div style="font-size: 16px; font-weight: bold;">Error obteniendo datos de empresa</div>
                        <div style="font-size: 12px; margin-top: 5px;">${apiError.message}</div>
                    </div>
                `;
            }

        } catch (error) {
            console.error('‚ùå [MODULES] Error cargando m√≥dulos:', error);
            modulesContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #dc3545;">
                    <div style="font-size: 32px; margin-bottom: 15px;">‚ùå</div>
                    <div style="font-size: 16px; font-weight: bold;">Error cargando m√≥dulos</div>
                    <div style="font-size: 12px; margin-top: 5px;">${error.message}</div>
                </div>
            `;
        }
    }

    // Funci√≥n auxiliar para ajustar brillo del color
    function adjustBrightness(hex, percent) {
        const num = parseInt(hex.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
            (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
            (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }

    // Funci√≥n auxiliar para convertir hex a rgba
    function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    // Funci√≥n para mostrar mensaje de m√≥dulo bloqueado
    function showModuleBlocked(moduleName) {
        alert(`üö´ M√≥dulo: ${moduleName}\n‚ùå Estado: NO CONTRATADO\n\nüìù Este m√≥dulo no est√° incluido en su plan actual.\nüí° Contacte al administrador para contratar este m√≥dulo.`);
    }

    function showMainSystem() {
        // Ocultar modal de login
        const modal = document.getElementById('companyLoginModal');
        const container = document.getElementById('mainSystemContainer');
        
        if (modal && container) {
            modal.style.display = 'none';
            container.style.display = 'block';
            
            // Actualizar informaci√≥n de empresa en el header
            const companyDisplay = document.getElementById('companyNameDisplay');
            if (companyDisplay && selectedCompany) {
                companyDisplay.textContent = selectedCompany?.name;
            }
        }
        
        // Continuar con la carga del sistema
        loadCoreInterface();
    }
    
    function logoutCompany() {
        // Limpiar datos de sesi√≥n
        companyAuthToken = null;
        currentUser = null;
        isAuthenticated = false;
        selectedCompany = null;
        
        // Limpiar localStorage si no se marc√≥ "recordar"
        const rememberMe = localStorage.getItem('rememberCompanyLogin') === 'true';
        if (!rememberMe) {
            localStorage.removeItem('companyLoginData');
        }
        localStorage.removeItem('rememberCompanyLogin');
        
        // Mostrar modal de login
        const modal = document.getElementById('companyLoginModal');
        const container = document.getElementById('mainSystemContainer');
        
        if (modal && container) {
            modal.style.display = 'block';
            container.style.display = 'none';
            
            // Reset form
            document.getElementById('userEmail').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('rememberMe').checked = false;
            document.getElementById('companySelect').value = '';
            hideLoginForm();
        }
        
        // Recargar empresas
        loadCompanyList();
    }
    
    function updateCompanyLoginStatus(message, type = 'info') {
        const status = document.getElementById('companyLoginStatus');
        if (status) {
            status.textContent = message;
            status.className = `login-status ${type}`;
        }
        console.log(`üè¢ [COMPANY-LOGIN] ${message}`);
    }

    // ü§ñ N√öCLEO AUTO-CONFIGURACI√ìN INTELIGENTE v6.3
    async function loadServerInfo() {
        console.log('üöÄ [DIRECT-CONFIG] Cargando interfaz directamente');
        updateLoadingStatus(`üéØ Conectando directamente a localhost:${window.DYNAMIC_CONFIG.port}...`);

        // Configurar directamente puerto din√°mico sin auto-detecci√≥n
        savedNetworkConfig.serverHost = 'localhost';
        savedNetworkConfig.serverPort = window.DYNAMIC_CONFIG.port;
        savedNetworkConfig.lastConnectedEndpoint = window.DYNAMIC_CONFIG.baseUrl;
        
        // Guardar configuraci√≥n
        localStorage.setItem('networkConfig', JSON.stringify(savedNetworkConfig));
        
        console.log('‚úÖ [DIRECT-CONFIG] Configuraci√≥n directa establecida');
        updateLoadingStatus(`‚úÖ Conectado a localhost:${window.DYNAMIC_CONFIG.port}`);
        updateServerStatus(true, 'Conectado directo');
        
        // Inicializar sistema de login empresarial en lugar de cargar interfaz directamente
        await initializeCompanyLogin();
    }
    
    // Intento inteligente de conexi√≥n con m√∫ltiples endpoints
    async function attemptSmartConnection() {
        const endpoints = generateSmartEndpoints();
        
        for (let endpoint of endpoints) {
            smartConfig.attemptCount++;
            console.log(`üéØ [SMART-CONFIG] Intento ${smartConfig.attemptCount}/${smartConfig.maxAttempts}: ${endpoint.url}`);
            updateLoadingStatus(`üîç Detectando servidor ${smartConfig.attemptCount}/${smartConfig.maxAttempts}...`);
            
            try {
                const result = await testServerEndpoint(endpoint);
                if (result.success) {
                    smartConfig.autoDetected = true;
                    smartConfig.serverInfo = result.data;
                    smartConfig.environment = endpoint.environment;
                    
                    // Actualizar configuraci√≥n guardada
                    savedNetworkConfig.serverHost = endpoint.host;
                    savedNetworkConfig.serverPort = endpoint.port;
                    
                    updateServerStatus(true, `${endpoint.environment}: ${endpoint.host}:${endpoint.port}`);
                    isServerConnected = true;
                    
                    console.log('üéâ [SMART-CONFIG] Servidor detectado:', result.data);
                    return true;
                }
            } catch (error) {
                console.log(`‚ùå [SMART-CONFIG] Fallo ${endpoint.url}:`, error.message);
            }
            
            if (smartConfig.attemptCount >= smartConfig.maxAttempts) {
                break;
            }
        }
        
        return false;
    }
    
    // Generar endpoints inteligentes basados en el contexto
    function generateSmartEndpoints() {
        const currentHost = window.location.hostname || 'localhost';
        const currentPort = window.location.port || '9999';
        const currentProtocol = window.location.protocol;

        // Detectar si estamos en producci√≥n (Railway, Heroku, Vercel, Render, etc.)
        const isProduction = !window.location.port ||
                            currentHost.includes('railway.app') ||
                            currentHost.includes('herokuapp.com') ||
                            currentHost.includes('vercel.app') ||
                            currentHost.includes('onrender.com');

        let endpoints = [];

        if (isProduction) {
            // üöÇ PRODUCCI√ìN: Sin puertos (Railway maneja proxy autom√°tico)
            console.log('üöÇ [SMART-CONFIG] Modo PRODUCCI√ìN detectado - sin puertos');
            endpoints = [
                // URL de producci√≥n correcta (sin puerto)
                { url: `${currentProtocol}//${currentHost}/api/v1/health`, host: currentHost, port: '', environment: 'production', priority: 1 }
            ];
        } else {
            // üíª LOCAL: Con puertos
            console.log('üíª [SMART-CONFIG] Modo LOCAL detectado - con puertos');
            endpoints = [
                // Endpoint actual (m√°s probable)
                { url: `http://${currentHost}:${currentPort}/api/v1/health`, host: currentHost, port: currentPort, environment: 'actual', priority: 1 },

                // Localhost est√°ndar
                { url: `${window.DYNAMIC_CONFIG.baseUrl}/api/v1/health`, host: 'localhost', port: window.DYNAMIC_CONFIG.port, environment: 'local', priority: 2 },
                { url: 'http://127.0.0.1:9997/api/v1/health', host: '127.0.0.1', port: '9999', environment: 'local', priority: 2 },

                // Red local com√∫n
                { url: 'http://192.168.1.100:9997/api/v1/health', host: '192.168.1.100', port: '9999', environment: 'local', priority: 3 },
                { url: 'http://192.168.0.100:9997/api/v1/health', host: '192.168.0.100', port: '9999', environment: 'local', priority: 3 },

                // Puertos alternativos
                { url: `http://${currentHost}:3000/api/v1/health`, host: currentHost, port: '3000', environment: 'actual-alt', priority: 4 },
                { url: `http://${currentHost}:8080/api/v1/health`, host: currentHost, port: '8080', environment: 'actual-alt', priority: 4 }
            ];
        }

        // Ordenar por prioridad
        return endpoints.sort((a, b) => a.priority - b.priority);
    }
    
    // Probar endpoint espec√≠fico
    async function testServerEndpoint(endpoint) {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000); // 3s timeout
            
            console.log('üîß [API] Probando endpoint:', endpoint.url);
            const response = await fetch(endpoint.url, {
                method: 'GET',
                signal: controller.signal,
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            clearTimeout(timeoutId);
            
            if (response.ok) {
                const data = await response.json();
                
                // Validar que es nuestro servidor
                if (data.status === 'OK' || data.message === 'Servidor funcionando') {
                    return { success: true, data: data };
                }
            }
            
            return { success: false, error: `HTTP ${response.status}` };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }
    
    // Mostrar opciones de configuraci√≥n manual
    function showManualConfigOptions() {
        const content = document.getElementById('mainContent');
        if (content) {
            content.innerHTML = `
                <div class="manual-config" style="padding: 40px; text-align: center; max-width: 600px; margin: 0 auto;">
                    <h2>üîß Configuraci√≥n Manual Requerida</h2>
                    <p style="margin-bottom: 30px; color: #666;">No se pudo detectar autom√°ticamente el servidor. Configure manualmente:</p>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Servidor:</label>
                            <input type="text" id="manualHost" value="${savedNetworkConfig.serverHost}" 
                                   style="width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Puerto:</label>
                            <input type="text" id="manualPort" value="${savedNetworkConfig.serverPort}" 
                                   style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <button onclick="testManualConfig()" 
                                style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                            üîó Probar Conexi√≥n
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>‚ö° Configuraci√≥n R√°pida:</h3>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="quickConfig('localhost', '9999')" style="padding: 8px 15px; border: 1px solid #007bff; background: white; color: #007bff; border-radius: 5px; cursor: pointer;">Local :9997</button>
                            <button onclick="quickConfig('192.168.1.100', '9999')" style="padding: 8px 15px; border: 1px solid #007bff; background: white; color: #007bff; border-radius: 5px; cursor: pointer;">Red .1.100</button>
                            <button onclick="quickConfig('192.168.0.100', '9999')" style="padding: 8px 15px; border: 1px solid #007bff; background: white; color: #007bff; border-radius: 5px; cursor: pointer;">Red .0.100</button>
                        </div>
                    </div>
                    
                    <div id="manualTestResult" style="margin-top: 20px; min-height: 30px;"></div>
                </div>
            `;
        }
    }

    // Update server status indicator
    function updateServerStatus(connected, text) {
        const indicator = document.getElementById('serverStatusIndicator');
        const statusText = document.getElementById('serverStatusText');
        
        if (indicator) {
            indicator.textContent = connected ? 'üü¢' : 'üî¥';
        }
        if (statusText) {
            statusText.textContent = text;
        }
        
        // Update top-right corner status
        const topStatus = document.getElementById('topConnectionStatus');
        const topText = document.getElementById('topConnectionText');
        
        if (topStatus) {
            topStatus.style.background = connected ? '#4CAF50' : '#f44336';
        }
        if (topText) {
            topText.textContent = connected ? 'Conectado' : 'Desconectado';
        }
    }

    // Load core interface
    async function loadCoreInterface() {
        console.log('üèóÔ∏è [PROGRESSIVE] Cargando interfaz principal...');
        updateLoadingStatus('üèóÔ∏è Cargando interfaz...');
        
        // Marcar core como cargado inmediatamente
        loadedModules.add('core');
        updateLoadingStatus('‚úÖ Interfaz cargada y lista');
        
        // Cargar m√≥dulos contratados de la empresa inmediatamente
        console.log('üöÄ [PROGRESSIVE] Iniciando carga de m√≥dulos...');
        loadContractedModules().catch(error => {
            console.error('‚ùå [PROGRESSIVE] Error cargando m√≥dulos:', error);
        });

        // Intentar auto-login para las funciones que requieren autenticaci√≥n (sin await)
        attemptAutoLogin().catch(error => {
            console.error('‚ùå [PROGRESSIVE] Error en auto-login:', error);
        });

        // Cargar dashboard por defecto
        showTab('dashboard', document.querySelector('.tab[onclick*="dashboard"]'));
        
        console.log('‚úÖ [PROGRESSIVE] Interfaz principal cargada');
    }
    
    // Auto-login para pruebas (ahora usa token empresarial)
    async function attemptAutoLogin() {
        try {
            // Si ya tenemos token empresarial, usarlo
            if (companyAuthToken) {
                authToken = companyAuthToken;
                isAuthenticated = true;
                updateLoadingStatus('‚úÖ Autenticado con token empresarial');
                
                // Mostrar indicador de autenticaci√≥n
                setTimeout(() => {
                    const versionDisplay = document.getElementById('versionDisplay');
                    if (versionDisplay && currentUser) {
                        versionDisplay.innerHTML = `üöÄ VERSI√ìN 6.7 - ‚úÖ ${selectedCompany?.name} - ${currentUser.username} üöÄ`;
                        versionDisplay.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                    }
                }, 2000);
                return;
            }
            
            // Si no hay token empresarial, no hacer login autom√°tico
            updateLoadingStatus('‚ö†Ô∏è Requiere autenticaci√≥n empresarial');
            
        } catch (error) {
            console.error('‚ùå [AUTH] Error en auto-login:', error);
            updateLoadingStatus('‚ö†Ô∏è Sin autenticaci√≥n');
        }
    }

    // Load module content dynamically
    async function loadModuleContent(tabName) {
        if (loadedModules.has(tabName)) {
            console.log(`üìã [PROGRESSIVE] M√≥dulo ${tabName} ya cargado`);
            
            // Debug espec√≠fico para notifications cuando ya est√° cargado
            if (tabName === 'notifications') {
                console.log('üì± [DEBUG] Notifications ya cargado, verificando funci√≥n...');
                console.log('üì± [DEBUG] window.showNotificationsContent:', typeof window.showNotificationsContent);
                console.log('üì± [DEBUG] loadedModules:', Array.from(loadedModules));
            }
            return;
        }
        
        console.log(`üì¶ [PROGRESSIVE] Cargando m√≥dulo: ${tabName}`);
        updateLoadingStatus(`üì¶ Cargando ${tabName}...`);
        
        return new Promise((resolve, reject) => {
            try {
                console.log(`üì¶ [PROGRESSIVE] Creando script para: ${tabName}`);
                
                // Load module-specific JavaScript
                const script = document.createElement('script');
                const cacheBuster = Date.now(); // Force cache refresh
                // Usar versi√≥n completa para notifications
                if (tabName === 'notifications') {
                    script.src = `js/modules/${tabName}-complete.js?v=${cacheBuster}`;
                    console.log(`üì¶ [PROGRESSIVE] Usando versi√≥n COMPLETA para notifications`);
                } else if (tabName === 'kiosks') {
                    script.src = `js/modules/kiosks-professional.js?v=${cacheBuster}`;
                    console.log(`üì¶ [PROGRESSIVE] Usando versi√≥n PROFESSIONAL para kiosks`);
                } else if (tabName === 'notifications-enterprise') {
                    script.src = `js/modules/notifications-enterprise.js?v=${cacheBuster}`;
                    console.log(`üì¶ [PROGRESSIVE] Cargando NOTIFICATIONS ENTERPRISE V3.0`);
                } else {
                    script.src = `js/modules/${tabName}.js?v=${cacheBuster}`;
                }
                
                console.log(`üì¶ [PROGRESSIVE] Script creado con src: ${script.src}`);
                console.log(`üì¶ [PROGRESSIVE] URL completa ser√°: ${window.location.origin}/${script.src}`);
                
                script.onload = () => {
                    console.log(`‚úÖ [PROGRESSIVE] M√≥dulo ${tabName} cargado`);

                    // FORCE HIDE ALL MODALS GLOBALLY (Render cache workaround)
                    setTimeout(() => {
                        document.querySelectorAll('.modal').forEach(modal => {
                            if (modal && modal.style.display !== 'none') {
                                modal.style.setProperty('display', 'none', 'important');
                                console.log('üîíüîíüîí [GLOBAL-FORCE-HIDE] Modal ocultado:', modal.id);
                            }
                        });
                    }, 200);
                    
                    // Debug espec√≠fico para notifications
                    if (tabName === 'notifications') {
                        console.log('üì± [DEBUG] === VERIFICATION SCRIPT ONLOAD ===');
                        console.log('üì± [DEBUG] Script onload ejecutado para notifications');
                        console.log('üì± [DEBUG] window.showNotificationsContent inmediato:', typeof window.showNotificationsContent);
                        console.log('üì± [DEBUG] showNotificationsContent global inmediato:', typeof showNotificationsContent);
                        
                        // Multiple delays to check function availability
                        setTimeout(() => {
                            console.log('üì± [DEBUG] window.showNotificationsContent despu√©s de 10ms:', typeof window.showNotificationsContent);
                            console.log('üì± [DEBUG] showNotificationsContent global despu√©s de 10ms:', typeof showNotificationsContent);
                        }, 10);
                        
                        setTimeout(() => {
                            console.log('üì± [DEBUG] window.showNotificationsContent despu√©s de 50ms:', typeof window.showNotificationsContent);
                            console.log('üì± [DEBUG] showNotificationsContent global despu√©s de 50ms:', typeof showNotificationsContent);
                        }, 50);
                        
                        setTimeout(() => {
                            console.log('üì± [DEBUG] window.showNotificationsContent despu√©s de 100ms:', typeof window.showNotificationsContent);
                            console.log('üì± [DEBUG] showNotificationsContent global despu√©s de 100ms:', typeof showNotificationsContent);
                        }, 100);
                    }
                    
                    loadedModules.add(tabName);
                    updateLoadingStatus(`‚úÖ ${tabName} listo`);
                    resolve();
                };
                script.onerror = (error) => {
                    console.error(`‚ùå [PROGRESSIVE] ERROR cargando m√≥dulo ${tabName}:`, error);
                    console.error(`‚ùå [PROGRESSIVE] Script URL era: ${script.src}`);
                    console.error(`‚ùå [PROGRESSIVE] Error completo:`, error);
                    loadFallbackContent(tabName);
                    // NO agregar a loadedModules si fall√≥!
                    // loadedModules.add(tabName);
                    resolve(); // Still resolve, just with fallback
                };
                
                console.log(`üì¶ [PROGRESSIVE] Agregando script al DOM para: ${tabName}`);
                document.head.appendChild(script);
                console.log(`‚úÖ [PROGRESSIVE] Script agregado al DOM, esperando carga...`);
                
            } catch (error) {
                console.error(`‚ùå [PROGRESSIVE] Error cargando ${tabName}:`, error);
                loadFallbackContent(tabName);
                loadedModules.add(tabName);
                resolve(); // Still resolve, just with fallback
            }
        });
    }

    // Load remaining modules progressively
    async function loadRemainingModules() {
        const modules = ['users', 'departments', 'kiosks', 'visitors', 'shifts', 'attendance', 'settings',
            'medical-config', 'medical-dashboard', 'fehaciente-consent',
            'terms-conditions', 'absence-notifications', 'document-management',
            'facial-biometric', 'employee-map', 'training-management','job-postings',
            'legal-dashboard', 'art-management', 'payroll-liquidation', 'emotional-analysis'
        ];
        
        for (const module of modules) {
            await new Promise(resolve => setTimeout(resolve, 200)); // Small delay
            await loadModuleContent(module);
        }
        
        updateLoadingStatus('üéâ Todas las funciones cargadas');
        setTimeout(() => {
            const status = document.getElementById('loadingStatus');
            if (status) status.style.display = 'none';
        }, 2000);
    }

    // Fallback content for modules that don't have separate files
    function loadFallbackContent(tabName) {
        console.log(`üîÑ [PROGRESSIVE] Usando contenido fallback para ${tabName}`);
        
        // Server configuration tab
        if (tabName === 'server-config') {
            showServerConfigContent();
            return;
        }
        
        // This will be populated with the original content
    }
    
    // Show server configuration content
    function showServerConfigContent() {
        const content = document.getElementById('mainContent');
        if (content) {
            const currentHost = smartConfig.autoDetected ? savedNetworkConfig.serverHost : 'localhost';
            const currentPort = smartConfig.autoDetected ? savedNetworkConfig.serverPort : '9999';
            const connectionStatus = isServerConnected ? 'Conectado' : 'Desconectado';
            const statusColor = isServerConnected ? '#4CAF50' : '#f44336';
            
            content.innerHTML = `
                <div class="server-config-content" style="padding: 20px; max-width: 800px; margin: 0 auto;">
                    <h2>üîß Configuraci√≥n del Servidor</h2>
                    
                    <div style="background: linear-gradient(135deg, #F8FAFF 0%, #E6F3FF 100%); border: 1px solid #C7E0FF; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #0066CC;">üìä Estado Actual</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                            <div>
                                <strong>Estado:</strong> <span style="color: ${statusColor};">${connectionStatus}</span>
                            </div>
                            <div>
                                <strong>Servidor:</strong> ${currentHost}:${currentPort}
                            </div>
                            <div>
                                <strong>Detecci√≥n:</strong> ${smartConfig.autoDetected ? 'Autom√°tica (' + smartConfig.environment + ')' : 'Manual'}
                            </div>
                            <div>
                                <strong>Versi√≥n:</strong> v6.3 Smart Config
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFF 100%); border: 1px solid #E0E7FF; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,102,204,0.08);">
                        <h3 style="color: #0066CC; margin-bottom: 20px;">üîÑ Cambiar Configuraci√≥n</h3>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #0066CC;">Servidor (IP o dominio):</label>
                            <input type="text" id="configHost" value="${currentHost}" 
                                   style="width: 300px; padding: 12px; border: 2px solid #E0E7FF; border-radius: 6px; font-size: 16px; background: #FAFBFF; transition: border-color 0.3s;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #0066CC;">Puerto:</label>
                            <input type="text" id="configPort" value="${currentPort}" 
                                   style="width: 120px; padding: 12px; border: 2px solid #E0E7FF; border-radius: 6px; font-size: 16px; background: #FAFBFF; transition: border-color 0.3s;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <button onclick="testAndSaveConfig()" 
                                    style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-right: 15px; box-shadow: 0 2px 8px rgba(16,185,129,0.3); font-weight: 500;">
                                üîó Probar y Guardar
                            </button>
                            <button onclick="resetAutoConfig()" 
                                    style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); color: white; padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; box-shadow: 0 2px 8px rgba(245,158,11,0.3); font-weight: 500;">
                                üîÑ Auto-Detectar Nuevamente
                            </button>
                        </div>
                        <div id="configTestResult" style="margin-top: 15px; padding: 10px; border-radius: 5px; min-height: 20px;"></div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border: 1px solid #B3E5FC; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(14,165,233,0.1);">
                        <h3 style="color: #0284C7; margin-bottom: 10px;">‚ö° Configuraciones R√°pidas</h3>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                            <button onclick="setQuickConfig('localhost', '9999')" style="padding: 10px 16px; border: 2px solid #0066CC; background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFF 100%); color: #0066CC; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,102,204,0.1);">üè† Local :9997</button>
                            <button onclick="setQuickConfig('127.0.0.1', '9999')" style="padding: 10px 16px; border: 2px solid #0066CC; background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFF 100%); color: #0066CC; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,102,204,0.1);">üè† 127.0.0.1</button>
                            <button onclick="setQuickConfig('192.168.1.100', '9999')" style="padding: 10px 16px; border: 2px solid #0066CC; background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFF 100%); color: #0066CC; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,102,204,0.1);">üåê Red .1.100</button>
                            <button onclick="setQuickConfig('192.168.0.100', '9999')" style="padding: 10px 16px; border: 2px solid #0066CC; background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFF 100%); color: #0066CC; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,102,204,0.1);">üåê Red .0.100</button>
                            <button onclick="setQuickConfig('localhost', '3000')" style="padding: 10px 16px; border: 2px solid #0066CC; background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFF 100%); color: #0066CC; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,102,204,0.1);">üîÄ Local :3000</button>
                            <button onclick="setQuickConfig('localhost', '8080')" style="padding: 10px 16px; border: 2px solid #0066CC; background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFF 100%); color: #0066CC; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,102,204,0.1);">üîÄ Local :8080</button>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    // Tab switching function
    function showTab(tabName, tabElement) {
        console.log(`üîÑ [PROGRESSIVE] Cambiando a tab: ${tabName}`);
        console.log(`üîÑ [PROGRESSIVE] loadedModules actual:`, Array.from(loadedModules));
        console.log(`üîÑ [PROGRESSIVE] ¬ø${tabName} est√° en loadedModules?:`, loadedModules.has(tabName));

        // company-management removido - bypass eliminado
        // ‚úÖ VALIDACI√ìN DE PERMISOS ANTES DE CARGAR M√ìDULO
        // DASHBOARD Y SETTINGS SIEMPRE PERMITIDOS DESPU√âS DE LOGIN EXITOSO
        if (tabName === 'dashboard' || tabName === 'settings') {
            console.log(`üéâ [BYPASS] Acceso autom√°tico para m√≥dulo esencial: ${tabName}`);
            // Continuar sin validaci√≥n - dashboard siempre se muestra
            continueTabLoading(tabName, tabElement);
        }
        else if (typeof validatePageAccess === 'function' && isAuthenticated && currentUser) {
            console.log(`üõ°Ô∏è [ACCESS-CONTROL] Validando acceso a m√≥dulo: ${tabName}`);

            // Hacer la validaci√≥n as√≠ncrona sin bloquear
            validatePageAccess(tabName)
                .then(() => {
                    console.log(`‚úÖ [ACCESS-CONTROL] Acceso autorizado para m√≥dulo: ${tabName}`);
                    continueTabLoading(tabName, tabElement);
                })
                .catch((accessError) => {
                    console.warn(`üö´ [ACCESS-CONTROL] Acceso denegado para m√≥dulo: ${tabName}`, accessError);

                    // Mostrar p√°gina de acceso denegado usando el sistema existente
                    if (typeof showAccessDeniedPage === 'function') {
                        showAccessDeniedPage(accessError.error, accessError.message);
                    } else {
                        // Fallback si no existe la funci√≥n
                        const content = document.getElementById('mainContent');
                        if (content) {
                            content.innerHTML = `
                                <div class="card" style="max-width: 600px; margin: 100px auto; text-align: center;">
                                    <div style="padding: 40px;">
                                        <div style="font-size: 64px; margin-bottom: 20px;">üö´</div>
                                        <h2 style="color: #dc3545; margin-bottom: 15px;">Acceso Denegado</h2>
                                        <p style="color: #6c757d; font-size: 16px; line-height: 1.5; margin-bottom: 20px;">
                                            ${accessError.message || 'No tiene permisos para acceder a este m√≥dulo.'}
                                        </p>
                                        <button onclick="showTab('dashboard', document.querySelector('.tab[onclick*=\"dashboard\"]'))"
                                                style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                            ‚Üê Volver al Dashboard
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    }
                });
            return; // Salir y esperar resultado de la promesa
        } else {
            // Sin autenticaci√≥n o sin funci√≥n de validaci√≥n, continuar normalmente
            continueTabLoading(tabName, tabElement);
        }
    }

    // Funci√≥n auxiliar para continuar la carga del tab despu√©s de validaci√≥n
    async function continueTabLoading(tabName, tabElement) {
        // Update active tab
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        if (tabElement) tabElement.classList.add('active');

        // IMPORTANTE: Hacer visible el mainContent
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
            mainContent.style.display = 'block';
            console.log('‚úÖ [PROGRESSIVE] mainContent ahora visible');
        }

        currentTab = tabName;

        // Load module if not loaded and wait for it to complete
        if (!loadedModules.has(tabName)) {
            console.log(`üì¶ [PROGRESSIVE] ${tabName} NO est√° cargado, llamando loadModuleContent...`);
            showDefaultContent(tabName); // Show loading immediately
            await loadModuleContent(tabName);
        } else {
            console.log(`‚ö†Ô∏è [PROGRESSIVE] ${tabName} YA est√° marcado como cargado, NO llamando loadModuleContent`);
        }
        
        // Small delay to ensure function is available
        setTimeout(() => {
            // Show content (will be implemented by modules)
            // Convert kebab-case to camelCase properly
            const camelCaseName = tabName.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase());

            // Special case for notifications
            let functionName;
            if (tabName === 'notifications') {
                functionName = 'showNotificationsContent';
            } else {
                functionName = `show${camelCaseName.charAt(0).toUpperCase() + camelCaseName.slice(1)}Content`;
            }
            
            console.log(`üîç [PROGRESSIVE] Buscando funci√≥n: ${functionName} para tab: ${tabName}`);
            
            
            // Debug espec√≠fico para notifications
            if (tabName === 'notifications') {
                console.log('üì± [DEBUG] === DEBUGGING NOTIFICATIONS ===');
                console.log('üì± [DEBUG] tabName:', tabName);
                console.log('üì± [DEBUG] functionName calculado:', functionName);
                console.log('üì± [DEBUG] loadedModules tiene notifications:', loadedModules.has('notifications'));
                console.log('üì± [DEBUG] window.showNotificationsContent:', typeof window.showNotificationsContent);
                console.log('üì± [DEBUG] showNotificationsContent global:', typeof showNotificationsContent);
                console.log('üì± [DEBUG] window[functionName]:', typeof window[functionName]);
                console.log('üì± [DEBUG] Todas las funciones window que contienen "notification":', 
                    Object.keys(window).filter(key => key.toLowerCase().includes('notification')));
                console.log('üì± [DEBUG] mainContent elemento:', document.getElementById('mainContent'));
                
                // Intentar ejecutar directamente
                if (typeof window.showNotificationsContent === 'function') {
                    console.log('‚úÖ [DEBUG] Ejecutando window.showNotificationsContent() directamente');
                    try {
                        window.showNotificationsContent();
                        console.log('‚úÖ [DEBUG] Funci√≥n ejecutada exitosamente');
                        return;
                    } catch (error) {
                        console.error('‚ùå [DEBUG] Error ejecutando funci√≥n:', error);
                    }
                } else if (typeof showNotificationsContent === 'function') {
                    console.log('‚úÖ [DEBUG] Ejecutando showNotificationsContent() global directamente');
                    try {
                        showNotificationsContent();
                        console.log('‚úÖ [DEBUG] Funci√≥n global ejecutada exitosamente');
                        return;
                    } catch (error) {
                        console.error('‚ùå [DEBUG] Error ejecutando funci√≥n global:', error);
                    }
                } else {
                    console.log('‚ùå [DEBUG] NO SE ENCONTR√ì LA FUNCI√ìN showNotificationsContent');
                    console.log('üì± [DEBUG] Intentando cargar m√≥dulo nuevamente...');
                }
            }
            
            // Debug espec√≠fico para company-management
            if (tabName === 'company-management') {
                console.log('üè¢ [DEBUG] === DEBUGGING COMPANY-MANAGEMENT ===');
                console.log('üè¢ [DEBUG] tabName:', tabName);
                console.log('üè¢ [DEBUG] Empresa actual:', selectedCompany);
                console.log('üè¢ [DEBUG] Usuario actual:', currentUser);
                
                // Crear contenedor espec√≠fico para gesti√≥n de empresas
                const content = document.getElementById('mainContent');
                if (content) {
                    content.innerHTML = '<div id="company-management-content" style="padding: 20px;"></div>';
                    
                    // MOSTRAR DASHBOARD DE EMPRESA INMEDIATAMENTE
                    console.log('üöÄ [FORCE-FIX] Mostrando dashboard de empresa...');
                    
                    const container = document.getElementById('company-management-content');
                    if (container) {
                        container.innerHTML = `
                            <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                                <div style="text-align: center; margin-bottom: 30px;">
                                    <h1 style="color: #2c3e50; margin-bottom: 10px;">üéâ ¬°Bienvenido al Dashboard!</h1>
                                    <h2 style="color: #8E24AA; margin-bottom: 5px;">üè¢ ${selectedCompany?.name || 'Empresa'}</h2>
                                    <p style="color: #666; font-size: 16px;">Administrador: <strong>${currentUser?.firstName} ${currentUser?.lastName}</strong></p>
                                </div>
                                
                                <div style="background: linear-gradient(135deg, #8E24AA 0%, #6A1B9A 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                                    <h3 style="margin: 0 0 10px 0;">üìä Estado de M√≥dulos Contratados</h3>
                                    <p style="margin: 0; opacity: 0.9;">‚úÖ Todos tus m√≥dulos est√°n activos y funcionando correctamente</p>
                                    <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.8;">Total de m√≥dulos activos: ${selectedCompany?.modules?.length || 0}</p>
                                </div>
                                
                                <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                                    <p style="margin: 0; color: #666; font-size: 14px;">
                                        üí° <strong>Consejo:</strong> Usa el men√∫ lateral para navegar entre los diferentes m√≥dulos de tu sistema.
                                    </p>
                                </div>
                            </div>
                        `;
                        console.log('‚úÖ [COMPANY-MANAGEMENT] Dashboard empresarial mostrado correctamente');
                    }
                    return;
                    
                    // Superadmin force load functionality removed (contained hardcoded credentials)
                }
            }
            
            // USAR EL SISTEMA showModuleContent QUE S√ç FUNCIONA
            console.log(`üéØ [FIX] Llamando directamente a showModuleContent('${tabName}', '${tabName}')`);
            if (typeof showModuleContent === 'function') {
                showModuleContent(tabName, tabName);
            } else {
                console.log(`‚ùå [FIX] showModuleContent no disponible, intentando funci√≥n espec√≠fica...`);
                if (window[functionName]) {
                    console.log(`‚úÖ [PROGRESSIVE] Ejecutando funci√≥n: ${functionName}`);
                    window[functionName]();
                } else {
                    console.log(`‚ö†Ô∏è [PROGRESSIVE] Funci√≥n ${functionName} no encontrada, usando contenido por defecto`);
                    showDefaultContent(tabName);
                }
            }
        }, 100);

        // Scroll autom√°tico al inicio del contenido del m√≥dulo
        setTimeout(() => {
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 200);
    }

    // Default content display
    function showDefaultContent(tabName) {
        const content = document.getElementById('mainContent');
        if (content) {
            content.innerHTML = `
                <div class="tab-content" style="padding: 20px; text-align: center;">
                    <h2>üìã ${tabName.toUpperCase()}</h2>
                    <p>üîÑ Cargando funcionalidades de ${tabName}...</p>
                    <div style="margin-top: 20px;">
                        <div class="loading-spinner" style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    </div>
                </div>
                <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                </style>
            `;
        }
    }

    // Detecci√≥n de cambios de red y manejo de errores
    function setupNetworkDetection() {
        // Detectar cambios de conexi√≥n
        window.addEventListener('online', handleNetworkChange);
        window.addEventListener('offline', handleNetworkOffline);
        
        // Monitoreo peri√≥dico de conexi√≥n
        setInterval(checkConnectionHealth, 10000); // Cada 10 segundos
        
        // FORCE PUERTO 9997 - Interceptar y corregir URLs
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            // Corregir cualquier URL que use puerto 9999
            if (args[0] && typeof args[0] === 'string') {
                args[0] = args[0].replace(/:9999|:9997|:9993|:3000/g, `:${window.DYNAMIC_CONFIG.port}`);
            }
            try {
                const response = await originalFetch.apply(this, args);
                if (response.ok) {
                    onConnectionSuccess();
                }
                return response;
            } catch (error) {
                console.log('üåê [NETWORK] Fetch error detectado:', error.message);
                if (error.message.includes('fetch') || error.name === 'TypeError') {
                    handleFetchError(error);
                }
                throw error;
            }
        };
        
        console.log('üåê [NETWORK] Sistema de detecci√≥n de red activado');
    }

    function handleNetworkChange() {
        console.log('üåê [NETWORK] Cambio de red detectado - ONLINE');
        networkChangeCount++;
        updateVersionDisplay();
        
        // Esperar un poco antes de reconectar
        setTimeout(() => {
            reconnectionAttempts = 0;
            attemptReconnection();
        }, 1000);
    }

    function handleNetworkOffline() {
        console.log('üåê [NETWORK] Red desconectada');
        updateServerStatus(false, 'Sin conexi√≥n a internet');
        isServerConnected = false;
    }

    function handleFetchError(error) {
        console.log('üåê [NETWORK] Error de fetch manejado:', error.message);
        
        if (isServerConnected) {
            networkChangeCount++;
            updateVersionDisplay();
            isServerConnected = false;
            updateServerStatus(false, 'Conexi√≥n perdida - Reintentando...');
            
            // Intentar reconectar autom√°ticamente
            setTimeout(() => {
                attemptReconnection();
            }, 2000);
        }
    }

    async function attemptReconnection() {
        if (reconnectionAttempts >= maxReconnectionAttempts) {
            updateServerStatus(false, 'Conexi√≥n perdida - Configurar manualmente');
            return;
        }

        reconnectionAttempts++;
        console.log(`üîÑ [NETWORK] Intento de reconexi√≥n ${reconnectionAttempts}/${maxReconnectionAttempts}`);
        
        updateServerStatus(false, `Reconectando... (${reconnectionAttempts}/${maxReconnectionAttempts})`);

        // Usar funci√≥n que ya existe y est√° definida
        let success = false;
        if (typeof attemptSmartConnection === 'function') {
            success = await attemptSmartConnection();
        } else {
            // Fallback: probar endpoint simple
            try {
                const endpoint = {
                    url: getApiUrl('/api/v1/health'),
                    host: savedNetworkConfig.serverHost,
                    port: savedNetworkConfig.serverPort,
                    environment: 'reconnection'
                };
                const result = await testServerEndpoint(endpoint);
                success = result.success;
                if (success) {
                    smartConfig.autoDetected = true;
                    smartConfig.serverInfo = result.data;
                    updateServerStatus(true, `Reconectado: ${savedNetworkConfig.serverHost}:${savedNetworkConfig.serverPort}`);
                }
            } catch (error) {
                success = false;
            }
        }
        
        if (success) {
            console.log('‚úÖ [NETWORK] Reconexi√≥n exitosa');
            reconnectionAttempts = 0;
            networkChangeCount++;
            updateVersionDisplay();
            onConnectionSuccess();
        } else {
            setTimeout(() => attemptReconnection(), 3000 * reconnectionAttempts);
        }
    }

    function onConnectionSuccess() {
        lastConnectionTime = Date.now();
        if (!isServerConnected) {
            isServerConnected = true;
            reconnectionAttempts = 0;
            console.log('‚úÖ [NETWORK] Conexi√≥n restablecida');
        }
    }

    async function checkConnectionHealth() {
        // Solo hacer check si creemos que estamos conectados
        if (isServerConnected && Date.now() - lastConnectionTime > 30000) {
            try {
                const endpoint = {
                    url: getApiUrl('/api/v1/health'),
                    host: savedNetworkConfig.serverHost,
                    port: savedNetworkConfig.serverPort,
                    environment: 'health-check'
                };
                
                const result = await testServerEndpoint(endpoint);
                if (result.success) {
                    onConnectionSuccess();
                } else {
                    throw new Error('Health check failed');
                }
            } catch (error) {
                console.log('üè• [HEALTH] Check fall√≥:', error.message);
                handleFetchError(error);
            }
        }
    }

    function updateVersionDisplay() {
        const versionElement = document.getElementById('versionDisplay');
        if (versionElement) {
            const baseVersion = '6.7';
            const sessionChanges = networkChangeCount;
            let versionText;
            
            if (sessionChanges === 0) {
                versionText = `Versi√≥n ${baseVersion} - Detecci√≥n Red Mejorada`;
            } else {
                versionText = `Versi√≥n ${baseVersion}.${sessionChanges} - Red Adaptada`;
            }
            
            versionElement.textContent = versionText;
            
            // Efecto visual temporal
            versionElement.style.background = 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
            setTimeout(() => {
                versionElement.style.background = 'linear-gradient(135deg, #0066CC 0%, #004499 100%)';
            }, 2000);
        }
    }

    // ‚úÖ INICIALIZACI√ìN DE DATOS DEL SISTEMA DE PERMISOS
    function initializePermissionsData() {
        console.log('üõ°Ô∏è [PERMISSIONS] Inicializando datos del sistema de permisos...');
        
        // Configurar variables globales para el sistema de control de acceso
        window.systemModules = {
            'users': {
                name: 'Gesti√≥n de Usuarios',
                functions: [
                    { id: 'view', name: 'Ver usuarios' },
                    { id: 'create', name: 'Crear usuarios' },
                    { id: 'edit', name: 'Editar usuarios' },
                    { id: 'delete', name: 'Eliminar usuarios' }
                ]
            },
            'departments': {
                name: 'Departamentos',
                functions: [
                    { id: 'view', name: 'Ver departamentos' },
                    { id: 'create', name: 'Crear departamentos' },
                    { id: 'edit', name: 'Editar departamentos' }
                ]
            },
            'shifts': {
                name: 'Turnos',
                functions: [
                    { id: 'view', name: 'Ver turnos' },
                    { id: 'create', name: 'Crear turnos' },
                    { id: 'edit', name: 'Editar turnos' }
                ]
            },
            'attendance': {
                name: 'Asistencia',
                functions: [
                    { id: 'view', name: 'Ver asistencia' },
                    { id: 'reports', name: 'Generar reportes' }
                ]
            }
        };
        
        window.defaultRoles = {
            'admin': {
                name: 'Administrador',
                color: '#dc3545',
                modules: ['users', 'departments', 'shifts', 'attendance'],
                permissions: 'all' // Acceso total
            },
            'supervisor': {
                name: 'Supervisor',
                color: '#ffc107',
                modules: ['users', 'attendance'],
                permissions: {
                    'users': ['view'],
                    'attendance': ['view', 'reports']
                }
            },
            'employee': {
                name: 'Empleado',
                color: '#28a745',
                modules: ['attendance'],
                permissions: {
                    'attendance': ['view']
                }
            }
        };
        
        // Configurar datos del usuario actual para permisos
        if (currentUser) {
            window.permissionUsers = [currentUser];
            // USAR LOS DATOS REALES DE LA EMPRESA CON M√ìDULOS CARGADOS
            const realCompany = window.currentCompany || selectedCompany;
            window.currentCompany = realCompany;

            // Usar m√≥dulos reales contratados por la empresa
            const realContractedModules = realCompany?.contractedModules || realCompany?.modules || [];
            window.companyLicenses = realContractedModules;

            console.log('üîë [PERMISSIONS] Configurando empresa real:', {
                companyName: realCompany?.name,
                contractedModules: realContractedModules,
                userId: currentUser.id,
                userRole: currentUser.role
            });
            
            console.log('‚úÖ [PERMISSIONS] Datos inicializados:', {
                systemModules: Object.keys(window.systemModules),
                defaultRoles: Object.keys(window.defaultRoles),
                currentUserRole: currentUser.role,
                companyLicenses: window.companyLicenses
            });
        } else {
            console.warn('‚ö†Ô∏è [PERMISSIONS] currentUser no disponible, inicializaci√≥n parcial');
        }
    }

    // Function to load main dashboard after authentication
    function loadMainDashboard() {
        console.log('üöÄ [DASHBOARD] Cargando dashboard principal...');

        // LIMPIAR COMPLETAMENTE todos los elementos de login superpuestos
        const modal = document.getElementById('companyLoginModal');
        const allDropdowns = document.querySelectorAll('select[id*="company"], select[id*="Company"]');
        const allForms = document.querySelectorAll('[id*="forceLogin"], [id*="login"]');
        const forceTitles = document.querySelectorAll('h3');

        // Ocultar modal principal COMPLETAMENTE
        if (modal) {
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
            modal.style.opacity = '0';
            modal.style.zIndex = '-1';
            console.log('üö® [DASHBOARD] Modal ocultado completamente');
        } else {
            console.warn('‚ö†Ô∏è [DASHBOARD] Modal companyLoginModal no encontrado');
        }

        // Eliminar solo los dropdowns superpuestos, NO el principal
        allDropdowns.forEach(dropdown => {
            if (dropdown.id !== 'companySelect') {
                dropdown.remove();
                console.log('üö® [DASHBOARD] Dropdown superpuesto eliminado:', dropdown.id);
            } else {
                // Solo ocultar el principal, no eliminarlo
                dropdown.style.display = 'none';
                console.log('üö® [DASHBOARD] Dropdown principal ocultado');
            }
        });

        // Eliminar todos los formularios superpuestos
        allForms.forEach(form => {
            if (form.id && form.id.includes('force')) {
                form.remove();
                console.log('üö® [DASHBOARD] Formulario eliminado:', form.id);
            }
        });

        // Ocultar t√≠tulos de fuerza
        forceTitles.forEach(title => {
            if (title.textContent && title.textContent.includes('Seleccionar Empresa')) {
                title.style.display = 'none';
            }
        });

        // Mostrar contenido principal
        const mainContent = document.getElementById('mainContent');
        const moduleGrid = document.querySelector('.module-grid');
        const bodyElement = document.body;

        console.log('üîç [DASHBOARD] Buscando elementos del dashboard...');
        console.log('üîç [DASHBOARD] mainContent encontrado:', !!mainContent);
        console.log('üîç [DASHBOARD] module-grid encontrado:', !!moduleGrid);

        if (mainContent) {
            mainContent.style.display = 'block';
            mainContent.style.visibility = 'visible';
            mainContent.style.opacity = '1';
            mainContent.style.zIndex = '1000';
            console.log('‚úÖ [DASHBOARD] mainContent hecho visible');
        } else {
            console.error('‚ùå [DASHBOARD] mainContent NO ENCONTRADO');
        }

        if (moduleGrid) {
            moduleGrid.style.display = 'grid';
            moduleGrid.style.visibility = 'visible';
            moduleGrid.style.opacity = '1';
            console.log('‚úÖ [DASHBOARD] module-grid hecho visible');
        } else {
            console.error('‚ùå [DASHBOARD] module-grid NO ENCONTRADO');
        }

        // Asegurar que body no tenga overflow hidden
        if (bodyElement) {
            bodyElement.style.overflow = 'auto';
            console.log('‚úÖ [DASHBOARD] Body overflow configurado');
        }

        // FORZAR ELIMINACI√ìN COMPLETA DE OVERLAYS Y MODALES
        const allOverlays = document.querySelectorAll('.modal-overlay, .overlay, [class*="modal"], [class*="backdrop"]');
        allOverlays.forEach(overlay => {
            overlay.remove();
            console.log('üßπ [DASHBOARD] Overlay removido:', overlay.className);
        });

        // Remover atributos de modal del body
        bodyElement.classList.remove('modal-open');
        bodyElement.style.paddingRight = '';

        console.log('üßπ [DASHBOARD] Limpieza completa de overlays y modales finalizada');

        // Establecer token para las llamadas API
        if (selectedCompany?.id) {
            window.companyAuthToken = localStorage.getItem('companyAuthToken');
            console.log('üîë [DASHBOARD] Token configurado para empresa:', selectedCompany.name);

            // Inicializar sistema de m√≥dulos despu√©s de un delay
            setTimeout(() => {
                console.log('üîÑ [DASHBOARD] Iniciando carga de m√≥dulos...');
                console.log('üîç [DASHBOARD] selectedCompany:', selectedCompany);
                console.log('üîç [DASHBOARD] showDashboardContent disponible:', typeof showDashboardContent);

                // Triggear la carga de los m√≥dulos
                window.currentTab = 'dashboard';
                if (typeof showDashboardContent === 'function') {
                    console.log('üöÄ [DASHBOARD] Ejecutando showDashboardContent...');
                    showDashboardContent();
                } else {
                    console.error('‚ùå [DASHBOARD] showDashboardContent no es una funci√≥n');
                    console.log('üîç [DASHBOARD] Buscando funciones alternativas...');

                    // Intentar cargar los m√≥dulos directamente
                    if (typeof loadModuleGrid === 'function') {
                        console.log('üöÄ [DASHBOARD] Ejecutando loadModuleGrid...');
                        loadModuleGrid();
                    } else {
                        console.log('üí° [DASHBOARD] Cargando m√≥dulos manualmente...');
                        // Forzar carga manual de m√≥dulos
                        loadModulesManually();
                    }
                }
            }, 1000);
        }

        console.log('‚úÖ [DASHBOARD] Dashboard principal cargado exitosamente');
    }

    // Funci√≥n manual para cargar m√≥dulos si las principales fallan
    function loadModulesManually() {
        console.log('üîß [MANUAL] Iniciando carga manual de m√≥dulos...');

        const mainContent = document.getElementById('mainContent');
        if (!mainContent) {
            console.error('‚ùå [MANUAL] No se encontr√≥ mainContent');
            return;
        }

        // Crear contenido b√°sico del dashboard con los m√≥dulos
        const dashboardHTML = `
            <div class="tab-content active" id="dashboard">
                <div class="company-header">
                    <h2>üè¢ Dashboard - ${selectedCompany?.name || 'Empresa'}</h2>
                    <p>M√≥dulos disponibles para tu empresa</p>
                </div>

                <div class="loading-message" style="text-align: center; padding: 40px;">
                    <h3>üöÄ Sistema Biom√©trico Cargado</h3>
                    <p>‚úÖ ${selectedCompany?.name || 'Empresa'} tiene acceso a los m√≥dulos contratados</p>
                    <p>üìä Utilice el men√∫ lateral para navegar entre los m√≥dulos disponibles</p>
                </div>
            </div>
        `;

        mainContent.innerHTML = dashboardHTML;
        mainContent.style.display = 'block';
        mainContent.style.visibility = 'visible';
        mainContent.style.opacity = '1';

        console.log('‚úÖ [MANUAL] Dashboard manual creado exitosamente');
    }

    // Initialize on page load
    window.onload = function() {
        console.log('üöÄ [PROGRESSIVE] Window onload ejecutado');

        // ‚úÖ BYPASS COMPLETO - OMITIR TODO LOGIN
        console.log('üö´ [BYPASS-TOTAL] Omitiendo login completamente - acceso directo ISI');

        // Configurar variables globales directamente
        window.selectedCompany = {id: 11, name: 'ISI', slug: 'isi'};
        window.companyAuthToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjA1OTNmOTcxLTg0NjEtNGU2Ny04MGExLTFmZGRkMTg5MzJmNCIsImVtYWlsIjoiYWRtaW5AdGVzdC1jb21wYW55LmNvbSIsImNvbXBhbnlfaWQiOjQsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc1ODgxMTk1OSwiZXhwIjoxNzU4ODk4MzU5fQ.4wskIaStFAas4kVF4L6Mn3z_SXNZKfLbi97L1bem2Hc';
        window.isAuthenticated = true;
        window.authToken = window.companyAuthToken;

        // Ocultar cualquier modal o form de login
        const loginModal = document.querySelector('.company-login-modal');
        const loginForm = document.getElementById('loginForm');
        if (loginModal) loginModal.style.display = 'none';
        if (loginForm) loginForm.style.display = 'none';

        // Mostrar contenido principal directo
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
            mainContent.style.display = 'block';
            mainContent.style.visibility = 'visible';
            mainContent.style.opacity = '1';
        }

        // Cargar dashboard directamente
        setTimeout(() => {
            console.log('üöÄ [BYPASS-TOTAL] Cargando dashboard directamente');
            loadCoreInterface();
        }, 500);

        // Inicializar objeto progressiveAdmin para los m√≥dulos
        window.progressiveAdmin = {
            getApiUrl: function(endpoint) {
                const protocol = window.location.protocol;

                // Detectar si estamos en producci√≥n
                const isProduction = !window.location.port ||
                                    window.location.hostname.includes('railway.app') ||
                                    window.location.hostname.includes('herokuapp.com') ||
                                    window.location.hostname.includes('vercel.app') ||
                                    window.location.hostname.includes('onrender.com');

                if (isProduction) {
                    // PRODUCCI√ìN: usar URL sin puerto
                    const baseUrl = `${protocol}//${window.location.hostname}`;
                    return `${baseUrl}${endpoint}`;
                }

                // LOCAL: Usar la configuraci√≥n guardada si existe
                if (savedNetworkConfig.serverHost && savedNetworkConfig.serverPort) {
                    const baseUrl = `${protocol}//${savedNetworkConfig.serverHost}:${savedNetworkConfig.serverPort}`;
                    return `${baseUrl}${endpoint}`;
                }

                // Si no hay configuraci√≥n, usar el puerto actual de la p√°gina
                const currentPort = window.location.port || '9999';
                const currentHost = window.location.hostname || 'localhost';
                const baseUrl = `${protocol}//${currentHost}:${currentPort}`;
                return `${baseUrl}${endpoint}`;
            },
            getServerConfig: function() {
                return savedNetworkConfig;
            },
            getAuthToken: function() {
                // First try to get from window global
                if (window.companyAuthToken) {
                    return window.companyAuthToken;
                }
                
                // Try to get from session storage
                const sessionData = localStorage.getItem('aponnt_session') || sessionStorage.getItem('aponnt_session');
                if (sessionData && sessionData !== 'undefined') {
                    try {
                        const session = JSON.parse(sessionData);
                        if (session.token) {
                            window.companyAuthToken = session.token;
                            return session.token;
                        }
                    } catch (e) {
                        console.error('Error parsing session data:', e);
                    }
                }
                
                return null;
            },
            getCurrentUser: function() {
                const sessionData = localStorage.getItem('aponnt_session') || sessionStorage.getItem('aponnt_session');
                if (sessionData && sessionData !== 'undefined') {
                    try {
                        const session = JSON.parse(sessionData);
                        return session.user || null;
                    } catch (e) {
                        console.error('Error parsing session data:', e);
                    }
                }
                return null;
            },
            isAuthenticated: function() {
                return this.getAuthToken() !== null;
            }
        };
        
        // Tambi√©n agregar getApiUrl global para compatibilidad
        window.getApiUrl = window.progressiveAdmin.getApiUrl;
        
        console.log('‚úÖ [PROGRESSIVE] Objeto progressiveAdmin inicializado');
        setupNetworkDetection();
        loadServerInfo();
        
        // Verificar sesi√≥n guardada al inicializar
        setTimeout(() => {
            console.log('üîç [INIT] Verificando sesi√≥n guardada...');

            // Verificar si ya est√° autenticado
            const authToken = localStorage.getItem('companyAuthToken');
            const isAuthenticated = localStorage.getItem('isAuthenticated');
            const savedCompany = localStorage.getItem('selectedCompany');

            // AUTENTICACI√ìN FORZADA - SIEMPRE PEDIR LOGIN
            console.log('üîê [INIT] Forzando login - limpiando localStorage...');

            // Limpiar localStorage para forzar nuevo login
            localStorage.removeItem('companyAuthToken');
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('token');

            // NO restaurar sesi√≥n autom√°ticamente - siempre mostrar login
            if (false) { // Desactivado completamente
                console.log('‚úÖ [INIT] Usuario ya autenticado, cargando dashboard...');
            }

            console.log('üîê [INIT] No hay sesi√≥n v√°lida, mostrando login...');

            // Si no hay sesi√≥n, mostrar selecci√≥n normal
            loadCompanyList();
            console.log('üìã [INIT] Mostrando selecci√≥n de empresa');

            // Asegurar que se muestre el modal de login de empresa
            setTimeout(() => {
                const modal = document.getElementById('companyLoginModal');
                if (modal) {
                    modal.style.display = 'flex';
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.justifyContent = 'center';
                    modal.style.alignItems = 'center';
                    modal.style.zIndex = '9999';
                    console.log('üîê [INIT] Modal de login mostrado y centrado');

                    // üåç TRADUCIR MODAL DESPU√âS DE MOSTRARLO
                    setTimeout(() => {
                        if (window.translator) {
                            console.log('üåç [TRANSLATION] Traduciendo modal de login...');
                            window.translator.updateInterface();
                        }
                    }, 200);
                }
            }, 100);
            
        }, 500); // Dar tiempo a que carguen los m√≥dulos
    };

    // Funciones de configuraci√≥n manual
    async function testManualConfig() {
        const host = document.getElementById('manualHost').value;
        const port = document.getElementById('manualPort').value;
        const resultDiv = document.getElementById('manualTestResult');
        
        if (!host || !port) {
            resultDiv.innerHTML = '<div style="color: red;">‚ùå Complete servidor y puerto</div>';
            return;
        }
        
        resultDiv.innerHTML = '<div style="color: #FFA500;">üîÑ Probando conexi√≥n...</div>';
        
        try {
            const endpoint = {
                url: `http://${host}:${port}/api/v1/health`,
                host: host,
                port: port,
                environment: 'manual'
            };
            
            const result = await testServerEndpoint(endpoint);
            
            if (result.success) {
                // Guardar configuraci√≥n exitosa
                savedNetworkConfig.serverHost = host;
                savedNetworkConfig.serverPort = port;
                smartConfig.autoDetected = true;
                smartConfig.serverInfo = result.data;
                isServerConnected = true;
                
                updateServerStatus(true, `Manual: ${host}:${port}`);
                resultDiv.innerHTML = '<div style="color: green;">‚úÖ Conexi√≥n exitosa</div>';
                
                setTimeout(async () => {
                    updateLoadingStatus('‚úÖ Configuraci√≥n manual exitosa');
                    await loadCoreInterface();
                }, 1000);
            } else {
                resultDiv.innerHTML = `<div style="color: red;">‚ùå Error: ${result.error}</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div style="color: red;">‚ùå Error: ${error.message}</div>`;
        }
    }
    
    // Configuraci√≥n r√°pida
    async function quickConfig(host, port) {
        document.getElementById('manualHost').value = host;
        document.getElementById('manualPort').value = port;
        await testManualConfig();
    }
    
    // Enhanced getApiUrl with smart configuration
    function getApiUrl(endpoint = '') {
        const host = smartConfig.autoDetected ? 
                    savedNetworkConfig.serverHost : 
                    (document.getElementById('serverHost')?.value || savedNetworkConfig.serverHost);
        const port = smartConfig.autoDetected ? 
                    savedNetworkConfig.serverPort : 
                    (document.getElementById('serverPort')?.value || savedNetworkConfig.serverPort);
        return `http://${host}:${port}${endpoint}`;
    }
    
    // Enhanced getSelectedHost with smart configuration
    function getSelectedHost() {
        return smartConfig.autoDetected ? 
               savedNetworkConfig.serverHost : 
               (document.getElementById('serverHost')?.value || savedNetworkConfig.serverHost);
    }
    
    // Add smart configuration status to update
    function updateLoadingStatus(message) {
        const status = document.getElementById('loadingStatus');
        if (status) {
            status.textContent = message;
            status.className = 'loading-indicator feature-loading';
            
            // Add environment info if available
            if (smartConfig.autoDetected && smartConfig.environment) {
                status.textContent += ` [${smartConfig.environment}]`;
            }
        }
        console.log(`üîÑ [SMART-CONFIG] ${message}`);
    }

    // Server configuration functions
    async function testAndSaveConfig() {
        const host = document.getElementById('configHost').value.trim();
        const port = document.getElementById('configPort').value.trim();
        const resultDiv = document.getElementById('configTestResult');
        
        if (!host || !port) {
            resultDiv.innerHTML = '<div style="background: #ffebee; color: #c62828; padding: 10px; border-radius: 5px;">‚ùå Complete servidor y puerto</div>';
            return;
        }
        
        resultDiv.innerHTML = '<div style="background: #fff3e0; color: #ef6c00; padding: 10px; border-radius: 5px;">üîÑ Probando nueva configuraci√≥n...</div>';
        
        try {
            const endpoint = {
                url: `http://${host}:${port}/api/v1/health`,
                host: host,
                port: port,
                environment: 'config'
            };
            
            const result = await testServerEndpoint(endpoint);
            
            if (result.success) {
                // Guardar nueva configuraci√≥n
                savedNetworkConfig.serverHost = host;
                savedNetworkConfig.serverPort = port;
                smartConfig.autoDetected = true;
                smartConfig.serverInfo = result.data;
                smartConfig.environment = 'config';
                isServerConnected = true;
                
                updateServerStatus(true, `Config: ${host}:${port}`);
                resultDiv.innerHTML = '<div style="background: #e8f5e8; color: #2e7d2e; padding: 10px; border-radius: 5px;">‚úÖ Configuraci√≥n guardada exitosamente</div>';
                
                // Refresh the configuration display
                setTimeout(() => {
                    showServerConfigContent();
                }, 1500);
                
            } else {
                resultDiv.innerHTML = `<div style="background: #ffebee; color: #c62828; padding: 10px; border-radius: 5px;">‚ùå Error: ${result.error}</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div style="background: #ffebee; color: #c62828; padding: 10px; border-radius: 5px;">‚ùå Error: ${error.message}</div>`;
        }
    }
    
    // Quick configuration setter
    function setQuickConfig(host, port) {
        document.getElementById('configHost').value = host;
        document.getElementById('configPort').value = port;
    }
    
    // Reset and try auto-configuration again
    async function resetAutoConfig() {
        const resultDiv = document.getElementById('configTestResult');
        resultDiv.innerHTML = '<div style="background: #fff3e0; color: #ef6c00; padding: 10px; border-radius: 5px;">üîÑ Ejecutando auto-detecci√≥n...</div>';
        
        // Reset configuration
        smartConfig.autoDetected = false;
        smartConfig.attemptCount = 0;
        isServerConnected = false;
        updateServerStatus(false, 'Auto-detectando...');
        
        const success = await attemptSmartConnection();
        
        if (success) {
            resultDiv.innerHTML = '<div style="background: #e8f5e8; color: #2e7d2e; padding: 10px; border-radius: 5px;">‚úÖ Auto-detecci√≥n completada</div>';
            // Refresh the configuration display
            setTimeout(() => {
                showServerConfigContent();
            }, 1500);
        } else {
            resultDiv.innerHTML = '<div style="background: #ffebee; color: #c62828; padding: 10px; border-radius: 5px;">‚ùå No se pudo auto-detectar. Configure manualmente.</div>';
        }
    }

    // üëÅÔ∏è FUNCI√ìN PARA MOSTRAR/OCULTAR CONTRASE√ëAS
    function togglePassword(inputId, button) {
        const input = document.getElementById(inputId);
        const isPassword = input.type === 'password';
        
        input.type = isPassword ? 'text' : 'password';
        button.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
        
        // Mantener el foco en el input
        input.focus();
        
        // Posicionar el cursor al final del texto
        setTimeout(() => {
            input.selectionStart = input.selectionEnd = input.value.length;
        }, 0);
    }

    // Superadmin functionality removed

    // Superadmin login functionality removed

    // Superadmin inline management module functionality removed (contained hardcoded credentials)
    
    // Superadmin module management close functionality removed
    
    // Superadmin company creation functionality removed
    
    // Superadmin system access functionality removed
    
    // Superadmin-dependent company initialization removed
    
    function closeInitCompanyModal() {
        const modal = document.getElementById('initCompanyModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('initCompanyForm').reset();
            document.getElementById('initCompanyStatus').innerHTML = '';
        }
    }
    
    function setupInitCompanySlugGeneration() {
        const nameInput = document.getElementById('initCompanyName');
        const slugInput = document.getElementById('initCompanySlug');
        
        if (nameInput && slugInput) {
            nameInput.addEventListener('input', function() {
                const slug = this.value
                    .toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .trim();
                slugInput.value = slug;
            });
        }
    }
    
    async function performCompanyInitialization(event) {
        event.preventDefault();
        
        const formData = {
            company_name: document.getElementById('initCompanyName').value.trim(),
            company_slug: document.getElementById('initCompanySlug').value.trim(),
            admin_email: document.getElementById('initAdminEmail').value.trim(),
            admin_password: document.getElementById('initAdminPassword').value.trim(),
            license_type: document.getElementById('initLicenseType').value,
            basic_modules: document.getElementById('basicModules').checked,
            hr_modules: document.getElementById('hrModules').checked,
            advanced_modules: document.getElementById('advancedModules').checked
        };
        
        const statusDiv = document.getElementById('initCompanyStatus');
        
        if (!formData.company_name || !formData.company_slug || !formData.admin_email || !formData.admin_password) {
            statusDiv.innerHTML = '<div style="background: #fee; color: #c53030; padding: 10px; border-radius: 5px;">‚ùå Complete todos los campos requeridos</div>';
            return;
        }
        
        statusDiv.innerHTML = '<div style="background: #fff3e0; color: #ef6c00; padding: 10px; border-radius: 5px;">üîÑ Inicializando empresa...</div>';
        
        try {
            // Preparar m√≥dulos seg√∫n selecci√≥n
            const selectedModules = [];
            
            if (formData.basic_modules) {
                selectedModules.push(1, 2, 3, 4, 5, 6); // Dashboard, Users, Attendance, Shifts, Branches, Reports
            }
            
            if (formData.hr_modules) {
                selectedModules.push(15, 16, 11); // Payroll, Permissions, Documents
            }
            
            if (formData.advanced_modules) {
                selectedModules.push(12, 13, 14, 17); // Facial Biometric, Location, ART, Legal
            }
            
            // Crear empresa con licencia
            const companyData = {
                company_name: formData.company_name,
                company_slug: formData.company_slug,
                contact_email: formData.admin_email,
                contact_phone: '',
                billing_address: '',
                license_type: formData.license_type,
                billing_currency: 'ARS',
                selected_modules: selectedModules
            };
            
            const apiUrl = window.getApiUrl ? window.getApiUrl('/api/v1/licensing') : '/api/v1/licensing';
            // API DESACTIVADA PERMANENTEMENTE
            console.log('üè¢ [COMPANY-API] API desactivada, operaci√≥n simulada');
            throw new Error('API desactivada');
            
        } catch (error) {
            console.error('‚ùå [INIT-COMPANY] Error:', error);
            statusDiv.innerHTML = `<div style="background: #fee; color: #c53030; padding: 10px; border-radius: 5px;">‚ùå Error: ${error.message}</div>`;
        }
    }

    // Export functions for modules to use (enhanced)
    window.progressiveAdmin = {
        getApiUrl,
        getSelectedHost,
        updateLoadingStatus,
        updateServerStatus,
        savedNetworkConfig,
        isServerConnected,
        smartConfig, // Export smart configuration
        testManualConfig,
        quickConfig,
        testAndSaveConfig,
        setQuickConfig,
        resetAutoConfig,
        showServerConfigContent
    };

    // Auto-inicializar interfaz principal si no se requiere login
    console.log('üöÄ [PROGRESSIVE] Auto-iniciando loadCoreInterface...');
    setTimeout(() => {
        loadCoreInterface();
    }, 500);

    // LOGIN REACTIVADO - Sistema funcionando normalmente
    
    </script>
    
    <!-- Inicializaci√≥n del sistema de traducciones -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üåç [TRANSLATION] Inicializando sistema de traducciones...');

        // CARGAR M√ìDULOS DE LA EMPRESA AL INICIO
        // Se cargar√°n cuando el usuario haga login y seleccione empresa

        // Verificar si TranslationSystem est√° disponible
        if (typeof TranslationSystem !== 'undefined') {
            // Inicializar el sistema de traducciones
            window.translator = new TranslationSystem();
            console.log('‚úÖ [TRANSLATION] Sistema de traducciones inicializado');

            // Inicializar selector de idioma despu√©s de un breve delay
            setTimeout(() => {
                if (typeof initializeLanguageSelector === 'function') {
                    // initializeLanguageSelector(); // DESACTIVADO
                }
                if (window.translator) {
                    window.translator.updateInterface();
                }
            }, 100);

        } else {
            console.error('‚ùå [TRANSLATION] TranslationSystem no est√° disponible');
            // Crear selector b√°sico de fallback
            if (typeof initializeLanguageSelector === 'function') {
                setTimeout(initializeLanguageSelector, 100);
            }
        }
    });

    // Funci√≥n para cargar todos los m√≥dulos del sistema globalmente
    async function loadCompanyModules(companyId) {
        console.log(`üß© [COMPANY-MODULES] Cargando m√≥dulos contratados para empresa: ${companyId}`);

        try {
            const response = await fetch(`/api/v1/company-modules/${companyId}`);
            if (response.ok) {
                const data = await response.json();
                window.companyModules = data.modules || [];
                window.allSystemModules = data.modules || []; // ‚úÖ FIX: Tambi√©n asignar a allSystemModules
                console.log(`‚úÖ [COMPANY-MODULES] ${window.companyModules.length} m√≥dulos contratados cargados para empresa ${companyId}`);
                console.log(`‚úÖ [ALL-SYSTEM-MODULES] ${window.allSystemModules.length} m√≥dulos asignados`);
                return window.companyModules;
            } else {
                throw new Error('Error en API: ' + response.status);
            }
        } catch (error) {
            console.error('‚ùå [COMPANY-MODULES] Error cargando m√≥dulos:', error);
            // Fallback b√°sico
            window.companyModules = [];
            window.allSystemModules = []; // ‚úÖ FIX: Tambi√©n limpiar allSystemModules
            return [];
        }
    }

    // Mantener funci√≥n legacy para compatibilidad
    async function loadAllSystemModules() {
        console.log('üß© [SYSTEM-MODULES] Funci√≥n legacy - usar loadCompanyModules()');

        // FIX: Agregar biometric-dashboard manualmente hasta que el API lo retorne
        window.allSystemModules = [
            {
                id: '354185da-67fb-452e-91d8-85e12a714da5',
                module_key: 'biometric-dashboard',
                name: 'Dashboard Biom√©trico',
                description: 'Centro de control biom√©trico con registro, an√°lisis emocional y consentimientos',
                icon: 'üîê',
                category: 'security',
                is_active: true
            }
        ];
        console.log('‚úÖ [FIX] biometric-dashboard agregado a allSystemModules');
    }

    // FIX: Inicializar window.allSystemModules al cargar la p√°gina
    if (!window.allSystemModules || window.allSystemModules.length === 0) {
        window.allSystemModules = [
            {
                id: '354185da-67fb-452e-91d8-85e12a714da5',
                module_key: 'biometric-dashboard',
                name: 'Dashboard Biom√©trico',
                description: 'Centro de control biom√©trico con registro, an√°lisis emocional y consentimientos',
                icon: 'üîê',
                category: 'security',
                is_active: true
            }
        ];
        console.log('‚úÖ [INIT] window.allSystemModules inicializado con biometric-dashboard');
    }

    // üè¢ FUNCIONES MULTI-TENANT PROFESIONAL
    // INICIALIZAR SISTEMA MULTI-TENANT
    async function initializeMultiTenantLogin() {
        try {
            await loadCompanies();
            setupEventListeners();

            // üåç TRADUCIR FORMULARIO DE LOGIN DESPU√âS DE CARGARLO
            setTimeout(() => {
                if (window.translator) {
                    console.log('üåç [TRANSLATION] Traduciendo formulario multi-tenant...');
                    window.translator.updateInterface();
                }
            }, 300);
        } catch (error) {
            console.error('‚ùå Error inicializando sistema:', error);
            showError('generalError', 'Error inicializando el sistema');
        }
    }

    // CARGAR EMPRESAS ACTIVAS
    async function loadCompanies() {
        try {
            console.log('üìã Cargando empresas activas...');

            const response = await fetch('/api/v1/auth/companies');
            const data = await response.json();

            const companySelect = document.getElementById('companySelect');

            if (data.success && data.companies) {
                companySelect.innerHTML = '<option value="">Selecciona una empresa</option>';

                data.companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.company_id;
                    option.textContent = company.name;
                    option.dataset.slug = company.slug;
                    companySelect.appendChild(option);
                });

                console.log(`‚úÖ Cargadas ${data.companies.length} empresas`);
            } else {
                throw new Error('No se pudieron cargar las empresas');
            }
        } catch (error) {
            console.error('‚ùå Error cargando empresas:', error);
            document.getElementById('companySelect').innerHTML = '<option value="">Error cargando empresas</option>';
        }
    }

    // CARGAR USUARIOS POR EMPRESA
    async function loadUsersByCompany(companyId) {
        try {
            console.log(`üë§ Cargando usuarios de empresa ${companyId}...`);

            const response = await fetch(`/api/v1/auth/companies/${companyId}/users`);
            const data = await response.json();

            const userSelect = document.getElementById('userSelect');

            if (data.success && data.users) {
                userSelect.innerHTML = '<option value="">Selecciona un usuario</option>';

                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.user_id;
                    const displayText = user.usuario ? `${user.firstName} ${user.lastName} (${user.usuario})` : `${user.firstName} ${user.lastName} (${user.email})`;
                    option.textContent = displayText;
                    option.dataset.usuario = user.usuario || user.email;
                    userSelect.appendChild(option);
                });

                userSelect.disabled = false;
                console.log(`‚úÖ Cargados ${data.users.length} usuarios`);
            } else {
                throw new Error('No se encontraron usuarios para esta empresa');
            }
        } catch (error) {
            console.error('‚ùå Error cargando usuarios:', error);
            const userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = '<option value="">Error cargando usuarios</option>';
            userSelect.disabled = true;
        }
    }

    // SETUP EVENT LISTENERS
    function setupEventListeners() {
        const companySelect = document.getElementById('companySelect');
        const userInput = document.getElementById('userInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginForm = document.getElementById('multiTenantLoginForm');

        // Cuando cambia la empresa, habilitar campo usuario
        companySelect.addEventListener('change', function() {
            const companyId = this.value;

            // Resetear campos dependientes
            userInput.value = '';
            userInput.disabled = !companyId;
            passwordInput.value = '';
            passwordInput.disabled = true;
            document.getElementById('loginButton').disabled = true;

            if (companyId) {
                userInput.focus();
                console.log(`‚úÖ Empresa seleccionada: ${companyId} - Campo usuario habilitado`);
            }
        });

        // Cuando cambia el usuario, habilitar contrase√±a
        userInput.addEventListener('input', function() {
            if (this.value.trim()) {
                passwordInput.disabled = false;
                // No hacer auto-focus, dejar que el usuario termine de escribir
            } else {
                passwordInput.disabled = true;
                document.getElementById('loginButton').disabled = true;
            }
            checkLoginButton();
        });

        // Cuando se ingresa contrase√±a, habilitar bot√≥n
        passwordInput.addEventListener('input', function() {
            checkLoginButton();
        });

        // Funci√≥n para verificar si habilitar bot√≥n login
        function checkLoginButton() {
            const loginButton = document.getElementById('loginButton');
            if (companySelect.value && userInput.value.trim() && passwordInput.value.trim()) {
                loginButton.disabled = false;
            } else {
                loginButton.disabled = true;
            }
        }

        // Manejar env√≠o del formulario
        loginForm.addEventListener('submit', handleLogin);
    }

    // MANEJAR LOGIN MULTI-TENANT
    async function handleLogin(event) {
        event.preventDefault();

        const companySelect = document.getElementById('companySelect');
        const companyId = companySelect.selectedOptions[0]?.dataset.companyId;
        const usuario = document.getElementById('userInput').value.trim();
        const password = document.getElementById('passwordInput').value;

        console.log('üîç [DEBUG-LOGIN] companyId:', companyId);
        console.log('üîç [DEBUG-LOGIN] usuario:', usuario);
        console.log('üîç [DEBUG-LOGIN] password:', password ? '****' : '(vac√≠o)');

        if (!companyId || !usuario || !password) {
            showError('generalError', 'Por favor completa todos los campos');
            return;
        }

        try {
            console.log('üîê Iniciando login multi-tenant...');
            document.getElementById('loginButton').disabled = true;
            document.getElementById('loginButton').textContent = '‚è≥ Ingresando...';

            const response = await fetch('/api/v1/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    identifier: usuario,
                    password: password,
                    companyId: parseInt(companyId)
                })
            });

            const data = await response.json();

            if (response.ok && data.token) {
                // Login exitoso
                authToken = data.token;
                currentUser = data.user;

                // Guardar datos COMPLETOS de empresa
                currentCompany = {
                    id: data.company?.company_id || companyId,
                    company_id: data.company?.company_id || companyId,
                    name: data.company?.name || document.getElementById('companySelect').selectedOptions[0].textContent,
                    address: data.company?.address || '',
                    phone: data.company?.phone || data.company?.contact_phone || '',
                    contact_phone: data.company?.contact_phone || data.company?.phone || '',
                    country: data.company?.country || 'Argentina',
                    legal_name: data.company?.legal_name || data.company?.name || '',
                    email: data.company?.email || ''
                };

                console.log('üîç [LOGIN DEBUG] Datos de empresa recibidos del backend:', data.company);
                console.log('üîç [LOGIN DEBUG] currentCompany construido:', currentCompany);

                // Guardar en localStorage - REACTIVADO para m√≥dulos biom√©tricos
                localStorage.setItem('authToken', data.token); // REACTIVADO - Necesario para m√≥dulos biom√©tricos
                localStorage.setItem('currentUser', JSON.stringify(data.user));
                localStorage.setItem('currentCompany', JSON.stringify(currentCompany)); // CAMBIADO: currentCompany en vez de selectedCompany
                localStorage.setItem('selectedCompany', JSON.stringify(currentCompany)); // Mantener por compatibilidad

                // Configurar variables globales para compatibilidad INMEDIATAMENTE
                window.selectedCompany = currentCompany;
                window.authToken = authToken;
                window.isAuthenticated = true;
                window.companyAuthToken = authToken; // Para compatibilidad adicional
                isAuthenticated = true;

                console.log('‚úÖ [LOGIN] Datos guardados en localStorage');
                console.log('‚úÖ Login exitoso - configurando variables globales:', {
                    selectedCompany: window.selectedCompany,
                    authToken: !!window.authToken,
                    isAuthenticated: window.isAuthenticated
                });

                // ‚úÖ CARGAR M√ìDULOS ACTIVOS DIN√ÅMICAMENTE (Sistema de Auto-Conocimiento)
                try {
                    console.log('üß† [DYNAMIC-LOAD] Cargando m√≥dulos activos para company_id:', currentCompany.company_id);
                    const modulesResponse = await fetch(`/api/modules/active?company_id=${currentCompany.company_id}&panel=empresa&role=${currentUser.role}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (modulesResponse.ok) {
                        const modulesData = await modulesResponse.json();
                        if (modulesData.success) {
                            window.activeModules = modulesData.modules;
                            window.companyModules = modulesData.modules; // Bridge v3.0.0 ‚Üí rendering
                            console.log(`‚úÖ [DYNAMIC-LOAD] Cargados ${modulesData.modules.length} m√≥dulos activos:`, modulesData.modules.map(m => m.module_key));
                            console.log('üîç [DYNAMIC-LOAD] M√≥dulos disponibles:', window.activeModules);
                        } else {
                            console.warn('‚ö†Ô∏è  [DYNAMIC-LOAD] API retorn√≥ success: false:', modulesData);
                        }
                    } else {
                        console.error('‚ùå [DYNAMIC-LOAD] Error en respuesta de API:', modulesResponse.status);
                    }
                } catch (moduleError) {
                    console.error('‚ùå [DYNAMIC-LOAD] Error cargando m√≥dulos activos:', moduleError);
                    console.warn('‚ö†Ô∏è  [DYNAMIC-LOAD] El sistema continuar√° con funcionalidad limitada');
                }

                // Actualizar banner con datos de empresa DIRECTAMENTE (sin leer de localStorage)
                console.log('üîÑ [LOGIN] Actualizando banner directamente...');
                console.log('üîÑ [LOGIN] Datos para actualizar:', currentCompany);

                // Usar setTimeout para asegurar que el DOM est√© listo
                setTimeout(() => {
                    try {
                        const nameEl = document.getElementById('companyNameDisplay');
                        const addressEl = document.getElementById('companyAddressDisplay');
                        const phoneEl = document.getElementById('companyPhoneDisplay');

                        console.log('üîç [LOGIN] Elementos encontrados:', {
                            nameEl: !!nameEl,
                            addressEl: !!addressEl,
                            phoneEl: !!phoneEl
                        });

                        if (nameEl) {
                            nameEl.textContent = currentCompany.name || 'Empresa Cliente';
                            console.log('‚úÖ [LOGIN] Nombre actualizado:', nameEl.textContent);
                        } else {
                            console.error('‚ùå [LOGIN] No se encontr√≥ companyNameDisplay');
                        }

                        if (addressEl) {
                            addressEl.textContent = currentCompany.address || 'Direcci√≥n empresa';
                            console.log('‚úÖ [LOGIN] Direcci√≥n actualizada:', addressEl.textContent);
                        } else {
                            console.error('‚ùå [LOGIN] No se encontr√≥ companyAddressDisplay');
                        }

                        if (phoneEl) {
                            phoneEl.textContent = `üìû ${currentCompany.phone || 'Tel√©fono'}`;
                            console.log('‚úÖ [LOGIN] Tel√©fono actualizado:', phoneEl.textContent);
                        } else {
                            console.error('‚ùå [LOGIN] No se encontr√≥ companyPhoneDisplay');
                        }

                        console.log('‚úÖ [LOGIN] Banner actualizaci√≥n completada');
                    } catch (error) {
                        console.error('‚ùå [LOGIN] Error actualizando banner:', error);
                    }
                }, 500); // Esperar 500ms para que el DOM est√© listo

                // Los empleados se cargar√°n autom√°ticamente cuando se abra el m√≥dulo biom√©trico
                console.log('üîÑ [LOGIN] Empleados se cargar√°n al abrir m√≥dulo de registro biom√©trico');

                console.log('‚úÖ Login exitoso - mostrando interfaz');
                showDashboard();

                // NO hacer scroll autom√°tico - dejar que el usuario seleccione el m√≥dulo
                setTimeout(() => {
                    window.scrollTo({ top: 0, behavior: 'instant' });
                }, 100);

            } else {
                throw new Error(data.error || 'Error de autenticaci√≥n');
            }

        } catch (error) {
            console.error('‚ùå Error en login:', error);
            showError('generalError', error.message);
        } finally {
            document.getElementById('loginButton').disabled = false;
            document.getElementById('loginButton').textContent = 'üöÄ Iniciar Sesi√≥n';
        }
    }

    // UTILIDAD: MOSTRAR ERRORES
    function showError(elementId, message) {
        const errorElement = document.getElementById(elementId);
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';

            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }
    }

    console.log('‚úÖ Sistema Multi-Tenant inicializado');
    </script>

    <!-- üì± Script para men√∫ m√≥vil responsive -->
    <script>
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');

            if (sidebar && overlay) {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        }

        function closeMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');

            if (sidebar && overlay) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            }
        }

        // Cerrar sidebar al hacer click en un link del men√∫ (en m√≥vil)
        document.addEventListener('DOMContentLoaded', function() {
            if (window.innerWidth <= 768) {
                const sidebarLinks = document.querySelectorAll('.sidebar a');
                sidebarLinks.forEach(link => {
                    link.addEventListener('click', closeMobileSidebar);
                });
            }
        });

        // Cerrar sidebar al cambiar de orientaci√≥n
        window.addEventListener('orientationchange', closeMobileSidebar);
    </script>

    <!-- ‚úÖ ASISTENTE IA - Ollama + Llama 3.1 (Chat Flotante con Tech Badges) -->
    <script src="js/modules/ai-assistant-chat.js"></script>

    <!-- üèÜ TECH STACK BADGES - Marketing Subliminal Profesional -->
    <!-- DESACTIVADO: No mostrar badges en login -->
    <!-- <script src="js/modules/tech-badges.js"></script> -->

    <!-- Bootstrap 5 JavaScript Bundle (incluye Popper.js para modales) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
