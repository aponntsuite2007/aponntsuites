<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aponnt - Portal de Proveedores</title>

    <!-- Bootstrap 5 (desde cdnjs para CSP) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Chart.js (desde cdnjs para CSP) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

    <!-- DARK THEME STYLES -->
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-card: #1c2128;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-purple: #a371f7;
            --accent-orange: #d29922;
            --accent-red: #f85149;
            --accent-cyan: #39c5cf;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --gradient-primary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-secondary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* LOGIN SCREEN */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            background-image:
                radial-gradient(at 40% 20%, rgba(240, 147, 251, 0.15) 0px, transparent 50%),
                radial-gradient(at 80% 0%, rgba(245, 87, 108, 0.15) 0px, transparent 50%),
                radial-gradient(at 0% 50%, rgba(57, 197, 207, 0.1) 0px, transparent 50%);
        }

        .login-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 440px;
            box-shadow: 0 8px 32px var(--shadow-color);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .login-logo p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group { margin-bottom: 20px; }

        .form-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-control-dark {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .form-control-dark:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(57, 197, 207, 0.15);
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: var(--gradient-primary);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(240, 147, 251, 0.4);
        }

        /* MAIN LAYOUT */
        .app-container { display: none; min-height: 100vh; }

        /* SIDEBAR */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .sidebar-logo-text h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-logo-text span {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 15px 0;
        }

        .nav-section-title {
            padding: 10px 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(240, 147, 251, 0.1);
            color: #f093fb;
            border-left-color: #f093fb;
        }

        .nav-item i { width: 20px; text-align: center; }

        .nav-badge {
            margin-left: auto;
            background: var(--accent-red);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* MAIN CONTENT */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* TOP BAR */
        .top-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .top-bar-left h1 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .top-bar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .notification-btn {
            position: relative;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .notification-btn:hover { color: var(--text-primary); }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-red);
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* CONTENT AREA */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* CARDS */
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .stat-card-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .stat-card-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-card-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* DATA TABLES */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 12px 15px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .data-table tr:hover {
            background: var(--bg-tertiary);
        }

        /* STATUS BADGES */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-pending { background: rgba(210, 153, 34, 0.2); color: var(--accent-orange); }
        .status-active, .status-confirmed { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .status-urgent { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        .status-completed { background: rgba(88, 166, 255, 0.2); color: var(--accent-blue); }
        .status-draft { background: rgba(139, 148, 158, 0.2); color: var(--text-secondary); }

        /* BUTTONS */
        .btn-primary-dark {
            background: var(--gradient-primary);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary-dark:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
        }

        .btn-outline-dark {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-outline-dark:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        /* MODALS */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body { padding: 20px; }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* LOADING */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* HIDDEN */
        .hidden { display: none !important; }

        /* ALERT */
        .alert-dark {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .alert-success { border-left: 3px solid var(--accent-green); }
        .alert-error { border-left: 3px solid var(--accent-red); }
        .alert-warning { border-left: 3px solid var(--accent-orange); }
        .alert-info { border-left: 3px solid var(--accent-blue); }

        /* Password toggle styles */
        .password-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            z-index: 10;
            padding: 4px;
            line-height: 1;
        }

        .password-toggle:hover {
            color: var(--accent-blue);
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <div style="font-size: 3rem; margin-bottom: 15px;">
                    <i class="fas fa-truck" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                </div>
                <h1>Portal de Proveedores</h1>
                <p>Acceda a su cuenta para gestionar sus operaciones</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Correo electr√≥nico</label>
                    <input type="email" id="loginEmail" class="form-control-dark" placeholder="proveedor@empresa.com" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" class="form-control-dark" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required style="padding-right: 40px;">
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)">üëÅÔ∏è</button>
                    </div>
                </div>

                <div id="loginError" class="alert-dark alert-error hidden" style="margin-bottom: 20px;"></div>

                <button type="submit" class="btn-login">
                    <i class="fas fa-sign-in-alt"></i>
                    Iniciar Sesi√≥n
                </button>
            </form>

            <div style="text-align: center; margin-top: 20px;">
                <a href="#" style="color: var(--accent-cyan); font-size: 0.9rem; text-decoration: none;">
                    ¬øOlvid√≥ su contrase√±a?
                </a>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appContainer" class="app-container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="sidebar-logo-text">
                        <h2>Portal Proveedor</h2>
                        <span id="supplierName">Mi Empresa</span>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section-title">Principal</div>
                <a class="nav-item active" data-section="dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>

                <div class="nav-section-title">Ventas</div>
                <a class="nav-item" data-section="rfqs">
                    <i class="fas fa-file-invoice"></i>
                    <span>Solicitudes (RFQ)</span>
                    <span class="nav-badge" id="rfqBadge">0</span>
                </a>
                <a class="nav-item" data-section="quotations">
                    <i class="fas fa-calculator"></i>
                    <span>Mis Cotizaciones</span>
                </a>
                <a class="nav-item" data-section="orders">
                    <i class="fas fa-shopping-cart"></i>
                    <span>√ìrdenes de Compra</span>
                </a>

                <div class="nav-section-title">Facturaci√≥n</div>
                <a class="nav-item" data-section="invoices">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Facturas</span>
                </a>
                <a class="nav-item" data-section="payments">
                    <i class="fas fa-money-check-alt"></i>
                    <span>Pagos</span>
                </a>

                <div class="nav-section-title">Soporte</div>
                <a class="nav-item" data-section="claims">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Reclamos</span>
                    <span class="nav-badge hidden" id="claimBadge">0</span>
                </a>

                <div class="nav-section-title">Marketing</div>
                <a class="nav-item" data-section="offers">
                    <i class="fas fa-tags"></i>
                    <span>Ofertas y Promociones</span>
                </a>

                <div class="nav-section-title">Reportes</div>
                <a class="nav-item" data-section="statistics">
                    <i class="fas fa-chart-bar"></i>
                    <span>Estad√≠sticas</span>
                </a>
            </nav>

            <div style="padding: 20px; border-top: 1px solid var(--border-color);">
                <a class="nav-item" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Cerrar Sesi√≥n</span>
                </a>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- TOP BAR -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <h1 id="pageTitle">Dashboard</h1>
                </div>
                <div class="top-bar-right">
                    <button class="notification-btn" id="notificationBtn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge">0</span>
                    </button>
                    <div class="user-menu" id="userMenu">
                        <div class="user-avatar" id="userAvatar">P</div>
                        <span id="userName">Usuario</span>
                    </div>
                </div>
            </header>

            <!-- CONTENT AREA -->
            <div class="content-area">
                <!-- DASHBOARD SECTION -->
                <section id="section-dashboard" class="content-section">
                    <div id="help-banner-dashboard"></div>
                    <div class="row g-4 mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-card-header">
                                    <div class="stat-card-icon" style="background: rgba(248, 81, 73, 0.2); color: var(--accent-red);">
                                        <i class="fas fa-file-invoice"></i>
                                    </div>
                                </div>
                                <div class="stat-card-value" id="statPendingRfqs">0</div>
                                <div class="stat-card-label">RFQs Pendientes</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-card-header">
                                    <div class="stat-card-icon" style="background: rgba(88, 166, 255, 0.2); color: var(--accent-blue);">
                                        <i class="fas fa-shopping-cart"></i>
                                    </div>
                                </div>
                                <div class="stat-card-value" id="statActiveOrders">0</div>
                                <div class="stat-card-label">√ìrdenes Activas</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-card-header">
                                    <div class="stat-card-icon" style="background: rgba(210, 153, 34, 0.2); color: var(--accent-orange);">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                </div>
                                <div class="stat-card-value" id="statPendingClaims">0</div>
                                <div class="stat-card-label">Reclamos Pendientes</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-card-header">
                                    <div class="stat-card-icon" style="background: rgba(63, 185, 80, 0.2); color: var(--accent-green);">
                                        <i class="fas fa-dollar-sign"></i>
                                    </div>
                                </div>
                                <div class="stat-card-value" id="statPendingPayments">$0</div>
                                <div class="stat-card-label">Por Cobrar</div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-8">
                            <div class="stat-card">
                                <h5 style="margin-bottom: 20px; color: var(--text-primary);">
                                    <i class="fas fa-chart-area" style="color: var(--accent-cyan);"></i>
                                    Ventas Mensuales
                                </h5>
                                <canvas id="salesChart" height="250"></canvas>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <h5 style="margin-bottom: 20px; color: var(--text-primary);">
                                    <i class="fas fa-bell" style="color: var(--accent-orange);"></i>
                                    Notificaciones Recientes
                                </h5>
                                <div id="recentNotifications">
                                    <div class="empty-state" style="padding: 20px;">
                                        <i class="fas fa-inbox" style="font-size: 2rem;"></i>
                                        <p>Sin notificaciones</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- RFQs SECTION -->
                <section id="section-rfqs" class="content-section hidden">
                    <div id="help-banner-rfqs"></div>
                    <div class="stat-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h5 style="color: var(--text-primary);">
                                <i class="fas fa-file-invoice" style="color: var(--accent-cyan);"></i>
                                Solicitudes de Cotizaci√≥n
                            </h5>
                            <div style="display: flex; gap: 10px;">
                                <select id="rfqStatusFilter" class="form-control-dark" style="width: auto;">
                                    <option value="">Todos los estados</option>
                                    <option value="pending">Pendientes</option>
                                    <option value="viewed">Vistos</option>
                                    <option value="quoted">Cotizados</option>
                                    <option value="declined">Rechazados</option>
                                </select>
                            </div>
                        </div>
                        <div id="rfqsList"></div>
                    </div>
                </section>

                <!-- ORDERS SECTION -->
                <section id="section-orders" class="content-section hidden">
                    <div id="help-banner-orders"></div>
                    <div class="stat-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h5 style="color: var(--text-primary);">
                                <i class="fas fa-shopping-cart" style="color: var(--accent-blue);"></i>
                                √ìrdenes de Compra
                            </h5>
                            <div style="display: flex; gap: 10px;">
                                <select id="orderStatusFilter" class="form-control-dark" style="width: auto;">
                                    <option value="">Todos los estados</option>
                                    <option value="sent">Nuevas</option>
                                    <option value="confirmed">Confirmadas</option>
                                    <option value="in_progress">En Proceso</option>
                                    <option value="completed">Completadas</option>
                                </select>
                            </div>
                        </div>
                        <div id="ordersList"></div>
                    </div>
                </section>

                <!-- INVOICES SECTION -->
                <section id="section-invoices" class="content-section hidden">
                    <div id="help-banner-invoices"></div>
                    <div class="stat-card">
                        <h5 style="margin-bottom: 20px; color: var(--text-primary);">
                            <i class="fas fa-file-invoice-dollar" style="color: var(--accent-green);"></i>
                            Mis Facturas
                        </h5>
                        <div id="invoicesList"></div>
                    </div>
                </section>

                <!-- PAYMENTS SECTION -->
                <section id="section-payments" class="content-section hidden">
                    <div id="help-banner-payments"></div>
                    <div class="stat-card">
                        <h5 style="margin-bottom: 20px; color: var(--text-primary);">
                            <i class="fas fa-money-check-alt" style="color: var(--accent-green);"></i>
                            √ìrdenes de Pago
                        </h5>
                        <div id="paymentsList"></div>
                    </div>
                </section>

                <!-- CLAIMS SECTION -->
                <section id="section-claims" class="content-section hidden">
                    <div id="help-banner-claims"></div>
                    <div class="stat-card">
                        <h5 style="margin-bottom: 20px; color: var(--text-primary);">
                            <i class="fas fa-exclamation-triangle" style="color: var(--accent-orange);"></i>
                            Reclamos
                        </h5>
                        <div id="claimsList"></div>
                    </div>
                </section>

                <!-- OFFERS SECTION -->
                <section id="section-offers" class="content-section hidden">
                    <div id="help-banner-offers"></div>
                    <div class="stat-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h5 style="color: var(--text-primary);">
                                <i class="fas fa-tags" style="color: var(--accent-purple);"></i>
                                Mis Ofertas y Promociones
                            </h5>
                            <button class="btn-primary-dark" onclick="SupplierPortal.showCreateOfferModal()">
                                <i class="fas fa-plus"></i> Nueva Oferta
                            </button>
                        </div>
                        <div id="offersList"></div>
                    </div>
                </section>

                <!-- STATISTICS SECTION -->
                <section id="section-statistics" class="content-section hidden">
                    <div id="help-banner-statistics"></div>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="stat-card">
                                <h5 style="margin-bottom: 20px; color: var(--text-primary);">
                                    <i class="fas fa-chart-pie" style="color: var(--accent-purple);"></i>
                                    Distribuci√≥n de Ventas
                                </h5>
                                <canvas id="pieChart" height="250"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stat-card">
                                <h5 style="margin-bottom: 20px; color: var(--text-primary);">
                                    <i class="fas fa-star" style="color: var(--accent-orange);"></i>
                                    M√©tricas de Rendimiento
                                </h5>
                                <div id="performanceMetrics"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- QUOTATIONS SECTION -->
                <section id="section-quotations" class="content-section hidden">
                    <div id="help-banner-quotations"></div>
                    <div class="stat-card">
                        <h5 style="margin-bottom: 20px; color: var(--text-primary);">
                            <i class="fas fa-calculator" style="color: var(--accent-cyan);"></i>
                            Mis Cotizaciones Enviadas
                        </h5>
                        <div id="quotationsList"></div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- RFQ DETAIL MODAL -->
    <div class="modal-overlay" id="rfqModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice"></i> Detalle de Solicitud</h3>
                <button class="modal-close" onclick="SupplierPortal.closeModal('rfqModal')">&times;</button>
            </div>
            <div class="modal-body" id="rfqModalBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button class="btn-outline-dark" onclick="SupplierPortal.closeModal('rfqModal')">Cerrar</button>
                <button class="btn-primary-dark" id="btnSubmitQuote" onclick="SupplierPortal.submitQuotation()">
                    <i class="fas fa-paper-plane"></i> Enviar Cotizaci√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- CLAIM DETAIL MODAL -->
    <div class="modal-overlay" id="claimModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Detalle del Reclamo</h3>
                <button class="modal-close" onclick="SupplierPortal.closeModal('claimModal')">&times;</button>
            </div>
            <div class="modal-body" id="claimModalBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button class="btn-outline-dark" onclick="SupplierPortal.closeModal('claimModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- CREATE OFFER MODAL -->
    <div class="modal-overlay" id="offerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-tags"></i> Nueva Oferta</h3>
                <button class="modal-close" onclick="SupplierPortal.closeModal('offerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="offerForm">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">T√≠tulo de la Oferta</label>
                            <input type="text" class="form-control-dark" id="offerTitle" required placeholder="Ej: Descuento 20% en productos seleccionados">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tipo</label>
                            <select class="form-control-dark" id="offerType" required>
                                <option value="discount">Descuento</option>
                                <option value="bundle">Pack/Bundle</option>
                                <option value="volume">Por Volumen</option>
                                <option value="seasonal">Temporada</option>
                                <option value="clearance">Liquidaci√≥n</option>
                                <option value="new_product">Nuevo Producto</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Descripci√≥n</label>
                            <textarea class="form-control-dark" id="offerDescription" rows="3" placeholder="Describa los beneficios de esta oferta..."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">V√°lido Desde</label>
                            <input type="date" class="form-control-dark" id="offerValidFrom" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">V√°lido Hasta</label>
                            <input type="date" class="form-control-dark" id="offerValidUntil" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tipo de Descuento</label>
                            <select class="form-control-dark" id="offerDiscountType">
                                <option value="">Sin descuento directo</option>
                                <option value="percentage">Porcentaje</option>
                                <option value="fixed">Monto Fijo</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Valor del Descuento</label>
                            <input type="number" class="form-control-dark" id="offerDiscountValue" step="0.01" placeholder="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Pedido M√≠nimo ($)</label>
                            <input type="number" class="form-control-dark" id="offerMinAmount" step="0.01" placeholder="0">
                        </div>
                        <div class="col-12">
                            <label class="form-label">T√©rminos y Condiciones</label>
                            <textarea class="form-control-dark" id="offerTerms" rows="2" placeholder="Condiciones adicionales de la oferta..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-outline-dark" onclick="SupplierPortal.closeModal('offerModal')">Cancelar</button>
                <button class="btn-primary-dark" onclick="SupplierPortal.createOffer()">
                    <i class="fas fa-paper-plane"></i> Publicar Oferta
                </button>
            </div>
        </div>
    </div>

    <!-- üí° Sistema de Ayuda Contextual -->
    <script src="js/core/ModuleHelpSystem.js"></script>

    <script>
    // ============================================================================
    // üëÅÔ∏è PASSWORD TOGGLE FUNCTION
    // ============================================================================
    function togglePassword(inputId, button) {
        const input = document.getElementById(inputId);
        const isPassword = input.type === 'password';

        input.type = isPassword ? 'text' : 'password';
        button.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';

        // Mantener el foco en el input
        input.focus();

        // Posicionar el cursor al final del texto
        setTimeout(() => {
            input.selectionStart = input.selectionEnd = input.value.length;
        }, 0);
    }

    // ============================================================================
    // üí° REGISTRO DE AYUDA CONTEXTUAL - PORTAL DE PROVEEDORES
    // ============================================================================
    if (typeof ModuleHelpSystem !== 'undefined') {
        ModuleHelpSystem.registerModule('supplier-portal', {
            moduleName: 'Portal de Proveedores',
            moduleDescription: 'Portal web para proveedores: cotizaciones, √≥rdenes, pagos y estad√≠sticas',
            contexts: {
                dashboard: {
                    title: 'Dashboard Principal',
                    description: 'Vista general de m√©tricas y actividad reciente',
                    tips: [
                        'Revisa las RFQs pendientes de respuesta en las tarjetas superiores',
                        'El gr√°fico muestra tu desempe√±o mensual',
                        'Accede a las secciones mediante el men√∫ lateral'
                    ],
                    warnings: [],
                    helpTopics: [
                        '¬øC√≥mo responder una RFQ?',
                        '¬øC√≥mo ver mis √≥rdenes activas?'
                    ],
                    fieldHelp: {}
                },
                rfqs: {
                    title: 'Solicitudes de Cotizaci√≥n',
                    description: 'RFQs recibidas de tus clientes',
                    tips: [
                        'Responde las RFQs antes de la fecha l√≠mite',
                        'Filtra por estado: pendiente, respondida, cerrada',
                        'Click en una RFQ para ver detalles y enviar cotizaci√≥n'
                    ],
                    warnings: [
                        'Las RFQs vencidas no pueden cotizarse'
                    ],
                    helpTopics: [
                        '¬øC√≥mo enviar una cotizaci√≥n?',
                        '¬øQu√© pasa si no respondo a tiempo?'
                    ],
                    fieldHelp: {
                        deadline: 'Fecha l√≠mite para enviar tu cotizaci√≥n',
                        items: 'Productos/servicios solicitados',
                        quantity: 'Cantidad requerida',
                        unitPrice: 'Precio unitario que ofreces'
                    }
                },
                quotations: {
                    title: 'Mis Cotizaciones',
                    description: 'Cotizaciones enviadas a clientes',
                    tips: [
                        'Revisa el estado de tus cotizaciones enviadas',
                        'Puedes editar cotizaciones mientras est√©n en borrador',
                        'Las cotizaciones aprobadas se convierten en √≥rdenes'
                    ],
                    warnings: [
                        'No puedes modificar cotizaciones ya aprobadas'
                    ],
                    helpTopics: [
                        '¬øC√≥mo editar una cotizaci√≥n?',
                        '¬øQu√© significa cada estado?'
                    ],
                    fieldHelp: {
                        status: 'Estado: borrador, enviada, aprobada, rechazada',
                        total: 'Monto total de la cotizaci√≥n',
                        validUntil: 'Fecha de validez de tu oferta'
                    }
                },
                orders: {
                    title: '√ìrdenes de Compra',
                    description: '√ìrdenes confirmadas por clientes',
                    tips: [
                        'Confirma la recepci√≥n de cada orden',
                        'Actualiza el estado seg√∫n el avance de preparaci√≥n',
                        'Notifica cuando el pedido est√© listo para entrega'
                    ],
                    warnings: [
                        'Actualiza el estado de las √≥rdenes oportunamente'
                    ],
                    helpTopics: [
                        '¬øC√≥mo confirmar una orden?',
                        '¬øC√≥mo cambiar el estado?'
                    ],
                    fieldHelp: {
                        orderNumber: 'N√∫mero de orden del cliente',
                        status: 'Estado: pendiente, confirmada, en preparaci√≥n, lista, entregada',
                        deliveryDate: 'Fecha de entrega comprometida'
                    }
                },
                invoices: {
                    title: 'Facturas',
                    description: 'Facturas emitidas a clientes',
                    tips: [
                        'Genera facturas desde √≥rdenes completadas',
                        'Descarga PDF para enviar al cliente',
                        'Registra pagos recibidos'
                    ],
                    warnings: [],
                    helpTopics: [
                        '¬øC√≥mo generar una factura?',
                        '¬øC√≥mo registrar un pago?'
                    ],
                    fieldHelp: {
                        invoiceNumber: 'N√∫mero de factura',
                        dueDate: 'Fecha de vencimiento del pago',
                        paymentStatus: 'Estado: pendiente, pagada, vencida'
                    }
                },
                payments: {
                    title: 'Pagos Recibidos',
                    description: 'Historial de pagos de clientes',
                    tips: [
                        'Verifica los pagos recibidos en tu cuenta bancaria',
                        'Concilia pagos con facturas emitidas',
                        'Descarga reportes de pagos por per√≠odo'
                    ],
                    warnings: [],
                    helpTopics: [
                        '¬øC√≥mo conciliar un pago?',
                        '¬øQu√© hacer si hay diferencias?'
                    ],
                    fieldHelp: {
                        paymentMethod: 'M√©todo: transferencia, cheque, etc.',
                        reference: 'N√∫mero de referencia del pago',
                        amount: 'Monto recibido'
                    }
                },
                claims: {
                    title: 'Reclamos',
                    description: 'Gesti√≥n de reclamos de clientes',
                    tips: [
                        'Responde los reclamos dentro de 24-48 horas',
                        'Adjunta evidencia para respaldar tu respuesta',
                        'Busca soluciones que mantengan la relaci√≥n comercial'
                    ],
                    warnings: [
                        'Los reclamos sin respuesta afectan tu reputaci√≥n'
                    ],
                    helpTopics: [
                        '¬øC√≥mo responder un reclamo?',
                        '¬øQu√© hacer ante una disputa?'
                    ],
                    fieldHelp: {
                        claimType: 'Tipo: calidad, entrega, facturaci√≥n',
                        priority: 'Prioridad: alta, media, baja',
                        resolution: 'Soluci√≥n propuesta'
                    }
                },
                offers: {
                    title: 'Mis Ofertas',
                    description: 'Ofertas y promociones publicadas',
                    tips: [
                        'Publica ofertas para atraer nuevos clientes',
                        'Define per√≠odo de validez y condiciones',
                        'Revisa el desempe√±o de cada oferta'
                    ],
                    warnings: [],
                    helpTopics: [
                        '¬øC√≥mo crear una oferta?',
                        '¬øC√≥mo medir el impacto?'
                    ],
                    fieldHelp: {
                        discount: 'Descuento en porcentaje o monto fijo',
                        validFrom: 'Fecha de inicio de la oferta',
                        validTo: 'Fecha de finalizaci√≥n'
                    }
                },
                statistics: {
                    title: 'Estad√≠sticas',
                    description: 'An√°lisis de desempe√±o y m√©tricas',
                    tips: [
                        'Revisa tus KPIs mensuales',
                        'Compara tu desempe√±o con per√≠odos anteriores',
                        'Identifica oportunidades de mejora'
                    ],
                    warnings: [],
                    helpTopics: [
                        '¬øC√≥mo interpretar las m√©tricas?',
                        '¬øQu√© es el ratio de conversi√≥n?'
                    ],
                    fieldHelp: {
                        conversionRate: 'Porcentaje de RFQs que se convierten en √≥rdenes',
                        onTimeDelivery: 'Porcentaje de entregas a tiempo',
                        averageRating: 'Calificaci√≥n promedio de clientes'
                    }
                }
            },
            fallbackResponses: {
                'rfq': 'Las RFQs (Request for Quotation) son solicitudes de cotizaci√≥n de clientes. Resp√≥ndelas desde la secci√≥n "RFQs".',
                'cotizar': 'Para enviar una cotizaci√≥n, ve a la secci√≥n "RFQs", selecciona una solicitud y completa los precios.',
                'orden': 'Las √≥rdenes son pedidos confirmados. Gesti√≥nalas desde la secci√≥n "√ìrdenes".',
                'factura': 'Genera facturas desde √≥rdenes completadas en la secci√≥n "Facturas".',
                'pago': 'Registra pagos recibidos en la secci√≥n "Pagos".',
                'reclamo': 'Gestiona reclamos de clientes en la secci√≥n "Reclamos". Responde dentro de 24-48 horas.',
                'oferta': 'Publica ofertas especiales en la secci√≥n "Mis Ofertas".',
                'estad√≠sticas': 'Revisa tus m√©tricas de desempe√±o en la secci√≥n "Estad√≠sticas".'
            }
        });
    }

    /**
     * Supplier Portal - Frontend Controller
     */
    const SupplierPortal = {
        token: null,
        user: null,
        currentSection: 'dashboard',
        apiBase: '/api/supplier-portal',
        charts: {},
        currentRfqId: null,
        quotationItems: [],

        init() {
            // Inicializar sistema de ayuda contextual
            if (typeof ModuleHelpSystem !== 'undefined') {
                ModuleHelpSystem.init('supplier-portal');
                ModuleHelpSystem.setContext('dashboard');
            }

            this.checkAuth();
            this.bindEvents();
        },

        checkAuth() {
            const token = localStorage.getItem('supplierToken');
            const user = localStorage.getItem('supplierUser');

            if (token && user) {
                this.token = token;
                this.user = JSON.parse(user);
                this.showApp();
            } else {
                this.showLogin();
            }
        },

        bindEvents() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                this.login();
            });

            // Navigation
            document.querySelectorAll('.nav-item[data-section]').forEach(item => {
                item.addEventListener('click', () => {
                    this.navigateTo(item.dataset.section);
                });
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => this.logout());

            // Filters
            document.getElementById('rfqStatusFilter')?.addEventListener('change', () => this.loadRfqs());
            document.getElementById('orderStatusFilter')?.addEventListener('change', () => this.loadOrders());
        },

        async login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch(`${this.apiBase}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error de autenticaci√≥n');
                }

                this.token = data.token;
                this.user = data.user;
                localStorage.setItem('supplierToken', data.token);
                localStorage.setItem('supplierUser', JSON.stringify(data.user));

                this.showApp();

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
            }
        },

        logout() {
            localStorage.removeItem('supplierToken');
            localStorage.removeItem('supplierUser');
            this.token = null;
            this.user = null;
            this.showLogin();
        },

        showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        },

        showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';

            // Update UI with user info
            document.getElementById('supplierName').textContent = this.user.supplierName;
            document.getElementById('userName').textContent = `${this.user.firstName} ${this.user.lastName}`;
            document.getElementById('userAvatar').textContent = this.user.firstName.charAt(0).toUpperCase();

            // Load dashboard
            this.loadDashboard();

            // Render help banners
            this.renderHelpBanners();
        },

        renderHelpBanners() {
            if (typeof ModuleHelpSystem === 'undefined') return;

            const sections = ['dashboard', 'rfqs', 'quotations', 'orders', 'invoices', 'payments', 'claims', 'offers', 'statistics'];
            sections.forEach(section => {
                const container = document.getElementById(`help-banner-${section}`);
                if (container) {
                    container.innerHTML = ModuleHelpSystem.renderBanner(section);
                }
            });
        },

        navigateTo(section) {
            this.currentSection = section;

            // Cambiar contexto de ayuda
            if (typeof ModuleHelpSystem !== 'undefined') {
                ModuleHelpSystem.setContext(section);
            }

            // Update nav
            document.querySelectorAll('.nav-item[data-section]').forEach(item => {
                item.classList.toggle('active', item.dataset.section === section);
            });

            // Update title
            const titles = {
                dashboard: 'Dashboard',
                rfqs: 'Solicitudes de Cotizaci√≥n',
                quotations: 'Mis Cotizaciones',
                orders: '√ìrdenes de Compra',
                invoices: 'Facturas',
                payments: 'Pagos',
                claims: 'Reclamos',
                offers: 'Ofertas y Promociones',
                statistics: 'Estad√≠sticas'
            };
            document.getElementById('pageTitle').textContent = titles[section] || section;

            // Show section
            document.querySelectorAll('.content-section').forEach(s => {
                s.classList.add('hidden');
            });
            document.getElementById(`section-${section}`)?.classList.remove('hidden');

            // Load section data
            this.loadSectionData(section);
        },

        loadSectionData(section) {
            switch (section) {
                case 'dashboard': this.loadDashboard(); break;
                case 'rfqs': this.loadRfqs(); break;
                case 'orders': this.loadOrders(); break;
                case 'invoices': this.loadInvoices(); break;
                case 'payments': this.loadPayments(); break;
                case 'claims': this.loadClaims(); break;
                case 'offers': this.loadOffers(); break;
                case 'statistics': this.loadStatistics(); break;
            }
        },

        async apiCall(endpoint, options = {}) {
            const response = await fetch(`${this.apiBase}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.token}`,
                    ...options.headers
                }
            });

            if (response.status === 401) {
                this.logout();
                throw new Error('Sesi√≥n expirada');
            }

            return response;
        },

        async loadDashboard() {
            try {
                const response = await this.apiCall('/dashboard');
                const data = await response.json();

                // Update stats
                document.getElementById('statPendingRfqs').textContent = data.pendingRfqs || 0;
                document.getElementById('statActiveOrders').textContent = data.activeOrders?.count || 0;
                document.getElementById('statPendingClaims').textContent = data.pendingClaims || 0;
                document.getElementById('statPendingPayments').textContent = `$${(data.pendingPayments?.total || 0).toLocaleString()}`;

                // Update badges
                document.getElementById('rfqBadge').textContent = data.pendingRfqs || 0;
                if (data.pendingClaims > 0) {
                    document.getElementById('claimBadge').textContent = data.pendingClaims;
                    document.getElementById('claimBadge').classList.remove('hidden');
                }

                // Load notifications
                this.renderNotifications(data.notifications || []);

                // Load chart
                this.loadSalesChart();

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        },

        renderNotifications(notifications) {
            const container = document.getElementById('recentNotifications');

            if (!notifications.length) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <i class="fas fa-inbox" style="font-size: 2rem;"></i>
                        <p>Sin notificaciones</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = notifications.map(n => `
                <div style="padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer;"
                     onclick="SupplierPortal.handleNotification(${n.id}, '${n.reference_type}', ${n.reference_id})">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas ${this.getNotificationIcon(n.notification_type)}"
                           style="color: ${n.read_at ? 'var(--text-muted)' : 'var(--accent-cyan)'}"></i>
                        <div style="flex: 1;">
                            <div style="font-size: 0.85rem; color: ${n.read_at ? 'var(--text-muted)' : 'var(--text-primary)'};">
                                ${n.title}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">
                                ${this.formatDate(n.created_at)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        },

        getNotificationIcon(type) {
            const icons = {
                rfq_invitation: 'fa-file-invoice',
                po_received: 'fa-shopping-cart',
                payment_scheduled: 'fa-money-check-alt',
                claim_received: 'fa-exclamation-triangle'
            };
            return icons[type] || 'fa-bell';
        },

        async loadSalesChart() {
            try {
                const response = await this.apiCall('/statistics?period=year');
                const data = await response.json();

                const ctx = document.getElementById('salesChart')?.getContext('2d');
                if (!ctx) return;

                if (this.charts.sales) this.charts.sales.destroy();

                const months = data.monthlyTrend?.map(m => m.year_month) || [];
                const amounts = data.monthlyTrend?.map(m => parseFloat(m.total_po_amount || 0)) || [];

                this.charts.sales = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Ventas ($)',
                            data: amounts,
                            borderColor: '#f093fb',
                            backgroundColor: 'rgba(240, 147, 251, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: '#8b949e' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#8b949e' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading sales chart:', error);
            }
        },

        async loadRfqs() {
            try {
                const status = document.getElementById('rfqStatusFilter')?.value || '';
                const response = await this.apiCall(`/rfqs?status=${status}`);
                const rfqs = await response.json();

                const container = document.getElementById('rfqsList');

                if (!rfqs.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-file-invoice"></i>
                            <h5>Sin solicitudes de cotizaci√≥n</h5>
                            <p>No hay RFQs pendientes en este momento</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>RFQ #</th>
                                <th>Empresa</th>
                                <th>T√≠tulo</th>
                                <th>Fecha L√≠mite</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rfqs.map(rfq => `
                                <tr>
                                    <td><strong>${rfq.rfq_number}</strong></td>
                                    <td>${rfq.company_name}</td>
                                    <td>${rfq.title}</td>
                                    <td>${this.formatDate(rfq.submission_deadline)}</td>
                                    <td>${this.getStatusBadge(rfq.invitation_status)}</td>
                                    <td>
                                        <button class="btn-outline-dark" style="padding: 5px 10px; font-size: 0.8rem;"
                                                onclick="SupplierPortal.viewRfq(${rfq.id})">
                                            <i class="fas fa-eye"></i> Ver
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading RFQs:', error);
            }
        },

        async viewRfq(rfqId) {
            try {
                const response = await this.apiCall(`/rfqs/${rfqId}`);
                const data = await response.json();

                this.currentRfqId = rfqId;
                this.quotationItems = data.items.map(item => ({
                    rfqItemId: item.id,
                    productId: item.product_id,
                    productCode: item.product_code,
                    productName: item.product_name,
                    quantity: item.quantity,
                    unitPrice: item.target_price || 0,
                    discountPercent: 0,
                    taxRate: 21
                }));

                // Load attachments
                const attachments = await this.loadRfqAttachments(rfqId);

                const body = document.getElementById('rfqModalBody');
                body.innerHTML = `
                    <div class="alert-dark alert-info" style="margin-bottom: 20px;">
                        <strong>${data.rfq.rfq_number}</strong> - ${data.rfq.company_name}
                        <br><small>Fecha l√≠mite: ${this.formatDate(data.rfq.submission_deadline)}</small>
                    </div>

                    <!-- ADJUNTOS DE LA EMPRESA -->
                    <div style="margin-bottom: 25px;">
                        <h6 style="margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center;">
                            <i class="fas fa-paperclip" style="margin-right: 8px;"></i>
                            Documentaci√≥n Adjunta
                            ${attachments.length > 0 ? `<span class="status-badge" style="margin-left: 10px; background: rgba(88,166,255,0.2); color: var(--accent-blue);">${attachments.length}</span>` : ''}
                        </h6>
                        ${this.renderAttachments(attachments)}
                    </div>

                    <h6 style="margin-bottom: 15px;">Productos Solicitados</h6>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unit.</th>
                                <th>Desc. %</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${this.quotationItems.map((item, idx) => `
                                <tr>
                                    <td>
                                        <strong>${item.productName}</strong>
                                        <br><small style="color: var(--text-muted);">${item.productCode || ''}</small>
                                    </td>
                                    <td>${item.quantity}</td>
                                    <td>
                                        <input type="number" class="form-control-dark" style="width: 100px;"
                                               value="${item.unitPrice}" step="0.01"
                                               onchange="SupplierPortal.updateQuotationItem(${idx}, 'unitPrice', this.value)">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control-dark" style="width: 80px;"
                                               value="${item.discountPercent}" step="0.5" min="0" max="100"
                                               onchange="SupplierPortal.updateQuotationItem(${idx}, 'discountPercent', this.value)">
                                    </td>
                                    <td id="subtotal-${idx}">$${this.calculateItemSubtotal(item).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align: right;"><strong>Total Estimado:</strong></td>
                                <td id="quotationTotal"><strong>$${this.calculateQuotationTotal().toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="row g-3 mt-3">
                        <div class="col-md-4">
                            <label class="form-label">D√≠as de Entrega</label>
                            <input type="number" class="form-control-dark" id="deliveryDays" value="7" min="1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">V√°lido Hasta</label>
                            <input type="date" class="form-control-dark" id="validUntil">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Condiciones de Pago</label>
                            <input type="text" class="form-control-dark" id="paymentTerms" placeholder="Ej: 30 d√≠as">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notas Adicionales</label>
                            <textarea class="form-control-dark" id="quotationNotes" rows="2"></textarea>
                        </div>
                    </div>
                `;

                // Set default valid until (30 days from now)
                const validUntil = new Date();
                validUntil.setDate(validUntil.getDate() + 30);
                document.getElementById('validUntil').value = validUntil.toISOString().split('T')[0];

                this.openModal('rfqModal');

            } catch (error) {
                console.error('Error loading RFQ:', error);
                alert('Error al cargar la solicitud');
            }
        },

        updateQuotationItem(idx, field, value) {
            this.quotationItems[idx][field] = parseFloat(value) || 0;
            document.getElementById(`subtotal-${idx}`).textContent =
                `$${this.calculateItemSubtotal(this.quotationItems[idx]).toFixed(2)}`;
            document.getElementById('quotationTotal').innerHTML =
                `<strong>$${this.calculateQuotationTotal().toFixed(2)}</strong>`;
        },

        calculateItemSubtotal(item) {
            const base = item.quantity * item.unitPrice;
            const discount = base * (item.discountPercent / 100);
            return base - discount;
        },

        calculateQuotationTotal() {
            return this.quotationItems.reduce((sum, item) => sum + this.calculateItemSubtotal(item), 0);
        },

        async submitQuotation() {
            try {
                const data = {
                    items: this.quotationItems,
                    deliveryDays: parseInt(document.getElementById('deliveryDays').value),
                    validUntil: document.getElementById('validUntil').value,
                    paymentTerms: document.getElementById('paymentTerms').value,
                    notes: document.getElementById('quotationNotes').value
                };

                const response = await this.apiCall(`/rfqs/${this.currentRfqId}/quote`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error);
                }

                this.closeModal('rfqModal');
                this.loadRfqs();
                alert('Cotizaci√≥n enviada exitosamente');

            } catch (error) {
                console.error('Error submitting quotation:', error);
                alert('Error al enviar cotizaci√≥n: ' + error.message);
            }
        },

        async loadOrders() {
            try {
                const status = document.getElementById('orderStatusFilter')?.value || '';
                const response = await this.apiCall(`/orders?status=${status}`);
                const orders = await response.json();

                const container = document.getElementById('ordersList');

                if (!orders.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-shopping-cart"></i>
                            <h5>Sin √≥rdenes de compra</h5>
                            <p>No hay √≥rdenes en este momento</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>OC #</th>
                                <th>Empresa</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orders.map(order => `
                                <tr>
                                    <td><strong>${order.po_number}</strong></td>
                                    <td>${order.company_name}</td>
                                    <td>${this.formatDate(order.order_date)}</td>
                                    <td>$${parseFloat(order.total).toLocaleString()}</td>
                                    <td>${this.getStatusBadge(order.status)}</td>
                                    <td>
                                        <button class="btn-outline-dark" style="padding: 5px 10px; font-size: 0.8rem;">
                                            <i class="fas fa-eye"></i> Ver
                                        </button>
                                        ${order.status === 'sent' ? `
                                            <button class="btn-primary-dark" style="padding: 5px 10px; font-size: 0.8rem;"
                                                    onclick="SupplierPortal.confirmOrder(${order.id})">
                                                <i class="fas fa-check"></i> Confirmar
                                            </button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        },

        async confirmOrder(orderId) {
            if (!confirm('¬øConfirmar esta orden de compra?')) return;

            try {
                const response = await this.apiCall(`/orders/${orderId}/confirm`, {
                    method: 'POST',
                    body: JSON.stringify({})
                });

                if (!response.ok) throw new Error('Error al confirmar');

                this.loadOrders();
                alert('Orden confirmada exitosamente');
            } catch (error) {
                console.error('Error confirming order:', error);
                alert('Error al confirmar la orden');
            }
        },

        async loadInvoices() {
            try {
                const response = await this.apiCall('/invoices');
                const invoices = await response.json();

                const container = document.getElementById('invoicesList');

                const uploadButton = `
                    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <h6 style="margin: 0;">Mis Facturas</h6>
                        <button class="btn-primary" onclick="SupplierPortal.showUploadInvoiceModal()">
                            <i class="fas fa-upload"></i> Subir Factura
                        </button>
                    </div>
                `;

                if (!invoices.length) {
                    container.innerHTML = uploadButton + `
                        <div class="empty-state">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <h5>Sin facturas</h5>
                            <p>Sube tu primera factura haciendo click arriba</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = uploadButton + `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Factura #</th>
                                <th>Empresa</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Saldo</th>
                                <th>Estado Pago</th>
                                <th>Validaci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoices.map(inv => `
                                <tr>
                                    <td><strong>${inv.invoice_number}</strong></td>
                                    <td>${inv.company_name}</td>
                                    <td>${this.formatDate(inv.invoice_date)}</td>
                                    <td>$${parseFloat(inv.total).toLocaleString()}</td>
                                    <td>$${parseFloat(inv.balance_due || 0).toLocaleString()}</td>
                                    <td>${this.getPaymentStatusBadge(inv.payment_status)}</td>
                                    <td>${inv.invoice_validated ?
                                        '<span class="status-badge status-completed"><i class="fas fa-check"></i> Validada</span>' :
                                        '<span class="status-badge status-pending"><i class="fas fa-clock"></i> Pendiente</span>'
                                    }</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading invoices:', error);
            }
        },

        showUploadInvoiceModal() {
            const modalContent = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h5><i class="fas fa-upload"></i> Subir Factura</h5>
                        <button class="close-button" onclick="SupplierPortal.closeUploadInvoiceModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="uploadInvoiceForm" onsubmit="SupplierPortal.handleInvoiceUpload(event)">
                            <div class="form-group">
                                <label class="form-label">N√∫mero de Factura *</label>
                                <input type="text" class="form-control-dark" id="invoiceNumber" required>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Fecha de Factura *</label>
                                    <input type="date" class="form-control-dark" id="invoiceDate" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Fecha de Vencimiento</label>
                                    <input type="date" class="form-control-dark" id="dueDate">
                                </div>
                            </div>

                            <div class="row g-3 mt-2">
                                <div class="col-md-4">
                                    <label class="form-label">Subtotal *</label>
                                    <input type="number" class="form-control-dark" id="subtotal" step="0.01" required
                                           onchange="SupplierPortal.calculateInvoiceTotal()">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">IVA *</label>
                                    <input type="number" class="form-control-dark" id="tax" step="0.01" required
                                           onchange="SupplierPortal.calculateInvoiceTotal()">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Total</label>
                                    <input type="number" class="form-control-dark" id="total" step="0.01" readonly>
                                </div>
                            </div>

                            <div class="form-group mt-3">
                                <label class="form-label">Moneda</label>
                                <select class="form-control-dark" id="currency">
                                    <option value="USD">USD</option>
                                    <option value="ARS">ARS</option>
                                    <option value="EUR">EUR</option>
                                </select>
                            </div>

                            <div class="form-group mt-3">
                                <label class="form-label">Orden de Compra Asociada (opcional)</label>
                                <input type="text" class="form-control-dark" id="purchaseOrderId" placeholder="Ej: PO-2025-001">
                            </div>

                            <div class="form-group mt-3">
                                <label class="form-label">Archivo de Factura (PDF) *</label>
                                <div style="position: relative;">
                                    <input type="file" class="form-control-dark" id="invoiceFile" accept=".pdf,image/*" required
                                           style="padding: 10px;">
                                    <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                                        Formatos aceptados: PDF, JPG, PNG. Tama√±o m√°ximo: 10MB
                                    </small>
                                </div>
                            </div>

                            <div class="form-group mt-3">
                                <label class="form-label">Notas</label>
                                <textarea class="form-control-dark" id="invoiceNotes" rows="2"></textarea>
                            </div>

                            <div class="modal-footer" style="margin-top: 20px;">
                                <button type="button" class="btn-outline-dark" onclick="SupplierPortal.closeUploadInvoiceModal()">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-upload"></i> Subir Factura
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            // Create modal if doesn't exist
            let modal = document.getElementById('uploadInvoiceModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'uploadInvoiceModal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }

            modal.innerHTML = modalContent;
            modal.style.display = 'flex';

            // Set default dates
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
        },

        closeUploadInvoiceModal() {
            const modal = document.getElementById('uploadInvoiceModal');
            if (modal) modal.style.display = 'none';
        },

        calculateInvoiceTotal() {
            const subtotal = parseFloat(document.getElementById('subtotal')?.value || 0);
            const tax = parseFloat(document.getElementById('tax')?.value || 0);
            const total = subtotal + tax;
            document.getElementById('total').value = total.toFixed(2);
        },

        async handleInvoiceUpload(event) {
            event.preventDefault();

            try {
                const formData = new FormData();
                formData.append('invoice_number', document.getElementById('invoiceNumber').value);
                formData.append('invoice_date', document.getElementById('invoiceDate').value);
                formData.append('due_date', document.getElementById('dueDate').value);
                formData.append('subtotal', document.getElementById('subtotal').value);
                formData.append('tax', document.getElementById('tax').value);
                formData.append('total', document.getElementById('total').value);
                formData.append('currency', document.getElementById('currency').value);
                formData.append('notes', document.getElementById('invoiceNotes').value || '');
                formData.append('file', document.getElementById('invoiceFile').files[0]);

                const poId = document.getElementById('purchaseOrderId').value;
                if (poId) formData.append('purchase_order_id', poId);

                const result = await this.uploadInvoice(formData);

                alert('‚úÖ Factura subida exitosamente');
                this.closeUploadInvoiceModal();
                this.loadInvoices();
            } catch (error) {
                console.error('Error uploading invoice:', error);
                alert('‚ùå Error al subir la factura. Por favor intente nuevamente.');
            }
        },

        async loadPayments() {
            try {
                const response = await this.apiCall('/payments');
                const payments = await response.json();

                const container = document.getElementById('paymentsList');

                if (!payments.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-money-check-alt"></i>
                            <h5>Sin √≥rdenes de pago</h5>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>OP #</th>
                                <th>Empresa</th>
                                <th>Fecha Programada</th>
                                <th>Monto Neto</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${payments.map(pay => `
                                <tr>
                                    <td><strong>${pay.payment_order_number}</strong></td>
                                    <td>${pay.company_name}</td>
                                    <td>${this.formatDate(pay.scheduled_date)}</td>
                                    <td>$${parseFloat(pay.net_amount || 0).toLocaleString()}</td>
                                    <td>${this.getStatusBadge(pay.status)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading payments:', error);
            }
        },

        async loadClaims() {
            try {
                const response = await this.apiCall('/claims');
                const claims = await response.json();

                const container = document.getElementById('claimsList');

                if (!claims.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h5>Sin reclamos</h5>
                            <p>No hay reclamos pendientes</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Reclamo #</th>
                                <th>Empresa</th>
                                <th>OC #</th>
                                <th>Tipo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${claims.map(claim => `
                                <tr>
                                    <td><strong>${claim.claim_number}</strong></td>
                                    <td>${claim.company_name}</td>
                                    <td>${claim.po_number || '-'}</td>
                                    <td>${this.getClaimTypeBadge(claim.claim_type)}</td>
                                    <td>${this.getStatusBadge(claim.status)}</td>
                                    <td>
                                        <button class="btn-outline-dark" style="padding: 5px 10px; font-size: 0.8rem;"
                                                onclick="SupplierPortal.viewClaim(${claim.id})">
                                            <i class="fas fa-eye"></i> Ver
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading claims:', error);
            }
        },

        async viewClaim(claimId) {
            try {
                const response = await this.apiCall(`/claims/${claimId}`);
                const data = await response.json();

                const body = document.getElementById('claimModalBody');
                body.innerHTML = `
                    <div class="alert-dark alert-warning" style="margin-bottom: 20px;">
                        <strong>${data.claim.claim_number}</strong> - ${data.claim.company_name}
                        <br><small>Resoluci√≥n solicitada: ${data.claim.requested_resolution || 'No especificada'}</small>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <strong>Descripci√≥n del Problema:</strong>
                        <p style="color: var(--text-secondary); margin-top: 10px;">${data.claim.description}</p>
                    </div>

                    <h6 style="margin-bottom: 15px;">Productos Afectados</h6>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Defecto</th>
                                <th>Monto Reclamado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.items.map(item => `
                                <tr>
                                    <td>${item.product_name}</td>
                                    <td>${item.quantity_affected}</td>
                                    <td>${item.defect_description}</td>
                                    <td>$${parseFloat(item.claimed_amount || 0).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    ${data.messages.length ? `
                        <h6 style="margin: 20px 0 15px;">Conversaci√≥n</h6>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px;">
                            ${data.messages.map(msg => `
                                <div style="margin-bottom: 15px; ${msg.sender_type === 'supplier' ? 'text-align: right;' : ''}">
                                    <div style="display: inline-block; max-width: 80%; padding: 10px 15px;
                                                background: ${msg.sender_type === 'supplier' ? 'var(--accent-cyan)' : 'var(--bg-tertiary)'};
                                                border-radius: 12px; color: ${msg.sender_type === 'supplier' ? 'white' : 'var(--text-primary)'};">
                                        <small style="opacity: 0.7;">${msg.sender_name} - ${this.formatDate(msg.created_at)}</small>
                                        <p style="margin: 5px 0 0;">${msg.message}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${data.claim.status === 'submitted' || data.claim.status === 'acknowledged' ? `
                        <div class="mt-4">
                            <h6>Responder al Reclamo</h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Tipo de Resoluci√≥n</label>
                                    <select class="form-control-dark" id="claimResolutionType">
                                        <option value="replacement">Reemplazo</option>
                                        <option value="credit_note">Nota de Cr√©dito</option>
                                        <option value="partial_credit">Cr√©dito Parcial</option>
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Mensaje</label>
                                    <textarea class="form-control-dark" id="claimResponseMessage" rows="2"
                                              placeholder="Ingrese su respuesta..."></textarea>
                                </div>
                                <div class="col-12">
                                    <button class="btn-primary-dark" onclick="SupplierPortal.respondToClaim(${claimId})">
                                        <i class="fas fa-reply"></i> Enviar Respuesta
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                `;

                this.openModal('claimModal');

            } catch (error) {
                console.error('Error loading claim:', error);
                alert('Error al cargar el reclamo');
            }
        },

        async respondToClaim(claimId) {
            const resolutionType = document.getElementById('claimResolutionType').value;
            const message = document.getElementById('claimResponseMessage').value;

            if (!message.trim()) {
                alert('Por favor ingrese un mensaje');
                return;
            }

            try {
                const response = await this.apiCall(`/claims/${claimId}/respond`, {
                    method: 'POST',
                    body: JSON.stringify({ resolutionType, message })
                });

                if (!response.ok) throw new Error('Error al responder');

                this.closeModal('claimModal');
                this.loadClaims();
                alert('Respuesta enviada exitosamente');

            } catch (error) {
                console.error('Error responding to claim:', error);
                alert('Error al enviar respuesta');
            }
        },

        async loadOffers() {
            try {
                const response = await this.apiCall('/offers');
                const offers = await response.json();

                const container = document.getElementById('offersList');

                if (!offers.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-tags"></i>
                            <h5>Sin ofertas publicadas</h5>
                            <p>Cree su primera oferta para atraer clientes</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Oferta</th>
                                <th>Tipo</th>
                                <th>V√°lida</th>
                                <th>Vistas</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${offers.map(offer => `
                                <tr>
                                    <td>
                                        <strong>${offer.title}</strong>
                                        <br><small style="color: var(--text-muted);">${offer.offer_number}</small>
                                    </td>
                                    <td>${this.getOfferTypeBadge(offer.offer_type)}</td>
                                    <td>${this.formatDate(offer.valid_from)} - ${this.formatDate(offer.valid_until)}</td>
                                    <td>${offer.total_views || 0}</td>
                                    <td>${this.getStatusBadge(offer.status)}</td>
                                    <td>
                                        ${offer.status !== 'cancelled' && offer.status !== 'expired' ? `
                                            <button class="btn-outline-dark" style="padding: 5px 10px; font-size: 0.8rem;"
                                                    onclick="SupplierPortal.cancelOffer(${offer.id})">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading offers:', error);
            }
        },

        showCreateOfferModal() {
            // Set default dates
            const today = new Date();
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);

            document.getElementById('offerValidFrom').value = today.toISOString().split('T')[0];
            document.getElementById('offerValidUntil').value = nextMonth.toISOString().split('T')[0];

            this.openModal('offerModal');
        },

        async createOffer() {
            try {
                const data = {
                    title: document.getElementById('offerTitle').value,
                    offerType: document.getElementById('offerType').value,
                    description: document.getElementById('offerDescription').value,
                    validFrom: document.getElementById('offerValidFrom').value,
                    validUntil: document.getElementById('offerValidUntil').value,
                    discountType: document.getElementById('offerDiscountType').value || null,
                    discountValue: parseFloat(document.getElementById('offerDiscountValue').value) || null,
                    minOrderAmount: parseFloat(document.getElementById('offerMinAmount').value) || null,
                    termsConditions: document.getElementById('offerTerms').value,
                    items: [] // Could add product selection UI
                };

                const response = await this.apiCall('/offers', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error);
                }

                this.closeModal('offerModal');
                this.loadOffers();
                alert('Oferta publicada exitosamente');

            } catch (error) {
                console.error('Error creating offer:', error);
                alert('Error al crear oferta: ' + error.message);
            }
        },

        async cancelOffer(offerId) {
            if (!confirm('¬øEst√° seguro de cancelar esta oferta?')) return;

            try {
                const response = await this.apiCall(`/offers/${offerId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Error al cancelar');

                this.loadOffers();
            } catch (error) {
                console.error('Error cancelling offer:', error);
                alert('Error al cancelar la oferta');
            }
        },

        async loadStatistics() {
            try {
                const response = await this.apiCall('/statistics?period=year');
                const data = await response.json();

                // Performance metrics
                const metricsContainer = document.getElementById('performanceMetrics');
                metricsContainer.innerHTML = `
                    <div style="display: grid; gap: 15px;">
                        <div style="padding: 15px; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Entregas a Tiempo</span>
                                <strong style="color: var(--accent-green);">${(data.performance?.avg_on_time_rate || 0).toFixed(1)}%</strong>
                            </div>
                            <div style="height: 4px; background: var(--border-color); border-radius: 2px; margin-top: 10px;">
                                <div style="height: 100%; width: ${data.performance?.avg_on_time_rate || 0}%; background: var(--accent-green); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <div style="padding: 15px; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>Calidad Promedio</span>
                                <strong style="color: var(--accent-blue);">${(data.performance?.avg_quality_score || 0).toFixed(1)}%</strong>
                            </div>
                            <div style="height: 4px; background: var(--border-color); border-radius: 2px; margin-top: 10px;">
                                <div style="height: 100%; width: ${data.performance?.avg_quality_score || 0}%; background: var(--accent-blue); border-radius: 2px;"></div>
                            </div>
                        </div>
                        <div style="padding: 15px; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>√ìrdenes Completadas</span>
                                <strong>${data.orders?.completed_orders || 0} / ${data.orders?.total_orders || 0}</strong>
                            </div>
                        </div>
                        <div style="padding: 15px; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Reclamos Resueltos</span>
                                <strong>${data.claims?.resolved_claims || 0} / ${data.claims?.total_claims || 0}</strong>
                            </div>
                        </div>
                    </div>
                `;

                // Pie chart
                const ctx = document.getElementById('pieChart')?.getContext('2d');
                if (ctx) {
                    if (this.charts.pie) this.charts.pie.destroy();

                    this.charts.pie = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Facturado', 'Pagado', 'Pendiente'],
                            datasets: [{
                                data: [
                                    parseFloat(data.invoices?.total_invoiced || 0),
                                    parseFloat(data.invoices?.total_paid || 0),
                                    parseFloat(data.invoices?.pending_payment || 0)
                                ],
                                backgroundColor: ['#f093fb', '#3fb950', '#d29922']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { color: '#8b949e' }
                                }
                            }
                        }
                    });
                }

            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        },

        // Utility methods
        openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        },

        closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        },

        formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('es-AR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        },

        getStatusBadge(status) {
            const badges = {
                pending: '<span class="status-badge status-pending"><i class="fas fa-clock"></i> Pendiente</span>',
                viewed: '<span class="status-badge status-pending"><i class="fas fa-eye"></i> Visto</span>',
                quoted: '<span class="status-badge status-completed"><i class="fas fa-check"></i> Cotizado</span>',
                declined: '<span class="status-badge status-draft"><i class="fas fa-times"></i> Rechazado</span>',
                draft: '<span class="status-badge status-draft"><i class="fas fa-edit"></i> Borrador</span>',
                sent: '<span class="status-badge status-pending"><i class="fas fa-paper-plane"></i> Enviada</span>',
                confirmed: '<span class="status-badge status-confirmed"><i class="fas fa-check"></i> Confirmada</span>',
                in_progress: '<span class="status-badge status-active"><i class="fas fa-spinner"></i> En Proceso</span>',
                completed: '<span class="status-badge status-completed"><i class="fas fa-check-double"></i> Completada</span>',
                submitted: '<span class="status-badge status-urgent"><i class="fas fa-exclamation"></i> Recibido</span>',
                acknowledged: '<span class="status-badge status-pending"><i class="fas fa-handshake"></i> Reconocido</span>',
                resolved: '<span class="status-badge status-completed"><i class="fas fa-check"></i> Resuelto</span>',
                active: '<span class="status-badge status-active"><i class="fas fa-check"></i> Activa</span>',
                pending_approval: '<span class="status-badge status-pending"><i class="fas fa-hourglass"></i> Pendiente</span>',
                approved: '<span class="status-badge status-confirmed"><i class="fas fa-check"></i> Aprobado</span>',
                paid: '<span class="status-badge status-completed"><i class="fas fa-check-double"></i> Pagado</span>',
                scheduled: '<span class="status-badge status-pending"><i class="fas fa-calendar"></i> Programado</span>',
                cancelled: '<span class="status-badge status-draft"><i class="fas fa-ban"></i> Cancelado</span>',
                expired: '<span class="status-badge status-draft"><i class="fas fa-clock"></i> Expirada</span>'
            };
            return badges[status] || `<span class="status-badge status-draft">${status}</span>`;
        },

        getPaymentStatusBadge(status) {
            const badges = {
                pending: '<span class="status-badge status-urgent">Pendiente</span>',
                partial: '<span class="status-badge status-pending">Parcial</span>',
                paid: '<span class="status-badge status-completed">Pagado</span>'
            };
            return badges[status] || status;
        },

        getClaimTypeBadge(type) {
            const types = {
                defective_product: 'Producto Defectuoso',
                wrong_product: 'Producto Incorrecto',
                missing_quantity: 'Faltante',
                damaged: 'Da√±ado'
            };
            return types[type] || type;
        },

        getOfferTypeBadge(type) {
            const types = {
                discount: '<span class="status-badge" style="background: rgba(240, 147, 251, 0.2); color: #f093fb;">Descuento</span>',
                bundle: '<span class="status-badge" style="background: rgba(88, 166, 255, 0.2); color: #58a6ff;">Bundle</span>',
                volume: '<span class="status-badge" style="background: rgba(63, 185, 80, 0.2); color: #3fb950;">Volumen</span>',
                seasonal: '<span class="status-badge" style="background: rgba(210, 153, 34, 0.2); color: #d29922;">Temporada</span>',
                clearance: '<span class="status-badge" style="background: rgba(248, 81, 73, 0.2); color: #f85149;">Liquidaci√≥n</span>',
                new_product: '<span class="status-badge" style="background: rgba(163, 113, 247, 0.2); color: #a371f7;">Nuevo</span>'
            };
            return types[type] || type;
        },

        // =====================================================================
        // ADJUNTOS Y DOCUMENTACI√ìN
        // =====================================================================

        async loadRfqAttachments(rfqId) {
            try {
                const response = await this.apiCall(`/attachments/rfq/${rfqId}/company-attachments`);
                const { attachments } = await response.json();
                return attachments || [];
            } catch (error) {
                console.error('Error loading RFQ attachments:', error);
                return [];
            }
        },

        renderAttachments(attachments) {
            if (!attachments || attachments.length === 0) {
                return `
                    <div class="alert-dark alert-info">
                        <i class="fas fa-info-circle"></i> No hay adjuntos para esta solicitud
                    </div>
                `;
            }

            const contractualAttachments = attachments.filter(a => a.attachment_type === 'contractual');
            const informativeAttachments = attachments.filter(a => a.attachment_type === 'informative');

            let html = '';

            // ADJUNTOS CONTRACTUALES (CR√çTICOS)
            if (contractualAttachments.length > 0) {
                html += `
                    <div class="alert-dark alert-danger" style="margin-bottom: 20px; border: 2px solid var(--accent-red);">
                        <h6 style="color: var(--accent-red); margin-bottom: 10px;">
                            <i class="fas fa-exclamation-triangle"></i> ADJUNTOS CONTRACTUALES
                        </h6>
                        <p style="margin-bottom: 15px; font-size: 0.9rem;">
                            Estos archivos son <strong>vinculantes</strong>. Debe cumplir exactamente con lo especificado.
                            El incumplimiento puede resultar en rechazo de pago o penalizaciones.
                        </p>
                        ${contractualAttachments.map(att => `
                            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid ${att.binding_level === 'strict' ? 'var(--accent-red)' : 'var(--accent-orange)'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <strong style="color: var(--text-primary);">
                                            <i class="fas fa-file-pdf"></i> ${att.file_name}
                                        </strong>
                                        ${att.binding_level === 'strict' ?
                                            '<span class="status-badge status-urgent" style="margin-left: 10px;">ESTRICTO</span>' :
                                            '<span class="status-badge" style="background: rgba(210,153,34,0.2); color: var(--accent-orange); margin-left: 10px;">ORIENTATIVO</span>'
                                        }
                                        ${att.is_required ?
                                            '<span class="status-badge status-active" style="margin-left: 5px;"><i class="fas fa-star"></i> OBLIGATORIO</span>' : ''
                                        }
                                        <br>
                                        <small style="color: var(--text-muted);">
                                            ${(att.file_size / 1024).toFixed(2)} KB
                                            ${att.downloaded_by_supplier ?
                                                ` | <i class="fas fa-check" style="color: var(--accent-green);"></i> Descargado el ${this.formatDate(att.downloaded_at)}` :
                                                ' | <i class="fas fa-download" style="color: var(--accent-orange);"></i> Sin descargar'
                                            }
                                        </small>
                                    </div>
                                    <button class="btn-primary" style="padding: 5px 12px;"
                                            onclick="SupplierPortal.downloadAttachment(${att.id}, ${this.currentRfqId}, 'rfq')">
                                        <i class="fas fa-download"></i> Descargar
                                    </button>
                                </div>

                                ${att.legal_notice ? `
                                    <div class="alert-dark alert-warning" style="margin-top: 10px; padding: 10px; background: rgba(210,153,34,0.15); border-left: 3px solid var(--accent-orange);">
                                        <strong>‚öñÔ∏è Aviso Legal:</strong><br>
                                        ${att.legal_notice}
                                    </div>
                                ` : ''}

                                ${att.deviation_allowed && att.deviation_tolerance ? `
                                    <div style="margin-top: 8px; font-size: 0.85rem; color: var(--text-secondary);">
                                        <i class="fas fa-info-circle"></i> Tolerancia permitida: ${att.deviation_tolerance}
                                    </div>
                                ` : ''}

                                ${att.non_compliance_notice ? `
                                    <div style="margin-top: 8px; padding: 8px; background: rgba(248,81,73,0.15); border-radius: 4px; font-size: 0.85rem;">
                                        <strong style="color: var(--accent-red);">‚ö†Ô∏è Consecuencias de incumplimiento:</strong><br>
                                        ${att.non_compliance_notice}
                                    </div>
                                ` : ''}

                                ${!att.supplier_acknowledged && att.attachment_type === 'contractual' ? `
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" onchange="SupplierPortal.acknowledgeAttachment(${att.id}, ${this.currentRfqId})"
                                                   style="margin-right: 8px; width: 18px; height: 18px;">
                                            <span style="font-size: 0.9rem;">
                                                He le√≠do y acepto cumplir con las especificaciones contractuales de este documento
                                            </span>
                                        </label>
                                    </div>
                                ` : att.supplier_acknowledged ? `
                                    <div style="margin-top: 8px; color: var(--accent-green); font-size: 0.85rem;">
                                        <i class="fas fa-check-circle"></i> Reconocido el ${this.formatDate(att.acknowledged_at)}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // ADJUNTOS INFORMATIVOS
            if (informativeAttachments.length > 0) {
                html += `
                    <h6 style="margin-bottom: 10px; color: var(--text-secondary);">
                        <i class="fas fa-info-circle"></i> Documentos Informativos
                    </h6>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        ${informativeAttachments.map(att => `
                            <div style="background: var(--bg-tertiary); padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);">
                                <div style="margin-bottom: 8px;">
                                    <strong style="font-size: 0.9rem;">
                                        <i class="fas fa-file"></i> ${att.file_name}
                                    </strong>
                                    <br>
                                    <small style="color: var(--text-muted);">
                                        ${(att.file_size / 1024).toFixed(2)} KB
                                    </small>
                                </div>
                                <button class="btn-outline-dark" style="width: 100%; padding: 5px;"
                                        onclick="SupplierPortal.downloadAttachment(${att.id}, ${this.currentRfqId}, 'rfq')">
                                    <i class="fas fa-download"></i> Descargar
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            return html;
        },

        async downloadAttachment(attachmentId, rfqId, type) {
            try {
                const url = type === 'rfq'
                    ? `/attachments/rfq/${rfqId}/company-attachments/${attachmentId}/download`
                    : `/attachments/purchase-order/${rfqId}/attachments/${attachmentId}/download`;

                const response = await this.apiCall(url);
                const blob = await response.blob();

                // Get filename from Content-Disposition header or use default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'download';
                if (contentDisposition) {
                    const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }

                // Create download link
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);

                // Refresh attachments to update download status
                if (type === 'rfq') {
                    setTimeout(() => this.viewRfq(rfqId), 1000);
                }
            } catch (error) {
                console.error('Error downloading attachment:', error);
                alert('Error al descargar el archivo');
            }
        },

        async acknowledgeAttachment(attachmentId, rfqId) {
            try {
                await this.apiCall(`/attachments/rfq/${rfqId}/company-attachments/${attachmentId}/acknowledge`, {
                    method: 'POST'
                });

                // Refresh to show acknowledgement
                this.viewRfq(rfqId);
            } catch (error) {
                console.error('Error acknowledging attachment:', error);
                alert('Error al reconocer el adjunto');
            }
        },

        async uploadInvoice(formData) {
            try {
                const response = await fetch('/api/supplier-portal/attachments/invoice/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.token}`
                    },
                    body: formData
                });

                if (!response.ok) throw new Error('Upload failed');

                return await response.json();
            } catch (error) {
                console.error('Error uploading invoice:', error);
                throw error;
            }
        },

        handleNotification(notificationId, refType, refId) {
            // Mark as read and navigate
            this.apiCall(`/notifications/${notificationId}/read`, { method: 'POST' });

            switch (refType) {
                case 'rfq':
                    this.navigateTo('rfqs');
                    setTimeout(() => this.viewRfq(refId), 500);
                    break;
                case 'purchase_order':
                    this.navigateTo('orders');
                    break;
                case 'claim':
                    this.navigateTo('claims');
                    setTimeout(() => this.viewClaim(refId), 500);
                    break;
                case 'payment':
                    this.navigateTo('payments');
                    break;
            }
        }
    };

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => SupplierPortal.init());
    </script>

    <!-- Bootstrap JS (desde cdnjs para CSP) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
</body>
</html>
