<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Presupuesto - APONNT 360</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #f59e0b;
      --primary-dark: #d97706;
      --success: #22c55e;
      --success-dark: #16a34a;
      --danger: #ef4444;
      --danger-dark: #dc2626;
      --bg: #f1f5f9;
      --card: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      padding: 32px 20px;
      text-align: center;
    }
    .header h1 { font-family: 'Poppins', sans-serif; color: #fff; font-size: 28px; margin-bottom: 4px; }
    .header p { color: #fffbeb; font-size: 16px; font-weight: 300; }

    .stepper {
      display: flex; justify-content: center; gap: 8px; margin: 24px auto 0; max-width: 400px;
    }
    .step-dot {
      width: 10px; height: 10px; border-radius: 50%; background: rgba(255,255,255,0.4); transition: all 0.3s;
    }
    .step-dot.active { background: #fff; transform: scale(1.3); }
    .step-dot.done { background: #fff; }

    .container { max-width: 760px; margin: -20px auto 40px; padding: 0 16px; }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: 0 4px 24px rgba(0,0,0,0.08); overflow: hidden; }
    .card-body { padding: 32px; }

    /* Step visibility */
    .step { display: none; }
    .step.active { display: block; }

    /* Quote view */
    .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .info-label { color: #475569; font-weight: 500; }
    .info-value { color: var(--text); font-weight: 600; }
    .status-badge { display: inline-block; padding: 4px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; }
    .status-sent { background: #dbeafe; color: #1d4ed8; }
    .status-draft { background: #f1f5f9; color: #475569; }
    .status-accepted { background: #dcfce7; color: var(--success-dark); }
    .status-rejected { background: #fee2e2; color: var(--danger-dark); }

    h3 { color: var(--text); margin: 24px 0 12px; font-size: 18px; font-family: 'Poppins', sans-serif; }
    table { width: 100%; border-collapse: collapse; }
    th { background: var(--text); color: #fff; padding: 12px 16px; text-align: left; font-weight: 600; font-size: 14px; }
    th:last-child { text-align: right; }
    td { padding: 12px 16px; border-bottom: 1px solid var(--border); color: #334155; font-size: 14px; }
    td:last-child { text-align: right; font-weight: 500; }
    .total-row { background: var(--primary); }
    .total-row td { border: none; color: #fff; font-size: 16px; font-weight: 700; }

    .trial-box { background: #dcfce7; border: 1px solid #86efac; border-radius: 10px; padding: 16px 20px; margin: 20px 0; }
    .trial-box p { color: #166534; margin: 0; }
    .trial-box strong { font-size: 16px; }

    /* Buttons */
    .actions { text-align: center; margin: 28px 0 8px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    .btn {
      padding: 14px 32px; border: none; border-radius: 8px; font-size: 15px; font-weight: 700;
      cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
    }
    .btn-accept { background: var(--success); color: #fff; }
    .btn-accept:hover { background: var(--success-dark); transform: translateY(-1px); }
    .btn-reject { background: var(--danger); color: #fff; }
    .btn-reject:hover { background: var(--danger-dark); }
    .btn-secondary { background: #e2e8f0; color: var(--text); }
    .btn-secondary:hover { background: #cbd5e1; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    /* Form styles */
    .form-section { margin-bottom: 28px; }
    .form-section-title {
      font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 600;
      color: var(--primary-dark); margin-bottom: 16px; padding-bottom: 8px;
      border-bottom: 2px solid var(--primary);
    }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group.full { grid-column: 1 / -1; }
    .form-group label { font-size: 13px; font-weight: 600; color: #475569; }
    .form-group label .req { color: var(--danger); }
    .form-group input, .form-group select, .form-group textarea {
      padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px;
      font-size: 14px; font-family: 'Inter', sans-serif; color: var(--text);
      transition: border-color 0.2s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none; border-color: var(--primary);
    }
    .form-group input.invalid, .form-group select.invalid {
      border-color: var(--danger); background: #fff5f5;
    }
    .form-group .field-error { font-size: 12px; color: var(--danger); display: none; }
    .form-group .field-error.show { display: block; }

    /* Branch selector */
    .branch-selector {
      display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0 16px;
    }
    .branch-opt {
      padding: 8px 18px; border: 2px solid var(--border); border-radius: 8px;
      cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;
      background: #fff;
    }
    .branch-opt:hover { border-color: var(--primary); }
    .branch-opt.selected { border-color: var(--primary); background: #fffbeb; color: var(--primary-dark); }

    .branch-note { font-size: 13px; color: var(--text-light); font-style: italic; margin: 8px 0 16px; }

    .branch-form {
      background: #f8fafc; border: 1px solid var(--border); border-radius: 10px;
      padding: 20px; margin-bottom: 14px;
    }
    .branch-form-title { font-weight: 600; font-size: 14px; color: var(--text); margin-bottom: 12px; }

    /* Result / confirmation */
    .result-msg {
      text-align: center; padding: 20px; border-radius: 8px; margin: 20px 0;
      font-weight: 600; font-size: 16px;
    }
    .result-ok { background: #dcfce7; color: #166534; }
    .result-err { background: #fee2e2; color: #991b1b; }

    .loading { text-align: center; padding: 60px 20px; color: var(--text-light); }
    .error-view { text-align: center; padding: 60px 20px; color: var(--danger-dark); }

    .confirmation-icon { font-size: 64px; margin-bottom: 16px; }
    .confirmation-title { font-family: 'Poppins', sans-serif; font-size: 22px; margin-bottom: 12px; }
    .confirmation-text { color: var(--text-light); font-size: 15px; line-height: 1.6; max-width: 500px; margin: 0 auto; }

    /* Reject modal */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 1000; justify-content: center; align-items: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: #fff; border-radius: var(--radius); padding: 32px; width: 90%; max-width: 460px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }
    .modal h3 { margin: 0 0 16px; }
    .modal textarea {
      width: 100%; min-height: 100px; padding: 12px; border: 1px solid var(--border);
      border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 14px; resize: vertical;
    }
    .modal .actions { margin-top: 20px; }

    .footer { text-align: center; padding: 24px; color: #94a3b8; font-size: 13px; }

    @media (max-width: 640px) {
      .form-grid { grid-template-columns: 1fr; }
      .card-body { padding: 20px; }
      .header h1 { font-size: 22px; }
      .btn { padding: 12px 20px; font-size: 14px; }
      .actions { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>APONNT 360&deg;</h1>
    <p>Presupuesto</p>
    <div class="stepper">
      <div class="step-dot active" id="dot-1"></div>
      <div class="step-dot" id="dot-2"></div>
      <div class="step-dot" id="dot-3"></div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="card-body" id="content">
        <div class="loading">Cargando presupuesto...</div>
      </div>
    </div>
  </div>

  <!-- Reject modal -->
  <div class="modal-overlay" id="reject-modal">
    <div class="modal">
      <h3>Rechazar presupuesto</h3>
      <p style="color:#64748b;margin-bottom:12px;font-size:14px;">Si lo desea, indique el motivo del rechazo:</p>
      <textarea id="reject-reason" placeholder="Motivo (opcional)"></textarea>
      <div class="actions">
        <button class="btn btn-reject" onclick="confirmReject()">Confirmar rechazo</button>
        <button class="btn btn-secondary" onclick="closeRejectModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <div class="footer">APONNT - Sistema de Gesti&oacute;n Empresarial 360&deg;</div>

  <script>
    const TOKEN = new URLSearchParams(window.location.search).get('token');
    if (!TOKEN) {
      document.getElementById('content').innerHTML = '<div class="error-view"><p style="font-size:48px;margin-bottom:12px;">&#9888;</p><p>Token no proporcionado</p></div>';
    }
    const API = '/api/quotes/public/' + encodeURIComponent(TOKEN);

    let quoteData = null;
    let currentStep = 1;
    let selectedBranchCount = 1;

    const statusMap = {
      draft: { label: 'Borrador', cls: 'status-draft' },
      sent: { label: 'Enviado', cls: 'status-sent' },
      accepted: { label: 'Aceptado', cls: 'status-accepted' },
      rejected: { label: 'Rechazado', cls: 'status-rejected' },
      in_trial: { label: 'En Trial (30 d\u00edas)', cls: 'status-accepted' },
      active: { label: 'Activo', cls: 'status-accepted' },
      expired: { label: 'Expirado', cls: 'status-rejected' }
    };

    const COUNTRIES = [
      { code: 'AR', name: 'Argentina', tz: 'America/Argentina/Buenos_Aires' },
      { code: 'CL', name: 'Chile', tz: 'America/Santiago' },
      { code: 'UY', name: 'Uruguay', tz: 'America/Montevideo' },
      { code: 'CO', name: 'Colombia', tz: 'America/Bogota' },
      { code: 'MX', name: 'M\u00e9xico', tz: 'America/Mexico_City' },
      { code: 'BR', name: 'Brasil', tz: 'America/Sao_Paulo' },
      { code: 'PE', name: 'Per\u00fa', tz: 'America/Lima' },
      { code: 'BO', name: 'Bolivia', tz: 'America/La_Paz' },
      { code: 'EC', name: 'Ecuador', tz: 'America/Guayaquil' },
      { code: 'PY', name: 'Paraguay', tz: 'America/Asuncion' },
      { code: 'VE', name: 'Venezuela', tz: 'America/Caracas' },
      { code: 'ES', name: 'Espa\u00f1a', tz: 'Europe/Madrid' }
    ];

    const PROVINCES = {
      AR: [
        { name: 'Buenos Aires', cities: ['Buenos Aires (CABA)','La Plata','Mar del Plata','Bahía Blanca','Tandil','Quilmes','Lanús','Avellaneda','Morón','Tigre','San Isidro','Vicente López','Pilar'] },
        { name: 'Córdoba', cities: ['Córdoba','Villa María','Río Cuarto','Carlos Paz','Alta Gracia'] },
        { name: 'Santa Fe', cities: ['Rosario','Santa Fe','Rafaela','Venado Tuerto','Reconquista'] },
        { name: 'Mendoza', cities: ['Mendoza','San Rafael','Godoy Cruz','Las Heras','Maipú'] },
        { name: 'Tucumán', cities: ['San Miguel de Tucumán','Yerba Buena','Tafí Viejo','Concepción'] },
        { name: 'Entre Ríos', cities: ['Paraná','Concordia','Gualeguaychú','Concepción del Uruguay'] },
        { name: 'Salta', cities: ['Salta','San Ramón de la Nueva Orán','Tartagal','Cafayate'] },
        { name: 'Misiones', cities: ['Posadas','Puerto Iguazú','Eldorado','Oberá'] },
        { name: 'Chaco', cities: ['Resistencia','Presidencia Roque Sáenz Peña','Villa Ángela'] },
        { name: 'Corrientes', cities: ['Corrientes','Goya','Mercedes','Paso de los Libres'] },
        { name: 'Santiago del Estero', cities: ['Santiago del Estero','La Banda','Termas de Río Hondo'] },
        { name: 'San Juan', cities: ['San Juan','Rawson','Rivadavia','Chimbas'] },
        { name: 'Jujuy', cities: ['San Salvador de Jujuy','Palpalá','San Pedro','Libertador General San Martín'] },
        { name: 'Río Negro', cities: ['Viedma','San Carlos de Bariloche','General Roca','Cipolletti'] },
        { name: 'Neuquén', cities: ['Neuquén','San Martín de los Andes','Zapala','Cutral Có'] },
        { name: 'Formosa', cities: ['Formosa','Clorinda','Pirané'] },
        { name: 'Chubut', cities: ['Rawson','Comodoro Rivadavia','Trelew','Puerto Madryn','Esquel'] },
        { name: 'San Luis', cities: ['San Luis','Villa Mercedes','Merlo','La Punta'] },
        { name: 'Catamarca', cities: ['San Fernando del Valle de Catamarca','Valle Viejo','Fray Mamerto Esquiú'] },
        { name: 'La Rioja', cities: ['La Rioja','Chilecito','Aimogasta'] },
        { name: 'La Pampa', cities: ['Santa Rosa','General Pico','Toay'] },
        { name: 'Santa Cruz', cities: ['Río Gallegos','Caleta Olivia','El Calafate','Pico Truncado'] },
        { name: 'Tierra del Fuego', cities: ['Ushuaia','Río Grande','Tolhuin'] }
      ],
      CL: [
        { name: 'Región Metropolitana', cities: ['Santiago','Providencia','Las Condes','Maipú','Puente Alto'] },
        { name: 'Valparaíso', cities: ['Valparaíso','Viña del Mar','Quilpué','Villa Alemana'] },
        { name: 'Biobío', cities: ['Concepción','Talcahuano','Los Ángeles','Chillán'] },
        { name: 'Maule', cities: ['Talca','Curicó','Linares','Constitución'] },
        { name: 'Araucanía', cities: ['Temuco','Padre las Casas','Villarrica','Pucón'] },
        { name: 'Los Lagos', cities: ['Puerto Montt','Osorno','Castro','Puerto Varas'] },
        { name: 'Coquimbo', cities: ['La Serena','Coquimbo','Ovalle'] },
        { name: "O'Higgins", cities: ['Rancagua','San Fernando','Rengo'] },
        { name: 'Antofagasta', cities: ['Antofagasta','Calama','Tocopilla'] },
        { name: 'Atacama', cities: ['Copiapó','Vallenar','Chañaral'] }
      ],
      UY: [
        { name: 'Montevideo', cities: ['Montevideo'] },
        { name: 'Canelones', cities: ['Las Piedras','Ciudad de la Costa','Pando','La Paz'] },
        { name: 'Maldonado', cities: ['Maldonado','Punta del Este','San Carlos'] },
        { name: 'Salto', cities: ['Salto'] },
        { name: 'Paysandú', cities: ['Paysandú'] },
        { name: 'Colonia', cities: ['Colonia del Sacramento','Carmelo','Nueva Helvecia'] },
        { name: 'Rivera', cities: ['Rivera'] }
      ],
      CO: [
        { name: 'Bogotá D.C.', cities: ['Bogotá'] },
        { name: 'Antioquia', cities: ['Medellín','Envigado','Bello','Itagüí','Rionegro'] },
        { name: 'Valle del Cauca', cities: ['Cali','Palmira','Buenaventura','Tuluá'] },
        { name: 'Atlántico', cities: ['Barranquilla','Soledad','Malambo'] },
        { name: 'Santander', cities: ['Bucaramanga','Floridablanca','Girón','Piedecuesta'] },
        { name: 'Cundinamarca', cities: ['Soacha','Zipaquirá','Chía','Facatativá'] },
        { name: 'Bolívar', cities: ['Cartagena','Magangué','Turbaco'] },
        { name: 'Norte de Santander', cities: ['Cúcuta','Ocaña','Pamplona'] }
      ],
      MX: [
        { name: 'Ciudad de México', cities: ['Ciudad de México'] },
        { name: 'Estado de México', cities: ['Toluca','Ecatepec','Naucalpan','Tlalnepantla','Nezahualcóyotl'] },
        { name: 'Jalisco', cities: ['Guadalajara','Zapopan','Tlaquepaque','Tonalá','Puerto Vallarta'] },
        { name: 'Nuevo León', cities: ['Monterrey','San Pedro Garza García','San Nicolás','Apodaca','Guadalupe'] },
        { name: 'Puebla', cities: ['Puebla','Tehuacán','San Martín Texmelucan'] },
        { name: 'Guanajuato', cities: ['León','Irapuato','Celaya','Salamanca','Guanajuato'] },
        { name: 'Querétaro', cities: ['Querétaro','San Juan del Río','El Marqués'] },
        { name: 'Yucatán', cities: ['Mérida','Valladolid','Progreso'] },
        { name: 'Quintana Roo', cities: ['Cancún','Playa del Carmen','Chetumal','Tulum'] },
        { name: 'Veracruz', cities: ['Veracruz','Xalapa','Coatzacoalcos','Córdoba'] },
        { name: 'Chihuahua', cities: ['Chihuahua','Ciudad Juárez','Delicias'] },
        { name: 'Baja California', cities: ['Tijuana','Mexicali','Ensenada'] }
      ],
      BR: [
        { name: 'São Paulo', cities: ['São Paulo','Campinas','Santos','Guarulhos','São Bernardo do Campo'] },
        { name: 'Rio de Janeiro', cities: ['Rio de Janeiro','Niterói','Petrópolis','Duque de Caxias'] },
        { name: 'Minas Gerais', cities: ['Belo Horizonte','Uberlândia','Juiz de Fora','Contagem'] },
        { name: 'Paraná', cities: ['Curitiba','Londrina','Maringá','Foz do Iguaçu'] },
        { name: 'Rio Grande do Sul', cities: ['Porto Alegre','Caxias do Sul','Pelotas','Canoas'] },
        { name: 'Bahia', cities: ['Salvador','Feira de Santana','Vitória da Conquista'] },
        { name: 'Santa Catarina', cities: ['Florianópolis','Joinville','Blumenau','Chapecó'] },
        { name: 'Distrito Federal', cities: ['Brasília'] }
      ],
      PE: [
        { name: 'Lima', cities: ['Lima','Callao','San Isidro','Miraflores','La Molina'] },
        { name: 'Arequipa', cities: ['Arequipa','Camaná','Mollendo'] },
        { name: 'La Libertad', cities: ['Trujillo','Chepén','Pacasmayo'] },
        { name: 'Cusco', cities: ['Cusco','Sicuani','Quillabamba'] },
        { name: 'Piura', cities: ['Piura','Sullana','Talara','Paita'] },
        { name: 'Lambayeque', cities: ['Chiclayo','Lambayeque','Ferreñafe'] }
      ],
      BO: [
        { name: 'La Paz', cities: ['La Paz','El Alto','Viacha'] },
        { name: 'Santa Cruz', cities: ['Santa Cruz de la Sierra','Montero','Warnes'] },
        { name: 'Cochabamba', cities: ['Cochabamba','Quillacollo','Sacaba'] },
        { name: 'Sucre', cities: ['Sucre'] },
        { name: 'Tarija', cities: ['Tarija','Yacuiba','Bermejo'] },
        { name: 'Oruro', cities: ['Oruro'] },
        { name: 'Potosí', cities: ['Potosí','Villazón'] }
      ],
      EC: [
        { name: 'Pichincha', cities: ['Quito','Cayambe','Sangolquí'] },
        { name: 'Guayas', cities: ['Guayaquil','Durán','Milagro','Samborondón'] },
        { name: 'Azuay', cities: ['Cuenca','Gualaceo'] },
        { name: 'Manabí', cities: ['Portoviejo','Manta','Chone'] },
        { name: 'Tungurahua', cities: ['Ambato','Baños','Pelileo'] },
        { name: 'El Oro', cities: ['Machala','Pasaje','Santa Rosa'] }
      ],
      PY: [
        { name: 'Central', cities: ['Asunción','San Lorenzo','Luque','Fernando de la Mora','Lambaré'] },
        { name: 'Alto Paraná', cities: ['Ciudad del Este','Presidente Franco','Hernandarias'] },
        { name: 'Itapúa', cities: ['Encarnación','Hohenau','Obligado'] },
        { name: 'Caaguazú', cities: ['Coronel Oviedo','Caaguazú'] }
      ],
      VE: [
        { name: 'Distrito Capital', cities: ['Caracas'] },
        { name: 'Miranda', cities: ['Los Teques','Guarenas','Guatire'] },
        { name: 'Zulia', cities: ['Maracaibo','Cabimas','Ciudad Ojeda'] },
        { name: 'Carabobo', cities: ['Valencia','Puerto Cabello','Guacara'] },
        { name: 'Lara', cities: ['Barquisimeto','Cabudare'] },
        { name: 'Aragua', cities: ['Maracay','Turmero','La Victoria'] }
      ],
      ES: [
        { name: 'Madrid', cities: ['Madrid','Alcalá de Henares','Getafe','Leganés','Móstoles'] },
        { name: 'Barcelona', cities: ['Barcelona','Hospitalet de Llobregat','Badalona','Terrassa','Sabadell'] },
        { name: 'Valencia', cities: ['Valencia','Alicante','Elche','Castellón'] },
        { name: 'Sevilla', cities: ['Sevilla','Dos Hermanas','Alcalá de Guadaíra'] },
        { name: 'Vizcaya', cities: ['Bilbao','Barakaldo','Getxo'] },
        { name: 'Málaga', cities: ['Málaga','Marbella','Vélez-Málaga','Torremolinos'] },
        { name: 'Asturias', cities: ['Oviedo','Gijón','Avilés'] },
        { name: 'Zaragoza', cities: ['Zaragoza','Calatayud'] }
      ]
    };

    function provinceOptions(countryCode, selected) {
      const provinces = PROVINCES[countryCode] || [];
      return '<option value="">Seleccione provincia</option>' +
        provinces.map(p => `<option value="${p.name}" ${p.name === selected ? 'selected' : ''}>${p.name}</option>`).join('');
    }

    function cityOptions(countryCode, provinceName, selected) {
      const provinces = PROVINCES[countryCode] || [];
      const prov = provinces.find(p => p.name === provinceName);
      const cities = prov ? prov.cities : [];
      return '<option value="">Seleccione ciudad</option>' +
        cities.map(c => `<option value="${c}" ${c === selected ? 'selected' : ''}>${c}</option>`).join('') +
        '<option value="__other__">Otra...</option>';
    }

    function onCountryChange(countrySelectId, provinceSelectId, citySelectId) {
      const country = document.getElementById(countrySelectId).value;
      const provEl = document.getElementById(provinceSelectId);
      const cityEl = document.getElementById(citySelectId);
      if (provEl) provEl.innerHTML = provinceOptions(country, '');
      if (cityEl) cityEl.innerHTML = '<option value="">Seleccione ciudad</option>';
    }

    function onProvinceChange(countrySelectId, provinceSelectId, citySelectId) {
      const country = document.getElementById(countrySelectId).value;
      const province = document.getElementById(provinceSelectId).value;
      const cityEl = document.getElementById(citySelectId);
      if (cityEl) cityEl.innerHTML = cityOptions(country, province, '');
    }

    function onCityChange(selectEl, inputId) {
      const customInput = document.getElementById(inputId);
      if (selectEl.value === '__other__') {
        if (customInput) { customInput.style.display = ''; customInput.focus(); }
      } else {
        if (customInput) { customInput.style.display = 'none'; customInput.value = ''; }
      }
    }

    const INDUSTRIES = [
      'retail', 'gastronom\u00eda', 'tecnolog\u00eda', 'salud', 'educaci\u00f3n',
      'construcci\u00f3n', 'log\u00edstica', 'manufactura', 'servicios profesionales',
      'agro', 'finanzas', 'turismo', 'medios', 'energ\u00eda', 'otro'
    ];

    function countryOptions(selected) {
      return '<option value="">Seleccione pa\u00eds</option>' +
        COUNTRIES.map(c => `<option value="${c.code}" ${c.code === selected ? 'selected' : ''}>${c.name}</option>`).join('');
    }

    function industryOptions() {
      return '<option value="">Seleccione rubro</option>' +
        INDUSTRIES.map(i => `<option value="${i}">${i.charAt(0).toUpperCase() + i.slice(1)}</option>`).join('');
    }

    function setStep(n) {
      currentStep = n;
      for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById('dot-' + i);
        dot.className = 'step-dot' + (i === n ? ' active' : (i < n ? ' done' : ''));
      }
    }

    // ==================== STEP 1: View Quote ====================
    async function load() {
      if (!TOKEN) return;
      try {
        const r = await fetch(API);
        const d = await r.json();
        if (!d.success) throw new Error(d.error || 'Error');
        quoteData = d.quote;
        renderStep1(d.quote);
      } catch(e) {
        document.getElementById('content').innerHTML =
          '<div class="error-view"><p style="font-size:48px;margin-bottom:12px;">&#9888;</p><p>' + escHtml(e.message) + '</p></div>';
      }
    }

    function escHtml(s) {
      const d = document.createElement('div'); d.textContent = s; return d.innerHTML;
    }

    function renderStep1(q) {
      setStep(1);
      const st = statusMap[q.status] || statusMap.draft;
      const modules = Array.isArray(q.modules_data) ? q.modules_data : (typeof q.modules_data === 'string' ? JSON.parse(q.modules_data) : []);

      let h = '<div class="step active" id="step-1">';
      h += '<div class="info-row"><span class="info-label">N\u00famero</span><span class="info-value">' + escHtml(q.quote_number) + '</span></div>';
      h += '<div class="info-row"><span class="info-label">Empresa</span><span class="info-value">' + escHtml(q.company_name || '') + '</span></div>';
      h += '<div class="info-row"><span class="info-label">Estado</span><span class="status-badge ' + st.cls + '">' + st.label + '</span></div>';
      if (q.valid_until) {
        h += '<div class="info-row"><span class="info-label">V\u00e1lido hasta</span><span class="info-value">' + new Date(q.valid_until).toLocaleDateString('es-AR') + '</span></div>';
      }

      h += '<h3>M\u00f3dulos incluidos</h3>';
      h += '<table><thead><tr><th>M\u00f3dulo</th><th>Precio/mes</th></tr></thead><tbody>';
      modules.forEach(function(m) {
        h += '<tr><td>' + escHtml(m.module_name || m.module_key || '') + '</td><td>USD $' + parseFloat(m.price || 0).toLocaleString('es-AR') + '</td></tr>';
      });
      h += '<tr class="total-row"><td>TOTAL MENSUAL</td><td>USD $' + parseFloat(q.total_amount || 0).toLocaleString('es-AR') + '</td></tr>';
      h += '</tbody></table>';

      if (q.has_trial) {
        h += '<div class="trial-box"><p><strong>&#127873; Trial de 30 d\u00edas 100% bonificado</strong></p><p>Pruebe todos los m\u00f3dulos sin compromiso</p></div>';
      }

      if (q.notes) {
        h += '<div style="margin-top:16px;padding:12px 16px;background:#f8fafc;border-radius:8px;font-size:14px;color:#475569;"><strong>Notas:</strong> ' + escHtml(q.notes) + '</div>';
      }

      h += '<div id="result"></div>';

      if (q.can_accept) {
        h += '<div class="actions">';
        h += '<button class="btn btn-accept" id="btn-accept" onclick="goToStep2()">Aceptar Presupuesto &#8594;</button>';
        h += '<button class="btn btn-reject" onclick="openRejectModal()">Rechazar</button>';
        h += '</div>';
      } else if (q.status === 'accepted' || q.status === 'in_trial' || q.status === 'active') {
        const msg = q.status === 'in_trial' ? 'Presupuesto aceptado. Su trial de 30 d\u00edas est\u00e1 activo.'
          : q.status === 'active' ? 'Este presupuesto est\u00e1 activo.'
          : 'Este presupuesto ya fue aceptado.';
        h += '<div class="result-msg result-ok">' + msg + '</div>';
      } else if (q.status === 'rejected') {
        h += '<div class="result-msg result-err">Este presupuesto fue rechazado.</div>';
      }

      h += '</div>';
      document.getElementById('content').innerHTML = h;
    }

    // ==================== STEP 2: Onboarding Form ====================
    function goToStep2() {
      setStep(2);
      renderStep2();
    }

    function renderStep2() {
      const contactEmail = quoteData.contact_email || '';

      let h = '<div class="step active" id="step-2">';
      h += '<h3 style="margin-top:0;">Ficha de Alta de Empresa</h3>';
      h += '<p style="color:var(--text-light);margin-bottom:24px;font-size:14px;">Complete los datos de su empresa para finalizar la aceptaci\u00f3n del presupuesto.</p>';

      // Section A: Company
      h += '<div class="form-section">';
      h += '<div class="form-section-title">A. Datos de la Empresa</div>';
      h += '<div class="form-grid">';
      h += formField('legal_name', 'Raz\u00f3n Social', 'text', true, '', 'Mi Empresa S.A.');
      h += formField('tax_id', 'CUIT / NIF / Tax ID', 'text', true, '', '30-12345678-9');
      h += formSelect('industry', 'Rubro / Industria', true, industryOptions());
      h += formField('address', 'Direcci\u00f3n fiscal', 'text', true, '', 'Av. Corrientes 1234', 'full');
      h += `<div class="form-group">
        <label>País <span class="req">*</span></label>
        <select name="country" id="f-country" required onchange="onCountryChange('f-country','f-state_province','f-city')">${countryOptions('AR')}</select>
        <span class="field-error" id="err-country">Campo requerido</span>
      </div>`;
      h += `<div class="form-group">
        <label>Provincia / Estado <span class="req">*</span></label>
        <select name="state_province" id="f-state_province" required onchange="onProvinceChange('f-country','f-state_province','f-city')">${provinceOptions('AR', '')}</select>
        <span class="field-error" id="err-state_province">Campo requerido</span>
      </div>`;
      h += `<div class="form-group">
        <label>Ciudad <span class="req">*</span></label>
        <select name="city" id="f-city" required onchange="onCityChange(this,'f-city-custom')"><option value="">Seleccione ciudad</option></select>
        <input type="text" id="f-city-custom" placeholder="Escriba el nombre de la ciudad" style="display:none;margin-top:6px;">
        <span class="field-error" id="err-city">Campo requerido</span>
      </div>`;
      h += formField('postal_code', 'C\u00f3digo Postal', 'text', false);
      h += formField('phone', 'Tel\u00e9fono', 'tel', false, '', '+54 11 4555-1234');
      h += formField('billing_email', 'Email de facturaci\u00f3n', 'email', false, '', 'facturacion@empresa.com');
      h += '</div></div>';

      // Section B: Branches
      h += '<div class="form-section">';
      h += '<div class="form-section-title">B. Sucursales</div>';
      h += '<label style="font-size:13px;font-weight:600;color:#475569;margin-bottom:4px;display:block;">\u00bfCu\u00e1ntas sucursales/locales tiene?</label>';
      h += '<div class="branch-selector" id="branch-selector">';
      for (let i = 1; i <= 5; i++) {
        h += `<div class="branch-opt ${i === 1 ? 'selected' : ''}" data-count="${i}" onclick="selectBranchCount(${i})">${i === 5 ? '5+' : i}</div>`;
      }
      h += '</div>';
      h += '<div id="branch-note" class="branch-note">Se usar\u00e1 la direcci\u00f3n fiscal como sede principal.</div>';
      h += '<div id="branches-container"></div>';
      h += '</div>';

      // Section C: Admin
      h += '<div class="form-section">';
      h += '<div class="form-section-title">C. Datos del Administrador</div>';
      h += '<div class="form-grid">';
      h += formField('admin_full_name', 'Nombre completo', 'text', true);
      h += formField('admin_email', 'Email', 'email', true, contactEmail);
      h += formField('admin_phone', 'Tel\u00e9fono directo', 'tel', false);
      h += '</div></div>';

      h += '<div class="actions">';
      h += '<button class="btn btn-secondary" onclick="goBackToStep1()">&larr; Volver</button>';
      h += '<button class="btn btn-accept" id="btn-confirm" onclick="submitForm()">Confirmar y Aceptar</button>';
      h += '</div>';

      h += '</div>';
      document.getElementById('content').innerHTML = h;
    }

    function formField(name, label, type, required, value, placeholder, extraClass) {
      const cls = extraClass ? ` ${extraClass}` : '';
      return `<div class="form-group${cls}">
        <label>${escHtml(label)}${required ? ' <span class="req">*</span>' : ''}</label>
        <input type="${type}" name="${name}" id="f-${name}" ${required ? 'required' : ''} value="${escHtml(value || '')}" placeholder="${escHtml(placeholder || '')}">
        <span class="field-error" id="err-${name}">Campo requerido</span>
      </div>`;
    }

    function formSelect(name, label, required, options) {
      return `<div class="form-group">
        <label>${escHtml(label)}${required ? ' <span class="req">*</span>' : ''}</label>
        <select name="${name}" id="f-${name}" ${required ? 'required' : ''}>${options}</select>
        <span class="field-error" id="err-${name}">Campo requerido</span>
      </div>`;
    }

    function selectBranchCount(n) {
      selectedBranchCount = n;
      document.querySelectorAll('.branch-opt').forEach(el => {
        el.classList.toggle('selected', parseInt(el.dataset.count) === n);
      });

      const noteEl = document.getElementById('branch-note');
      const container = document.getElementById('branches-container');

      if (n === 1) {
        noteEl.textContent = 'Se usar\u00e1 la direcci\u00f3n fiscal como sede principal.';
        noteEl.style.display = 'block';
        container.innerHTML = '';
      } else {
        noteEl.textContent = 'Puede modificar sucursales despu\u00e9s desde el panel de administraci\u00f3n.';
        noteEl.style.display = 'block';
        let bh = '';
        for (let i = 0; i < n; i++) {
          const isMain = i === 0;
          bh += `<div class="branch-form">
            <div class="branch-form-title">Sucursal ${i + 1} ${isMain ? '(Principal)' : ''}</div>
            <div class="form-grid">
              <div class="form-group full">
                <label>Nombre${isMain ? '' : ''} <span class="req">*</span></label>
                <input type="text" id="br-${i}-name" placeholder="${isMain ? 'Casa Matriz' : 'Sucursal ' + (i + 1)}" value="${isMain ? 'Casa Matriz' : ''}">
              </div>
              <div class="form-group full">
                <label>Direcci\u00f3n</label>
                <input type="text" id="br-${i}-address" placeholder="Direcci\u00f3n de la sucursal">
              </div>
              <div class="form-group">
                <label>País</label>
                <select id="br-${i}-country" onchange="updateBranchTimezone(${i}); onCountryChange('br-${i}-country','br-${i}-province','br-${i}-city')">${countryOptions('AR')}</select>
              </div>
              <div class="form-group">
                <label>Provincia</label>
                <select id="br-${i}-province" onchange="onProvinceChange('br-${i}-country','br-${i}-province','br-${i}-city')">${provinceOptions('AR', '')}</select>
              </div>
              <div class="form-group">
                <label>Ciudad</label>
                <select id="br-${i}-city" onchange="onCityChange(this,'br-${i}-city-custom')"><option value="">Seleccione ciudad</option></select>
                <input type="text" id="br-${i}-city-custom" placeholder="Otra ciudad" style="display:none;margin-top:6px;">
              </div>
              <div class="form-group full">
                <label>Zona horaria</label>
                <input type="text" id="br-${i}-timezone" value="America/Argentina/Buenos_Aires" readonly style="background:#f8fafc;">
              </div>
            </div>
          </div>`;
        }
        container.innerHTML = bh;
      }
    }

    function updateBranchTimezone(idx) {
      const countryCode = document.getElementById(`br-${idx}-country`).value;
      const country = COUNTRIES.find(c => c.code === countryCode);
      if (country) {
        document.getElementById(`br-${idx}-timezone`).value = country.tz;
      }
    }

    function goBackToStep1() {
      renderStep1(quoteData);
    }

    // ==================== SUBMIT FORM ====================
    async function submitForm() {
      // Validate required fields
      const required = [
        { id: 'f-legal_name', name: 'legal_name' },
        { id: 'f-tax_id', name: 'tax_id' },
        { id: 'f-industry', name: 'industry' },
        { id: 'f-address', name: 'address' },
        { id: 'f-city', name: 'city' },
        { id: 'f-state_province', name: 'state_province' },
        { id: 'f-country', name: 'country' },
        { id: 'f-admin_full_name', name: 'admin_full_name' },
        { id: 'f-admin_email', name: 'admin_email' }
      ];

      let valid = true;
      required.forEach(f => {
        const el = document.getElementById(f.id);
        const errEl = document.getElementById('err-' + f.name);
        if (!el || !el.value.trim()) {
          if (el) el.classList.add('invalid');
          if (errEl) errEl.classList.add('show');
          valid = false;
        } else {
          if (el) el.classList.remove('invalid');
          if (errEl) errEl.classList.remove('show');
        }
      });

      // Validar ciudad custom si eligió "Otra..."
      const citySelect = document.getElementById('f-city');
      const cityCustom = document.getElementById('f-city-custom');
      if (citySelect && citySelect.value === '__other__' && (!cityCustom || !cityCustom.value.trim())) {
        cityCustom.classList.add('invalid');
        cityCustom.focus();
        valid = false;
      }

      if (!valid) return;

      // Build payload
      const val = id => (document.getElementById(id) || {}).value || '';
      const cityVal = (selectId, customId) => {
        const v = val(selectId);
        return (v === '__other__') ? val(customId) : v;
      };

      const payload = {
        company: {
          legal_name: val('f-legal_name'),
          tax_id: val('f-tax_id'),
          industry: val('f-industry'),
          address: val('f-address'),
          city: cityVal('f-city', 'f-city-custom'),
          state_province: val('f-state_province'),
          country: val('f-country'),
          postal_code: val('f-postal_code'),
          phone: val('f-phone'),
          billing_email: val('f-billing_email')
        },
        admin: {
          full_name: val('f-admin_full_name'),
          email: val('f-admin_email'),
          phone: val('f-admin_phone')
        },
        branches: []
      };

      if (selectedBranchCount === 1) {
        // Single branch from fiscal address
        payload.branches = [{
          name: 'Casa Matriz',
          address: val('f-address'),
          city: cityVal('f-city', 'f-city-custom'),
          country: val('f-country'),
          timezone: (COUNTRIES.find(c => c.code === val('f-country')) || {}).tz || 'America/Argentina/Buenos_Aires',
          is_main: true
        }];
      } else {
        for (let i = 0; i < selectedBranchCount; i++) {
          const name = val(`br-${i}-name`);
          if (!name.trim()) {
            alert(`Ingrese el nombre de la sucursal ${i + 1}`);
            return;
          }
          payload.branches.push({
            name,
            address: val(`br-${i}-address`),
            city: cityVal(`br-${i}-city`, `br-${i}-city-custom`),
            country: val(`br-${i}-country`),
            timezone: val(`br-${i}-timezone`),
            is_main: i === 0
          });
        }
      }

      // Submit
      const btn = document.getElementById('btn-confirm');
      btn.disabled = true;
      btn.innerHTML = 'Procesando...';

      try {
        const r = await fetch(API + '/accept', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const d = await r.json();
        if (d.success) {
          renderStep3(d);
        } else {
          throw new Error(d.error || 'Error al procesar');
        }
      } catch(e) {
        btn.disabled = false;
        btn.innerHTML = 'Confirmar y Aceptar';
        alert('Error: ' + e.message);
      }
    }

    // ==================== STEP 3: Confirmation ====================
    function renderStep3(result) {
      setStep(3);
      const hasTrial = quoteData && quoteData.has_trial;

      let h = '<div class="step active" id="step-3" style="text-align:center;padding:40px 20px;">';
      h += '<div class="confirmation-icon">&#9989;</div>';
      h += '<div class="confirmation-title">Presupuesto aceptado</div>';

      if (hasTrial) {
        h += '<p class="confirmation-text">Su <strong>trial de 30 d\u00edas 100% bonificado</strong> ha sido activado. Podr\u00e1 utilizar todos los m\u00f3dulos contratados sin costo durante este per\u00edodo.</p>';
      } else {
        h += '<p class="confirmation-text">El presupuesto ha sido aceptado y activado correctamente.</p>';
      }

      h += '<p class="confirmation-text" style="margin-top:16px;">Nos pondremos en contacto a la brevedad para los pr\u00f3ximos pasos de configuraci\u00f3n de su cuenta.</p>';

      if (result.message) {
        h += '<div class="result-msg result-ok" style="margin-top:24px;">' + escHtml(result.message) + '</div>';
      }

      h += '</div>';
      document.getElementById('content').innerHTML = h;
    }

    // ==================== REJECT ====================
    function openRejectModal() {
      document.getElementById('reject-modal').classList.add('show');
    }
    function closeRejectModal() {
      document.getElementById('reject-modal').classList.remove('show');
    }

    async function confirmReject() {
      const reason = document.getElementById('reject-reason').value;
      try {
        const r = await fetch(API + '/reject', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });
        const d = await r.json();
        closeRejectModal();
        if (d.success) {
          document.getElementById('content').innerHTML =
            '<div style="text-align:center;padding:40px 20px;">' +
            '<div style="font-size:64px;margin-bottom:16px;">&#128172;</div>' +
            '<div class="confirmation-title">Presupuesto rechazado</div>' +
            '<p class="confirmation-text">Gracias por su respuesta. Si cambia de opini\u00f3n, no dude en contactarnos.</p>' +
            '</div>';
        } else {
          throw new Error(d.error || 'Error');
        }
      } catch(e) {
        closeRejectModal();
        alert('Error: ' + e.message);
      }
    }

    // Init
    load();
  </script>
</body>
</html>
