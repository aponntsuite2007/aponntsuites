<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Opini贸n | APONNT</title>
    <link rel="icon" type="image/png" href="/images/aponnt-favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            padding: 40px;
            text-align: center;
            color: white;
        }

        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; }

        .body { padding: 40px; }

        .thank-you {
            text-align: center;
            margin-bottom: 30px;
        }

        .thank-you h2 {
            color: #1f2937;
            margin-bottom: 10px;
        }

        .thank-you p {
            color: #6b7280;
        }

        .rating-section {
            margin-bottom: 30px;
        }

        .rating-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
            display: block;
        }

        .stars {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .star {
            font-size: 36px;
            color: #d1d5db;
            cursor: pointer;
            transition: all 0.2s;
        }

        .star:hover, .star.active {
            color: #fbbf24;
            transform: scale(1.1);
        }

        .feedback-section {
            margin-bottom: 25px;
        }

        .feedback-section label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 10px;
        }

        .feedback-section textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.2s;
        }

        .feedback-section textarea:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        .checkbox-group {
            margin-bottom: 25px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .checkbox-option:hover {
            background: #f3f4f6;
        }

        .checkbox-option input {
            width: 20px;
            height: 20px;
            accent-color: #8b5cf6;
        }

        .btn-submit {
            width: 100%;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .completed {
            text-align: center;
            padding: 60px 40px;
        }

        .completed i {
            font-size: 80px;
            color: #22c55e;
            margin-bottom: 20px;
        }

        .loading { text-align: center; padding: 60px; }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container" id="container">
        <div class="loading">
            <div class="spinner"></div>
            <p>Cargando...</p>
        </div>
    </div>

    <script>
        const pathParts = window.location.pathname.split('/');
        const token = pathParts[pathParts.length - 1];

        let surveyData = null;
        let satisfactionRating = 0;
        let vendorRating = 0;

        async function init() {
            try {
                const response = await fetch(`/api/sales-orchestration/satisfaction/${token}`);
                const result = await response.json();

                if (!result.success) {
                    showError(result.error);
                    return;
                }

                if (result.completed) {
                    showCompleted(result.message);
                    return;
                }

                surveyData = result;
                renderSurvey();
            } catch (error) {
                showError('Error de conexi贸n');
            }
        }

        function renderSurvey() {
            const { attendee } = surveyData;

            document.getElementById('container').innerHTML = `
                <div class="header">
                    <h1> Gracias por tu tiempo</h1>
                    <p>Tu opini贸n es muy valiosa para nosotros</p>
                </div>

                <div class="body">
                    <div class="thank-you">
                        <h2>Hola ${attendee.name.split(' ')[0]}</h2>
                        <p>Nos encantar铆a saber qu茅 te pareci贸 la reuni贸n</p>
                    </div>

                    <!-- Calificaci贸n general -->
                    <div class="rating-section">
                        <span class="rating-label">驴C贸mo calificar铆as la reuni贸n en general?</span>
                        <div class="stars" id="satisfaction-stars">
                            ${[1,2,3,4,5].map(n => `
                                <span class="star" data-value="${n}" onclick="setSatisfactionRating(${n})">
                                    <i class="fas fa-star"></i>
                                </span>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Calificaci贸n del vendedor -->
                    <div class="rating-section">
                        <span class="rating-label">驴C贸mo calificar铆as a ${attendee.vendorName || 'el presentador'}?</span>
                        <div class="stars" id="vendor-stars">
                            ${[1,2,3,4,5].map(n => `
                                <span class="star" data-value="${n}" onclick="setVendorRating(${n})">
                                    <i class="fas fa-star"></i>
                                </span>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Feedback -->
                    <div class="feedback-section">
                        <label>驴Alg煤n comentario o sugerencia? (opcional)</label>
                        <textarea id="feedback" placeholder="Cu茅ntanos qu茅 podemos mejorar..."></textarea>
                    </div>

                    <!-- Opciones adicionales -->
                    <div class="checkbox-group">
                        <label class="checkbox-option">
                            <input type="checkbox" id="has-questions">
                            <span>Me quedaron algunas dudas que me gustar铆a aclarar</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" id="needs-followup">
                            <span>Me gustar铆a una reuni贸n de seguimiento</span>
                        </label>
                    </div>

                    <button class="btn-submit" onclick="submit()" id="submit-btn">
                        <i class="fas fa-paper-plane"></i> Enviar Opini贸n
                    </button>
                </div>
            `;
        }

        function setSatisfactionRating(value) {
            satisfactionRating = value;
            updateStars('satisfaction-stars', value);
        }

        function setVendorRating(value) {
            vendorRating = value;
            updateStars('vendor-stars', value);
        }

        function updateStars(containerId, value) {
            document.querySelectorAll(`#${containerId} .star`).forEach(star => {
                star.classList.toggle('active', parseInt(star.dataset.value) <= value);
            });
        }

        async function submit() {
            if (satisfactionRating === 0) {
                alert('Por favor califica la reuni贸n');
                return;
            }

            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

            const data = {
                satisfactionRating,
                vendorRating: vendorRating || null,
                feedback: document.getElementById('feedback').value,
                hasQuestions: document.getElementById('has-questions').checked,
                needsFollowup: document.getElementById('needs-followup').checked
            };

            try {
                const response = await fetch(`/api/sales-orchestration/satisfaction/${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showCompleted(result.message);
                } else {
                    alert('Error: ' + result.error);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Opini贸n';
                }
            } catch (error) {
                alert('Error de conexi贸n');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Opini贸n';
            }
        }

        function showCompleted(message) {
            document.getElementById('container').innerHTML = `
                <div class="header">
                    <h1> APONNT</h1>
                    <p>Sistema de Gesti贸n Empresarial</p>
                </div>
                <div class="completed">
                    <i class="fas fa-check-circle"></i>
                    <h2>隆Gracias!</h2>
                    <p>${message || 'Tu opini贸n ha sido registrada.'}</p>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('container').innerHTML = `
                <div class="header">
                    <h1> APONNT</h1>
                </div>
                <div class="completed">
                    <i class="fas fa-exclamation-circle" style="color: #ef4444;"></i>
                    <h2>Error</h2>
                    <p>${message}</p>
                </div>
            `;
        }

        init();
    </script>
</body>
</html>
