#!/usr/bin/env node
/**
 * ============================================================================
 * DEMO: DYNAMIC WORKFLOW INTROSPECTION
 * ============================================================================
 *
 * Demuestra cรณmo el sistema detecta cambios en el cรณdigo y regenera
 * el workflow automรกticamente.
 *
 * USO:
 *   node scripts/demo-dynamic-workflow-introspection.js
 *
 * MODO WATCH:
 *   node scripts/demo-dynamic-workflow-introspection.js --watch
 *
 * @version 1.0.0
 * @date 2025-12-14
 * ============================================================================
 */

const path = require('path');
const fs = require('fs');
const DynamicWorkflowIntrospector = require('../src/services/DynamicWorkflowIntrospector');

console.log('');
console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
console.log('โ         ๐ DYNAMIC WORKFLOW INTROSPECTION DEMO                             โ');
console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
console.log('');

const introspector = new DynamicWorkflowIntrospector();

// Archivos del workflow de fichaje
const workflowFiles = [
    path.join(__dirname, '../src/services/LateArrivalAuthorizationService.js'),
    path.join(__dirname, '../src/services/CalendarioLaboralService.js'),
    path.join(__dirname, '../src/services/ShiftCalculatorService.js'),
    path.join(__dirname, '../src/services/AttendanceWorkflowService.js')
];

// Archivo principal a analizar
const mainServiceFile = path.join(__dirname, '../src/services/LateArrivalAuthorizationService.js');

async function runDemo() {
    console.log('๐ Archivos del workflow:');
    workflowFiles.forEach(f => {
        const exists = fs.existsSync(f);
        console.log(`   ${exists ? 'โ' : 'โ'} ${path.basename(f)}`);
    });
    console.log('');

    // ========================================================================
    // PASO 1: Anรกlisis inicial
    // ========================================================================
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
    console.log('PASO 1: Analizando workflow desde cรณdigo fuente...');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');

    try {
        const workflow = await introspector.analyzeWorkflow(
            mainServiceFile,
            'late-arrival-authorization'
        );

        console.log('');
        console.log(`๐ Workflow detectado: ${workflow.name}`);
        console.log(`   Versiรณn: ${workflow.version}`);
        console.log(`   Stages: ${workflow.stageCount}`);
        console.log(`   Auto-generado: ${workflow.isAutoGenerated ? 'Sร' : 'NO'}`);
        console.log('');

        console.log('๐ Stages detectados:');
        workflow.stages.forEach((stage, i) => {
            console.log(`   ${i + 1}. ${stage.name}`);
            console.log(`      ID: ${stage.id}`);
            console.log(`      Fuente: ${stage.source.function}() lรญnea ${stage.source.line}`);
            if (stage.callsServices.length > 0) {
                console.log(`      Llama a: ${stage.callsServices.join(', ')}`);
            }
            if (stage.validations.length > 0) {
                console.log(`      Validaciones: ${stage.validations.length}`);
            }
        });

        console.log('');
        console.log('๐ Dependencias externas:');
        workflow.dependencies.external.forEach(dep => {
            console.log(`   - ${dep.name}${dep.isCore ? ' (core)' : ''}`);
        });

        // ========================================================================
        // PASO 2: Generar documentaciรณn automรกtica
        // ========================================================================
        console.log('');
        console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
        console.log('PASO 2: Generando documentaciรณn automรกtica...');
        console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');

        const doc = introspector.generateDocumentation(workflow);
        const docPath = path.join(__dirname, '../docs/WORKFLOW-LATE-AUTHORIZATION-AUTO.md');
        fs.writeFileSync(docPath, doc);
        console.log(`   โ Documentaciรณn guardada en: ${docPath}`);

        // ========================================================================
        // PASO 3: Modo watch (si se solicita)
        // ========================================================================
        if (process.argv.includes('--watch')) {
            console.log('');
            console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
            console.log('PASO 3: Modo WATCH activado - Esperando cambios...');
            console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
            console.log('');
            console.log('๐๏ธ Monitoreando archivos. Edita cualquiera para ver regeneraciรณn automรกtica.');
            console.log('   Presiona Ctrl+C para salir.');
            console.log('');

            const watcher = introspector.watchForChanges(
                workflowFiles,
                'late-arrival-authorization',
                (error, newWorkflow, changedFile) => {
                    if (error) {
                        console.error(`โ Error re-analizando: ${error.message}`);
                        return;
                    }

                    console.log('');
                    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
                    console.log('โ              ๐ CAMBIO DETECTADO - WORKFLOW REGENERADO                     โ');
                    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
                    console.log('');
                    console.log(`   ๐ Archivo: ${path.basename(changedFile)}`);
                    console.log(`   โฐ Hora: ${new Date().toLocaleTimeString()}`);
                    console.log(`   ๐ Nuevo workflow: ${newWorkflow.stageCount} stages`);
                    console.log('');

                    // Comparar con versiรณn anterior
                    const comparison = introspector.compareWorkflows(workflow, newWorkflow);
                    if (comparison.hasChanges) {
                        console.log('   ๐ Cambios detectados:');
                        console.log(`      + Agregados: ${comparison.summary.added}`);
                        console.log(`      - Eliminados: ${comparison.summary.removed}`);
                        console.log(`      ~ Modificados: ${comparison.summary.modified}`);
                        console.log(`      = Sin cambios: ${comparison.summary.unchanged}`);

                        if (comparison.details.added.length > 0) {
                            console.log('');
                            console.log('   ๐ Stages nuevos:');
                            comparison.details.added.forEach(s => {
                                console.log(`      + ${s.name} (${s.id})`);
                            });
                        }

                        if (comparison.details.removed.length > 0) {
                            console.log('');
                            console.log('   ๐๏ธ Stages eliminados:');
                            comparison.details.removed.forEach(s => {
                                console.log(`      - ${s.name} (${s.id})`);
                            });
                        }
                    } else {
                        console.log('   โน๏ธ Estructura del workflow sin cambios');
                    }

                    console.log('');
                    console.log('๐๏ธ Continuando monitoreo...');
                }
            );

            // Mantener proceso vivo
            process.on('SIGINT', () => {
                console.log('\n\n๐ Deteniendo watcher...');
                watcher.stop();
                process.exit(0);
            });

        } else {
            // ========================================================================
            // PASO 3 (sin watch): Mostrar grafo de flujo
            // ========================================================================
            console.log('');
            console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
            console.log('PASO 3: Grafo de flujo detectado');
            console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');

            console.log('');
            console.log('๐ Nodos:');
            workflow.flowGraph.nodes.forEach(node => {
                console.log(`   [${node.type.toUpperCase()}] ${node.name}`);
            });

            console.log('');
            console.log('๐ Conexiones:');
            workflow.flowGraph.edges.forEach(edge => {
                const fromNode = workflow.flowGraph.nodes.find(n => n.id === edge.from);
                const toNode = workflow.flowGraph.nodes.find(n => n.id === edge.to);
                const edgeType = edge.type === 'conditional' ? `โโ(${edge.condition})โโโบ` : 'โโโโโโโโโบ';
                console.log(`   ${fromNode?.name || edge.from} ${edgeType} ${toNode?.name || edge.to}`);
            });

            console.log('');
            console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
            console.log('๐ก Para activar modo watch: node scripts/demo-dynamic-workflow-introspection.js --watch');
            console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
        }

    } catch (error) {
        console.error(`โ Error: ${error.message}`);
        console.error(error.stack);
    }
}

// ============================================================================
// Demostraciรณn de la diferencia ESTรTICO vs DINรMICO
// ============================================================================
console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
console.log('โ DIFERENCIA: ESTรTICO vs DINรMICO                                           โ');
console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค');
console.log('โ                                                                             โ');
console.log('โ ANTES (AttendanceWorkflowService.js - ESTรTICO):                            โ');
console.log('โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                      โ');
console.log('โ โ static STAGES = {                  โ  โ Definido a mano                   โ');
console.log('โ โ   BIOMETRIC_CAPTURE: {...},        โ    NO cambia solo                    โ');
console.log('โ โ   IDENTIFICATION: {...},           โ    cuando editas cรณdigo              โ');
console.log('โ โ }                                  โ                                      โ');
console.log('โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                      โ');
console.log('โ                                                                             โ');
console.log('โ AHORA (DynamicWorkflowIntrospector - DINรMICO):                             โ');
console.log('โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                      โ');
console.log('โ โ analyzeWorkflow(file) โโโโโโโโโโโโบ โ  โ Analiza cรณdigo real               โ');
console.log('โ โ   1. Lee cรณdigo fuente             โ    Detecta funciones                 โ');
console.log('โ โ   2. Extrae funciones              โ    Construye workflow                โ');
console.log('โ โ   3. Detecta validaciones          โ    SE REGENERA AUTOMรTICO            โ');
console.log('โ โ   4. Traza dependencias            โ    cuando cambias cรณdigo             โ');
console.log('โ โ   5. Construye workflow            โ                                      โ');
console.log('โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                      โ');
console.log('โ                                                                             โ');
console.log('โ RESULTADO:                                                                  โ');
console.log('โ   Hoy: workflow = A โ B โ C                                                 โ');
console.log('โ   Maรฑana editas cรณdigo, agregas paso K                                      โ');
console.log('โ   Brain detecta: workflow = A โ B โ K โ C                                   โ');
console.log('โ                                                                             โ');
console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
console.log('');

runDemo();
