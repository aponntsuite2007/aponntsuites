/**
 * SCRIPT: Execute Cleanup Plan
 * PURPOSE: Execute the archival plan generated by categorize-root-scripts-v2.js
 * SAFETY: Creates backups, validates before moving, logs all operations
 */

const fs = require('fs');
const path = require('path');

const backendRoot = path.join(__dirname, '..');
const reportPath = path.join(backendRoot, 'archive/root-scripts-categorization-v2.json');

// Read the categorization report
if (!fs.existsSync(reportPath)) {
  console.error('‚ùå ERROR: Categorization report not found. Run categorize-root-scripts-v2.js first.');
  process.exit(1);
}

const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
const categories = report.detailedCategorization;

// Statistics
const stats = {
  moved: 0,
  failed: 0,
  skipped: 0,
  operations: []
};

// Helper: Move file safely
function moveFileSafely(filename, fromDir, toSubDir) {
  const sourcePath = path.join(fromDir, filename);
  const targetDir = path.join(backendRoot, toSubDir);
  const targetPath = path.join(targetDir, filename);

  try {
    // Validate source exists
    if (!fs.existsSync(sourcePath)) {
      stats.skipped++;
      stats.operations.push({ file: filename, status: 'SKIPPED', reason: 'Source not found' });
      return false;
    }

    // Ensure target directory exists
    if (!fs.existsSync(targetDir)) {
      fs.mkdirSync(targetDir, { recursive: true });
    }

    // Check if target already exists
    if (fs.existsSync(targetPath)) {
      stats.skipped++;
      stats.operations.push({ file: filename, status: 'SKIPPED', reason: 'Target already exists' });
      return false;
    }

    // Move file
    fs.renameSync(sourcePath, targetPath);
    stats.moved++;
    stats.operations.push({ file: filename, status: 'MOVED', from: sourcePath, to: targetPath });
    return true;

  } catch (error) {
    stats.failed++;
    stats.operations.push({ file: filename, status: 'FAILED', error: error.message });
    return false;
  }
}

console.log('\nüöÄ EXECUTING ROOT SCRIPTS CLEANUP PLAN');
console.log('=' .repeat(70));

// PHASE 1: Move Claude integration scripts
console.log('\nüìÅ PHASE 1: Moving Claude Code integration scripts...');
const claudeFiles = categories.CLAUDE_INTEGRATION.files;
claudeFiles.forEach(file => {
  const success = moveFileSafely(file, backendRoot, 'scripts/claude-integration/');
  console.log(`  ${success ? '‚úÖ' : '‚è≠Ô∏è '} ${file}`);
});

// PHASE 2: Archive safe diagnostic scripts (LOW RISK)
console.log('\nüì¶ PHASE 2: Archiving safe diagnostic scripts (LOW RISK)...');
const safeScripts = [
  ...categories.DIAGNOSTIC_CHECK.files.map(f => ({ file: f, dest: categories.DIAGNOSTIC_CHECK.destination })),
  ...categories.DIAGNOSTIC_DEBUG.files.map(f => ({ file: f, dest: categories.DIAGNOSTIC_DEBUG.destination })),
  ...categories.DIAGNOSTIC_ANALYZE.files.map(f => ({ file: f, dest: categories.DIAGNOSTIC_ANALYZE.destination })),
  ...categories.TEST_RUN.files.map(f => ({ file: f, dest: categories.TEST_RUN.destination })),
  ...categories.DEMO_SCRIPTS.files.map(f => ({ file: f, dest: categories.DEMO_SCRIPTS.destination }))
];

safeScripts.forEach(({ file, dest }) => {
  const success = moveFileSafely(file, backendRoot, dest);
  console.log(`  ${success ? '‚úÖ' : '‚è≠Ô∏è '} ${file} ‚Üí ${dest}`);
});

// PHASE 3: Archive medium-risk scripts
console.log('\nüì¶ PHASE 3: Archiving medium-risk scripts...');
const mediumRiskScripts = [
  ...categories.ACTIVATION.files.map(f => ({ file: f, dest: categories.ACTIVATION.destination })),
  ...categories.MIGRATION.files.map(f => ({ file: f, dest: categories.MIGRATION.destination })),
  ...categories.FIX_REPAIR.files.map(f => ({ file: f, dest: categories.FIX_REPAIR.destination })),
  ...categories.CLEANUP.files.map(f => ({ file: f, dest: categories.CLEANUP.destination })),
  ...categories.CREATE_SEED.files.map(f => ({ file: f, dest: categories.CREATE_SEED.destination }))
];

mediumRiskScripts.forEach(({ file, dest }) => {
  const success = moveFileSafely(file, backendRoot, dest);
  console.log(`  ${success ? '‚úÖ' : '‚è≠Ô∏è '} ${file} ‚Üí ${dest}`);
});

// PHASE 4: Move uncategorized files for manual review
console.log('\n‚ùì PHASE 4: Moving UNCATEGORIZED files for manual review...');
categories.UNCATEGORIZED.files.forEach(file => {
  const success = moveFileSafely(file, backendRoot, categories.UNCATEGORIZED.destination);
  console.log(`  ${success ? '‚úÖ' : '‚è≠Ô∏è '} ${file}`);
});

// SUMMARY
console.log('\n' + '=' .repeat(70));
console.log('üìä CLEANUP SUMMARY');
console.log('=' .repeat(70));
console.log(`‚úÖ Files moved: ${stats.moved}`);
console.log(`‚è≠Ô∏è  Files skipped: ${stats.skipped}`);
console.log(`‚ùå Files failed: ${stats.failed}`);
console.log(`üìù Total operations: ${stats.operations.length}`);

// Save operation log
const logPath = path.join(backendRoot, 'archive/cleanup-operations-log.json');
fs.writeFileSync(logPath, JSON.stringify({
  executionDate: new Date().toISOString(),
  stats,
  operations: stats.operations
}, null, 2));

console.log(`\nüìÑ Operation log saved to: ${logPath}`);

// List remaining files in root
const remainingFiles = fs.readdirSync(backendRoot).filter(f => f.endsWith('.js'));
console.log(`\nüìÇ Remaining .js files in backend root: ${remainingFiles.length}`);
remainingFiles.forEach(f => {
  const isCritical = categories.CRITICAL_KEEP.files.includes(f);
  console.log(`  ${isCritical ? 'üîí' : '‚ö†Ô∏è '} ${f}`);
});

console.log('\n‚úÖ CLEANUP PLAN EXECUTION COMPLETE!\n');
