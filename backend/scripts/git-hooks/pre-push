#!/bin/bash

# ğŸ›¡ï¸ PRE-PUSH HOOK - BLOQUEA PUSHES PELIGROSOS
# VersiÃ³n: 1.0
# Fecha: 2026-01-04

# Este hook se ejecuta ANTES de cada git push
# BLOQUEA el push si se intenta pushear a master sin estar en main

CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
CHANGES=$(git status --porcelain)

# Leer quÃ© ramas se estÃ¡n pusheando
while read local_ref local_sha remote_ref remote_sha
do
    REMOTE_BRANCH=$(echo $remote_ref | sed 's/refs\/heads\///')

    # Si se intenta pushear a master
    if [ "$REMOTE_BRANCH" == "master" ]; then

        # Y NO estamos en main
        if [ "$CURRENT_BRANCH" != "main" ]; then
            echo ""
            echo "ğŸš¨ ============================================== ğŸš¨"
            echo "ğŸš¨  PUSH BLOQUEADO - PROTECCIÃ“N ACTIVADA        ğŸš¨"
            echo "ğŸš¨ ============================================== ğŸš¨"
            echo ""
            echo "âŒ NO podÃ©s pushear a 'master' desde '$CURRENT_BRANCH'"
            echo ""
            echo "ğŸ“‹ REGLA: Solo se puede pushear a master desde main"
            echo ""
            echo "âœ… SOLUCIÃ“N:"
            echo ""
            echo "   1. CambiÃ¡ a main (solo si NO tenÃ©s cambios sin commitear):"
            echo "      git checkout main"
            echo ""
            echo "   2. PusheÃ¡ de main a master SIN hacer checkout:"
            echo "      git push origin main:master --force-with-lease"
            echo ""
            echo "   3. O usÃ¡ el script seguro:"
            echo "      npm run deploy:safe"
            echo ""

            exit 1  # BLOQUEAR el push
        fi

        # Si estamos en main, verificar que no haya cambios sin commitear
        if [ -n "$CHANGES" ]; then
            echo ""
            echo "ğŸš¨ ============================================== ğŸš¨"
            echo "ğŸš¨  PUSH BLOQUEADO - CAMBIOS SIN COMMITEAR      ğŸš¨"
            echo "ğŸš¨ ============================================== ğŸš¨"
            echo ""
            echo "âŒ Hay cambios sin commitear"
            echo ""
            echo "ğŸ“Š Cambios pendientes:"
            git status --short
            echo ""
            echo "âœ… SOLUCIÃ“N: CommiteÃ¡ primero"
            echo ""
            echo "   git add -A"
            echo "   git commit -m \"Tu mensaje\""
            echo ""

            exit 1  # BLOQUEAR el push
        fi
    fi
done

# Si todo estÃ¡ OK, permitir el push
exit 0
