#!/bin/bash

# ğŸ›¡ï¸ GIT SAFE - Wrapper seguro para comandos git
# VersiÃ³n: 1.0
# Fecha: 2026-01-04
# Uso: git-safe checkout <branch>

COMMAND=$1
shift
ARGS=$@

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Verificar cambios pendientes
check_uncommitted_changes() {
    CHANGES=$(git status --porcelain)

    if [ -n "$CHANGES" ]; then
        echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${RED}â•‘   ğŸš¨ BLOQUEADO: Hay cambios sin commitear               â•‘${NC}"
        echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo -e "${YELLOW}ğŸ“Š Cambios pendientes:${NC}"
        git status --short
        echo ""
        echo -e "${GREEN}âœ… SOLUCIÃ“N: CommiteÃ¡ primero${NC}"
        echo ""
        echo "   git add -A"
        echo "   git commit -m \"Tu mensaje\""
        echo ""
        return 1
    fi

    return 0
}

case "$COMMAND" in
    checkout|switch|co)
        # Verificar cambios antes de permitir checkout
        if ! check_uncommitted_changes; then
            exit 1
        fi

        echo -e "${GREEN}âœ… No hay cambios sin commitear${NC}"
        echo -e "${BLUE}   Ejecutando: git checkout $ARGS${NC}"
        git checkout $ARGS
        ;;

    push)
        # Verificar cambios antes de push
        if ! check_uncommitted_changes; then
            exit 1
        fi

        CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

        # Si se intenta pushear a master y no estamos en main
        if [[ "$ARGS" == *"master"* ]] && [ "$CURRENT_BRANCH" != "main" ]; then
            echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
            echo -e "${RED}â•‘   ğŸš¨ BLOQUEADO: No podÃ©s pushear a master desde $CURRENT_BRANCH    â•‘${NC}"
            echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
            echo ""
            echo -e "${GREEN}âœ… SOLUCIÃ“N: UsÃ¡ el deploy seguro${NC}"
            echo ""
            echo "   git safe-deploy"
            echo "   npm run deploy:safe"
            echo ""
            exit 1
        fi

        echo -e "${GREEN}âœ… Push seguro${NC}"
        git push $ARGS
        ;;

    stash)
        echo -e "${YELLOW}âš ï¸  ADVERTENCIA: Stash es peligroso${NC}"
        echo ""
        echo "   Mejor hacÃ© commit en vez de stash"
        echo ""
        read -p "Â¿Continuar con stash? (s/n): " -n 1 -r
        echo ""

        if [[ $REPLY =~ ^[Ss]$ ]]; then
            git stash $ARGS
        else
            echo "Cancelado"
        fi
        ;;

    *)
        echo -e "${YELLOW}Comando no implementado en git-safe: $COMMAND${NC}"
        echo "Ejecutando directamente: git $COMMAND $ARGS"
        git $COMMAND $ARGS
        ;;
esac
