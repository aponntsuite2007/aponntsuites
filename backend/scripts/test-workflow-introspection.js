#!/usr/bin/env node
/**
 * ============================================================================
 * TEST: WORKFLOW INTROSPECTION DINรMICO
 * ============================================================================
 *
 * Demuestra cรณmo el sistema regenera workflows automรกticamente cuando
 * cambia el cรณdigo fuente.
 *
 * USO:
 *   node scripts/test-workflow-introspection.js
 *
 * @version 1.0.0
 * @date 2025-12-14
 * ============================================================================
 */

const path = require('path');
const fs = require('fs');

console.log('');
console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
console.log('โ     ๐ง TEST: WORKFLOW INTROSPECTION DINรMICO                               โ');
console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
console.log('');

async function runTest() {
    // ========================================================================
    // PASO 1: Estado inicial
    // ========================================================================
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
    console.log('PASO 1: Verificar estado inicial');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');

    const workflowFile = path.join(__dirname, '../src/services/AttendanceWorkflowService.js');

    if (fs.existsSync(workflowFile)) {
        const content = fs.readFileSync(workflowFile, 'utf8');
        const isAutoGenerated = content.includes('AUTO-GENERADO');
        const stagesMatch = content.match(/static\s+STAGES\s*=\s*\{/);

        console.log(`   ๐ AttendanceWorkflowService.js existe: โ`);
        console.log(`   ๐ค Es auto-generado: ${isAutoGenerated ? 'โ' : 'โ (manual)'}`);
        console.log(`   ๐ Tiene static STAGES: ${stagesMatch ? 'โ' : 'โ'}`);
    } else {
        console.log(`   ๐ AttendanceWorkflowService.js: โ No existe`);
    }

    // ========================================================================
    // PASO 2: Ejecutar WorkflowAutoGenerator
    // ========================================================================
    console.log('');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
    console.log('PASO 2: Ejecutar WorkflowAutoGenerator');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');

    try {
        const WorkflowAutoGenerator = require('../src/services/WorkflowAutoGenerator');
        const generator = new WorkflowAutoGenerator();

        console.log('   ๐ Analizando cรณdigo fuente...');
        const result = await generator.regenerateIfChanged();

        if (result.regenerated) {
            console.log(`   โ Workflow regenerado!`);
            console.log(`      - Stages: ${result.stagesCount}`);
            console.log(`      - Timestamp: ${result.timestamp}`);
        } else {
            console.log(`   โน๏ธ ${result.reason}`);
        }
    } catch (error) {
        console.error(`   โ Error: ${error.message}`);
    }

    // ========================================================================
    // PASO 3: Simular cambio en cรณdigo fuente
    // ========================================================================
    console.log('');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
    console.log('PASO 3: Simular cambio en cรณdigo fuente');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');

    const testServiceFile = path.join(__dirname, '../src/services/LateArrivalAuthorizationService.js');

    if (fs.existsSync(testServiceFile)) {
        // Leer contenido actual
        const originalContent = fs.readFileSync(testServiceFile, 'utf8');

        // Agregar un comentario al final (cambio mรญnimo)
        const timestamp = new Date().toISOString();
        const modifiedContent = originalContent + `\n// Test introspection: ${timestamp}\n`;

        // Guardar cambio
        fs.writeFileSync(testServiceFile, modifiedContent);
        console.log(`   ๐ Archivo modificado: LateArrivalAuthorizationService.js`);
        console.log(`   ๐ Agregado comentario de test`);

        // Regenerar workflow
        console.log('   ๐ Regenerando workflow...');

        try {
            const WorkflowAutoGenerator = require('../src/services/WorkflowAutoGenerator');
            const generator = new WorkflowAutoGenerator();

            // Forzar recarga del archivo
            generator.fileHashes.clear();

            const result = await generator.regenerateIfChanged();

            if (result.regenerated) {
                console.log(`   โ Workflow regenerado automรกticamente!`);
                console.log(`      - Stages: ${result.stagesCount}`);
            }
        } catch (error) {
            console.error(`   โ Error regenerando: ${error.message}`);
        }

        // Restaurar archivo original
        fs.writeFileSync(testServiceFile, originalContent);
        console.log(`   ๐ Archivo restaurado a estado original`);

    } else {
        console.log(`   โ๏ธ LateArrivalAuthorizationService.js no encontrado`);
    }

    // ========================================================================
    // PASO 4: Verificar que Brain detecta el workflow
    // ========================================================================
    console.log('');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
    console.log('PASO 4: Verificar detecciรณn por Brain');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');

    try {
        const EcosystemBrainService = require('../src/services/EcosystemBrainService');
        const brain = new EcosystemBrainService();

        console.log('   ๐ง Ejecutando Brain.getWorkflowsConnected()...');

        const { workflows, source } = await brain.getWorkflowsConnected();

        console.log(`   ๐ Source: ${source}`);
        console.log(`   ๐ Workflows detectados: ${workflows.length}`);

        // Buscar el workflow de fichaje
        const attendanceWorkflow = workflows.find(w =>
            w.name.toLowerCase().includes('attendance') ||
            w.name.toLowerCase().includes('fichaje')
        );

        if (attendanceWorkflow) {
            console.log('');
            console.log('   โ Workflow de Fichaje DETECTADO:');
            console.log(`      - ID: ${attendanceWorkflow.id}`);
            console.log(`      - Nombre: ${attendanceWorkflow.displayName || attendanceWorkflow.name}`);
            console.log(`      - Tipo: ${attendanceWorkflow.type}`);
            console.log(`      - Stages: ${attendanceWorkflow.stageCount}`);
            console.log(`      - Fuente: ${attendanceWorkflow.source}`);

            if (attendanceWorkflow.stages && attendanceWorkflow.stages.length > 0) {
                console.log('');
                console.log('   ๐ Primeros 5 stages:');
                attendanceWorkflow.stages.slice(0, 5).forEach((stage, i) => {
                    console.log(`      ${i + 1}. ${stage.name} (${stage.code})`);
                });
            }
        } else {
            console.log('   โ๏ธ Workflow de fichaje no detectado');
            console.log('   ๐ก Workflows disponibles:');
            workflows.forEach(w => console.log(`      - ${w.name}`));
        }

    } catch (error) {
        console.error(`   โ Error con Brain: ${error.message}`);
    }

    // ========================================================================
    // RESUMEN
    // ========================================================================
    console.log('');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
    console.log('โ                              ๐ RESUMEN                                    โ');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ');
    console.log('โ                                                                            โ');
    console.log('โ  FLUJO DE INTROSPECCIรN DINรMICA:                                          โ');
    console.log('โ                                                                            โ');
    console.log('โ  1. Cambias cรณdigo en LateArrivalAuthorizationService.js                   โ');
    console.log('โ                    โ                                                       โ');
    console.log('โ  2. Brain.getWorkflowsConnected() es llamado                               โ');
    console.log('โ                    โ                                                       โ');
    console.log('โ  3. regenerateDerivedWorkflows() detecta el cambio                         โ');
    console.log('โ                    โ                                                       โ');
    console.log('โ  4. WorkflowAutoGenerator regenera AttendanceWorkflowService.js            โ');
    console.log('โ                    โ                                                       โ');
    console.log('โ  5. Brain escanea el archivo y extrae STAGES actualizados                  โ');
    console.log('โ                    โ                                                       โ');
    console.log('โ  6. Workflow refleja el cรณdigo REAL (AโBโC se convierte en AโBโKโC)        โ');
    console.log('โ                                                                            โ');
    console.log('โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ');
    console.log('');
}

runTest().catch(console.error);
