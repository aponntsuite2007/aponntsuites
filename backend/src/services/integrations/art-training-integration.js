/**
 * ============================================================================
 * INTEGRACI√ìN: ART ‚Üí Training
 * ============================================================================
 *
 * CIRCUITO DE INTEGRACI√ìN:
 *
 *  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
 *  ‚îÇ                        ART ‚Üí TRAINING                                 ‚îÇ
 *  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
 *  ‚îÇ                                                                       ‚îÇ
 *  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
 *  ‚îÇ  ‚îÇ                     FLUJO POST-ACCIDENTE                        ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
 *  ‚îÇ  ‚îÇ                                                                  ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  ACCIDENTE          DENUNCIA           CIERRE           ALTA    ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  OCURRE      ‚îÄ‚îÄ‚ñ∂    ART        ‚îÄ‚îÄ‚ñ∂    M√âDICA    ‚îÄ‚îÄ‚ñ∂    LABORAL  ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ     ‚îÇ                 ‚îÇ                  ‚îÇ                ‚îÇ     ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ     ‚ñº                 ‚ñº                  ‚ñº                ‚ñº     ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  Registro         Adjuntar           Capacitaci√≥n      Seguim.  ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  inicial          historial          REINSERCI√ìN       final    ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ                   trainings                                     ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
 *  ‚îÇ                                                                       ‚îÇ
 *  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
 *  ‚îÇ  ‚îÇ                   CAPACITACI√ìN PREVENTIVA                       ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
 *  ‚îÇ  ‚îÇ                                                                  ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  ACCIDENTE          AN√ÅLISIS          CAPACITACI√ìN              ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  REGISTRADO   ‚îÄ‚îÄ‚ñ∂   DE CAUSA    ‚îÄ‚îÄ‚ñ∂   A TODA EL √ÅREA            ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ     ‚îÇ                  ‚îÇ                   ‚îÇ                     ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ     ‚ñº                  ‚ñº                   ‚ñº                     ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  Tipo de           Falta de            Todos los                ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  accidente         capacitaci√≥n?       empleados                ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  identificado                          del √°rea                 ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ                                                                  ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
 *  ‚îÇ                                                                       ‚îÇ
 *  ‚îÇ  TIPOS DE ACCIDENTE ‚Üí CAPACITACI√ìN:                                  ‚îÇ
 *  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                 ‚îÇ
 *  ‚îÇ  ‚Ä¢ Ca√≠da altura     ‚Üí Trabajo en altura, Uso de arn√©s               ‚îÇ
 *  ‚îÇ  ‚Ä¢ Ca√≠da nivel      ‚Üí Orden y limpieza, 5S                          ‚îÇ
 *  ‚îÇ  ‚Ä¢ Golpe objeto     ‚Üí EPP, Seguridad general                        ‚îÇ
 *  ‚îÇ  ‚Ä¢ Corte/herida     ‚Üí Herramientas manuales, Primeros auxilios      ‚îÇ
 *  ‚îÇ  ‚Ä¢ Atrapamiento     ‚Üí LOTO, Bloqueo/etiquetado                      ‚îÇ
 *  ‚îÇ  ‚Ä¢ Quemadura        ‚Üí Manejo qu√≠micos, Protecci√≥n t√©rmica           ‚îÇ
 *  ‚îÇ  ‚Ä¢ El√©ctrico        ‚Üí Riesgo el√©ctrico, LOTO                        ‚îÇ
 *  ‚îÇ  ‚Ä¢ Ergon√≥mico       ‚Üí Ergonom√≠a, Levantamiento cargas               ‚îÇ
 *  ‚îÇ  ‚Ä¢ In itinere       ‚Üí Seguridad vial, Manejo defensivo              ‚îÇ
 *  ‚îÇ                                                                       ‚îÇ
 *  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
 *
 * @version 1.0.0
 * @date 2026-02-01
 */

const TrainingEcosystemHub = require('./TrainingEcosystemHub');
const { sequelize } = require('../../config/database');

class ARTTrainingIntegration {

    /**
     * Mapeo de tipos de accidente a capacitaciones requeridas
     */
    static ACCIDENT_TRAINING_MAP = {
        // Ca√≠das
        caida_altura: {
            victim: ['Trabajo en altura', 'Uso correcto de arn√©s', 'Inspecci√≥n de equipos'],
            area: ['Prevenci√≥n de ca√≠das', 'Seguridad en altura'],
            priority: 'critical'
        },
        caida_nivel: {
            victim: ['Orden y limpieza', 'Identificaci√≥n de riesgos'],
            area: ['5S', 'Housekeeping'],
            priority: 'high'
        },

        // Golpes y cortes
        golpe_objeto: {
            victim: ['Uso de EPP', 'Seguridad general'],
            area: ['Prevenci√≥n de golpes', 'Almacenamiento seguro'],
            priority: 'high'
        },
        corte_herida: {
            victim: ['Herramientas manuales', 'Primeros auxilios'],
            area: ['Seguridad con herramientas', 'Uso de guantes'],
            priority: 'high'
        },

        // Atrapamientos y mec√°nicos
        atrapamiento: {
            victim: ['LOTO - Bloqueo y etiquetado', 'Seguridad en m√°quinas'],
            area: ['Procedimientos LOTO', 'Guardas de seguridad'],
            priority: 'critical'
        },

        // T√©rmicos y qu√≠micos
        quemadura: {
            victim: ['Manejo de qu√≠micos', 'Protecci√≥n t√©rmica', 'EPP especializado'],
            area: ['Seguridad qu√≠mica', 'Emergencias qu√≠micas'],
            priority: 'critical'
        },

        // El√©ctricos
        electrico: {
            victim: ['Riesgo el√©ctrico', 'LOTO el√©ctrico', 'Primeros auxilios RCP'],
            area: ['Seguridad el√©ctrica', 'Identificaci√≥n de riesgos el√©ctricos'],
            priority: 'critical'
        },

        // Ergon√≥micos
        ergonomico: {
            victim: ['Ergonom√≠a laboral', 'Levantamiento de cargas'],
            area: ['Prevenci√≥n de lesiones musculoesquel√©ticas'],
            priority: 'normal'
        },

        // In itinere (en trayecto)
        in_itinere: {
            victim: ['Seguridad vial', 'Manejo defensivo'],
            area: ['Concientizaci√≥n vial'],
            priority: 'normal'
        },

        // Otros
        enfermedad_profesional: {
            victim: ['Salud ocupacional', 'Prevenci√≥n espec√≠fica'],
            area: ['Higiene industrial'],
            priority: 'high'
        }
    };

    /**
     * Hook: Cuando se cierra un accidente (alta m√©dica)
     * Llamar desde: artRoutes.js al cerrar caso
     */
    static async onAccidentClosed(accident, closedBy) {
        console.log(`üè• [ART‚ÜíTRAINING] Accidente cerrado: ${accident.denuncia_number || accident.id}`);

        const mapping = this.ACCIDENT_TRAINING_MAP[accident.accident_type];

        if (!mapping) {
            console.warn(`‚ö†Ô∏è [ART‚ÜíTRAINING] Sin mapeo para tipo: ${accident.accident_type}`);
            return { success: false, reason: 'Tipo de accidente no mapeado' };
        }

        const results = {
            victimTrainings: [],
            areaTrainings: []
        };

        // 1. Capacitaci√≥n de reinserci√≥n para la v√≠ctima
        for (const trainingKeyword of mapping.victim) {
            const result = await TrainingEcosystemHub.assignFromExternalModule({
                userId: accident.employee_id,
                companyId: accident.company_id,
                sourceModule: 'art',
                sourceEntityType: 'art_accident',
                sourceEntityId: accident.id,
                keywords: trainingKeyword.toLowerCase().split(' '),
                priority: mapping.priority,
                mandatory: true,
                reason: `Reinserci√≥n post-accidente: ${accident.denuncia_number || accident.id}`,
                assignedBy: closedBy
            });

            results.victimTrainings.push({ keyword: trainingKeyword, ...result });
        }

        // 2. Capacitaci√≥n preventiva para el √°rea (si aplica)
        if (accident.department_id && mapping.area.length > 0) {
            const areaResult = await this.assignPreventiveToArea(
                accident,
                mapping.area,
                mapping.priority
            );
            results.areaTrainings = areaResult;
        }

        const victimSuccess = results.victimTrainings.filter(r => r.success).length;
        console.log(`‚úÖ [ART‚ÜíTRAINING] V√≠ctima: ${victimSuccess}/${mapping.victim.length} capacitaciones`);

        return {
            success: victimSuccess > 0,
            victimTrainings: results.victimTrainings,
            areaTrainings: results.areaTrainings
        };
    }

    /**
     * Asigna capacitaci√≥n preventiva a todos los empleados del √°rea
     */
    static async assignPreventiveToArea(accident, trainingKeywords, priority) {
        const { User } = require('../../config/database');

        try {
            // Obtener empleados del √°rea
            const employees = await User.findAll({
                where: {
                    company_id: accident.company_id,
                    department_id: accident.department_id,
                    isActive: true,
                    user_id: { [require('sequelize').Op.ne]: accident.employee_id } // Excluir v√≠ctima
                },
                attributes: ['user_id']
            });

            console.log(`üì¢ [ART‚ÜíTRAINING] Asignando prevenci√≥n a ${employees.length} empleados del √°rea`);

            const results = [];

            for (const emp of employees) {
                // Asignar la primera capacitaci√≥n del √°rea como prevenci√≥n
                const result = await TrainingEcosystemHub.assignFromExternalModule({
                    userId: emp.user_id,
                    companyId: accident.company_id,
                    sourceModule: 'art',
                    sourceEntityType: 'art_accident_prevention',
                    sourceEntityId: accident.id,
                    keywords: trainingKeywords[0].toLowerCase().split(' '),
                    priority: priority === 'critical' ? 'high' : 'normal', // Bajar prioridad para √°rea
                    mandatory: true,
                    reason: `Prevenci√≥n post-accidente tipo: ${accident.accident_type}`
                });

                results.push({ userId: emp.user_id, ...result });
            }

            return results;

        } catch (error) {
            console.error('‚ùå [ART‚ÜíTRAINING] Error asignando al √°rea:', error);
            return [];
        }
    }

    /**
     * Hook: Al crear denuncia ART, adjuntar historial de capacitaciones
     * Llamar desde: artRoutes.js al crear denuncia
     */
    static async attachTrainingHistory(denunciaId, employeeId, companyId) {
        console.log(`üìé [ART‚ÜíTRAINING] Adjuntando historial a denuncia: ${denunciaId}`);

        try {
            const history = await sequelize.query(`
                SELECT
                    t.title as training_title,
                    t.category,
                    ta.status,
                    ta.completed_at,
                    ta.score,
                    CASE
                        WHEN ta.status = 'completed' THEN 'Completada'
                        WHEN ta.status = 'in_progress' THEN 'En progreso'
                        ELSE 'Pendiente'
                    END as status_display
                FROM training_assignments ta
                JOIN trainings t ON t.id = ta.training_id
                WHERE ta.user_id = $1 AND ta.company_id = $2
                  AND t.category = 'safety'
                ORDER BY ta.completed_at DESC NULLS LAST
                LIMIT 20
            `, { bind: [employeeId, companyId], type: sequelize.QueryTypes.SELECT });

            // Guardar en metadata de la denuncia
            await sequelize.query(`
                UPDATE art_accidents
                SET training_history = $1,
                    updated_at = NOW()
                WHERE id = $2
            `, {
                bind: [JSON.stringify(history), denunciaId],
                type: sequelize.QueryTypes.UPDATE
            });

            console.log(`‚úÖ [ART‚ÜíTRAINING] Historial adjuntado: ${history.length} capacitaciones`);

            return {
                success: true,
                trainingsAttached: history.length,
                history
            };

        } catch (error) {
            console.error('‚ùå [ART‚ÜíTRAINING] Error adjuntando historial:', error);
            return { success: false, error: error.message };
        }
    }

    /**
     * Obtiene estad√≠sticas de capacitaciones post-accidente
     */
    static async getPostAccidentStats(companyId, dateFrom, dateTo) {
        try {
            const stats = await sequelize.query(`
                SELECT
                    COUNT(DISTINCT ta.id) as total_assignments,
                    COUNT(DISTINCT ta.id) FILTER (WHERE ta.status = 'completed') as completed,
                    COUNT(DISTINCT ta.id) FILTER (WHERE ta.status = 'in_progress') as in_progress,
                    COUNT(DISTINCT ta.id) FILTER (WHERE ta.source_entity_type = 'art_accident') as victim_trainings,
                    COUNT(DISTINCT ta.id) FILTER (WHERE ta.source_entity_type = 'art_accident_prevention') as area_trainings,
                    AVG(EXTRACT(EPOCH FROM (ta.completed_at - ta.assigned_at)) / 86400)::numeric(10,2) as avg_completion_days
                FROM training_assignments ta
                WHERE ta.company_id = $1
                  AND ta.source_module = 'art'
                  AND ta.assigned_at BETWEEN $2 AND $3
            `, {
                bind: [companyId, dateFrom, dateTo],
                type: sequelize.QueryTypes.SELECT
            });

            return stats[0] || {};

        } catch (error) {
            console.error('‚ùå [ART‚ÜíTRAINING] Error obteniendo estad√≠sticas:', error);
            return {};
        }
    }

    /**
     * Verifica si un empleado tiene las capacitaciones de seguridad requeridas
     * antes de permitir trabajar en √°reas de riesgo
     */
    static async verifySafetyTrainingCompliance(userId, companyId, riskLevel = 'high') {
        try {
            const required = await sequelize.query(`
                SELECT
                    COUNT(*) FILTER (WHERE t.category = 'safety' AND ta.status = 'completed') as completed_safety,
                    COUNT(*) FILTER (WHERE t.category = 'safety' AND ta.status != 'completed') as pending_safety,
                    ARRAY_AGG(t.title) FILTER (WHERE t.category = 'safety' AND ta.status != 'completed') as pending_titles
                FROM training_assignments ta
                JOIN trainings t ON t.id = ta.training_id
                WHERE ta.user_id = $1 AND ta.company_id = $2
                  AND ta.source_module = 'art'
            `, { bind: [userId, companyId], type: sequelize.QueryTypes.SELECT });

            const data = required[0] || {};

            return {
                compliant: (data.pending_safety || 0) === 0,
                completedCount: data.completed_safety || 0,
                pendingCount: data.pending_safety || 0,
                pendingTitles: data.pending_titles || []
            };

        } catch (error) {
            console.error('‚ùå [ART‚ÜíTRAINING] Error verificando compliance:', error);
            return { compliant: true, error: error.message };
        }
    }
}

module.exports = ARTTrainingIntegration;
