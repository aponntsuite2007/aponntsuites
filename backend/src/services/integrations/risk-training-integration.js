/**
 * ============================================================================
 * INTEGRACI√ìN: Risk Intelligence ‚Üí Training
 * ============================================================================
 *
 * CIRCUITO DE INTEGRACI√ìN:
 *
 *  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
 *  ‚îÇ                  RISK INTELLIGENCE ‚Üí TRAINING                         ‚îÇ
 *  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
 *  ‚îÇ                                                                       ‚îÇ
 *  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
 *  ‚îÇ  ‚îÇ                    SCORE CR√çTICO                                ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
 *  ‚îÇ  ‚îÇ                                                                  ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  C√ÅLCULO           SCORE            CAPACITACI√ìN                ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  DE RIESGO   ‚îÄ‚îÄ‚ñ∂   CR√çTICO    ‚îÄ‚îÄ‚ñ∂   PREVENTIVA                  ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ     ‚îÇ               (‚â•80)               ‚îÇ                        ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ     ‚ñº                ‚îÇ                  ‚ñº                        ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  ‚Ä¢ Asistencia       ‚ñº               ‚Ä¢ Auto-asignar              ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  ‚Ä¢ Sanciones    Categor√≠a:          ‚Ä¢ Prioridad seg√∫n           ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  ‚Ä¢ HSE          ‚Ä¢ attendance_risk     score                     ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  ‚Ä¢ Desempe√±o    ‚Ä¢ safety_risk       ‚Ä¢ Notificar manager         ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  ‚Ä¢ M√©dico       ‚Ä¢ compliance_risk                               ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ                                                                  ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
 *  ‚îÇ                                                                       ‚îÇ
 *  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
 *  ‚îÇ  ‚îÇ                    ALERTA ACTIVA                                ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
 *  ‚îÇ  ‚îÇ                                                                  ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  ALERTA            CATEGOR√çA         CAPACITACI√ìN               ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  DISPARADA    ‚îÄ‚îÄ‚ñ∂  DE RIESGO   ‚îÄ‚îÄ‚ñ∂   ESPEC√çFICA                 ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ     ‚îÇ                  ‚îÇ                  ‚îÇ                      ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ     ‚ñº                  ‚ñº                  ‚ñº                      ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  ‚Ä¢ 3+ tardanzas   attendance_risk   "Gesti√≥n del tiempo"        ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  ‚Ä¢ HSE repeat     safety_risk       "Seguridad laboral"         ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  ‚Ä¢ Sanci√≥n grave  compliance_risk   "Cumplimiento normativo"    ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  ‚Ä¢ Bajo rendim.   performance_risk  "Mejora desempe√±o"          ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ                                                                  ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
 *  ‚îÇ                                                                       ‚îÇ
 *  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
 *  ‚îÇ  ‚îÇ                    TREND NEGATIVO                               ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
 *  ‚îÇ  ‚îÇ                                                                  ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  AN√ÅLISIS         TREND           INTERVENCI√ìN                  ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  HIST√ìRICO  ‚îÄ‚îÄ‚ñ∂   NEGATIVO  ‚îÄ‚îÄ‚ñ∂   TEMPRANA                      ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ     ‚îÇ               (3 meses)          ‚îÇ                         ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ     ‚ñº                  ‚îÇ               ‚ñº                         ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ  ‚Ä¢ Comparar           ‚ñº            ‚Ä¢ Capacitaci√≥n                ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ    con per√≠odo     Deterioro         preventiva                  ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ    anterior        sostenido       ‚Ä¢ Antes de llegar             ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ                                      a score cr√≠tico             ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îÇ                                                                  ‚îÇ ‚îÇ
 *  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
 *  ‚îÇ                                                                       ‚îÇ
 *  ‚îÇ  MAPEO CATEGOR√çA ‚Üí CAPACITACI√ìN:                                     ‚îÇ
 *  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                     ‚îÇ
 *  ‚îÇ  ‚Ä¢ attendance_risk    ‚Üí "Gesti√≥n tiempo", "Puntualidad"              ‚îÇ
 *  ‚îÇ  ‚Ä¢ safety_risk        ‚Üí "Seguridad laboral", "EPP"                   ‚îÇ
 *  ‚îÇ  ‚Ä¢ compliance_risk    ‚Üí "Cumplimiento normativo", "Pol√≠ticas"        ‚îÇ
 *  ‚îÇ  ‚Ä¢ performance_risk   ‚Üí "Mejora desempe√±o", "Productividad"          ‚îÇ
 *  ‚îÇ  ‚Ä¢ medical_risk       ‚Üí "Salud ocupacional", "Prevenci√≥n"            ‚îÇ
 *  ‚îÇ  ‚Ä¢ flight_risk        ‚Üí "Desarrollo carrera", "Engagement"           ‚îÇ
 *  ‚îÇ                                                                       ‚îÇ
 *  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
 *
 * @version 1.0.0
 * @date 2026-02-01
 */

const TrainingEcosystemHub = require('./TrainingEcosystemHub');
const { sequelize } = require('../../config/database');

class RiskTrainingIntegration {

    /**
     * Mapeo de categor√≠as de riesgo a capacitaciones
     */
    static RISK_TRAINING_MAP = {
        attendance_risk: {
            keywords: ['gesti√≥n tiempo', 'puntualidad', 'asistencia'],
            priority_thresholds: { 80: 'critical', 60: 'high', 40: 'normal' }
        },
        safety_risk: {
            keywords: ['seguridad laboral', 'EPP', 'prevenci√≥n'],
            priority_thresholds: { 80: 'critical', 60: 'high', 40: 'normal' }
        },
        compliance_risk: {
            keywords: ['cumplimiento', 'normativa', 'pol√≠ticas'],
            priority_thresholds: { 80: 'critical', 60: 'high', 40: 'normal' }
        },
        performance_risk: {
            keywords: ['desempe√±o', 'productividad', 'mejora continua'],
            priority_thresholds: { 80: 'high', 60: 'normal', 40: 'low' }
        },
        medical_risk: {
            keywords: ['salud ocupacional', 'prevenci√≥n', 'bienestar'],
            priority_thresholds: { 80: 'high', 60: 'normal', 40: 'low' }
        },
        flight_risk: {
            keywords: ['desarrollo', 'carrera', 'engagement', 'liderazgo'],
            priority_thresholds: { 80: 'high', 60: 'normal', 40: 'low' }
        }
    };

    /**
     * Hook: Cuando se detecta un score de riesgo cr√≠tico
     * Llamar desde: Risk Intelligence al calcular score
     */
    static async onCriticalRiskScore(params) {
        const { userId, companyId, riskCategory, riskScore, alertId, riskFactors } = params;

        console.log(`üìä [RISK‚ÜíTRAINING] Score cr√≠tico: ${riskCategory} = ${riskScore} para user ${userId}`);

        const mapping = this.RISK_TRAINING_MAP[riskCategory];

        if (!mapping) {
            console.warn(`‚ö†Ô∏è [RISK‚ÜíTRAINING] Categor√≠a no mapeada: ${riskCategory}`);
            return { success: false, error: 'Categor√≠a de riesgo no mapeada' };
        }

        // Determinar prioridad seg√∫n score
        let priority = 'normal';
        for (const [threshold, prio] of Object.entries(mapping.priority_thresholds).sort((a, b) => b[0] - a[0])) {
            if (riskScore >= parseInt(threshold)) {
                priority = prio;
                break;
            }
        }

        return TrainingEcosystemHub.onCriticalRiskScore({
            userId,
            companyId,
            riskCategory,
            riskScore,
            alertId
        });
    }

    /**
     * Hook: Cuando se activa una alerta de riesgo
     */
    static async onRiskAlert(alert) {
        console.log(`üö® [RISK‚ÜíTRAINING] Alerta activada: ${alert.type} para user ${alert.user_id}`);

        const alertTypeMapping = {
            // Alertas de asistencia
            'multiple_tardiness': { category: 'attendance_risk', score: 70 },
            'excessive_absences': { category: 'attendance_risk', score: 80 },
            'pattern_monday_friday': { category: 'attendance_risk', score: 60 },

            // Alertas de seguridad
            'repeated_hse_violations': { category: 'safety_risk', score: 85 },
            'no_epp_detected': { category: 'safety_risk', score: 75 },
            'safety_incident': { category: 'safety_risk', score: 90 },

            // Alertas de compliance
            'policy_violation': { category: 'compliance_risk', score: 70 },
            'pending_trainings': { category: 'compliance_risk', score: 60 },
            'expired_certifications': { category: 'compliance_risk', score: 75 },

            // Alertas de desempe√±o
            'low_productivity': { category: 'performance_risk', score: 65 },
            'missed_deadlines': { category: 'performance_risk', score: 70 },

            // Alertas m√©dicas
            'expired_medical_cert': { category: 'medical_risk', score: 80 },
            'health_concern': { category: 'medical_risk', score: 70 },

            // Alertas de retenci√≥n
            'high_flight_risk': { category: 'flight_risk', score: 75 },
            'engagement_drop': { category: 'flight_risk', score: 65 }
        };

        const mapping = alertTypeMapping[alert.type];

        if (!mapping) {
            console.warn(`‚ö†Ô∏è [RISK‚ÜíTRAINING] Tipo de alerta no mapeado: ${alert.type}`);
            return { success: false, error: 'Tipo de alerta no mapeado' };
        }

        return this.onCriticalRiskScore({
            userId: alert.user_id,
            companyId: alert.company_id,
            riskCategory: mapping.category,
            riskScore: mapping.score,
            alertId: alert.id,
            riskFactors: [alert.type]
        });
    }

    /**
     * Hook: Cuando se detecta un trend negativo sostenido
     */
    static async onNegativeTrend(params) {
        const { userId, companyId, trendCategory, trendDelta, periodMonths, alertId } = params;

        console.log(`üìâ [RISK‚ÜíTRAINING] Trend negativo: ${trendCategory} Œî${trendDelta}% en ${periodMonths} meses`);

        // Solo intervenir si el deterioro es significativo (>15%)
        if (Math.abs(trendDelta) < 15) {
            return { success: true, message: 'Deterioro no significativo, sin intervenci√≥n' };
        }

        // Calcular score simulado basado en el deterioro
        const simulatedScore = Math.min(90, 50 + Math.abs(trendDelta));

        return this.onCriticalRiskScore({
            userId,
            companyId,
            riskCategory: trendCategory,
            riskScore: simulatedScore,
            alertId,
            riskFactors: [`trend_negativo_${periodMonths}m`]
        });
    }

    /**
     * Obtiene recomendaciones de capacitaci√≥n basadas en riesgo
     */
    static async getTrainingRecommendations(userId, companyId) {
        console.log(`üí° [RISK‚ÜíTRAINING] Generando recomendaciones para user ${userId}`);

        try {
            // Obtener scores de riesgo actuales
            const riskScores = await this.getCurrentRiskScores(userId, companyId);

            const recommendations = [];

            for (const [category, score] of Object.entries(riskScores)) {
                if (score < 40) continue; // Sin riesgo significativo

                const mapping = this.RISK_TRAINING_MAP[category];
                if (!mapping) continue;

                // Determinar prioridad
                let priority = 'low';
                for (const [threshold, prio] of Object.entries(mapping.priority_thresholds).sort((a, b) => b[0] - a[0])) {
                    if (score >= parseInt(threshold)) {
                        priority = prio;
                        break;
                    }
                }

                // Buscar capacitaci√≥n apropiada
                const training = await this.findRecommendedTraining(companyId, mapping.keywords);

                if (training) {
                    recommendations.push({
                        category,
                        riskScore: score,
                        priority,
                        training: {
                            id: training.id,
                            title: training.title,
                            duration: training.duration,
                            category: training.category
                        },
                        reason: `Score de ${category}: ${score}%`
                    });
                }
            }

            // Ordenar por prioridad
            const priorityOrder = { critical: 0, high: 1, normal: 2, low: 3 };
            recommendations.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);

            return recommendations;

        } catch (error) {
            console.error('‚ùå [RISK‚ÜíTRAINING] Error generando recomendaciones:', error);
            return [];
        }
    }

    /**
     * Obtiene scores de riesgo actuales del usuario
     */
    static async getCurrentRiskScores(userId, companyId) {
        // Simulaci√≥n: En producci√≥n esto vendr√≠a del m√≥dulo Risk Intelligence
        try {
            // Intentar obtener de la tabla de risk scores si existe
            const [scores] = await sequelize.query(`
                SELECT
                    COALESCE(attendance_score, 0) as attendance_risk,
                    COALESCE(safety_score, 0) as safety_risk,
                    COALESCE(compliance_score, 0) as compliance_risk,
                    COALESCE(performance_score, 0) as performance_risk
                FROM risk_intelligence_scores
                WHERE user_id = $1 AND company_id = $2
                ORDER BY calculated_at DESC
                LIMIT 1
            `, { bind: [userId, companyId], type: sequelize.QueryTypes.SELECT });

            if (scores) {
                return scores;
            }

            // Si no hay datos, retornar vac√≠o
            return {};

        } catch (error) {
            // Tabla puede no existir
            return {};
        }
    }

    /**
     * Busca una capacitaci√≥n recomendada por keywords
     */
    static async findRecommendedTraining(companyId, keywords) {
        const { Training } = require('../../config/database');

        const trainings = await Training.findAll({
            where: {
                company_id: companyId,
                status: 'active'
            }
        });

        let bestMatch = null;
        let bestScore = 0;

        for (const training of trainings) {
            const titleLower = training.title.toLowerCase();
            const descLower = (training.description || '').toLowerCase();
            let score = 0;

            for (const keyword of keywords) {
                const kw = keyword.toLowerCase();
                if (titleLower.includes(kw)) score += 3;
                if (descLower.includes(kw)) score += 1;
            }

            if (score > bestScore) {
                bestScore = score;
                bestMatch = training;
            }
        }

        return bestMatch;
    }

    /**
     * Prioriza capacitaciones existentes basado en riesgo
     */
    static async reprioritizeByRisk(userId, companyId) {
        console.log(`üîÑ [RISK‚ÜíTRAINING] Re-priorizando capacitaciones para user ${userId}`);

        try {
            const riskScores = await this.getCurrentRiskScores(userId, companyId);

            // Mapeo de categor√≠a de training a categor√≠a de riesgo
            const categoryRiskMap = {
                safety: 'safety_risk',
                compliance: 'compliance_risk',
                quality: 'performance_risk',
                soft_skills: 'performance_risk'
            };

            // Actualizar prioridades
            const updates = [];

            for (const [trainingCategory, riskCategory] of Object.entries(categoryRiskMap)) {
                const riskScore = riskScores[riskCategory] || 0;

                if (riskScore >= 80) {
                    // Subir a critical
                    await sequelize.query(`
                        UPDATE training_assignments ta
                        SET priority = 'critical'
                        FROM trainings t
                        WHERE ta.training_id = t.id
                          AND ta.user_id = $1
                          AND ta.company_id = $2
                          AND t.category = $3
                          AND ta.status IN ('assigned', 'in_progress')
                          AND ta.priority != 'critical'
                    `, { bind: [userId, companyId, trainingCategory] });

                    updates.push({ category: trainingCategory, newPriority: 'critical' });
                }
            }

            return {
                success: true,
                updates
            };

        } catch (error) {
            console.error('‚ùå [RISK‚ÜíTRAINING] Error re-priorizando:', error);
            return { success: false, error: error.message };
        }
    }

    /**
     * Dashboard: Obtiene vista de riesgo vs capacitaciones
     */
    static async getRiskTrainingDashboard(companyId) {
        try {
            const stats = await sequelize.query(`
                WITH risk_data AS (
                    SELECT
                        user_id,
                        GREATEST(
                            COALESCE(attendance_score, 0),
                            COALESCE(safety_score, 0),
                            COALESCE(compliance_score, 0)
                        ) as max_risk_score
                    FROM risk_intelligence_scores
                    WHERE company_id = $1
                )
                SELECT
                    CASE
                        WHEN rd.max_risk_score >= 80 THEN 'critical'
                        WHEN rd.max_risk_score >= 60 THEN 'high'
                        WHEN rd.max_risk_score >= 40 THEN 'medium'
                        ELSE 'low'
                    END as risk_level,
                    COUNT(DISTINCT rd.user_id) as users_count,
                    COUNT(DISTINCT ta.id) as pending_trainings,
                    COUNT(DISTINCT ta.id) FILTER (WHERE ta.status = 'completed') as completed_trainings
                FROM risk_data rd
                LEFT JOIN training_assignments ta ON ta.user_id = rd.user_id
                    AND ta.company_id = $1
                    AND ta.source_module = 'risk_intelligence'
                GROUP BY 1
                ORDER BY 1
            `, { bind: [companyId], type: sequelize.QueryTypes.SELECT });

            return stats;

        } catch (error) {
            console.error('‚ùå [RISK‚ÜíTRAINING] Error en dashboard:', error);
            return [];
        }
    }
}

module.exports = RiskTrainingIntegration;
